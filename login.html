<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - Labour Care</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <style>
    .form-check-input:checked {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    
    .form-check-label {
      cursor: pointer;
      user-select: none;
    }
    
    .form-check-label:hover {
      color: #0d6efd;
    }
    
    .brand i {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    .brand h4 {
      color: #0d6efd;
      margin-bottom: 0.5rem;
    }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
</head>
<body>
  <div class="login-card">
    <div class="brand mb-3 text-center">
      <i class="fas fa-heartbeat text-primary"></i>
      <h4>Labour Care Guide</h4>
      <p class="text-muted">Sign in to your account</p>
    </div>
    <form id="loginForm">
      <div class="mb-3">
        <label for="email" class="form-label">
          <i class="fas fa-envelope"></i> Email Address
        </label>
        <input type="email" id="email" class="form-control" placeholder="Enter your email" required />
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">
          <i class="fas fa-key"></i> Password
        </label>
        <input type="password" id="password" class="form-control" placeholder="Enter your password" required />
      </div>
      <div class="mb-3 form-check">
        <input type="checkbox" id="rememberMe" class="form-check-input">
        <label class="form-check-label" for="rememberMe">
          <i class="fas fa-lock"></i> Remember me for 30 days
        </label>
      </div>
      <button type="submit" class="btn btn-primary w-100">
        <i class="fas fa-sign-in-alt"></i> Sign In
      </button>
      <a href="registration.html" class="btn btn-link w-100 mt-2">Register</a>
    </form>
    <form id="registerForm" style="display:none;">
      <div class="mb-3">
        <label>Email</label>
        <input type="email" id="regEmail" class="form-control" required />
      </div>
      <div class="mb-3">
        <label>Password</label>
        <input type="password" id="regPassword" class="form-control" required />
      </div>
      <div class="mb-3">
        <label>Role</label>
        <select id="regRole" class="form-control" required>
          <option value="">Select...</option>
          <option value="midwife">Midwife</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <button type="submit" class="btn btn-success w-100">Register</button>
      <button type="button" class="btn btn-link w-100 mt-2" onclick="showLogin()">Back to Login</button>
    </form>
    <div id="message" class="mt-3 text-center"></div>
  </div>
  <footer class="footer">
    Â© 2025 Labour Care App &mdash; Designed for clinical excellence
  </footer>
  <script>
    // Global variables
    let isLoggingIn = false; // Flag to prevent session check during login
    
    // Session management functions
    function setRememberMe(enabled) {
      if (enabled) {
        // Set persistent session (30 days)
        localStorage.setItem('rememberMe', 'true');
        localStorage.setItem('sessionExpiry', new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString());
      } else {
        // Set session-only (browser closes)
        localStorage.setItem('rememberMe', 'false');
        localStorage.removeItem('sessionExpiry');
      }
    }

    function checkSessionExpiry() {
      const rememberMe = localStorage.getItem('rememberMe');
      const sessionExpiry = localStorage.getItem('sessionExpiry');
      
      console.log('Checking session expiry:', { rememberMe, sessionExpiry });
      
      if (rememberMe === 'true' && sessionExpiry) {
        const expiryDate = new Date(sessionExpiry);
        const now = new Date();
        
        console.log('Session expiry check:', { expiryDate, now, isExpired: now > expiryDate });
        
        if (now > expiryDate) {
          // Session expired, clear everything
          console.log('Session expired, clearing...');
          clearSession();
          return false;
        }
        console.log('Session valid');
        return true;
      }
      
      // If no remember me, check if user has basic session data
      const hasBasicSession = localStorage.getItem('uid') && localStorage.getItem('role');
      console.log('No remember me, checking basic session:', hasBasicSession);
      
      return hasBasicSession;
    }

    function clearSession() {
      localStorage.removeItem('rememberMe');
      localStorage.removeItem('sessionExpiry');
      localStorage.removeItem('role');
      localStorage.removeItem('uid');
      localStorage.removeItem('userEmail');
      localStorage.removeItem('userTownship');
      localStorage.removeItem('userRegion');
    }

    // Global logout function that can be called from other pages
    function logout() {
      firebase.auth().signOut();
      clearSession();
      window.location.href = 'login.html';
    }

    function showRegister() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = '';
      document.getElementById('message').textContent = '';
    }
    
    function showLogin() {
      document.getElementById('loginForm').style.display = '';
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('message').textContent = '';
    }

    // Login
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const rememberMe = document.getElementById("rememberMe").checked;
      
      try {
        console.log('Starting login process...');
        isLoggingIn = true; // Set flag to prevent session check
        
        // Set Firebase persistence based on "Remember Me" choice
        if (rememberMe) {
          console.log('Setting LOCAL persistence...');
          await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        } else {
          console.log('Setting SESSION persistence...');
          await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);
        }
        
        console.log('Attempting Firebase sign in...');
        const userCred = await firebase.auth().signInWithEmailAndPassword(email, password);
        console.log('Firebase sign in successful:', userCred.user.uid);
        
        // Get user document from Firestore
        console.log('Fetching user profile from Firestore...');
        let userData = null;
        
        try {
          const userDoc = await db.collection("users").doc(userCred.user.uid).get();
          console.log('Firestore response:', userDoc.exists ? 'Document found' : 'Document not found');
          
          if (userDoc.exists) {
            userData = userDoc.data();
            console.log('User data from Firestore:', userData);
          } else {
            console.log('User document not found, creating default profile...');
            // Create a default user profile if document doesn't exist
            userData = {
              role: 'Midwife', // Default role
              approved: true,   // Default to approved for testing
              email: email,
              createdAt: new Date().toISOString()
            };
            
            // Try to save the default profile
            try {
              await db.collection("users").doc(userCred.user.uid).set(userData);
              console.log('Default user profile created successfully');
            } catch (saveError) {
              console.warn('Could not save default profile:', saveError);
            }
          }
        } catch (firestoreError) {
          console.warn('Firestore access failed, using default profile:', firestoreError);
          
          // Show helpful message about Firestore rules
          const message = document.getElementById('message');
          message.innerHTML = `
            <div class="alert alert-warning">
              <strong>Firestore Access Issue:</strong> Cannot read user profile due to security rules.<br>
              <small>Please update Firestore rules or contact administrator.</small>
            </div>
          `;
          
          // Use default profile if Firestore access fails
          userData = {
            role: 'Midwife',
            approved: true,
            email: email,
            createdAt: new Date().toISOString()
          };
        }
        
        // Check if user is approved (support both 'approved' and 'status' fields)
        const isApproved = userData.approved === true || userData.status === 'approved';
        
        // TEMPORARY: Allow all users for testing (remove this in production)
        if (!isApproved && email !== 'admin@test.com') {
          await firebase.auth().signOut();
          const message = document.getElementById('message');
          message.textContent = "Your account is pending approval by a super admin.";
          message.className = "mt-3 text-warning";
          return;
        }
        
        // Set session management
        setRememberMe(rememberMe);
        
        // Store user data
        localStorage.setItem("role", userData.role);
        localStorage.setItem("uid", userCred.user.uid);
        localStorage.setItem("userEmail", email);
        localStorage.setItem("userTownship", userData.township || '');
        localStorage.setItem("userRegion", userData.region || '');
        
        // Reset login flag
        isLoggingIn = false;
        
        // Redirect to dashboard or index
        window.location.replace("index.html");
        
      } catch (err) {
        const message = document.getElementById('message');
        
        // Provide more user-friendly error messages
        let errorMessage = err.message;
        if (err.code === 'auth/user-not-found') {
          errorMessage = 'No account found with this email address.';
        } else if (err.code === 'auth/wrong-password') {
          errorMessage = 'Incorrect password. Please try again.';
        } else if (err.code === 'auth/invalid-email') {
          errorMessage = 'Please enter a valid email address.';
        } else if (err.code === 'auth/too-many-requests') {
          errorMessage = 'Too many failed attempts. Please try again later.';
        }
        
        message.textContent = errorMessage;
        message.className = "mt-3 text-danger";
        console.error('Login error:', err);
        
        // Reset login flag on error
        isLoggingIn = false;
      }
    });

    // Check for existing session on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, checking Firebase auth state...');
      
      // Check if user is already logged in
      firebase.auth().onAuthStateChanged(function(user) {
        console.log('Auth state changed:', user ? 'User logged in' : 'No user');
        if (user) {
          // User is already authenticated, check session expiry
          // Skip session check if user is currently logging in
          if (isLoggingIn) {
            console.log('User is logging in, skipping session check');
            return;
          }
          
          // Add a small delay to avoid race condition with login process
          setTimeout(() => {
            if (checkSessionExpiry()) {
              // Valid session, redirect to dashboard
              console.log('Valid session found, redirecting...');
              window.location.replace("index.html");
            } else {
              // Session expired, sign out
              console.log('Session expired, signing out...');
              firebase.auth().signOut();
              clearSession();
            }
          }, 1000); // 1 second delay
        } else {
          console.log('No authenticated user, login form ready');
          isLoggingIn = false; // Reset flag when no user
        }
      });
    });

    // Register
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value;
      const role = document.getElementById("regRole").value;
      try {
        const userCred = await firebase.auth().createUserWithEmailAndPassword(email, password);
        await db.collection("users").doc(userCred.user.uid).set({ role });
        message.textContent = "Registration successful! You can now login.";
        message.className = "mt-3 text-success";
        showLogin();
      } catch (err) {
        message.textContent = err.message;
        message.className = "mt-3 text-danger";
      }
    });
  </script>
</body>
</html>