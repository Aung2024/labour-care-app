<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#10b981">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Select Patient - Maternal & Child Health Care System</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #10b981;
      --secondary-color: #059669;
      --danger-color: #dc2626;
      --warning-color: #f59e0b;
      --info-color: #3b82f6;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --card-hover-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 0;
      margin: 0;
    }

    /* Header */
    .medical-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header-left {
      flex: 1;
    }

    .app-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .page-subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* Main Container */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Search and Filter Section */
    .search-section {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
    }

    .search-box {
      position: relative;
      margin-bottom: 1rem;
    }

    .search-input {
      width: 100%;
      padding: 1rem 1rem 1rem 3rem;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
      font-size: 1.2rem;
    }

    /* Filter Chips */
    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .filter-chip {
      padding: 0.5rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 20px;
      background: white;
      color: #6b7280;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter-chip:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .filter-chip.active {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    /* Recent Patients Section */
    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: white;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-title i {
      color: #fbbf24;
    }

    /* Patient Cards Grid */
    .patients-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .patient-card {
      background: white;
      border-radius: 15px;
      padding: 1.25rem;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .patient-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--card-hover-shadow);
      border-color: var(--primary-color);
    }

    .patient-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }

    .patient-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }

    .patient-id {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .status-badge {
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-badge.antenatal {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.labour {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-badge.postnatal {
      background: #ede9fe;
      color: #5b21b6;
    }

    .status-badge.registered {
      background: #f3f4f6;
      color: #374151;
    }

    .patient-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
    }

    .detail-label {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 0.25rem;
    }

    .detail-value {
      font-size: 0.95rem;
      font-weight: 600;
      color: #374151;
    }

    .risk-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .risk-badge.high {
      background: #fef3c7;
      color: #78350f;
    }

    .risk-badge.normal {
      background: #d1fae5;
      color: #065f46;
    }

    .patient-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-select {
      flex: 1;
      padding: 0.75rem;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-select:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-edit {
      padding: 0.75rem 1rem;
      background: #6b7280;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-edit:hover {
      background: #4b5563;
    }

    /* Loading State */
    .loading-container {
      text-align: center;
      padding: 4rem 2rem;
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
      color: var(--primary-color);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: white;
      border-radius: 15px;
      box-shadow: var(--card-shadow);
    }

    .empty-icon {
      font-size: 4rem;
      color: #d1d5db;
      margin-bottom: 1.5rem;
    }

    .empty-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 1rem;
    }

    .empty-text {
      color: #6b7280;
      margin-bottom: 2rem;
    }

    /* Footer */
    .footer {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      color: #374151;
      text-align: center;
      padding: 2rem;
      margin-top: 2rem;
      border-radius: 20px;
      box-shadow: var(--card-shadow);
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .main-container {
        padding: 1rem;
      }

      .app-title {
        font-size: 1.2rem;
      }

      .patients-grid {
        grid-template-columns: 1fr;
      }

      .patient-details {
        grid-template-columns: 1fr;
      }

      .filter-chips {
        flex-wrap: wrap;
      }

      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }

      .search-section {
        padding: 1rem;
      }
    }

    /* Touch-friendly buttons */
    @media (hover: none) and (pointer: coarse) {
      .patient-card {
        min-height: 60px;
      }

      .btn-select,
      .btn-edit,
      .filter-chip {
        min-height: 44px;
        min-width: 44px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="medical-header">
    <div class="header-content">
      <div class="header-left">
        <div class="app-title">üë©‚Äç‚öïÔ∏è Select Patient for Care</div>
        <div class="page-subtitle">Choose a patient to access comprehensive care management</div>
      </div>
      <div class="header-right">
        <a href="index.html" class="btn btn-outline-light btn-sm me-2">
          <i class="fas fa-home me-2"></i>Home
        </a>
        <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); sessionStorage.clear(); window.location='login.html';">
          <i class="fas fa-sign-out-alt me-2"></i>Logout
        </button>
      </div>
    </div>
  </div>

  <div class="main-container">
    <!-- Search and Filter Section -->
    <div class="search-section">
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input 
          type="text" 
          id="searchInput" 
          class="search-input" 
          placeholder="Search by name, phone, address, or patient ID..." 
          oninput="filterPatients()"
        >
      </div>
      <div class="filter-chips">
        <div class="filter-chip active" data-filter="all" onclick="setStatusFilter('all')">
          <i class="fas fa-users me-1"></i> All Patients
        </div>
        <div class="filter-chip" data-filter="registered" onclick="setStatusFilter('registered')">
          <i class="fas fa-user-plus me-1"></i> Registered
        </div>
        <div class="filter-chip" data-filter="antenatal" onclick="setStatusFilter('antenatal')">
          <i class="fas fa-baby-carriage me-1"></i> Antenatal
        </div>
        <div class="filter-chip" data-filter="labour care" onclick="setStatusFilter('labour care')">
          <i class="fas fa-heartbeat me-1"></i> Labour Care
        </div>
        <div class="filter-chip" data-filter="postnatal" onclick="setStatusFilter('postnatal')">
          <i class="fas fa-hands-holding-child me-1"></i> Postnatal
        </div>
      </div>
    </div>

    <!-- Recent Patients Section -->
    <div id="recentPatientsSection" style="display: none;">
      <h3 class="section-title">
        <i class="fas fa-clock"></i> Recently Viewed Patients
      </h3>
      <div id="recentPatientsGrid" class="patients-grid mb-4">
        <!-- Recent patients will be populated here -->
      </div>
    </div>

    <!-- All Patients Section -->
    <h3 class="section-title">
      <i class="fas fa-list"></i> <span id="sectionTitleText">All Patients</span>
    </h3>

    <!-- Loading State -->
    <div id="loadingContainer" class="loading-container">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-white">Loading patients...</p>
    </div>

    <!-- Patients Grid -->
    <div id="patientsGrid" class="patients-grid" style="display: none;">
      <!-- Patient cards will be populated here -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
      <div class="empty-icon">
        <i class="fas fa-inbox"></i>
      </div>
      <h3 class="empty-title">No Patients Found</h3>
      <p class="empty-text">
        <span id="emptyMessage">There are no patients registered yet.</span>
      </p>
      <button class="btn btn-primary btn-lg" onclick="window.location.href='patient-enhanced.html'">
        <i class="fas fa-plus me-2"></i>Register New Patient
      </button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p class="mb-0">
        <i class="fas fa-heart me-2"></i>
        ¬© 2025 Maternal & Child Health Care System ‚Äî Designed for clinical excellence - Powered by Jhpiego Myanmar
      </p>
    </div>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>

  <script>
    let currentUser = null;
    let userRole = null;
    let allPatients = [];
    let filteredPatients = [];
    let currentStatusFilter = 'all';
    let recentPatients = [];

    // Initialize Firebase auth state
    firebase.auth().onAuthStateChanged(async function(user) {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      
      currentUser = user;
      
      // Get user role
      const userDoc = await firebase.firestore()
        .collection('users')
        .doc(user.uid)
        .get();
      
      if (userDoc.exists) {
        userRole = userDoc.data().role;
      }
      
      // Load recent patients
      loadRecentPatients();
      
      // Load all patients
      await loadPatients();
    });

    // Load patients from Firestore
    async function loadPatients() {
      try {
        console.log('Loading patients...');
        const db = firebase.firestore();
        let query = db.collection('patients');

        // Apply role-based filtering
        if (userRole === 'Midwife') {
          query = query.where('created_by', '==', currentUser.uid);
        } else if (userRole === 'TMO') {
          const userDoc = await db.collection('users').doc(currentUser.uid).get();
          const userTownship = userDoc.data().township;
          query = query.where('township', '==', userTownship);
        }

        const snapshot = await query.get();
        
        allPatients = [];
        snapshot.forEach(doc => {
          allPatients.push({
            id: doc.id,
            ...doc.data()
          });
        });

        console.log('Loaded', allPatients.length, 'patients');
        
        // Sort by creation date (newest first)
        allPatients.sort((a, b) => {
          const dateA = a.created_at ? (a.created_at.toDate ? a.created_at.toDate() : new Date(a.created_at)) : new Date(0);
          const dateB = b.created_at ? (b.created_at.toDate ? b.created_at.toDate() : new Date(b.created_at)) : new Date(0);
          return dateB - dateA;
        });

        filteredPatients = [...allPatients];
        
        document.getElementById('loadingContainer').style.display = 'none';
        
        if (allPatients.length === 0) {
          document.getElementById('emptyState').style.display = 'block';
          document.getElementById('emptyMessage').textContent = 'There are no patients registered yet.';
        } else {
          displayPatients();
        }
        
      } catch (error) {
        console.error('Error loading patients:', error);
        document.getElementById('loadingContainer').style.display = 'none';
        alert('Error loading patients: ' + error.message);
      }
    }

    // Display patients in grid
    function displayPatients() {
      const grid = document.getElementById('patientsGrid');
      grid.innerHTML = '';
      
      if (filteredPatients.length === 0) {
        document.getElementById('patientsGrid').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        
        if (currentStatusFilter !== 'all') {
          document.getElementById('emptyMessage').textContent = `No patients found with status: ${currentStatusFilter}`;
        } else {
          document.getElementById('emptyMessage').textContent = 'No patients match your search criteria.';
        }
        return;
      }
      
      document.getElementById('patientsGrid').style.display = 'grid';
      document.getElementById('emptyState').style.display = 'none';
      
      filteredPatients.forEach(patient => {
        const card = createPatientCard(patient);
        grid.appendChild(card);
      });
    }

    // Create patient card element
    function createPatientCard(patient) {
      const card = document.createElement('div');
      card.className = 'patient-card';
      card.onclick = () => selectPatient(patient);
      
      const status = patient.status || 'registered';
      let statusClass = status.toLowerCase();
      
      // Normalize status for display
      let displayStatus = status;
      if (status === 'registered') displayStatus = 'Registered';
      else if (status === 'antenatal_care') displayStatus = 'Antenatal Care';
      else if (status === 'labour_care') displayStatus = 'Labour Care';
      else if (status === 'postnatal_care') displayStatus = 'Postnatal Care';
      
      // Map status to CSS classes
      if (statusClass.includes('antenatal')) statusClass = 'antenatal';
      else if (statusClass.includes('labour')) statusClass = 'labour';
      else if (statusClass.includes('postnatal')) statusClass = 'postnatal';
      else if (statusClass === 'registered') statusClass = 'registered';
      else statusClass = 'antenatal'; // fallback
      
      const isHighRisk = patient.high_risk === 'yes' || patient.high_risk === true;
      const riskBadge = isHighRisk ? 
        '<span class="risk-badge high">High Risk</span>' : 
        '<span class="risk-badge normal">Normal</span>';
      
      // Calculate GA
      let gaDisplay = '-';
      if (patient.gestational_age) {
        gaDisplay = `${patient.gestational_age} wks`;
      } else if (patient.lmp && patient.lmp !== 'unknown') {
        const ga = calculateGA(patient.lmp);
        gaDisplay = ga ? `${ga} wks` : '-';
      }
      
      // Format EDD
      let eddDisplay = '-';
      if (patient.edd) {
        eddDisplay = formatDate(patient.edd);
      }
      
      card.innerHTML = `
        <div class="patient-header">
          <div>
            <div class="patient-name">${patient.name || 'Unknown'}</div>
            <div class="patient-id">ID: ${patient.id.substring(0, 8)}...</div>
          </div>
          <span class="status-badge ${statusClass}">${displayStatus}</span>
        </div>
        <div class="patient-details">
          <div class="detail-item">
            <span class="detail-label">Age</span>
            <span class="detail-value">${patient.age || '-'} years</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Address</span>
            <span class="detail-value">${patient.patient_address || patient.patientAddress || '-'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Risk Level</span>
            <span class="detail-value">${riskBadge}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Status</span>
            <span class="detail-value">${status}</span>
          </div>
        </div>
        <div class="patient-actions">
          <button class="btn-select" onclick="event.stopPropagation(); selectPatient(${JSON.stringify(patient).replace(/"/g, '&quot;')})">
            <i class="fas fa-check-circle"></i> Select Patient
          </button>
          <button class="btn-edit" onclick="event.stopPropagation(); editPatient('${patient.id}')">
            <i class="fas fa-edit"></i>
          </button>
        </div>
      `;
      
      return card;
    }

    // Select patient and save to session
    function selectPatient(patient) {
      console.log('Selecting patient:', patient);
      
      // Save to session storage
      sessionStorage.setItem('selectedPatientId', patient.id);
      sessionStorage.setItem('selectedPatientData', JSON.stringify(patient));
      
      // Add to recent patients
      addToRecentPatients(patient);
      
      // Redirect to patient care hub
      window.location.href = 'patient-care-hub.html';
    }

    // Edit patient
    function editPatient(patientId) {
      window.location.href = `edit-patient.html?id=${patientId}`;
    }

    // Filter patients by status
    function setStatusFilter(status) {
      currentStatusFilter = status;
      
      // Update active chip
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
      });
      event.target.closest('.filter-chip').classList.add('active');
      
      // Update section title
      if (status === 'all') {
        document.getElementById('sectionTitleText').textContent = 'All Patients';
      } else {
        document.getElementById('sectionTitleText').textContent = `${status} Patients`;
      }
      
      // Apply filter
      filterPatients();
    }

    // Filter patients by search and status
    function filterPatients() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      
      filteredPatients = allPatients.filter(patient => {
        // Status filter
        if (currentStatusFilter !== 'all') {
          const patientStatus = patient.status || 'registered';
          // Handle different status formats
          let normalizedStatus = patientStatus.toLowerCase();
          if (normalizedStatus === 'antenatal_care') normalizedStatus = 'antenatal';
          if (normalizedStatus === 'labour_care') normalizedStatus = 'labour care';
          if (normalizedStatus === 'postnatal_care') normalizedStatus = 'postnatal';
          
          const normalizedFilter = currentStatusFilter.toLowerCase();
          if (normalizedStatus !== normalizedFilter) return false;
        }
        
        // Search filter
        if (searchTerm) {
          const name = (patient.name || '').toLowerCase();
          const phone = (patient.phone || '').toLowerCase();
          const address = (patient.patient_address || patient.patientAddress || '').toLowerCase();
          const id = patient.id.toLowerCase();
          
          if (!name.includes(searchTerm) && 
              !phone.includes(searchTerm) && 
              !address.includes(searchTerm) &&
              !id.includes(searchTerm)) {
            return false;
          }
        }
        
        return true;
      });
      
      displayPatients();
    }

    // Load recent patients from localStorage
    function loadRecentPatients() {
      const recent = localStorage.getItem('recentPatients');
      if (recent) {
        recentPatients = JSON.parse(recent);
        
        if (recentPatients.length > 0) {
          displayRecentPatients();
        }
      }
    }

    // Display recent patients
    function displayRecentPatients() {
      const section = document.getElementById('recentPatientsSection');
      const grid = document.getElementById('recentPatientsGrid');
      
      grid.innerHTML = '';
      
      // Show only last 3 recent patients
      const recentToShow = recentPatients.slice(0, 3);
      
      recentToShow.forEach(patientId => {
        const patient = allPatients.find(p => p.id === patientId);
        if (patient) {
          const card = createPatientCard(patient);
          grid.appendChild(card);
        }
      });
      
      if (recentToShow.length > 0) {
        section.style.display = 'block';
      }
    }

    // Add patient to recent patients
    function addToRecentPatients(patient) {
      // Remove if already exists
      recentPatients = recentPatients.filter(id => id !== patient.id);
      
      // Add to beginning
      recentPatients.unshift(patient.id);
      
      // Keep only last 5
      recentPatients = recentPatients.slice(0, 5);
      
      // Save to localStorage
      localStorage.setItem('recentPatients', JSON.stringify(recentPatients));
    }

    // Calculate Gestational Age from LMP
    function calculateGA(lmp) {
      if (!lmp || lmp === 'unknown') return null;
      
      let lmpDate;
      if (lmp.toDate) {
        lmpDate = lmp.toDate();
      } else if (lmp.seconds) {
        lmpDate = new Date(lmp.seconds * 1000);
      } else {
        lmpDate = new Date(lmp);
      }
      
      const today = new Date();
      const diffTime = Math.abs(today - lmpDate);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      const weeks = Math.floor(diffDays / 7);
      
      return weeks;
    }

    // Format date
    function formatDate(date) {
      if (!date) return '-';
      
      let dateObj;
      if (date.toDate) {
        dateObj = date.toDate();
      } else if (date.seconds) {
        dateObj = new Date(date.seconds * 1000);
      } else {
        dateObj = new Date(date);
      }
      
      return dateObj.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    }
  </script>
</body>
</html>
