<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#10b981">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Select Patient - Maternal & Child Health Care System</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #10b981;
      --secondary-color: #059669;
      --danger-color: #dc2626;
      --warning-color: #f59e0b;
      --info-color: #3b82f6;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --card-hover-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 0;
      margin: 0;
    }

    /* Header */
    .medical-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header-left {
      flex: 1;
    }

    .app-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .page-subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .header-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 1rem;
    }

    /* Main Container */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Search and Filter Section */
    .search-section {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
    }

    .search-box {
      position: relative;
      margin-bottom: 1rem;
    }

    .search-input {
      width: 100%;
      padding: 1rem 1rem 1rem 3rem;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
      font-size: 1.2rem;
    }

    /* Filter Chips */
    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .filter-chip {
      padding: 0.5rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 20px;
      background: white;
      color: #6b7280;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter-chip:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .filter-chip.active {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    /* Recent Patients Section */
    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: white;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-title i {
      color: #fbbf24;
    }

    .view-section-header {
      position: relative;
    }

    .view-toggle {
      position: relative;
      display: flex;
      align-items: center;
    }

    .view-toggle-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .view-toggle-button:hover,
    .view-toggle-button:focus {
      background: rgba(255, 255, 255, 0.35);
      outline: none;
      transform: translateY(-1px);
    }

    .view-toggle-menu {
      position: absolute;
      top: 46px;
      left: 0;
      background: white;
      color: #111827;
      border-radius: 12px;
      box-shadow: 0 20px 25px -15px rgba(15, 23, 42, 0.6);
      padding: 0.5rem;
      min-width: 160px;
      display: none;
      z-index: 10;
    }

    .view-toggle-menu.show {
      display: block;
    }

    .view-toggle-option {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border: none;
      background: transparent;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      color: #4b5563;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .view-toggle-option:hover,
    .view-toggle-option:focus {
      background: rgba(16, 185, 129, 0.12);
      color: var(--primary-color);
      outline: none;
    }

    .view-toggle-option.active {
      background: rgba(16, 185, 129, 0.18);
      color: var(--primary-color);
    }

    .patients-list {
      display: none;
      background: white;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      overflow-x: auto;
      overflow-y: hidden;
    }

    .patients-table {
      width: 100%;
      margin-bottom: 0;
      color: #111827;
    }

    .patients-table thead {
      background: rgba(16, 185, 129, 0.12);
    }

    .patients-table th {
      font-weight: 600;
      color: #047857;
      border-bottom: none;
      padding: 0.85rem;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .patients-table td {
      vertical-align: middle;
      padding: 0.85rem;
      font-size: 0.95rem;
      border-color: #e5e7eb !important;
      font-weight: 500;
    }

    .patients-table tbody tr {
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .patients-table tbody tr:hover {
      background: rgba(16, 185, 129, 0.08);
    }

    .actions-cell {
      text-align: right;
    }

    .patients-table .btn-secondary {
      padding: 0.4rem 0.75rem;
    }

    .status-pill.antenatal {
      background: #d1fae5;
      color: #065f46;
    }

    .status-pill.labour {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-pill.postnatal {
      background: #ede9fe;
      color: #5b21b6;
    }

    .status-pill.registered {
      background: #f3f4f6;
      color: #374151;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: capitalize;
    }

    /* Patient Cards Grid */
    .patients-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2rem;
    }

    .patient-card {
      background: white;
      border-radius: 16px;
      padding: 1.25rem;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid rgba(229, 231, 235, 0.9);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .patient-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--card-hover-shadow);
      border-color: rgba(16, 185, 129, 0.45);
    }

    .patient-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .patient-name {
      font-size: 1.15rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.25rem;
    }

    .status-badge {
      padding: 0.35rem 0.75rem;
      border-radius: 18px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .status-badge.antenatal {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.labour {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-badge.postnatal {
      background: #ede9fe;
      color: #5b21b6;
    }

    .status-badge.registered {
      background: #f3f4f6;
      color: #374151;
    }

    .patient-highlight-grid,
    .patient-stat-grid {
      display: grid;
      gap: 0.6rem;
    }

    .patient-highlight-grid {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }

    .patient-stat-grid {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }

    .info-chip {
      background: rgba(243, 244, 246, 0.7);
      border-radius: 12px;
      padding: 0.65rem 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .info-chip span {
      font-size: 0.72rem;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .info-chip strong {
      font-size: 0.95rem;
      color: #111827;
      font-weight: 600;
    }

    .info-chip.risk-high {
      background: rgba(254, 226, 226, 0.9);
      color: #991b1b;
    }

    .info-chip.risk-high strong {
      color: #991b1b;
    }

    .info-chip.risk-normal {
      background: rgba(209, 250, 229, 0.9);
      color: #065f46;
    }

    .info-chip.risk-normal strong {
      color: #065f46;
    }

    .risk-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .risk-badge.high {
      background: #fef3c7;
      color: #78350f;
    }

    .risk-badge.normal {
      background: #d1fae5;
      color: #065f46;
    }

    .patient-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-select {
      flex: 1;
      padding: 0.75rem;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-select:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-edit {
      padding: 0.75rem 1rem;
      background: #6b7280;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-edit:hover {
      background: #4b5563;
    }


    /* Loading State */
    .loading-container {
      text-align: center;
      padding: 4rem 2rem;
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
      color: var(--primary-color);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: white;
      border-radius: 15px;
      box-shadow: var(--card-shadow);
    }

    .empty-icon {
      font-size: 4rem;
      color: #d1d5db;
      margin-bottom: 1.5rem;
    }

    .empty-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 1rem;
    }

    .empty-text {
      color: #6b7280;
      margin-bottom: 2rem;
    }

    /* Footer */
    .footer {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      color: #374151;
      text-align: center;
      padding: 2rem;
      margin-top: 2rem;
      border-radius: 20px;
      box-shadow: var(--card-shadow);
    }

    /* Mobile Responsiveness */
    @media (max-width: 992px) {
      .patient-card {
        padding: 1rem;
      }

      .patient-highlight-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }

      .patient-stat-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .main-container {
        padding: 1rem;
      }

      .app-title {
        font-size: 1.2rem;
      }

      .patients-grid {
        grid-template-columns: 1fr;
      }

      .patient-details {
        grid-template-columns: repeat(2, 1fr);
      }

      .filter-chips {
        flex-wrap: wrap;
      }

      .header-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .header-right {
        align-self: flex-end;
      }

      .search-section {
        padding: 1rem;
      }

      .patients-list {
        border-radius: 14px;
      }
    }

    /* Touch-friendly buttons */
    @media (hover: none) and (pointer: coarse) {
      .patient-card {
        min-height: 60px;
      }

      .btn-select,
      .btn-edit,
      .filter-chip {
        min-height: 44px;
        min-width: 44px;
      }
    }

    @media (max-width: 576px) {
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="medical-header">
    <div class="header-content">
      <div class="header-left">
        <div class="app-title">üë©‚Äç‚öïÔ∏è Select Patient for Care</div>
        <div class="page-subtitle">Choose a patient to access comprehensive care management</div>
      </div>
      <div class="header-right">
        <a href="index.html" class="btn btn-outline-light btn-sm me-2">
          <i class="fas fa-home me-2"></i>Home
        </a>
        <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); sessionStorage.clear(); window.location='login.html';">
          <i class="fas fa-sign-out-alt me-2"></i>Logout
        </button>
      </div>
    </div>
  </div>

  <div class="main-container">
    <!-- Search and Filter Section -->
    <div class="search-section">
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input 
          type="text" 
          id="searchInput" 
          class="search-input" 
          placeholder="Search by name, phone, address, or patient ID..." 
          oninput="filterPatients()"
        >
      </div>
      <div class="filter-chips">
        <div class="filter-chip active" data-filter="all" onclick="setStatusFilter('all')">
          <i class="fas fa-users me-1"></i> All Patients
        </div>
        <div class="filter-chip" data-filter="registered" onclick="setStatusFilter('registered')">
          <i class="fas fa-user-plus me-1"></i> Registered
        </div>
        <div class="filter-chip" data-filter="antenatal" onclick="setStatusFilter('antenatal')">
          <i class="fas fa-baby-carriage me-1"></i> Antenatal
        </div>
        <div class="filter-chip" data-filter="labour care" onclick="setStatusFilter('labour care')">
          <i class="fas fa-heartbeat me-1"></i> Labour Care
        </div>
        <div class="filter-chip" data-filter="postnatal" onclick="setStatusFilter('postnatal')">
          <i class="fas fa-hands-holding-child me-1"></i> Postnatal
        </div>
      </div>
    </div>

    <!-- Recent Patients Section -->
    <div id="recentPatientsSection" style="display: none;">
      <h3 class="section-title">
        <i class="fas fa-clock"></i> Recently Viewed Patients
      </h3>
      <div id="recentPatientsGrid" class="patients-grid mb-4">
        <!-- Recent patients will be populated here -->
      </div>
    </div>

    <!-- All Patients Section -->
    <h3 class="section-title view-section-header">
      <div class="view-toggle">
        <button 
          id="viewToggleButton" 
          class="view-toggle-button" 
          type="button" 
          aria-haspopup="true" 
          aria-expanded="false" 
          aria-controls="viewToggleMenu"
          onclick="toggleViewMenu(event)"
        >
          <i class="fas fa-list-ul"></i>
        </button>
        <div id="viewToggleMenu" class="view-toggle-menu" role="menu">
          <button class="view-toggle-option" data-view="grid" type="button" role="menuitem" onclick="setView('grid', event)">
            <i class="fas fa-th-large"></i> Grid View
          </button>
          <button class="view-toggle-option active" data-view="list" type="button" role="menuitem" onclick="setView('list', event)">
            <i class="fas fa-list-ul"></i> List View
          </button>
        </div>
      </div>
      <span id="sectionTitleText">All Patients</span>
    </h3>

    <!-- Loading State -->
    <div id="loadingContainer" class="loading-container">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-white">Loading patients...</p>
    </div>

    <!-- Patients Grid -->
    <div id="patientsGrid" class="patients-grid" style="display: none;">
      <!-- Patient cards will be populated here -->
    </div>

    <!-- Patients List -->
    <div id="patientsList" class="patients-list" style="display: none;">
      <!-- Patient rows will be populated here -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
      <div class="empty-icon">
        <i class="fas fa-inbox"></i>
      </div>
      <h3 class="empty-title">No Patients Found</h3>
      <p class="empty-text">
        <span id="emptyMessage">There are no patients registered yet.</span>
      </p>
      <button class="btn btn-primary btn-lg" onclick="window.location.href='patient-enhanced.html'">
        <i class="fas fa-plus me-2"></i>Register New Patient
      </button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p class="mb-0">
        <i class="fas fa-heart me-2"></i>
        MNCH App 2025 | Developed by Jhpiego Myanmar for MoH.
      </p>
    </div>
  </footer>
 
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>

  <script>
    let currentUser = null;
    let userRole = null;
    let allPatients = [];
    let filteredPatients = [];
    let currentStatusFilter = 'all';
    let recentPatients = [];
    let currentView = 'list';

    // Initialize Firebase auth state
    firebase.auth().onAuthStateChanged(async function(user) {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      
      currentUser = user;
      
      // Get user role
      const userDoc = await firebase.firestore()
        .collection('users')
        .doc(user.uid)
        .get();
      
      if (userDoc.exists) {
        userRole = userDoc.data().role;
      }
      
      // Load recent patients
      loadRecentPatients();
      
      // Load all patients
      await loadPatients();
    });

    // Load patients from Firestore with optimization
    async function loadPatients() {
      try {
        console.log('Loading patients...');
        const db = firebase.firestore();
        let query = db.collection('patients');

        // Apply role-based filtering
        if (userRole === 'Midwife') {
          query = query.where('created_by', '==', currentUser.uid);
        } else if (userRole === 'TMO') {
          const userDoc = await db.collection('users').doc(currentUser.uid).get({ source: 'server' });
          const userTownship = userDoc.data().township;
          query = query.where('township', '==', userTownship);
        }

        // Load from server with timeout
        const snapshot = await Promise.race([
          query.get({ source: 'server' }),
          new Promise((_, reject) => setTimeout(() => reject(new Error('Server timeout')), 15000))
        ]);
        
        allPatients = [];
        snapshot.forEach(doc => {
          allPatients.push({
            id: doc.id,
            ...doc.data()
          });
        });

        console.log('Loaded', allPatients.length, 'patients');
        
        // Sort by creation date (newest first) - optimized
        allPatients.sort((a, b) => {
          const dateA = a.created_at ? (a.created_at.toDate ? a.created_at.toDate() : new Date(a.created_at)) : new Date(0);
          const dateB = b.created_at ? (b.created_at.toDate ? b.created_at.toDate() : new Date(b.created_at)) : new Date(0);
          return dateB - dateA;
        });

        filteredPatients = [...allPatients];
        
        document.getElementById('loadingContainer').style.display = 'none';
        
        if (allPatients.length === 0) {
          document.getElementById('emptyState').style.display = 'block';
          document.getElementById('emptyMessage').textContent = 'There are no patients registered yet.';
        } else {
          displayPatients();
        }
        
      } catch (error) {
        console.error('Error loading patients:', error);
        document.getElementById('loadingContainer').style.display = 'none';
        
        // Show error message
        console.error('Failed to load patients from server');
        
        alert('Error loading patients: ' + error.message);
      }
    }

    // Display patients in current view
    function displayPatients() {
      const grid = document.getElementById('patientsGrid');
      const list = document.getElementById('patientsList');
      grid.innerHTML = '';
      list.innerHTML = '';
      
      if (filteredPatients.length === 0) {
        document.getElementById('patientsGrid').style.display = 'none';
        document.getElementById('patientsList').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        
        if (currentStatusFilter !== 'all') {
          document.getElementById('emptyMessage').textContent = `No patients found with status: ${currentStatusFilter}`;
        } else {
          document.getElementById('emptyMessage').textContent = 'No patients match your search criteria.';
          }
          return;
        }
        
      document.getElementById('emptyState').style.display = 'none';
      
      if (currentView === 'grid') {
        document.getElementById('patientsGrid').style.display = 'grid';
        document.getElementById('patientsList').style.display = 'none';
        
        filteredPatients.forEach(patient => {
          const card = createPatientCard(patient);
          grid.appendChild(card);
        });
      } else {
        document.getElementById('patientsGrid').style.display = 'none';
        document.getElementById('patientsList').style.display = 'block';
      
      const table = document.createElement('table');
      table.className = 'table table-hover patients-table align-middle';
      table.innerHTML = `
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Status</th>
            <th scope="col" class="text-end">Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      
      const tbody = table.querySelector('tbody');
      filteredPatients.forEach(patient => {
        const row = createPatientRow(patient);
        tbody.appendChild(row);
      });
      
      list.appendChild(table);
      }
    }

    // Create patient card element
    function createPatientCard(patient) {
      console.log('Creating card for patient:', patient.name, 'ID:', patient.id);
      
      const card = document.createElement('div');
      card.className = 'patient-card';
      card.onclick = () => selectPatient(patient);
      
      const status = patient.status || 'registered';
      let statusClass = status.toLowerCase();
      
      // Normalize status for display
      let displayStatus = status;
      if (status === 'registered') displayStatus = 'Registered';
      else if (status === 'antenatal_care') displayStatus = 'Antenatal Care';
      else if (status === 'labour_care') displayStatus = 'Labour Care';
      else if (status === 'postnatal_care' || status === 'postpartum') displayStatus = 'Postnatal Care';
      
      // Map status to CSS classes
      if (statusClass.includes('antenatal')) statusClass = 'antenatal';
      else if (statusClass.includes('labour')) statusClass = 'labour';
      else if (statusClass.includes('postnatal') || statusClass.includes('postpartum')) statusClass = 'postnatal';
      else if (statusClass === 'registered') statusClass = 'registered';
      else statusClass = 'antenatal'; // fallback
      
    const isHighRisk = patient.high_risk === 'yes' || patient.high_risk === true;
      
      // Calculate GA
      let gaDisplay = '-';
      if (patient.gestational_age) {
        gaDisplay = `${patient.gestational_age} wks`;
      } else if (patient.lmp && patient.lmp !== 'unknown') {
        const ga = calculateGA(patient.lmp);
        gaDisplay = ga ? `${ga} wks` : '-';
      }
      
      // Format EDD
      let eddDisplay = '-';
      if (patient.edd) {
        eddDisplay = formatDate(patient.edd);
      }
    
    const parityDisplay = patient.parity || '-';
    const ageDisplay = patient.age ? `${patient.age} yrs` : '-';
    const riskDisplay = isHighRisk ? 'High Risk' : 'Normal';
      
      card.innerHTML = `
        <div class="patient-header">
          <div>
            <div class="patient-name">${patient.name || 'Unknown'}</div>
          </div>
          <span class="status-badge ${statusClass}">${displayStatus}</span>
        </div>
      <div class="patient-highlight-grid">
        <div class="info-chip">
          <span>Age</span>
          <strong>${ageDisplay}</strong>
        </div>
        <div class="info-chip">
          <span>Parity</span>
          <strong>${parityDisplay}</strong>
        </div>
      </div>
      <div class="patient-stat-grid">
        <div class="info-chip">
          <span>GA</span>
          <strong>${gaDisplay}</strong>
        </div>
        <div class="info-chip">
          <span>EDD</span>
          <strong>${eddDisplay}</strong>
        </div>
        <div class="info-chip ${isHighRisk ? 'risk-high' : 'risk-normal'}">
          <span>Risk</span>
          <strong>${riskDisplay}</strong>
        </div>
      </div>
        <div class="patient-actions">
          <button class="btn-select" data-patient='${JSON.stringify(patient)}' onclick="event.stopPropagation(); handleSelectPatient(this)">
            <i class="fas fa-check-circle"></i> Select Patient
          </button>
          <button class="btn-edit" data-patient-id="${patient.id}" onclick="event.stopPropagation(); handleEditPatient(this)" title="Edit Patient Info">
            <i class="fas fa-edit"></i>
          </button>
        </div>
      `;
      
      return card;
    }

    function createPatientRow(patient) {
      const row = document.createElement('tr');
      row.onclick = () => selectPatient(patient);
      
      const status = (patient.status || 'registered').toLowerCase();
      let statusClass = status;
      if (statusClass.includes('antenatal')) statusClass = 'antenatal';
      else if (statusClass.includes('labour')) statusClass = 'labour';
      else if (statusClass.includes('postnatal') || statusClass.includes('postpartum')) statusClass = 'postnatal';
      else if (statusClass === 'registered') statusClass = 'registered';
      else statusClass = 'antenatal';
      
      let displayStatus = patient.status || 'Registered';
      if (displayStatus === 'antenatal_care') displayStatus = 'Antenatal Care';
      else if (displayStatus === 'labour_care') displayStatus = 'Labour Care';
      else if (displayStatus === 'postnatal_care' || displayStatus === 'postpartum') displayStatus = 'Postnatal Care';
      else if (displayStatus === 'registered') displayStatus = 'Registered';

      const ageDisplay = patient.age ? `${patient.age} yrs` : '-';
      const parityDisplay = patient.parity || '-';

      row.innerHTML = `
        <td>
          <div class="fw-semibold text-dark mb-1">${patient.name || 'Unknown'}</div>
          <div class="text-muted" style="font-size: 0.8rem;">${ageDisplay} ¬∑ Parity: ${parityDisplay}</div>
        </td>
        <td>
          <span class="status-pill ${statusClass}">
            <i class="fas fa-circle" style="font-size: 0.5rem;"></i> ${displayStatus}
          </span>
        </td>
        <td class="actions-cell">
          <button class="btn btn-secondary btn-sm" data-patient-id="${patient.id}" onclick="event.stopPropagation(); handleEditPatient(this)">
            <i class="fas fa-edit"></i>
          </button>
        </td>
      `;

      return row;
    }

    // Handle select patient button click
    function handleSelectPatient(button) {
      try {
        const patientData = button.getAttribute('data-patient');
        const patient = JSON.parse(patientData);
        selectPatient(patient);
      } catch (error) {
        console.error('Error parsing patient data:', error);
        alert('Error selecting patient: ' + error.message);
      }
    }

    // Handle edit patient button click
    function handleEditPatient(button) {
      try {
        const patientId = button.getAttribute('data-patient-id');
        console.log('Edit patient clicked, patientId:', patientId);
        
        if (!patientId || patientId === 'undefined' || patientId === 'null') {
          alert('No patient ID found. Please try again.');
          return;
        }
        
        window.location.href = `edit-patient.html?id=${patientId}`;
      } catch (error) {
        console.error('Error navigating to edit patient:', error);
        alert('Error opening patient edit page: ' + error.message);
      }
    }

    // Select patient and save to session
    function selectPatient(patient) {
      console.log('Selecting patient:', patient);
      
      // Save to session storage
      sessionStorage.setItem('selectedPatientId', patient.id);
      sessionStorage.setItem('selectedPatientData', JSON.stringify(patient));
      
      // Add to recent patients
      addToRecentPatients(patient);
      
      // Redirect: OG doctors to LCG-only hub if email ends with @test.com
      try {
        const user = firebase && firebase.auth ? firebase.auth().currentUser : null;
        const email = user && user.email ? user.email : '';
        if (email && /@test\.com$/i.test(email)) {
          sessionStorage.setItem('lcgOnly', '1');
          window.location.href = 'patient-care-hub-lcg.html';
          return;
        }
      } catch (e) {
        console.warn('Email check failed, defaulting to full hub.', e);
      }
      // Default: full hub
      sessionStorage.removeItem('lcgOnly');
      window.location.href = 'patient-care-hub.html';
    }

    // Edit patient (legacy function for backward compatibility)
    function editPatient(patientId) {
      console.log('Edit patient clicked, patientId:', patientId);
      try {
        if (!patientId || patientId === 'undefined' || patientId === 'null') {
          alert('No patient ID found. Please try again.');
          return;
        }
        window.location.href = `edit-patient.html?id=${patientId}`;
      } catch (error) {
        console.error('Error navigating to edit patient:', error);
        alert('Error opening patient edit page: ' + error.message);
      }
    }

    // Filter patients by status
    function setStatusFilter(status) {
      currentStatusFilter = status;
      
      // Update active chip
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
      });
      event.target.closest('.filter-chip').classList.add('active');
      
      // Update section title
      if (status === 'all') {
        document.getElementById('sectionTitleText').textContent = 'All Patients';
      } else {
        document.getElementById('sectionTitleText').textContent = `${status} Patients`;
      }
      
      // Apply filter
      filterPatients();
    }

    // Filter patients by search and status
    function filterPatients() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      
      filteredPatients = allPatients.filter(patient => {
        // Status filter
        if (currentStatusFilter !== 'all') {
          const patientStatus = patient.status || 'registered';
          // Handle different status formats
          let normalizedStatus = patientStatus.toLowerCase();
          if (normalizedStatus === 'antenatal_care') normalizedStatus = 'antenatal';
          if (normalizedStatus === 'labour_care') normalizedStatus = 'labour care';
          if (normalizedStatus === 'postnatal_care' || normalizedStatus === 'postpartum') normalizedStatus = 'postnatal';
          
          const normalizedFilter = currentStatusFilter.toLowerCase();
          if (normalizedStatus !== normalizedFilter) return false;
        }
        
        // Search filter
        if (searchTerm) {
          const name = (patient.name || '').toLowerCase();
          const phone = (patient.phone || '').toLowerCase();
          const address = (patient.patient_address || patient.patientAddress || '').toLowerCase();
          const id = patient.id.toLowerCase();
          
          if (!name.includes(searchTerm) && 
              !phone.includes(searchTerm) && 
              !address.includes(searchTerm) &&
              !id.includes(searchTerm)) {
            return false;
          }
        }
        
        return true;
      });
      
      displayPatients();
    }

    function toggleViewMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('viewToggleMenu');
      const button = document.getElementById('viewToggleButton');
      if (!menu || !button) return;
      const isOpen = menu.classList.contains('show');
      if (isOpen) {
        closeViewMenu();
      } else {
        menu.classList.add('show');
        button.setAttribute('aria-expanded', 'true');
      }
    }

    function closeViewMenu() {
      const menu = document.getElementById('viewToggleMenu');
      const button = document.getElementById('viewToggleButton');
      if (menu) {
        menu.classList.remove('show');
      }
      if (button) {
        button.setAttribute('aria-expanded', 'false');
      }
    }

    function setView(view, event) {
      if (event) {
        event.stopPropagation();
      }
      if (currentView === view) {
        closeViewMenu();
        return;
      }
      currentView = view;
      updateViewToggleUI();
      closeViewMenu();
      displayPatients();
    }

    function updateViewToggleUI() {
      const options = document.querySelectorAll('.view-toggle-option');
      options.forEach(option => {
        if (option.getAttribute('data-view') === currentView) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });

      const buttonIcon = document.querySelector('#viewToggleButton i');
      if (buttonIcon) {
        buttonIcon.className = currentView === 'grid' ? 'fas fa-th-large' : 'fas fa-list-ul';
      }
    }

    document.addEventListener('click', (event) => {
      const menu = document.getElementById('viewToggleMenu');
      const button = document.getElementById('viewToggleButton');
      if (!menu || !button) return;
      if (!menu.contains(event.target) && !button.contains(event.target)) {
        closeViewMenu();
      }
    });

    updateViewToggleUI();

    // Load recent patients from localStorage
    function loadRecentPatients() {
      const recent = localStorage.getItem('recentPatients');
      if (recent) {
        recentPatients = JSON.parse(recent);
        
        if (recentPatients.length > 0) {
          displayRecentPatients();
        }
      }
    }

    // Display recent patients
    function displayRecentPatients() {
      const section = document.getElementById('recentPatientsSection');
      const grid = document.getElementById('recentPatientsGrid');
      
      grid.innerHTML = '';
      
      // Show only last 3 recent patients
      const recentToShow = recentPatients.slice(0, 3);
      
      recentToShow.forEach(patientId => {
        const patient = allPatients.find(p => p.id === patientId);
        if (patient) {
          const card = createPatientCard(patient);
          grid.appendChild(card);
        }
      });
      
      if (recentToShow.length > 0) {
        section.style.display = 'block';
      }
    }

    // Add patient to recent patients
    function addToRecentPatients(patient) {
      // Remove if already exists
      recentPatients = recentPatients.filter(id => id !== patient.id);
      
      // Add to beginning
      recentPatients.unshift(patient.id);
      
      // Keep only last 5
      recentPatients = recentPatients.slice(0, 5);
      
      // Save to localStorage
      localStorage.setItem('recentPatients', JSON.stringify(recentPatients));
    }

    // Calculate Gestational Age from LMP
    function calculateGA(lmp) {
      if (!lmp || lmp === 'unknown') return null;
      
      let lmpDate;
      if (lmp.toDate) {
        lmpDate = lmp.toDate();
      } else if (lmp.seconds) {
        lmpDate = new Date(lmp.seconds * 1000);
      } else {
        lmpDate = new Date(lmp);
      }
      
      const today = new Date();
      const diffTime = Math.abs(today - lmpDate);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      const weeks = Math.floor(diffDays / 7);
      
      return weeks;
    }

    // Format date
    function formatDate(date) {
      if (!date) return '-';
      
      let dateObj;
      if (date.toDate) {
        dateObj = date.toDate();
      } else if (date.seconds) {
        dateObj = new Date(date.seconds * 1000);
      } else {
        dateObj = new Date(date);
      }
      
      return dateObj.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    }
  </script>
</body>
</html>
