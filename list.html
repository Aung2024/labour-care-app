<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Patient Management Hub - Maternal & Child Health Care System</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root {
      --primary-color: #2563eb;
      --secondary-color: #1e40af;
      --success-color: #059669;
      --warning-color: #d97706;
      --danger-color: #dc2626;
      --info-color: #0891b2;
      --light-bg: #f8fafc;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --card-hover-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .header-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .brand-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .brand-subtitle {
      font-size: 1.1rem;
      color: #64748b;
      margin-bottom: 1.5rem;
    }

    .user-info {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--card-shadow);
    }

    .user-details {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .content-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-antenatal { background: #d1fae5; color: #065f46; }
    .status-labour { background: #fee2e2; color: #991b1b; }
    .status-postpartum { background: #ede9fe; color: #5b21b6; }
    .status-baby { background: #fef3c7; color: #92400e; }
    .status-other { background: #f3f4f6; color: #374151; }
    .status-transferred { background: #dbeafe; color: #1e40af; }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .table {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
    }

    .table thead th {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border: none;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.875rem;
    }

    .table tbody tr {
      transition: all 0.3s ease;
    }

    .table tbody tr:hover {
      background-color: #f8fafc;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .search-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 1.5rem;
      text-align: center;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--card-hover-shadow);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: #64748b;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .footer {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      color: white;
      text-align: center;
      padding: 2rem;
      margin-top: 2rem;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Action buttons styling */
    .dropdown-toggle::after {
      margin-left: 0.5em;
    }

    .btn-group .btn {
      border-radius: 0.375rem;
    }

    .dropdown-menu {
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .dropdown-item {
      padding: 0.5rem 1rem;
      transition: all 0.2s ease;
    }

    .dropdown-item:hover {
      background-color: #f8fafc;
      color: #1f2937;
    }

    .dropdown-item i {
      width: 16px;
      text-align: center;
    }

    /* Risk badges styling */
    .badge {
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
    }

    /* Responsive action buttons */
    @media (max-width: 768px) {
      .d-flex.flex-wrap {
        flex-direction: column;
        gap: 0.25rem;
      }
      
      .btn-group {
        width: 100%;
      }
      
      .btn-group .btn {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 768px) {
      .main-container {
        padding: 1rem;
      }
      
      .stats-container {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
      
      .user-info {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
      
      .brand-title {
        font-size: 2rem;
      }
    }
  </style>
 
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  <script>
    let currentUser = null;
    let userRole = null;
    let userTownship = null;
    let patientStats = {
      total: 0,
      antenatal: 0,
      labour: 0,
      postpartum: 0,
      baby: 0,
      other: 0,
      transferred: 0
    };

    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
        loadUserData();
      }
    });

    function loadUserData() {
      db.collection("users").doc(currentUser.uid).get().then(doc => {
        if (doc.exists) {
          const userData = doc.data();
          userRole = userData.role;
          userTownship = userData.township;
          
          document.getElementById("userEmail").textContent = currentUser.email;
          document.getElementById("userRole").textContent = userData.role;
          
          // Load patients after user data is loaded
          loadPatients();
          
          // If Super Admin, also migrate existing patients
          if (userRole === "Super Admin" || userRole === "admin") {
            migrateExistingPatients();
          }
        }
      });
    }
  </script>
</head>
<body>
  <div class="main-container">
    <!-- Header Section -->
    <div class="header-section">
      <div class="text-center mb-4">
        <h1 class="brand-title">
          <i class="fas fa-users me-3"></i>
          Patient Management Hub
        </h1>
        <p class="brand-subtitle">
          Comprehensive patient management for all maternal and child health care
        </p>
      </div>
      
      <div class="user-info">
        <div class="user-details">
          <div class="user-avatar">
            <i class="fas fa-user-md"></i>
          </div>
          <div>
            <div id="userEmail" class="fw-bold"></div>
            <div id="userRole" class="small"></div>
          </div>
        </div>
        <div>
          <a href="testindex.html" class="btn btn-outline-light btn-sm me-2">
            <i class="fas fa-home me-2"></i>Home
          </a>
          <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
            <i class="fas fa-sign-out-alt me-2"></i>Logout
          </button>
        </div>
      </div>
    </div>
    <!-- Patient Statistics -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-number" id="totalPatients">0</div>
        <div class="stat-label">Total Patients</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="antenatalPatients">0</div>
        <div class="stat-label">Antenatal</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="labourPatients">0</div>
        <div class="stat-label">Labour Care</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="postpartumPatients">0</div>
        <div class="stat-label">Postpartum</div>
      </div>
    </div>

    <!-- Search and Actions -->
    <div class="search-container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" id="searchInput" class="form-control" placeholder="Search by name, age, parity, risk, EDD, GA, or status...">
            <button class="btn btn-primary" onclick="loadPatients()">
              <i class="fas fa-search me-2"></i>Search
            </button>
          </div>
        </div>
        <div class="col-md-4 text-end">
          <a href="patient-enhanced.html" class="btn btn-success me-2">
            <i class="fas fa-user-plus me-2"></i>Register New Patient
          </a>
          <button class="btn btn-outline-primary" onclick="loadPatients()">
            <i class="fas fa-sync-alt me-2"></i>Refresh
          </button>
        </div>
      </div>
    </div>

    <!-- Patient List -->
    <div class="content-card">
      <div class="table-responsive">
        <table class="table table-hover align-middle" id="patientsTable">
          <thead>
            <tr>
              <th><i class="fas fa-hashtag me-2"></i>#</th>
              <th><i class="fas fa-user me-2"></i>Name</th>
              <th><i class="fas fa-calendar me-2"></i>Age</th>
              <th><i class="fas fa-baby me-2"></i>Parity</th>
              <th><i class="fas fa-exclamation-triangle me-2"></i>Risk</th>
              <th><i class="fas fa-calendar-check me-2"></i>EDD</th>
              <th><i class="fas fa-clock me-2"></i>GA</th>
              <th><i class="fas fa-heartbeat me-2"></i>Status</th>
              <th><i class="fas fa-cogs me-2"></i>Patient Management</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    async function loadPatients() {
      try {
        console.log('Loading patients for user:', currentUser?.uid, 'Role:', userRole, 'Township:', userTownship);
        const tableBody = document.querySelector("#patientsTable tbody");
        tableBody.innerHTML = "";
        
        if (!currentUser) {
          console.log('No current user, returning');
          return;
        }
        
        let snap;
        
        // Determine access level based on user role
        if (userRole === "Super Admin" || userRole === "admin") {
          // For Super Admin, get all patients and sort client-side to handle missing created_at field
          snap = await db.collection("patients").get({ source: "server" });
        } else if (userRole === "TMO") {
          snap = await db.collection("patients").where("township", "==", userTownship).get({ source: "server" });
        } else if (userRole === "Midwife" || userRole === "midwife") {
          // For Midwives, get patients created by them using both field names for compatibility
          const snapNew = await db.collection("patients").where("created_by", "==", currentUser.uid).get({ source: "server" });
          const snapOld = await db.collection("patients").where("createdBy", "==", currentUser.uid).get({ source: "server" });
          
          // Combine both snapshots and remove duplicates
          const combinedDocs = new Map();
          
          snapNew.forEach(doc => {
            combinedDocs.set(doc.id, doc);
          });
          
          snapOld.forEach(doc => {
            if (!combinedDocs.has(doc.id)) {
              combinedDocs.set(doc.id, doc);
            }
          });
          
          // Create a combined snapshot-like object
          snap = {
            forEach: (callback) => {
              combinedDocs.forEach(callback);
            }
          };
        } else {
          // fallback: no access
          snap = { forEach: () => {} };
        }
        
        const search = document.getElementById("searchInput").value.trim().toLowerCase();
        let serial = 1;
        let stats = { total: 0, antenatal: 0, labour: 0, postpartum: 0 };
        
        // Convert snapshot to array and sort by creation date (newest first)
        const patients = [];
        snap.forEach(doc => {
          const data = doc.data();
          
          // Add migration support for old patients
          if (data.createdBy && !data.created_by) {
            data.created_by = data.createdBy;
          }
          if (data.treatmentStatus && !data.status) {
            data.status = data.treatmentStatus === 'active' ? 'antenatal' : data.treatmentStatus;
          }
          if (!data.created_at) {
            // For old patients without created_at, use a default timestamp
            data.created_at = new Date('2024-01-01'); // Default old date
          }
          
          patients.push({ id: doc.id, data: data });
        });
        
        console.log(`Found ${patients.length} patients total`);
        if (patients.length > 0) {
          console.log('Sample patient data:', patients[0]);
        }
        
        // Sort by creation date (newest first)
        patients.sort((a, b) => {
          const dateA = a.data.created_at ? (a.data.created_at.toDate ? a.data.created_at.toDate() : new Date(a.data.created_at)) : new Date(0);
          const dateB = b.data.created_at ? (b.data.created_at.toDate ? b.data.created_at.toDate() : new Date(b.data.created_at)) : new Date(0);
          return dateB - dateA; // Descending order (newest first)
        });
        
        let displayedCount = 0;
        patients.forEach(patient => {
          const d = patient.data;
          
          // Check if patient matches search criteria
          const matchesSearch = !search ||
            (d.name && d.name.toLowerCase().includes(search)) ||
            (d.age && String(d.age).includes(search)) ||
            (d.parity && d.parity.toLowerCase().includes(search)) ||
            (d.high_risk && d.high_risk.toLowerCase().includes(search)) ||
            (d.edd && d.edd.toString().toLowerCase().includes(search)) ||
            (d.manual_edd && d.manual_edd.toString().toLowerCase().includes(search)) ||
            (d.gestational_age && String(d.gestational_age).includes(search)) ||
            (d.manual_gestational_age && String(d.manual_gestational_age).includes(search)) ||
            (d.status && d.status.toLowerCase().includes(search));
          
          if (matchesSearch) {
            displayedCount++;
            const tr = document.createElement("tr");
            
            // Get status - check both new 'status' field and old 'treatmentStatus' field
            const status = d.status || d.treatmentStatus || 'antenatal';
            const statusClass = getStatusClass(status);
            const statusText = getStatusText(status);
            
            // Update statistics - map to 3 main statuses
            stats.total++;
            
            // Map status to one of the 3 main statuses
            let mappedStatus = 'antenatal'; // default
            if (status === 'antenatal' || status === 'active') {
              mappedStatus = 'antenatal';
            } else if (status === 'labour' || status === 'labour care') {
              mappedStatus = 'labour';
            } else if (status === 'postpartum' || status === 'baby' || status === 'transferred' || status === 'other' || status === 'birthed') {
              mappedStatus = 'postpartum';
            }
            
            stats[mappedStatus]++;
            
            // Format risk display
            const riskDisplay = d.high_risk === 'yes' ? '<span class="badge bg-danger">High Risk</span>' : '<span class="badge bg-success">Standard</span>';
            
            // Format EDD display
            let eddDisplay = d.edd || d.manual_edd || '<span class="text-muted">Not set</span>';
            if (eddDisplay !== '<span class="text-muted">Not set</span>' && typeof eddDisplay === 'string') {
              const eddDate = new Date(eddDisplay);
              if (!isNaN(eddDate.getTime())) {
                eddDisplay = eddDate.toLocaleDateString();
              }
            }
            
            // Format GA display
            let gaDisplay = d.gestational_age || d.manual_gestational_age || '<span class="text-muted">Not calculated</span>';
            if (gaDisplay !== '<span class="text-muted">Not calculated</span>' && typeof gaDisplay === 'number') {
              gaDisplay = `${gaDisplay}w`;
            }
            
            tr.innerHTML = `
              <td>${serial++}</td>
              <td><strong>${d.name || ""}</strong></td>
              <td>${d.age || ""}</td>
              <td>${d.parity || ""}</td>
              <td>${riskDisplay}</td>
              <td><small>${eddDisplay}</small></td>
              <td><small>${gaDisplay}</small></td>
              <td><span class="status-badge ${statusClass}">${statusText}</span></td>
              <td>
                <div class="d-flex flex-wrap gap-1 align-items-center">
                  <!-- Edit Patient Info Button -->
                  <a href="edit-patient.html?patient=${patient.id}" class="btn btn-sm btn-outline-primary" title="Edit Patient Info">
                    <i class="fas fa-user-edit me-1"></i>Edit
                  </a>
                  
                  <!-- Antenatal Care Button -->
                  <a href="antenatal-form.html?patient=${patient.id}" class="btn btn-sm btn-success" title="Antenatal Care">
                    <i class="fas fa-baby-carriage me-1"></i>ANC
                  </a>
                  
                  <!-- Labour Care Button -->
                  <a href="summary.html?patient=${patient.id}" class="btn btn-sm btn-danger" title="Labour Care">
                    <i class="fas fa-heartbeat me-1"></i>Labour
                  </a>
                  
                  <!-- Postnatal Care Button -->
                  <a href="baby.html?patient=${patient.id}" class="btn btn-sm btn-warning" title="Postnatal Care">
                    <i class="fas fa-hands-holding-child me-1"></i>PNC
                  </a>
                  
                  <!-- Reports Dropdown -->
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-info dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Generate Reports">
                      <i class="fas fa-file-alt me-1"></i>Reports
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="patient-info-report.html?patient=${patient.id}">
                        <i class="fas fa-user me-2"></i>Patient Info Report
                      </a></li>
                      <li><a class="dropdown-item" href="antenatal-report.html?patient=${patient.id}">
                        <i class="fas fa-chart-line me-2"></i>Antenatal Report
                      </a></li>
                      <li><a class="dropdown-item" href="summary-view.html?patient=${patient.id}">
                        <i class="fas fa-clipboard-list me-2"></i>Labour Care Summary
                      </a></li>
                      <li><a class="dropdown-item" href="baby-report.html?patient=${patient.id}">
                        <i class="fas fa-baby me-2"></i>Postnatal Report
                      </a></li>
                    </ul>
                  </div>
                  
                  <!-- Delete Button -->
                  <button class="btn btn-sm btn-outline-danger" onclick="deletePatient('${patient.id}', this)" title="Delete Patient">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            `;
            tableBody.appendChild(tr);
          }
        });
        
        console.log(`Displayed ${displayedCount} patients out of ${patients.length} total`);
        console.log('Final stats:', stats);
        
        // Update statistics display
        updateStatsDisplay(stats);
        
      } catch (error) {
        console.error("Error loading patients:", error);
        const tableBody = document.querySelector("#patientsTable tbody");
        tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Error loading patients: ${error.message}</td></tr>`;
      }
    }

    function updateStatsDisplay(stats) {
      document.getElementById('totalPatients').textContent = stats.total;
      document.getElementById('antenatalPatients').textContent = stats.antenatal;
      document.getElementById('labourPatients').textContent = stats.labour;
      document.getElementById('postpartumPatients').textContent = stats.postpartum;
    }
    async function deletePatient(id, btn) {
      try {
        // Check if user has permission to delete this patient
        const user = firebase.auth().currentUser;
        if (!user) {
          alert("You must be logged in to delete patients.");
          return;
        }
        
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (!userDoc.exists) {
          alert("User profile not found.");
          return;
        }
        
        const userData = userDoc.data();
        
        // Super Admin can delete any patient - no need to check patient data
        if (userData.role === "Super Admin" || userData.role === "admin") {
          if (confirm("Are you sure you want to delete this patient?")) {
            await db.collection("patients").doc(id).delete();
            btn.closest("tr").remove();
          }
          return;
        }
        
        // For other roles, check patient data
        const patientDoc = await db.collection("patients").doc(id).get();
        
        if (!patientDoc.exists) {
          alert("Patient not found.");
          return;
        }
        
        const patientData = patientDoc.data();
        let canDelete = false;
        
        if (userData.role === "TMO") {
          canDelete = patientData.township === userData.township;
        } else if (userData.role === "Midwife" || userData.role === "midwife") {
          // Check both new and old field names for compatibility
          canDelete = patientData.created_by === user.uid || patientData.createdBy === user.uid;
        }
        
        if (!canDelete) {
          alert("You don't have permission to delete this patient.");
          return;
        }
        
        // Proceed with deletion
        if (confirm("Are you sure you want to delete this patient?")) {
          await db.collection("patients").doc(id).delete();
          btn.closest("tr").remove();
        }
      } catch (error) {
        console.error("Error deleting patient:", error);
        alert("Error deleting patient: " + error.message);
      }
    }
    
    // Helper function to get status badge class
    function getStatusClass(status) {
      switch(status) {
        case 'antenatal':
        case 'active': // Old treatmentStatus value
          return 'status-antenatal';
        case 'labour':
        case 'labour care': // Handle variations
          return 'status-labour';
        case 'postpartum':
        case 'baby': // Legacy status - treat as postpartum
        case 'transferred': // Legacy status - treat as postpartum
        case 'other': // Legacy status - treat as postpartum
        case 'birthed': // Legacy status - treat as postpartum
          return 'status-postpartum';
        default:
          return 'status-antenatal';
      }
    }
    
    // Helper function to get status display text
    function getStatusText(status) {
      switch(status) {
        case 'antenatal':
        case 'active': // Old treatmentStatus value
          return 'Antenatal';
        case 'labour':
        case 'labour care': // Handle variations
          return 'Labour Care';
        case 'postpartum':
        case 'baby': // Legacy status - treat as postpartum
        case 'transferred': // Legacy status - treat as postpartum
        case 'other': // Legacy status - treat as postpartum
        case 'birthed': // Legacy status - treat as postpartum
          return 'Postpartum Care';
        default:
          return 'Antenatal';
      }
    }
    
    // Check and migrate existing patients without township
    async function migrateExistingPatients() {
      try {
        const user = firebase.auth().currentUser;
        if (!user) return;
        
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (!userDoc.exists) return;
        
        const userData = userDoc.data();
        
        // Only Super Admin can migrate data
        if (userData.role !== "Super Admin" && userData.role !== "admin") {
          return;
        }
        
        // Check for patients without township
        const patientsWithoutTownship = await db.collection("patients")
          .where("township", "==", null)
          .limit(10)
          .get();
        
        if (!patientsWithoutTownship.empty) {
          console.log(`Found ${patientsWithoutTownship.size} patients without township`);
          
          // For each patient without township, try to get it from the creator
          for (const doc of patientsWithoutTownship.docs) {
            const patientData = doc.data();
            const creatorId = patientData.created_by || patientData.createdBy;
            if (creatorId) {
              try {
                const creatorDoc = await db.collection("users").doc(creatorId).get();
                if (creatorDoc.exists) {
                  const creatorData = creatorDoc.data();
                  if (creatorData.township) {
                    await doc.ref.update({
                      township: creatorData.township,
                      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log(`Updated patient ${doc.id} with township: ${creatorData.township}`);
                  }
                }
              } catch (error) {
                console.error(`Error updating patient ${doc.id}:`, error);
              }
            }
          }
        }
      } catch (error) {
        console.error('Error migrating patients:', error);
      }
    }


    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
      notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(notification);
      
      // Auto-remove after 3 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }
    
    // loadPatients(); // Removed - now called in auth callback
  </script>

  <footer class="footer">
    <div class="container">
      <p class="mb-0">
        <i class="fas fa-heart me-2"></i>
        Â© 2025 Maternal & Child Health Care System &mdash; Designed for clinical excellence - Powered by Jhpiego Myanmar
      </p>
    </div>
  </footer>
</body>
</html>