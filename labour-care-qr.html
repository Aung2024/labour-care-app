<!DOCTYPE html>
<html lang="en">
<head>
  <title>Quick Labour Care Access - Maternal & Child Health Care System</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    
    .access-container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .access-header {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 40px;
      text-align: center;
    }
    
    .access-header h1 {
      margin: 0;
      font-size: 2.5rem;
      font-weight: 700;
    }
    
    .access-header p {
      margin: 10px 0 0 0;
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .access-content {
      padding: 40px;
    }
    
    .status-card {
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .status-success {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      border: 1px solid #10b981;
      color: #065f46;
    }
    
    .status-error {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      border: 1px solid #ef4444;
      color: #991b1b;
    }
    
    .status-loading {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      border: 1px solid #3b82f6;
      color: #1e40af;
    }
    
    .patient-info {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
    }
    
    .patient-info h3 {
      color: #374151;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .patient-info h3 i {
      color: #10b981;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .info-item {
      display: flex;
      flex-direction: column;
    }
    
    .info-label {
      font-size: 0.9rem;
      color: #6b7280;
      font-weight: 500;
      margin-bottom: 5px;
    }
    
    .info-value {
      font-weight: 600;
      color: #374151;
    }
    
    .access-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn-access {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-access:hover {
      background: linear-gradient(135deg, #059669, #047857);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
      color: white;
      text-decoration: none;
    }
    
    .btn-secondary {
      background: #6b7280;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
      transform: translateY(-1px);
      color: white;
      text-decoration: none;
    }
    
    .token-info {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      font-size: 0.9rem;
      color: #0369a1;
    }
    
    .spinner-border {
      width: 2rem;
      height: 2rem;
      border-width: 0.3em;
    }
    
    .footer {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      color: #374151;
      text-align: center;
      padding: 2rem;
      margin-top: 2rem;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    @media (max-width: 768px) {
      .access-buttons {
        flex-direction: column;
      }
      
      .btn-access, .btn-secondary {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="access-container">
      <!-- Header -->
      <div class="access-header">
        <h1><i class="fas fa-qrcode"></i> Quick Labour Care Access</h1>
        <p>Scanning QR code for direct access...</p>
      </div>
      
      <!-- Content -->
      <div class="access-content">
        <!-- Status Card -->
        <div class="status-card" id="statusCard">
          <div class="status-loading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <h4 class="mt-3">Validating Access Token...</h4>
            <p class="mb-0">Please wait while we verify your access permissions.</p>
          </div>
        </div>
        
        <!-- Patient Information -->
        <div class="patient-info" id="patientInfo" style="display: none;">
          <h3><i class="fas fa-user-injured"></i> Patient Information</h3>
          <div class="info-grid" id="patientInfoGrid">
            <!-- Patient info will be populated here -->
          </div>
        </div>
        
        <!-- Token Information -->
        <div class="token-info" id="tokenInfo" style="display: none;">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Access Token Valid</strong> - This session will expire automatically for security.
        </div>
        
        <!-- Access Buttons -->
        <div class="access-buttons" id="accessButtons" style="display: none;">
          <a href="#" class="btn-access" id="labourCareBtn">
            <i class="fas fa-heartbeat"></i>
            Access Labour Care
          </a>
          <a href="#" class="btn-access" id="summaryBtn">
            <i class="fas fa-clipboard-list"></i>
            View Summary
          </a>
          <a href="index.html" class="btn-secondary">
            <i class="fas fa-home"></i>
            Go to Dashboard
          </a>
        </div>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
      <p class="mb-0">
        <i class="fas fa-heart me-2"></i>
        © 2025 Maternal & Child Health Care System — Designed for clinical excellence - Powered by Jhpiego Myanmar
      </p>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  
  <script>
    let accessToken = null;
    let patientData = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const tokenParam = urlParams.get('token');
        
        if (!tokenParam) {
          showError('No access token provided. Please scan a valid QR code.');
          return;
        }
        
        // Decode and validate token
        accessToken = JSON.parse(atob(decodeURIComponent(tokenParam)));
        
        // Validate token
        const isValid = await validateAccessToken(accessToken);
        
        if (!isValid) {
          showError('Access token is invalid or expired. Please generate a new QR code.');
          return;
        }
        
        // Load patient data
        await loadPatientData(accessToken.patientId);
        
        // Show success
        showSuccess();
        
        // Mark token as used
        await markTokenAsUsed();
        
      } catch (error) {
        console.error('Error initializing QR access:', error);
        showError('Error processing access token: ' + error.message);
      }
    });

    // Validate access token
    async function validateAccessToken(token) {
      try {
        // Check if token is expired
        if (Date.now() > token.expiresAt) {
          return false;
        }
        
        // Check if token exists in Firestore and hasn't been used
        const tokensSnap = await firebase.firestore()
          .collection('access_tokens')
          .where('token', '==', btoa(JSON.stringify(token)))
          .where('used', '==', false)
          .get();
        
        return !tokensSnap.empty;
        
      } catch (error) {
        console.error('Error validating token:', error);
        return false;
      }
    }

    // Load patient data
    async function loadPatientData(patientId) {
      try {
        const patientDoc = await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .get();
        
        if (!patientDoc.exists) {
          throw new Error('Patient not found');
        }
        
        patientData = patientDoc.data();
        patientData.id = patientId;
        
      } catch (error) {
        console.error('Error loading patient data:', error);
        throw new Error('Could not load patient information');
      }
    }

    // Mark token as used
    async function markTokenAsUsed() {
      try {
        const tokensSnap = await firebase.firestore()
          .collection('access_tokens')
          .where('token', '==', btoa(JSON.stringify(accessToken)))
          .get();
        
        if (!tokensSnap.empty) {
          await tokensSnap.docs[0].ref.update({
            used: true,
            usedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      } catch (error) {
        console.error('Error marking token as used:', error);
      }
    }

    // Show success state
    function showSuccess() {
      const statusCard = document.getElementById('statusCard');
      statusCard.innerHTML = `
        <div class="status-success">
          <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
          <h4>Access Granted!</h4>
          <p class="mb-0">You now have direct access to labour care for this patient.</p>
        </div>
      `;
      
      // Show patient info
      displayPatientInfo();
      document.getElementById('patientInfo').style.display = 'block';
      document.getElementById('tokenInfo').style.display = 'block';
      
      // Setup access buttons
      setupAccessButtons();
      document.getElementById('accessButtons').style.display = 'flex';
    }

    // Show error state
    function showError(message) {
      const statusCard = document.getElementById('statusCard');
      statusCard.innerHTML = `
        <div class="status-error">
          <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
          <h4>Access Denied</h4>
          <p class="mb-0">${message}</p>
          <a href="index.html" class="btn btn-light mt-3">
            <i class="fas fa-home me-2"></i>Go to Dashboard
          </a>
        </div>
      `;
    }

    // Display patient information
    function displayPatientInfo() {
      const patientInfoGrid = document.getElementById('patientInfoGrid');
      patientInfoGrid.innerHTML = `
        <div class="info-item">
          <span class="info-label">Patient Name</span>
          <span class="info-value">${patientData.name || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Age</span>
          <span class="info-value">${patientData.age || 'N/A'} years</span>
        </div>
        <div class="info-item">
          <span class="info-label">Parity</span>
          <span class="info-value">${patientData.parity || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Status</span>
          <span class="info-value">${patientData.status || 'Unknown'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Labour Onset</span>
          <span class="info-value">${patientData.labour_onset || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Active Labour</span>
          <span class="info-value">${patientData.active_labour || 'N/A'}</span>
        </div>
      `;
    }

    // Setup access buttons with proper URLs
    function setupAccessButtons() {
      const patientId = accessToken.patientId;
      
      // Labour Care button
      document.getElementById('labourCareBtn').href = `summary.html?patient=${patientId}&qr_access=true`;
      
      // Summary button
      document.getElementById('summaryBtn').href = `summary-view.html?patient=${patientId}&qr_access=true`;
    }

    // Auto-redirect to labour care after 5 seconds (optional)
    setTimeout(() => {
      if (accessToken && patientData) {
        const labourCareBtn = document.getElementById('labourCareBtn');
        if (labourCareBtn && confirm('Would you like to go directly to Labour Care now?')) {
          window.location.href = labourCareBtn.href;
        }
      }
    }, 5000);
  </script>
</body>
</html>
