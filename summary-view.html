<!DOCTYPE html>
<html lang="en">
<head>
  <title>WHO Labour Care Guide - Summary View</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    /* A4 Print Styles */
    @page {
      size: A4 portrait;
      margin: 1cm;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      line-height: 1.4;
      color: #333;
      background: white;
    }
    
    .summary-container {
      max-width: 21cm;
      margin: 0 auto;
      padding: 1cm;
      background: white;
    }
    
    /* Header */
    .summary-header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #2c3e50;
      padding-bottom: 15px;
    }
    
    .summary-title {
      font-size: 18px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 5px;
    }
    
    .summary-subtitle {
      font-size: 12px;
      color: #6c757d;
    }
    
    /* Patient Information */
    .patient-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-bottom: 20px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 10px;
    }
    
    .patient-info-item {
      display: flex;
      flex-direction: column;
    }
    
    .patient-info-label {
      font-weight: 600;
      color: #495057;
      text-transform: uppercase;
      font-size: 8px;
      margin-bottom: 2px;
    }
    
    .patient-info-value {
      font-size: 10px;
      color: #212529;
      font-weight: 500;
    }
    
    /* Section Headers */
    .section-header {
      background: #2c3e50;
      color: white;
      padding: 6px 10px;
      margin: 15px 0 8px 0;
      border-radius: 3px;
      font-weight: 600;
      font-size: 11px;
    }
    
    .section-header i {
      margin-right: 5px;
    }
    
    /* Tables */
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      font-size: 8px;
    }
    
    .summary-table th,
    .summary-table td {
      border: 1px solid #dee2e6;
      padding: 3px 2px;
      text-align: center;
      vertical-align: middle;
    }
    
    .summary-table th {
      background: #e9ecef;
      font-weight: 600;
      color: #495057;
      font-size: 7px;
    }
    
    .summary-table .field-column {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
      text-align: left;
      width: 60px;
      font-size: 7px;
    }
    
    .summary-table .alert-column {
      background: #fff3cd;
      font-weight: 600;
      color: #856404;
      font-size: 6px;
      width: 30px;
      min-width: 30px;
      max-width: 30px;
      text-align: center;
      padding: 1px 2px;
    }
    
    /* Alert Value Highlighting - Simple Red Text */
    .alert-value,
    .alert-column .alert-value,
    td.alert-value,
    .alert-value * {
      color: #dc2626 !important;
      font-weight: 700 !important;
      font-size: 7px !important;
    }
    
    /* Alert column thresholds - simple red text */
    .alert-column .alert-value {
      color: #dc2626 !important;
      font-weight: 700 !important;
      font-size: 6px !important;
    }
    
    /* Data cell alert values - simple red text */
    .data-cell.alert-value {
      color: #dc2626 !important;
      font-weight: 700 !important;
      font-size: 7px !important;
    }
    
    /* Ensure alert highlighting works for all alert values */
    .alert-column {
      position: relative !important;
      z-index: 1 !important;
    }
    
    .summary-table .time-column {
      background: #dbeafe;
      color: #1e40af;
      font-weight: 600;
      font-size: 7px;
      width: 25px;
      min-width: 25px;
      padding: 2px 1px;
      text-align: center;
    }
    
    .summary-table .data-cell {
      padding: 2px 1px !important;
      text-align: center !important;
      vertical-align: middle !important;
      font-size: 7px !important;
      line-height: 1.0 !important;
      min-height: 12px !important;
    }
    
    .summary-table .time-column.second-stage {
      background: #dcfce7 !important;
      color: #166534 !important;
    }
    
    .summary-table .data-cell {
      background: white;
      font-size: 7px;
      width: 25px;
    }
    
    .summary-table .data-cell.second-stage {
      background: #dcfce7 !important;
      color: #166534 !important;
    }
    
    /* Override second stage color for alert values - higher specificity */
    .summary-table .data-cell.second-stage.alert-value {
      color: #dc2626 !important;
      font-weight: 700 !important;
    }
    
    /* Ensure alert values in second stage are always red */
    .summary-table .data-cell.second-stage.alert-value,
    .summary-table .data-cell.second-stage .alert-value {
      color: #dc2626 !important;
      font-weight: 700 !important;
    }
    
    /* Action Buttons */
    .action-buttons {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .action-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      font-size: 11px;
    }
    
    .btn-print {
      background: #28a745;
      color: white;
    }
    
    .btn-export {
      background: #17a2b8;
      color: white;
    }
    
    .btn-share {
      background: #6f42c1;
      color: white;
    }
    
    .btn-back {
      background: #6c757d;
      color: white;
    }
    
    /* Print Styles */
    @media print {
      .action-buttons {
        display: none;
      }
      
      .summary-container {
        padding: 0;
        margin: 0;
        max-width: none;
      }
      
      .summary-table {
        page-break-inside: avoid;
        margin-bottom: 8px;
        font-size: 7px;
      }
      
      .section-header {
        page-break-after: avoid;
        margin: 8px 0 4px 0;
        padding: 4px 6px;
        font-size: 10px;
      }
      
      .patient-info {
        margin-bottom: 12px;
        padding: 6px;
      }
      
      .summary-header {
        margin-bottom: 12px;
        padding-bottom: 8px;
      }
      
      .summary-title {
        font-size: 16px;
        margin-bottom: 3px;
      }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .summary-container {
        padding: 10px;
      }
      
      .action-buttons {
        bottom: 10px;
        right: 10px;
      }
      
      .action-btn {
        padding: 6px 10px;
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Action Buttons -->
  <div class="action-buttons">
    <button class="action-btn btn-print" onclick="printSummary()">
      <i class="fas fa-print"></i>
      Print PDF
    </button>
    <button class="action-btn btn-export" onclick="exportToExcel()">
      <i class="fas fa-file-excel"></i>
      Export Excel
    </button>
    <button class="action-btn btn-share" onclick="shareSummary()">
      <i class="fas fa-share-alt"></i>
      Share Link
    </button>
    <button class="action-btn btn-back" onclick="window.history.back()">
      <i class="fas fa-arrow-left"></i>
      Back
    </button>
  </div>

  <div class="summary-container">
    <!-- Header -->
    <div class="summary-header">
      <div class="summary-title">
        <i class="fas fa-clipboard-list"></i>
        WHO Labour Care Guide - Summary Form
      </div>
      <div class="summary-subtitle">
        Clinical Summary for Labour Monitoring and Decision Making
      </div>
    </div>

    <!-- Patient Information -->
    <div class="patient-info">
      <div class="patient-info-item">
        <div class="patient-info-label">Patient Name</div>
        <div class="patient-info-value" id="patientName">Loading...</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Age</div>
        <div class="patient-info-value" id="patientAge">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Parity</div>
        <div class="patient-info-value" id="patientParity">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Labour Onset</div>
        <div class="patient-info-value" id="labourOnset">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Active Labour Start</div>
        <div class="patient-info-value" id="activeLabourStart">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Membranes Ruptured</div>
        <div class="patient-info-value" id="membranesRuptured">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Risk Factors</div>
        <div class="patient-info-value" id="riskFactors">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Second Stage Start</div>
        <div class="patient-info-value" id="secondStageStart">-</div>
      </div>
    </div>

    <!-- Supportive Care Section -->
    <div class="section-header">
      <i class="fas fa-hands-helping"></i>
      Supportive Care
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="supportiveCareTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- FHR Section -->
    <div class="section-header">
      <i class="fas fa-heartbeat"></i>
      FHR
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="fhrTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Baby Section -->
    <div class="section-header">
      <i class="fas fa-baby"></i>
      Baby
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="babyTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Woman Section -->
    <div class="section-header">
      <i class="fas fa-female"></i>
      Woman
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="womanTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Contractions Section -->
    <div class="section-header">
      <i class="fas fa-utensils"></i>
      Contractions
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="contractionsTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Cervix Plot Section -->
    <div class="section-header">
      <i class="fas fa-chart-area"></i>
      Cervix [Plot X]
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="cervixPlotTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Descent Plot Section -->
    <div class="section-header">
      <i class="fas fa-chart-line"></i>
      Descent [Plot O]
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="descentPlotTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Medication Section -->
    <div class="section-header">
      <i class="fas fa-pills"></i>
      Medication
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="medicationTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Shared Decision-Making Section -->
    <div class="section-header">
      <i class="fas fa-comments"></i>
      Shared Decision-Making
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="decisionMakingTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Initials Section -->
    <div class="section-header">
      <i class="fas fa-signature"></i>
      Initials
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="initialsTable">
        <!-- Table will be generated here -->
      </table>
    </div>


  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  
  <script>
    // Global variables
    let patientData = {};
    let summaryData = {};
    let secondStageData = {};
    let activeFirstStageStartTime = null;
    
    // Time column arrays (matching summary.html structure)
    let supportiveCareTimeCols = [];
    let babyBaselineTimeCols = [];
    let babyOtherTimeCols = [];
    let womanTimeCols = [];
    let contractionsTimeCols = [];
    let cervixPlotTimeCols = [];
    let descentPlotTimeCols = [];
    let medicationTimeCols = [];
    let assessmentTimeCols = [];
    let planTimeCols = [];
    let initialsTimeCols = [];
    
    // Get patient ID from URL parameters
    function getPatientIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('patient');
    }
    
    const patientId = getPatientIdFromUrl();
    
    // Load data when page loads
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        // Add a small delay to prevent race condition with auth state
        setTimeout(() => {
          const currentUser = firebase.auth().currentUser;
          if (!currentUser) {
            console.log('No authenticated user found, redirecting to login');
            window.location.href = "login.html";
          }
        }, 100);
      } else {
        console.log('User authenticated:', user.uid);
        loadSummaryData();
      }
    });
    
    // Check if a value should be highlighted as an alert (same logic as summary.html)
    function checkAlertValue(fieldName, value) {
      if (!value) return false;
      
      // Check for alert conditions based on field and value
      if (fieldName.includes('Companion') && value === 'N') {
        return true;
      } else if (fieldName.includes('Mobility') && value === 'SP') {
        return true;
      } else if (fieldName.includes('Baseline_FHR')) {
        const fhr = parseFloat(value);
        if (fhr < 110 || fhr >= 160) {
          return true;
        }
      } else if (fieldName.includes('Pulse')) {
        const pulse = parseFloat(value);
        if (pulse < 60 || pulse >= 120) {
          return true;
        }
      } else if (fieldName.includes('Systolic_BP')) {
        const bp = parseFloat(value);
        if (bp < 80 || bp >= 140) {
          return true;
        }
      } else if (fieldName.includes('Diastolic_BP')) {
        const bp = parseFloat(value);
        if (bp >= 90) {
          return true;
        }
      } else if (fieldName.includes('Temperature_C')) {
        const temp = parseFloat(value);
        if (temp < 35.0 || temp >= 37.5) {
          return true;
        }
      } else if (fieldName.includes('FHR_deceleration') && value === 'L') {
        return true;
      } else if (fieldName.includes('Amniotic_fluid') && (value === 'M+++' || value === 'B')) {
        return true;
      } else if (fieldName.includes('Fetal_position') && (value === 'P' || value === 'T')) {
        return true;
      } else if (fieldName.includes('Caput') && value === '+++') {
        return true;
      } else if (fieldName.includes('Moulding') && value === '+++') {
        return true;
      } else if (fieldName.includes('Pain_Relief') && value === 'N') {
        return true;
      } else if (fieldName.includes('Oral_fluids') && value === 'N') {
        return true;
      } else if (fieldName.includes('Contractions_per_10_min')) {
        const contractions = parseFloat(value);
        if (contractions <= 2 || contractions > 5) {
          return true;
        }
      } else if (fieldName.includes('Duration_of_contractions')) {
        const duration = parseFloat(value);
        if (duration < 20 || duration > 60) {
          return true;
        }
      } else if (fieldName.includes('Urine')) {
        if (value.includes('P++') || value.includes('A++')) {
          return true;
        }
      }
      
      return false;
    }

    // Load all summary data
    async function loadSummaryData() {
      try {
        console.log('Loading summary data for patient:', patientId);
        const base = firebase.firestore().collection("patients").doc(patientId);
        
        // Load patient basic info
        const patientDoc = await base.get();
        if (patientDoc.exists) {
          patientData = patientDoc.data();
          console.log('Patient data loaded:', patientData);
          populatePatientInfo();
        } else {
          console.log('No patient document found');
        }
        
        // Load summary records
        const summaryDoc = await base.collection("records").doc("summary").get();
        if (summaryDoc.exists) {
          summaryData = summaryDoc.data();
          console.log('Summary data loaded:', summaryData);
          
          // Check if starting time is stored in summary data
          if (summaryData.startingTime && !activeFirstStageStartTime) {
            activeFirstStageStartTime = summaryData.startingTime;
            console.log('Active first stage start time loaded from summary data:', activeFirstStageStartTime);
          }
        } else {
          console.log('No summary document found');
        }
        
        // Load medication data from separate collection
        const medicationSnap = await base.collection("medication").get();
        medicationSnap.forEach(doc => {
          const d = doc.data();
          const time = d.time;
          
          // Store oxytocin data
          if (d.oxytocin) {
            summaryData[`Medication_Oxytocin_${time}`] = d.oxytocin;
            if (d.oxytocin === "Yes") {
              summaryData[`Medication_Oxytocin_${time}_UL`] = d.oxytocin_UL || "";
              summaryData[`Medication_Oxytocin_${time}_drops`] = d.oxytocin_drops || "";
            }
          }
          
          // Store medicine data
          if (d.medicine) {
            summaryData[`Medication_Medicine_${time}`] = d.medicine;
            if (d.medicine === "Yes") {
              summaryData[`Medication_Medicine_${time}_text`] = d.medicine_text || "";
            }
          }
          
          // Store IV fluids data
          if (d.iv_fluids) {
            summaryData[`Medication_IV_Fluids_${time}`] = d.iv_fluids;
          }
        });
        
        console.log('Medication data loaded and merged with summary data');
        
        // Load starting time and generate time columns
        const startingTimeDoc = await base.collection("records").doc("startingTime").get();
        if (startingTimeDoc.exists) {
          const startingData = startingTimeDoc.data();
          console.log('Starting time data:', startingData);
          if (startingData.startingTime) {
            activeFirstStageStartTime = startingData.startingTime;
            generateDynamicTimeColumns();
            console.log('Dynamic time columns generated from starting time:', activeFirstStageStartTime);
          } else {
            generateDefaultTimeColumns();
            console.log('Default time columns generated');
          }
        } else {
          console.log('No starting time document found, using defaults');
          // Set a default starting time if none found
          if (!activeFirstStageStartTime) {
            const now = new Date();
            activeFirstStageStartTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            console.log('Using current time as default starting time:', activeFirstStageStartTime);
          }
          generateDefaultTimeColumns();
          console.log('Default time columns generated');
        }
        
        // Load second stage data
        const secondStageDoc = await base.collection("records").doc("secondStage").get();
        if (secondStageDoc.exists) {
          secondStageData = secondStageDoc.data();
          console.log('Second stage data:', secondStageData);
          if (secondStageData.isSecondStageActive) {
            document.getElementById('secondStageStart').textContent = secondStageData.secondStageStartTime || '-';
            
            // Generate hybrid time columns for second stage
            if (activeFirstStageStartTime && secondStageData.secondStageStartTime) {
              console.log('Generating hybrid time columns for second stage...');
              generateHybridTimeColumns();
            }
          }
        } else {
          console.log('No second stage document found');
        }
        
        // Generate all tables
        console.log('Generating tables with dynamic time columns');
        generateAllTables();
        

        
      } catch (error) {
        console.error("Error loading summary data:", error);
        document.body.innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
      }
    }
    
    // Populate patient information
    function populatePatientInfo() {
      document.getElementById('patientName').textContent = patientData.name || 'Not specified';
      document.getElementById('patientAge').textContent = patientData.age || '-';
      document.getElementById('patientParity').textContent = patientData.parity || '-';
      document.getElementById('labourOnset').textContent = patientData.labour_onset || '-';
      document.getElementById('activeLabourStart').textContent = patientData.active_labour || '-';
      document.getElementById('membranesRuptured').textContent = patientData.ruptured_membrane || '-';
      document.getElementById('riskFactors').textContent = patientData.risk_factors || 'None identified';
    }
    
    // Generate dynamic time columns based on starting time (matching summary.html)
    function generateDynamicTimeColumns() {
      console.log('🚀 generateDynamicTimeColumns() called');
      console.log(`  activeFirstStageStartTime: ${activeFirstStageStartTime}`);
      
      if (!activeFirstStageStartTime) {
        // Default fallback - use current time as starting point
        const now = new Date();
        activeFirstStageStartTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        console.log(`  No starting time, using current time: ${activeFirstStageStartTime}`);
      }
      
      const startHour = parseInt(activeFirstStageStartTime.split(':')[0]);
      const startMinute = parseInt(activeFirstStageStartTime.split(':')[1]);
      
      // Supportive Care: +1 hour intervals for 12 hours
      supportiveCareTimeCols = [];
      for (let i = 0; i <= 12; i++) {
        const hour = (startHour + i) % 24;
        supportiveCareTimeCols.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
      }
      
      // Baby Baseline & FHR: +30 minute intervals for 12 hours (FIRST STAGE)
      babyBaselineTimeCols = [];
      for (let i = 0; i <= 24; i++) {
        const totalMinutes = startHour * 60 + startMinute + (i * 30);
        const hour = Math.floor(totalMinutes / 60) % 24;
        const minute = totalMinutes % 60;
        babyBaselineTimeCols.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
      }
      
      // Contractions: +30 minute intervals for 12 hours (FIRST STAGE)
      contractionsTimeCols = [];
      for (let i = 0; i <= 24; i++) {
        const totalMinutes = startHour * 60 + startMinute + (i * 30);
        const hour = Math.floor(totalMinutes / 60) % 24;
        const minute = totalMinutes % 60;
        contractionsTimeCols.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
      }
      
      // Baby Other, Woman, Medication, Assessment, Initials: +1 hour intervals for 12 hours
      babyOtherTimeCols = [];
      womanTimeCols = [];
      medicationTimeCols = [];
      assessmentTimeCols = [];
      initialsTimeCols = [];
      for (let i = 0; i <= 12; i++) {
        const hour = (startHour + i) % 24;
        babyOtherTimeCols.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
        womanTimeCols.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
        medicationTimeCols.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
        assessmentTimeCols.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
        initialsTimeCols.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
      }
      
      // Cervix and Descent Plot: +1 hour intervals
      cervixPlotTimeCols = [...supportiveCareTimeCols];
      descentPlotTimeCols = [...supportiveCareTimeCols];
      
      // Plan: +2 hour intervals
      planTimeCols = [];
      for (let i = 0; i <= 6; i++) {
        const hour = (startHour + (i * 2)) % 24;
        planTimeCols.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
      }
      
      console.log('Generated time columns:', {
        supportiveCare: supportiveCareTimeCols.length,
        babyBaseline: babyBaselineTimeCols.length,
        contractions: contractionsTimeCols.length,
        babyOther: babyOtherTimeCols.length,
        woman: womanTimeCols.length
      });
    }
    
    // Generate hybrid time columns: 30-min before second stage, 15-min after (matching summary.html)
    function generateHybridTimeColumns() {
      console.log('🚀 generateHybridTimeColumns() called');
      console.log(`  activeFirstStageStartTime: ${activeFirstStageStartTime}`);
      console.log(`  secondStageStartTime: ${secondStageData.secondStageStartTime}`);
      console.log(`  isSecondStageActive: ${secondStageData.isSecondStageActive}`);
      
      if (!activeFirstStageStartTime) {
        console.log('❌ No activeFirstStageStartTime, returning early');
        return;
      }
      
      const startHour = parseInt(activeFirstStageStartTime.split(':')[0]);
      const startMinute = parseInt(activeFirstStageStartTime.split(':')[1]);
      console.log(`  Start time: ${startHour}:${startMinute}`);
      
      // Create Date objects for proper time comparison across midnight
      const baseDate = new Date('2024-01-01');
      const startTimeDate = createTimeDate(activeFirstStageStartTime, baseDate);
      const secondStageDate = createTimeDate(secondStageData.secondStageStartTime, baseDate);
      
      // If second stage is earlier than first stage, it means it's the next day
      if (secondStageDate < startTimeDate) {
        secondStageDate.setDate(secondStageDate.getDate() + 1);
      }
      
      // Generate hybrid contractions time columns
      contractionsTimeCols = [];
      let currentTime = new Date(startTimeDate);
      const endTime = new Date(secondStageDate);
      endTime.setHours(endTime.getHours() + 2); // 2 hours after second stage
      
      while (currentTime <= endTime) {
        const timeStr = currentTime.toTimeString().slice(0, 5);
        contractionsTimeCols.push(timeStr);
        
        // Determine interval based on whether we're before or after second stage
        const currentTimeMinutes = currentTime.getHours() * 60 + currentTime.getMinutes();
        const secondStageMinutes = secondStageDate.getHours() * 60 + secondStageDate.getMinutes();
        const startTimeMinutes = startTimeDate.getHours() * 60 + startTimeDate.getMinutes();
        
        // Calculate relative minutes from start time
        let currentRelativeMinutes = currentTimeMinutes - startTimeMinutes;
        if (currentRelativeMinutes < 0) currentRelativeMinutes += 24 * 60; // Handle midnight crossing
        
        let secondStageRelativeMinutes = secondStageMinutes - startTimeMinutes;
        if (secondStageRelativeMinutes < 0) secondStageRelativeMinutes += 24 * 60; // Handle midnight crossing
        
        if (currentRelativeMinutes < secondStageRelativeMinutes) {
          // Before second stage: 30-minute intervals
          currentTime.setMinutes(currentTime.getMinutes() + 30);
        } else {
          // After second stage: 15-minute intervals
          currentTime.setMinutes(currentTime.getMinutes() + 15);
        }
      }
      
      // Generate hybrid FHR time columns
      babyBaselineTimeCols = [];
      currentTime = new Date(startTimeDate);
      
      while (currentTime <= endTime) {
        const timeStr = currentTime.toTimeString().slice(0, 5);
        babyBaselineTimeCols.push(timeStr);
        
        // Determine interval based on whether we're before or after second stage
        const currentTimeMinutes = currentTime.getHours() * 60 + currentTime.getMinutes();
        const secondStageMinutes = secondStageDate.getHours() * 60 + secondStageDate.getMinutes();
        const startTimeMinutes = startTimeDate.getHours() * 60 + startTimeDate.getMinutes();
        
        // Calculate relative minutes from start time
        let currentRelativeMinutes = currentTimeMinutes - startTimeMinutes;
        if (currentRelativeMinutes < 0) currentRelativeMinutes += 24 * 60; // Handle midnight crossing
        
        let secondStageRelativeMinutes = secondStageMinutes - startTimeMinutes;
        if (secondStageRelativeMinutes < 0) secondStageRelativeMinutes += 24 * 60; // Handle midnight crossing
        
        if (currentRelativeMinutes < secondStageRelativeMinutes) {
          // Before second stage: 30-minute intervals
          currentTime.setMinutes(currentTime.getMinutes() + 30);
        } else {
          // After second stage: 15-minute intervals
          currentTime.setMinutes(currentTime.getMinutes() + 15);
        }
      }
      
      console.log('✅ Generated hybrid time columns:');
      console.log(`  Contractions: ${contractionsTimeCols.length} intervals:`, contractionsTimeCols);
      console.log(`  FHR: ${babyBaselineTimeCols.length} intervals:`, babyBaselineTimeCols);
    }
    
    // Generate default time columns if no starting time is available
    function generateDefaultTimeColumns() {
      const now = new Date();
      activeFirstStageStartTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      generateDynamicTimeColumns();
    }
    
    // Generate all tables
    function generateAllTables() {
      generateSupportiveCareTable();
      generateFHRTable();
      generateBabyTable();
      generateWomanTable();
      generateContractionsTable();
      generateCervixPlotTable();
      generateDescentPlotTable();
      generateMedicationTable();
      generateDecisionMakingTable();
      generateInitialsTable();
    }
    
    // Check if a time is in second stage
    function isSecondStageTime(time) {
      if (!secondStageData.isSecondStageActive || !secondStageData.secondStageStartTime) {
        return false;
      }
      
      // Create Date objects for proper time comparison across midnight
      const baseDate = new Date('2024-01-01'); // Use a common base date
      const timeDate = createTimeDate(time, baseDate);
      const secondStageDate = createTimeDate(secondStageData.secondStageStartTime, baseDate);
      const activeFirstStageDate = createTimeDate(activeFirstStageStartTime, baseDate);
      
      // If second stage is earlier than first stage, it means it's the next day
      if (secondStageDate < activeFirstStageDate) {
        // Second stage is next day, so adjust second stage date
        secondStageDate.setDate(secondStageDate.getDate() + 1);
      }
      
      // If current time is earlier than first stage, it means it's the next day
      if (timeDate < activeFirstStageDate) {
        timeDate.setDate(timeDate.getDate() + 1);
      }
      
      return timeDate >= secondStageDate;
    }
    
    // Helper function to create a Date object from time string
    function createTimeDate(timeStr, baseDate) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      const date = new Date(baseDate);
      date.setHours(hours, minutes, 0, 0);
      return date;
    }
    
    // Generate Supportive Care table
    function generateSupportiveCareTable() {
      const table = document.getElementById('supportiveCareTable');
      const fields = ["Companion", "Pain_Relief", "Oral_fluids", "Mobility"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      supportiveCareTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        supportiveCareTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue(field, value);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate FHR table
    function generateFHRTable() {
      const table = document.getElementById('fhrTable');
      const fields = ["Baseline_FHR", "FHR_deceleration"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      babyBaselineTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        babyBaselineTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue(field, value);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Baby table
    function generateBabyTable() {
      const table = document.getElementById('babyTable');
      const fields = ["Amniotic_fluid", "Fetal_position", "Caput", "Moulding"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      babyOtherTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        babyOtherTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue(field, value);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Woman table
    function generateWomanTable() {
      const table = document.getElementById('womanTable');
      const fields = ["Pulse", "Systolic_BP", "Diastolic_BP", "Temperature_C", "Urine"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      womanTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        womanTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue(field, value);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Contractions table
    function generateContractionsTable() {
      const table = document.getElementById('contractionsTable');
      const fields = ["Contractions_per_10_min", "Duration_of_contractions"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      contractionsTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        contractionsTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue(field, value);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Cervix Plot table
    function generateCervixPlotTable() {
      const table = document.getElementById('cervixPlotTable');
      const cervixValues = ["10", "9", "8", "7", "6", "5"];
      const timeThresholds = ["", "≥ 2h", "≥ 2.5h", "≥ 3h", "≥ 5h", "≥ 6h"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Cervix [Plot X]</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      cervixPlotTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      cervixValues.forEach((cervixValue, index) => {
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${cervixValue}</td>`;
        const thresholdValue = timeThresholds[index];
        const highlightedThreshold = thresholdValue ? `<span class="alert-value">${thresholdValue}</span>` : '';
        tableHTML += `<td class="alert-column">${highlightedThreshold}</td>`;
        
        cervixPlotTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `Cervix_Plot_${cervixValue}_${timeKey}`;
          const dataValue = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue('Cervix Plot', dataValue);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${dataValue}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Descent Plot table
    function generateDescentPlotTable() {
      const table = document.getElementById('descentPlotTable');
      const descentValues = ["5", "4", "3", "2", "1", "0"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Descent [Plot O]</th>';
      
      descentPlotTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      descentValues.forEach(descentValue => {
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${descentValue}</td>`;
        
        descentPlotTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `Descent_Plot_${descentValue}_${timeKey}`;
          const dataValue = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue('Descent Plot', dataValue);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${dataValue}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Medication table
    function generateMedicationTable() {
      const table = document.getElementById('medicationTable');
      const fields = ["Oxytocin", "Medicine", "IV_Fluids"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      
      supportiveCareTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${field.replace(/_/g, ' ')}</td>`;
        
        supportiveCareTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `Medication_${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue(field, value);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Decision Making table
    function generateDecisionMakingTable() {
      const table = document.getElementById('decisionMakingTable');
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      
      supportiveCareTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      // Assessment fields
      const assessmentFields = ["Womans_condition", "Babys_condition", "Labour_progress", "Other_concerns"];
      assessmentFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ').replace('s condition', "'s condition");
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">Assessment: ${displayName}</td>`;
        
        supportiveCareTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `ASSESSMENT_${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue(field, value);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      // Plan field
      tableHTML += '<tr>';
      tableHTML += '<td class="field-column">Plan</td>';
      
      supportiveCareTimeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `PLAN_${timeKey}`;
        const value = summaryData[key] || '';
        const isSecondStage = isSecondStageTime(time);
        const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
        
        // Check if this value should be highlighted as an alert
        const shouldHighlight = checkAlertValue('Plan', value);
        const alertClass = shouldHighlight ? ' alert-value' : '';
        
        tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
      });
      
      tableHTML += '</tr>';
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Initials table
    function generateInitialsTable() {
      const table = document.getElementById('initialsTable');
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      
      supportiveCareTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      tableHTML += '<tr>';
      tableHTML += '<td class="field-column">Initials</td>';
      
      supportiveCareTimeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `INITIALS_${timeKey}`;
        const value = summaryData[key] || '';
        const isSecondStage = isSecondStageTime(time);
        const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
        
        // Check if this value should be highlighted as an alert
        const shouldHighlight = checkAlertValue('Initials', value);
        const alertClass = shouldHighlight ? ' alert-value' : '';
        
        tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
      });
      
      tableHTML += '</tr>';
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    

    
    // Helper functions
    function getAlertValue(field) {
      const alertValues = {
        "Companion": "N",
        "Pain Relief": "N",
        "Oral fluids": "N",
        "Mobility": "SP",
        "Baseline FHR": "<110, ≥160",
        "FHR deceleration": "L",
        "Amniotic fluid": "M+++, B",
        "Fetal position": "P, T",
        "Caput": "+++",
        "Moulding": "+++",
        "Pulse": "<60, ≥120",
        "Systolic BP": "<80, ≥140",
        "Diastolic BP": "≥90",
        "Temperature C": "<35.0, ≥37.5",
        "Urine": "P++, A++",
        "Contractions per 10 min": "≤2, >5",
        "Duration of contractions": "<20, >60"
      };
      
      const value = alertValues[field] || '';
      // Wrap alert values in span with alert-value class for highlighting
      return value ? `<span class="alert-value">${value}</span>` : '';
    }
    
    // Action functions
    function printSummary() {
      window.print();
    }
    
    function exportToExcel() {
      try {
        // Create a new workbook
        const wb = XLSX.utils.book_new();
        
        // Create the main summary sheet
        const summaryData = generateExcelData();
        const ws = XLSX.utils.aoa_to_sheet(summaryData);
        
        // Set column widths
        ws['!cols'] = [
          { width: 20 }, // Field column
          { width: 12 }, // Alert column
          ...Array(supportiveCareTimeCols.length).fill({ width: 12 }) // Time columns
        ];
        
        // Add the worksheet to the workbook
        XLSX.utils.book_append_sheet(wb, ws, "WHO LCG Summary");
        
        // Generate filename
        const patientName = patientData.name || 'Patient';
        const timestamp = new Date().toISOString().split('T')[0];
        const filename = `WHO_LCG_${patientName}_${timestamp}.xlsx`;
        
        // Save the file
        XLSX.writeFile(wb, filename);
        
      } catch (error) {
        console.error('Error exporting to Excel:', error);
        alert('Error exporting to Excel: ' + error.message);
      }
    }
    
    function generateExcelData() {
      const data = [];
      
      // Header row
      const headerRow = ['Field', 'Alert'];
      supportiveCareTimeCols.forEach(time => {
        headerRow.push(time);
      });
      data.push(headerRow);
      
      // Patient Information
      data.push(['', '']); // Empty row
      data.push(['PATIENT INFORMATION', '']);
      data.push(['Patient Name', '', patientData.name || '']);
      data.push(['Age', '', patientData.age || '']);
      data.push(['Parity', '', patientData.parity || '']);
      data.push(['Labour Onset', '', patientData.labour_onset || '']);
      data.push(['Active Labour Start', '', patientData.active_labour || '']);
      data.push(['Membranes Ruptured', '', patientData.ruptured_membrane || '']);
      data.push(['Risk Factors', '', patientData.risk_factors || '']);
      data.push(['Second Stage Start', '', secondStageData.secondStageStartTime || '']);
      
      // Supportive Care section
      data.push(['', '']); // Empty row
      data.push(['SUPPORTIVE CARE', '']);
      const supportiveFields = ["Companion", "Pain_Relief", "Oral_fluids", "Mobility"];
      supportiveFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        supportiveCareTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // FHR section
      data.push(['', '']); // Empty row
      data.push(['FHR', '']);
      const fhrFields = ["Baseline_FHR", "FHR_deceleration"];
      fhrFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        babyBaselineTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Baby section
      data.push(['', '']); // Empty row
      data.push(['BABY', '']);
      const babyFields = ["Amniotic_fluid", "Fetal_position", "Caput", "Moulding"];
      babyFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        supportiveCareTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Woman section
      data.push(['', '']); // Empty row
      data.push(['WOMAN', '']);
      const womanFields = ["Pulse", "Systolic_BP", "Diastolic_BP", "Temperature_C", "Urine"];
      womanFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        supportiveCareTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Contractions section
      data.push(['', '']); // Empty row
      data.push(['CONTRACTIONS', '']);
      const contractionsFields = ["Contractions_per_10_min", "Duration_of_contractions"];
      contractionsFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        babyBaselineTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Medication section
      data.push(['', '']); // Empty row
      data.push(['MEDICATION', '']);
      
      // Oxytocin with details
      const oxytocinRow = ['Oxytocin', ''];
      supportiveCareTimeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const oxytocinKey = `Medication_Oxytocin_${timeKey}`;
        const oxytocinValue = summaryData[oxytocinKey] || '';
        
        if (oxytocinValue === 'Y') {
          const uLKey = `Medication_Oxytocin_${timeKey}_UL`;
          const dropsKey = `Medication_Oxytocin_${timeKey}_drops`;
          const uLValue = summaryData[uLKey] || '';
          const dropsValue = summaryData[dropsKey] || '';
          
          if (uLValue && dropsValue) {
            oxytocinRow.push(`${uLValue} U/L, ${dropsValue} drops/min`);
          } else if (uLValue) {
            oxytocinRow.push(`${uLValue} U/L`);
          } else if (dropsValue) {
            oxytocinRow.push(`${dropsValue} drops/min`);
          } else {
            oxytocinRow.push('Y');
          }
        } else {
          oxytocinRow.push(oxytocinValue);
        }
      });
      data.push(oxytocinRow);
      
      // Medicine with details
      const medicineRow = ['Medicine', ''];
      supportiveCareTimeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const medicineKey = `Medication_Medicine_${timeKey}`;
        const medicineValue = summaryData[medicineKey] || '';
        
        if (medicineValue === 'Y') {
          const textKey = `Medication_Medicine_${timeKey}_text`;
          const textValue = summaryData[textKey] || '';
          
          if (textValue) {
            medicineRow.push(textValue);
          } else {
            medicineRow.push('Y');
          }
        } else {
          medicineRow.push(medicineValue);
        }
      });
      data.push(medicineRow);
      
      // IV Fluids
      const ivFluidsRow = ['IV Fluids', ''];
      supportiveCareTimeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `Medication_IV_Fluids_${timeKey}`;
        ivFluidsRow.push(summaryData[key] || '');
      });
      data.push(ivFluidsRow);
      
      // Shared Decision-Making section
      data.push(['', '']); // Empty row
      data.push(['SHARED DECISION-MAKING', '']);
      const assessmentFields = ["Womans_condition", "Babys_condition", "Labour_progress", "Other_concerns"];
      assessmentFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ').replace('s condition', "'s condition");
        const row = [`Assessment: ${displayName}`, ''];
        supportiveCareTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `ASSESSMENT_${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Plan row
      const planRow = ['Plan', ''];
      supportiveCareTimeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `PLAN_${timeKey}`;
        planRow.push(summaryData[key] || '');
      });
      data.push(planRow);
      
      // Initials section
      data.push(['', '']); // Empty row
      data.push(['INITIALS', '']);
      const initialsRow = ['Initials', ''];
      supportiveCareTimeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `INITIALS_${timeKey}`;
        initialsRow.push(summaryData[key] || '');
      });
      data.push(initialsRow);
      
      return data;
    }
    
    function shareSummary() {
      const currentUrl = window.location.href;
      navigator.clipboard.writeText(currentUrl).then(() => {
        alert('Summary link copied to clipboard! Share this link with other clinicians for review.');
      }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = currentUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        textArea.remove();
        alert('Summary link copied to clipboard! Share this link with other clinicians for review.');
      });
    }
  </script>
</body>
</html>
