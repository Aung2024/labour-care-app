<!DOCTYPE html>
<html lang="en">
<head>
  <title>WHO Labour Care Guide - Summary View</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    /* A4 Print Styles */
    @page {
      size: A4 portrait;
      margin: 1cm;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      line-height: 1.4;
      color: #333;
      background: white;
    }
    
    .summary-container {
      max-width: 21cm;
      margin: 0 auto;
      padding: 1cm;
      background: white;
    }
    
    /* Header */
    .summary-header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #2c3e50;
      padding-bottom: 15px;
    }
    
    .summary-title {
      font-size: 18px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 5px;
    }
    
    .summary-subtitle {
      font-size: 12px;
      color: #6c757d;
    }
    
    /* Patient Information */
    .patient-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-bottom: 20px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 10px;
    }
    
    .patient-info-item {
      display: flex;
      flex-direction: column;
    }
    
    .patient-info-label {
      font-weight: 600;
      color: #495057;
      text-transform: uppercase;
      font-size: 8px;
      margin-bottom: 2px;
    }
    
    .patient-info-value {
      font-size: 10px;
      color: #212529;
      font-weight: 500;
    }
    
    /* Section Headers */
    .section-header {
      background: #2c3e50;
      color: white;
      padding: 6px 10px;
      margin: 15px 0 8px 0;
      border-radius: 3px;
      font-weight: 600;
      font-size: 11px;
    }
    
    .section-header i {
      margin-right: 5px;
    }
    
    /* Tables */
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      font-size: 8px;
    }
    
    .summary-table th,
    .summary-table td {
      border: 1px solid #dee2e6;
      padding: 3px 2px;
      text-align: center;
      vertical-align: middle;
    }
    
    .summary-table th {
      background: #e9ecef;
      font-weight: 600;
      color: #495057;
      font-size: 7px;
    }
    
    .summary-table .field-column {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
      text-align: left;
      width: 60px;
      font-size: 7px;
    }
    
    .summary-table .alert-column {
      background: #fff3cd;
      font-weight: 600;
      color: #856404;
      font-size: 6px;
      width: 25px;
    }
    
    .summary-table .time-column {
      background: #dbeafe;
      color: #1e40af;
      font-weight: 600;
      font-size: 7px;
      width: 25px;
    }
    
    .summary-table .time-column.second-stage {
      background: #dcfce7 !important;
      color: #166534 !important;
    }
    
    .summary-table .data-cell {
      background: white;
      font-size: 7px;
      width: 25px;
    }
    
    .summary-table .data-cell.second-stage {
      background: #dcfce7 !important;
      color: #166534 !important;
    }
    
    /* Action Buttons */
    .action-buttons {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .action-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      font-size: 11px;
    }
    
    .btn-print {
      background: #28a745;
      color: white;
    }
    
    .btn-export {
      background: #17a2b8;
      color: white;
    }
    
    .btn-share {
      background: #6f42c1;
      color: white;
    }
    
    .btn-back {
      background: #6c757d;
      color: white;
    }
    
    /* Print Styles */
    @media print {
      .action-buttons {
        display: none;
      }
      
      .summary-container {
        padding: 0;
        margin: 0;
        max-width: none;
      }
      
      .summary-table {
        page-break-inside: avoid;
        margin-bottom: 8px;
        font-size: 7px;
      }
      
      .section-header {
        page-break-after: avoid;
        margin: 8px 0 4px 0;
        padding: 4px 6px;
        font-size: 10px;
      }
      
      .patient-info {
        margin-bottom: 12px;
        padding: 6px;
      }
      
      .summary-header {
        margin-bottom: 12px;
        padding-bottom: 8px;
      }
      
      .summary-title {
        font-size: 16px;
        margin-bottom: 3px;
      }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .summary-container {
        padding: 10px;
      }
      
      .action-buttons {
        bottom: 10px;
        right: 10px;
      }
      
      .action-btn {
        padding: 6px 10px;
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Action Buttons -->
  <div class="action-buttons">
    <button class="action-btn btn-print" onclick="printSummary()">
      <i class="fas fa-print"></i>
      Print PDF
    </button>
    <button class="action-btn btn-export" onclick="exportToExcel()">
      <i class="fas fa-file-excel"></i>
      Export Excel
    </button>
    <button class="action-btn btn-share" onclick="shareSummary()">
      <i class="fas fa-share-alt"></i>
      Share Link
    </button>
    <button class="action-btn btn-back" onclick="window.history.back()">
      <i class="fas fa-arrow-left"></i>
      Back
    </button>
  </div>

  <div class="summary-container">
    <!-- Header -->
    <div class="summary-header">
      <div class="summary-title">
        <i class="fas fa-clipboard-list"></i>
        WHO Labour Care Guide - Summary Form
      </div>
      <div class="summary-subtitle">
        Clinical Summary for Labour Monitoring and Decision Making
      </div>
    </div>

    <!-- Patient Information -->
    <div class="patient-info">
      <div class="patient-info-item">
        <div class="patient-info-label">Patient Name</div>
        <div class="patient-info-value" id="patientName">Loading...</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Age</div>
        <div class="patient-info-value" id="patientAge">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Parity</div>
        <div class="patient-info-value" id="patientParity">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Labour Onset</div>
        <div class="patient-info-value" id="labourOnset">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Active Labour Start</div>
        <div class="patient-info-value" id="activeLabourStart">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Membranes Ruptured</div>
        <div class="patient-info-value" id="membranesRuptured">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Risk Factors</div>
        <div class="patient-info-value" id="riskFactors">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Second Stage Start</div>
        <div class="patient-info-value" id="secondStageStart">-</div>
      </div>
    </div>

    <!-- Supportive Care Section -->
    <div class="section-header">
      <i class="fas fa-hands-helping"></i>
      Supportive Care
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="supportiveCareTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- FHR Section -->
    <div class="section-header">
      <i class="fas fa-heartbeat"></i>
      FHR
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="fhrTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Baby Section -->
    <div class="section-header">
      <i class="fas fa-baby"></i>
      Baby
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="babyTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Woman Section -->
    <div class="section-header">
      <i class="fas fa-female"></i>
      Woman
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="womanTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Contractions Section -->
    <div class="section-header">
      <i class="fas fa-utensils"></i>
      Contractions
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="contractionsTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Cervix Plot Section -->
    <div class="section-header">
      <i class="fas fa-chart-area"></i>
      Cervix [Plot X]
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="cervixPlotTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Descent Plot Section -->
    <div class="section-header">
      <i class="fas fa-chart-line"></i>
      Descent [Plot O]
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="descentPlotTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Medication Section -->
    <div class="section-header">
      <i class="fas fa-pills"></i>
      Medication
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="medicationTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Shared Decision-Making Section -->
    <div class="section-header">
      <i class="fas fa-comments"></i>
      Shared Decision-Making
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="decisionMakingTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Initials Section -->
    <div class="section-header">
      <i class="fas fa-signature"></i>
      Initials
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="initialsTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Clinical Recommendations -->
    <div class="section-header">
      <i class="fas fa-stethoscope"></i>
      Clinical Recommendations
    </div>
    <div id="recommendations" class="p-2 bg-light rounded" style="font-size: 9px;">
      <!-- Recommendations will be populated here -->
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  
  <script>
    // Global variables
    let patientData = {};
    let summaryData = {};
    let timeColumns = {};
    let secondStageData = {};
    
    // Get patient ID from URL parameters
    function getPatientIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('patient');
    }
    
    const patientId = getPatientIdFromUrl();
    
    // Load data when page loads
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "login.html";
      } else {
        loadSummaryData();
      }
    });
    
    // Load all summary data
    async function loadSummaryData() {
      try {
        console.log('Loading summary data for patient:', patientId);
        const base = firebase.firestore().collection("patients").doc(patientId);
        
        // Load patient basic info
        const patientDoc = await base.get();
        if (patientDoc.exists) {
          patientData = patientDoc.data();
          console.log('Patient data loaded:', patientData);
          populatePatientInfo();
        } else {
          console.log('No patient document found');
        }
        
        // Load summary records
        const summaryDoc = await base.collection("records").doc("summary").get();
        if (summaryDoc.exists) {
          summaryData = summaryDoc.data();
          console.log('Summary data loaded:', summaryData);
        } else {
          console.log('No summary document found');
        }
        
        // Load starting time and generate time columns
        const startingTimeDoc = await base.collection("records").doc("startingTime").get();
        if (startingTimeDoc.exists) {
          const startingData = startingTimeDoc.data();
          console.log('Starting time data:', startingData);
          if (startingData.startingTime) {
            generateTimeColumns(startingData.startingTime);
            console.log('Time columns generated from starting time:', timeColumns);
          } else {
            generateDefaultTimeColumns();
            console.log('Default time columns generated:', timeColumns);
          }
        } else {
          console.log('No starting time document found, using defaults');
          generateDefaultTimeColumns();
          console.log('Default time columns generated:', timeColumns);
        }
        
        // Load second stage data
        const secondStageDoc = await base.collection("records").doc("secondStage").get();
        if (secondStageDoc.exists) {
          secondStageData = secondStageDoc.data();
          console.log('Second stage data:', secondStageData);
          if (secondStageData.isSecondStageActive) {
            document.getElementById('secondStageStart').textContent = secondStageData.secondStageStartTime || '-';
          }
        } else {
          console.log('No second stage document found');
        }
        
        // Generate all tables
        console.log('Generating tables with timeColumns:', timeColumns);
        generateAllTables();
        
        // Load recommendations
        loadRecommendations();
        
      } catch (error) {
        console.error("Error loading summary data:", error);
        document.body.innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
      }
    }
    
    // Populate patient information
    function populatePatientInfo() {
      document.getElementById('patientName').textContent = patientData.name || 'Not specified';
      document.getElementById('patientAge').textContent = patientData.age || '-';
      document.getElementById('patientParity').textContent = patientData.parity || '-';
      document.getElementById('labourOnset').textContent = patientData.labour_onset || '-';
      document.getElementById('activeLabourStart').textContent = patientData.active_labour || '-';
      document.getElementById('membranesRuptured').textContent = patientData.ruptured_membrane || '-';
      document.getElementById('riskFactors').textContent = patientData.risk_factors || 'None identified';
    }
    
    // Generate time columns based on starting time
    function generateTimeColumns(startingTime) {
      const startHour = parseInt(startingTime.split(':')[0]);
      const startMinute = parseInt(startingTime.split(':')[1]);
      
      // Supportive Care, Baby Other, Woman, Medication, Assessment, Initials: +1 hour intervals
      timeColumns.hourly = [];
      for (let i = 0; i <= 12; i++) {
        const hour = (startHour + i) % 24;
        timeColumns.hourly.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
      }
      
      // Baby Baseline & FHR, Contractions: +30 minute intervals
      timeColumns.thirtyMin = [];
      for (let i = 0; i <= 24; i++) {
        const totalMinutes = startHour * 60 + startMinute + (i * 30);
        const hour = Math.floor(totalMinutes / 60) % 24;
        const minute = totalMinutes % 60;
        timeColumns.thirtyMin.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
      }
      
      // Plan: +2 hour intervals
      timeColumns.twoHour = [];
      for (let i = 0; i <= 6; i++) {
        const hour = (startHour + (i * 2)) % 24;
        timeColumns.twoHour.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
      }
      
      // Cervix and Descent Plot: +1 hour intervals
      timeColumns.plot = [...timeColumns.hourly];
    }
    
    // Generate default time columns if no starting time is available
    function generateDefaultTimeColumns() {
      const now = new Date();
      const startHour = now.getHours();
      const startMinute = now.getMinutes();
      
      // Supportive Care, Baby Other, Woman, Medication, Assessment, Initials: +1 hour intervals
      timeColumns.hourly = [];
      for (let i = 0; i <= 12; i++) {
        const hour = (startHour + i) % 24;
        timeColumns.hourly.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
      }
      
      // Baby Baseline & FHR, Contractions: +30 minute intervals
      timeColumns.thirtyMin = [];
      for (let i = 0; i <= 24; i++) {
        const totalMinutes = startHour * 60 + startMinute + (i * 30);
        const hour = Math.floor(totalMinutes / 60) % 24;
        const minute = totalMinutes % 60;
        timeColumns.thirtyMin.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
      }
      
      // Plan: +2 hour intervals
      timeColumns.twoHour = [];
      for (let i = 0; i <= 6; i++) {
        const hour = (startHour + (i * 2)) % 24;
        timeColumns.twoHour.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
      }
      
      // Cervix and Descent Plot: +1 hour intervals
      timeColumns.plot = [...timeColumns.hourly];
    }
    
    // Generate all tables
    function generateAllTables() {
      generateSupportiveCareTable();
      generateFHRTable();
      generateBabyTable();
      generateWomanTable();
      generateContractionsTable();
      generateCervixPlotTable();
      generateDescentPlotTable();
      generateMedicationTable();
      generateDecisionMakingTable();
      generateInitialsTable();
    }
    
    // Check if a time is in second stage
    function isSecondStageTime(time) {
      if (!secondStageData.isSecondStageActive || !secondStageData.secondStageStartTime) {
        return false;
      }
      
      const timeHour = parseInt(time.split(':')[0]);
      const timeMinute = parseInt(time.split(':')[1]);
      const secondHour = parseInt(secondStageData.secondStageStartTime.split(':')[0]);
      const secondMinute = parseInt(secondStageData.secondStageStartTime.split(':')[1]);
      
      const timeMinutes = timeHour * 60 + timeMinute;
      const secondMinutes = secondHour * 60 + secondMinute;
      
      return timeMinutes >= secondMinutes;
    }
    
    // Generate Supportive Care table
    function generateSupportiveCareTable() {
      const table = document.getElementById('supportiveCareTable');
      const fields = ["Companion", "Pain_Relief", "Oral_fluids", "Mobility"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      timeColumns.hourly.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        timeColumns.hourly.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          tableHTML += `<td class="${cellClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate FHR table
    function generateFHRTable() {
      const table = document.getElementById('fhrTable');
      const fields = ["Baseline_FHR", "FHR_deceleration"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      timeColumns.thirtyMin.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        timeColumns.thirtyMin.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          tableHTML += `<td class="${cellClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Baby table
    function generateBabyTable() {
      const table = document.getElementById('babyTable');
      const fields = ["Amniotic_fluid", "Fetal_position", "Caput", "Moulding"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      timeColumns.hourly.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        timeColumns.hourly.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          tableHTML += `<td class="${cellClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Woman table
    function generateWomanTable() {
      const table = document.getElementById('womanTable');
      const fields = ["Pulse", "Systolic_BP", "Diastolic_BP", "Temperature_C", "Urine"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      timeColumns.hourly.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        timeColumns.hourly.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          tableHTML += `<td class="${cellClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Contractions table
    function generateContractionsTable() {
      const table = document.getElementById('contractionsTable');
      const fields = ["Contractions_per_10_min", "Duration_of_contractions"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      timeColumns.thirtyMin.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        timeColumns.thirtyMin.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          tableHTML += `<td class="${cellClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Cervix Plot table
    function generateCervixPlotTable() {
      const table = document.getElementById('cervixPlotTable');
      const cervixValues = ["10", "9", "8", "7", "6", "5"];
      const timeThresholds = ["", "≥ 2h", "≥ 2.5h", "≥ 3h", "≥ 5h", "≥ 6h"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Cervix [Plot X]</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      timeColumns.plot.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      cervixValues.forEach((cervixValue, index) => {
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${cervixValue}</td>`;
        tableHTML += `<td class="alert-column">${timeThresholds[index]}</td>`;
        
        timeColumns.plot.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `Cervix_Plot_${cervixValue}_${timeKey}`;
          const dataValue = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          tableHTML += `<td class="${cellClass}">${dataValue}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Descent Plot table
    function generateDescentPlotTable() {
      const table = document.getElementById('descentPlotTable');
      const descentValues = ["5", "4", "3", "2", "1", "0"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Descent [Plot O]</th>';
      
      timeColumns.plot.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      descentValues.forEach(descentValue => {
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${descentValue}</td>`;
        
        timeColumns.plot.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `Descent_Plot_${descentValue}_${timeKey}`;
          const dataValue = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          tableHTML += `<td class="${cellClass}">${dataValue}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Medication table
    function generateMedicationTable() {
      const table = document.getElementById('medicationTable');
      const fields = ["Oxytocin", "Medicine", "IV_Fluids"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      
      timeColumns.hourly.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${field.replace(/_/g, ' ')}</td>`;
        
        timeColumns.hourly.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `Medication_${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          tableHTML += `<td class="${cellClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Decision Making table
    function generateDecisionMakingTable() {
      const table = document.getElementById('decisionMakingTable');
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      
      timeColumns.hourly.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      // Assessment fields
      const assessmentFields = ["Womans_condition", "Babys_condition", "Labour_progress", "Other_concerns"];
      assessmentFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ').replace('s condition', "'s condition");
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">Assessment: ${displayName}</td>`;
        
        timeColumns.hourly.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `ASSESSMENT_${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          tableHTML += `<td class="${cellClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      // Plan field
      tableHTML += '<tr>';
      tableHTML += '<td class="field-column">Plan</td>';
      
      timeColumns.hourly.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `PLAN_${timeKey}`;
        const value = summaryData[key] || '';
        const isSecondStage = isSecondStageTime(time);
        const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
        
        tableHTML += `<td class="${cellClass}">${value}</td>`;
      });
      
      tableHTML += '</tr>';
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Initials table
    function generateInitialsTable() {
      const table = document.getElementById('initialsTable');
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      
      timeColumns.hourly.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      tableHTML += '<tr>';
      tableHTML += '<td class="field-column">Initials</td>';
      
      timeColumns.hourly.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `INITIALS_${timeKey}`;
        const value = summaryData[key] || '';
        const isSecondStage = isSecondStageTime(time);
        const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
        
        tableHTML += `<td class="${cellClass}">${value}</td>`;
      });
      
      tableHTML += '</tr>';
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Load clinical recommendations
    function loadRecommendations() {
      const recommendationsDiv = document.getElementById('recommendations');
      recommendationsDiv.innerHTML = '<p class="text-muted" style="font-size: 9px; margin: 0;">Clinical recommendations will be displayed here based on the data entered.</p>';
    }
    
    // Helper functions
    function getAlertValue(field) {
      const alertValues = {
        "Companion": "N",
        "Pain Relief": "N",
        "Oral fluids": "N",
        "Mobility": "SP",
        "Baseline FHR": "110-160",
        "FHR deceleration": "L",
        "Amniotic fluid": "M+++, B",
        "Fetal position": "P, T",
        "Caput": "+++",
        "Moulding": "+++",
        "Pulse": "<60, >120",
        "Systolic BP": "<90, >140",
        "Diastolic BP": ">90",
        "Temperature C": "<36, >37.5",
        "Urine": "P++, A++",
        "Contractions per 10 min": ">5",
        "Duration of contractions": ">50s"
      };
      
      return alertValues[field] || '';
    }
    
    // Action functions
    function printSummary() {
      window.print();
    }
    
    function exportToExcel() {
      try {
        // Create a new workbook
        const wb = XLSX.utils.book_new();
        
        // Create the main summary sheet
        const summaryData = generateExcelData();
        const ws = XLSX.utils.aoa_to_sheet(summaryData);
        
        // Set column widths
        ws['!cols'] = [
          { width: 20 }, // Field column
          { width: 12 }, // Alert column
          ...Array(timeColumns.hourly.length).fill({ width: 12 }) // Time columns
        ];
        
        // Add the worksheet to the workbook
        XLSX.utils.book_append_sheet(wb, ws, "WHO LCG Summary");
        
        // Generate filename
        const patientName = patientData.name || 'Patient';
        const timestamp = new Date().toISOString().split('T')[0];
        const filename = `WHO_LCG_${patientName}_${timestamp}.xlsx`;
        
        // Save the file
        XLSX.writeFile(wb, filename);
        
      } catch (error) {
        console.error('Error exporting to Excel:', error);
        alert('Error exporting to Excel: ' + error.message);
      }
    }
    
    function generateExcelData() {
      const data = [];
      
      // Header row
      const headerRow = ['Field', 'Alert'];
      timeColumns.hourly.forEach(time => {
        headerRow.push(time);
      });
      data.push(headerRow);
      
      // Patient Information
      data.push(['', '']); // Empty row
      data.push(['PATIENT INFORMATION', '']);
      data.push(['Patient Name', '', patientData.name || '']);
      data.push(['Age', '', patientData.age || '']);
      data.push(['Parity', '', patientData.parity || '']);
      data.push(['Labour Onset', '', patientData.labour_onset || '']);
      data.push(['Active Labour Start', '', patientData.active_labour || '']);
      data.push(['Membranes Ruptured', '', patientData.ruptured_membrane || '']);
      data.push(['Risk Factors', '', patientData.risk_factors || '']);
      data.push(['Second Stage Start', '', secondStageData.secondStageStartTime || '']);
      
      // Supportive Care section
      data.push(['', '']); // Empty row
      data.push(['SUPPORTIVE CARE', '']);
      const supportiveFields = ["Companion", "Pain_Relief", "Oral_fluids", "Mobility"];
      supportiveFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        timeColumns.hourly.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // FHR section
      data.push(['', '']); // Empty row
      data.push(['FHR', '']);
      const fhrFields = ["Baseline_FHR", "FHR_deceleration"];
      fhrFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        timeColumns.thirtyMin.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Baby section
      data.push(['', '']); // Empty row
      data.push(['BABY', '']);
      const babyFields = ["Amniotic_fluid", "Fetal_position", "Caput", "Moulding"];
      babyFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        timeColumns.hourly.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Woman section
      data.push(['', '']); // Empty row
      data.push(['WOMAN', '']);
      const womanFields = ["Pulse", "Systolic_BP", "Diastolic_BP", "Temperature_C", "Urine"];
      womanFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        timeColumns.hourly.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Contractions section
      data.push(['', '']); // Empty row
      data.push(['CONTRACTIONS', '']);
      const contractionsFields = ["Contractions_per_10_min", "Duration_of_contractions"];
      contractionsFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        timeColumns.thirtyMin.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Medication section
      data.push(['', '']); // Empty row
      data.push(['MEDICATION', '']);
      const medicationFields = ["Oxytocin", "Medicine", "IV_Fluids"];
      medicationFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, ''];
        timeColumns.hourly.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `Medication_${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Shared Decision-Making section
      data.push(['', '']); // Empty row
      data.push(['SHARED DECISION-MAKING', '']);
      const assessmentFields = ["Womans_condition", "Babys_condition", "Labour_progress", "Other_concerns"];
      assessmentFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ').replace('s condition', "'s condition");
        const row = [`Assessment: ${displayName}`, ''];
        timeColumns.hourly.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `ASSESSMENT_${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Plan row
      const planRow = ['Plan', ''];
      timeColumns.hourly.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `PLAN_${timeKey}`;
        planRow.push(summaryData[key] || '');
      });
      data.push(planRow);
      
      // Initials section
      data.push(['', '']); // Empty row
      data.push(['INITIALS', '']);
      const initialsRow = ['Initials', ''];
      timeColumns.hourly.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `INITIALS_${timeKey}`;
        initialsRow.push(summaryData[key] || '');
      });
      data.push(initialsRow);
      
      return data;
    }
    
    function shareSummary() {
      const currentUrl = window.location.href;
      navigator.clipboard.writeText(currentUrl).then(() => {
        alert('Summary link copied to clipboard! Share this link with other clinicians for review.');
      }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = currentUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        textArea.remove();
        alert('Summary link copied to clipboard! Share this link with other clinicians for review.');
      });
    }
  </script>
</body>
</html>
