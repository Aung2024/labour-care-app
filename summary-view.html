<!DOCTYPE html>
<html lang="en">
<head>
  <title>Labour Care Guide</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    /* A4 Print Styles */
    @page {
      size: A4 portrait;
      margin: 1cm;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      line-height: 1.4;
      color: #333;
      background: white;
    }
    
    .summary-container {
      max-width: 21cm;
      margin: 0 auto;
      padding: 1cm;
      background: white;
    }
    
    /* Header */
    .summary-header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #2c3e50;
      padding-bottom: 15px;
    }
    
    .summary-title {
      font-size: 18px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 5px;
    }
    
    .summary-subtitle {
      font-size: 12px;
      color: #6c757d;
    }
    
    /* Patient Information */
    .patient-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-bottom: 20px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 10px;
    }
    
    .patient-info-item {
      display: flex;
      flex-direction: column;
    }
    
    .patient-info-label {
      font-weight: 600;
      color: #495057;
      text-transform: uppercase;
      font-size: 8px;
      margin-bottom: 2px;
    }
    
    .patient-info-value {
      font-size: 10px;
      color: #212529;
      font-weight: 500;
    }
    
    /* Section Headers */
    .section-header {
      background: #2c3e50;
      color: white;
      padding: 6px 10px;
      margin: 15px 0 8px 0;
      border-radius: 3px;
      font-weight: 600;
      font-size: 11px;
    }
    
    .section-header i {
      margin-right: 5px;
    }
    
    /* Tables */
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      font-size: 8px;
    }
    
    .summary-table th,
    .summary-table td {
      border: 1px solid #dee2e6;
      padding: 3px 2px;
      text-align: center;
      vertical-align: middle;
    }
    
    .summary-table th {
      background: #e9ecef;
      font-weight: 600;
      color: #495057;
      font-size: 7px;
    }
    
    .summary-table .field-column {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
      text-align: left;
      width: 60px;
      font-size: 7px;
    }
    
    .summary-table .alert-column {
      background: #fff3cd;
      font-weight: 600;
      color: #856404;
      font-size: 6px;
      width: 30px;
      min-width: 30px;
      max-width: 30px;
      text-align: center;
      padding: 1px 2px;
    }
    
    /* Alert Value Highlighting - Simple Red Text */
    .alert-value,
    .alert-column .alert-value,
    td.alert-value,
    .alert-value * {
      color: #dc2626 !important;
      font-weight: 700 !important;
      font-size: 7px !important;
    }
    
    /* Alert column thresholds - simple red text */
    .alert-column .alert-value {
      color: #dc2626 !important;
      font-weight: 700 !important;
      font-size: 6px !important;
    }
    
    /* Data cell alert values - simple red text */
    .data-cell.alert-value {
      color: #dc2626 !important;
      font-weight: 700 !important;
      font-size: 7px !important;
    }
    
    /* Ensure alert highlighting works for all alert values */
    .alert-column {
      position: relative !important;
      z-index: 1 !important;
    }
    
    .summary-table .time-column {
      background: #dbeafe;
      color: #1e40af;
      font-weight: 600;
      font-size: 7px;
      width: 25px;
      min-width: 25px;
      padding: 2px 1px;
      text-align: center;
    }
    
    .summary-table .data-cell {
      padding: 2px 1px !important;
      text-align: center !important;
      vertical-align: middle !important;
      font-size: 7px !important;
      line-height: 1.0 !important;
      min-height: 12px !important;
    }
    
    .summary-table .time-column.second-stage {
      background: #dcfce7 !important;
      color: #166534 !important;
    }
    
    .summary-table .data-cell {
      background: white;
      font-size: 7px;
      width: 25px;
    }
    
    .summary-table .data-cell.second-stage {
      background: #dcfce7 !important;
      color: #166534 !important;
    }
    
    /* Override second stage color for alert values - higher specificity */
    .summary-table .data-cell.second-stage.alert-value {
      color: #dc2626 !important;
      font-weight: 700 !important;
    }
    
    /* Ensure alert values in second stage are always red */
    .summary-table .data-cell.second-stage.alert-value,
    .summary-table .data-cell.second-stage .alert-value {
      color: #dc2626 !important;
      font-weight: 700 !important;
    }
    
    /* Action Buttons */
    .action-buttons {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .action-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      font-size: 11px;
    }
    
    .btn-print {
      background: #28a745;
      color: white;
    }
    
    .btn-export {
      background: #17a2b8;
      color: white;
    }
    
    .btn-share {
      background: #6f42c1;
      color: white;
    }
    
    .btn-back {
      background: #6c757d;
      color: white;
    }
    
    /* Print Styles */
    @media print {
      .action-buttons {
        display: none;
      }
      
      .summary-container {
        padding: 0;
        margin: 0;
        max-width: none;
      }
      
      .summary-table {
        page-break-inside: avoid;
        margin-bottom: 8px;
        font-size: 7px;
      }
      
      .section-header {
        page-break-after: avoid;
        margin: 8px 0 4px 0;
        padding: 4px 6px;
        font-size: 10px;
      }
      
      .patient-info {
        margin-bottom: 12px;
        padding: 6px;
      }
      
      .summary-header {
        margin-bottom: 12px;
        padding-bottom: 8px;
      }
      
      .summary-title {
        font-size: 16px;
        margin-bottom: 3px;
      }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .summary-container {
        padding: 10px;
      }
      
      .action-buttons {
        bottom: 10px;
        right: 10px;
      }
      
      .action-btn {
        padding: 6px 10px;
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Action Buttons -->
  <div class="action-buttons">
    <button class="action-btn btn-print" onclick="printSummary()">
      <i class="fas fa-print"></i>
      Print PDF
    </button>
    <button class="action-btn btn-export" onclick="exportToExcel()">
      <i class="fas fa-file-excel"></i>
      Export Excel
    </button>
    <button class="action-btn btn-share" onclick="shareSummary()">
      <i class="fas fa-share-alt"></i>
      Share Link
    </button>
    <button class="action-btn btn-back" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
      Back
    </button>
  </div>

  <div class="summary-container">
    <!-- Header -->
    <div class="summary-header">
      <div class="summary-title">
        <i class="fas fa-clipboard-list"></i>
        Labour Care Guide
      </div>
      <div class="summary-subtitle">
        Clinical Summary for Labour Monitoring and Decision Making
      </div>
    </div>

    <!-- Patient Information -->
    <div class="patient-info">
      <div class="patient-info-item">
        <div class="patient-info-label">Patient Name</div>
        <div class="patient-info-value" id="patientName">Loading...</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Age</div>
        <div class="patient-info-value" id="patientAge">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Parity</div>
        <div class="patient-info-value" id="patientParity">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Labour Onset</div>
        <div class="patient-info-value" id="labourOnset">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Active Labour Start</div>
        <div class="patient-info-value" id="activeLabourStart">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Membranes Ruptured</div>
        <div class="patient-info-value" id="membranesRuptured">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Risk Factors</div>
        <div class="patient-info-value" id="riskFactors">-</div>
      </div>
      <div class="patient-info-item">
        <div class="patient-info-label">Second Stage Start</div>
        <div class="patient-info-value" id="secondStageStart">-</div>
      </div>
    </div>

    <!-- Supportive Care Section -->
    <div class="section-header">
      <i class="fas fa-hands-helping"></i>
      Supportive Care
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="supportiveCareTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- FHR Section -->
    <div class="section-header">
      <i class="fas fa-heartbeat"></i>
      FHR
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="fhrTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Baby Section -->
    <div class="section-header">
      <i class="fas fa-baby"></i>
      Baby
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="babyTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Woman Section -->
    <div class="section-header">
      <i class="fas fa-female"></i>
      Woman
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="womanTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Contractions Section -->
    <div class="section-header">
      <i class="fas fa-utensils"></i>
      Contractions
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="contractionsTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Cervix Plot Section -->
    <div class="section-header">
      <i class="fas fa-chart-area"></i>
      Cervix [Plot X]
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="cervixPlotTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Descent Plot Section -->
    <div class="section-header">
      <i class="fas fa-chart-line"></i>
      Descent [Plot O]
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="descentPlotTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Medication Section -->
    <div class="section-header">
      <i class="fas fa-pills"></i>
      Medication
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="medicationTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Shared Decision-Making Section -->
    <div class="section-header">
      <i class="fas fa-comments"></i>
      Shared Decision-Making
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="decisionMakingTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Initials Section -->
    <div class="section-header">
      <i class="fas fa-signature"></i>
      Initials
    </div>
    <div class="table-responsive">
      <table class="summary-table" id="initialsTable">
        <!-- Table will be generated here -->
      </table>
    </div>

    <!-- Clinical Recommendations Section -->
    <div class="section-header" style="background: #dc2626; margin-top: 30px;">
      <i class="fas fa-stethoscope"></i>
      Clinical Recommendations & Alerts
    </div>
    <div id="recommendationsSection" style="background: #fff; padding: 20px; border: 2px solid #f0f0f0; border-radius: 8px; margin-bottom: 20px;">
      <!-- Recommendations will be populated here -->
    </div>


  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  
  <script>
    // Global variables
    let patientData = {};
    let summaryData = {};
    let secondStageData = {};
    let activeFirstStageStartTime = null;
    
    // Time column arrays (matching summary.html structure)
    let supportiveCareTimeCols = [];
    let babyBaselineTimeCols = [];
    let babyOtherTimeCols = [];
    let womanTimeCols = [];
    let contractionsTimeCols = [];
    let cervixPlotTimeCols = [];
    let descentPlotTimeCols = [];
    let medicationTimeCols = [];
    let assessmentTimeCols = [];
    let planTimeCols = [];
    let initialsTimeCols = [];
    
    // Get patient ID from URL parameters
    function getPatientIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('patient');
    }
    
    const patientId = getPatientIdFromUrl();
    
    // Load data when page loads
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        // Add a small delay to prevent race condition with auth state
        setTimeout(() => {
          const currentUser = firebase.auth().currentUser;
          if (!currentUser) {
            console.log('No authenticated user found, redirecting to login');
            window.location.href = "login.html";
          }
        }, 100);
      } else {
        console.log('User authenticated:', user.uid);
        loadSummaryData();
      }
    });
    
    // Check if a cervix plot value should be highlighted as an alert based on time thresholds
    function checkCervixPlotAlert(cervixValue, dataValue, timeKey) {
      if (!dataValue || dataValue !== 'X') return false;
      
      // Define time thresholds for each cervix value (in hours)
      const timeThresholds = {
        '10': 0,    // No threshold for 10cm
        '9': 2,     // ≥ 2h
        '8': 2.5,   // ≥ 2.5h  
        '7': 3,     // ≥ 3h
        '6': 5,     // ≥ 5h
        '5': 6      // ≥ 6h
      };
      
      const thresholdHours = timeThresholds[cervixValue];
      if (!thresholdHours) return false; // No threshold for this cervix value
      
      // Get the current time from the timeKey (format: "HH_MM")
      const [hours, minutes] = timeKey.split('_').map(Number);
      const currentTime = hours * 60 + minutes; // Convert to minutes
      
      // Get the active first stage start time
      if (!activeFirstStageStartTime) return false;
      const [startHours, startMinutes] = activeFirstStageStartTime.split(':').map(Number);
      const startTime = startHours * 60 + startMinutes; // Convert to minutes
      
      // Calculate elapsed time in hours
      let elapsedHours = (currentTime - startTime) / 60;
      
      // Handle midnight crossing
      if (elapsedHours < 0) {
        elapsedHours += 24;
      }
      
      // Check if elapsed time exceeds threshold
      return elapsedHours >= thresholdHours;
    }

    // Check if a value should be highlighted as an alert (same logic as summary.html)
    function checkAlertValue(fieldName, value) {
      if (!value) return false;
      
      // Check for alert conditions based on field and value
      if (fieldName.includes('Companion') && value === 'N') {
        return true;
      } else if (fieldName.includes('Mobility') && value === 'SP') {
        return true;
      } else if (fieldName.includes('Baseline_FHR')) {
        const fhr = parseFloat(value);
        if (fhr < 110 || fhr >= 160) {
          return true;
        }
      } else if (fieldName.includes('Pulse')) {
        const pulse = parseFloat(value);
        if (pulse < 60 || pulse >= 120) {
          return true;
        }
      } else if (fieldName.includes('Systolic_BP')) {
        const bp = parseFloat(value);
        if (bp < 80 || bp >= 140) {
          return true;
        }
      } else if (fieldName.includes('Diastolic_BP')) {
        const bp = parseFloat(value);
        if (bp >= 90) {
          return true;
        }
      } else if (fieldName.includes('Temperature_C')) {
        const temp = parseFloat(value);
        if (temp < 35.0 || temp >= 37.5) {
          return true;
        }
      } else if (fieldName.includes('FHR_deceleration') && value === 'L') {
        return true;
      } else if (fieldName.includes('Amniotic_fluid') && (value === 'M+++' || value === 'B')) {
        return true;
      } else if (fieldName.includes('Fetal_position') && (value === 'P' || value === 'T')) {
        return true;
      } else if (fieldName.includes('Caput') && value === '+++') {
        return true;
      } else if (fieldName.includes('Moulding') && value === '+++') {
        return true;
      } else if (fieldName.includes('Pain_Relief') && value === 'N') {
        return true;
      } else if (fieldName.includes('Oral_fluids') && value === 'N') {
        return true;
      } else if (fieldName.includes('Contractions_per_10_min')) {
        const contractions = parseFloat(value);
        if (contractions <= 2 || contractions > 5) {
          return true;
        }
      } else if (fieldName.includes('Duration_of_contractions')) {
        const duration = parseFloat(value);
        if (duration < 20 || duration > 60) {
          return true;
        }
      } else if (fieldName.includes('Urine')) {
        if (value.includes('P++') || value.includes('A++')) {
          return true;
        }
      }
      
      return false;
    }

    // Load all summary data
    async function loadSummaryData() {
      try {
        console.log('Loading summary data for patient:', patientId);
        const base = firebase.firestore().collection("patients").doc(patientId);
        
        // Load patient basic info
        const patientDoc = await base.get();
        if (patientDoc.exists) {
          patientData = patientDoc.data();
          console.log('Patient data loaded:', patientData);
          populatePatientInfo();
        } else {
          console.log('No patient document found');
        }
        
        // Load summary records
        const summaryDoc = await base.collection("records").doc("summary").get();
        if (summaryDoc.exists) {
          summaryData = summaryDoc.data();
          console.log('Summary data loaded:', summaryData);
          
          // Debug: Check for medicine data
          const medicineKeys = Object.keys(summaryData).filter(key => key.includes('Medication_Medicine'));
          console.log('Medicine keys found:', medicineKeys);
          medicineKeys.forEach(key => {
            console.log(`${key}:`, summaryData[key]);
          });
          
          // Check if starting time is stored in summary data
          if (summaryData.startingTime && !activeFirstStageStartTime) {
            activeFirstStageStartTime = summaryData.startingTime;
            console.log('Active first stage start time loaded from summary data:', activeFirstStageStartTime);
          }
        } else {
          console.log('No summary document found');
        }
        
        // Note: Medication data is already loaded from the records collection above
        // The detailed medicine and oxytocin fields are stored in the summary document
        
        console.log('Medication data loaded and merged with summary data');
        
        // Load starting time and generate time columns
        const startingTimeDoc = await base.collection("records").doc("startingTime").get();
        if (startingTimeDoc.exists) {
          const startingData = startingTimeDoc.data();
          console.log('Starting time data:', startingData);
          if (startingData.startingTime) {
            activeFirstStageStartTime = startingData.startingTime;
            generateDynamicTimeColumns();
            console.log('Dynamic time columns generated from starting time:', activeFirstStageStartTime);
          } else {
            generateDefaultTimeColumns();
            console.log('Default time columns generated');
          }
        } else {
          console.log('No starting time document found, using defaults');
          // Set a default starting time if none found
          if (!activeFirstStageStartTime) {
            const now = new Date();
            activeFirstStageStartTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            console.log('Using current time as default starting time:', activeFirstStageStartTime);
          }
          generateDefaultTimeColumns();
          console.log('Default time columns generated');
        }
        
        // Load second stage data
        const secondStageDoc = await base.collection("records").doc("secondStage").get();
        if (secondStageDoc.exists) {
          secondStageData = secondStageDoc.data();
          console.log('Second stage data:', secondStageData);
          if (secondStageData.isSecondStageActive) {
            document.getElementById('secondStageStart').textContent = secondStageData.secondStageStartTime || '-';
            
            // Generate hybrid time columns for second stage
            if (activeFirstStageStartTime && secondStageData.secondStageStartTime) {
              console.log('Generating hybrid time columns for second stage...');
              generateHybridTimeColumns();
            }
          }
        } else {
          console.log('No second stage document found');
        }
        
        // Generate all tables
        console.log('Generating tables with dynamic time columns');
        console.log('Medicine data before table generation:', {
          'Medication_Medicine_21_49': summaryData['Medication_Medicine_21_49'],
          'Medication_Medicine_21_49_name': summaryData['Medication_Medicine_21_49_name'],
          'Medication_Medicine_21_49_dosage': summaryData['Medication_Medicine_21_49_dosage'],
          'Medication_Medicine_21_49_route': summaryData['Medication_Medicine_21_49_route'],
          'Medication_Medicine_21_49_frequency': summaryData['Medication_Medicine_21_49_frequency']
        });
        generateAllTables();
        
        // Show clinical recommendations
        showRecommendations();
        
      } catch (error) {
        console.error("Error loading summary data:", error);
        document.body.innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
      }
    }
    
    // Populate patient information
    function populatePatientInfo() {
      document.getElementById('patientName').textContent = patientData.name || 'Not specified';
      document.getElementById('patientAge').textContent = patientData.age || '-';
      document.getElementById('patientParity').textContent = patientData.parity || '-';
      document.getElementById('labourOnset').textContent = patientData.labour_onset || '-';
      document.getElementById('activeLabourStart').textContent = patientData.active_labour || '-';
      document.getElementById('membranesRuptured').textContent = patientData.ruptured_membrane || '-';
      document.getElementById('riskFactors').textContent = patientData.risk_factors || 'None identified';
    }
    
    // Generate dynamic time columns based on starting time (matching summary.html)
    function generateDynamicTimeColumns() {
      console.log('🚀 generateDynamicTimeColumns() called');
      console.log(`  activeFirstStageStartTime: ${activeFirstStageStartTime}`);
      
      if (!activeFirstStageStartTime) {
        // Default fallback - use current time as starting point
        const now = new Date();
        activeFirstStageStartTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        console.log(`  No starting time, using current time: ${activeFirstStageStartTime}`);
      }
      
      const startHour = parseInt(activeFirstStageStartTime.split(':')[0]);
      const startMinute = parseInt(activeFirstStageStartTime.split(':')[1]);
      
      // Supportive Care: +1 hour intervals for 12 hours
      supportiveCareTimeCols = [];
      for (let i = 0; i <= 12; i++) {
        const hour = (startHour + i) % 24;
        supportiveCareTimeCols.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
      }
      
      // Baby Baseline & FHR: +30 minute intervals for 12 hours (FIRST STAGE)
      babyBaselineTimeCols = [];
      for (let i = 0; i <= 24; i++) {
        const totalMinutes = startHour * 60 + startMinute + (i * 30);
        const hour = Math.floor(totalMinutes / 60) % 24;
        const minute = totalMinutes % 60;
        babyBaselineTimeCols.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
      }
      
      // Contractions: +30 minute intervals for 12 hours (FIRST STAGE)
      contractionsTimeCols = [];
      for (let i = 0; i <= 24; i++) {
        const totalMinutes = startHour * 60 + startMinute + (i * 30);
        const hour = Math.floor(totalMinutes / 60) % 24;
        const minute = totalMinutes % 60;
        contractionsTimeCols.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
      }
      
      // Baby Other, Woman, Medication, Assessment, Initials: +1 hour intervals for 12 hours
      babyOtherTimeCols = [];
      womanTimeCols = [];
      medicationTimeCols = [];
      assessmentTimeCols = [];
      initialsTimeCols = [];
      for (let i = 0; i <= 12; i++) {
        const hour = (startHour + i) % 24;
        babyOtherTimeCols.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
        womanTimeCols.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
        medicationTimeCols.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
        assessmentTimeCols.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
        initialsTimeCols.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
      }
      
      // Cervix and Descent Plot: +1 hour intervals
      cervixPlotTimeCols = [...supportiveCareTimeCols];
      descentPlotTimeCols = [...supportiveCareTimeCols];
      
      // Plan: +2 hour intervals
      planTimeCols = [];
      for (let i = 0; i <= 6; i++) {
        const hour = (startHour + (i * 2)) % 24;
        planTimeCols.push(`${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
      }
      
      console.log('Generated time columns:', {
        supportiveCare: supportiveCareTimeCols.length,
        babyBaseline: babyBaselineTimeCols.length,
        contractions: contractionsTimeCols.length,
        babyOther: babyOtherTimeCols.length,
        woman: womanTimeCols.length
      });
    }
    
    // Generate hybrid time columns: 30-min before second stage, 15-min after (matching summary.html)
    function generateHybridTimeColumns() {
      console.log('🚀 generateHybridTimeColumns() called');
      console.log(`  activeFirstStageStartTime: ${activeFirstStageStartTime}`);
      console.log(`  secondStageStartTime: ${secondStageData.secondStageStartTime}`);
      console.log(`  isSecondStageActive: ${secondStageData.isSecondStageActive}`);
      console.log(`  Starting from first stage time: ${activeFirstStageStartTime}`);
      console.log(`  Switching to 15-min intervals at EXACT second stage time: ${secondStageData.secondStageStartTime}`);
      
      if (!activeFirstStageStartTime) {
        console.log('❌ No activeFirstStageStartTime, returning early');
        return;
      }
      
      // Create Date objects for proper time comparison across midnight
      const baseDate = new Date('2024-01-01');
      const startTimeDate = createTimeDate(activeFirstStageStartTime, baseDate);
      const secondStageDate = createTimeDate(secondStageData.secondStageStartTime, baseDate);
      
      // If second stage is earlier than first stage, it means it's the next day
      if (secondStageDate < startTimeDate) {
        secondStageDate.setDate(secondStageDate.getDate() + 1);
      }
      
      console.log(`  First stage start: ${startTimeDate.toTimeString().slice(0, 5)}`);
      console.log(`  Second stage start (EXACT): ${secondStageDate.toTimeString().slice(0, 5)}`);
      
      // Generate hybrid contractions time columns
      contractionsTimeCols = [];
      
      // Phase 1: Generate 30-minute intervals up to (but not including) second stage time
      let currentTime = new Date(startTimeDate);
      while (currentTime < secondStageDate) {
        const timeStr = currentTime.toTimeString().slice(0, 5);
        contractionsTimeCols.push(timeStr);
        console.log(`  Added ${timeStr} (30-min interval, before second stage)`);
        currentTime.setMinutes(currentTime.getMinutes() + 30);
      }
      
      // Phase 2: Add the EXACT second stage time
      const exactSecondStageTime = secondStageDate.toTimeString().slice(0, 5);
      contractionsTimeCols.push(exactSecondStageTime);
      console.log(`  Added ${exactSecondStageTime} (EXACT second stage time)`);
      
      // Phase 3: Continue with 15-minute intervals for 4 hours after second stage
      currentTime = new Date(secondStageDate);
      currentTime.setMinutes(currentTime.getMinutes() + 15); // Start 15 minutes after second stage
      const endTime = new Date(secondStageDate);
      endTime.setHours(endTime.getHours() + 4); // 4 hours after second stage
      
      while (currentTime <= endTime) {
        const timeStr = currentTime.toTimeString().slice(0, 5);
        contractionsTimeCols.push(timeStr);
        console.log(`  Added ${timeStr} (15-min interval, after second stage)`);
        currentTime.setMinutes(currentTime.getMinutes() + 15);
      }
      
      // Generate hybrid FHR time columns (same logic as contractions)
      babyBaselineTimeCols = [];
      
      // Phase 1: Generate 30-minute intervals up to (but not including) second stage time
      currentTime = new Date(startTimeDate);
      while (currentTime < secondStageDate) {
        const timeStr = currentTime.toTimeString().slice(0, 5);
        babyBaselineTimeCols.push(timeStr);
        console.log(`  FHR: Added ${timeStr} (30-min interval, before second stage)`);
        currentTime.setMinutes(currentTime.getMinutes() + 30);
      }
      
      // Phase 2: Add the EXACT second stage time
      babyBaselineTimeCols.push(exactSecondStageTime);
      console.log(`  FHR: Added ${exactSecondStageTime} (EXACT second stage time)`);
      
      // Phase 3: Continue with 15-minute intervals for 4 hours after second stage
      currentTime = new Date(secondStageDate);
      currentTime.setMinutes(currentTime.getMinutes() + 15); // Start 15 minutes after second stage
      
      while (currentTime <= endTime) {
        const timeStr = currentTime.toTimeString().slice(0, 5);
        babyBaselineTimeCols.push(timeStr);
        console.log(`  FHR: Added ${timeStr} (15-min interval, after second stage)`);
        currentTime.setMinutes(currentTime.getMinutes() + 15);
      }
      
      // Generate hybrid cervix plot time columns (same logic as contractions)
      cervixPlotTimeCols = [];
      
      // Phase 1: Generate 1-hour intervals up to (but not including) second stage time
      currentTime = new Date(startTimeDate);
      while (currentTime < secondStageDate) {
        const timeStr = currentTime.toTimeString().slice(0, 5);
        cervixPlotTimeCols.push(timeStr);
        console.log(`  Cervix: Added ${timeStr} (1-hour interval, before second stage)`);
        currentTime.setHours(currentTime.getHours() + 1);
      }
      
      // Phase 2: Add the EXACT second stage time
      cervixPlotTimeCols.push(exactSecondStageTime);
      console.log(`  Cervix: Added ${exactSecondStageTime} (EXACT second stage time)`);
      
      // Phase 3: Continue with 15-minute intervals for 4 hours after second stage
      currentTime = new Date(secondStageDate);
      currentTime.setMinutes(currentTime.getMinutes() + 15); // Start 15 minutes after second stage
      
      while (currentTime <= endTime) {
        const timeStr = currentTime.toTimeString().slice(0, 5);
        cervixPlotTimeCols.push(timeStr);
        console.log(`  Cervix: Added ${timeStr} (15-min interval, after second stage)`);
        currentTime.setMinutes(currentTime.getMinutes() + 15);
      }
      
      // Generate other time columns that DON'T switch to 15-minute intervals
      // These should use the original generateDynamicTimeColumns logic
      generateOtherTimeColumns();
      
      console.log('✅ Generated hybrid time columns:');
      console.log(`  Contractions: ${contractionsTimeCols.length} intervals:`, contractionsTimeCols);
      console.log(`  FHR: ${babyBaselineTimeCols.length} intervals:`, babyBaselineTimeCols);
      console.log(`  Cervix Plot: ${cervixPlotTimeCols.length} intervals:`, cervixPlotTimeCols);
      console.log(`  Other tables: Using original intervals (1-hour, 2-hour, 30-min)`);
    }
    
    // Generate other time columns that DON'T switch to 15-minute intervals
    function generateOtherTimeColumns() {
      console.log('🚀 generateOtherTimeColumns() called');
      console.log(`  activeFirstStageStartTime: ${activeFirstStageStartTime}`);
      
      if (!activeFirstStageStartTime) {
        console.log('❌ No activeFirstStageStartTime, returning early');
        return;
      }
      
      const startHour = parseInt(activeFirstStageStartTime.split(':')[0]);
      const startMinute = parseInt(activeFirstStageStartTime.split(':')[1]);
      console.log(`  Start time: ${startHour}:${startMinute}`);
      
      // Helper function to generate time columns with exact second stage time included
      const generateWithSecondStage = () => {
        const timeCols = [];
        const startTimeDate = new Date(`2000-01-01T${activeFirstStageStartTime}:00`);
        const endTimeDate = new Date(startTimeDate);
        endTimeDate.setHours(endTimeDate.getHours() + 12); // 12-hour horizon
        
        let currentTime = new Date(startTimeDate);
        
        // Add exact second stage time if it exists
        if (secondStageData.secondStageStartTime && secondStageData.isSecondStageActive) {
          const secondStageDate = new Date(`2000-01-01T${secondStageData.secondStageStartTime}:00`);
          const exactSecondStageTime = secondStageData.secondStageStartTime;
          
          // Generate 1-hour intervals up to (but not including) second stage
          while (currentTime < secondStageDate) {
            const timeStr = currentTime.toTimeString().slice(0, 5);
            timeCols.push(timeStr);
            currentTime.setHours(currentTime.getHours() + 1);
          }
          
          // Add the EXACT second stage time
          timeCols.push(exactSecondStageTime);
          console.log(`  Added ${exactSecondStageTime} (EXACT second stage time)`);
          
          // Continue 1-hour intervals after second stage
          currentTime = new Date(secondStageDate);
          currentTime.setHours(currentTime.getHours() + 1);
        }
        
        // Generate remaining 1-hour intervals
        while (currentTime <= endTimeDate) {
          const timeStr = currentTime.toTimeString().slice(0, 5);
          timeCols.push(timeStr);
          currentTime.setHours(currentTime.getHours() + 1);
        }
        
        return timeCols;
      };
      
      // Generate time columns with second stage support
      supportiveCareTimeCols = generateWithSecondStage();
      babyOtherTimeCols = generateWithSecondStage();
      womanTimeCols = generateWithSecondStage();
      medicationTimeCols = generateWithSecondStage();
      assessmentTimeCols = generateWithSecondStage();
      initialsTimeCols = generateWithSecondStage();
      descentPlotTimeCols = generateWithSecondStage();
      
      // Note: cervixPlotTimeCols is generated in generateHybridTimeColumns() for second stage
      
      // Plan: +2 hour intervals for 12 hours
      planTimeCols = [];
      for (let i = 0; i <= 6; i++) {
        const hour = (startHour + (i * 2)) % 24;
        const timeStr = `${hour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`;
        planTimeCols.push(timeStr);
      }
      
      console.log('✅ Generated other time columns:');
      console.log(`  Supportive Care: ${supportiveCareTimeCols.length} intervals (1-hour)`);
      console.log(`  Baby Other: ${babyOtherTimeCols.length} intervals (1-hour)`);
      console.log(`  Woman: ${womanTimeCols.length} intervals (1-hour)`);
      console.log(`  Medication: ${medicationTimeCols.length} intervals (1-hour)`);
      console.log(`  Assessment: ${assessmentTimeCols.length} intervals (1-hour)`);
      console.log(`  Initials: ${initialsTimeCols.length} intervals (1-hour)`);
      console.log(`  Descent Plot: ${descentPlotTimeCols.length} intervals (1-hour)`);
      console.log(`  Plan: ${planTimeCols.length} intervals (2-hour)`);
    }
    
    // Generate default time columns if no starting time is available
    function generateDefaultTimeColumns() {
      const now = new Date();
      activeFirstStageStartTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      generateDynamicTimeColumns();
    }
    
    // Generate all tables
    function generateAllTables() {
      console.log('🔍 generateAllTables() called');
      generateSupportiveCareTable();
      generateFHRTable();
      generateBabyTable();
      generateWomanTable();
      generateContractionsTable();
      generateCervixPlotTable();
      generateDescentPlotTable();
      generateMedicationTable();
      generateDecisionMakingTable();
      generateInitialsTable();
    }
    
    // Check if a time is in second stage
    function isSecondStageTime(time) {
      if (!secondStageData.isSecondStageActive || !secondStageData.secondStageStartTime) {
        return false;
      }
      
      // Create Date objects for proper time comparison across midnight
      const baseDate = new Date('2024-01-01'); // Use a common base date
      const timeDate = createTimeDate(time, baseDate);
      const secondStageDate = createTimeDate(secondStageData.secondStageStartTime, baseDate);
      const activeFirstStageDate = createTimeDate(activeFirstStageStartTime, baseDate);
      
      // If second stage is earlier than first stage, it means it's the next day
      if (secondStageDate < activeFirstStageDate) {
        // Second stage is next day, so adjust second stage date
        secondStageDate.setDate(secondStageDate.getDate() + 1);
      }
      
      // If current time is earlier than first stage, it means it's the next day
      if (timeDate < activeFirstStageDate) {
        timeDate.setDate(timeDate.getDate() + 1);
      }
      
      const isSecondStage = timeDate >= secondStageDate;
      console.log(`🔍 isSecondStageTime(${time}): ${time} >= ${secondStageData.secondStageStartTime} = ${isSecondStage} (using EXACT second stage time)`);
      return isSecondStage;
    }
    
    // Helper function to create a Date object from time string
    function createTimeDate(timeStr, baseDate) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      const date = new Date(baseDate);
      date.setHours(hours, minutes, 0, 0);
      return date;
    }
    
    // Generate Supportive Care table
    function generateSupportiveCareTable() {
      console.log('🔍 generateSupportiveCareTable() called');
      const table = document.getElementById('supportiveCareTable');
      const fields = ["Companion", "Pain_Relief", "Oral_fluids", "Mobility"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      supportiveCareTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        supportiveCareTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue(field, value);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate FHR table
    function generateFHRTable() {
      const table = document.getElementById('fhrTable');
      const fields = ["Baseline_FHR", "FHR_deceleration"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      babyBaselineTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        babyBaselineTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue(field, value);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Baby table
    function generateBabyTable() {
      const table = document.getElementById('babyTable');
      const fields = ["Amniotic_fluid", "Fetal_position", "Caput", "Moulding"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      babyOtherTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        babyOtherTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue(field, value);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Woman table
    function generateWomanTable() {
      const table = document.getElementById('womanTable');
      const fields = ["Pulse", "Systolic_BP", "Diastolic_BP", "Temperature_C", "Urine"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      womanTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        womanTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue(field, value);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Contractions table
    function generateContractionsTable() {
      const table = document.getElementById('contractionsTable');
      const fields = ["Contractions_per_10_min", "Duration_of_contractions"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      contractionsTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${displayName}</td>`;
        tableHTML += `<td class="alert-column">${getAlertValue(displayName)}</td>`;
        
        contractionsTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue(field, value);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Cervix Plot table
    function generateCervixPlotTable() {
      const table = document.getElementById('cervixPlotTable');
      const cervixValues = ["10", "9", "8", "7", "6", "5"];
      const timeThresholds = ["", "≥ 2h", "≥ 2.5h", "≥ 3h", "≥ 5h", "≥ 6h"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Cervix [Plot X]</th>';
      tableHTML += '<th class="alert-column">Alert</th>';
      
      cervixPlotTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      cervixValues.forEach((cervixValue, index) => {
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${cervixValue}</td>`;
        const thresholdValue = timeThresholds[index];
        const highlightedThreshold = thresholdValue ? `<span class="alert-value">${thresholdValue}</span>` : '';
        tableHTML += `<td class="alert-column">${highlightedThreshold}</td>`;
        
        cervixPlotTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `Cervix_Plot_${cervixValue}_${timeKey}`;
          const dataValue = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this cervix plot value should be highlighted as an alert based on time thresholds
          const shouldHighlight = checkCervixPlotAlert(cervixValue, dataValue, timeKey);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${dataValue}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Descent Plot table
    function generateDescentPlotTable() {
      const table = document.getElementById('descentPlotTable');
      const descentValues = ["5", "4", "3", "2", "1", "0"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Descent [Plot O]</th>';
      
      descentPlotTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      descentValues.forEach(descentValue => {
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${descentValue}</td>`;
        
        descentPlotTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `Descent_Plot_${descentValue}_${timeKey}`;
          const dataValue = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue('Descent Plot', dataValue);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${dataValue}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Medication table
    function generateMedicationTable() {
      const table = document.getElementById('medicationTable');
      const fields = ["Oxytocin", "Medicine", "IV_Fluids"];
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      
      supportiveCareTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      fields.forEach(field => {
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">${field.replace(/_/g, ' ')}</td>`;
        
        supportiveCareTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `Medication_${field}_${timeKey}`;
          const value = summaryData[key] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue(field, value);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          // Special handling for Medicine field with detailed information
          let displayValue = value;
          if (field === 'Medicine') {
            if (value === 'Y') {
              // Classic LCG format: separate fields
              const nameValue = summaryData[`Medication_Medicine_${timeKey}_name`] || '';
              const dosageValue = summaryData[`Medication_Medicine_${timeKey}_dosage`] || '';
              const routeValue = summaryData[`Medication_Medicine_${timeKey}_route`] || '';
              const frequencyValue = summaryData[`Medication_Medicine_${timeKey}_frequency`] || '';
              
              // Build detailed medicine string
              const medicineDetails = [];
              if (nameValue) medicineDetails.push(nameValue);
              if (dosageValue) medicineDetails.push(dosageValue);
              if (routeValue) medicineDetails.push(routeValue);
              if (frequencyValue) medicineDetails.push(frequencyValue);
              
              if (medicineDetails.length > 0) {
                displayValue = medicineDetails.join(' - ');
              }
            }
            // If value is not 'Y', it's already the medicine name from Carousel LCG (text format)
            // Just display it as-is
          }
          
          // Special handling for Oxytocin field with detailed information
          if (field === 'Oxytocin') {
            if (value === 'Y') {
              // Classic LCG format: separate UL and drops fields
              const uLValue = summaryData[`Medication_Oxytocin_${timeKey}_UL`] || '';
              const dropsValue = summaryData[`Medication_Oxytocin_${timeKey}_drops`] || '';
              
              if (uLValue && dropsValue) {
                displayValue = `${uLValue} U/L, ${dropsValue} drops/min`;
              } else if (uLValue) {
                displayValue = `${uLValue} U/L`;
              } else if (dropsValue) {
                displayValue = `${dropsValue} drops/min`;
              }
            }
            // If value is not 'Y', it's already formatted text from Carousel LCG
            // Just display it as-is
          }
          
          tableHTML += `<td class="${cellClass}${alertClass}">${displayValue}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Decision Making table
    function generateDecisionMakingTable() {
      const table = document.getElementById('decisionMakingTable');
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      
      supportiveCareTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      
      // Assessment fields
      const assessmentFields = ["Womans_condition", "Babys_condition", "Labour_progress", "Other_concerns"];
      assessmentFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ').replace('s condition', "'s condition");
        tableHTML += '<tr>';
        tableHTML += `<td class="field-column">Assessment: ${displayName}</td>`;
        
        supportiveCareTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `ASSESSMENT_${field}_${timeKey}`;
          // Backward compatibility: try old naming convention if new one doesn't exist
          const oldKey = `Assessment_${field}_${timeKey}`;
          const value = summaryData[key] || summaryData[oldKey] || '';
          const isSecondStage = isSecondStageTime(time);
          const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
          
          // Check if this value should be highlighted as an alert
          const shouldHighlight = checkAlertValue(field, value);
          const alertClass = shouldHighlight ? ' alert-value' : '';
          
          tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      // Plan field
      tableHTML += '<tr>';
      tableHTML += '<td class="field-column">Plan</td>';
      
      supportiveCareTimeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `PLAN_${timeKey}`;
        // Backward compatibility: try old naming convention if new one doesn't exist
        const oldKey = `Plan_${timeKey}`;
        const value = summaryData[key] || summaryData[oldKey] || '';
        const isSecondStage = isSecondStageTime(time);
        const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
        
        // Check if this value should be highlighted as an alert
        const shouldHighlight = checkAlertValue('Plan', value);
        const alertClass = shouldHighlight ? ' alert-value' : '';
        
        tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
      });
      
      tableHTML += '</tr>';
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    
    // Generate Initials table
    function generateInitialsTable() {
      const table = document.getElementById('initialsTable');
      
      let tableHTML = '<thead><tr>';
      tableHTML += '<th class="field-column">Field</th>';
      
      supportiveCareTimeCols.forEach(time => {
        const isSecondStage = isSecondStageTime(time);
        const headerClass = isSecondStage ? 'time-column second-stage' : 'time-column';
        tableHTML += `<th class="${headerClass}">${time}</th>`;
      });
      
      tableHTML += '</tr></thead><tbody>';
      tableHTML += '<tr>';
      tableHTML += '<td class="field-column">Initials</td>';
      
      supportiveCareTimeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `INITIALS_${timeKey}`;
        // Backward compatibility: try old naming convention if new one doesn't exist
        const oldKey = `Initials_${timeKey}`;
        const value = summaryData[key] || summaryData[oldKey] || '';
        const isSecondStage = isSecondStageTime(time);
        const cellClass = isSecondStage ? 'data-cell second-stage' : 'data-cell';
        
        // Check if this value should be highlighted as an alert
        const shouldHighlight = checkAlertValue('Initials', value);
        const alertClass = shouldHighlight ? ' alert-value' : '';
        
        tableHTML += `<td class="${cellClass}${alertClass}">${value}</td>`;
      });
      
      tableHTML += '</tr>';
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }
    

    
    // Helper functions
    function getAlertValue(field) {
      const alertValues = {
        "Companion": "N",
        "Pain Relief": "N",
        "Oral fluids": "N",
        "Mobility": "SP",
        "Baseline FHR": "<110, ≥160",
        "FHR deceleration": "L",
        "Amniotic fluid": "M+++, B",
        "Fetal position": "P, T",
        "Caput": "+++",
        "Moulding": "+++",
        "Pulse": "<60, ≥120",
        "Systolic BP": "<80, ≥140",
        "Diastolic BP": "≥90",
        "Temperature C": "<35.0, ≥37.5",
        "Urine": "P++, A++",
        "Contractions per 10 min": "≤2, >5",
        "Duration of contractions": "<20, >60"
      };
      
      const value = alertValues[field] || '';
      // Wrap alert values in span with alert-value class for highlighting
      return value ? `<span class="alert-value">${value}</span>` : '';
    }
    
    // Action functions
    function printSummary() {
      window.print();
    }
    
    function exportToExcel() {
      try {
        // Create a new workbook
        const wb = XLSX.utils.book_new();
        
        // Create the main summary sheet
        const summaryData = generateExcelData();
        const ws = XLSX.utils.aoa_to_sheet(summaryData);
        
        // Set column widths
        ws['!cols'] = [
          { width: 20 }, // Field column
          { width: 12 }, // Alert column
          ...Array(supportiveCareTimeCols.length).fill({ width: 12 }) // Time columns
        ];
        
        // Add the worksheet to the workbook
        XLSX.utils.book_append_sheet(wb, ws, "WHO LCG Summary");
        
        // Generate filename
        const patientName = patientData.name || 'Patient';
        const timestamp = new Date().toISOString().split('T')[0];
        const filename = `WHO_LCG_${patientName}_${timestamp}.xlsx`;
        
        // Save the file
        XLSX.writeFile(wb, filename);
        
      } catch (error) {
        console.error('Error exporting to Excel:', error);
        alert('Error exporting to Excel: ' + error.message);
      }
    }
    
    function generateExcelData() {
      const data = [];
      
      // Header row
      const headerRow = ['Field', 'Alert'];
      supportiveCareTimeCols.forEach(time => {
        headerRow.push(time);
      });
      data.push(headerRow);
      
      // Patient Information
      data.push(['', '']); // Empty row
      data.push(['PATIENT INFORMATION', '']);
      data.push(['Patient Name', '', patientData.name || '']);
      data.push(['Age', '', patientData.age || '']);
      data.push(['Parity', '', patientData.parity || '']);
      data.push(['Labour Onset', '', patientData.labour_onset || '']);
      data.push(['Active Labour Start', '', patientData.active_labour || '']);
      data.push(['Membranes Ruptured', '', patientData.ruptured_membrane || '']);
      data.push(['Risk Factors', '', patientData.risk_factors || '']);
      data.push(['Second Stage Start', '', secondStageData.secondStageStartTime || '']);
      
      // Supportive Care section
      data.push(['', '']); // Empty row
      data.push(['SUPPORTIVE CARE', '']);
      const supportiveFields = ["Companion", "Pain_Relief", "Oral_fluids", "Mobility"];
      supportiveFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        supportiveCareTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // FHR section
      data.push(['', '']); // Empty row
      data.push(['FHR', '']);
      const fhrFields = ["Baseline_FHR", "FHR_deceleration"];
      fhrFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        babyBaselineTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Baby section
      data.push(['', '']); // Empty row
      data.push(['BABY', '']);
      const babyFields = ["Amniotic_fluid", "Fetal_position", "Caput", "Moulding"];
      babyFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        supportiveCareTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Woman section
      data.push(['', '']); // Empty row
      data.push(['WOMAN', '']);
      const womanFields = ["Pulse", "Systolic_BP", "Diastolic_BP", "Temperature_C", "Urine"];
      womanFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        supportiveCareTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Contractions section
      data.push(['', '']); // Empty row
      data.push(['CONTRACTIONS', '']);
      const contractionsFields = ["Contractions_per_10_min", "Duration_of_contractions"];
      contractionsFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ');
        const row = [displayName, getAlertValue(displayName)];
        babyBaselineTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${field}_${timeKey}`;
          row.push(summaryData[key] || '');
        });
        data.push(row);
      });
      
      // Medication section
      data.push(['', '']); // Empty row
      data.push(['MEDICATION', '']);
      
      // Oxytocin with details
      const oxytocinRow = ['Oxytocin', ''];
      supportiveCareTimeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const oxytocinKey = `Medication_Oxytocin_${timeKey}`;
        const oxytocinValue = summaryData[oxytocinKey] || '';
        
        if (oxytocinValue === 'Y') {
          const uLKey = `Medication_Oxytocin_${timeKey}_UL`;
          const dropsKey = `Medication_Oxytocin_${timeKey}_drops`;
          const uLValue = summaryData[uLKey] || '';
          const dropsValue = summaryData[dropsKey] || '';
          
          if (uLValue && dropsValue) {
            oxytocinRow.push(`${uLValue} U/L, ${dropsValue} drops/min`);
          } else if (uLValue) {
            oxytocinRow.push(`${uLValue} U/L`);
          } else if (dropsValue) {
            oxytocinRow.push(`${dropsValue} drops/min`);
          } else {
            oxytocinRow.push('Y');
          }
        } else {
          oxytocinRow.push(oxytocinValue);
        }
      });
      data.push(oxytocinRow);
      
      // Medicine with details
      console.log('🔍 Starting medicine processing...');
      const medicineRow = ['Medicine', ''];
      console.log('supportiveCareTimeCols:', supportiveCareTimeCols);
      supportiveCareTimeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const medicineKey = `Medication_Medicine_${timeKey}`;
        const medicineValue = summaryData[medicineKey] || '';
        
        console.log(`Processing medicine for time ${time} (key: ${timeKey}):`, {
          medicineKey,
          medicineValue,
          hasName: !!summaryData[`Medication_Medicine_${timeKey}_name`],
          hasDosage: !!summaryData[`Medication_Medicine_${timeKey}_dosage`],
          hasRoute: !!summaryData[`Medication_Medicine_${timeKey}_route`],
          hasFrequency: !!summaryData[`Medication_Medicine_${timeKey}_frequency`]
        });
        
        // Debug: Check if the data exists with the exact key format
        console.log(`Checking for data with key: ${medicineKey}`);
        console.log(`Value found: ${summaryData[medicineKey]}`);
        console.log(`Name data: ${summaryData[`Medication_Medicine_${timeKey}_name`]}`);
        console.log(`Dosage data: ${summaryData[`Medication_Medicine_${timeKey}_dosage`]}`);
        console.log(`Route data: ${summaryData[`Medication_Medicine_${timeKey}_route`]}`);
        console.log(`Frequency data: ${summaryData[`Medication_Medicine_${timeKey}_frequency`]}`);
        
        // Debug: Check if there's a time format mismatch
        console.log(`Time from column: "${time}"`);
        console.log(`TimeKey after replace: "${timeKey}"`);
        console.log(`Expected data key: "${medicineKey}"`);
        
        // Check if the data exists with this exact key
        if (summaryData[medicineKey]) {
          console.log(`✅ Found data with key: ${medicineKey}`);
        } else {
          console.log(`❌ No data found with key: ${medicineKey}`);
        }
        
        if (medicineValue === 'Y') {
          const nameKey = `Medication_Medicine_${timeKey}_name`;
          const dosageKey = `Medication_Medicine_${timeKey}_dosage`;
          const routeKey = `Medication_Medicine_${timeKey}_route`;
          const frequencyKey = `Medication_Medicine_${timeKey}_frequency`;
          
          const nameValue = summaryData[nameKey] || '';
          const dosageValue = summaryData[dosageKey] || '';
          const routeValue = summaryData[routeKey] || '';
          const frequencyValue = summaryData[frequencyKey] || '';
          
          console.log(`Medicine details for ${timeKey}:`, {
            name: nameValue,
            dosage: dosageValue,
            route: routeValue,
            frequency: frequencyValue
          });
          
          console.log(`Looking for keys:`, {
            nameKey,
            dosageKey,
            routeKey,
            frequencyKey
          });
          
          // Build detailed medicine string
          const medicineDetails = [];
          if (nameValue) medicineDetails.push(nameValue);
          if (dosageValue) medicineDetails.push(dosageValue);
          if (routeValue) medicineDetails.push(routeValue);
          if (frequencyValue) medicineDetails.push(frequencyValue);
          
          if (medicineDetails.length > 0) {
            medicineRow.push(medicineDetails.join(' - '));
          } else {
            medicineRow.push('Y');
          }
        } else {
          medicineRow.push(medicineValue);
        }
      });
      console.log('🔍 Medicine processing completed. Final row:', medicineRow);
      data.push(medicineRow);
      
      // IV Fluids
      const ivFluidsRow = ['IV Fluids', ''];
      supportiveCareTimeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `Medication_IV_Fluids_${timeKey}`;
        ivFluidsRow.push(summaryData[key] || '');
      });
      data.push(ivFluidsRow);
      
      // Shared Decision-Making section
      data.push(['', '']); // Empty row
      data.push(['SHARED DECISION-MAKING', '']);
      const assessmentFields = ["Womans_condition", "Babys_condition", "Labour_progress", "Other_concerns"];
      assessmentFields.forEach(field => {
        const displayName = field.replace(/_/g, ' ').replace('s condition', "'s condition");
        const row = [`Assessment: ${displayName}`, ''];
        supportiveCareTimeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `ASSESSMENT_${field}_${timeKey}`;
          // Backward compatibility: try old naming convention if new one doesn't exist
          const oldKey = `Assessment_${field}_${timeKey}`;
          row.push(summaryData[key] || summaryData[oldKey] || '');
        });
        data.push(row);
      });
      
      // Plan row
      const planRow = ['Plan', ''];
      supportiveCareTimeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `PLAN_${timeKey}`;
        // Backward compatibility: try old naming convention if new one doesn't exist
        const oldKey = `Plan_${timeKey}`;
        planRow.push(summaryData[key] || summaryData[oldKey] || '');
      });
      data.push(planRow);
      
      // Initials section
      data.push(['', '']); // Empty row
      data.push(['INITIALS', '']);
      const initialsRow = ['Initials', ''];
      supportiveCareTimeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `INITIALS_${timeKey}`;
        // Backward compatibility: try old naming convention if new one doesn't exist
        const oldKey = `Initials_${timeKey}`;
        initialsRow.push(summaryData[key] || summaryData[oldKey] || '');
      });
      data.push(initialsRow);
      
      return data;
    }
    
    function shareSummary() {
      const currentUrl = window.location.href;
      navigator.clipboard.writeText(currentUrl).then(() => {
        alert('Summary link copied to clipboard! Share this link with other clinicians for review.');
      }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = currentUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        textArea.remove();
        alert('Summary link copied to clipboard! Share this link with other clinicians for review.');
      });
    }
    
    // Handle back button - go to labour care entry if opened from there, otherwise go to list
    function goBack() {
      // Check if we have history to go back to
      if (document.referrer && document.referrer.includes('labour-care-entry.html')) {
        // If opened from entry page, go back in history
        window.history.back();
      } else {
        // Otherwise, go to patient list
        window.location.href = 'list.html';
      }
    }
    
    // Show clinical recommendations based on alert values
    function showRecommendations() {
      console.log('=== showRecommendations() called ===');
      
      const recommendationsSection = document.getElementById('recommendationsSection');
      if (!recommendationsSection) {
        console.log('❌ Recommendations section not found');
        return;
      }
      
      console.log('✅ Found recommendations section, checking for alerts...');
      
      // Use a Map to track latest value for each field type
      const latestValues = new Map();
      
      // First, group all field values by field type and find the latest timepoint for each
      Object.keys(summaryData).forEach(fieldName => {
        const value = summaryData[fieldName];
        
        // Extract field base name (remove time suffix like _HH_MM)
        const fieldParts = fieldName.split('_');
        if (fieldParts.length >= 3) {
          // Remove last two parts (time HH_MM)
          const baseFieldName = fieldParts.slice(0, -2).join('_');
          const timeKey = fieldParts.slice(-2).join('_'); // Get HH_MM
          
          // Store with time info
          if (!latestValues.has(baseFieldName)) {
            latestValues.set(baseFieldName, { timeKey, value, fieldName });
          } else {
            // Compare times and keep the latest
            const existing = latestValues.get(baseFieldName);
            if (timeKey > existing.timeKey) {
              latestValues.set(baseFieldName, { timeKey, value, fieldName });
            }
          }
        }
      });
      
      // Use a Map to track unique alerts by field type
      const alertMap = new Map();
      
      // Check only the latest value for each field type
      latestValues.forEach((data, baseFieldName) => {
        const value = data.value;
        const fieldName = data.fieldName;
        
        if (value && value.toString().trim() !== '') {
          // Check if this value should trigger an alert
          let shouldAlert = false;
          let alertType = '';
          
          // Check against WHO LCG alert values (same as summary.html)
          if (fieldName.includes('Baseline_FHR')) {
            const fhr = parseInt(value);
            if (!isNaN(fhr) && (fhr < 110 || fhr >= 160)) {
              shouldAlert = true;
              alertType = 'FHR';
            }
          } else if (fieldName.includes('Pulse')) {
            const pulse = parseInt(value);
            if (!isNaN(pulse) && (pulse < 60 || pulse >= 120)) {
              shouldAlert = true;
              alertType = 'Pulse';
            }
          } else if (fieldName.includes('Systolic_BP')) {
            const bp = parseInt(value);
            if (!isNaN(bp) && (bp < 80 || bp >= 140)) {
              shouldAlert = true;
              alertType = 'Systolic BP';
            }
          } else if (fieldName.includes('Diastolic_BP')) {
            const bp = parseInt(value);
            if (!isNaN(bp) && bp >= 90) {
              shouldAlert = true;
              alertType = 'Diastolic BP';
            }
          } else if (fieldName.includes('Temperature_C')) {
            const temp = parseFloat(value);
            if (!isNaN(temp) && (temp < 35.0 || temp >= 37.5)) {
              shouldAlert = true;
              alertType = 'Temperature C';
            }
          } else if (fieldName.includes('Pain_Relief') && value === 'N') {
            shouldAlert = true;
            alertType = 'Pain Relief';
          } else if (fieldName.includes('Mobility') && value === 'SP') {
            shouldAlert = true;
            alertType = 'Mobility';
          } else if (fieldName.includes('FHR_deceleration') && (value === 'L' || value === 'V' || value === 'E')) {
            shouldAlert = true;
            alertType = 'FHR deceleration';
          } else if (fieldName.includes('Companion') && value === 'N') {
            shouldAlert = true;
            alertType = 'Companion';
          } else if (fieldName.includes('Contractions_per_10_min')) {
            const contractions = parseInt(value);
            if (!isNaN(contractions) && (contractions < 2 || contractions > 5)) {
              shouldAlert = true;
              alertType = 'Contractions per 10 min';
            }
          } else if (fieldName.includes('Duration_of_contractions')) {
            const duration = parseInt(value);
            if (!isNaN(duration) && (duration < 20 || duration > 60)) {
              shouldAlert = true;
              alertType = 'Duration of contractions';
            }
          }
          
          if (shouldAlert) {
            // Store alert by type, not by individual field values
            alertMap.set(alertType, true);
          }
        }
      });
      
      // Generate recommendations HTML
      console.log(`📊 Unique alert types found: ${alertMap.size}`);
      
      if (alertMap.size > 0) {
        // Create recommendations HTML
        let recommendationsHTML = '<div style="padding: 0;"><h5 style="margin-bottom: 15px; color: #dc2626;"><i class="fas fa-exclamation-triangle"></i> Clinical Recommendations:</h5><ul style="margin-left: 20px; line-height: 1.8;">';
        
        // Convert Map keys to Array and sort for consistent display
        const sortedAlertTypes = Array.from(alertMap.keys()).sort();
        
        sortedAlertTypes.forEach(alertType => {
          let recommendation = '';
          
          // Generate specific recommendations based on alert type
          switch (alertType) {
            case 'Pain Relief':
              recommendation = 'Review supportive care measures. Ensure adequate pain relief, mobility, and hydration.';
              break;
            case 'Mobility':
              recommendation = 'Review supportive care measures. Ensure adequate pain relief, mobility, and hydration.';
              break;
            case 'FHR deceleration':
              recommendation = 'Monitor fetal heart rate closely. Consider fetal assessment and continuous monitoring if pattern persists.';
              break;
            case 'FHR':
              recommendation = 'Monitor fetal heart rate closely. Consider fetal assessment and continuous monitoring if pattern persists.';
              break;
            case 'Pulse':
              recommendation = 'Monitor maternal pulse. Check for underlying causes and consider cardiovascular assessment.';
              break;
            case 'Systolic BP':
            case 'Diastolic BP':
              recommendation = 'Monitor blood pressure closely. Consider antihypertensive therapy if severe hypertension.';
              break;
            case 'Temperature C':
              recommendation = 'Monitor for signs of infection. Consider antibiotics if infection suspected.';
              break;
            case 'Contractions per 10 min':
            case 'Duration of contractions':
              recommendation = 'Monitor and document progress. Consider specialist consultation if needed.';
              break;
            case 'Companion':
              recommendation = 'Review supportive care measures. Ensure adequate companion presence.';
              break;
            default:
              recommendation = 'Monitor closely and document findings. Consider specialist consultation if needed.';
          }
          
          recommendationsHTML += `<li style="margin-bottom: 10px;"><strong style="color: #2c3e50;">${alertType}:</strong> ${recommendation}</li>`;
        });
        
        recommendationsHTML += '</ul></div>';
        
        recommendationsSection.innerHTML = recommendationsHTML;
        console.log('✅ Recommendations HTML set with alerts');
      } else {
        // No alerts found
        recommendationsSection.innerHTML = '<p style="color: #059669; text-align: center; padding: 20px;"><i class="fas fa-check-circle"></i> No active alerts. All parameters within normal ranges.</p>';
        console.log('✅ Recommendations HTML set with no alerts message');
      }
      
      console.log('=== showRecommendations() completed ===');
    }
  </script>
</body>
</html>
