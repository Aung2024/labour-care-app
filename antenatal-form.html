<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ANC Visit Record - Maternal & Child Health Care System</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="js/firebase.js"></script>
  <style>
    :root {
      --primary-color: #10b981;
      --secondary-color: #059669;
      --accent-color: #34d399;
      --light-bg: #f0fdf4;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    body {
      background: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .header-section {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1.5rem 0;
      margin-bottom: 2rem;
    }

    .form-section {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
      border-left: 4px solid var(--primary-color);
    }

    .section-title {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 0.5rem;
    }

    .patient-banner {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 2rem;
    }

    .patient-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-size: 0.85rem;
      opacity: 0.8;
      margin-bottom: 0.25rem;
    }

    .info-value {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .anc-table {
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 2rem;
    }

    .anc-table th {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      font-weight: 600;
      text-align: center;
      padding: 0.75rem 0.5rem;
      border: none;
      font-size: 0.9rem;
    }

    .anc-table td {
      padding: 0.75rem 0.5rem;
      border: 1px solid #e5e7eb;
      vertical-align: middle;
    }

    .anc-table input,
    .anc-table select {
      border: none;
      background: transparent;
      width: 100%;
      padding: 0.25rem;
      font-size: 0.9rem;
    }

    .anc-table input:focus,
    .anc-table select:focus {
      outline: 2px solid var(--primary-color);
      background: #f0fdf4;
      border-radius: 4px;
    }

    .danger-signs-card {
      border: 2px solid #f59e0b;
      border-radius: 10px;
      margin-bottom: 1rem;
    }

    .danger-signs-card .card-header {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      font-weight: 600;
    }

    .danger-signs-card.severe {
      border-color: #dc2626;
    }

    .danger-signs-card.severe .card-header {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
    }

    .form-check-input:checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .quick-fill-btn {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      margin-top: 0.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .quick-fill-btn:hover {
      background: var(--secondary-color);
      transform: translateY(-1px);
    }

    .btn-save {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .footer {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      color: #374151;
      text-align: center;
      padding: 2rem;
      margin-top: 2rem;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: var(--card-shadow);
    }

    @media (max-width: 768px) {
      .anc-table {
        font-size: 0.8rem;
      }
      
      .anc-table th,
      .anc-table td {
        padding: 0.5rem 0.25rem;
      }
      
      .patient-info-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header-section">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="mb-2">
            <i class="fas fa-clipboard-list me-3"></i>
            ANC Visit Record
          </h1>
          <p class="mb-0">Comprehensive antenatal care visit documentation</p>
        </div>
        <div class="col-md-4 text-end">
          <div class="d-flex align-items-center justify-content-end gap-3">
            <a href="antenatal-care.html" class="btn btn-outline-light btn-sm">
              <i class="fas fa-arrow-left me-2"></i>Back to ANC
            </a>
            <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
              <i class="fas fa-sign-out-alt me-2"></i>Logout
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Patient Banner -->
    <div class="patient-banner">
      <h4 class="mb-3">
        <i class="fas fa-user-injured me-2"></i>Patient Information
      </h4>
      <div class="patient-info-grid" id="patientInfoGrid">
        <!-- Patient info will be populated here -->
      </div>
    </div>

    <!-- ANC Visit Form -->
    <form id="ancForm" onsubmit="saveVisitData(event)">
      <!-- Visit Header -->
      <div class="form-section">
        <h5 class="section-title">
          <i class="fas fa-calendar-alt me-2"></i>Visit Information
        </h5>
        
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="visitNumber" name="visitNumber" readonly>
              <label>Visit Number</label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-floating mb-3">
              <input type="date" class="form-control" id="visitDate" name="visitDate" required>
              <label>Date of Visit</label>
              <button type="button" class="quick-fill-btn" onclick="setToday('visitDate')">Today</button>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="healthFacility" name="healthFacility" placeholder="Health Facility Name">
              <label>Health Facility</label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="totalAncVisits" name="totalAncVisits" readonly>
              <label>Total No. of ANC Visits (Previous)</label>
            </div>
          </div>
        </div>

        <!-- Main ANC Record Table -->
        <div class="table-responsive">
          <table class="table table-bordered anc-table">
            <thead>
              <tr>
                <th style="width: 8%">Weight (kg)</th>
                <th style="width: 12%">Blood Pressure (mmHg)</th>
                <th style="width: 10%">Gestational Age (weeks)</th>
                <th style="width: 10%">Fundal Height (cm)</th>
                <th style="width: 12%">Fetal Presentation</th>
                <th style="width: 10%">Fetal Heart Rate (bpm)</th>
                <th style="width: 12%">Urine Protein/Sugar</th>
                <th style="width: 8%">Deworming</th>
                <th style="width: 8%">TB Symptoms</th>
                <th style="width: 10%">Initial</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><input type="number" id="weight" name="weight" step="0.1" min="0" max="200"></td>
                <td><input type="text" id="bloodPressure" name="bloodPressure" placeholder="120/80"></td>
                <td><input type="number" id="gestationalAge" name="gestationalAge" step="0.1" min="0" max="42"></td>
                <td><input type="number" id="fundalHeight" name="fundalHeight" step="0.1" min="0" max="50"></td>
                <td>
                  <select id="fetalPresentation" name="fetalPresentation">
                    <option value="">Select</option>
                    <option value="Cephalic">Cephalic</option>
                    <option value="Breech">Breech</option>
                    <option value="Transverse">Transverse</option>
                    <option value="Oblique">Oblique</option>
                  </select>
                </td>
                <td><input type="number" id="fetalHeartRate" name="fetalHeartRate" min="100" max="180"></td>
                <td>
                  <select id="urineTest" name="urineTest">
                    <option value="">Select</option>
                    <option value="Negative/Negative">Negative/Negative</option>
                    <option value="Positive/Negative">Positive/Negative</option>
                    <option value="Negative/Positive">Negative/Positive</option>
                    <option value="Positive/Positive">Positive/Positive</option>
                  </select>
                </td>
                <td>
                  <select id="deworming" name="deworming">
                    <option value="">Select</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </td>
                <td>
                  <select id="tbSymptoms" name="tbSymptoms">
                    <option value="">Select</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </td>
                <td><input type="text" id="initial" name="initial" placeholder="Initial"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Second Table Row -->
        <div class="table-responsive">
          <table class="table table-bordered anc-table">
            <thead class="table-secondary">
              <tr>
                <th style="width: 15%">Iron & Folic Acid Tablet</th>
                <th style="width: 15%">Tetanus Toxoid/Tetanus Diphtheria</th>
                <th style="width: 20%">Treatment Given</th>
                <th style="width: 15%">Follow-up Date</th>
                <th style="width: 15%">Referral +/-</th>
                <th style="width: 20%">Midwife Signature</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <select id="ironFolicAcid" name="ironFolicAcid">
                    <option value="">Select</option>
                    <option value="Given">Given</option>
                    <option value="Not Given">Not Given</option>
                  </select>
                </td>
                <td>
                  <select id="tetanusToxoid" name="tetanusToxoid" onchange="calculateTTCompletion()">
                    <option value="">Select</option>
                    <option value="TT1">TT1</option>
                    <option value="TT2">TT2</option>
                    <option value="TT3">TT3</option>
                    <option value="TT4">TT4</option>
                    <option value="TT5">TT5</option>
                    <option value="TD1">TD1</option>
                    <option value="TD2">TD2</option>
                    <option value="Not Given">Not Given</option>
                  </select>
                </td>
                <td><textarea id="treatmentGiven" name="treatmentGiven" rows="2" placeholder="Treatment details" style="width: 100%; border: none; background: transparent; resize: none;"></textarea></td>
                <td>
                  <input type="date" id="followUpDate" name="followUpDate" style="width: 100%; border: none; background: transparent;">
                  <button type="button" class="quick-fill-btn mt-1" onclick="setNextMonth('followUpDate')">+4 weeks</button>
                </td>
                <td>
                  <select id="referral" name="referral">
                    <option value="">Select</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </td>
                <td>
                  <input type="text" id="midwifeName" name="midwifeName" placeholder="Midwife Name" style="width: 100%; border: none; background: transparent;">
                  <button type="button" class="quick-fill-btn mt-1" onclick="fillCurrentUser('midwifeName')">Me</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- TT/TD Completion Status -->
        <div class="row mt-3">
          <div class="col-md-6">
            <div class="form-floating mb-3">
              <select class="form-select" id="ttTdCompletion" name="ttTdCompletion" readonly>
                <option value="">Auto-calculated</option>
                <option value="Complete">Complete</option>
                <option value="Incomplete">Incomplete</option>
              </select>
              <label>TT/TD Completion Status</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating mb-3">
              <input type="number" class="form-control" id="ttTdDoses" name="ttTdDoses" readonly>
              <label>No. of Doses Received During Pregnancy</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Danger Signs Section -->
      <div class="form-section">
        <h5 class="section-title">
          <i class="fas fa-exclamation-triangle me-2"></i>Danger Signs Assessment
        </h5>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="form-floating">
              <select class="form-select" id="dangerSignsPresent" name="dangerSignsPresent" onchange="showDangerSignsDetails()">
                <option value="">Select</option>
                <option value="Yes">Danger Signs Present</option>
                <option value="No">No Danger Signs</option>
              </select>
              <label>Danger Signs!</label>
            </div>
          </div>
        </div>
        
        <div id="dangerSignsDetails" style="display: none;">
          <!-- Danger Signs in Pregnancy -->
          <div class="row">
            <div class="col-md-6">
              <div class="card danger-signs-card">
                <div class="card-header">
                  <h6 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Danger Signs in Pregnancy</h6>
                </div>
                <div class="card-body">
                  <h6 class="text-danger">If the symptoms below occur, please go urgently to health center:</h6>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_vaginal_bleeding" name="ds_vaginal_bleeding">
                    <label class="form-check-label" for="ds_vaginal_bleeding">Vaginal bleeding</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_convulsions" name="ds_convulsions">
                    <label class="form-check-label" for="ds_convulsions">Convulsions</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_loss_consciousness" name="ds_loss_consciousness">
                    <label class="form-check-label" for="ds_loss_consciousness">Loss of consciousness</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_severe_headache" name="ds_severe_headache">
                    <label class="form-check-label" for="ds_severe_headache">Severe headache</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_blurred_vision" name="ds_blurred_vision">
                    <label class="form-check-label" for="ds_blurred_vision">Blurred vision</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_vomiting" name="ds_vomiting">
                    <label class="form-check-label" for="ds_vomiting">Vomiting</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_severe_abdominal_pain" name="ds_severe_abdominal_pain">
                    <label class="form-check-label" for="ds_severe_abdominal_pain">Severe abdominal pain</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_fever" name="ds_fever">
                    <label class="form-check-label" for="ds_fever">Fever</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_fatigue" name="ds_fatigue">
                    <label class="form-check-label" for="ds_fatigue">Fatigue</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_fast_breathing" name="ds_fast_breathing">
                    <label class="form-check-label" for="ds_fast_breathing">Fast breathing</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_difficulty_breathing" name="ds_difficulty_breathing">
                    <label class="form-check-label" for="ds_difficulty_breathing">Difficulty in breathing</label>
                  </div>
                  
                  <h6 class="text-warning mt-3">If the symptoms below occur, please go to health center:</h6>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_puffiness" name="ds_puffiness">
                    <label class="form-check-label" for="ds_puffiness">Puffiness of face, hands and leg</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_oliguria" name="ds_oliguria">
                    <label class="form-check-label" for="ds_oliguria">Oliguria</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_excessive_vomiting" name="ds_excessive_vomiting">
                    <label class="form-check-label" for="ds_excessive_vomiting">Excessive vomiting</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_abdominal_pain" name="ds_abdominal_pain">
                    <label class="form-check-label" for="ds_abdominal_pain">Abdominal pain</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_reduced_fetal_movement" name="ds_reduced_fetal_movement">
                    <label class="form-check-label" for="ds_reduced_fetal_movement">Reduced/absent fetal movement</label>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card danger-signs-card severe">
                <div class="card-header">
                  <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Danger Signs During Labour</h6>
                </div>
                <div class="card-body">
                  <h6 class="text-danger">Mother:</h6>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_no_labour_pain" name="ds_no_labour_pain">
                    <label class="form-check-label" for="ds_no_labour_pain">No labor pain after 6 hours of membrane rupture</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_no_delivery" name="ds_no_delivery">
                    <label class="form-check-label" for="ds_no_delivery">No delivery until 12 hours of labour pain</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_postpartum_hemorrhage" name="ds_postpartum_hemorrhage">
                    <label class="form-check-label" for="ds_postpartum_hemorrhage">Postpartum hemorrhage after birth</label>
                  </div>
                  
                  <h6 class="text-danger mt-3">Baby:</h6>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_no_placenta" name="ds_no_placenta">
                    <label class="form-check-label" for="ds_no_placenta">No placenta delivery until 1 hour after child birth</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_very_small_baby" name="ds_very_small_baby">
                    <label class="form-check-label" for="ds_very_small_baby">Very small babies (&lt;1500gm/1.5kg)</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_difficulty_breathing_baby" name="ds_difficulty_breathing_baby">
                    <label class="form-check-label" for="ds_difficulty_breathing_baby">Difficulty in breathing</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Clinical Notes -->
      <div class="form-section">
        <h5 class="section-title">
          <i class="fas fa-notes-medical me-2"></i>Clinical Notes & Recommendations
        </h5>
        <div class="row">
          <div class="col-12">
            <div class="form-floating mb-3">
              <textarea class="form-control" id="clinicalNotes" name="clinicalNotes" style="height: 100px"></textarea>
              <label>Clinical Notes & Recommendations</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="form-section text-center">
        <button type="button" class="btn btn-outline-secondary me-3" onclick="generateAntenatalReport()">
          <i class="fas fa-file-pdf me-2"></i>Generate ANC Report
        </button>
        <button type="submit" class="btn btn-save me-3">
          <i class="fas fa-save me-2"></i>Save Visit Data
        </button>
        <button type="button" class="btn btn-outline-info" onclick="showVisitHistory()">
          <i class="fas fa-list me-2"></i>View All Visits
        </button>
      </div>
    </form>
  </div>

  <footer class="footer">
    <div class="container">
      <p class="mb-0">
        <i class="fas fa-heart me-2"></i>
        © 2025 Maternal & Child Health Care System — Designed for clinical excellence - Powered by Jhpiego Myanmar
      </p>
    </div>
  </footer>

  <script>
    let currentUser = null;
    let currentPatient = null;
    let patientId = null;
    let visitCount = 1;

    // Get patient ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    patientId = urlParams.get('patient');

    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
        loadPatientInfo();
      }
    });

    async function loadPatientInfo() {
      try {
        if (!patientId) {
          alert('Patient ID not found.');
          return;
        }

        // Load patient data
        const patientDoc = await firebase.firestore()
          .collection("patients")
          .doc(patientId)
          .get();

        if (!patientDoc.exists) {
          alert('Patient not found.');
          return;
        }

        currentPatient = patientDoc.data();
        
        // Populate patient banner
        const patientInfoGrid = document.getElementById('patientInfoGrid');
        patientInfoGrid.innerHTML = `
          <div class="info-item">
            <span class="info-label">Patient Name</span>
            <span class="info-value">${currentPatient.name || 'N/A'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Age</span>
            <span class="info-value">${currentPatient.age || 'N/A'} years</span>
          </div>
          <div class="info-item">
            <span class="info-label">Parity</span>
            <span class="info-value">${currentPatient.parity || 'N/A'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">LMP</span>
            <span class="info-value">${currentPatient.lmp ? new Date(currentPatient.lmp).toLocaleDateString() : 'N/A'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">EDD</span>
            <span class="info-value">${currentPatient.edd || 'N/A'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Township</span>
            <span class="info-value">${currentPatient.township || 'N/A'}</span>
          </div>
        `;

        // Load visit count and set visit number
        await loadVisitCount();
        document.getElementById('visitNumber').value = visitCount;
        document.getElementById('totalAncVisits').value = visitCount - 1;

        // Auto-calculate gestational age if LMP is available
        if (currentPatient.lmp) {
          calculateGestationalAge();
        }

      } catch (error) {
        console.error('Error loading patient info:', error);
        alert(`Error loading patient information: ${error.message}`);
      }
    }

    async function loadVisitCount() {
      try {
        const visitsSnapshot = await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .collection('antenatal_visits')
          .orderBy('visit_date', 'desc')
          .get();

        visitCount = visitsSnapshot.size + 1;
      } catch (error) {
        console.error('Error loading visit count:', error);
        visitCount = 1;
      }
    }

    function calculateGestationalAge() {
      if (currentPatient.lmp) {
        const lmpDate = new Date(currentPatient.lmp);
        const today = new Date();
        const diffTime = today - lmpDate;
        const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
        const diffDays = Math.floor((diffTime % (1000 * 60 * 60 * 24 * 7)) / (1000 * 60 * 60 * 24));
        const gestationalAge = diffWeeks + (diffDays / 7);
        document.getElementById('gestationalAge').value = gestationalAge.toFixed(1);
      }
    }

    function setToday(fieldId) {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById(fieldId).value = today;
    }

    function setNextMonth(fieldId) {
      const today = new Date();
      const nextMonth = new Date(today.getTime() + (28 * 24 * 60 * 60 * 1000)); // 4 weeks
      document.getElementById(fieldId).value = nextMonth.toISOString().split('T')[0];
    }

    function fillCurrentUser(fieldId) {
      if (currentUser) {
        document.getElementById(fieldId).value = currentUser.email || 'Current User';
      }
    }

    function showDangerSignsDetails() {
      const dangerSignsPresent = document.getElementById('dangerSignsPresent').value;
      const dangerSignsDetails = document.getElementById('dangerSignsDetails');
      
      if (dangerSignsPresent === 'Yes') {
        dangerSignsDetails.style.display = 'block';
      } else {
        dangerSignsDetails.style.display = 'none';
      }
    }

    function calculateTTCompletion() {
      const ttTdValue = document.getElementById('tetanusToxoid').value;
      const completionSelect = document.getElementById('ttTdCompletion');
      const dosesInput = document.getElementById('ttTdDoses');
      
      let doses = 0;
      let completion = 'Incomplete';
      
      if (ttTdValue.includes('TT') || ttTdValue.includes('TD')) {
        doses = parseInt(ttTdValue.slice(-1));
        if (doses >= 2) {
          completion = 'Complete';
        }
      }
      
      completionSelect.value = completion;
      dosesInput.value = doses;
    }

    async function saveVisitData(event) {
      event.preventDefault();
      
      try {
        // Collect all form data
        const visitData = {
          visitNumber: parseInt(document.getElementById('visitNumber').value),
          visitDate: document.getElementById('visitDate').value,
          healthFacility: document.getElementById('healthFacility').value,
          totalAncVisits: parseInt(document.getElementById('totalAncVisits').value),
          
          // Main table data
          weight: parseFloat(document.getElementById('weight').value) || null,
          bloodPressure: document.getElementById('bloodPressure').value || '',
          gestationalAge: parseFloat(document.getElementById('gestationalAge').value) || null,
          fundalHeight: parseFloat(document.getElementById('fundalHeight').value) || null,
          fetalPresentation: document.getElementById('fetalPresentation').value || '',
          fetalHeartRate: parseInt(document.getElementById('fetalHeartRate').value) || null,
          urineTest: document.getElementById('urineTest').value || '',
          deworming: document.getElementById('deworming').value || '',
          tbSymptoms: document.getElementById('tbSymptoms').value || '',
          initial: document.getElementById('initial').value || '',
          
          // Second table data
          ironFolicAcid: document.getElementById('ironFolicAcid').value || '',
          tetanusToxoid: document.getElementById('tetanusToxoid').value || '',
          treatmentGiven: document.getElementById('treatmentGiven').value || '',
          followUpDate: document.getElementById('followUpDate').value || '',
          referral: document.getElementById('referral').value || '',
          midwifeName: document.getElementById('midwifeName').value || '',
          
          // TT/TD completion
          ttTdCompletion: document.getElementById('ttTdCompletion').value || '',
          ttTdDoses: parseInt(document.getElementById('ttTdDoses').value) || 0,
          
          // Danger signs
          dangerSignsPresent: document.getElementById('dangerSignsPresent').value || '',
          dangerSigns: {
            vaginal_bleeding: document.getElementById('ds_vaginal_bleeding').checked,
            convulsions: document.getElementById('ds_convulsions').checked,
            loss_consciousness: document.getElementById('ds_loss_consciousness').checked,
            severe_headache: document.getElementById('ds_severe_headache').checked,
            blurred_vision: document.getElementById('ds_blurred_vision').checked,
            vomiting: document.getElementById('ds_vomiting').checked,
            severe_abdominal_pain: document.getElementById('ds_severe_abdominal_pain').checked,
            fever: document.getElementById('ds_fever').checked,
            fatigue: document.getElementById('ds_fatigue').checked,
            fast_breathing: document.getElementById('ds_fast_breathing').checked,
            difficulty_breathing: document.getElementById('ds_difficulty_breathing').checked,
            puffiness: document.getElementById('ds_puffiness').checked,
            oliguria: document.getElementById('ds_oliguria').checked,
            excessive_vomiting: document.getElementById('ds_excessive_vomiting').checked,
            abdominal_pain: document.getElementById('ds_abdominal_pain').checked,
            reduced_fetal_movement: document.getElementById('ds_reduced_fetal_movement').checked,
            no_labour_pain: document.getElementById('ds_no_labour_pain').checked,
            no_delivery: document.getElementById('ds_no_delivery').checked,
            postpartum_hemorrhage: document.getElementById('ds_postpartum_hemorrhage').checked,
            no_placenta: document.getElementById('ds_no_placenta').checked,
            very_small_baby: document.getElementById('ds_very_small_baby').checked,
            difficulty_breathing_baby: document.getElementById('ds_difficulty_breathing_baby').checked
          },
          
          clinicalNotes: document.getElementById('clinicalNotes').value || '',
          
          patientId: patientId,
          recordedBy: currentUser.uid,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Save visit data to Firestore
        const visitRef = await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .collection('antenatal_visits')
          .add(visitData);

        // Update patient's last antenatal visit
        await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .update({
            lastAntenatalVisit: visitData.timestamp,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });

        alert('Visit data saved successfully!');
        console.log('Visit data saved:', visitRef.id);

      } catch (error) {
        console.error('Error saving visit data:', error);
        alert(`Error saving visit data: ${error.message}`);
      }
    }

    function generateAntenatalReport() {
      window.open(`antenatal-report.html?patient=${patientId}`, '_blank');
    }

    function showVisitHistory() {
      // Redirect to antenatal care page to show history
      window.location.href = `antenatal-care.html`;
    }

    // Set today's date on page load
    window.addEventListener('load', function() {
      setToday('visitDate');
      setNextMonth('followUpDate');
    });
  </script>
</body>
</html>
