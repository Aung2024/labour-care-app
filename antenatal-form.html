<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ANC Visit Record - Maternal & Child Health Care System</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="js/firebase.js"></script>
  <script src="js/status-manager.js"></script>
  <style>
    :root {
      --primary-color: #10b981;
      --secondary-color: #059669;
      --accent-color: #34d399;
      --light-bg: #f0fdf4;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    body {
      background: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .header-section {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1.5rem 0;
      margin-bottom: 2rem;
    }

    .form-section {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
      border-left: 4px solid var(--primary-color);
    }

    .section-title {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 0.5rem;
    }

    .card-subtitle {
      font-size: 0.85rem;
      font-weight: 600;
      color: #2563eb;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin: 1.25rem 0 0.75rem;
    }

    .form-hint {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .patient-name-header {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .patient-name-header h4 {
      margin: 0;
      font-weight: 600;
    }

    .anc-table {
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 2rem;
    }

    .anc-table th {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      font-weight: 600;
      text-align: center;
      padding: 0.75rem 0.5rem;
      border: none;
      font-size: 0.9rem;
    }

    .anc-table td {
      padding: 0.75rem 0.5rem;
      border: 1px solid #e5e7eb;
      vertical-align: middle;
    }

    .anc-table input,
    .anc-table select {
      border: none;
      background: transparent;
      width: 100%;
      padding: 0.25rem;
      font-size: 0.9rem;
    }

    .anc-table input:focus,
    .anc-table select:focus {
      outline: 2px solid var(--primary-color);
      background: #f0fdf4;
      border-radius: 4px;
    }

    .danger-signs-card {
      border: 2px solid #f59e0b;
      border-radius: 10px;
      margin-bottom: 1rem;
    }

    .danger-signs-card .card-header {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      font-weight: 600;
    }

    .danger-signs-card.severe {
      border-color: #dc2626;
    }

    .danger-signs-card.severe .card-header {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
    }

    .form-check-input:checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .quick-fill-btn {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      margin-top: 0.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .quick-fill-btn:hover {
      background: var(--secondary-color);
      transform: translateY(-1px);
    }

    .btn-save {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .footer {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      color: #374151;
      text-align: center;
      padding: 2rem;
      margin-top: 2rem;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: var(--card-shadow);
    }

    /* Mobile-First ANC Form Styles */
    .mobile-anc-form {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .form-row-mobile {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group-mobile {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
    }

    .form-group-mobile:hover {
      border-color: var(--primary-color);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
    }

    .form-group-mobile .form-label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .form-group-mobile .form-control {
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 0.75rem;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .form-group-mobile .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
      outline: none;
    }

    @media (max-width: 768px) {
      .form-row-mobile {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
      
      .form-group-mobile {
        padding: 0.75rem;
      }
      
      .mobile-anc-form {
        padding: 1rem;
      }
      
      .patient-name-header {
        padding: 0.75rem 1rem;
      }
      
      .patient-name-header h4 {
        font-size: 1.1rem;
      }
    }

    @media (max-width: 480px) {
      .form-group-mobile .form-control {
        padding: 0.5rem;
        font-size: 0.9rem;
      }
      
      .form-group-mobile .form-label {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header-section">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="mb-2">
            <i class="fas fa-clipboard-list me-3"></i>
            ANC Visit Record
          </h1>
        </div>
        <div class="col-md-4 text-end">
          <div class="d-flex align-items-center justify-content-end gap-3">
            <a href="antenatal-care.html" class="btn btn-outline-light btn-sm">
              <i class="fas fa-arrow-left me-2"></i>Back to ANC
            </a>
            <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
              <i class="fas fa-sign-out-alt me-2"></i>Logout
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Patient Name Header -->
    <div class="patient-name-header">
      <h4 class="mb-0">
        <i class="fas fa-user me-2"></i>
        <span id="patientNameDisplay">Loading...</span>
      </h4>
    </div>

    <!-- ANC Visit Form -->
    <form id="ancForm" onsubmit="saveVisitData(event)">
      <!-- Visit Information -->
      <div class="form-section">
        <h5 class="section-title">
          <i class="fas fa-calendar-alt me-2"></i>Visit Information
        </h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Visit Number</label>
            <input type="number" class="form-control" id="visitNumber" name="visitNumber" readonly>
            <small class="form-hint">Auto-calculated from previous visits.</small>
          </div>
          <div class="col-md-6">
            <label class="form-label">Date of Visit</label>
            <div class="d-flex gap-2">
              <input type="date" class="form-control" id="visitDate" name="visitDate" required>
              <button type="button" class="quick-fill-btn" onclick="setToday('visitDate')">Today</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Card 1 · History Taking -->
      <div class="form-section">
        <h5 class="section-title">
          <i class="fas fa-clipboard-list me-2"></i>Card 1 · History Taking
        </h5>

        <div class="row g-3 align-items-end">
          <div class="col-lg-4 col-md-6">
            <label class="form-label d-block">LMP Status</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="lmpStatus" id="lmpKnown" value="known" checked onchange="toggleLMPFields()">
              <label class="form-check-label" for="lmpKnown">LMP Known</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="lmpStatus" id="lmpUnknown" value="unknown" onchange="toggleLMPFields()">
              <label class="form-check-label" for="lmpUnknown">LMP Unknown (Ultrasound)</label>
            </div>
          </div>
          <div class="col-lg-4 col-md-6">
            <label for="lmp" class="form-label">Last Menstrual Period (LMP)</label>
            <input type="date" id="lmp" name="lmp" class="form-control" onchange="calculateGestationalAgeAndEDD()">
          </div>
          <div class="col-lg-4 col-md-6">
            <label for="edd" class="form-label">Expected Due Date (EDD)</label>
            <input type="date" id="edd" name="edd" class="form-control" readonly>
            <small class="form-hint">Auto-calculated when LMP is known.</small>
          </div>
        </div>

        <div id="manualGAEDDSection" class="row g-3 mt-1" style="display: none;">
          <div class="col-md-6">
            <label for="manualGestationalAge" class="form-label">Gestational Age (weeks)</label>
            <input type="number" id="manualGestationalAge" name="manualGestationalAge" class="form-control" step="0.1" min="0" max="42" onchange="calculateEDDFromGA()">
          </div>
          <div class="col-md-6">
            <label for="manualEdd" class="form-label">Expected Due Date (EDD)</label>
            <input type="date" id="manualEdd" name="manualEdd" class="form-control">
          </div>
        </div>

        <div class="row g-3 mt-0">
          <div class="col-md-6">
            <label for="gestationalAgeDisplay" class="form-label">Gestational Age (calculated)</label>
            <input type="number" id="gestationalAgeDisplay" name="gestationalAgeDisplay" class="form-control" step="0.1" min="0" max="42" readonly>
            <small class="form-hint">Auto-calculated from LMP or manual entry.</small>
          </div>
          <div class="col-md-6">
            <label for="gestationalAgeManual" class="form-label">Gestational Age (manual override)</label>
            <input type="number" id="gestationalAgeManual" name="gestationalAgeManual" class="form-control" step="0.1" min="0" max="42" onchange="updateGestationalAge()">
            <small class="form-hint">Use when LMP is unknown.</small>
          </div>
        </div>

        <div class="mt-4">
          <label class="form-label">
            <i class="fas fa-calendar-plus"></i> Early ANC Visit
          </label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="earlyAncVisit" id="earlyAncVisit" value="yes">
            <label class="form-check-label" for="earlyAncVisit">Patient attended ANC before 14 weeks</label>
          </div>
        </div>

        <div class="card-subtitle"><i class="fas fa-history me-2"></i>Past Histories</div>
        <div class="row g-3">
          <div class="col-lg-4 col-md-6">
            <label class="form-label d-block">Status</label>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="pastHistoryStatus" id="pastHistoryStatusNAD" value="nad" checked>
              <label class="form-check-label" for="pastHistoryStatusNAD">NAD</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="pastHistoryStatus" id="pastHistoryStatusRisk" value="risk">
              <label class="form-check-label" for="pastHistoryStatusRisk">Risk +</label>
            </div>
          </div>
          <div class="col-lg-8 col-md-6">
            <label class="form-label" for="pastHistoryNotes">Details</label>
            <textarea class="form-control" id="pastHistoryNotes" name="pastHistoryNotes" rows="2" placeholder="Family / Medical / Surgical / OG / Drugs / Social history"></textarea>
            <small class="form-hint">Note type when Risk+ is selected.</small>
          </div>
        </div>
      </div>

      <!-- Card 2 · Physical Examination -->
      <div class="form-section">
        <h5 class="section-title">
          <i class="fas fa-stethoscope me-2"></i>Card 2 · Physical Examination
        </h5>

        <div class="card-subtitle"><i class="fas fa-female me-2"></i>Maternal Portion</div>
        <div class="row g-3">
          <div class="col-md-3 col-sm-6">
            <label for="weight" class="form-label">Weight (kg)</label>
            <input type="number" id="weight" name="weight" class="form-control" step="0.1" min="0" max="200">
          </div>
          <div class="col-md-3 col-sm-6">
            <label for="height" class="form-label">Height (cm)</label>
            <input type="number" id="height" name="height" class="form-control" step="0.1" min="0" max="220">
          </div>
          <div class="col-md-3 col-sm-6">
            <label for="bloodPressure" class="form-label">Blood Pressure (mmHg)</label>
            <input type="text" id="bloodPressure" name="bloodPressure" class="form-control" placeholder="120/80">
          </div>
          <div class="col-md-3 col-sm-6">
            <label for="pulseRate" class="form-label">Pulse Rate (bpm)</label>
            <input type="number" id="pulseRate" name="pulseRate" class="form-control" min="40" max="180">
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-md-3 col-sm-6">
            <label for="anemiaStatus" class="form-label">Anemia (inner eyelids)</label>
            <select id="anemiaStatus" name="anemiaStatus" class="form-control">
              <option value="">Select</option>
              <option value="normal">Normal</option>
              <option value="mild">Mild pallor</option>
              <option value="severe">Severe pallor</option>
              <option value="not_assessed">Not assessed</option>
            </select>
          </div>
          <div class="col-md-3 col-sm-6">
            <label for="jaundiceStatus" class="form-label">Jaundice (inner eyelids)</label>
            <select id="jaundiceStatus" name="jaundiceStatus" class="form-control">
              <option value="">Select</option>
              <option value="present">Present</option>
              <option value="absent">Absent</option>
              <option value="not_assessed">Not assessed</option>
            </select>
          </div>
          <div class="col-md-3 col-sm-6">
            <label for="breastExam" class="form-label">Breast Examination</label>
            <select id="breastExam" name="breastExam" class="form-control">
              <option value="">Select</option>
              <option value="normal">Normal</option>
              <option value="abnormal">Abnormal</option>
              <option value="not_done">Not done</option>
            </select>
          </div>
          <div class="col-md-3 col-sm-6">
            <label for="pittingEdema" class="form-label">Pitting Edema</label>
            <select id="pittingEdema" name="pittingEdema" class="form-control">
              <option value="">Select</option>
              <option value="present">Present</option>
              <option value="absent">Absent</option>
              <option value="not_assessed">Not assessed</option>
            </select>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-md-4 col-sm-6">
            <label for="tbSymptoms" class="form-label">Co-infection (TB/Malaria/Immuno-suppress symptoms)</label>
            <select id="tbSymptoms" name="tbSymptoms" class="form-control">
              <option value="">Select</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
          <div class="col-md-4 col-sm-6">
            <label for="coinfectionNotes" class="form-label">If yes, specify</label>
            <input type="text" id="coinfectionNotes" name="coinfectionNotes" class="form-control" placeholder="e.g. TB symptoms, malaria">
          </div>
          <div class="col-md-4 col-sm-12">
            <label for="urineTest" class="form-label">Urine Protein/Sugar</label>
            <select id="urineTest" name="urineTest" class="form-control">
              <option value="">Select</option>
              <option value="+/+">+/+</option>
              <option value="+/-">+/-</option>
              <option value="-/-">-/-</option>
              <option value="-/+">-/+</option>
            </select>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-md-4 col-sm-6">
            <label for="initial" class="form-label">Provider Initials</label>
            <input type="text" id="initial" name="initial" class="form-control" placeholder="Initials">
          </div>
        </div>

        <div class="card-subtitle"><i class="fas fa-baby me-2"></i>Fetal Portion</div>
        <div class="row g-3">
          <div class="col-md-4 col-sm-6">
            <label for="fundalHeight" class="form-label">Fundal Height (cm)</label>
            <input type="number" id="fundalHeight" name="fundalHeight" class="form-control" step="0.1" min="0" max="50">
          </div>
          <div class="col-md-4 col-sm-6">
            <label for="fetalPresentation" class="form-label">Fetal Presentation</label>
            <select id="fetalPresentation" name="fetalPresentation" class="form-control">
              <option value="">Select</option>
              <option value="Cephalic">Cephalic</option>
              <option value="Breech">Breech</option>
              <option value="Transverse">Transverse</option>
              <option value="Oblique">Oblique</option>
            </select>
          </div>
          <div class="col-md-4 col-sm-6">
            <label for="fetalHeartRate" class="form-label">FHS / Fetal Heart Rate (bpm)</label>
            <input type="number" id="fetalHeartRate" name="fetalHeartRate" class="form-control" min="100" max="180">
          </div>
        </div>

        <div class="card-subtitle"><i class="fas fa-exclamation-triangle me-2"></i>High Risk Assessment</div>
        <div class="mt-2">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="highRisk" id="highRiskNo" value="no" checked>
            <label class="form-check-label" for="highRiskNo">No - Standard risk pregnancy</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="highRisk" id="highRiskYes" value="yes">
            <label class="form-check-label" for="highRiskYes">Yes - High risk pregnancy</label>
          </div>
        </div>

        <div id="highRiskDetails" class="row g-3 mt-2" style="display: none;">
          <div class="col-md-12">
            <label class="form-label">High Risk Factors (select all that apply)</label>
            <div class="row">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="riskFactors" id="riskAge" value="maternal_age">
                  <label class="form-check-label" for="riskAge">Maternal age ≥35 years</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="riskFactors" id="riskDiabetes" value="diabetes">
                  <label class="form-check-label" for="riskDiabetes">Diabetes (pre-existing/gestational)</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="riskFactors" id="riskHypertension" value="hypertension">
                  <label class="form-check-label" for="riskHypertension">Hypertension</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="riskFactors" id="riskPrevious" value="previous_complications">
                  <label class="form-check-label" for="riskPrevious">Previous pregnancy complications</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="riskFactors" id="riskMultiple" value="multiple_pregnancy">
                  <label class="form-check-label" for="riskMultiple">Multiple pregnancy</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="riskFactors" id="riskPlacenta" value="placenta_issues">
                  <label class="form-check-label" for="riskPlacenta">Placenta previa/abruption</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="riskFactors" id="riskOther" value="other">
                  <label class="form-check-label" for="riskOther">Other medical conditions</label>
                </div>
              </div>
            </div>
            <label class="form-label mt-2" for="riskNotes">Additional Notes</label>
            <textarea name="riskNotes" id="riskNotes" class="form-control" rows="2" placeholder="Describe any other risk factors or concerns"></textarea>
          </div>
        </div>
      </div>

      <!-- Card 3 · Treatment Given -->
      <div class="form-section">
        <h5 class="section-title">
          <i class="fas fa-syringe me-2"></i>Card 3 · Treatment Given
        </h5>

        <div class="row g-3">
          <div class="col-md-4 col-sm-6">
            <label for="deworming" class="form-label">Deworming</label>
            <select id="deworming" name="deworming" class="form-control">
              <option value="">Select</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
          <div class="col-md-4 col-sm-6">
            <label for="ironFolicAcid" class="form-label">FeSO<sub>4</sub> / FA</label>
            <select id="ironFolicAcid" name="ironFolicAcid" class="form-control">
              <option value="">Select</option>
              <option value="Given">Given</option>
              <option value="Not Given">Not Given</option>
            </select>
          </div>
          <div class="col-md-4 col-sm-6">
            <label for="tetanusToxoid" class="form-label">TD / TT</label>
            <select id="tetanusToxoid" name="tetanusToxoid" class="form-control">
              <option value="">Select</option>
              <option value="TT1">TT1</option>
              <option value="TT2">TT2</option>
              <option value="TD1">TD1</option>
              <option value="TD2">TD2</option>
              <option value="Not Given">Not Given</option>
            </select>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-md-4 col-sm-6">
            <label for="vitaminB1" class="form-label">Vitamin B1</label>
            <select id="vitaminB1" name="vitaminB1" class="form-control">
              <option value="">Select</option>
              <option value="Given">Given</option>
              <option value="Not Given">Not Given</option>
            </select>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-12">
            <label for="treatmentGiven" class="form-label">Others / Treatment Details</label>
            <textarea id="treatmentGiven" name="treatmentGiven" class="form-control" rows="3" placeholder="Include additional treatments or comments"></textarea>
          </div>
        </div>
      </div>

      <!-- Card 4 · Clinical Notes & Next Steps -->
      <div class="form-section">
        <h5 class="section-title">
          <i class="fas fa-notes-medical me-2"></i>Card 4 · Clinical Notes & Next Steps
        </h5>

        <div class="row g-3">
          <div class="col-md-6">
            <label for="referral" class="form-label">Referral Status</label>
            <select id="referral" name="referral" class="form-control">
              <option value="">Select</option>
              <option value="Transfer">Transfer</option>
              <option value="Joint Care">Joint Care</option>
              <option value="No">No</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="nextVisitDate" class="form-label">Next Visit Date</label>
            <div class="d-flex gap-2">
              <input type="date" id="nextVisitDate" name="nextVisitDate" class="form-control">
              <button type="button" class="quick-fill-btn" onclick="setNextMonth('nextVisitDate')">+4 weeks</button>
            </div>
            <small class="form-hint">Use reminder tools to add this to your calendar.</small>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-12">
            <label for="clinicalNotes" class="form-label">Clinical Notes & Recommendations</label>
            <textarea class="form-control" id="clinicalNotes" name="clinicalNotes" rows="3"></textarea>
          </div>
        </div>

        <div class="alert alert-warning mt-4" role="alert">
          <i class="fas fa-info-circle me-2"></i>Use the danger signs checklist below to counsel the client and plan referrals.
        </div>

        <div id="dangerSignsDetails">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card danger-signs-card">
                <div class="card-header">
                  <h6 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Danger Signs in Pregnancy</h6>
                </div>
                <div class="card-body">
                  <h6 class="text-danger">If the symptoms below occur, please go urgently to health center:</h6>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_vaginal_bleeding" name="ds_vaginal_bleeding">
                    <label class="form-check-label" for="ds_vaginal_bleeding">Vaginal bleeding</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_convulsions" name="ds_convulsions">
                    <label class="form-check-label" for="ds_convulsions">Convulsions</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_loss_consciousness" name="ds_loss_consciousness">
                    <label class="form-check-label" for="ds_loss_consciousness">Loss of consciousness</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_severe_headache" name="ds_severe_headache">
                    <label class="form-check-label" for="ds_severe_headache">Severe headache</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_blurred_vision" name="ds_blurred_vision">
                    <label class="form-check-label" for="ds_blurred_vision">Blurred vision</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_vomiting" name="ds_vomiting">
                    <label class="form-check-label" for="ds_vomiting">Vomiting</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_severe_abdominal_pain" name="ds_severe_abdominal_pain">
                    <label class="form-check-label" for="ds_severe_abdominal_pain">Severe abdominal pain</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_fever" name="ds_fever">
                    <label class="form-check-label" for="ds_fever">Fever</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_fatigue" name="ds_fatigue">
                    <label class="form-check-label" for="ds_fatigue">Fatigue</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_fast_breathing" name="ds_fast_breathing">
                    <label class="form-check-label" for="ds_fast_breathing">Fast breathing</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_difficulty_breathing" name="ds_difficulty_breathing">
                    <label class="form-check-label" for="ds_difficulty_breathing">Difficulty in breathing</label>
                  </div>
                  
                  <h6 class="text-warning mt-3">If the symptoms below occur, please go to health center:</h6>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_puffiness" name="ds_puffiness">
                    <label class="form-check-label" for="ds_puffiness">Puffiness of face, hands and leg</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_oliguria" name="ds_oliguria">
                    <label class="form-check-label" for="ds_oliguria">Oliguria</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_excessive_vomiting" name="ds_excessive_vomiting">
                    <label class="form-check-label" for="ds_excessive_vomiting">Excessive vomiting</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_abdominal_pain" name="ds_abdominal_pain">
                    <label class="form-check-label" for="ds_abdominal_pain">Abdominal pain</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ds_reduced_fetal_movement" name="ds_reduced_fetal_movement">
                    <label class="form-check-label" for="ds_reduced_fetal_movement">Reduced/absent fetal movement</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="form-section text-center">
        <button type="submit" class="btn btn-save">
          <i class="fas fa-save me-2"></i>Save Visit Data
        </button>
      </div>
    </form>
  </div>

  <footer class="footer">
    <div class="container">
      <p class="mb-0">
        <i class="fas fa-heart me-2"></i>
        © 2025 Maternal & Child Health Care System — Designed for clinical excellence - Powered by Jhpiego Myanmar
      </p>
    </div>
  </footer>

  <script>
    let currentUser = null;
    let currentPatient = null;
    let patientId = null;
    let visitCount = 1;
    

    // Get patient ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    patientId = urlParams.get('patient');

    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
        loadPatientInfo();
      }
    });

    async function loadPatientInfo() {
      try {
        if (!patientId) {
          alert('Patient ID not found.');
          return;
        }

        // Load patient data
        const patientDoc = await firebase.firestore()
          .collection("patients")
          .doc(patientId)
          .get();

        if (!patientDoc.exists) {
          alert('Patient not found.');
          return;
        }

        currentPatient = patientDoc.data();
        
        // Populate patient name in header
        document.getElementById('patientNameDisplay').textContent = currentPatient.name || 'Unknown Patient';

        // Load visit count and set visit number
        await loadVisitCount();
        document.getElementById('visitNumber').value = visitCount;
        

        // Auto-calculate gestational age if LMP is available
        if (currentPatient.lmp) {
          calculateGestationalAge();
        }

        // Load existing visit data if available
        await loadExistingVisitData();

      } catch (error) {
        console.error('Error loading patient info:', error);
        alert(`Error loading patient information: ${error.message}`);
      }
    }

    async function loadVisitCount() {
      try {
        console.log('Loading visit count for patient:', patientId);
        
        const visitsSnapshot = await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .collection('antenatal_visits')
          .orderBy('visitDate', 'desc')
          .get();
        
        console.log('Found visits:', visitsSnapshot.size);
        console.log('Visit documents:', visitsSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() })));
        
        visitCount = visitsSnapshot.size + 1;
        console.log('Calculated visit count:', visitCount);
      } catch (error) {
        console.error('Error loading visit count:', error);
        visitCount = 1;
      }
    }

    async function loadExistingVisitData() {
      try {
        console.log('Loading existing visit data for patient:', patientId);
        
        // Load the most recent visit data to populate the form
        const visitsSnapshot = await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .collection('antenatal_visits')
          .orderBy('visitDate', 'desc')
          .limit(1)
          .get();
        
        console.log('Found existing visits:', visitsSnapshot.size);
        
        if (!visitsSnapshot.empty) {
          const latestVisit = visitsSnapshot.docs[0].data();
          
          // Populate form fields with latest visit data
          if (latestVisit.weight) document.getElementById('weight').value = latestVisit.weight;
          if (latestVisit.height) document.getElementById('height').value = latestVisit.height;
          if (latestVisit.bloodPressure) document.getElementById('bloodPressure').value = latestVisit.bloodPressure;
          if (latestVisit.pulseRate) document.getElementById('pulseRate').value = latestVisit.pulseRate;
          if (latestVisit.anemiaStatus) document.getElementById('anemiaStatus').value = latestVisit.anemiaStatus;
          if (latestVisit.jaundiceStatus) document.getElementById('jaundiceStatus').value = latestVisit.jaundiceStatus;
          if (latestVisit.breastExam) document.getElementById('breastExam').value = latestVisit.breastExam;
          if (latestVisit.pittingEdema) document.getElementById('pittingEdema').value = latestVisit.pittingEdema;
          if (latestVisit.tbSymptoms) document.getElementById('tbSymptoms').value = latestVisit.tbSymptoms;
          if (latestVisit.coinfectionNotes) document.getElementById('coinfectionNotes').value = latestVisit.coinfectionNotes;
          if (latestVisit.urineTest) document.getElementById('urineTest').value = latestVisit.urineTest;
          if (latestVisit.gestationalAge) document.getElementById('gestationalAgeDisplay').value = latestVisit.gestationalAge;
          if (latestVisit.fundalHeight) document.getElementById('fundalHeight').value = latestVisit.fundalHeight;
          if (latestVisit.fetalHeartRate) document.getElementById('fetalHeartRate').value = latestVisit.fetalHeartRate;
          if (latestVisit.deworming) document.getElementById('deworming').value = latestVisit.deworming;
          if (latestVisit.ironFolicAcid) document.getElementById('ironFolicAcid').value = latestVisit.ironFolicAcid;
          if (latestVisit.tetanusToxoid) document.getElementById('tetanusToxoid').value = latestVisit.tetanusToxoid;
          if (latestVisit.vitaminB1) document.getElementById('vitaminB1').value = latestVisit.vitaminB1;
          if (latestVisit.treatmentGiven) document.getElementById('treatmentGiven').value = latestVisit.treatmentGiven;
          if (latestVisit.initial) document.getElementById('initial').value = latestVisit.initial;
          if (latestVisit.referral) document.getElementById('referral').value = latestVisit.referral;
          if (latestVisit.nextVisitDate) document.getElementById('nextVisitDate').value = latestVisit.nextVisitDate;
          if (latestVisit.clinicalNotes) document.getElementById('clinicalNotes').value = latestVisit.clinicalNotes;
          
          // Load ANC information from latest visit
          if (latestVisit.lmp) document.getElementById('lmp').value = latestVisit.lmp;
          if (latestVisit.edd) document.getElementById('edd').value = latestVisit.edd;
          
          // Load LMP status
          if (latestVisit.lmpStatus) {
            document.getElementById(latestVisit.lmpStatus === 'known' ? 'lmpKnown' : 'lmpUnknown').checked = true;
            toggleLMPFields();
          }
          
          // Load manual GA/EDD if LMP unknown
          if (latestVisit.manualGestationalAge) document.getElementById('manualGestationalAge').value = latestVisit.manualGestationalAge;
          if (latestVisit.manualEdd) document.getElementById('manualEdd').value = latestVisit.manualEdd;
          
          // Load danger signs checkboxes
          if (latestVisit.dangerSigns) {
            Object.keys(latestVisit.dangerSigns).forEach(sign => {
              const checkbox = document.getElementById(`ds_${sign}`);
              if (checkbox) {
                checkbox.checked = latestVisit.dangerSigns[sign];
              }
            });
          }
          
          // Load Early ANC Visit checkbox
          if (latestVisit.early_anc_visit) {
            document.getElementById('earlyAncVisit').checked = latestVisit.early_anc_visit;
          }
          
          if (latestVisit.pastHistoryStatus) {
            const historyRadio = document.querySelector(`input[name="pastHistoryStatus"][value="${latestVisit.pastHistoryStatus}"]`);
            if (historyRadio) {
              historyRadio.checked = true;
            }
          }
          if (latestVisit.pastHistoryNotes) {
            document.getElementById('pastHistoryNotes').value = latestVisit.pastHistoryNotes;
          }
          
          // Load High Risk Assessment
          if (latestVisit.high_risk) {
            const highRiskRadio = document.querySelector(`input[name="highRisk"][value="${latestVisit.high_risk}"]`);
            if (highRiskRadio) {
              highRiskRadio.checked = true;
              toggleHighRiskDetails(); // Show/hide risk factors section
            }
          }
          
          // Load High Risk Factors checkboxes
          if (latestVisit.risk_factors && Array.isArray(latestVisit.risk_factors)) {
            latestVisit.risk_factors.forEach(riskFactor => {
              const checkbox = document.querySelector(`input[name="riskFactors"][value="${riskFactor}"]`);
              if (checkbox) {
                checkbox.checked = true;
              }
            });
          }
          
          // Load Risk Notes
          if (latestVisit.risk_notes) {
            document.getElementById('riskNotes').value = latestVisit.risk_notes;
          }
        }
      } catch (error) {
        console.error('Error loading existing visit data:', error);
      }
    }

    function calculateGestationalAge() {
      if (currentPatient.lmp) {
        const lmpDate = new Date(currentPatient.lmp);
        const today = new Date();
        const diffTime = today - lmpDate;
        const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
        const diffDays = Math.floor((diffTime % (1000 * 60 * 60 * 24 * 7)) / (1000 * 60 * 60 * 24));
        const gestationalAge = diffWeeks + (diffDays / 7);
        document.getElementById('gestationalAgeDisplay').value = gestationalAge.toFixed(1);
      }
    }

    function updateGestationalAge() {
      const manualGA = document.getElementById('gestationalAgeManual').value;
      const displayGA = document.getElementById('gestationalAgeDisplay');
      
      if (manualGA) {
        displayGA.value = manualGA;
      } else {
        // Recalculate from LMP if available
        if (currentPatient && currentPatient.lmp) {
          calculateGestationalAge();
        }
      }
    }

    function calculateGestationalAgeAndEDD() {
      const lmpInput = document.getElementById('lmp');
      const eddInput = document.getElementById('edd');
      
      if (lmpInput.value) {
        const lmpDate = new Date(lmpInput.value);
        
        // Calculate EDD (LMP + 280 days)
        const eddDate = new Date(lmpDate.getTime() + (280 * 24 * 60 * 60 * 1000));
        eddInput.value = eddDate.toISOString().split('T')[0];
        
        // Update gestational age display
        calculateGestationalAgeFromLMP(lmpInput.value);
      }
    }

    function calculateGestationalAgeFromLMP(lmpValue) {
      if (lmpValue) {
        const lmpDate = new Date(lmpValue);
        const today = new Date();
        const diffTime = today - lmpDate;
        const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
        const diffDays = Math.floor((diffTime % (1000 * 60 * 60 * 24 * 7)) / (1000 * 60 * 60 * 24));
        const gestationalAge = diffWeeks + (diffDays / 7);
        document.getElementById('gestationalAgeDisplay').value = gestationalAge.toFixed(1);
      }
    }

    function calculateEDDFromGA() {
      const gaInput = document.getElementById('manualGestationalAge');
      const eddInput = document.getElementById('manualEdd');
      
      if (gaInput.value) {
        const today = new Date();
        const weeksFromNow = 40 - parseFloat(gaInput.value); // Assuming 40 weeks full term
        const eddDate = new Date(today.getTime() + (weeksFromNow * 7 * 24 * 60 * 60 * 1000));
        eddInput.value = eddDate.toISOString().split('T')[0];
      }
    }

    function toggleLMPFields() {
      const lmpKnown = document.getElementById('lmpKnown').checked;
      const lmpUnknown = document.getElementById('lmpUnknown').checked;
      const manualSection = document.getElementById('manualGAEDDSection');
      const lmpInput = document.getElementById('lmp');
      const eddInput = document.getElementById('edd');
      
      if (lmpUnknown) {
        manualSection.style.display = 'block';
        lmpInput.disabled = true;
        lmpInput.value = '';
        eddInput.value = '';
      } else {
        manualSection.style.display = 'none';
        lmpInput.disabled = false;
      }
    }

    function setToday(fieldId) {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById(fieldId).value = today;
    }
    
    // Toggle high risk details
    function toggleHighRiskDetails() {
      const highRisk = document.querySelector('input[name="highRisk"]:checked');
      const highRiskDetails = document.getElementById('highRiskDetails');
      
      if (highRisk && highRisk.value === 'yes') {
        highRiskDetails.style.display = 'block';
      } else {
        highRiskDetails.style.display = 'none';
      }
    }
    
    // Initialize high risk toggle on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listeners to high risk radios
      document.querySelectorAll('input[name="highRisk"]').forEach(radio => {
        radio.addEventListener('change', toggleHighRiskDetails);
      });
    });

    function setNextMonth(fieldId) {
      const today = new Date();
      const nextMonth = new Date(today.getTime() + (28 * 24 * 60 * 60 * 1000)); // 4 weeks
      document.getElementById(fieldId).value = nextMonth.toISOString().split('T')[0];
    }

    function fillCurrentUser(fieldId) {
      if (currentUser) {
        document.getElementById(fieldId).value = currentUser.email || 'Current User';
      }
    }

    function checkDangerSignsPresent() {
      // Check all danger sign checkboxes
      const dangerSigns = [
        'ds_vaginal_bleeding', 'ds_convulsions', 'ds_loss_consciousness', 'ds_severe_headache',
        'ds_blurred_vision', 'ds_vomiting', 'ds_severe_abdominal_pain', 'ds_fever', 'ds_fatigue',
        'ds_fast_breathing', 'ds_difficulty_breathing', 'ds_puffiness', 'ds_oliguria', 
        'ds_excessive_vomiting', 'ds_abdominal_pain', 'ds_reduced_fetal_movement',
        'ds_no_labour_pain', 'ds_no_delivery', 'ds_postpartum_hemorrhage', 'ds_no_placenta',
        'ds_very_small_baby', 'ds_difficulty_breathing_baby'
      ];
      
      for (let checkboxId of dangerSigns) {
        if (document.getElementById(checkboxId) && document.getElementById(checkboxId).checked) {
          return 'Yes';
        }
      }
      return 'No';
    }


    async function saveVisitData(event) {
      event.preventDefault();
      
      // Prevent double submission
      const submitButton = event.target.querySelector('button[type="submit"]');
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
      }
      
      try {
        // Collect all form data
        const visitData = {
          visitNumber: visitCount, // Use the calculated visit count instead of form input
          visitDate: document.getElementById('visitDate').value,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(), // Add timestamp for proper ordering
          healthFacility: currentPatient.township || 'Unknown Facility',
          totalAncVisits: visitCount - 1, // Previous visits count
          
          // Main table data
          weight: parseFloat(document.getElementById('weight').value) || null,
          height: parseFloat(document.getElementById('height').value) || null,
          bloodPressure: document.getElementById('bloodPressure').value || '',
          pulseRate: parseInt(document.getElementById('pulseRate').value) || null,
          anemiaStatus: document.getElementById('anemiaStatus').value || '',
          jaundiceStatus: document.getElementById('jaundiceStatus').value || '',
          breastExam: document.getElementById('breastExam').value || '',
          pittingEdema: document.getElementById('pittingEdema').value || '',
          gestationalAge: parseFloat(document.getElementById('gestationalAgeDisplay').value) || null,
          fundalHeight: parseFloat(document.getElementById('fundalHeight').value) || null,
          fetalPresentation: document.getElementById('fetalPresentation').value || '',
          fetalHeartRate: parseInt(document.getElementById('fetalHeartRate').value) || null,
          urineTest: document.getElementById('urineTest').value || '',
          deworming: document.getElementById('deworming').value || '',
          tbSymptoms: document.getElementById('tbSymptoms').value || '',
          coinfectionNotes: document.getElementById('coinfectionNotes').value || '',
          initial: document.getElementById('initial').value || '',
          
          // Second table data
          ironFolicAcid: document.getElementById('ironFolicAcid').value || '',
          tetanusToxoid: document.getElementById('tetanusToxoid').value || '',
          vitaminB1: document.getElementById('vitaminB1').value || '',
          treatmentGiven: document.getElementById('treatmentGiven').value || '',
          referral: document.getElementById('referral').value || '',
          nextVisitDate: document.getElementById('nextVisitDate').value || null,
          
          // Danger signs - determine if any are present
          dangerSignsPresent: checkDangerSignsPresent(),
          dangerSigns: {
            vaginal_bleeding: document.getElementById('ds_vaginal_bleeding').checked,
            convulsions: document.getElementById('ds_convulsions').checked,
            loss_consciousness: document.getElementById('ds_loss_consciousness').checked,
            severe_headache: document.getElementById('ds_severe_headache').checked,
            blurred_vision: document.getElementById('ds_blurred_vision').checked,
            vomiting: document.getElementById('ds_vomiting').checked,
            severe_abdominal_pain: document.getElementById('ds_severe_abdominal_pain').checked,
            fever: document.getElementById('ds_fever').checked,
            fatigue: document.getElementById('ds_fatigue').checked,
            fast_breathing: document.getElementById('ds_fast_breathing').checked,
            difficulty_breathing: document.getElementById('ds_difficulty_breathing').checked,
            puffiness: document.getElementById('ds_puffiness').checked,
            oliguria: document.getElementById('ds_oliguria').checked,
            excessive_vomiting: document.getElementById('ds_excessive_vomiting').checked,
            abdominal_pain: document.getElementById('ds_abdominal_pain').checked,
            reduced_fetal_movement: document.getElementById('ds_reduced_fetal_movement').checked
          },
          
          clinicalNotes: document.getElementById('clinicalNotes').value || '',
          
          // ANC Information
          lmp: document.getElementById('lmp').value || null,
          edd: document.getElementById('edd').value || null,
          lmpStatus: document.querySelector('input[name="lmpStatus"]:checked').value || 'known',
          manualGestationalAge: parseFloat(document.getElementById('manualGestationalAge').value) || null,
          manualEdd: document.getElementById('manualEdd').value || null,
          
          // Early ANC Visit
          early_anc_visit: document.getElementById('earlyAncVisit').checked,
          
          // Past history
          pastHistoryStatus: document.querySelector('input[name="pastHistoryStatus"]:checked') ? document.querySelector('input[name="pastHistoryStatus"]:checked').value : 'nad',
          pastHistoryNotes: document.getElementById('pastHistoryNotes').value || '',
          
          // High risk pregnancy assessment
          high_risk: document.querySelector('input[name="highRisk"]:checked') ? document.querySelector('input[name="highRisk"]:checked').value : 'no',
          risk_factors: Array.from(document.querySelectorAll('input[name="riskFactors"]:checked')).map(cb => cb.value),
          risk_notes: document.getElementById('riskNotes').value || null,
          
          patientId: patientId,
          recordedBy: currentUser.uid,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        console.log('Saving visit data:', visitData);
        
        // Save visit data to Firestore
        const visitRef = await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .collection('antenatal_visits')
          .add(visitData);

        console.log('Visit saved with ID:', visitRef.id);

        // Update patient's last antenatal visit
        await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .update({
            lastAntenatalVisit: firebase.firestore.FieldValue.serverTimestamp(),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });

        console.log('Patient record updated');

        // Update patient status to Antenatal Care (if first visit)
        const statusUpdated = await StatusManager.checkAndUpdateToAntenatalCare(patientId);
        if (statusUpdated) {
          console.log('✅ Patient status updated to Antenatal Care');
        }

        // Refresh the visit count to ensure accuracy
        await loadVisitCount();
        console.log('Visit count refreshed:', visitCount);

        alert('Visit data saved successfully!');
        console.log('Visit data saved:', visitRef.id);
        
        // Redirect to antenatal care main page
        window.location.href = 'antenatal-care.html';

      } catch (error) {
        console.error('Error saving visit data:', error);
        alert(`Error saving visit data: ${error.message}`);
        
        // Reset button state on error
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.innerHTML = '<i class="fas fa-save me-2"></i>Save Visit Data';
        }
      }
    }

    function generateAntenatalReport() {
      window.open(`antenatal-report.html?patient=${patientId}`, '_blank');
    }

    function showVisitHistory() {
      // Redirect to antenatal care page to show history
      window.location.href = `antenatal-care.html`;
    }

    // Set today's date on page load
    window.addEventListener('load', function() {
      setToday('visitDate');
    });
  </script>
</body>
</html>
