<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Postpartum Care Form - Maternal & Child Health Care System</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="js/firebase.js"></script>
  <style>
    :root {
      --primary-color: #7c3aed;
      --secondary-color: #6d28d9;
      --accent-color: #a78bfa;
      --light-bg: #faf5ff;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    body {
      background: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .header-section {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
    }

    .form-container {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      box-shadow: var(--card-shadow);
      margin-bottom: 2rem;
    }

    .form-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #fafafa;
    }

    .form-section h4 {
      color: var(--primary-color);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .danger-signs-section {
      background: #fef2f2;
      border: 1px solid #fecaca;
    }

    .danger-signs-section h4 {
      color: #dc2626;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .form-check {
      background: white;
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      transition: all 0.2s ease;
    }

    .form-check:hover {
      background: #f8fafc;
      border-color: var(--primary-color);
    }

    .form-check-input:checked + .form-check-label {
      color: var(--primary-color);
      font-weight: 600;
    }

    .btn-primary-action {
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      border: none;
      color: white;
      font-weight: 600;
      padding: 0.75rem 2rem;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .btn-primary-action:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(124, 58, 237, 0.3);
      color: white;
    }

    .btn-secondary-action {
      background: #6b7280;
      border: none;
      color: white;
      font-weight: 600;
      padding: 0.75rem 2rem;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .btn-secondary-action:hover {
      background: #4b5563;
      color: white;
    }

    .patient-info {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 1px solid #0ea5e9;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
    }

    .patient-info h5 {
      color: #0369a1;
      margin-bottom: 0.5rem;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.25rem;
    }

    .info-label {
      font-weight: 600;
      color: #374151;
    }

    .info-value {
      color: #6b7280;
    }

    .loading-spinner {
      text-align: center;
      padding: 3rem;
      color: var(--primary-color);
    }

    @media (max-width: 768px) {
      .header-section {
        padding: 1.5rem 0;
      }
      
      .form-container {
        padding: 1rem;
        margin: 0 1rem 1rem;
      }
      
      .checkbox-group {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header Section -->
  <div class="header-section">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="mb-2">
            <i class="fas fa-hands-holding-child me-3"></i>
            Postpartum Care Form
          </h1>
          <p class="mb-0 opacity-75">
            Record postpartum visit and health monitoring data
          </p>
        </div>
        <div class="col-md-4 text-md-end">
          <a href="postpartum-care.html" class="btn btn-outline-light">
            <i class="fas fa-arrow-left me-2"></i>Back to Postpartum Care
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Patient Information -->
    <div class="patient-info" id="patientInfo">
      <h5><i class="fas fa-user me-2"></i>Patient Information</h5>
      <div class="info-row">
        <span class="info-label">Name:</span>
        <span class="info-value" id="patientName">Loading...</span>
      </div>
      <div class="info-row">
        <span class="info-label">Age:</span>
        <span class="info-value" id="patientAge">Loading...</span>
      </div>
      <div class="info-row">
        <span class="info-label">Phone:</span>
        <span class="info-value" id="patientPhone">Loading...</span>
      </div>
      <div class="info-row">
        <span class="info-label">Delivery Date:</span>
        <span class="info-value" id="deliveryDate">Not recorded</span>
      </div>
    </div>

    <!-- Postpartum Care Form -->
    <div class="form-container">
      <form id="postpartumForm">
        <!-- Visit Information -->
        <div class="form-section">
          <h4><i class="fas fa-calendar-alt"></i>Visit Information</h4>
          <div class="row">
            <div class="col-md-6">
              <label for="visitDate" class="form-label">Visit Date *</label>
              <input type="date" class="form-control" id="visitDate" required>
            </div>
            <div class="col-md-6">
              <label for="visitNumber" class="form-label">Visit Number</label>
              <input type="number" class="form-control" id="visitNumber" min="1" readonly>
            </div>
          </div>
        </div>

        <!-- Vital Signs -->
        <div class="form-section">
          <h4><i class="fas fa-heartbeat"></i>Vital Signs</h4>
          <div class="row">
            <div class="col-md-3">
              <label for="temperature" class="form-label">Temperature (°C)</label>
              <input type="number" class="form-control" id="temperature" step="0.1" min="35" max="42">
            </div>
            <div class="col-md-3">
              <label for="systolicBP" class="form-label">Systolic BP</label>
              <input type="number" class="form-control" id="systolicBP" min="70" max="200">
            </div>
            <div class="col-md-3">
              <label for="diastolicBP" class="form-label">Diastolic BP</label>
              <input type="number" class="form-control" id="diastolicBP" min="40" max="120">
            </div>
            <div class="col-md-3">
              <label for="hemoglobin" class="form-label">Hemoglobin (g/dl)</label>
              <input type="number" class="form-control" id="hemoglobin" step="0.1" min="5" max="20">
            </div>
          </div>
        </div>

        <!-- Physical Examination -->
        <div class="form-section">
          <h4><i class="fas fa-stethoscope"></i>Physical Examination</h4>
          <div class="row">
            <div class="col-md-6">
              <label for="nippleCondition" class="form-label">Nipple Condition</label>
              <select class="form-control" id="nippleCondition">
                <option value="">Select condition</option>
                <option value="Normal">Normal</option>
                <option value="Cracked">Cracked</option>
                <option value="Inverted">Inverted</option>
                <option value="Flat">Flat</option>
                <option value="Inflamed">Inflamed</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="uterusInvolution" class="form-label">Uterus Involution</label>
              <select class="form-control" id="uterusInvolution">
                <option value="">Select status</option>
                <option value="Normal">Normal</option>
                <option value="Delayed">Delayed</option>
                <option value="Subinvolution">Subinvolution</option>
              </select>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-6">
              <label for="vaginalBleeding" class="form-label">Vaginal Bleeding (Lochia)</label>
              <select class="form-control" id="vaginalBleeding">
                <option value="">Select type</option>
                <option value="Rubra">Rubra (Red)</option>
                <option value="Serosa">Serosa (Pinkish)</option>
                <option value="Alba">Alba (White/Yellow)</option>
                <option value="Heavy bleeding">Heavy bleeding</option>
                <option value="No bleeding">No bleeding</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="episiotomyHealing" class="form-label">Episiotomy Wound Healing</label>
              <select class="form-control" id="episiotomyHealing">
                <option value="">Select status</option>
                <option value="Healing well">Healing well</option>
                <option value="Infected">Infected</option>
                <option value="Dehiscence">Dehiscence</option>
                <option value="No episiotomy">No episiotomy</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Medications & Supplements -->
        <div class="form-section">
          <h4><i class="fas fa-pills"></i>Medications & Supplements</h4>
          <div class="row">
            <div class="col-md-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="vitaminB1">
                <label class="form-check-label" for="vitaminB1">
                  Vitamin B1
                </label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="vitaminA">
                <label class="form-check-label" for="vitaminA">
                  Vitamin A
                </label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="ironFolic">
                <label class="form-check-label" for="ironFolic">
                  Iron & Folic Acid
                </label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="contraception">
                <label class="form-check-label" for="contraception">
                  Contraception (45 days after birth)
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Danger Signs -->
        <div class="form-section danger-signs-section">
          <h4><i class="fas fa-exclamation-triangle"></i>Danger Signs Assessment</h4>
          <p class="text-danger mb-3">
            <strong>If any of these symptoms occur, please seek urgent medical attention:</strong>
          </p>
          
          <div class="checkbox-group">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="heavyBleeding">
              <label class="form-check-label" for="heavyBleeding">
                Heavy vaginal bleeding
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="severeHeadache">
              <label class="form-check-label" for="severeHeadache">
                Severe headache, Blurred vision
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="convulsions">
              <label class="form-check-label" for="convulsions">
                Convulsions
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="breathingProblems">
              <label class="form-check-label" for="breathingProblems">
                Fast breathing, Difficulty in breathing
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="feverFatigue">
              <label class="form-check-label" for="feverFatigue">
                Fever, Fatigue
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="breastEngorgement">
              <label class="form-check-label" for="breastEngorgement">
                Breast engorgement/ Nipple inflammation, redness, tenderness
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="urinaryProblems">
              <label class="form-check-label" for="urinaryProblems">
                Difficulty in micturition, Urinary incontinence
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="woundInflammation">
              <label class="form-check-label" for="woundInflammation">
                Episiotomy wound inflammation and tenderness
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="foulDischarge">
              <label class="form-check-label" for="foulDischarge">
                Foul smelling vaginal discharge
              </label>
            </div>
          </div>
        </div>

        <!-- Additional Information -->
        <div class="form-section">
          <h4><i class="fas fa-notes-medical"></i>Additional Information</h4>
          <div class="row">
            <div class="col-md-6">
              <label for="otherSymptoms" class="form-label">Other Symptoms</label>
              <textarea class="form-control" id="otherSymptoms" rows="3" placeholder="Describe any other symptoms or concerns..."></textarea>
            </div>
            <div class="col-md-6">
              <label for="treatment" class="form-label">Treatment Given</label>
              <textarea class="form-control" id="treatment" rows="3" placeholder="Describe treatment provided..."></textarea>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-6">
              <label for="referralGiven" class="form-label">Referral Given</label>
              <select class="form-control" id="referralGiven">
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="referralReason" class="form-label">Reason for Referral</label>
              <input type="text" class="form-control" id="referralReason" placeholder="Reason for referral...">
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-12">
              <label for="clinicalNotes" class="form-label">Clinical Notes</label>
              <textarea class="form-control" id="clinicalNotes" rows="4" placeholder="Additional clinical observations and recommendations..."></textarea>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="text-center mt-4">
          <button type="button" class="btn btn-secondary-action me-3" onclick="window.location.href='postpartum-care.html'">
            <i class="fas fa-times me-2"></i>Cancel
          </button>
          <button type="submit" class="btn btn-primary-action">
            <i class="fas fa-save me-2"></i>Save Postpartum Visit
          </button>
        </div>
      </form>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading patient data...</p>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <p><strong>Maternal & Child Health Care System</strong></p>
      <p>Designed for clinical excellence - Powered by Jhpiego Myanmar</p>
      <p class="copyright">© 2025 Maternal & Child Health Care System — Designed for clinical excellence - Powered by Jhpiego Myanmar</p>
    </div>
  </footer>

  <script>
    let currentUser = null;
    let currentPatient = null;

    // Initialize Firebase and load data
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await loadPatientFromURL();
      } else {
        window.location.href = 'login.html';
      }
    });

    // Load patient from URL parameter
    async function loadPatientFromURL() {
      try {
        showLoading(true);
        
        const urlParams = new URLSearchParams(window.location.search);
        const patientId = urlParams.get('patient');
        
        if (!patientId) {
          alert('No patient ID provided');
          window.location.href = 'postpartum-care.html';
          return;
        }
        
        const db = firebase.firestore();
        const patientDoc = await db.collection('patients').doc(patientId).get();
        
        if (!patientDoc.exists) {
          alert('Patient not found');
          window.location.href = 'postpartum-care.html';
          return;
        }
        
        currentPatient = { id: patientDoc.id, ...patientDoc.data() };
        
        // Populate patient information
        document.getElementById('patientName').textContent = currentPatient.name || 'Unknown';
        document.getElementById('patientAge').textContent = currentPatient.age || 'N/A';
        document.getElementById('patientPhone').textContent = currentPatient.phone || 'Not provided';
        
        if (currentPatient.deliveryDate) {
          document.getElementById('deliveryDate').textContent = new Date(currentPatient.deliveryDate).toLocaleDateString();
        }
        
        // Set default visit date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('visitDate').value = today;
        
        // Calculate visit number
        await calculateVisitNumber();
        
        showLoading(false);
        
      } catch (error) {
        console.error('Error loading patient:', error);
        alert('Error loading patient data: ' + error.message);
        showLoading(false);
      }
    }

    // Calculate visit number
    async function calculateVisitNumber() {
      try {
        const db = firebase.firestore();
        const visitsSnapshot = await db.collection('patients')
          .doc(currentPatient.id)
          .collection('postpartum_visits')
          .orderBy('visitDate', 'asc')
          .get();
        
        const visitNumber = visitsSnapshot.size + 1;
        document.getElementById('visitNumber').value = visitNumber;
        
      } catch (error) {
        console.error('Error calculating visit number:', error);
        document.getElementById('visitNumber').value = 1;
      }
    }

    // Show/hide loading spinner
    function showLoading(show) {
      const spinner = document.getElementById('loadingSpinner');
      const container = document.querySelector('.container');
      
      if (show) {
        spinner.style.display = 'block';
        container.style.display = 'none';
      } else {
        spinner.style.display = 'none';
        container.style.display = 'block';
      }
    }

    // Form submission
    document.getElementById('postpartumForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const formData = {
          visitDate: document.getElementById('visitDate').value,
          visitNumber: parseInt(document.getElementById('visitNumber').value),
          temperature: document.getElementById('temperature').value || null,
          systolicBP: document.getElementById('systolicBP').value || null,
          diastolicBP: document.getElementById('diastolicBP').value || null,
          hemoglobin: document.getElementById('hemoglobin').value || null,
          nippleCondition: document.getElementById('nippleCondition').value,
          uterusInvolution: document.getElementById('uterusInvolution').value,
          vaginalBleeding: document.getElementById('vaginalBleeding').value,
          episiotomyHealing: document.getElementById('episiotomyHealing').value,
          vitaminB1: document.getElementById('vitaminB1').checked,
          vitaminA: document.getElementById('vitaminA').checked,
          ironFolic: document.getElementById('ironFolic').checked,
          contraception: document.getElementById('contraception').checked,
          dangerSigns: {
            heavyBleeding: document.getElementById('heavyBleeding').checked,
            severeHeadache: document.getElementById('severeHeadache').checked,
            convulsions: document.getElementById('convulsions').checked,
            breathingProblems: document.getElementById('breathingProblems').checked,
            feverFatigue: document.getElementById('feverFatigue').checked,
            breastEngorgement: document.getElementById('breastEngorgement').checked,
            urinaryProblems: document.getElementById('urinaryProblems').checked,
            woundInflammation: document.getElementById('woundInflammation').checked,
            foulDischarge: document.getElementById('foulDischarge').checked
          },
          otherSymptoms: document.getElementById('otherSymptoms').value,
          treatment: document.getElementById('treatment').value,
          referralGiven: document.getElementById('referralGiven').value,
          referralReason: document.getElementById('referralReason').value,
          clinicalNotes: document.getElementById('clinicalNotes').value,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: currentUser.uid
        };
        
        const db = firebase.firestore();
        await db.collection('patients')
          .doc(currentPatient.id)
          .collection('postpartum_visits')
          .add(formData);
        
        // Update patient's last postpartum visit date
        await db.collection('patients')
          .doc(currentPatient.id)
          .update({
            lastPostpartumVisit: firebase.firestore.FieldValue.serverTimestamp()
          });
        
        alert('Postpartum visit saved successfully!');
        window.location.href = 'postpartum-care.html';
        
      } catch (error) {
        console.error('Error saving postpartum visit:', error);
        alert('Error saving postpartum visit: ' + error.message);
      }
    });
  </script>
</body>
</html>
