<!DOCTYPE html>
<html>
<head>
  <title>User Registration</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/style.css" />
</head>
<body class="container my-5">
  <div class="text-center mb-4">
    <h2>üë©‚Äç‚öïÔ∏è Register New Account</h2>
    <p class="text-muted">Join the Labour Care Guide system</p>
  </div>
  <form id="registerForm" class="mb-3">
    <div class="mb-3">
      <label for="name" class="form-label">Full Name</label>
      <input name="name" id="name" class="form-control" placeholder="Enter your full name" required>
    </div>
    <div class="mb-3">
      <label for="role" class="form-label">Professional Role</label>
      <select name="role" id="role" class="form-control" required>
        <option value="">Select your professional role</option>
        <option value="Midwife">üë©‚Äç‚öïÔ∏è Midwife</option>
        <option value="TMO">üè• TMO (Township Medical Officer)</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="regionSelect" class="form-label">Region (State/Division)</label>
      <select name="region" id="regionSelect" class="form-control" required onchange="updateTownships()">
        <option value="">Select your region first</option>
        <option value="Yangon Region">üèôÔ∏è Yangon Region</option>
        <option value="Mandalay Region">üèõÔ∏è Mandalay Region</option>
        <option value="Bago Region (East)">üèòÔ∏è Bago Region (East)</option>
        <option value="Bago Region (West)">üèòÔ∏è Bago Region (West)</option>
        <option value="Ayeyarwady Region">üåä Ayeyarwady Region</option>
        <option value="Sagaing Region">üèîÔ∏è Sagaing Region</option>
        <option value="Magway Region">üèúÔ∏è Magway Region</option>
        <option value="Tanintharyi Region">üèñÔ∏è Tanintharyi Region</option>
        <option value="Kachin State">üèîÔ∏è Kachin State</option>
        <option value="Kayah State">üèûÔ∏è Kayah State</option>
        <option value="Kayin State">üå≤ Kayin State</option>
        <option value="Chin State">‚õ∞Ô∏è Chin State</option>
        <option value="Mon State">üè∫ Mon State</option>
        <option value="Rakhine State">üåä Rakhine State</option>
        <option value="Shan State (South)">üèîÔ∏è Shan State (South)</option>
        <option value="Shan State (North)">üèîÔ∏è Shan State (North)</option>
        <option value="Shan State (East)">üèîÔ∏è Shan State (East)</option>
        <option value="Nay Pyi Taw">üèõÔ∏è Nay Pyi Taw</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="townshipSelect" class="form-label">Township</label>
      <select name="township" id="townshipSelect" class="form-control" required disabled>
        <option value="">Please select a region first</option>
      </select>
      <div class="form-text">Township options will appear after selecting a region</div>
    </div>
    <div class="mb-3">
      <label for="clinic" class="form-label">Clinic/Hospital Name</label>
      <input name="clinic" id="clinic" class="form-control" placeholder="Enter clinic or hospital name (optional)">
    </div>
    <div class="mb-3">
      <label for="phone" class="form-label">Phone Number</label>
      <input name="phone" id="phone" class="form-control" placeholder="Enter your phone number" required>
    </div>
    <div class="mb-3">
      <label for="email" class="form-label">Email Address</label>
      <input name="email" id="email" type="email" class="form-control" placeholder="Enter your email address (optional)">
    </div>
    <div class="mb-3">
      <label for="password" class="form-label">Password</label>
      <input name="password" id="password" type="password" class="form-control" placeholder="Create a strong password" required>
    </div>
    <div class="mb-3">
      <label for="confirm" class="form-label">Confirm Password</label>
      <input name="confirm" id="confirm" type="password" class="form-control" placeholder="Confirm your password" required>
    </div>
    <button type="submit" class="btn btn-primary w-100 btn-lg">
      <i class="fas fa-user-plus"></i> Create Account
    </button>
  </form>
  
  <div id="registerMsg"></div>
  
  <div class="text-center mt-4">
    <p class="text-muted">Already have an account?</p>
    <a href="login.html" class="btn btn-outline-secondary">
      <i class="fas fa-sign-in-alt"></i> Back to Login
    </a>
  </div>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  <script>
    // Myanmar administrative data (exact match from JSON file)
    const myanmarRegions = {
      "Ayeyarwady Region": [
        "Bogale",
        "Danubyu",
        "Dedaye",
        "Einme",
        "Hinthada",
        "Ingapu",
        "Kangyidaunt",
        "Kyaiklat",
        "Kyangin",
        "Kyaunggon",
        "Kyonpyaw",
        "Labutta",
        "Lemyethna",
        "Maubin",
        "Mawlamyinegyun",
        "Myanaung",
        "Ngapudaw",
        "Nyaungdon",
        "Pantanaw",
        "Pathein",
        "Pyapon",
        "Thabaung",
        "Wakema",
        "Yegyi",
        "Zalun",
        "Yedashe"
      ],
      "Bago Region (East)": [
        "Bago",
        "Daik-U",
        "Htantabin",
        "Kawa",
        "Kyaukkyi",
        "Kyauktaga",
        "Nyaunglebin",
        "Oktwin",
        "Phyu",
        "Shwegyin",
        "Taungoo",
        "Thanatpin",
        "Waw",
        "Yedashe"
      ],
      "Bago Region (West)": [
        "Letpadan",
        "Minhla",
        "Monyo",
        "Nattalin",
        "Okpho",
        "Paukkaung",
        "Paungde",
        "Pyay",
        "Shwedaung",
        "Tharrawaddy",
        "Zigon"
      ],
      "Chin State": [
        "Falam",
        "Hakha",
        "Htantlang",
        "Kanpetlet",
        "Matupi",
        "Mindat",
        "Paletwa",
        "Tedim",
        "Tonzang"
      ],
      "Kachin State": [
        "Bhamo",
        "Chipwi",
        "Hpakant",
        "Hsawlaw",
        "Injangyang",
        "Kawnglanghpu",
        "Machanbaw",
        "Mansi",
        "Mogaung",
        "Mohnyin",
        "Momauk",
        "Myitkyina",
        "Puta-O",
        "Shwegu",
        "Sumprabum",
        "Tsawlaw",
        "Waingmaw"
      ],
      "Kayah State": [
        "Bawlake",
        "Demoso",
        "Hpasawng",
        "Hpruso",
        "Loikaw",
        "Mese",
        "Shadaw"
      ],
      "Kayin State": [
        "Hlaingbwe",
        "Hpa-An",
        "Hpapun",
        "Kawkareik",
        "Kyainseikgyi",
        "Myawaddy",
        "Thandaunggyi"
      ],
      "Magway Region": [
        "Aunglan",
        "Chauk",
        "Gangaw",
        "Kamma",
        "Minbu",
        "Mindon",
        "Minhla",
        "Myaing",
        "Myothit",
        "Natmauk",
        "Ngape",
        "Pakokku",
        "Pauk",
        "Pwintbyu",
        "Salin",
        "Saw",
        "Seikphyu",
        "Sidoktaya",
        "Sinbaungwe",
        "Taungdwingyi",
        "Tilin",
        "Yenangyaung",
        "Yesagyo"
      ],
      "Mandalay Region": [
        "Amarapura",
        "Aungmyaythazan",
        "Chanayethazan",
        "Chanmyathazi",
        "Kyaukpadaung",
        "Kyaukse",
        "Madaya",
        "Mahaaungmyay",
        "Mahlaing",
        "Meiktila",
        "Mogoke",
        "Myingyan",
        "Myittha",
        "Natogyi",
        "Ngazun",
        "Nyaung-U",
        "Patheingyi",
        "Pyigyidagun",
        "Pyinoolwin",
        "Singu",
        "Sintgaing",
        "Tada-U",
        "Taungtha",
        "Thazi",
        "Wundwin",
        "Yamethin"
      ],
      "Mon State": [
        "Bilin",
        "Chaungzon",
        "Kyaikmaraw",
        "Kyaikto",
        "Mawlamyine",
        "Mudon",
        "Paung",
        "Thanbyuzayat",
        "Thaton",
        "Ye"
      ],
      "Nay Pyi Taw": [
        "Dekkhinathiri",
        "Lewe",
        "Ottarathiri",
        "Pobbathiri",
        "Pyinmana",
        "Tatkon",
        "Zabuthiri"
      ],
      "Rakhine State": [
        "Ann",
        "Buthidaung",
        "Gwa",
        "Kyaukpyu",
        "Kyauktaw",
        "Maungdaw",
        "Minbya",
        "Mrauk-U",
        "Munaung",
        "Myebon",
        "Pauktaw",
        "Ponnagyun",
        "Ramree",
        "Rathedaung",
        "Sittwe",
        "Thandwe",
        "Toungup"
      ],
      "Sagaing Region": [
        "Ayadaw",
        "Banmauk",
        "Budalin",
        "Chaung-U",
        "Hkamti",
        "Homalin",
        "Indaw",
        "Kale",
        "Kani",
        "Katha",
        "Kawlin",
        "Khin-U",
        "Kyunhla",
        "Lahe",
        "Lay Shi",
        "Mawlaik",
        "Mingin",
        "Monywa",
        "Nanyun",
        "Pale",
        "Paungbyin",
        "Pinlebu",
        "Salingyi",
        "Shwebo",
        "Tabayin",
        "Tamu",
        "Taze",
        "Tigyaing",
        "Wetlet",
        "Wuntho",
        "Ye-U",
        "Yinmabin"
      ],
      "Shan State (South)": [
        "Hopong",
        "Hsiseng",
        "Kalaw",
        "Kunhing",
        "Kyaukme",
        "Kyethi",
        "Lawksawk",
        "Loilen",
        "Mawkmai",
        "Monghsu",
        "Mongkaung",
        "Mongnai",
        "Nansang",
        "Nawnghkio",
        "Pekon",
        "Pinlaung",
        "Taunggyi"
      ],
      "Shan State (North)": [
        "Hseni",
        "Kutkai",
        "Lashio",
        "Laukkaing",
        "Mabein",
        "Manton",
        "Mongmao",
        "Mongmit",
        "Mongyai",
        "Muse",
        "Namkham",
        "Namhsan",
        "Namtu",
        "Nawnghkio",
        "Pangsang",
        "Pangwaun",
        "Tangyan"
      ],
      "Shan State (East)": [
        "Kengtung",
        "Monghpyak",
        "Monghsat",
        "Mongkhet",
        "Mongla",
        "Mongping",
        "Mongton",
        "Mongyang",
        "Tachileik"
      ],
      "Tanintharyi Region": [
        "Bokpyin",
        "Dawei",
        "Kawthaung",
        "Kyunsu",
        "Launglon",
        "Myeik",
        "Palaw",
        "Tanintharyi",
        "Thayetchaung",
        "Yebyu"
      ],
      "Yangon Region": [
        "Ahlone",
        "Bahan",
        "Botataung",
        "Cocokyun",
        "Dagon",
        "Dagon Myothit (East)",
        "Dagon Myothit (North)",
        "Dagon Myothit (Seikkan)",
        "Dagon Myothit (South)",
        "Dala",
        "Dawbon",
        "Hlaing",
        "Hlaingthaya (East)",
        "Hlaingthaya (West)",
        "Insein",
        "Kamaryut",
        "Kyauktada",
        "Kyauktan",
        "Kyeemyindaing",
        "Lanmadaw",
        "Latha",
        "Mayangone",
        "Mingaladon",
        "Mingalar Taung Nyunt",
        "North Okkalapa",
        "Pabedan",
        "Pazundaung",
        "Sanchaung",
        "Seikkyi Khanaungto",
        "Shwepyithar",
        "South Okkalapa",
        "Tamwe",
        "Thingangyun",
        "Thaketa",
        "Yankin"
      ]
    };

    // Function to update townships based on selected region
    function updateTownships() {
      const regionSelect = document.getElementById('regionSelect');
      const townshipSelect = document.getElementById('townshipSelect');
      const selectedRegion = regionSelect.value;
      
      // Clear and disable township select
      townshipSelect.innerHTML = '<option value="">Select Township</option>';
      townshipSelect.disabled = true;
      
      if (selectedRegion && myanmarRegions[selectedRegion]) {
        // Enable township select and populate options
        townshipSelect.disabled = false;
        
        // Add township options
        myanmarRegions[selectedRegion].forEach(township => {
          const option = document.createElement('option');
          option.value = township;
          option.textContent = township;
          townshipSelect.appendChild(option);
        });
      }
    }

    const form = document.getElementById("registerForm");
    form.onsubmit = async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form));
      
      // Validate required fields
      if (!data.region || !data.township) {
        document.getElementById("registerMsg").innerHTML = '<div class="alert alert-danger">Please select both region and township.</div>';
        return;
      }
      
              // Additional validation for township
        if (!data.township || data.township.trim() === '') {
          document.getElementById("registerMsg").innerHTML = '<div class="alert alert-danger">Township cannot be empty.</div>';
          return;
        }
        
        // Ensure township is a valid string
        if (typeof data.township !== 'string') {
          document.getElementById("registerMsg").innerHTML = '<div class="alert alert-danger">Township must be a valid string.</div>';
          return;
        }
        
        console.log('Registration data:', data);
        console.log('Township to save:', data.township);
        console.log('Township validation passed');
      
      if (data.password !== data.confirm) {
        document.getElementById("registerMsg").innerHTML = '<div class="alert alert-danger">Passwords do not match.</div>';
        return;
      }
      try {
        // On registration form submit
        const cred = await firebase.auth().createUserWithEmailAndPassword(data.email, data.password);
        const userData = {
          name: data.name,
          role: data.role,
          region: data.region,
          township: data.township,
          clinic: data.clinic || "",
          phone: data.phone,
          email: data.email,
          approved: false, // Use 'approved' field to match existing login logic
          createdAt: new Date().toISOString()
        };
        
        console.log('Saving user data to Firestore:', userData);
        console.log('Township being saved:', userData.township);
        
        await firebase.firestore().collection("users").doc(cred.user.uid).set(userData);
        
        console.log('User data saved successfully');
        console.log('Verifying saved data...');
        
        // Verify the data was saved correctly
        const savedDoc = await firebase.firestore().collection("users").doc(cred.user.uid).get();
        if (savedDoc.exists) {
          const savedData = savedDoc.data();
          console.log('Verified saved data:', savedData);
          console.log('Verified township:', savedData.township);
        }
        await firebase.auth().signOut();
        window.location.href = "registration-success.html";
      } catch (err) {
        document.getElementById("registerMsg").innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
      }
    };
    
    // Debug function to check form data (can be called from console)
    window.debugFormData = function() {
      const form = document.getElementById("registerForm");
      const data = Object.fromEntries(new FormData(form));
      console.log('=== DEBUG FORM DATA ===');
      console.log('Form data:', data);
      console.log('Region:', data.region);
      console.log('Township:', data.township);
      console.log('Township type:', typeof data.township);
      console.log('Township length:', data.township ? data.township.length : 'N/A');
      console.log('Township trimmed:', data.township ? data.township.trim() : 'N/A');
      console.log('=== END DEBUG ===');
    };
  </script>
</body>
</html>