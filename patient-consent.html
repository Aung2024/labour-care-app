<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#10b981">
  <title>Patient Consent - Maternal & Child Health Care System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <style>
    :root {
      --primary-color: #10b981;
      --secondary-color: #059669;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #f0fdf4;
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    .consent-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 3rem 2rem;
    }

    .consent-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 2px solid #e5e7eb;
    }

    .consent-header h1 {
      color: var(--primary-color);
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .patient-info-box {
      background: #ecfdf5;
      border-left: 4px solid var(--primary-color);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
    }

    .consent-content {
      max-height: 50vh;
      overflow-y: auto;
      padding: 1.5rem;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 2rem;
      line-height: 1.8;
    }

    .consent-content h3 {
      color: var(--primary-color);
      font-size: 1.3rem;
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
    }

    .consent-content ul {
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }

    .consent-content li {
      margin-bottom: 0.5rem;
    }

    .consent-method {
      margin-bottom: 2rem;
    }

    .consent-method h4 {
      color: var(--text-primary);
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    .method-option {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .method-option:hover {
      border-color: var(--primary-color);
      background: rgba(16, 185, 129, 0.05);
    }

    .method-option.selected {
      border-color: var(--primary-color);
      background: rgba(16, 185, 129, 0.1);
    }

    .method-option input[type="radio"] {
      margin-right: 0.75rem;
    }

    .signature-pad-container {
      display: none;
      margin-top: 1rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 8px;
    }

    .signature-pad-container.active {
      display: block;
    }

    canvas {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      width: 100%;
      max-width: 500px;
      touch-action: none;
    }

    .signature-controls {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    .btn-signature {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: white;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-signature:hover {
      background: #f3f4f6;
    }

    .patient-name-input {
      margin-top: 1rem;
    }

    .patient-name-input input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
    }

    .verbal-consent-note {
      display: none;
      margin-top: 1rem;
      padding: 1rem;
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      border-radius: 8px;
    }

    .verbal-consent-note.active {
      display: block;
    }

    .consent-actions {
      text-align: center;
      padding-top: 1.5rem;
      border-top: 1px solid #e5e7eb;
    }

    .btn-consent {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border: none;
      padding: 1rem 3rem;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s;
      margin: 0.5rem;
    }

    .btn-consent:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }

    .btn-consent:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-refuse {
      background: transparent;
      color: #dc2626;
      border: 2px solid #dc2626;
      padding: 1rem 3rem;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s;
      margin: 0.5rem;
    }

    .btn-refuse:hover {
      background: #dc2626;
      color: white;
    }

    .language-switcher {
      text-align: center;
      margin-bottom: 1rem;
    }

    .language-btn {
      background: white;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      padding: 0.5rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      margin: 0 0.5rem;
      transition: all 0.2s;
    }

    .language-btn.active {
      background: var(--primary-color);
      color: white;
    }

    @media (max-width: 768px) {
      .consent-container {
        padding: 2rem 1.5rem;
      }

      .consent-content {
        max-height: 40vh;
      }
    }
  </style>
</head>
<body>
  <div class="consent-container">
    <div class="language-switcher">
      <button class="language-btn active" data-lang="en" onclick="switchLanguage('en')">
        <span>ðŸ‡¬ðŸ‡§</span> English
      </button>
      <button class="language-btn" data-lang="mm" onclick="switchLanguage('mm')">
        <span>ðŸ‡²ðŸ‡²</span> á€™á€¼á€”á€ºá€™á€¬
      </button>
    </div>

    <div class="consent-header">
      <h1>
        <span class="lang-text" data-en="Patient Consent" data-mm="á€œá€°á€”á€¬ á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€º">Patient Consent</span>
      </h1>
      <p style="color: var(--text-secondary);">
        <span class="lang-text" data-en="Please read this to the patient and obtain consent" data-mm="á€€á€»á€±á€¸á€‡á€°á€¸á€•á€¼á€¯á á€¤á€¡á€›á€¬á€€á€­á€¯ á€œá€°á€”á€¬á€‘á€¶ á€–á€á€¼á€•á€¼á€®á€¸ á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€º á€›á€šá€°á€•á€«">Please read this to the patient and obtain consent</span>
      </p>
    </div>

    <div class="patient-info-box" id="patientInfoBox" style="display: none;">
      <h4 style="margin-bottom: 0.5rem;">
        <span class="lang-text" data-en="Patient Information" data-mm="á€œá€°á€”á€¬ á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸">Patient Information</span>
      </h4>
      <p id="patientInfoText" style="margin: 0;"></p>
    </div>

    <div class="consent-content">
      <h3>
        <span class="lang-text" data-en="Purpose of this system" data-mm="á€¤á€…á€”á€…á€ºá á€›á€Šá€ºá€›á€½á€šá€ºá€á€»á€€á€º">Purpose of this system</span>
      </h3>
      <p>
        <span class="lang-text" data-en="Your health information will be recorded in a secure digital system to support quality of care during pregnancy, labour, and after birth." data-mm="á€žá€„á€·á€ºá€€á€»á€”á€ºá€¸á€™á€¬á€›á€±á€¸ á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€€á€­á€¯á€šá€ºá€á€”á€ºá€†á€±á€¬á€„á€ºá€…á€‰á€ºáŠ á€€á€œá€±á€¸á€™á€½á€±á€¸á€–á€½á€¬á€¸á€…á€‰á€ºá€”á€¾á€„á€·á€º á€™á€½á€±á€¸á€–á€½á€¬á€¸á€•á€¼á€®á€¸á€”á€±á€¬á€€á€º á€…á€±á€¬á€„á€·á€ºá€›á€¾á€±á€¬á€€á€ºá€™á€¾á€¯ á€¡á€›á€Šá€ºá€¡á€žá€½á€±á€¸á€€á€­á€¯ á€•á€¶á€·á€•á€­á€¯á€¸á€›á€”á€º á€œá€¯á€¶á€á€¼á€¯á€¶á€žá€±á€¬ á€’á€…á€ºá€‚á€»á€…á€ºá€á€šá€º á€…á€”á€…á€ºá€á€½á€„á€º á€™á€¾á€á€ºá€á€™á€ºá€¸á€á€„á€ºá€‘á€¬á€¸á€•á€«á€™á€Šá€ºá‹">Your health information will be recorded in a secure digital system to support quality of care during pregnancy, labour, and after birth.</span>
      </p>

      <h3>
        <span class="lang-text" data-en="What information is collected" data-mm="á€™á€Šá€ºá€žá€Šá€·á€º á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸ á€…á€¯á€†á€±á€¬á€„á€ºá€¸á€žá€Šá€º">What information is collected</span>
      </h3>
      <p>
        <span class="lang-text" data-en="Only information needed for your clinical care will be recorded." data-mm="á€žá€„á€·á€ºá€†á€±á€¸á€™á€¾á€á€ºá€á€™á€ºá€¸ á€…á€±á€¬á€„á€·á€ºá€›á€¾á€±á€¬á€€á€ºá€™á€¾á€¯á€¡á€á€½á€€á€º á€œá€­á€¯á€¡á€•á€ºá€žá€±á€¬ á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯á€žá€¬ á€™á€¾á€á€ºá€á€™á€ºá€¸á€á€„á€ºá€•á€«á€™á€Šá€ºá‹">Only information needed for your clinical care will be recorded.</span>
      </p>

      <h3>
        <span class="lang-text" data-en="Privacy and Confidentiality" data-mm="á€€á€­á€¯á€šá€ºá€›á€±á€¸á€œá€¯á€¶á€á€¼á€¯á€¶á€™á€¾á€¯á€”á€¾á€„á€·á€º á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€™á€¾á€¯">Privacy and Confidentiality</span>
      </h3>
      <ul>
        <li>
          <span class="lang-text" data-en="Your information is kept confidential and used only for your care or approved health reporting" data-mm="á€žá€„á€·á€ºá€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€‘á€¬á€¸á€•á€¼á€®á€¸ á€žá€„á€·á€ºá€…á€±á€¬á€„á€·á€ºá€›á€¾á€±á€¬á€€á€ºá€™á€¾á€¯ á€žá€­á€¯á€·á€™á€Ÿá€¯á€á€º á€á€½á€„á€·á€ºá€•á€¼á€¯á€‘á€¬á€¸á€žá€±á€¬ á€€á€»á€”á€ºá€¸á€™á€¬á€›á€±á€¸ á€¡á€…á€®á€›á€„á€ºá€á€¶á€…á€¬á€¡á€á€½á€€á€º á€žá€¬á€œá€»á€¾á€„á€º á€¡á€žá€¯á€¶á€¸á€•á€¼á€¯á€•á€«á€žá€Šá€º">Your information is kept confidential and used only for your care or approved health reporting</span>
        </li>
        <li>
          <span class="lang-text" data-en="Your data is protected according to international standards and Myanmar's cybersecurity regulations" data-mm="á€žá€„á€·á€ºá€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€¡á€•á€¼á€Šá€ºá€•á€¼á€Šá€ºá€†á€­á€¯á€„á€ºá€›á€¬ á€…á€¶á€”á€¾á€¯á€”á€ºá€¸á€™á€»á€¬á€¸á€”á€¾á€„á€·á€º á€™á€¼á€”á€ºá€™á€¬á€”á€­á€¯á€„á€ºá€„á€¶á á€†á€­á€¯á€€á€ºá€˜á€¬á€œá€¯á€¶á€á€¼á€¯á€¶á€™á€¾á€¯ á€…á€Šá€ºá€¸á€™á€»á€‰á€ºá€¸á€™á€»á€¬á€¸á€”á€¾á€„á€·á€ºá€¡á€Šá€® á€€á€¬á€€á€½á€šá€ºá€‘á€¬á€¸á€•á€«á€žá€Šá€º">Your data is protected according to international standards and Myanmar's cybersecurity regulations</span>
        </li>
      </ul>

      <h3>
        <span class="lang-text" data-en="Your Rights" data-mm="á€žá€„á€·á€ºá€¡á€á€½á€„á€·á€ºá€¡á€›á€±á€¸á€™á€»á€¬á€¸">Your Rights</span>
      </h3>
      <ul>
        <li>
          <span class="lang-text" data-en="You may ask questions anytime" data-mm="á€žá€„á€ºá€žá€Šá€º á€™á€Šá€ºá€žá€Šá€·á€ºá€¡á€á€»á€­á€”á€ºá€á€½á€„á€ºá€™á€†á€­á€¯ á€™á€±á€¸á€á€½á€”á€ºá€¸á€™á€»á€¬á€¸ á€™á€±á€¸á€”á€­á€¯á€„á€ºá€žá€Šá€º">You may ask questions anytime</span>
        </li>
        <li>
          <span class="lang-text" data-en="You may refuse or withdraw consent. This will not affect your care" data-mm="á€žá€„á€ºá€žá€Šá€º á€„á€¼á€„á€ºá€¸á€†á€­á€¯á€”á€­á€¯á€„á€ºá€žá€Šá€º á€žá€­á€¯á€·á€™á€Ÿá€¯á€á€º á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€ºá€€á€­á€¯ á€›á€¯á€•á€ºá€žá€­á€™á€ºá€¸á€”á€­á€¯á€„á€ºá€žá€Šá€ºá‹ áŽá€„á€ºá€¸á€žá€Šá€º á€žá€„á€·á€ºá€…á€±á€¬á€„á€·á€ºá€›á€¾á€±á€¬á€€á€ºá€™á€¾á€¯á€€á€­á€¯ á€‘á€­á€á€­á€¯á€€á€ºá€…á€±á€™á€Šá€º á€™á€Ÿá€¯á€á€ºá€•á€«">You may refuse or withdraw consent. This will not affect your care</span>
        </li>
      </ul>

      <div style="margin-top: 2rem; padding: 1.5rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px;">
        <p style="font-weight: 600; margin: 0;">
          <span class="lang-text" data-en="Consent: Do you agree for your health information to be recorded in this secure digital system?" data-mm="á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€º: á€žá€„á€·á€ºá€€á€»á€”á€ºá€¸á€™á€¬á€›á€±á€¸ á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€¤á€œá€¯á€¶á€á€¼á€¯á€¶á€žá€±á€¬ á€’á€…á€ºá€‚á€»á€…á€ºá€á€šá€º á€…á€”á€…á€ºá€á€½á€„á€º á€™á€¾á€á€ºá€á€™á€ºá€¸á€á€„á€ºá€›á€”á€º á€žá€„á€ºá€žá€Šá€º á€žá€˜á€±á€¬á€á€°á€•á€«á€žá€œá€¬á€¸?">Consent: Do you agree for your health information to be recorded in this secure digital system?</span>
        </p>
      </div>
    </div>

    <div class="consent-method">
      <h4>
        <span class="lang-text" data-en="Consent Method" data-mm="á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€º á€”á€Šá€ºá€¸á€œá€™á€ºá€¸">Consent Method</span>
      </h4>
      
      <div class="method-option" onclick="selectMethod('digital')">
        <input type="radio" name="consentMethod" id="methodDigital" value="digital" checked>
        <label for="methodDigital" style="cursor: pointer; font-weight: 500;">
          <span class="lang-text" data-en="Digital Signature" data-mm="á€’á€…á€ºá€‚á€»á€…á€ºá€á€šá€º á€œá€€á€ºá€™á€¾á€á€º">Digital Signature</span>
        </label>
      </div>

      <div class="signature-pad-container active" id="signaturePadContainer">
        <p style="margin-bottom: 0.5rem; font-weight: 500;">
          <span class="lang-text" data-en="Please sign below:" data-mm="á€€á€»á€±á€¸á€‡á€°á€¸á€•á€¼á€¯á á€¡á€±á€¬á€€á€ºá€á€½á€„á€º á€œá€€á€ºá€™á€¾á€á€ºá€‘á€­á€¯á€¸á€•á€«:">Please sign below:</span>
        </p>
        <canvas id="signaturePad" width="500" height="200"></canvas>
        <div class="signature-controls">
          <button type="button" class="btn-signature" onclick="clearSignature()">
            <span class="lang-text" data-en="Clear" data-mm="á€›á€¾á€„á€ºá€¸á€œá€„á€ºá€¸á€›á€”á€º">Clear</span>
          </button>
        </div>
        <div class="patient-name-input">
          <input type="text" id="patientNameInput" placeholder="Patient Name (or type name)" required>
        </div>
      </div>

      <div class="method-option" onclick="selectMethod('verbal')">
        <input type="radio" name="consentMethod" id="methodVerbal" value="verbal">
        <label for="methodVerbal" style="cursor: pointer; font-weight: 500;">
          <span class="lang-text" data-en="Verbal Consent (Patient prefers not to sign)" data-mm="á€”á€¾á€¯á€á€ºá€–á€¼á€„á€·á€º á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€º (á€œá€°á€”á€¬á€žá€Šá€º á€œá€€á€ºá€™á€¾á€á€ºá€‘á€­á€¯á€¸á€›á€”á€º á€™á€”á€¾á€…á€ºá€žá€€á€ºá€•á€«)">Verbal Consent (Patient prefers not to sign)</span>
        </label>
      </div>

      <div class="verbal-consent-note" id="verbalConsentNote">
        <p style="margin: 0; font-weight: 500;">
          <span class="lang-text" data-en="Provider Attestation: The patient provided verbal consent but prefers not to sign." data-mm="á€…á€±á€¬á€„á€·á€ºá€›á€¾á€±á€¬á€€á€ºá€™á€¾á€¯ á€•á€±á€¸á€žá€° á€¡á€á€Šá€ºá€•á€¼á€¯á€á€»á€€á€º: á€œá€°á€”á€¬á€žá€Šá€º á€”á€¾á€¯á€á€ºá€–á€¼á€„á€·á€º á€á€½á€„á€·á€ºá€•á€¼á€¯á€á€»á€€á€º á€•á€±á€¸á€‘á€¬á€¸á€žá€±á€¬á€ºá€œá€Šá€ºá€¸ á€œá€€á€ºá€™á€¾á€á€ºá€‘á€­á€¯á€¸á€›á€”á€º á€™á€”á€¾á€…á€ºá€žá€€á€ºá€•á€«á‹">Provider Attestation: The patient provided verbal consent but prefers not to sign.</span>
        </p>
        <div class="patient-name-input" style="margin-top: 1rem;">
          <input type="text" id="verbalPatientName" placeholder="Patient Name" required>
        </div>
      </div>
    </div>

    <div class="consent-actions">
      <button class="btn-consent" id="acceptBtn" onclick="acceptConsent()">
        <i class="fas fa-check-circle me-2"></i>
        <span class="lang-text" data-en="Accept & Continue" data-mm="á€œá€€á€ºá€á€¶á€•á€¼á€®á€¸ á€†á€€á€ºá€œá€€á€ºá€œá€¯á€•á€ºá€†á€±á€¬á€„á€ºá€›á€”á€º">Accept & Continue</span>
      </button>
      <br>
      <button class="btn-refuse" id="refuseBtn" onclick="refuseConsent()">
        <i class="fas fa-times-circle me-2"></i>
        <span class="lang-text" data-en="Patient Refuses" data-mm="á€œá€°á€”á€¬ á€„á€¼á€„á€ºá€¸á€†á€­á€¯á€žá€Šá€º">Patient Refuses</span>
      </button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  <script src="js/consent-manager.js"></script>

  <script>
    let currentLanguage = localStorage.getItem('appLanguage') || 'en';
    let currentUser = null;
    let currentProvider = null;
    let patientData = null;
    let signaturePad = null;
    let canvas = null;
    let isDrawing = false;

    // Get patient data from URL or sessionStorage
    function getPatientData() {
      const urlParams = new URLSearchParams(window.location.search);
      const patientDataStr = urlParams.get('data') || sessionStorage.getItem('pendingPatientData');
      
      if (patientDataStr) {
        try {
          return JSON.parse(decodeURIComponent(patientDataStr));
        } catch (e) {
          console.error('Error parsing patient data:', e);
        }
      }
      return null;
    }

    function switchLanguage(lang) {
      currentLanguage = lang;
      localStorage.setItem('appLanguage', lang);
      
      document.querySelectorAll('.language-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      document.querySelectorAll('.lang-text').forEach(el => {
        const text = el.dataset[lang] || el.dataset.en || el.textContent;
        el.textContent = text;
      });
    }

    function selectMethod(method) {
      document.querySelectorAll('.method-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      document.querySelectorAll('input[name="consentMethod"]').forEach(radio => {
        radio.checked = radio.value === method;
        if (radio.value === method) {
          radio.closest('.method-option').classList.add('selected');
        }
      });

      if (method === 'digital') {
        document.getElementById('signaturePadContainer').classList.add('active');
        document.getElementById('verbalConsentNote').classList.remove('active');
        document.getElementById('patientNameInput').required = true;
        document.getElementById('verbalPatientName').required = false;
      } else {
        document.getElementById('signaturePadContainer').classList.remove('active');
        document.getElementById('verbalConsentNote').classList.add('active');
        document.getElementById('patientNameInput').required = false;
        document.getElementById('verbalPatientName').required = true;
      }
    }

    function initSignaturePad() {
      canvas = document.getElementById('signaturePad');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      let lastX = 0;
      let lastY = 0;

      function startDrawing(e) {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
      }

      function draw(e) {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();

        lastX = x;
        lastY = y;
      }

      function stopDrawing() {
        isDrawing = false;
      }

      // Mouse events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);

      // Touch events
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
      });

      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
      });

      canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        canvas.dispatchEvent(mouseEvent);
      });
    }

    function clearSignature() {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function getSignatureData() {
      if (!canvas) return null;
      return canvas.toDataURL('image/png');
    }

    async function acceptConsent() {
      if (!currentUser || !patientData) {
        alert('Error: Missing user or patient data');
        return;
      }

      const consentMethod = document.querySelector('input[name="consentMethod"]:checked').value;
      const acceptBtn = document.getElementById('acceptBtn');
      acceptBtn.disabled = true;
      acceptBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div> Processing...';

      try {
        let consentData = {
          type: consentMethod === 'digital' ? 'digital' : 'verbal',
          signature: null,
          patientName: null,
          verbalConsent: consentMethod === 'verbal',
          providerAttestation: consentMethod === 'verbal' ? 'Patient provided verbal consent but prefers not to sign' : null
        };

        if (consentMethod === 'digital') {
          const signature = getSignatureData();
          const patientName = document.getElementById('patientNameInput').value.trim();
          
          if (!signature || !patientName) {
            alert('Please provide signature and patient name');
            acceptBtn.disabled = false;
            acceptBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Accept & Continue';
            return;
          }
          
          consentData.signature = signature;
          consentData.patientName = patientName;
        } else {
          const patientName = document.getElementById('verbalPatientName').value.trim();
          if (!patientName) {
            alert('Please enter patient name');
            acceptBtn.disabled = false;
            acceptBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Accept & Continue';
            return;
          }
          consentData.patientName = patientName;
        }

        // Get provider info
        const userDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
        const providerName = userDoc.exists ? (userDoc.data().name || currentUser.email) : currentUser.email;
        const facility = userDoc.exists ? (userDoc.data().facility_code || null) : null;

        // Get IP address
        const ipAddress = await ConsentManager.getClientIP();

        consentData.facility = facility;
        consentData.ipAddress = ipAddress;

        // Save patient first (if not already saved)
        let patientId = patientData.id || null;
        
        if (!patientId) {
          // Save patient data to Firestore
          const userDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
          const userData = userDoc.exists ? userDoc.data() : {};
          const userTownship = userData.township || '';

          const patientDoc = await firebase.firestore().collection('patients').add({
            ...patientData,
            created_by: currentUser.uid,
            created_at: firebase.firestore.FieldValue.serverTimestamp(),
            township: userTownship,
            status: 'registered',
            hasConsent: true,
            consentStatus: 'consented'
          });

          patientId = patientDoc.id;
        }

        // Save consent
        const saved = await ConsentManager.savePatientConsent(
          patientId,
          currentUser.uid,
          providerName,
          consentData
        );

        if (saved) {
          // Clear pending data
          sessionStorage.removeItem('pendingPatientData');
          
          // Redirect to success or patient list
          window.location.href = 'registration-success.html?patient=' + patientId;
        } else {
          alert('Error saving consent. Please try again.');
          acceptBtn.disabled = false;
          acceptBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Accept & Continue';
        }
      } catch (error) {
        console.error('Error accepting consent:', error);
        alert('Error: ' + error.message);
        acceptBtn.disabled = false;
        acceptBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Accept & Continue';
      }
    }

    async function refuseConsent() {
      if (!confirm('Are you sure the patient refuses consent? The patient record will be marked as "No Consent - Do Not Record Identifiable Data".')) {
        return;
      }

      if (!currentUser || !patientData) {
        alert('Error: Missing user or patient data');
        return;
      }

      const refuseBtn = document.getElementById('refuseBtn');
      refuseBtn.disabled = true;
      refuseBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div> Processing...';

      try {
        // Save patient with no consent status
        const userDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
        const userData = userDoc.exists ? userDoc.data() : {};
        const userTownship = userData.township || '';

        const patientDoc = await firebase.firestore().collection('patients').add({
          ...patientData,
          created_by: currentUser.uid,
          created_at: firebase.firestore.FieldValue.serverTimestamp(),
          township: userTownship,
          status: 'registered',
          hasConsent: false,
          consentStatus: 'no_consent',
          consentRefused: true,
          consentRefusedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Save refusal consent record
        const consentData = {
          type: 'refused',
          patientName: patientData.name || 'Unknown',
          providerAttestation: 'Patient refused consent',
          ipAddress: await ConsentManager.getClientIP()
        };

        await ConsentManager.savePatientConsent(
          patientDoc.id,
          currentUser.uid,
          currentUser.email,
          consentData
        );

        // Clear pending data
        sessionStorage.removeItem('pendingPatientData');

        alert('Patient record created with "No Consent" status. No identifiable data will be recorded.');
        window.location.href = 'list.html';
      } catch (error) {
        console.error('Error refusing consent:', error);
        alert('Error: ' + error.message);
        refuseBtn.disabled = false;
        refuseBtn.innerHTML = '<i class="fas fa-times-circle me-2"></i>Patient Refuses';
      }
    }

    // Initialize
    firebase.auth().onAuthStateChanged(async function(user) {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      currentUser = user;
      patientData = getPatientData();

      if (!patientData) {
        alert('No patient data found. Please start registration again.');
        window.location.href = 'patient-enhanced.html';
        return;
      }

      // Display patient info
      const patientInfoBox = document.getElementById('patientInfoBox');
      const patientInfoText = document.getElementById('patientInfoText');
      if (patientInfoBox && patientInfoText) {
        const name = patientData.name || 'Unknown';
        const age = patientData.age || 'N/A';
        patientInfoText.textContent = `Name: ${name}, Age: ${age}`;
        patientInfoBox.style.display = 'block';
      }

      // Initialize signature pad
      initSignaturePad();

      // Initialize language
      switchLanguage(currentLanguage);
    });

    // Initialize language on page load
    document.addEventListener('DOMContentLoaded', function() {
      switchLanguage(currentLanguage);
    });
  </script>
</body>
</html>

