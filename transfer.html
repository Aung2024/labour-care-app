<!DOCTYPE html>
<html lang="en">
<head>
  <title>Patient Transfer Record</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <style>
    :root {
      --primary-color: #10b981;
      --secondary-color: #059669;
      --accent-color: #34d399;
      --light-bg: #f0fdf4;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    body {
      background: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header-section {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1rem 0;
      margin-bottom: 2rem;
    }
    .transfer-form-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    
    .form-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }
    
    .form-section h3 {
      color: #374151;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f59e0b;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-section h3 i {
      color: #f59e0b;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }
    
    .form-control:invalid {
      border-color: #ef4444;
    }
    
    .required-field::after {
      content: " *";
      color: #ef4444;
      font-weight: bold;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 12px;
    }
    
    .btn-save-transfer {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }
    
    .btn-save-transfer:hover {
      background: linear-gradient(135deg, #d97706, #b45309);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
    }
    
    .btn-back {
      background: #6b7280;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-back:hover {
      background: #4b5563;
      transform: translateY(-1px);
    }
    
    .success-message {
      display: none;
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin: 20px 0;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }
    
    .success-message i {
      font-size: 2rem;
      margin-bottom: 10px;
      display: block;
    }
    
    .patient-info {
      background: #f3f4f6;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      border-left: 4px solid #f59e0b;
    }
    
    .patient-info h4 {
      color: #374151;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .patient-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .info-item {
      display: flex;
      flex-direction: column;
    }
    
    .info-label {
      font-size: 0.9rem;
      color: #6b7280;
      font-weight: 500;
      margin-bottom: 5px;
    }
    
    .info-value {
      font-weight: 600;
      color: #374151;
    }
    
    .transfer-reason-section {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .transfer-reason-section h4 {
      color: #92400e;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .reason-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .reason-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border: 1px solid #f59e0b;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .reason-option:hover {
      background: #fef3c7;
      border-color: #d97706;
    }
    
    .reason-option input[type="radio"] {
      margin: 0;
    }
    
    .reason-option label {
      margin: 0;
      cursor: pointer;
      font-weight: 500;
    }

    /* Simplified Patient Info Card */
    .patient-info-simple {
      background: #f3f4f6;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      border-left: 4px solid #10b981;
    }
    
    .patient-info-simple h4 {
      color: #374151;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
    }

    /* Collapse Icon Styling */
    .collapse-icon {
      transition: transform 0.3s ease;
      font-size: 0.8rem;
    }
    
    .collapsed .collapse-icon {
      transform: rotate(-90deg);
    }
    
    .btn-link {
      color: var(--primary-color);
      text-decoration: none;
    }
    
    .btn-link:hover {
      color: var(--secondary-color);
    }

    .footer {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      color: #374151;
      text-align: center;
      padding: 2rem;
      margin-top: 2rem;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Language Switcher Styles */
    .language-switcher {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .language-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .language-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .language-btn.active {
      background: rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .flag-icon {
      width: 16px;
      height: 12px;
      object-fit: cover;
      border-radius: 2px;
    }

    @media (max-width: 768px) {
      .header-section .d-flex {
        flex-wrap: wrap;
        justify-content: flex-start;
      }
      
      .language-switcher {
        order: 2;
        margin-top: 10px;
      }
      
      .header-section .btn-outline-light {
        order: 1;
      }
    }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  <script src="js/status-manager.js"></script>
  <script src="js/session-manager.js"></script>
  <script src="js/audit-logger.js"></script>
</head>
<body>
  <!-- Header Section -->
  <div class="header-section">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
          <h1 class="mb-2">
            <i class="fas fa-ambulance me-3"></i>
            <span class="lang-text" data-en="Patient Referral Record" data-mm="á€œá€°á€”á€¬á€Šá€½á€¾á€”á€ºá€¸á€•á€­á€¯á€·á€žá€Šá€·á€º á€™á€¾á€á€ºá€á€™á€ºá€¸">Patient Referral Record</span>
          </h1>
        </div>
        <div class="d-flex align-items-center gap-3">
          <div class="language-switcher">
            <button class="language-btn" data-lang="en" onclick="switchLanguage('en')">
              <span>ðŸ‡¬ðŸ‡§</span> ENG
            </button>
            <button class="language-btn active" data-lang="mm" onclick="switchLanguage('mm')">
              <span>ðŸ‡²ðŸ‡²</span> MM
            </button>
          </div>
          <a href="patient-care-hub.html" class="btn btn-outline-light btn-sm">
            <i class="fas fa-arrow-left me-2"></i><span class="lang-text" data-en="Back to Hub" data-mm="á€•á€¼á€”á€ºá€žá€½á€¬á€¸á€›á€”á€º">Back to Hub</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="main-container">
    <div class="transfer-form-container">

      <!-- Patient Information Display -->
      <div class="patient-info-simple">
        <h4><i class="fas fa-user-injured"></i> <span id="patientName">Loading...</span></h4>
      </div>

      <!-- Transfer Information Form -->
      <form id="transferForm" onsubmit="saveTransferRecord(event)">
        <!-- Referral Details Section -->
        <div class="form-section">
          <h3>
            <i class="fas fa-hospital"></i> <span class="lang-text" data-en="Referral Details" data-mm="á€œá€½á€¾á€²á€•á€¼á€±á€¬á€„á€ºá€¸á€•á€±á€¸á€•á€­á€¯á€·á€™á€¾á€¯á€¡á€žá€±á€¸á€…á€­á€á€ºá€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸">Referral Details</span>
            <button class="btn btn-link p-0 ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#transferDetailsCollapse" aria-expanded="true" aria-controls="transferDetailsCollapse">
              <i class="fas fa-chevron-down collapse-icon"></i>
            </button>
          </h3>
          <div class="collapse show" id="transferDetailsCollapse">
          
          <div class="form-row">
            <div class="form-group">
              <label for="referralTime" class="required-field lang-text" data-en="Referral Time (Calendar)" data-mm="á€Šá€½á€¾á€”á€ºá€¸á€•á€­á€¯á€·á€”á€±á€·á€…á€½á€²">Referral Time (Calendar)</label>
              <input type="datetime-local" id="referralTime" name="referralTime" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="referralMode" class="lang-text" data-en="Referral Mode (Drop down)" data-mm="á€žá€½á€¬á€¸á€›á€±á€¬á€€á€ºá€›á€”á€ºá€¡á€žá€¯á€¶á€¸á€•á€¼á€¯á€žá€Šá€·á€ºá€šá€¬á€‰á€º">Referral Mode (Drop down)</label>
              <select id="referralMode" name="referralMode" class="form-control">
                <option value="" data-en="Select referral mode" data-mm="á€Šá€½á€¾á€”á€ºá€¸á€•á€­á€¯á€·á€›á€”á€ºá€¡á€žá€¯á€¶á€¸á€•á€¼á€¯á€žá€Šá€·á€ºá€šá€¬á€‰á€ºá€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«">Select referral mode</option>
                <option value="Ambulance" data-en="Ambulance" data-mm="á€†á€±á€¸á€›á€¯á€¶á€€á€¬á€¸á€–á€¼á€„á€·á€º">Ambulance</option>
                <option value="Private Vehicle" data-en="Private Vehicle" data-mm="á€€á€­á€¯á€šá€ºá€•á€­á€¯á€„á€ºá€šá€¬á€‰á€º">Private Vehicle</option>
                <option value="Public Transport" data-en="Public Transport" data-mm="á€¡á€™á€»á€¬á€¸á€•á€¼á€Šá€ºá€žá€°á€žá€½á€¬á€¸á€œá€¬á€›á€±á€¸á€šá€¬á€‰á€º">Public Transport</option>
                <option value="Other" data-en="Other" data-mm="á€¡á€á€¼á€¬á€¸">Other</option>
              </select>
            </div>
          </div>
          
            <div class="form-group">
            <label for="referralFacility" class="lang-text" data-en="Referral Facility (Type)" data-mm="á€œá€½á€¾á€²á€•á€¼á€±á€¬á€„á€ºá€¸á€Šá€½á€¾á€”á€ºá€¸á€•á€­á€¯á€·á€™á€Šá€·á€ºá€†á€±á€¸á€›á€¯á€¶/á€€á€»á€”á€ºá€¸á€™á€¬á€›á€±á€¸á€Œá€¬á€”á€¡á€™á€Šá€º">Referral Facility (Type)</label>
            <input type="text" id="referralFacility" name="referralFacility" class="form-control" placeholder="Enter facility name">
          </div>
          
          <div class="form-group">
            <label for="mainSymptoms" class="lang-text" data-en="Main symptoms and duration (if the patient is pregnant, please also describe the obstetric history) (Type)" data-mm="á€¡á€“á€­á€€á€›á€±á€¬á€‚á€«á€œá€€á€¹á€á€á€¬á€™á€»á€¬á€¸á€”á€¾á€„á€·á€º á€€á€¼á€¬á€™á€¼á€„á€·á€ºá€á€»á€­á€”á€º (á€™á€½á€±á€¸á€œá€°á€”á€¬á€€á€­á€¯á€šá€ºá€á€”á€ºá€†á€±á€¬á€„á€ºá€–á€¼á€…á€ºá€•á€«á€€ á€™á€½á€±á€¸á€–á€½á€¬á€¸á€›á€¬á€‡á€á€„á€ºá€™á€»á€¬á€¸á€•á€« á€–á€±á€¬á€ºá€•á€¼á€•á€«á‹)">Main symptoms and duration (if the patient is pregnant, please also describe the obstetric history) (Type)</label>
            <textarea id="mainSymptoms" name="mainSymptoms" class="form-control" rows="4" placeholder="Describe main symptoms, duration, and obstetric history if applicable"></textarea>
          </div>
          
          <div class="form-group">
            <label for="treatmentBeforeReferral" class="lang-text" data-en="Treatment given before referral" data-mm="á€™á€œá€½á€¾á€²á€•á€¼á€±á€¬á€„á€ºá€¸á€™á€® á€€á€¯á€žá€•á€±á€¸á€™á€¾á€¯á€™á€»á€¬á€¸">Treatment given before referral</label>
            <textarea id="treatmentBeforeReferral" name="treatmentBeforeReferral" class="form-control" rows="3" placeholder="Describe treatment provided before referral"></textarea>
          </div>
          
          <div class="form-group">
            <label for="medications" class="lang-text" data-en="Medications (Type)" data-mm="á€†á€±á€¸á€á€«á€¸á€™á€»á€¬á€¸">Medications (Type)</label>
            <textarea id="medications" name="medications" class="form-control" rows="3" placeholder="List medications given"></textarea>
          </div>
          </div>
        </div>


        <!-- Patient's Condition at Referral Section -->
        <div class="form-section">
          <h3>
            <i class="fas fa-heartbeat"></i> <span class="lang-text" data-en="Patient's condition at referral" data-mm="á€œá€½á€¾á€²á€•á€¼á€±á€¬á€„á€ºá€¸á€…á€‰á€º á€œá€°á€”á€¬áá€¡á€á€¼á€±á€¡á€”á€±">Patient's condition at referral</span>
            <button class="btn btn-link p-0 ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#patientConditionCollapse" aria-expanded="true" aria-controls="patientConditionCollapse">
              <i class="fas fa-chevron-down collapse-icon"></i>
            </button>
          </h3>
          <div class="collapse show" id="patientConditionCollapse">
          
          <div class="form-row">
            <div class="form-group">
              <label for="patientGeneralCondition" class="lang-text" data-en="Patient's General Condition (Drop down - Good, Fair, Poor, Serious)" data-mm="á€œá€°á€”á€¬áá€¡á€á€¼á€±á€¡á€”á€± (á€€á€±á€¬á€„á€ºá€¸áŠ á€•á€»á€™á€ºá€¸á€™á€»á€¾áŠ á€™á€€á€±á€¬á€„á€ºá€¸áŠ á€•á€¼á€„á€ºá€¸á€‘á€”á€º)">Patient's General Condition (Drop down - Good, Fair, Poor, Serious)</label>
              <select id="patientGeneralCondition" name="patientGeneralCondition" class="form-control">
                <option value="" data-en="Select condition" data-mm="á€¡á€á€¼á€±á€¡á€”á€±á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«">Select condition</option>
                <option value="Good" data-en="Good" data-mm="á€€á€±á€¬á€„á€ºá€¸">Good</option>
                <option value="Fair" data-en="Fair" data-mm="á€•á€»á€™á€ºá€¸á€™á€»á€¾">Fair</option>
                <option value="Poor" data-en="Poor" data-mm="á€™á€€á€±á€¬á€„á€ºá€¸">Poor</option>
                <option value="Serious" data-en="Serious" data-mm="á€•á€¼á€„á€ºá€¸á€‘á€”á€º">Serious</option>
              </select>
            </div>
            <div class="form-group">
              <label for="vitalSigns" class="lang-text" data-en="Vital signs (BP, Pulse, Temperature)" data-mm="Vital signs (á€žá€½á€±á€¸á€•á€±á€«á€„á€ºá€á€»á€­á€”á€ºáŠ á€žá€½á€±á€¸á€á€¯á€”á€ºá€”á€¾á€¯á€”á€ºá€¸áŠ á€€á€­á€¯á€šá€ºá€¡á€•á€°á€á€»á€­á€”á€º)">Vital signs (BP, Pulse, Temperature)</label>
              <input type="text" id="vitalSigns" name="vitalSigns" class="form-control" placeholder="e.g., BP: 120/80, Pulse: 72, Temp: 37.5Â°C">
            </div>
          </div>
          
            <div class="form-group">
            <label for="initial" class="lang-text" data-en="Initial" data-mm="á€œá€€á€ºá€™á€¾á€á€º">Initial</label>
            <input type="text" id="initial" name="initial" class="form-control" placeholder="Signature / Initials">
          </div>
          </div>
        </div>


        <!-- Action Buttons -->
        <div class="action-buttons">
          <button type="button" class="btn-back" onclick="goBack()">
            <i class="fas fa-arrow-left"></i> <span class="lang-text" data-en="Back" data-mm="á€•á€¼á€”á€ºá€žá€½á€¬á€¸á€›á€”á€º">Back</span>
          </button>
          <button type="submit" class="btn-save-transfer">
            <i class="fas fa-save"></i> <span class="lang-text" data-en="Save Referral Record" data-mm="á€Šá€½á€¾á€”á€ºá€¸á€•á€­á€¯á€·á€™á€¾á€á€ºá€á€™á€ºá€¸ á€žá€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€”á€º">Save Referral Record</span>
          </button>
        </div>
      </form>

      <!-- Success Message -->
      <div id="successMessage" class="success-message">
        <i class="fas fa-check-circle"></i>
        <h4 class="lang-text" data-en="Referral Record Saved Successfully!" data-mm="á€Šá€½á€¾á€”á€ºá€¸á€•á€­á€¯á€·á€™á€¾á€á€ºá€á€™á€ºá€¸ á€žá€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®!">Referral Record Saved Successfully!</h4>
        <p class="lang-text" data-en="The patient referral information has been recorded. You can now view the complete referral record." data-mm="á€œá€°á€”á€¬ á€Šá€½á€¾á€”á€ºá€¸á€•á€­á€¯á€·á€™á€¾á€¯ á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€™á€¾á€á€ºá€á€™á€ºá€¸á€á€„á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹ á€šá€á€¯ á€•á€¼á€Šá€·á€ºá€…á€¯á€¶á€žá€±á€¬ á€Šá€½á€¾á€”á€ºá€¸á€•á€­á€¯á€·á€™á€¾á€á€ºá€á€™á€ºá€¸á€€á€­á€¯ á€€á€¼á€Šá€·á€ºá€›á€¾á€¯á€”á€­á€¯á€„á€ºá€•á€«á€žá€Šá€ºá‹">The patient referral information has been recorded. You can now view the complete referral record.</p>
        <button class="btn btn-light mt-3" onclick="viewTransferRecord()">
          <i class="fas fa-eye"></i> <span class="lang-text" data-en="View Referral Record" data-mm="á€Šá€½á€¾á€”á€ºá€¸á€•á€­á€¯á€·á€™á€¾á€á€ºá€á€™á€ºá€¸á€€á€­á€¯ á€€á€¼á€Šá€·á€ºá€›á€¾á€¯á€›á€”á€º">View Referral Record</span>
        </button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p class="mb-0">
        <i class="fas fa-heart me-2"></i>
        MNCH App 2025 | Developed by Jhpiego Myanmar for MoH.
      </p>
    </div>
  </footer>

  <script>
    // Language switching
    let currentLanguage = localStorage.getItem('appLanguage') || 'mm';

    // Language switching function
    function switchLanguage(lang) {
      currentLanguage = lang;
      localStorage.setItem('appLanguage', lang);
      
      // Update active button
      document.querySelectorAll('.language-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      // Update all text elements with lang-text class
      document.querySelectorAll('.lang-text').forEach(el => {
        const enText = el.getAttribute('data-en');
        const mmText = el.getAttribute('data-mm');
        if (lang === 'en' && enText) {
          el.textContent = enText;
        } else if (lang === 'mm' && mmText) {
          el.textContent = mmText;
        }
      });
      
      // Update option elements in select dropdowns
      document.querySelectorAll('select option[data-en]').forEach(option => {
        const enText = option.getAttribute('data-en');
        const mmText = option.getAttribute('data-mm');
        if (lang === 'en' && enText) {
          option.textContent = enText;
        } else if (lang === 'mm' && mmText) {
          option.textContent = mmText;
        }
      });
      
      // Update placeholders
      const placeholders = {
        'referralTime': { en: 'Select date and time', mm: 'á€›á€€á€ºá€…á€½á€²á€”á€¾á€„á€·á€º á€¡á€á€»á€­á€”á€ºá€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«' },
        'referralFacility': { en: 'Enter facility name', mm: 'á€†á€±á€¸á€›á€¯á€¶/á€€á€»á€”á€ºá€¸á€™á€¬á€›á€±á€¸á€Œá€¬á€”á€¡á€™á€Šá€º á€›á€­á€¯á€€á€ºá€‘á€Šá€·á€ºá€•á€«' },
        'mainSymptoms': { en: 'Describe main symptoms, duration, and obstetric history if applicable', mm: 'á€¡á€“á€­á€€á€›á€±á€¬á€‚á€«á€œá€€á€¹á€á€á€¬á€™á€»á€¬á€¸áŠ á€€á€¼á€¬á€™á€¼á€„á€·á€ºá€á€»á€­á€”á€ºá€”á€¾á€„á€·á€º á€™á€½á€±á€¸á€–á€½á€¬á€¸á€›á€¬á€‡á€á€„á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€–á€±á€¬á€ºá€•á€¼á€•á€«' },
        'treatmentBeforeReferral': { en: 'Describe treatment provided before referral', mm: 'á€™á€œá€½á€¾á€²á€•á€¼á€±á€¬á€„á€ºá€¸á€™á€® á€€á€¯á€žá€•á€±á€¸á€™á€¾á€¯á€™á€»á€¬á€¸á€€á€­á€¯ á€–á€±á€¬á€ºá€•á€¼á€•á€«' },
        'medications': { en: 'List medications given', mm: 'á€•á€±á€¸á€‘á€¬á€¸á€žá€±á€¬ á€†á€±á€¸á€á€«á€¸á€™á€»á€¬á€¸á€€á€­á€¯ á€…á€¬á€›á€„á€ºá€¸á€•á€¼á€¯á€…á€¯á€•á€«' },
        'vitalSigns': { en: 'e.g., BP: 120/80, Pulse: 72, Temp: 37.5Â°C', mm: 'á€¥á€•á€™á€¬ - á€žá€½á€±á€¸á€•á€±á€«á€„á€ºá€á€»á€­á€”á€º: 120/80, á€žá€½á€±á€¸á€á€¯á€”á€ºá€”á€¾á€¯á€”á€ºá€¸: 72, á€¡á€•á€°á€á€»á€­á€”á€º: 37.5Â°C' },
        'initial': { en: 'Signature / Initials', mm: 'á€œá€€á€ºá€™á€¾á€á€º / á€¡á€™á€Šá€ºá€¡á€á€­á€¯á€€á€±á€¬á€€á€º' }
      };
      
      Object.keys(placeholders).forEach(id => {
        const el = document.getElementById(id);
        if (el && placeholders[id][lang]) {
          el.placeholder = placeholders[id][lang];
        }
      });
    }

    // Get patient ID from URL parameters
    function getPatientIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('patient');
    }

    // Load patient information
    async function loadPatientInfo() {
      try {
        const patientId = getPatientIdFromUrl();
        if (!patientId) {
          document.body.innerHTML = '<div class="alert alert-danger">Patient ID not found.</div>';
          return;
        }

        // Check if user is authenticated
        const user = firebase.auth().currentUser;
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        // Load patient data
        const patientDoc = await firebase.firestore()
          .collection("patients")
          .doc(patientId)
          .get();

        if (!patientDoc.exists) {
          document.body.innerHTML = '<div class="alert alert-danger">Patient not found.</div>';
          return;
        }

        const patientData = patientDoc.data();
        
        // Populate simplified patient info display
        document.getElementById('patientName').textContent = patientData.name || 'Unknown Patient';

        // Set default referral time to current time
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
        const referralTimeEl = document.getElementById('referralTime');
        if (referralTimeEl) {
          referralTimeEl.value = localDateTime.toISOString().slice(0, 16);
        }

      } catch (error) {
        console.error('Error loading patient info:', error);
        document.body.innerHTML = `<div class="alert alert-danger">Error loading patient information: ${error.message}</div>`;
      }
    }

    // Save transfer record
    async function saveTransferRecord(event) {
      event.preventDefault();
      
      try {
        const patientId = getPatientIdFromUrl();
        if (!patientId) {
          alert('Patient ID not found.');
          return;
        }

        // Helper function to safely get element value
        const getValue = (id) => {
          const el = document.getElementById(id);
          return el ? el.value : '';
        };
        
        // Collect form data with new field names
        const formData = {
          referralTime: getValue('referralTime'),
          referralMode: getValue('referralMode'),
          referralFacility: getValue('referralFacility'),
          mainSymptoms: getValue('mainSymptoms'),
          treatmentBeforeReferral: getValue('treatmentBeforeReferral'),
          medications: getValue('medications'),
          patientGeneralCondition: getValue('patientGeneralCondition'),
          vitalSigns: getValue('vitalSigns'),
          initial: getValue('initial'),
          patientId: patientId,
          recordedBy: firebase.auth().currentUser?.uid || 'unknown',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Save transfer record to Firestore
        await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .collection('records')
          .doc('transferRecord')
          .set(formData);

        // Save endTreatment document with outcome 'transfer'
        await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .collection('records')
          .doc('endTreatment')
          .set({
            outcome: 'transfer',
            recordedBy: firebase.auth().currentUser?.uid || 'unknown',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });

        // Get transfer type from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const transferType = urlParams.get('type') || 'anc'; // Default to 'anc' if not specified
        
        // Map transfer type to status
        let transferStatus;
        let transferReason;
        switch(transferType) {
          case 'labour':
            transferStatus = 'labour_transfer';
            transferReason = 'Transferred during labour care';
            break;
          case 'pnc':
            transferStatus = 'pnc_transfer';
            transferReason = 'Transferred during postnatal care';
            break;
          case 'anc':
          default:
            transferStatus = 'anc_transfer';
            transferReason = 'Transferred during antenatal care';
            break;
        }

        // Update patient status using StatusManager
        if (window.StatusManager) {
          const statusUpdated = await StatusManager.checkAndUpdateToTransfer(
            patientId,
            transferStatus,
            transferReason
          );
          if (statusUpdated) {
            console.log(`âœ… Patient status updated to ${transferStatus}`);
          }
        } else {
          // Fallback if StatusManager is not available
          await firebase.firestore()
            .collection('patients')
            .doc(patientId)
            .update({
              status: transferStatus,
              last_updated: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        console.log('Transfer record saved successfully and patient status updated');
        
        // Redirect to Patient Care Hub after successful save
        window.location.href = `patient-care-hub.html?patient=${patientId}`;

      } catch (error) {
        console.error('Error saving transfer record:', error);
        alert(`Error saving transfer record: ${error.message}`);
      }
    }

    // Go back to summary page
    function goBack() {
      const patientId = getPatientIdFromUrl();
      if (patientId) {
        window.location.href = `summary.html?patient=${patientId}`;
      } else {
        window.location.href = 'list.html';
      }
    }

    // View transfer record
    function viewTransferRecord() {
      const patientId = getPatientIdFromUrl();
      if (patientId) {
        // You can create a transfer-record-view.html page or redirect to summary
        window.location.href = `summary.html?patient=${patientId}`;
      }
    }

    // Initialize language switcher
    document.addEventListener('DOMContentLoaded', function() {
      // Set initial language
      switchLanguage(currentLanguage);
      
      // Add event listeners to language buttons
      document.querySelectorAll('.language-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          switchLanguage(this.dataset.lang);
        });
      });
    });

    // Load data when page loads
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "login.html";
      } else {
        loadPatientInfo();
      }
    });
  </script>
</body>
</html>
