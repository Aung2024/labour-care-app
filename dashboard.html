<!DOCTYPE html>
<html lang="en">
<head>
  <title>Labour Care Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="languages/language-switcher.css" />
  
  <!-- Chart.js for beautiful charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    .dashboard-container {
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
    }
    
    .dashboard-header {
      background: linear-gradient(135deg, #1e40af, #3b82f6);
      color: white;
      padding: 30px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(30, 64, 175, 0.3);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card.primary { border-left: 5px solid #3b82f6; }
    .stat-card.success { border-left: 5px solid #10b981; }
    .stat-card.warning { border-left: 5px solid #f59e0b; }
    .stat-card.danger { border-left: 5px solid #ef4444; }
    .stat-card.info { border-left: 5px solid #06b6d4; }
    .stat-card.info .stat-number { color: #06b6d4; }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .stat-label {
      color: #6b7280;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Clinical Tables - Premium Design */
    .clinical-table-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      border: 1px solid #f1f5f9;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .clinical-table-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    .table-header {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 20px 25px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .table-header h5 {
      color: #1e293b;
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
    }
    
    .table-header h5 i {
      margin-right: 10px;
      color: #3b82f6;
    }
    
    .table-actions .btn {
      border-radius: 8px;
      font-weight: 500;
      padding: 8px 16px;
      transition: all 0.2s ease;
    }
    
    .table-actions .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    /* Clinical Table Styling */
    .clinical-table {
      margin: 0;
      font-size: 0.9rem;
    }
    
    .clinical-table thead th {
      background: #f8fafc;
      border: none;
      color: #475569;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 15px 12px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .clinical-table tbody td {
      padding: 12px;
      border: none;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
      color: #334155;
    }
    
    .clinical-table tbody tr:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      transform: scale(1.01);
      transition: all 0.2s ease;
    }
    
    /* Action Buttons */
    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 2px;
    }
    
    .btn-edit {
      background: #3b82f6;
      color: white;
    }
    
    .btn-edit:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-view {
      background: #10b981;
      color: white;
    }
    
    .btn-view:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .btn-delete {
      background: #ef4444;
      color: white;
    }
    
    .btn-delete:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    /* Status Badges */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-active {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-birthed {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .status-transferred {
      background: #fef3c7;
      color: #92400e;
    }
    
    .status-other {
      background: #f3e8ff;
      color: #7c3aed;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .table-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .clinical-table {
        font-size: 0.8rem;
      }
      
      .clinical-table thead th,
      .clinical-table tbody td {
        padding: 8px 6px;
      }
    }
    
    /* Premium Enhancements */
    .clinical-table tbody tr {
      transition: all 0.2s ease;
    }
    
    .clinical-table tbody tr:nth-child(even) {
      background: #fafbfc;
    }
    
    .clinical-table tbody tr:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      transform: scale(1.005);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    /* Empty state styling */
    .text-muted {
      color: #94a3b8 !important;
      font-style: italic;
    }
    
    /* Loading states */
    .table-loading {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }
    
    .table-loading i {
      font-size: 2rem;
      margin-bottom: 15px;
      color: #3b82f6;
    }
    
    /* Sticky Back Button */
    .sticky-back-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 15px 20px;
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
      transition: all 0.3s ease;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sticky-back-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(59, 130, 246, 0.4);
      background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%);
    }
    
    /* Footer Sticky */
    .footer {
      position: sticky;
      bottom: 0;
      background: white;
      border-top: 1px solid #e2e8f0;
      padding: 20px 0;
      margin-top: auto;
    }
    
    /* Main container for sticky footer */
    .main-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .content-wrapper {
      flex: 1;
    }
    
    /* Chart Cards */
    .chart-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      border: 1px solid #f1f5f9;
      height: 100%;
      transition: all 0.3s ease;
    }
    
    .chart-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    .chart-card h5 {
      color: #1e293b;
      font-size: 1.1rem;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .chart-card h5 i {
      margin-right: 10px;
      color: #3b82f6;
    }
    
    .chart-card canvas {
      max-height: 300px;
      width: 100% !important;
    }
    
    /* Analytics Cards */
    .analytics-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      border: 1px solid #f1f5f9;
      height: 100%;
      transition: all 0.3s ease;
    }
    
    .analytics-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    .analytics-card h5 {
      color: #1e293b;
      font-size: 1.1rem;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .analytics-card h5 i {
      margin-right: 10px;
      color: #3b82f6;
    }
    
    /* Analytics Content */
    .analytics-content {
      font-size: 0.9rem;
      color: #6b7280;
    }
    
    .analytics-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .analytics-item:last-child {
      border-bottom: none;
    }
    
    .analytics-label {
      font-weight: 500;
      color: #374151;
    }
    
    .analytics-value {
      font-weight: 600;
      color: #1f2937;
    }
  </style>
</head>
<body>
  <!-- Sticky Back Button -->
  <button class="sticky-back-btn" onclick="goBack()">
    <i class="fas fa-arrow-left"></i>
    Back
  </button>

  <!-- Professional Header -->
  <div class="medical-header">
    <div class="header-content">
      <div class="header-left">
        <div class="app-title">üë©‚Äç‚öïÔ∏è <span data-i18n="appTitle">Labour Care Guide</span></div>
        <div class="page-subtitle"><span data-i18n="dashboard">Dashboard</span></div>
      </div>
      <div class="header-right">
        <div class="language-switcher">
          <div class="language-switcher-container">
            <button class="lang-btn" data-lang="en" onclick="switchLanguage('en')">EN</button>
            <button class="lang-btn" data-lang="my" onclick="switchLanguage('my')">MY</button>
          </div>
        </div>
        <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
          <i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <div class="content-wrapper">
      <div class="dashboard-container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
          <h1><i class="fas fa-chart-line"></i> <span id="dashboardTitle">Dashboard</span></h1>
          <p id="dashboardSubtitle">Welcome to your personalized dashboard</p>
        </div>

        <!-- Key Statistics -->
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card primary">
            <div class="stat-number" id="totalPatients">0</div>
            <div class="stat-label">Total Patients</div>
          </div>
          <div class="stat-card success">
            <div class="stat-number" id="antenatalPatients">0</div>
            <div class="stat-label">Antenatal Care</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-number" id="labourPatients">0</div>
            <div class="stat-label">Labour Care</div>
          </div>
          <div class="stat-card info">
            <div class="stat-number" id="postnatalPatients">0</div>
            <div class="stat-label">Postnatal Care</div>
          </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center p-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Loading dashboard...</p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" style="display: none;">


      <!-- Analysis Sections -->
      <div class="analytics-section mb-4">
        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-heartbeat"></i> ANC Analysis</h5>
              <div id="ancAnalysis"></div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-baby"></i> Postnatal Analysis</h5>
              <div id="postnatalAnalysis"></div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-12 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-user-plus"></i> Patient Analysis</h5>
              <div id="patientAnalysis"></div>
            </div>
          </div>
        </div>
      </div>

            </div>
          </div>
        </div>


  <footer class="footer">
    <p>&copy; 2025 Maternal & Child Health Care System ‚Äî Designed for clinical excellence - Powered by Jhpiego Myanmar</p>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/firebase.js"></script>
  <script src="languages/language-manager.js"></script>
  
  <script>
    // Global variables
    let currentUser = null;
    let userRole = null;
    let userTownship = null;

    // Initialize dashboard
    async function initializeDashboard() {
      try {
        console.log('Initializing dashboard...');
        
        // Get current user
        currentUser = firebase.auth().currentUser;
        console.log('Current user:', currentUser ? currentUser.uid : 'No user');
        
        if (!currentUser) {
          console.log('No user found, redirecting to login');
          window.location.href = 'login.html';
          return;
        }

        // Load user profile
        console.log('Loading user profile...');
        const userDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
        if (!userDoc.exists) {
          throw new Error('User profile not found');
        }

        const userData = userDoc.data();
        userRole = userData.role;
        userTownship = userData.township;
        
        console.log('User role:', userRole);
        console.log('User township:', userTownship);

        // Update dashboard title and subtitle
        updateDashboardHeader();

        // Load dashboard data based on role
        console.log('Loading dashboard data...');
        await loadDashboardData();

        // Hide loading, show content
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';
        
        console.log('Dashboard initialization complete');

      } catch (error) {
        console.error('Error initializing dashboard:', error);
        document.getElementById('loadingState').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            Error loading dashboard: ${error.message}
          </div>
        `;
      }
    }

    // Update dashboard header based on user role
    function updateDashboardHeader() {
      const title = document.getElementById('dashboardTitle');
      const subtitle = document.getElementById('dashboardSubtitle');

      switch (userRole) {
        case 'Super Admin':
          title.innerHTML = '<i class="fas fa-crown"></i> Super Admin Dashboard';
          subtitle.textContent = 'Global overview and system management';
          break;
        case 'TMO':
          title.innerHTML = '<i class="fas fa-hospital"></i> TMO Dashboard';
          subtitle.textContent = `Township: ${userTownship || 'Not set'}`;
          break;
        case 'Midwife':
        case 'midwife':
          title.innerHTML = '<i class="fas fa-user-nurse"></i> Midwife Dashboard';
          subtitle.textContent = 'Your patient performance and statistics';
          break;
        default:
          title.innerHTML = '<i class="fas fa-chart-line"></i> Dashboard';
          subtitle.textContent = 'Welcome to your dashboard';
      }
    }

    // Load dashboard data based on user role
    async function loadDashboardData() {
      try {
        // Load statistics
        await loadStatistics();
        
        // Load comprehensive dashboard content
        await loadDashboardContent();
      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }

    // Load key statistics
    async function loadStatistics() {
      try {
        let stats = {};

        if (userRole === 'Super Admin' || userRole === 'admin') {
          // Global statistics
          stats = await getGlobalStatistics();
        } else if (userRole === 'TMO') {
          // Township statistics
          stats = await getTownshipStatistics(userTownship);
        } else {
          // Personal statistics
          stats = await getPersonalStatistics(currentUser.uid);
        }

        displayStatistics(stats);

      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    // Get global statistics (Super Admin)
    async function getGlobalStatistics() {
      try {
        console.log('Loading global statistics...');
        const patientsSnap = await firebase.firestore().collection('patients').get();
        console.log('Patients found:', patientsSnap.size);

        let totalPatients = 0;
        let antenatalPatients = 0;
        let labourPatients = 0;
        let postnatalPatients = 0;

        patientsSnap.forEach(doc => {
          const data = doc.data();
          totalPatients++;
          
          // Handle new status system
          const status = data.status || data.treatmentStatus || 'Antenatal Care';
          console.log(`Patient ${doc.id}: status = "${status}"`);
          
          if (status.toLowerCase().includes('antenatal')) {
            antenatalPatients++;
          } else if (status.toLowerCase().includes('labour')) {
            labourPatients++;
          } else if (status.toLowerCase().includes('postnatal') || status.toLowerCase().includes('postpartum')) {
            postnatalPatients++;
          } else {
            // Default to antenatal for unknown statuses
            antenatalPatients++;
          }
        });

        const stats = {
          totalPatients,
          antenatalPatients,
          labourPatients,
          postnatalPatients
        };
        
        console.log('Calculated stats:', stats);
        return stats;
      } catch (error) {
        console.error('Error in getGlobalStatistics:', error);
        return {
          totalPatients: 0,
          antenatalPatients: 0,
          labourPatients: 0,
          postnatalPatients: 0
        };
      }
    }

    // Get township statistics (TMO)
    async function getTownshipStatistics(township) {
      const patientsSnap = await firebase.firestore()
        .collection('patients')
        .where('township', '==', township)
        .get();

      let totalPatients = 0;
      let antenatalPatients = 0;
      let labourPatients = 0;
      let postnatalPatients = 0;

      patientsSnap.forEach(doc => {
        const data = doc.data();
        totalPatients++;
        
        // Handle new status system
        const status = data.status || data.treatmentStatus || 'Antenatal Care';
        
        if (status.toLowerCase().includes('antenatal')) {
          antenatalPatients++;
        } else if (status.toLowerCase().includes('labour')) {
          labourPatients++;
        } else if (status.toLowerCase().includes('postnatal') || status.toLowerCase().includes('postpartum')) {
          postnatalPatients++;
        } else {
          // Default to antenatal for unknown statuses
          antenatalPatients++;
        }
      });

      return {
        totalPatients,
        antenatalPatients,
        labourPatients,
        postnatalPatients
      };
    }

    // Get personal statistics (Midwife)
    async function getPersonalStatistics(userId) {
      try {
        console.log('Loading personal statistics for user:', userId);
        
        // Try multiple queries to find patients
        let patientsSnap;
        
        // First try: createdBy field
        patientsSnap = await firebase.firestore()
          .collection('patients')
          .where('createdBy', '==', userId)
          .get();
        
        console.log('Patients found with createdBy:', patientsSnap.size);
        
        // If no patients found, try created_by field (snake_case)
        if (patientsSnap.size === 0) {
          patientsSnap = await firebase.firestore()
            .collection('patients')
            .where('created_by', '==', userId)
            .get();
          console.log('Patients found with created_by:', patientsSnap.size);
        }
        
        // If still no patients, try without user filter (for testing)
        if (patientsSnap.size === 0) {
          console.log('No patients found with user filter, trying all patients...');
          patientsSnap = await firebase.firestore()
            .collection('patients')
            .get();
          console.log('Total patients in database:', patientsSnap.size);
        }

        let totalPatients = 0;
        let antenatalPatients = 0;
        let labourPatients = 0;
        let postnatalPatients = 0;

        patientsSnap.forEach(doc => {
          const data = doc.data();
          console.log(`Patient ${doc.id}:`, {
            name: data.name,
            status: data.status,
            treatmentStatus: data.treatmentStatus,
            createdBy: data.createdBy,
            created_by: data.created_by
          });
          
          totalPatients++;
          
          // Handle new status system
          const status = data.status || data.treatmentStatus || 'Antenatal Care';
          console.log(`Patient ${doc.id}: final status = "${status}"`);
          
          if (status.toLowerCase().includes('antenatal')) {
            antenatalPatients++;
          } else if (status.toLowerCase().includes('labour')) {
            labourPatients++;
          } else if (status.toLowerCase().includes('postnatal') || status.toLowerCase().includes('postpartum')) {
            postnatalPatients++;
          } else {
            // Default to antenatal for unknown statuses
            antenatalPatients++;
          }
        });

        const stats = {
          totalPatients,
          antenatalPatients,
          labourPatients,
          postnatalPatients
        };
        
        console.log('Personal statistics calculated:', stats);
        return stats;
      } catch (error) {
        console.error('Error in getPersonalStatistics:', error);
        return {
          totalPatients: 0,
          antenatalPatients: 0,
          labourPatients: 0,
          postnatalPatients: 0
        };
      }
    }

    // Display statistics in cards
    function displayStatistics(stats) {
      // Update the existing score cards with new data
      document.getElementById('totalPatients').textContent = stats.totalPatients || 0;
      document.getElementById('antenatalPatients').textContent = stats.antenatalPatients || 0;
      document.getElementById('labourPatients').textContent = stats.labourPatients || 0;
      document.getElementById('postnatalPatients').textContent = stats.postnatalPatients || 0;
    }

    // Load comprehensive dashboard content
    async function loadDashboardContent() {
      try {
        // Load new analytics
        await loadNewAnalytics();
        
      } catch (error) {
        console.error('Error loading dashboard content:', error);
      }
    }

    // Load new analytics
    async function loadNewAnalytics() {
      try {
        // Load ANC analysis
        await loadANCAnalysis();
        
        // Load Postnatal analysis
        await loadPostnatalAnalysis();
        
        // Load Patient analysis
        await loadPatientAnalysis();
        
      } catch (error) {
        console.error('Error loading new analytics:', error);
      }
    }

    // Load ANC Analysis
    async function loadANCAnalysis() {
      try {
        const ancData = await getANCAnalysis();
        const container = document.getElementById('ancAnalysis');
        
        let html = '<div class="analytics-content">';
        html += `<div class="analytics-item"><span class="analytics-label">Early ANC (1st trimester):</span><span class="analytics-value">${ancData.earlyANC}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">At least 4 ANC visits:</span><span class="analytics-value">${ancData.atLeast4ANC}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">TT/TD completion:</span><span class="analytics-value">${ancData.ttTdCompletion}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Anemia cases:</span><span class="analytics-value">${ancData.anemiaCases}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Infection cases:</span><span class="analytics-value">${ancData.infectionCases}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Anemia treated:</span><span class="analytics-value">${ancData.anemiaTreated}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">High-risk pregnancies:</span><span class="analytics-value">${ancData.highRiskPregnancies}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Referred cases:</span><span class="analytics-value">${ancData.referredCases}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Next pregnancy within 24 months:</span><span class="analytics-value">${ancData.nextPregnancy24Months}</span></div>`;
        html += '</div>';
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading ANC analysis:', error);
        document.getElementById('ancAnalysis').innerHTML = '<p class="text-muted">Data not available</p>';
      }
    }

    // Load Postnatal Analysis
    async function loadPostnatalAnalysis() {
      try {
        const postnatalData = await getPostnatalAnalysis();
        const container = document.getElementById('postnatalAnalysis');
        
        let html = '<div class="analytics-content">';
        html += `<div class="analytics-item"><span class="analytics-label">Total postnatal visits:</span><span class="analytics-value">${postnatalData.totalVisits}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Patients with danger signs:</span><span class="analytics-value">${postnatalData.dangerSigns}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Vitamin B1 given:</span><span class="analytics-value">${postnatalData.vitaminB1}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Vitamin A given:</span><span class="analytics-value">${postnatalData.vitaminA}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Iron & Folic Acid:</span><span class="analytics-value">${postnatalData.ironFolicAcid}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Contraception provided:</span><span class="analytics-value">${postnatalData.contraception}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Referrals made:</span><span class="analytics-value">${postnatalData.referrals}</span></div>`;
        html += '</div>';
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading postnatal analysis:', error);
        document.getElementById('postnatalAnalysis').innerHTML = '<p class="text-muted">Data not available</p>';
      }
    }

    // Load Patient Analysis
    async function loadPatientAnalysis() {
      try {
        const patientData = await getPatientAnalysis();
        const container = document.getElementById('patientAnalysis');
        
        let html = '<div class="analytics-content">';
        html += `<div class="analytics-item"><span class="analytics-label">Total registered patients:</span><span class="analytics-value">${patientData.totalPatients}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Average age:</span><span class="analytics-value">${patientData.averageAge} years</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Primipara (0):</span><span class="analytics-value">${patientData.primipara}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Multipara (1+):</span><span class="analytics-value">${patientData.multipara}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">High-risk pregnancies:</span><span class="analytics-value">${patientData.highRisk}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Early ANC visits:</span><span class="analytics-value">${patientData.earlyANC}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Patients with complications:</span><span class="analytics-value">${patientData.complications}</span></div>`;
        html += '</div>';
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading patient analysis:', error);
        document.getElementById('patientAnalysis').innerHTML = '<p class="text-muted">Data not available</p>';
      }
    }

    // Get ANC Analysis Data
    async function getANCAnalysis() {
      try {
        console.log('Loading ANC analysis...');
        let patientsSnap;
        
        if (userRole === 'Super Admin' || userRole === 'admin') {
          patientsSnap = await firebase.firestore().collection('patients').get();
        } else if (userRole === 'TMO') {
          patientsSnap = await firebase.firestore().collection('patients').where('township', '==', userTownship).get();
        } else {
          // Try multiple queries for midwife
          patientsSnap = await firebase.firestore().collection('patients').where('createdBy', '==', currentUser.uid).get();
          
          if (patientsSnap.size === 0) {
            patientsSnap = await firebase.firestore().collection('patients').where('created_by', '==', currentUser.uid).get();
          }
          
          if (patientsSnap.size === 0) {
            patientsSnap = await firebase.firestore().collection('patients').get();
          }
        }
        
        console.log('Patients for ANC analysis:', patientsSnap.size);

        let earlyANC = 0;
        let atLeast4ANC = 0;
        let ttTdCompletion = 0;
        let anemiaCases = 0;
        let infectionCases = 0;
        let anemiaTreated = 0;
        let highRiskPregnancies = 0;
        let referredCases = 0;
        let nextPregnancy24Months = 0;

        // Process each patient to get ANC data
        for (const doc of patientsSnap.docs) {
          const data = doc.data();
          
          // Check early ANC visits
          if (data.early_anc_visits && parseInt(data.early_anc_visits) > 0) {
            earlyANC++;
          }
          
          // Check if high risk pregnancy
          if (data.high_risk_pregnancy === 'Yes' || data.highRiskPregnancy === 'Yes') {
            highRiskPregnancies++;
          }
          
          // Get ANC visits data
          try {
            const ancVisitsSnap = await firebase.firestore()
              .collection('patients')
              .doc(doc.id)
              .collection('antenatal_visits')
              .get();
            
            if (ancVisitsSnap.size >= 4) {
              atLeast4ANC++;
            }
            
            // Check for anemia, infections, treatments, referrals in visits
            ancVisitsSnap.forEach(visitDoc => {
              const visitData = visitDoc.data();
              
              if (visitData.hemoglobin && parseInt(visitData.hemoglobin) < 11) {
                anemiaCases++;
              }
              
              if (visitData.treatment && visitData.treatment.toLowerCase().includes('iron')) {
                anemiaTreated++;
              }
              
              if (visitData.referral === 'Yes' || visitData.referred === 'Yes') {
                referredCases++;
              }
              
              // Check for infections (HIV, Syphilis, Hepatitis B, Hepatitis C)
              if (visitData.hiv === 'Positive' || visitData.syphilis === 'Positive' || 
                  visitData.hepatitisB === 'Positive' || visitData.hepatitisC === 'Positive') {
                infectionCases++;
              }
            });
          } catch (ancError) {
            console.log(`No ANC visits for patient ${doc.id}`);
          }
        }

        return {
          earlyANC,
          atLeast4ANC,
          ttTdCompletion, // This would need specific TT/TD tracking
          anemiaCases,
          infectionCases,
          anemiaTreated,
          highRiskPregnancies,
          referredCases,
          nextPregnancy24Months // This would need specific tracking
        };
      } catch (error) {
        console.error('Error getting ANC analysis:', error);
        return {
          earlyANC: 0, atLeast4ANC: 0, ttTdCompletion: 0, anemiaCases: 0,
          infectionCases: 0, anemiaTreated: 0, highRiskPregnancies: 0,
          referredCases: 0, nextPregnancy24Months: 0
        };
      }
    }

    // Get Postnatal Analysis Data
    async function getPostnatalAnalysis() {
      try {
        let patientsSnap;
        
        if (userRole === 'Super Admin' || userRole === 'admin') {
          patientsSnap = await firebase.firestore().collection('patients').get();
        } else if (userRole === 'TMO') {
          patientsSnap = await firebase.firestore().collection('patients').where('township', '==', userTownship).get();
        } else {
          // Try multiple queries for midwife
          patientsSnap = await firebase.firestore().collection('patients').where('createdBy', '==', currentUser.uid).get();
          
          if (patientsSnap.size === 0) {
            patientsSnap = await firebase.firestore().collection('patients').where('created_by', '==', currentUser.uid).get();
          }
          
          if (patientsSnap.size === 0) {
            patientsSnap = await firebase.firestore().collection('patients').get();
          }
        }

        let totalVisits = 0;
        let dangerSigns = 0;
        let vitaminB1 = 0;
        let vitaminA = 0;
        let ironFolicAcid = 0;
        let contraception = 0;
        let referrals = 0;

        // Process each patient to get postnatal data
        for (const doc of patientsSnap.docs) {
          const data = doc.data();
          
          // Get postnatal visits data
          try {
            const postnatalVisitsSnap = await firebase.firestore()
              .collection('patients')
              .doc(doc.id)
              .collection('postpartum_visits')
              .get();
            
            totalVisits += postnatalVisitsSnap.size;
            
            postnatalVisitsSnap.forEach(visitDoc => {
              const visitData = visitDoc.data();
              
              // Check for danger signs
              if (visitData.dangerSigns && Object.keys(visitData.dangerSigns).some(key => visitData.dangerSigns[key] === true)) {
                dangerSigns++;
              }
              
              // Check for medications
              if (visitData.vitaminB1 === 'Yes') vitaminB1++;
              if (visitData.vitaminA === 'Yes') vitaminA++;
              if (visitData.ironFolicAcid === 'Yes') ironFolicAcid++;
              
              // Check for contraception
              if (visitData.contraceptionMethod && visitData.contraceptionMethod !== '') {
                contraception++;
              }
              
              // Check for referrals
              if (visitData.referral === 'Yes' || visitData.referred === 'Yes') {
                referrals++;
              }
            });
          } catch (postnatalError) {
            console.log(`No postnatal visits for patient ${doc.id}`);
          }
        }

        return {
          totalVisits,
          dangerSigns,
          vitaminB1,
          vitaminA,
          ironFolicAcid,
          contraception,
          referrals
        };
      } catch (error) {
        console.error('Error getting postnatal analysis:', error);
        return {
          totalVisits: 0, dangerSigns: 0, vitaminB1: 0, vitaminA: 0,
          ironFolicAcid: 0, contraception: 0, referrals: 0
        };
      }
    }

    // Get Patient Analysis Data
    async function getPatientAnalysis() {
      try {
        let patientsSnap;
        
        if (userRole === 'Super Admin' || userRole === 'admin') {
          patientsSnap = await firebase.firestore().collection('patients').get();
        } else if (userRole === 'TMO') {
          patientsSnap = await firebase.firestore().collection('patients').where('township', '==', userTownship).get();
        } else {
          // Try multiple queries for midwife
          patientsSnap = await firebase.firestore().collection('patients').where('createdBy', '==', currentUser.uid).get();
          
          if (patientsSnap.size === 0) {
            patientsSnap = await firebase.firestore().collection('patients').where('created_by', '==', currentUser.uid).get();
          }
          
          if (patientsSnap.size === 0) {
            patientsSnap = await firebase.firestore().collection('patients').get();
          }
        }

        let totalPatients = 0;
        let totalAge = 0;
        let primipara = 0;
        let multipara = 0;
        let highRisk = 0;
        let earlyANC = 0;
        let complications = 0;

        patientsSnap.forEach(doc => {
          const data = doc.data();
          totalPatients++;
          
          // Calculate average age
          if (data.age) {
            totalAge += parseInt(data.age);
          }
          
          // Check parity
          if (data.parity === 0 || data.parity === '0') {
            primipara++;
          } else if (data.parity && parseInt(data.parity) > 0) {
            multipara++;
          }
          
          // Check high risk pregnancy
          if (data.high_risk_pregnancy === 'Yes' || data.highRiskPregnancy === 'Yes') {
            highRisk++;
          }
          
          // Check early ANC visits
          if (data.early_anc_visits && parseInt(data.early_anc_visits) > 0) {
            earlyANC++;
          }
          
          // Check for complications (from risk factors)
          if (data.risk_factors) {
            if (Array.isArray(data.risk_factors) && data.risk_factors.length > 0) {
              complications++;
            } else if (typeof data.risk_factors === 'string' && data.risk_factors.trim() !== '') {
              complications++;
            }
          }
        });

        return {
          totalPatients,
          averageAge: totalPatients > 0 ? Math.round(totalAge / totalPatients) : 0,
          primipara,
          multipara,
          highRisk,
          earlyANC,
          complications
        };
      } catch (error) {
        console.error('Error getting patient analysis:', error);
        return {
          totalPatients: 0, averageAge: 0, primipara: 0, multipara: 0,
          highRisk: 0, earlyANC: 0, complications: 0
        };
      }
    }

    // Go back function
    function goBack() {
      window.history.back();
    }

    // Language switching function
    function switchLanguage(lang) {
      if (languageManager) {
        languageManager.switchLanguage(lang);
      }
    }

    // Initialize dashboard when page loads
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        initializeDashboard();
      } else {
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>
