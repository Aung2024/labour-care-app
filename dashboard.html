<!DOCTYPE html>
<html lang="en">
<head>
  <title>Labour Care Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="languages/language-switcher.css" />
  
  <!-- Chart.js for beautiful charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    .dashboard-container {
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
    }
    
    .dashboard-header {
      background: linear-gradient(135deg, #1e40af, #3b82f6);
      color: white;
      padding: 30px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(30, 64, 175, 0.3);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card.primary { border-left: 5px solid #3b82f6; }
    .stat-card.success { border-left: 5px solid #10b981; }
    .stat-card.warning { border-left: 5px solid #f59e0b; }
    .stat-card.danger { border-left: 5px solid #ef4444; }
    .stat-card.info { border-left: 5px solid #06b6d4; }
    .stat-card.info .stat-number { color: #06b6d4; }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .stat-label {
      color: #6b7280;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Clinical Tables - Premium Design */
    .clinical-table-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      border: 1px solid #f1f5f9;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .clinical-table-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    .table-header {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 20px 25px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .table-header h5 {
      color: #1e293b;
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
    }
    
    .table-header h5 i {
      margin-right: 10px;
      color: #3b82f6;
    }
    
    .table-actions .btn {
      border-radius: 8px;
      font-weight: 500;
      padding: 8px 16px;
      transition: all 0.2s ease;
    }
    
    .table-actions .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    /* Clinical Table Styling */
    .clinical-table {
      margin: 0;
      font-size: 0.9rem;
    }
    
    .clinical-table thead th {
      background: #f8fafc;
      border: none;
      color: #475569;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 15px 12px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .clinical-table tbody td {
      padding: 12px;
      border: none;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
      color: #334155;
    }
    
    .clinical-table tbody tr:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      transform: scale(1.01);
      transition: all 0.2s ease;
    }
    
    /* Action Buttons */
    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 2px;
    }
    
    .btn-edit {
      background: #3b82f6;
      color: white;
    }
    
    .btn-edit:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-view {
      background: #10b981;
      color: white;
    }
    
    .btn-view:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .btn-delete {
      background: #ef4444;
      color: white;
    }
    
    .btn-delete:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    /* Status Badges */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-active {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-birthed {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .status-transferred {
      background: #fef3c7;
      color: #92400e;
    }
    
    .status-other {
      background: #f3e8ff;
      color: #7c3aed;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .table-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .clinical-table {
        font-size: 0.8rem;
      }
      
      .clinical-table thead th,
      .clinical-table tbody td {
        padding: 8px 6px;
      }
    }
    
    /* Premium Enhancements */
    .clinical-table tbody tr {
      transition: all 0.2s ease;
    }
    
    .clinical-table tbody tr:nth-child(even) {
      background: #fafbfc;
    }
    
    .clinical-table tbody tr:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      transform: scale(1.005);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    /* Empty state styling */
    .text-muted {
      color: #94a3b8 !important;
      font-style: italic;
    }
    
    /* Loading states */
    .table-loading {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }
    
    .table-loading i {
      font-size: 2rem;
      margin-bottom: 15px;
      color: #3b82f6;
    }
    
    /* Sticky Back Button */
    .sticky-back-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 15px 20px;
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
      transition: all 0.3s ease;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sticky-back-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(59, 130, 246, 0.4);
      background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%);
    }
    
    /* Footer Sticky */
    .footer {
      position: sticky;
      bottom: 0;
      background: white;
      border-top: 1px solid #e2e8f0;
      padding: 20px 0;
      margin-top: auto;
    }
    
    /* Main container for sticky footer */
    .main-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .content-wrapper {
      flex: 1;
    }
    
    /* Chart Cards */
    .chart-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      border: 1px solid #f1f5f9;
      height: 100%;
      transition: all 0.3s ease;
    }
    
    .chart-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    .chart-card h5 {
      color: #1e293b;
      font-size: 1.1rem;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .chart-card h5 i {
      margin-right: 10px;
      color: #3b82f6;
    }
    
    .chart-card canvas {
      max-height: 300px;
      width: 100% !important;
    }
    
    /* Analytics Cards */
    .analytics-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      border: 1px solid #f1f5f9;
      height: 100%;
      transition: all 0.3s ease;
    }
    
    .analytics-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    .analytics-card h5 {
      color: #1e293b;
      font-size: 1.1rem;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .analytics-card h5 i {
      margin-right: 10px;
      color: #3b82f6;
    }
    
    /* Analytics Content */
    .analytics-content {
      font-size: 0.9rem;
      color: #6b7280;
    }
    
    .analytics-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .analytics-item:last-child {
      border-bottom: none;
    }
    
    .analytics-label {
      font-weight: 500;
      color: #374151;
    }
    
    .analytics-value {
      font-weight: 600;
      color: #1f2937;
    }
  </style>
</head>
<body>
  <!-- Sticky Back Button -->
  <button class="sticky-back-btn" onclick="goBack()">
    <i class="fas fa-arrow-left"></i>
    Back
  </button>

  <!-- Professional Header -->
  <div class="medical-header">
    <div class="header-content">
      <div class="header-left">
        <div class="app-title">üë©‚Äç‚öïÔ∏è <span data-i18n="appTitle">Labour Care Guide</span></div>
        <div class="page-subtitle"><span data-i18n="dashboard">Dashboard</span></div>
      </div>
      <div class="header-right">
        <div class="language-switcher">
          <div class="language-switcher-container">
            <button class="lang-btn" data-lang="en" onclick="switchLanguage('en')">EN</button>
            <button class="lang-btn" data-lang="my" onclick="switchLanguage('my')">MY</button>
          </div>
        </div>
        <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
          <i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <div class="content-wrapper">
      <div class="dashboard-container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
          <h1><i class="fas fa-chart-line"></i> <span id="dashboardTitle">Dashboard</span></h1>
          <p id="dashboardSubtitle">Welcome to your personalized dashboard</p>
        </div>

        <!-- Key Statistics -->
        <div class="stats-grid" id="statsGrid">
          <!-- Stats will be populated here -->
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center p-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Loading dashboard...</p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" style="display: none;">


      <!-- Charts Section -->
      <div class="charts-section mb-4">
        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="chart-card">
              <h5><i class="fas fa-chart-pie"></i> Patient Status Distribution</h5>
              <canvas id="patientStatusChart" width="400" height="200"></canvas>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="chart-card">
              <h5><i class="fas fa-chart-bar"></i> Monthly Patient Trends</h5>
              <canvas id="monthlyTrendsChart" width="400" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Analytics Section -->
      <div class="analytics-section mb-4">
        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-users"></i> Patient Demographics</h5>
              <div id="patientDemographics"></div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-clock"></i> Labour Duration Analysis</h5>
              <div id="labourDurationAnalysis"></div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-baby"></i> Birth Outcomes</h5>
              <div id="birthOutcomes"></div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-hospital"></i> Transfer Analysis</h5>
              <div id="transferAnalysis"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Clinical Data Tables Section -->
      <div class="clinical-tables-section">
        
        <!-- Baby Information Table -->
        <div class="clinical-table-card mb-4">
          <div class="table-header">
            <h5><i class="fas fa-baby"></i> Baby Information & Outcomes</h5>
            <div class="table-actions">
              <button class="btn btn-sm btn-outline-primary" onclick="refreshBabyTable()">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover clinical-table" id="babyTable">
              <thead class="table-light">
                <tr>
                  <th>Patient Name</th>
                  <th>Baby Name</th>
                  <th>Father Name</th>
                  <th>Birth Date</th>
                  <th>Birth Time</th>
                  <th>Birth Weight</th>
                  <th>Gender</th>
                  <th>APGAR Score</th>
                  <th>Complications</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="babyTableBody">
                <!-- Baby data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Transfer Information Table -->
        <div class="clinical-table-card mb-4">
          <div class="table-header">
            <h5><i class="fas fa-ambulance"></i> Transfer Information</h5>
            <div class="table-actions">
              <button class="btn btn-sm btn-outline-primary" onclick="refreshTransferTable()">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover clinical-table" id="transferTable">
              <thead class="table-light">
                <tr>
                  <th>Patient Name</th>
                  <th>Transfer Date</th>
                  <th>Transfer Time</th>
                  <th>Transfer Reason</th>
                  <th>Destination</th>
                  <th>Transfer Type</th>
                  <th>Notes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="transferTableBody">
                <!-- Transfer data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Other Outcomes Table -->
        <div class="clinical-table-card mb-4">
          <div class="table-header">
            <h5><i class="fas fa-ellipsis-h"></i> Other Outcomes</h5>
            <div class="table-actions">
              <button class="btn btn-sm btn-outline-primary" onclick="refreshOtherOutcomesTable()">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover clinical-table" id="otherOutcomesTable">
              <thead class="table-light">
                <tr>
                  <th>Patient Name</th>
                  <th>Age</th>
                  <th>Outcome Date</th>
                  <th>Outcome Type</th>
                  <th>Reason</th>
                  <th>Notes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="otherOutcomesTableBody">
                <!-- Other outcomes data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Baby Edit Modal -->
  <div class="modal fade" id="babyEditModal" tabindex="-1" aria-labelledby="babyEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="babyEditModalLabel">Edit Baby Information</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="babyEditForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="babyName" class="form-label">Baby Name</label>
                <input type="text" class="form-control" id="babyName" name="babyName" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="fatherName" class="form-label">Father Name</label>
                <input type="text" class="form-control" id="fatherName" name="fatherName" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="birthDate" class="form-label">Birth Date</label>
                <input type="date" class="form-control" id="birthDate" name="birthDate" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="birthTime" class="form-label">Birth Time</label>
                <input type="time" class="form-control" id="birthTime" name="birthTime" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="birthWeight" class="form-label">Birth Weight (kg)</label>
                <input type="number" step="0.1" class="form-control" id="birthWeight" name="birthWeight" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="gender" class="form-label">Gender</label>
                <select class="form-control" id="gender" name="gender" required>
                  <option value="">Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="apgarScore" class="form-label">APGAR Score</label>
                <input type="number" min="0" max="10" class="form-control" id="birthWeight" name="apgarScore" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="complications" class="form-label">Complications</label>
                <textarea class="form-control" id="complications" name="complications" rows="2"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveBabyInfo()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Transfer Edit Modal -->
  <div class="modal fade" id="transferEditModal" tabindex="-1" aria-labelledby="transferEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="transferEditModalLabel">Edit Transfer Information</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="transferEditForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="transferDate" class="form-label">Transfer Date</label>
                <input type="date" class="form-control" id="transferDate" name="transferDate" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="transferTime" class="form-label">Transfer Time</label>
                <input type="time" class="form-control" id="transferTime" name="transferTime" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="transferReason" class="form-label">Transfer Reason</label>
                <input type="text" class="form-control" id="transferReason" name="transferReason" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="destination" class="form-label">Destination</label>
                <input type="text" class="form-control" id="destination" name="destination" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="transferType" class="form-label">Transfer Type</label>
                <select class="form-control" id="transferType" name="transferType" required>
                  <option value="">Select Transfer Type</option>
                  <option value="emergency">Emergency</option>
                  <option value="planned">Planned</option>
                  <option value="referral">Referral</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="transferNotes" class="form-label">Notes</label>
                <textarea class="form-control" id="transferNotes" name="transferNotes" rows="2"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveTransferInfo()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Other Outcomes Edit Modal -->
  <div class="modal fade" id="otherOutcomesEditModal" tabindex="-1" aria-labelledby="otherOutcomesEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="otherOutcomesEditModalLabel">Edit Other Outcome Information</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="otherOutcomesEditForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="outcomeDate" class="form-label">Outcome Date</label>
                <input type="date" class="form-control" id="outcomeDate" name="outcomeDate" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="outcomeTime" class="form-label">Outcome Time</label>
                <input type="time" class="form-control" id="outcomeTime" name="outcomeTime" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="outcomeType" class="form-label">Outcome Type</label>
                <input type="text" class="form-control" id="outcomeType" name="outcomeType" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="outcomeReason" class="form-label">Reason</label>
                <input type="text" class="form-control" id="outcomeReason" name="outcomeReason" required>
              </div>
            </div>
            <div class="row">
              <div class="col-12 mb-3">
                <label for="outcomeNotes" class="form-label">Notes</label>
                <textarea class="form-control" id="outcomeNotes" name="outcomeNotes" rows="3"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveOtherOutcomeInfo()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>&copy; 2025 Maternal & Child Health Care System ‚Äî Designed for clinical excellence - Powered by Jhpiego Myanmar</p>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/firebase.js"></script>
  <script src="languages/language-manager.js"></script>
  
  <script>
    // Global variables
    let currentUser = null;
    let userRole = null;
    let userTownship = null;

    // Initialize dashboard
    async function initializeDashboard() {
      try {
        // Get current user
        currentUser = firebase.auth().currentUser;
        if (!currentUser) {
          window.location.href = 'login.html';
          return;
        }

        // Load user profile
        const userDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
        if (!userDoc.exists) {
          throw new Error('User profile not found');
        }

        const userData = userDoc.data();
        userRole = userData.role;
        userTownship = userData.township;

        // Update dashboard title and subtitle
        updateDashboardHeader();

        // Load dashboard data based on role
        await loadDashboardData();

        // Hide loading, show content
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';

      } catch (error) {
        console.error('Error initializing dashboard:', error);
        document.getElementById('loadingState').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            Error loading dashboard: ${error.message}
          </div>
        `;
      }
    }

    // Update dashboard header based on user role
    function updateDashboardHeader() {
      const title = document.getElementById('dashboardTitle');
      const subtitle = document.getElementById('dashboardSubtitle');

      switch (userRole) {
        case 'Super Admin':
          title.innerHTML = '<i class="fas fa-crown"></i> Super Admin Dashboard';
          subtitle.textContent = 'Global overview and system management';
          break;
        case 'TMO':
          title.innerHTML = '<i class="fas fa-hospital"></i> TMO Dashboard';
          subtitle.textContent = `Township: ${userTownship || 'Not set'}`;
          break;
        case 'Midwife':
        case 'midwife':
          title.innerHTML = '<i class="fas fa-user-nurse"></i> Midwife Dashboard';
          subtitle.textContent = 'Your patient performance and statistics';
          break;
        default:
          title.innerHTML = '<i class="fas fa-chart-line"></i> Dashboard';
          subtitle.textContent = 'Welcome to your dashboard';
      }
    }

    // Load dashboard data based on user role
    async function loadDashboardData() {
      try {
        // Load statistics
        await loadStatistics();
        
        // Load comprehensive dashboard content
        await loadDashboardContent();
      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }

    // Load key statistics
    async function loadStatistics() {
      try {
        let stats = {};

        if (userRole === 'Super Admin' || userRole === 'admin') {
          // Global statistics
          stats = await getGlobalStatistics();
        } else if (userRole === 'TMO') {
          // Township statistics
          stats = await getTownshipStatistics(userTownship);
        } else {
          // Personal statistics
          stats = await getPersonalStatistics(currentUser.uid);
        }

        displayStatistics(stats);

      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    // Get global statistics (Super Admin)
    async function getGlobalStatistics() {
      const patientsSnap = await firebase.firestore().collection('patients').get();
      const usersSnap = await firebase.firestore().collection('users').get();

      let totalPatients = 0;
      let activePatients = 0;
      let birthedPatients = 0;
      let transferredPatients = 0;
      let otherOutcomes = 0;
      let totalUsers = 0;
      let pendingApprovals = 0;

      patientsSnap.forEach(doc => {
        const data = doc.data();
        totalPatients++;
        
        // Handle cases where treatmentStatus might be undefined/null
        const status = data.treatmentStatus || 'active'; // Default to active if no status
        
        switch (status) {
          case 'active':
            activePatients++;
            break;
          case 'birthed':
            birthedPatients++;
            break;
          case 'transferred':
            transferredPatients++;
            break;
          case 'other':
            otherOutcomes++;
            break;
          default:
            // If status is unknown, count as active
            activePatients++;
            break;
        }
      });

      // Ensure total equals sum of all statuses
      const calculatedTotal = activePatients + birthedPatients + transferredPatients + otherOutcomes;
      if (calculatedTotal !== totalPatients) {
        console.warn('Statistics mismatch detected. Recalculating total...');
        totalPatients = calculatedTotal;
      }

      usersSnap.forEach(doc => {
        const data = doc.data();
        if (data.status === 'pending' || data.approved === false) {
          pendingApprovals++;
        }
        totalUsers++;
      });

      return {
        totalPatients,
        activePatients,
        birthedPatients,
        transferredPatients,
        otherOutcomes,
        totalUsers,
        pendingApprovals
      };
    }

    // Get township statistics (TMO)
    async function getTownshipStatistics(township) {
      const patientsSnap = await firebase.firestore()
        .collection('patients')
        .where('township', '==', township)
        .get();

      let totalPatients = 0;
      let activePatients = 0;
      let birthedPatients = 0;
      let transferredPatients = 0;
      let otherOutcomes = 0;

      patientsSnap.forEach(doc => {
        const data = doc.data();
        totalPatients++;
        
        // Handle cases where treatmentStatus might be undefined/null
        const status = data.treatmentStatus || 'active'; // Default to active if no status
        
        switch (status) {
          case 'active':
            activePatients++;
            break;
          case 'birthed':
            birthedPatients++;
            break;
          case 'transferred':
            transferredPatients++;
            break;
          case 'other':
            otherOutcomes++;
            break;
          default:
            // If status is unknown, count as active
            activePatients++;
            break;
        }
      });

      // Ensure total equals sum of all statuses
      const calculatedTotal = activePatients + birthedPatients + transferredPatients + otherOutcomes;
      if (calculatedTotal !== totalPatients) {
        console.warn('Statistics mismatch detected. Recalculating total...');
        totalPatients = calculatedTotal;
      }

      return {
        totalPatients,
        activePatients,
        birthedPatients,
        transferredPatients,
        otherOutcomes
      };
    }

    // Get personal statistics (Midwife)
    async function getPersonalStatistics(userId) {
      const patientsSnap = await firebase.firestore()
        .collection('patients')
        .where('createdBy', '==', userId)
        .get();

      let totalPatients = 0;
      let activePatients = 0;
      let birthedPatients = 0;
      let transferredPatients = 0;
      let otherOutcomes = 0;

      patientsSnap.forEach(doc => {
        const data = doc.data();
        totalPatients++;
        
        // Handle cases where treatmentStatus might be undefined/null
        const status = data.treatmentStatus || 'active'; // Default to active if no status
        
        switch (status) {
          case 'active':
            activePatients++;
            break;
          case 'birthed':
            birthedPatients++;
            break;
          case 'transferred':
            transferredPatients++;
            break;
          case 'other':
            otherOutcomes++;
            break;
          default:
            // If status is unknown, count as active
            activePatients++;
            break;
        }
      });

      // Ensure total equals sum of all statuses
      const calculatedTotal = activePatients + birthedPatients + transferredPatients + otherOutcomes;
      if (calculatedTotal !== totalPatients) {
        console.warn('Statistics mismatch detected. Recalculating total...');
        totalPatients = calculatedTotal;
      }

      return {
        totalPatients,
        activePatients,
        birthedPatients,
        transferredPatients,
        otherOutcomes
      };
    }

    // Display statistics in cards
    function displayStatistics(stats) {
      const statsGrid = document.getElementById('statsGrid');
      
      let statsHTML = '';

      if (userRole === 'Super Admin' || userRole === 'admin') {
        statsHTML = `
          <div class="stat-card primary">
            <div class="stat-number">${stats.totalPatients}</div>
            <div class="stat-label">Total Patients</div>
          </div>
          <div class="stat-card success">
            <div class="stat-number">${stats.birthedPatients}</div>
            <div class="stat-label">Successful Births</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-number">${stats.transferredPatients}</div>
            <div class="stat-label">Transfers</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-number">${stats.pendingApprovals}</div>
            <div class="stat-label">Pending Approvals</div>
          </div>
        `;
      } else {
        statsHTML = `
          <div class="stat-card primary">
            <div class="stat-number">${stats.totalPatients}</div>
            <div class="stat-label">Total Patients</div>
          </div>
          <div class="stat-card success">
            <div class="stat-number">${stats.birthedPatients}</div>
            <div class="stat-label">Successful Births</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-number">${stats.transferredPatients}</div>
            <div class="stat-label">Transfers</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-number">${stats.activePatients}</div>
            <div class="stat-label">Active Cases</div>
          </div>
          <div class="stat-card info">
            <div class="stat-number">${stats.otherOutcomes}</div>
            <div class="stat-label">Other Outcomes</div>
          </div>
        `;
      }

      statsGrid.innerHTML = statsHTML;
    }

    // Load comprehensive dashboard content
    async function loadDashboardContent() {
      try {
        // Load charts
        await loadCharts();
        
        // Load analytics
        await loadAnalytics();
        
        // Load clinical tables
        await loadClinicalTables();
        
      } catch (error) {
        console.error('Error loading dashboard content:', error);
      }
    }

    // Load charts
    async function loadCharts() {
      try {
        // Patient Status Distribution Chart
        await createPatientStatusChart();
        
        // Monthly Trends Chart
        await createMonthlyTrendsChart();
        
      } catch (error) {
        console.error('Error loading charts:', error);
      }
    }

    // Create Patient Status Distribution Chart
    async function createPatientStatusChart() {
      try {
        const stats = await getCurrentStats();
        
        const ctx = document.getElementById('patientStatusChart').getContext('2d');
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Active', 'Birthed', 'Transferred', 'Other'],
            datasets: [{
              data: [stats.activePatients, stats.birthedPatients, stats.transferredPatients, stats.otherOutcomes],
              backgroundColor: ['#ef4444', '#10b981', '#f59e0b', '#06b6d4'],
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 20,
                  usePointStyle: true
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error creating patient status chart:', error);
      }
    }

    // Create Monthly Trends Chart
    async function createMonthlyTrendsChart() {
      try {
        const monthlyData = await getMonthlyTrends();
        
        const ctx = document.getElementById('monthlyTrendsChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: monthlyData.labels,
            datasets: [{
              label: 'New Patients',
              data: monthlyData.data,
              backgroundColor: '#3b82f6',
              borderColor: '#1e40af',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      } catch (error) {
        console.error('Error creating monthly trends chart:', error);
      }
    }

    // Load analytics data
    async function loadAnalytics() {
      try {
        // Patient Demographics
        await loadPatientDemographics();
        
        // Labour Duration Analysis
        await loadLabourDurationAnalysis();
        
        // Birth Outcomes
        await loadBirthOutcomes();
        
        // Transfer Analysis
        await loadTransferAnalysis();
        
      } catch (error) {
        console.error('Error loading analytics:', error);
      }
    }

    // Load clinical tables
    async function loadClinicalTables() {
      try {
        // Load baby information table
        await loadBabyTable();
        
        // Load transfer information table
        await loadTransferTable();
        
        // Load other outcomes table
        await loadOtherOutcomesTable();
        
      } catch (error) {
        console.error('Error loading clinical tables:', error);
      }
    }

    // Load Baby Information Table
    async function loadBabyTable() {
      try {
        const babyData = await getBabyData();
        const tbody = document.getElementById('babyTableBody');
        
        if (babyData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No baby information available</td></tr>';
          return;
        }
        
        let html = '';
        babyData.forEach(patient => {
          html += `
            <tr>
              <td><strong>${patient.name}</strong></td>
              <td>${patient.babyName || 'N/A'}</td>
              <td>${patient.fatherName || 'N/A'}</td>
              <td>${patient.birthDate || 'N/A'}</td>
              <td>${patient.birthTime || 'N/A'}</td>
              <td>${patient.birthWeight || 'N/A'}</td>
              <td>${patient.gender || 'N/A'}</td>
              <td>${patient.apgarScore || 'N/A'}</td>
              <td>${patient.complications || 'None'}</td>
              <td>
                <button class="action-btn btn-edit" onclick="editBabyInfo('${patient.id}')" title="Edit Baby Info">
                  <i class="fas fa-edit"></i>
                </button>
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
      } catch (error) {
        console.error('Error loading baby table:', error);
        document.getElementById('babyTableBody').innerHTML = '<tr><td colspan="10" class="text-center text-danger">Error loading data</td></tr>';
      }
    }

    // Load Transfer Information Table
    async function loadTransferTable() {
      try {
        const transferData = await getTransferData();
        const tbody = document.getElementById('transferTableBody');
        
        if (transferData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No transfer information available</td></tr>';
          return;
        }
        
        let html = '';
        transferData.forEach(patient => {
          html += `
            <tr>
              <td><strong>${patient.name}</strong></td>
              <td>${patient.transferDate || 'N/A'}</td>
              <td>${patient.transferTime || 'N/A'}</td>
              <td>${patient.transferReason || 'N/A'}</td>
              <td>${patient.destination || 'N/A'}</td>
              <td>${patient.transferType || 'N/A'}</td>
              <td>${patient.notes || 'None'}</td>
              <td>
                <button class="action-btn btn-edit" onclick="editTransferInfo('${patient.id}')" title="Edit Transfer Info">
                  <i class="fas fa-edit"></i>
                </button>
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
      } catch (error) {
        console.error('Error loading transfer table:', error);
        document.getElementById('transferTableBody').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>';
      }
    }

    // Load Other Outcomes Table
    async function loadOtherOutcomesTable() {
      try {
        const otherData = await getOtherOutcomesData();
        const tbody = document.getElementById('otherOutcomesTableBody');
        
        if (otherData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No other outcomes available</td></tr>';
          return;
        }
        
        let html = '';
        otherData.forEach(patient => {
          html += `
            <tr>
              <td><strong>${patient.name}</strong></td>
              <td>${patient.age}</td>
              <td>${patient.outcomeDate || 'N/A'}</td>
              <td>${patient.outcomeType || 'N/A'}</td>
              <td>${patient.reason || 'N/A'}</td>
              <td>${patient.notes || 'None'}</td>
              <td>
                <button class="action-btn btn-view" onclick="viewPatient('${patient.id}')" title="View Details">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn btn-edit" onclick="editPatient('${patient.id}')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
      } catch (error) {
        console.error('Error loading other outcomes table:', error);
        document.getElementById('otherOutcomesTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading data</td></tr>';
      }
    }

    // Get Baby Data
    async function getBabyData() {
      try {
        let patientsSnap;
        
        if (userRole === 'Super Admin' || userRole === 'admin') {
          patientsSnap = await firebase.firestore().collection('patients').get();
        } else if (userRole === 'TMO') {
          patientsSnap = await firebase.firestore().collection('patients').where('township', '==', userTownship).get();
        } else {
          patientsSnap = await firebase.firestore().collection('patients').where('createdBy', '==', currentUser.uid).get();
        }

        const babyData = [];
        
        // Process each patient to get baby information
        for (const doc of patientsSnap.docs) {
          const data = doc.data();
          console.log(`Patient ${doc.id}:`, data); // Debug log
          
          // Log all available fields for debugging
          if (data.treatmentStatus === 'birthed') {
            console.log(`Available fields for birthed patient ${doc.id}:`, Object.keys(data));
            console.log(`Baby-related fields:`, {
              babyName: data.babyName,
              baby_name: data.baby_name,
              baby_name_my: data.baby_name_my,
              babyNameMy: data.babyNameMy,
              babyName_my: data.babyName_my,
              fatherName: data.fatherName,
              father_name: data.father_name,
              father_name_my: data.father_name_my,
              fatherNameMy: data.fatherNameMy,
              fatherName_my: data.fatherName_my
            });
            // Get baby info from the birthRecord subcollection
            try {
              const birthRecordSnap = await firebase.firestore()
                .collection('patients')
                .doc(doc.id)
                .collection('records')
                .doc('birthRecord')
                .get();
              
              if (birthRecordSnap.exists) {
                const birthData = birthRecordSnap.data();
                console.log(`Birth record data for patient ${doc.id}:`, birthData);
                
                const babyInfo = {
                  babyName: birthData.babyName || 'N/A',
                  fatherName: birthData.fatherName || 'N/A',
                  birthDate: birthData.birthTime ? new Date(birthData.birthTime).toLocaleDateString() : 'N/A',
                  birthTime: birthData.birthTime ? new Date(birthData.birthTime).toLocaleTimeString() : 'N/A',
                  birthWeight: birthData.birthWeight ? `${birthData.birthWeight}g` : 'N/A',
                  gender: birthData.babyGender || 'N/A',
                  apgarScore: birthData.apgarScore1min || birthData.apgarScore5min || 'N/A',
                  complications: birthData.birthComplications || 'None'
                };
                
                console.log(`Extracted baby info for patient ${doc.id}:`, babyInfo);
                
                babyData.push({
                  id: doc.id,
                  name: data.name || 'Unknown',
                  ...babyInfo
                });
              } else {
                console.log(`No birth record found for patient ${doc.id}`);
                // Add patient with N/A values if no birth record exists
                babyData.push({
                  id: doc.id,
                  name: data.name || 'Unknown',
                  babyName: 'N/A',
                  fatherName: 'N/A',
                  birthDate: 'N/A',
                  birthTime: 'N/A',
                  birthWeight: 'N/A',
                  gender: 'N/A',
                  apgarScore: 'N/A',
                  complications: 'None'
                });
              }
            } catch (birthError) {
              console.error(`Error loading birth record for patient ${doc.id}:`, birthError);
              // Add patient with N/A values if birth record access fails
              babyData.push({
                id: doc.id,
                name: data.name || 'Unknown',
                babyName: 'N/A',
                fatherName: 'N/A',
                birthDate: 'N/A',
                birthTime: 'N/A',
                birthWeight: 'N/A',
                gender: 'N/A',
                apgarScore: 'N/A',
                complications: 'None'
              });
            }
          }
        }

        return babyData;
      } catch (error) {
        console.error('Error getting baby data:', error);
        return [];
      }
    }

    // Get Transfer Data
    async function getTransferData() {
      try {
        let patientsSnap;
        
        if (userRole === 'Super Admin' || userRole === 'admin') {
          patientsSnap = await firebase.firestore().collection('patients').get();
        } else if (userRole === 'TMO') {
          patientsSnap = await firebase.firestore().collection('patients').where('township', '==', userTownship).get();
        } else {
          patientsSnap = await firebase.firestore().collection('patients').where('createdBy', '==', currentUser.uid).get();
        }

        const transferData = [];
        
        // Process each patient to get transfer information
        for (const doc of patientsSnap.docs) {
          const data = doc.data();
          console.log(`Patient ${doc.id}:`, data); // Debug log
          
          if (data.treatmentStatus === 'transferred') {
            console.log(`Available fields for transferred patient ${doc.id}:`, Object.keys(data));
            
            // Get transfer info from the transferRecord subcollection
            try {
              const transferRecordSnap = await firebase.firestore()
                .collection('patients')
                .doc(doc.id)
                .collection('records')
                .doc('transferRecord')
                .get();
              
              if (transferRecordSnap.exists) {
                const transferRecordData = transferRecordSnap.data();
                console.log(`Transfer record data for patient ${doc.id}:`, transferRecordData);
                
                const transferInfo = {
                  transferDate: transferRecordData.transferDate ? new Date(transferRecordData.transferDate).toLocaleDateString() : 'N/A',
                  transferTime: transferRecordData.transferTime ? new Date(transferRecordData.transferTime).toLocaleTimeString() : 'N/A',
                  transferReason: transferRecordData.transferReason || 'N/A',
                  destination: transferRecordData.destination || 'N/A',
                  transferType: transferRecordData.transferType || 'N/A',
                  notes: transferRecordData.notes || transferRecordData.transferNotes || 'None'
                };
                
                console.log(`Extracted transfer info for patient ${doc.id}:`, transferInfo);
                
                transferData.push({
                  id: doc.id,
                  name: data.name || 'Unknown',
                  ...transferInfo
                });
              } else {
                console.log(`No transfer record found for patient ${doc.id}`);
                // Add patient with N/A values if no transfer record exists
                transferData.push({
                  id: doc.id,
                  name: data.name || 'Unknown',
                  transferDate: 'N/A',
                  transferTime: 'N/A',
                  transferReason: 'N/A',
                  destination: 'N/A',
                  transferType: 'N/A',
                  notes: 'None'
                });
              }
            } catch (transferError) {
              console.error(`Error loading transfer record for patient ${doc.id}:`, transferError);
              // Add patient with N/A values if transfer record access fails
              transferData.push({
                id: doc.id,
                name: data.name || 'Unknown',
                transferDate: 'N/A',
                transferTime: 'N/A',
                transferReason: 'N/A',
                destination: 'N/A',
                transferType: 'N/A',
                notes: 'None'
              });
            }
          }
        }

        return transferData;
      } catch (error) {
        console.error('Error getting transfer data:', error);
        return [];
      }
    }

    // Get Other Outcomes Data
    async function getOtherOutcomesData() {
      try {
        let patientsSnap;
        
        if (userRole === 'Super Admin' || userRole === 'admin') {
          patientsSnap = await firebase.firestore().collection('patients').get();
        } else if (userRole === 'TMO') {
          patientsSnap = await firebase.firestore().collection('patients').where('township', '==', userTownship).get();
        } else {
          patientsSnap = await firebase.firestore().collection('patients').where('createdBy', '==', currentUser.uid).get();
        }

        const otherData = [];
        patientsSnap.forEach(doc => {
          const data = doc.data();
          if (data.treatmentStatus === 'other') {
            otherData.push({
              id: doc.id,
              name: data.name || 'Unknown',
              age: data.age || 'N/A',
              outcomeDate: data.outcomeDate || 'N/A',
              outcomeType: data.outcomeType || 'N/A',
              reason: data.reason || 'N/A',
              notes: data.notes || 'None'
            });
          }
        });

        return otherData;
      } catch (error) {
        console.error('Error getting other outcomes data:', error);
        return [];
      }
    }

    // Refresh Functions
    function refreshBabyTable() {
      loadBabyTable();
    }

    function refreshTransferTable() {
      loadTransferTable();
    }

    function refreshOtherOutcomesTable() {
      loadOtherOutcomesTable();
    }

    // Action Functions
    function viewPatient(patientId) {
      // Navigate to patient summary view
      window.open(`summary-view.html?patient=${patientId}`, '_blank');
    }

    function editPatient(patientId) {
      // Navigate to patient summary for editing
      window.location.href = `summary.html?patient=${patientId}`;
    }

    // Baby Edit Functions
    let currentEditingBabyId = null;

    async function editBabyInfo(patientId) {
      try {
        currentEditingBabyId = patientId;
        
        // Get birthRecord data from subcollection
        const birthRecordDoc = await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .collection('records')
          .doc('birthRecord')
          .get();
        
        if (!birthRecordDoc.exists) {
          alert('Birth record not found for this patient');
          return;
        }
        
        const data = birthRecordDoc.data();
        console.log('Birth record data for editing:', data);
        
        // Populate modal fields from birthRecord data
        document.getElementById('babyName').value = data.babyName || '';
        document.getElementById('fatherName').value = data.fatherName || '';
        
        // Handle combined birthTime field (format: "2025-09-01T20:56")
        if (data.birthTime) {
          const birthDateTime = new Date(data.birthTime);
          if (!isNaN(birthDateTime.getTime())) {
            document.getElementById('birthDate').value = birthDateTime.toISOString().split('T')[0];
            document.getElementById('birthTime').value = birthDateTime.toTimeString().slice(0, 5);
          }
        }
        
        document.getElementById('birthWeight').value = data.birthWeight || '';
        document.getElementById('gender').value = data.babyGender || '';
        document.getElementById('apgarScore').value = data.apgarScore1min || data.apgarScore || '';
        document.getElementById('complications').value = data.birthComplications || '';
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('babyEditModal'));
        modal.show();
        
      } catch (error) {
        console.error('Error loading baby info for editing:', error);
        alert('Error loading baby information');
      }
    }

    async function saveBabyInfo() {
      try {
        if (!currentEditingBabyId) {
          alert('No baby selected for editing');
          return;
        }
        
        // Get form data and map to database field names
        const formData = {
          babyName: document.getElementById('babyName').value,
          fatherName: document.getElementById('fatherName').value,
          birthTime: `${document.getElementById('birthDate').value}T${document.getElementById('birthTime').value}`, // Combine date and time
          birthWeight: parseInt(document.getElementById('birthWeight').value) || 0,
          babyGender: document.getElementById('gender').value,
          apgarScore1min: parseInt(document.getElementById('apgarScore').value) || 0,
          birthComplications: document.getElementById('complications').value
        };
        
        // Validate required fields
        if (!formData.babyName || !formData.fatherName || !formData.birthDate || 
            !formData.birthTime || !formData.birthWeight || !formData.gender || !formData.apgarScore) {
          alert('Please fill in all required fields');
          return;
        }
        
        // Update birthRecord subcollection with baby information
        const birthRecordRef = firebase.firestore()
          .collection('patients')
          .doc(currentEditingBabyId)
          .collection('records')
          .doc('birthRecord');
        
        // Check if birthRecord document exists
        const birthRecordSnap = await birthRecordRef.get();
        
        if (birthRecordSnap.exists) {
          // Update existing birth record
          await birthRecordRef.update(formData);
        } else {
          // Create new birth record document
          await birthRecordRef.set(formData);
        }
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('babyEditModal'));
        modal.hide();
        
        // Refresh table
        await loadBabyTable();
        
        // Show success message
        alert('Baby information updated successfully!');
        
        // Reset form
        document.getElementById('babyEditForm').reset();
        currentEditingBabyId = null;
        
      } catch (error) {
        console.error('Error saving baby info:', error);
        alert('Error saving baby information');
      }
    }

    // Helper function to get current stats
    async function getCurrentStats() {
      if (userRole === 'Super Admin' || userRole === 'admin') {
        return await getGlobalStatistics();
      } else if (userRole === 'TMO') {
        return await getTownshipStatistics(userTownship);
      } else {
        return await getPersonalStatistics(currentUser.uid);
      }
    }

    // Get Patient Demographics
    async function getPatientDemographics() {
      try {
        let patientsSnap;
        
        if (userRole === 'Super Admin' || userRole === 'admin') {
          patientsSnap = await firebase.firestore().collection('patients').get();
        } else if (userRole === 'TMO') {
          patientsSnap = await firebase.firestore().collection('patients').where('township', '==', userTownship).get();
        } else {
          patientsSnap = await firebase.firestore().collection('patients').where('createdBy', '==', currentUser.uid).get();
        }

        let totalAge = 0;
        let totalPatients = 0;
        let primipara = 0;
        let multipara = 0;
        let highRisk = 0;

        patientsSnap.forEach(doc => {
          const data = doc.data();
          if (data.age) {
            totalAge += parseInt(data.age);
            totalPatients++;
          }
          
          if (data.parity === 0 || data.parity === '0') {
            primipara++;
          } else if (data.parity > 0) {
            multipara++;
          }
          
          if (data.risk_factors && data.risk_factors.trim() !== '') {
            highRisk++;
          }
        });

        return {
          averageAge: totalPatients > 0 ? Math.round(totalAge / totalPatients) : 0,
          primipara,
          multipara,
          highRisk
        };
      } catch (error) {
        console.error('Error getting demographics:', error);
        return { averageAge: 0, primipara: 0, multipara: 0, highRisk: 0 };
      }
    }

    // Get Labour Duration Data
    async function getLabourDurationData() {
      try {
        let patientsSnap;
        
        if (userRole === 'Super Admin' || userRole === 'admin') {
          patientsSnap = await firebase.firestore().collection('patients').get();
        } else if (userRole === 'TMO') {
          patientsSnap = await firebase.firestore().collection('patients').where('township', '==', userTownship).get();
        } else {
          patientsSnap = await firebase.firestore().collection('patients').where('createdBy', '==', currentUser.uid).get();
        }

        // This is a placeholder - in a real implementation, you'd calculate from labour records
        return {
          avgFirstStage: '6.5 hours',
          avgSecondStage: '45 minutes',
          longestLabour: '18 hours',
          shortestLabour: '2 hours'
        };
      } catch (error) {
        console.error('Error getting labour duration:', error);
        return { avgFirstStage: 'N/A', avgSecondStage: 'N/A', longestLabour: 'N/A', shortestLabour: 'N/A' };
      }
    }

    // Get Birth Outcomes
    async function getBirthOutcomes() {
      try {
        let patientsSnap;
        
        if (userRole === 'Super Admin' || userRole === 'admin') {
          patientsSnap = await firebase.firestore().collection('patients').get();
        } else if (userRole === 'TMO') {
          patientsSnap = await firebase.firestore().collection('patients').where('township', '==', userTownship).get();
        } else {
          patientsSnap = await firebase.firestore().collection('patients').where('createdBy', '==', currentUser.uid).get();
        }

        let vaginalBirths = 0;
        let cSections = 0;
        let complications = 0;
        let healthyBabies = 0;

        patientsSnap.forEach(doc => {
          const data = doc.data();
          if (data.treatmentStatus === 'birthed') {
            if (data.birthType === 'vaginal') {
              vaginalBirths++;
            } else if (data.birthType === 'c-section') {
              cSections++;
            }
            
            if (data.complications && data.complications.trim() !== '') {
              complications++;
            } else {
              healthyBabies++;
            }
          }
        });

        return {
          vaginalBirths: vaginalBirths || 'N/A',
          cSections: cSections || 'N/A',
          complications: complications || 'N/A',
          healthyBabies: healthyBabies || 'N/A'
        };
      } catch (error) {
        console.error('Error getting birth outcomes:', error);
        return { vaginalBirths: 'N/A', cSections: 'N/A', complications: 'N/A', healthyBabies: 'N/A' };
      }
    }

    // Get Transfer Analysis
    async function getTransferAnalysis() {
      try {
        let patientsSnap;
        
        if (userRole === 'Super Admin' || userRole === 'admin') {
          patientsSnap = await firebase.firestore().collection('patients').get();
        } else if (userRole === 'TMO') {
          patientsSnap = await firebase.firestore().collection('patients').where('township', '==', userTownship).get();
        } else {
          patientsSnap = await firebase.firestore().collection('patients').where('createdBy', '==', currentUser.uid).get();
        }

        let totalTransfers = 0;
        let emergencyTransfers = 0;
        let plannedTransfers = 0;
        let mainReason = 'N/A';

        patientsSnap.forEach(doc => {
          const data = doc.data();
          if (data.treatmentStatus === 'transferred') {
            totalTransfers++;
            if (data.transferType === 'emergency') {
              emergencyTransfers++;
            } else if (data.transferType === 'planned') {
              plannedTransfers++;
            }
          }
        });

        return {
          totalTransfers: totalTransfers || 'N/A',
          emergencyTransfers: emergencyTransfers || 'N/A',
          plannedTransfers: plannedTransfers || 'N/A',
          mainReason: mainReason
        };
      } catch (error) {
        console.error('Error getting transfer analysis:', error);
        return { totalTransfers: 'N/A', emergencyTransfers: 'N/A', plannedTransfers: 'N/A', mainReason: 'N/A' };
      }
    }

    // Get Monthly Trends
    async function getMonthlyTrends() {
      try {
        let patientsSnap;
        
        if (userRole === 'Super Admin' || userRole === 'admin') {
          patientsSnap = await firebase.firestore().collection('patients').get();
        } else if (userRole === 'TMO') {
          patientsSnap = await firebase.firestore().collection('patients').where('township', '==', userTownship).get();
        } else {
          patientsSnap = await firebase.firestore().collection('patients').where('createdBy', '==', currentUser.uid).get();
        }

        // Get current year
        const currentYear = new Date().getFullYear();
        const monthlyData = new Array(12).fill(0);
        
        patientsSnap.forEach(doc => {
          const data = doc.data();
          if (data.createdAt) {
            const createdDate = data.createdAt.toDate ? data.createdAt.toDate() : new Date(data.createdAt);
            if (createdDate.getFullYear() === currentYear) {
              monthlyData[createdDate.getMonth()]++;
            }
          }
        });

        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        return {
          labels: months,
          data: monthlyData
        };
      } catch (error) {
        console.error('Error getting monthly trends:', error);
        return { labels: [], data: [] };
      }
    }

    // Go back function
    function goBack() {
      window.history.back();
    }

    // Load Patient Demographics
    async function loadPatientDemographics() {
      try {
        const demographics = await getPatientDemographics();
        const container = document.getElementById('patientDemographics');
        
        let html = '<div class="analytics-content">';
        html += `<div class="analytics-item"><span class="analytics-label">Average Age:</span><span class="analytics-value">${demographics.averageAge} years</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Primipara (0):</span><span class="analytics-value">${demographics.primipara}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Multipara (1+):</span><span class="analytics-value">${demographics.multipara}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">High Risk:</span><span class="analytics-value">${demographics.highRisk}</span></div>`;
        html += '</div>';
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading demographics:', error);
      }
    }

    // Load Labour Duration Analysis
    async function loadLabourDurationAnalysis() {
      try {
        const durationData = await getLabourDurationData();
        const container = document.getElementById('labourDurationAnalysis');
        
        let html = '<div class="analytics-content">';
        html += `<div class="analytics-item"><span class="analytics-label">Average First Stage:</span><span class="analytics-value">${durationData.avgFirstStage}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Average Second Stage:</span><span class="analytics-value">${durationData.avgSecondStage}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Longest Labour:</span><span class="analytics-value">${durationData.longestLabour}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Shortest Labour:</span><span class="analytics-value">${durationData.shortestLabour}</span></div>`;
        html += '</div>';
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading labour duration:', error);
      }
    }

    // Load Birth Outcomes
    async function loadBirthOutcomes() {
      try {
        const birthData = await getBirthOutcomes();
        const container = document.getElementById('birthOutcomes');
        
        let html = '<div class="analytics-content">';
        html += `<div class="analytics-item"><span class="analytics-label">Vaginal Births:</span><span class="analytics-value">${birthData.vaginalBirths}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">C-Sections:</span><span class="analytics-value">${birthData.cSections}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Complications:</span><span class="analytics-value">${birthData.complications}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Healthy Babies:</span><span class="analytics-value">${birthData.healthyBabies}</span></div>`;
        html += '</div>';
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading birth outcomes:', error);
        document.getElementById('birthOutcomes').innerHTML = '<p class="text-muted">Data not available</p>';
      }
    }

    // Load Transfer Analysis
    async function loadTransferAnalysis() {
      try {
        const transferData = await getTransferAnalysis();
        const container = document.getElementById('transferAnalysis');
        
        let html = '<div class="analytics-content">';
        html += `<div class="analytics-item"><span class="analytics-label">Total Transfers:</span><span class="analytics-value">${transferData.totalTransfers}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Emergency:</span><span class="analytics-value">${transferData.emergencyTransfers}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-item"><span class="analytics-label">Planned:</span><span class="analytics-value">${transferData.plannedTransfers}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Main Reason:</span><span class="analytics-value">${transferData.mainReason}</span></div>`;
        html += '</div>';
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading transfer analysis:', error);
        document.getElementById('transferAnalysis').innerHTML = '<p class="text-muted">Data not available</p>';
      }
    }

    // Transfer Edit Functions
    let currentEditingTransferId = null;

    async function editTransferInfo(patientId) {
      try {
        currentEditingTransferId = patientId;
        
        // Get transferRecord data from subcollection
        const transferRecordDoc = await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .collection('records')
          .doc('transferRecord')
          .get();
        
        if (!transferRecordDoc.exists) {
          alert('Transfer record not found for this patient');
          return;
        }
        
        const data = transferRecordDoc.data();
        console.log('Transfer record data for editing:', data);
        
        // Populate modal fields from transferRecord data
        document.getElementById('transferReason').value = data.transferReason || '';
        document.getElementById('destination').value = data.destination || '';
        document.getElementById('transferType').value = data.transferType || '';
        document.getElementById('transferNotes').value = data.notes || data.transferNotes || '';
        
        // Handle combined transferTime field (format: "2025-09-01T20:56")
        if (data.transferTime) {
          const transferDateTime = new Date(data.transferTime);
          if (!isNaN(transferDateTime.getTime())) {
            document.getElementById('transferDate').value = transferDateTime.toISOString().split('T')[0];
            document.getElementById('transferTime').value = transferDateTime.toTimeString().slice(0, 5);
          }
        }
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('transferEditModal'));
        modal.show();
        
      } catch (error) {
        console.error('Error loading transfer info for editing:', error);
        alert('Error loading transfer information');
      }
    }

    async function saveTransferInfo() {
      try {
        if (!currentEditingTransferId) {
          alert('No transfer selected for editing');
          return;
        }
        
        // Get form data and map to database field names
        const formData = {
          transferDate: document.getElementById('transferDate').value,
          transferTime: `${document.getElementById('transferDate').value}T${document.getElementById('transferTime').value}`, // Combine date and time
          transferReason: document.getElementById('transferReason').value,
          destination: document.getElementById('destination').value,
          transferType: document.getElementById('transferType').value,
          notes: document.getElementById('transferNotes').value
        };
        
        // Validate required fields
        if (!formData.transferDate || !formData.transferTime || !formData.transferReason || 
            !formData.destination || !formData.transferType) {
          alert('Please fill in all required fields');
          return;
        }
        
        // Update transferRecord subcollection with transfer information
        const transferRecordRef = firebase.firestore()
          .collection('patients')
          .doc(currentEditingTransferId)
          .collection('records')
          .doc('transferRecord');
        
        // Check if transferRecord document exists
        const transferRecordSnap = await transferRecordRef.get();
        
        if (transferRecordSnap.exists) {
          // Update existing transfer record
          await transferRecordRef.update(formData);
        } else {
          // Create new transfer record document
          await transferRecordRef.set(formData);
        }
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('transferEditModal'));
        modal.hide();
        
        // Refresh table
        await loadTransferTable();
        
        // Show success message
        alert('Transfer information updated successfully!');
        
        // Reset form
        document.getElementById('transferEditForm').reset();
        currentEditingTransferId = null;
        
      } catch (error) {
        console.error('Error saving transfer info:', error);
        alert('Error saving transfer information');
      }
    }

    // Language switching function
    function switchLanguage(lang) {
      if (languageManager) {
        languageManager.switchLanguage(lang);
      }
    }

    // Initialize dashboard when page loads
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        initializeDashboard();
      } else {
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>

</html>
