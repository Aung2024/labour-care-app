<!DOCTYPE html>
<html lang="en">
<head>
  <title>Labour Care Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="languages/language-switcher.css" />
  

  
  <style>
    .dashboard-container {
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
    }
    
    .dashboard-header {
      background: linear-gradient(135deg, #1e40af, #3b82f6);
      color: white;
      padding: 30px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(30, 64, 175, 0.3);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card.primary { border-left: 5px solid #3b82f6; }
    .stat-card.success { border-left: 5px solid #10b981; }
    .stat-card.warning { border-left: 5px solid #f59e0b; }
    .stat-card.danger { border-left: 5px solid #ef4444; }
    .stat-card.info { border-left: 5px solid #06b6d4; }
    .stat-card.info .stat-number { color: #06b6d4; }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .stat-label {
      color: #6b7280;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Clinical Tables - Premium Design */
    .clinical-table-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      border: 1px solid #f1f5f9;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .clinical-table-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    .table-header {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 20px 25px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .table-header h5 {
      color: #1e293b;
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
    }
    
    .table-header h5 i {
      margin-right: 10px;
      color: #3b82f6;
    }
    
    .table-actions .btn {
      border-radius: 8px;
      font-weight: 500;
      padding: 8px 16px;
      transition: all 0.2s ease;
    }
    
    .table-actions .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    /* Clinical Table Styling */
    .clinical-table {
      margin: 0;
      font-size: 0.9rem;
    }
    
    .clinical-table thead th {
      background: #f8fafc;
      border: none;
      color: #475569;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 15px 12px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .clinical-table tbody td {
      padding: 12px;
      border: none;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
      color: #334155;
    }
    
    .clinical-table tbody tr:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      transform: scale(1.01);
      transition: all 0.2s ease;
    }
    
    /* Action Buttons */
    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 2px;
    }
    
    .btn-edit {
      background: #3b82f6;
      color: white;
    }
    
    .btn-edit:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-view {
      background: #10b981;
      color: white;
    }
    
    .btn-view:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .btn-delete {
      background: #ef4444;
      color: white;
    }
    
    .btn-delete:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    /* Status Badges */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-active {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-birthed {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .status-transferred {
      background: #fef3c7;
      color: #92400e;
    }
    
    .status-other {
      background: #f3e8ff;
      color: #7c3aed;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .table-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .clinical-table {
        font-size: 0.8rem;
      }
      
      .clinical-table thead th,
      .clinical-table tbody td {
        padding: 8px 6px;
      }
    }
    
    /* Premium Enhancements */
    .clinical-table tbody tr {
      transition: all 0.2s ease;
    }
    
    .clinical-table tbody tr:nth-child(even) {
      background: #fafbfc;
    }
    
    .clinical-table tbody tr:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      transform: scale(1.005);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    /* Empty state styling */
    .text-muted {
      color: #94a3b8 !important;
      font-style: italic;
    }
    
    /* Loading states */
    .table-loading {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }
    
    .table-loading i {
      font-size: 2rem;
      margin-bottom: 15px;
      color: #3b82f6;
    }
  </style>
</head>
<body>
  <!-- Professional Header -->
  <div class="medical-header">
    <div class="header-content">
      <div class="header-left">
        <div class="app-title">üë©‚Äç‚öïÔ∏è <span data-i18n="appTitle">Labour Care Guide</span></div>
        <div class="page-subtitle"><span data-i18n="dashboard">Dashboard</span></div>
      </div>
      <div class="header-right">
        <div class="language-switcher">
          <div class="language-switcher-container">
            <button class="lang-btn" data-lang="en" onclick="switchLanguage('en')">EN</button>
            <button class="lang-btn" data-lang="my" onclick="switchLanguage('my')">MY</button>
          </div>
        </div>
        <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
          <i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span>
        </button>
      </div>
    </div>
  </div>

  <div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <h1><i class="fas fa-chart-line"></i> <span id="dashboardTitle">Dashboard</span></h1>
      <p id="dashboardSubtitle">Welcome to your personalized dashboard</p>
    </div>

    <!-- Key Statistics -->
    <div class="stats-grid" id="statsGrid">
      <!-- Stats will be populated here -->
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center p-5">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Loading dashboard...</p>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent" style="display: none;">


      <!-- Clinical Data Tables Section -->
      <div class="clinical-tables-section">
        
        <!-- Baby Information Table -->
        <div class="clinical-table-card mb-4">
          <div class="table-header">
            <h5><i class="fas fa-baby"></i> Baby Information & Outcomes</h5>
            <div class="table-actions">
              <button class="btn btn-sm btn-outline-primary" onclick="refreshBabyTable()">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover clinical-table" id="babyTable">
              <thead class="table-light">
                <tr>
                  <th>Patient Name</th>
                  <th>Age</th>
                  <th>Parity</th>
                  <th>Baby Status</th>
                  <th>Birth Date</th>
                  <th>Birth Weight</th>
                  <th>APGAR Score</th>
                  <th>Complications</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="babyTableBody">
                <!-- Baby data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Transfer Information Table -->
        <div class="clinical-table-card mb-4">
          <div class="table-header">
            <h5><i class="fas fa-ambulance"></i> Transfer Information</h5>
            <div class="table-actions">
              <button class="btn btn-sm btn-outline-primary" onclick="refreshTransferTable()">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover clinical-table" id="transferTable">
              <thead class="table-light">
                <tr>
                  <th>Patient Name</th>
                  <th>Age</th>
                  <th>Transfer Date</th>
                  <th>Transfer Reason</th>
                  <th>Destination</th>
                  <th>Transfer Type</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="transferTableBody">
                <!-- Transfer data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Other Outcomes Table -->
        <div class="clinical-table-card mb-4">
          <div class="table-header">
            <h5><i class="fas fa-ellipsis-h"></i> Other Outcomes</h5>
            <div class="table-actions">
              <button class="btn btn-sm btn-outline-primary" onclick="refreshOtherOutcomesTable()">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover clinical-table" id="otherOutcomesTable">
              <thead class="table-light">
                <tr>
                  <th>Patient Name</th>
                  <th>Age</th>
                  <th>Outcome Date</th>
                  <th>Outcome Type</th>
                  <th>Reason</th>
                  <th>Notes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="otherOutcomesTableBody">
                <!-- Other outcomes data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>&copy; 2025 Labour Care App &mdash; Designed for clinical excellence</p>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  <script src="languages/language-manager.js"></script>
  
  <script>
    // Global variables
    let currentUser = null;
    let userRole = null;
    let userTownship = null;

    // Initialize dashboard
    async function initializeDashboard() {
      try {
        // Get current user
        currentUser = firebase.auth().currentUser;
        if (!currentUser) {
          window.location.href = 'login.html';
          return;
        }

        // Load user profile
        const userDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
        if (!userDoc.exists) {
          throw new Error('User profile not found');
        }

        const userData = userDoc.data();
        userRole = userData.role;
        userTownship = userData.township;

        // Update dashboard title and subtitle
        updateDashboardHeader();

        // Load dashboard data based on role
        await loadDashboardData();

        // Hide loading, show content
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';

      } catch (error) {
        console.error('Error initializing dashboard:', error);
        document.getElementById('loadingState').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            Error loading dashboard: ${error.message}
          </div>
        `;
      }
    }

    // Update dashboard header based on user role
    function updateDashboardHeader() {
      const title = document.getElementById('dashboardTitle');
      const subtitle = document.getElementById('dashboardSubtitle');

      switch (userRole) {
        case 'Super Admin':
          title.innerHTML = '<i class="fas fa-crown"></i> Super Admin Dashboard';
          subtitle.textContent = 'Global overview and system management';
          break;
        case 'TMO':
          title.innerHTML = '<i class="fas fa-hospital"></i> TMO Dashboard';
          subtitle.textContent = `Township: ${userTownship || 'Not set'}`;
          break;
        case 'Midwife':
        case 'midwife':
          title.innerHTML = '<i class="fas fa-user-nurse"></i> Midwife Dashboard';
          subtitle.textContent = 'Your patient performance and statistics';
          break;
        default:
          title.innerHTML = '<i class="fas fa-chart-line"></i> Dashboard';
          subtitle.textContent = 'Welcome to your dashboard';
      }
    }

    // Load dashboard data based on user role
    async function loadDashboardData() {
      try {
        // Load statistics
        await loadStatistics();
        
        // Load comprehensive dashboard content
        await loadDashboardContent();
      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }

    // Load key statistics
    async function loadStatistics() {
      try {
        let stats = {};

        if (userRole === 'Super Admin' || userRole === 'admin') {
          // Global statistics
          stats = await getGlobalStatistics();
        } else if (userRole === 'TMO') {
          // Township statistics
          stats = await getTownshipStatistics(userTownship);
        } else {
          // Personal statistics
          stats = await getPersonalStatistics(currentUser.uid);
        }

        displayStatistics(stats);

      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    // Get global statistics (Super Admin)
    async function getGlobalStatistics() {
      const patientsSnap = await firebase.firestore().collection('patients').get();
      const usersSnap = await firebase.firestore().collection('users').get();

      let totalPatients = 0;
      let activePatients = 0;
      let birthedPatients = 0;
      let transferredPatients = 0;
      let otherOutcomes = 0;
      let totalUsers = 0;
      let pendingApprovals = 0;

      patientsSnap.forEach(doc => {
        const data = doc.data();
        totalPatients++;
        
        switch (data.treatmentStatus) {
          case 'active':
            activePatients++;
            break;
          case 'birthed':
            birthedPatients++;
            break;
          case 'transferred':
            transferredPatients++;
            break;
          case 'other':
            otherOutcomes++;
            break;
        }
      });

      usersSnap.forEach(doc => {
        const data = doc.data();
        if (data.status === 'pending' || data.approved === false) {
          pendingApprovals++;
        }
        totalUsers++;
      });

      return {
        totalPatients,
        activePatients,
        birthedPatients,
        transferredPatients,
        otherOutcomes,
        totalUsers,
        pendingApprovals
      };
    }

    // Get township statistics (TMO)
    async function getTownshipStatistics(township) {
      const patientsSnap = await firebase.firestore()
        .collection('patients')
        .where('township', '==', township)
        .get();

      let totalPatients = 0;
      let activePatients = 0;
      let birthedPatients = 0;
      let transferredPatients = 0;
      let otherOutcomes = 0;

      patientsSnap.forEach(doc => {
        const data = doc.data();
        totalPatients++;
        
        switch (data.treatmentStatus) {
          case 'active':
            activePatients++;
            break;
          case 'birthed':
            birthedPatients++;
            break;
          case 'transferred':
            transferredPatients++;
            break;
          case 'other':
            otherOutcomes++;
            break;
        }
      });

      return {
        totalPatients,
        activePatients,
        birthedPatients,
        transferredPatients,
        otherOutcomes
      };
    }

    // Get personal statistics (Midwife)
    async function getPersonalStatistics(userId) {
      const patientsSnap = await firebase.firestore()
        .collection('patients')
        .where('createdBy', '==', userId)
        .get();

      let totalPatients = 0;
      let activePatients = 0;
      let birthedPatients = 0;
      let transferredPatients = 0;
      let otherOutcomes = 0;

      patientsSnap.forEach(doc => {
        const data = doc.data();
        totalPatients++;
        
        switch (data.treatmentStatus) {
          case 'active':
            activePatients++;
            break;
          case 'birthed':
            birthedPatients++;
            break;
          case 'transferred':
            transferredPatients++;
            break;
          case 'other':
            otherOutcomes++;
            break;
        }
      });

      return {
        totalPatients,
        activePatients,
        birthedPatients,
        transferredPatients,
        otherOutcomes
      };
    }

    // Display statistics in cards
    function displayStatistics(stats) {
      const statsGrid = document.getElementById('statsGrid');
      
      let statsHTML = '';

      if (userRole === 'Super Admin' || userRole === 'admin') {
        statsHTML = `
          <div class="stat-card primary">
            <div class="stat-number">${stats.totalPatients}</div>
            <div class="stat-label">Total Patients</div>
          </div>
          <div class="stat-card success">
            <div class="stat-number">${stats.birthedPatients}</div>
            <div class="stat-label">Successful Births</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-number">${stats.transferredPatients}</div>
            <div class="stat-label">Transfers</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-number">${stats.pendingApprovals}</div>
            <div class="stat-label">Pending Approvals</div>
          </div>
        `;
      } else {
        statsHTML = `
          <div class="stat-card primary">
            <div class="stat-number">${stats.totalPatients}</div>
            <div class="stat-label">Total Patients</div>
          </div>
          <div class="stat-card success">
            <div class="stat-number">${stats.birthedPatients}</div>
            <div class="stat-label">Successful Births</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-number">${stats.transferredPatients}</div>
            <div class="stat-label">Transfers</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-number">${stats.activePatients}</div>
            <div class="stat-label">Active Cases</div>
          </div>
          <div class="stat-card info">
            <div class="stat-number">${stats.otherOutcomes}</div>
            <div class="stat-label">Other Outcomes</div>
          </div>
        `;
      }

      statsGrid.innerHTML = statsHTML;
    }

    // Load comprehensive dashboard content
    async function loadDashboardContent() {
      try {
        // Load clinical tables
        await loadClinicalTables();
        
      } catch (error) {
        console.error('Error loading dashboard content:', error);
      }
    }

    // Load clinical tables
    async function loadClinicalTables() {
      try {
        // Load baby information table
        await loadBabyTable();
        
        // Load transfer information table
        await loadTransferTable();
        
        // Load other outcomes table
        await loadOtherOutcomesTable();
        
      } catch (error) {
        console.error('Error loading clinical tables:', error);
      }
    }

    // Load Baby Information Table
    async function loadBabyTable() {
      try {
        const babyData = await getBabyData();
        const tbody = document.getElementById('babyTableBody');
        
        if (babyData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No baby information available</td></tr>';
          return;
        }
        
        let html = '';
        babyData.forEach(patient => {
          html += `
            <tr>
              <td><strong>${patient.name}</strong></td>
              <td>${patient.age}</td>
              <td>${patient.parity}</td>
              <td><span class="status-badge status-birthed">Birthed</span></td>
              <td>${patient.birthDate || 'N/A'}</td>
              <td>${patient.birthWeight || 'N/A'}</td>
              <td>${patient.apgarScore || 'N/A'}</td>
              <td>${patient.complications || 'None'}</td>
              <td>
                <button class="action-btn btn-view" onclick="viewPatient('${patient.id}')" title="View Details">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn btn-edit" onclick="editPatient('${patient.id}')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
      } catch (error) {
        console.error('Error loading baby table:', error);
        document.getElementById('babyTableBody').innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading data</td></tr>';
      }
    }

    // Load Transfer Information Table
    async function loadTransferTable() {
      try {
        const transferData = await getTransferData();
        const tbody = document.getElementById('transferTableBody');
        
        if (transferData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No transfer information available</td></tr>';
          return;
        }
        
        let html = '';
        transferData.forEach(patient => {
          html += `
            <tr>
              <td><strong>${patient.name}</strong></td>
              <td>${patient.age}</td>
              <td>${patient.transferDate || 'N/A'}</td>
              <td>${patient.transferReason || 'N/A'}</td>
              <td>${patient.destination || 'N/A'}</td>
              <td>${patient.transferType || 'N/A'}</td>
              <td><span class="status-badge status-transferred">Transferred</span></td>
              <td>
                <button class="action-btn btn-view" onclick="viewPatient('${patient.id}')" title="View Details">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn btn-edit" onclick="editPatient('${patient.id}')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
      } catch (error) {
        console.error('Error loading transfer table:', error);
        document.getElementById('transferTableBody').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>';
      }
    }

    // Load Other Outcomes Table
    async function loadOtherOutcomesTable() {
      try {
        const otherData = await getOtherOutcomesData();
        const tbody = document.getElementById('otherOutcomesTableBody');
        
        if (otherData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No other outcomes available</td></tr>';
          return;
        }
        
        let html = '';
        otherData.forEach(patient => {
          html += `
            <tr>
              <td><strong>${patient.name}</strong></td>
              <td>${patient.age}</td>
              <td>${patient.outcomeDate || 'N/A'}</td>
              <td>${patient.outcomeType || 'N/A'}</td>
              <td>${patient.reason || 'N/A'}</td>
              <td>${patient.notes || 'None'}</td>
              <td>
                <button class="action-btn btn-view" onclick="viewPatient('${patient.id}')" title="View Details">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn btn-edit" onclick="editPatient('${patient.id}')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
      } catch (error) {
        console.error('Error loading other outcomes table:', error);
        document.getElementById('otherOutcomesTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading data</td></tr>';
      }
    }

    // Get Baby Data
    async function getBabyData() {
      try {
        let patientsSnap;
        
        if (userRole === 'Super Admin' || userRole === 'admin') {
          patientsSnap = await firebase.firestore().collection('patients').get();
        } else if (userRole === 'TMO') {
          patientsSnap = await firebase.firestore().collection('patients').where('township', '==', userTownship).get();
        } else {
          patientsSnap = await firebase.firestore().collection('patients').where('createdBy', '==', currentUser.uid).get();
        }

        const babyData = [];
        patientsSnap.forEach(doc => {
          const data = doc.data();
          if (data.treatmentStatus === 'birthed') {
            babyData.push({
              id: doc.id,
              name: data.name || 'Unknown',
              age: data.age || 'N/A',
              parity: data.parity || 'N/A',
              birthDate: data.birthDate || 'N/A',
              birthWeight: data.birthWeight || 'N/A',
              apgarScore: data.apgarScore || 'N/A',
              complications: data.complications || 'None'
            });
          }
        });

        return babyData;
      } catch (error) {
        console.error('Error getting baby data:', error);
        return [];
      }
    }

    // Get Transfer Data
    async function getTransferData() {
      try {
        let patientsSnap;
        
        if (userRole === 'Super Admin' || userRole === 'admin') {
          patientsSnap = await firebase.firestore().collection('patients').get();
        } else if (userRole === 'TMO') {
          patientsSnap = await firebase.firestore().collection('patients').where('township', '==', userTownship).get();
        } else {
          patientsSnap = await firebase.firestore().collection('patients').where('createdBy', '==', currentUser.uid).get();
        }

        const transferData = [];
        patientsSnap.forEach(doc => {
          const data = doc.data();
          if (data.treatmentStatus === 'transferred') {
            transferData.push({
              id: doc.id,
              name: data.name || 'Unknown',
              age: data.age || 'N/A',
              transferDate: data.transferDate || 'N/A',
              transferReason: data.transferReason || 'N/A',
              destination: data.destination || 'N/A',
              transferType: data.transferType || 'N/A'
            });
          }
        });

        return transferData;
      } catch (error) {
        console.error('Error getting transfer data:', error);
        return [];
      }
    }

    // Get Other Outcomes Data
    async function getOtherOutcomesData() {
      try {
        let patientsSnap;
        
        if (userRole === 'Super Admin' || userRole === 'admin') {
          patientsSnap = await firebase.firestore().collection('patients').get();
        } else if (userRole === 'TMO') {
          patientsSnap = await firebase.firestore().collection('patients').where('township', '==', userTownship).get();
        } else {
          patientsSnap = await firebase.firestore().collection('patients').where('createdBy', '==', currentUser.uid).get();
        }

        const otherData = [];
        patientsSnap.forEach(doc => {
          const data = doc.data();
          if (data.treatmentStatus === 'other') {
            otherData.push({
              id: doc.id,
              name: data.name || 'Unknown',
              age: data.age || 'N/A',
              outcomeDate: data.outcomeDate || 'N/A',
              outcomeType: data.outcomeType || 'N/A',
              reason: data.reason || 'N/A',
              notes: data.notes || 'None'
            });
          }
        });

        return otherData;
      } catch (error) {
        console.error('Error getting other outcomes data:', error);
        return [];
      }
    }

    // Refresh Functions
    function refreshBabyTable() {
      loadBabyTable();
    }

    function refreshTransferTable() {
      loadTransferTable();
    }

    function refreshOtherOutcomesTable() {
      loadOtherOutcomesTable();
    }

    // Action Functions
    function viewPatient(patientId) {
      // Navigate to patient summary view
      window.open(`summary-view.html?patient=${patientId}`, '_blank');
    }

    function editPatient(patientId) {
      // Navigate to patient summary for editing
      window.location.href = `summary.html?patient=${patientId}`;
    }

    // Language switching function
    function switchLanguage(lang) {
      if (languageManager) {
        languageManager.switchLanguage(lang);
      }
    }

    // Initialize dashboard when page loads
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        initializeDashboard();
      } else {
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>

</html>
