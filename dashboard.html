<!DOCTYPE html>
<html lang="en">
<head>
  <title>Labour Care Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  
  <!-- Chart.js for beautiful charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --primary-color: #10b981;
      --secondary-color: #059669;
      --accent-color: #34d399;
      --light-bg: #f0fdf4;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    body {
      background: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .dashboard-container {
      padding: 20px;
      background: var(--light-bg);
      min-height: 100vh;
    }
    
    .header-section {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card.primary { border-left: 5px solid #3b82f6; }
    .stat-card.success { border-left: 5px solid #10b981; }
    .stat-card.warning { border-left: 5px solid #f59e0b; }
    .stat-card.danger { border-left: 5px solid #ef4444; }
    .stat-card.info { border-left: 5px solid #06b6d4; }
    .stat-card.info .stat-number { color: #06b6d4; }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .stat-label {
      color: #6b7280;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Clinical Tables - Premium Design */
    .clinical-table-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      border: 1px solid #f1f5f9;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .clinical-table-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    .table-header {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 20px 25px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .table-header h5 {
      color: #1e293b;
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
    }
    
    .table-header h5 i {
      margin-right: 10px;
      color: #3b82f6;
    }
    
    .table-actions .btn {
      border-radius: 8px;
      font-weight: 500;
      padding: 8px 16px;
      transition: all 0.2s ease;
    }
    
    .table-actions .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    /* Clinical Table Styling */
    .clinical-table {
      margin: 0;
      font-size: 0.9rem;
    }
    
    .clinical-table thead th {
      background: #f8fafc;
      border: none;
      color: #475569;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 15px 12px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .clinical-table tbody td {
      padding: 12px;
      border: none;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
      color: #334155;
    }
    
    .clinical-table tbody tr:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      transform: scale(1.01);
      transition: all 0.2s ease;
    }
    
    /* Action Buttons */
    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 2px;
    }
    
    .btn-edit {
      background: #3b82f6;
      color: white;
    }
    
    .btn-edit:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-view {
      background: #10b981;
      color: white;
    }
    
    .btn-view:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .btn-delete {
      background: #ef4444;
      color: white;
    }
    
    .btn-delete:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    /* Status Badges */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-active {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-birthed {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .status-transferred {
      background: #fef3c7;
      color: #92400e;
    }
    
    .status-other {
      background: #f3e8ff;
      color: #7c3aed;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .table-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .clinical-table {
        font-size: 0.8rem;
      }
      
      .clinical-table thead th,
      .clinical-table tbody td {
        padding: 8px 6px;
      }
    }
    
    /* Premium Enhancements */
    .clinical-table tbody tr {
      transition: all 0.2s ease;
    }
    
    .clinical-table tbody tr:nth-child(even) {
      background: #fafbfc;
    }
    
    .clinical-table tbody tr:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      transform: scale(1.005);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    /* Empty state styling */
    .text-muted {
      color: #94a3b8 !important;
      font-style: italic;
    }
    
    /* Loading states */
    .table-loading {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }
    
    .table-loading i {
      font-size: 2rem;
      margin-bottom: 15px;
      color: #3b82f6;
    }
    
    /* Sticky Back Button */
    .sticky-back-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 15px 20px;
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
      transition: all 0.3s ease;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sticky-back-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(59, 130, 246, 0.4);
      background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%);
    }
    
    /* Footer Sticky */
    .footer {
      position: sticky;
      bottom: 0;
      background: white;
      border-top: 1px solid #e2e8f0;
      padding: 20px 0;
      margin-top: auto;
    }
    
    /* Main container for sticky footer */
    .main-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .content-wrapper {
      flex: 1;
    }
    
    /* Chart Cards */
    .chart-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      border: 1px solid #f1f5f9;
      height: 100%;
      transition: all 0.3s ease;
    }
    
    .chart-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    .chart-card h5 {
      color: #1e293b;
      font-size: 1.1rem;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .chart-card h5 i {
      margin-right: 10px;
      color: #3b82f6;
    }
    
    .chart-card canvas {
      max-height: 300px;
      width: 100% !important;
    }
    
    /* Analytics Cards */
    .analytics-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      border: 1px solid #f1f5f9;
      height: 100%;
      transition: all 0.3s ease;
    }
    
    .analytics-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    .analytics-card h5 {
      color: #1e293b;
      font-size: 1.1rem;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .analytics-card h5 i {
      margin-right: 10px;
      color: #3b82f6;
    }

    /* Chart Containers */
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 15px;
    }

    .analytics-details {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      font-size: 0.9rem;
    }

    .analytics-details .detail-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .analytics-details .detail-item:last-child {
      margin-bottom: 0;
    }

    .detail-label {
      font-weight: 500;
      color: #374151;
    }

    .detail-value {
      font-weight: 600;
      color: #10b981;
    }
    
    /* Analytics Content */
    .analytics-content {
      font-size: 0.9rem;
      color: #6b7280;
    }
    
    .analytics-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .analytics-item:last-child {
      border-bottom: none;
    }
    
    .analytics-label {
      font-weight: 500;
      color: #374151;
    }
    
    .analytics-value {
      font-weight: 600;
      color: #1f2937;
    }

    /* Filter Bar */
    .filter-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid #e5e7eb;
      margin-bottom: 25px;
    }

    .filter-card .form-label {
      font-weight: 600;
      color: #374151;
    }

    .filter-card .btn {
      min-width: 120px;
    }

    @media (max-width: 768px) {
      .filter-card .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Sticky Back Button -->
  <button class="sticky-back-btn" onclick="goBack()">
    <i class="fas fa-arrow-left"></i>
    Back
  </button>


  <!-- Main Container -->
  <div class="main-container">
    <div class="content-wrapper">
      <div class="dashboard-container">
        <!-- Dashboard Header -->
        <div class="header-section">
          <div class="container">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h1 class="mb-2">
                  <i class="fas fa-chart-line me-3"></i>
                  <span id="dashboardTitle">Dashboard</span>
                </h1>
                <p class="mb-0" id="dashboardSubtitle">Your patient performance and statistics</p>
              </div>
              <div class="col-md-4 text-end">
                <div class="d-flex align-items-center justify-content-end gap-3">
                  <span id="userInfo" class="text-white-50"></span>
                  <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Key Statistics - Removed score cards per user request -->

        <!-- Loading State -->
        <div id="loadingState" class="text-center p-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Loading dashboard...</p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" style="display: none;">

          <!-- Date Filter -->
          <div class="filter-card">
            <div class="row g-3 align-items-end">
              <div class="col-12 col-md-4">
                <label for="filterStartDate" class="form-label"><i class="fas fa-calendar-day me-2"></i>Start Date</label>
                <input type="date" id="filterStartDate" class="form-control">
              </div>
              <div class="col-12 col-md-4">
                <label for="filterEndDate" class="form-label"><i class="fas fa-calendar-check me-2"></i>End Date</label>
                <input type="date" id="filterEndDate" class="form-control">
              </div>
              <div class="col-12 col-md-4 d-flex gap-2">
                <button type="button" class="btn btn-primary flex-grow-1" onclick="applyDateFilter()">
                  <i class="fas fa-filter me-2"></i>Apply
                </button>
                <button type="button" class="btn btn-secondary flex-grow-1" onclick="resetDateFilter()">
                  <i class="fas fa-undo me-2"></i>Reset
                </button>
              </div>
            </div>
            <div id="activeFilterNotice" class="mt-3 text-muted" style="display: none;">
              <i class="fas fa-info-circle me-2"></i>
              Showing records within the selected date range.
            </div>
          </div>


      <!-- TMO Analytics Section -->
      <div id="tmoAnalytics" class="analytics-section mb-4" style="display: none;">
        <!-- Midwife Filter -->
        <div class="row mb-4">
          <div class="col-md-12">
            <div class="analytics-card">
              <div class="d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-filter"></i> Filter by Midwife</h5>
                <select id="midwifeFilter" class="form-select" style="width: 300px;">
                  <option value="all">All Midwives</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- ANC Analytics -->
        <div class="row mb-4">
          <div class="col-md-12 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-heartbeat"></i> ANC Visits Analysis</h5>
              <div class="chart-container">
                <canvas id="ancVisitsChart"></canvas>
              </div>
              <div id="ancVisitsDetails" class="analytics-details mt-3"></div>
            </div>
          </div>
        </div>

        <!-- Clinical Care Analytics -->
        <div class="row mb-4">
          <div class="col-md-4 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-syringe"></i> Oxytocin Usage</h5>
              <div class="chart-container">
                <canvas id="oxytocinChart"></canvas>
              </div>
              <div id="oxytocinDetails" class="analytics-details mt-3"></div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-exclamation-triangle"></i> High Risk Pregnancies</h5>
              <div class="chart-container">
                <canvas id="highRiskChart"></canvas>
              </div>
              <div id="highRiskDetails" class="analytics-details mt-3"></div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-shield-alt"></i> TT Vaccination</h5>
              <div class="chart-container">
                <canvas id="ttChart"></canvas>
              </div>
              <div id="ttDetails" class="analytics-details mt-3"></div>
            </div>
          </div>
        </div>

        <!-- Medication & Testing Analytics -->
        <div class="row mb-4">
          <div class="col-md-6 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-pills"></i> Folic Acid & B1</h5>
              <div class="chart-container">
                <canvas id="folicAcidChart"></canvas>
              </div>
              <div id="folicAcidDetails" class="analytics-details mt-3"></div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-vial"></i> HIV & Syphilis Testing</h5>
              <div class="chart-container">
                <canvas id="hivSyphilisChart"></canvas>
              </div>
              <div id="hivSyphilisDetails" class="analytics-details mt-3"></div>
            </div>
          </div>
        </div>

        <!-- Birth Outcomes Analytics -->
        <div class="row mb-4">
          <div class="col-md-4 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-tint"></i> PPH Cases</h5>
              <div class="chart-container">
                <canvas id="pphChart"></canvas>
              </div>
              <div id="pphDetails" class="analytics-details mt-3"></div>
            </div>
          </div>
          <div class="col-md-12 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-check-circle"></i> Treatment Outcomes</h5>
              <div class="chart-container">
                <canvas id="transferChart"></canvas>
              </div>
              <div id="transferDetails" class="analytics-details mt-3"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Standard Analytics (for Midwives) -->
      <div id="standardAnalytics" class="analytics-section mb-4">
        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-heartbeat"></i> ANC Analysis</h5>
              <div id="ancAnalysis"></div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-baby"></i> Postnatal Analysis</h5>
              <div id="postnatalAnalysis"></div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-12 mb-3">
            <div class="analytics-card">
              <h5><i class="fas fa-user-plus"></i> Patient Analysis</h5>
              <div id="patientAnalysis"></div>
            </div>
          </div>
        </div>
      </div>

            </div>
          </div>
        </div>


  <footer class="footer">
    <p>&copy; 2025 Maternal & Child Health Care System â€” Designed for clinical excellence - Powered by Jhpiego Myanmar</p>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/firebase.js"></script>
 
  
  <script>
    // Global variables
    let currentUser = null;
    let userRole = null;
    let userTownship = null;
    let dateFilter = { start: null, end: null };

    function parseDateValue(value) {
      if (!value) return null;
      if (value instanceof Date) return isNaN(value.getTime()) ? null : value;
      if (typeof value.toDate === 'function') {
        const d = value.toDate();
        return isNaN(d.getTime()) ? null : d;
      }
      if (typeof value === 'object' && typeof value.seconds === 'number') {
        return new Date(value.seconds * 1000);
      }
      if (typeof value === 'number') {
        const d = new Date(value);
        return isNaN(d.getTime()) ? null : d;
      }
      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (!trimmed) return null;
        const iso = Date.parse(trimmed);
        if (!isNaN(iso)) return new Date(iso);
        const parts = trimmed.split('/');
        if (parts.length === 3) {
          const [day, month, year] = parts.map(p => parseInt(p, 10));
          if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
            const candidate = new Date(year, month - 1, day);
            if (!isNaN(candidate.getTime())) return candidate;
          }
        }
      }
      return null;
    }

    function normalizeStartOfDay(date) {
      if (!date) return null;
      const normalized = new Date(date.getTime());
      normalized.setHours(0, 0, 0, 0);
      return normalized;
    }

    function normalizeEndOfDay(date) {
      if (!date) return null;
      const normalized = new Date(date.getTime());
      normalized.setHours(23, 59, 59, 999);
      return normalized;
    }

    function isDateWithinActiveFilter(date) {
      if (!dateFilter.start && !dateFilter.end) return true;
      if (!date) return true;
      if (dateFilter.start && date < dateFilter.start) return false;
      if (dateFilter.end && date > dateFilter.end) return false;
      return true;
    }

    function recordIsWithinFilter(data, dateKeys = []) {
      if (!dateFilter.start && !dateFilter.end) return true;
      let evaluated = false;

      if (data) {
        for (const key of dateKeys) {
          if (data[key]) {
            const parsed = parseDateValue(data[key]);
            if (parsed) {
              evaluated = true;
              if (isDateWithinActiveFilter(parsed)) return true;
            }
          }
        }

        if (data.timestamp) {
          const parsedTimestamp = parseDateValue(data.timestamp);
          if (parsedTimestamp) {
            evaluated = true;
            if (isDateWithinActiveFilter(parsedTimestamp)) return true;
          }
        }
      }

      return !evaluated;
    }

    function updateFilterNotice() {
      const notice = document.getElementById('activeFilterNotice');
      if (!notice) return;
      if (dateFilter.start || dateFilter.end) {
        notice.style.display = 'block';
      } else {
        notice.style.display = 'none';
      }
    }

    async function refreshDashboardContents() {
      try {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('dashboardContent').style.display = 'none';
        analyticsData = await buildAnalyticsData();
        await loadDashboardData();
      } catch (error) {
        console.error('Error refreshing dashboard:', error);
      } finally {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';
      }
    }

    async function applyDateFilter() {
      const startInput = document.getElementById('filterStartDate');
      const endInput = document.getElementById('filterEndDate');

      const startValue = startInput ? parseDateValue(startInput.value) : null;
      const endValue = endInput ? parseDateValue(endInput.value) : null;

      if (startValue && endValue && startValue > endValue) {
        alert('Start date cannot be later than end date.');
        return;
      }

      dateFilter.start = startValue ? normalizeStartOfDay(startValue) : null;
      dateFilter.end = endValue ? normalizeEndOfDay(endValue) : null;

      updateFilterNotice();
      await refreshDashboardContents();
    }

    async function resetDateFilter() {
      const startInput = document.getElementById('filterStartDate');
      const endInput = document.getElementById('filterEndDate');
      if (startInput) startInput.value = '';
      if (endInput) endInput.value = '';

      dateFilter = { start: null, end: null };
      updateFilterNotice();
      await refreshDashboardContents();
    }

    // Initialize dashboard
    async function initializeDashboard() {
      try {
        console.log('Initializing dashboard...');
        
        // Get current user
        currentUser = firebase.auth().currentUser;
        console.log('Current user:', currentUser ? currentUser.uid : 'No user');
        
        if (!currentUser) {
          console.log('No user found, redirecting to login');
          window.location.href = 'login.html';
          return;
        }

        // Load user profile
        console.log('Loading user profile...');
        const userDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
        if (!userDoc.exists) {
          throw new Error('User profile not found');
        }

        const userData = userDoc.data();
        userRole = userData.role;
        userTownship = userData.township;
        
        console.log('User role:', userRole);
        console.log('User township:', userTownship);
        
        // Load user info in header
        document.getElementById("userInfo").textContent = `${currentUser.email} (${userData.role})`;

        // Update dashboard title and subtitle
        updateDashboardHeader();

        console.log('Loading dashboard data...');
        await refreshDashboardContents();
        
        console.log('Dashboard initialization complete');

      } catch (error) {
        console.error('Error initializing dashboard:', error);
        document.getElementById('loadingState').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            Error loading dashboard: ${error.message}
          </div>
        `;
      }
    }

    // Update dashboard header based on user role
    function updateDashboardHeader() {
      const title = document.getElementById('dashboardTitle');
      const subtitle = document.getElementById('dashboardSubtitle');

      switch (userRole) {
        case 'Super Admin':
          title.innerHTML = '<i class="fas fa-crown"></i> Super Admin Dashboard';
          subtitle.textContent = 'Global overview and system management';
          break;
        case 'TMO':
          title.innerHTML = '<i class="fas fa-hospital"></i> TMO Dashboard';
          subtitle.textContent = `Township: ${userTownship || 'Not set'}`;
          break;
        case 'Midwife':
        case 'midwife':
          title.innerHTML = '<i class="fas fa-user-nurse"></i> Midwife Dashboard';
          subtitle.textContent = 'Your patient performance and statistics';
          break;
        default:
          title.innerHTML = '<i class="fas fa-chart-line"></i> Dashboard';
          subtitle.textContent = 'Welcome to your dashboard';
      }
    }

    // Load dashboard data based on user role
    async function loadDashboardData() {
      try {
        // Load statistics
        await loadStatistics();
        
        // Load comprehensive dashboard content
        await loadDashboardContent();
      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }

    function emptyStats() {
      return {
          totalPatients: 0,
          antenatalPatients: 0,
          labourPatients: 0,
          postnatalPatients: 0
        };
      }

    function computeStatusStatistics(patients = []) {
      if (!patients.length) {
        return emptyStats();
      }

      const stats = emptyStats();

      patients.forEach(patient => {
        stats.totalPatients++;
        const data = patient.profile || {};
        const status = (data.status || data.treatmentStatus || 'Antenatal Care').toLowerCase();

        if (status.includes('antenatal')) {
          stats.antenatalPatients++;
        } else if (status.includes('labour')) {
          stats.labourPatients++;
        } else if (status.includes('postnatal') || status.includes('postpartum')) {
          stats.postnatalPatients++;
        } else {
          stats.antenatalPatients++;
        }
      });

      return stats;
    }

    async function loadStatistics() {
      try {
        if (!analyticsData) {
          analyticsData = await buildAnalyticsData();
        }

        let stats = emptyStats();

        if (userRole === 'Super Admin' || userRole === 'admin') {
          stats = getGlobalStatistics();
        } else if (userRole === 'TMO') {
          stats = getTownshipStatistics(userTownship);
        } else {
          stats = getPersonalStatistics(currentUser.uid);
        }

        displayStatistics(stats);

      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    function getGlobalStatistics() {
      if (!analyticsData || !analyticsData.patients) {
        return emptyStats();
      }
      return computeStatusStatistics(analyticsData.patients);
    }

    function getTownshipStatistics(township) {
      if (!analyticsData || !analyticsData.patients) {
        return emptyStats();
      }

      if (!township) {
        return computeStatusStatistics(analyticsData.patients);
      }

      const filtered = analyticsData.patients.filter(patient => {
        const patientTownship = (patient.profile?.township || '').toLowerCase();
        return patientTownship === township.toLowerCase();
      });

      return computeStatusStatistics(filtered.length ? filtered : analyticsData.patients);
    }

    function getPersonalStatistics(userId) {
      if (!analyticsData || !analyticsData.patients) {
        return emptyStats();
      }

      const filtered = analyticsData.patients.filter(patient => {
        const creator = patient.profile.created_by || patient.profile.createdBy;
        return creator === userId;
      });

      return computeStatusStatistics(filtered.length ? filtered : analyticsData.patients);
    }

    // Display statistics in cards
    function displayStatistics(stats) {
      // Update the existing score cards with new data
      document.getElementById('totalPatients').textContent = stats.totalPatients || 0;
      document.getElementById('antenatalPatients').textContent = stats.antenatalPatients || 0;
      document.getElementById('labourPatients').textContent = stats.labourPatients || 0;
      document.getElementById('postnatalPatients').textContent = stats.postnatalPatients || 0;
    }

    // Load midwife filter for TMO
    async function loadMidwifeFilter() {
      try {
        const midwifeFilter = document.getElementById('midwifeFilter');
        midwifeFilter.innerHTML = '<option value="all">All Midwives</option>';
        
        console.log('Loading midwives for township:', userTownship);
        
        // Get all midwives in the township
        const midwivesSnap = await firebase.firestore()
          .collection('users')
          .where('role', '==', 'Midwife')
          .where('township', '==', userTownship)
          .get();
        
        console.log('Found midwives:', midwivesSnap.size);
        
        midwivesSnap.forEach(doc => {
          const userData = doc.data();
          console.log('Adding midwife:', userData.name || userData.email);
          
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = userData.name || userData.email || 'Unknown Midwife';
          midwifeFilter.appendChild(option);
        });
        
        // Remove existing event listeners to prevent duplicates
        const newMidwifeFilter = midwifeFilter.cloneNode(true);
        midwifeFilter.parentNode.replaceChild(newMidwifeFilter, midwifeFilter);
        
        // Add event listener for filtering
        newMidwifeFilter.addEventListener('change', loadTMOAnalytics);
        
        console.log('Midwife filter loaded with', newMidwifeFilter.options.length, 'options');
        
      } catch (error) {
        console.error('Error loading midwife filter:', error);
        console.error('Error details:', error.message);
      }
    }

    // Chart instances storage
    let chartInstances = {};
    let analyticsData = null;

    function destroyChart(chartId) {
      if (chartInstances[chartId]) {
        chartInstances[chartId].destroy();
        delete chartInstances[chartId];
      }
    }

    function cloneSnapshotDocs(snapshot) {
      if (!snapshot || snapshot.empty) return [];
      return snapshot.docs.map(doc => ({
        id: doc.id,
        data: doc.data() || {}
      }));
    }

    function filterRecords(records = [], dateKeys = []) {
      return records
        .filter(record => record && record.data)
        .filter(record => recordIsWithinFilter(record.data, dateKeys));
    }

    function recordMatchesDate(record, dateKeys = []) {
      if (!record || !record.data) return false;
      return recordIsWithinFilter(record.data, dateKeys);
    }

    function patientMatchesDateFilter(entry) {
      if (!entry) return false;
      if (!dateFilter.start && !dateFilter.end) return true;

      if (recordIsWithinFilter(entry.profile, [
        'createdAt', 'created_at', 'createdDate', 'registrationDate',
        'registration_date', 'timestamp', 'date'
      ])) {
        return true;
      }

      const hasFilteredVisits = (entry.antenatalVisits && entry.antenatalVisits.length > 0) ||
        (entry.postpartumVisits && entry.postpartumVisits.length > 0) ||
        (entry.testRecords && entry.testRecords.length > 0);
      if (hasFilteredVisits) return true;

      if (entry.birthRecord) return true;
      if (entry.endTreatment) return true;
      if (entry.transferRecord) return true;
      if (entry.outcomeRecord) return true;

      return false;
    }

    async function buildAnalyticsData() {
      const db = firebase.firestore();
      let patientDocs = [];
        
        if (userRole === 'TMO') {
        const snapshot = await db.collection('patients')
              .where('township', '==', userTownship)
              .get();
        patientDocs = snapshot.docs;
      } else if (userRole && userRole.toLowerCase() === 'midwife') {
        const [snapNew, snapOld] = await Promise.all([
          db.collection('patients').where('created_by', '==', currentUser.uid).get(),
          db.collection('patients').where('createdBy', '==', currentUser.uid).get()
        ]);
        const combined = new Map();
        snapNew.forEach(doc => combined.set(doc.id, doc));
        snapOld.forEach(doc => {
          if (!combined.has(doc.id)) combined.set(doc.id, doc);
        });
        patientDocs = Array.from(combined.values());
          } else {
        const snapshot = await db.collection('patients').get();
        patientDocs = snapshot.docs;
      }

      if (!patientDocs.length) {
        return { patients: [] };
      }

      const patientData = await Promise.all(patientDocs.map(async doc => {
        const profile = doc.data() || {};
        const patientRef = db.collection('patients').doc(doc.id);

        try {
          const [
            antenatalVisitsSnap,
            postpartumVisitsSnap,
            testRecordsSnap,
            summaryDoc,
            birthRecordDoc,
            endTreatmentDoc,
            transferRecordDoc,
            outcomeRecordDoc
          ] = await Promise.all([
            patientRef.collection('antenatal_visits').get(),
            patientRef.collection('postpartum_visits').get(),
            patientRef.collection('testRecords').get(),
            patientRef.collection('records').doc('summary').get(),
            patientRef.collection('records').doc('birthRecord').get(),
            patientRef.collection('records').doc('endTreatment').get(),
            patientRef.collection('records').doc('transferRecord').get(),
            patientRef.collection('records').doc('outcomeRecord').get()
          ]);

          const antenatalVisits = filterRecords(
            cloneSnapshotDocs(antenatalVisitsSnap),
            ['visitDate', 'visit_date', 'timestamp', 'createdAt', 'created_at', 'date']
          );

          const postpartumVisits = filterRecords(
            cloneSnapshotDocs(postpartumVisitsSnap),
            ['visitDate', 'visit_date', 'timestamp', 'createdAt', 'created_at', 'date']
          );

          const testRecords = filterRecords(
            cloneSnapshotDocs(testRecordsSnap),
            ['testDate', 'timestamp', 'createdAt', 'created_at', 'date']
          );

          const birthRecordData = birthRecordDoc.exists ? { id: birthRecordDoc.id, data: birthRecordDoc.data() || {} } : null;
          const endTreatmentData = endTreatmentDoc.exists ? { id: endTreatmentDoc.id, data: endTreatmentDoc.data() || {} } : null;
          const transferRecordData = transferRecordDoc.exists ? { id: transferRecordDoc.id, data: transferRecordDoc.data() || {} } : null;
          const outcomeRecordData = outcomeRecordDoc.exists ? { id: outcomeRecordDoc.id, data: outcomeRecordDoc.data() || {} } : null;

          const birthRecord = recordMatchesDate(birthRecordData, ['deliveryDate', 'birthDate', 'timestamp', 'date']) ? birthRecordData : null;
          const endTreatment = recordMatchesDate(endTreatmentData, ['outcomeDate', 'timestamp', 'date']) ? endTreatmentData : null;
          const transferRecord = recordMatchesDate(transferRecordData, ['transferDate', 'timestamp', 'date']) ? transferRecordData : null;
          const outcomeRecord = recordMatchesDate(outcomeRecordData, ['outcomeDate', 'timestamp', 'date']) ? outcomeRecordData : null;

          const entry = {
            id: doc.id,
            profile,
            antenatalVisits,
            postpartumVisits,
            testRecords,
            summary: summaryDoc.exists ? summaryDoc.data() || {} : null,
            birthRecord,
            endTreatment,
            transferRecord,
            outcomeRecord
          };

          entry.matchesDateFilter = patientMatchesDateFilter(entry);
          return entry;
            } catch (error) {
          console.error('Error loading patient collections for analytics:', doc.id, error);
          const fallbackEntry = {
            id: doc.id,
            profile,
            antenatalVisits: [],
            postpartumVisits: [],
            testRecords: [],
            summary: null,
            birthRecord: null,
            endTreatment: null,
            transferRecord: null,
            outcomeRecord: null,
            matchesDateFilter: patientMatchesDateFilter({ profile })
          };
          return fallbackEntry;
        }
      }));

      const filteredPatients = patientData.filter(patient => patient.matchesDateFilter);

      return {
        patients: filteredPatients,
        totalPatients: patientData.length
      };
    }

    // Load TMO analytics with charts
    async function loadTMOAnalytics() {
      try {
        if (!analyticsData) {
          analyticsData = await buildAnalyticsData();
        }

        const selectedMidwife = document.getElementById('midwifeFilter')
          ? document.getElementById('midwifeFilter').value
          : currentUser.uid;

        let dataset = analyticsData.patients || [];

        if (userRole === 'TMO') {
          if (selectedMidwife && selectedMidwife !== 'all') {
            dataset = dataset.filter(patient => {
              const createdBy = patient.profile.created_by || patient.profile.createdBy;
              return createdBy === selectedMidwife;
            });
          }
        } else if (userRole && userRole.toLowerCase() === 'midwife') {
          dataset = dataset.filter(patient => {
            const createdBy = patient.profile.created_by || patient.profile.createdBy;
            return createdBy === currentUser.uid;
          });
        }

        console.log('Patients available for analytics after filtering:', dataset.length);

        const chartIds = ['ancVisitsChart', 'oxytocinChart', 'highRiskChart',
          'ttChart', 'folicAcidChart', 'hivSyphilisChart', 'pphChart',
          'transferChart'];

        chartIds.forEach(chartId => destroyChart(chartId));

        await loadANCVisitsChart(dataset);
        await loadOxytocinChart(dataset);
        await loadHighRiskChart(dataset);
        await loadTTChart(dataset);
        await loadFolicAcidChart(dataset);
        await loadHIVSyphilisChart(dataset);
        await loadPPHChart(dataset);
        await loadTransferChart(dataset);
        
      } catch (error) {
        console.error('Error loading TMO analytics:', error);
      }
    }

    // ANC Visits Chart
    async function loadANCVisitsChart(patientsData) {
      try {
        let visitCounts = { '0': 0, '1-3': 0, '4+': 0, '8+': 0 };
        const totalPatients = patientsData.length;

        patientsData.forEach(patient => {
          const visitCount = (patient.antenatalVisits || []).length;
          if (visitCount === 0) {
            visitCounts['0']++;
          } else if (visitCount >= 8) {
            visitCounts['8+']++;
          } else if (visitCount >= 4) {
            visitCounts['4+']++;
          } else {
            visitCounts['1-3']++;
          }
        });

        const chartData = totalPatients > 0
          ? [visitCounts['0'], visitCounts['1-3'], visitCounts['4+'], visitCounts['8+']]
          : [0, 0, 0, 0];
        
        const ctx = document.getElementById('ancVisitsChart').getContext('2d');
        chartInstances['ancVisitsChart'] = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Zero visits', '1-3 visits', '4+ visits', '8+ visits'],
            datasets: [{
              data: chartData,
              backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6'],
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 20,
                  usePointStyle: true
                }
              },
              title: {
                display: true,
                text: `ANC Visits Distribution (${totalPatients} patients)`,
                font: { size: 14, weight: 'bold' }
              }
            }
          }
        });
        
        const pct = (value) => totalPatients > 0 ? Math.round((value / totalPatients) * 100) : 0;

        document.getElementById('ancVisitsDetails').innerHTML = `
          <div class="detail-item">
            <span class="detail-label">Total Patients:</span>
            <span class="detail-value">${totalPatients}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">4+ ANC Visits:</span>
            <span class="detail-value">${visitCounts['4+'] + visitCounts['8+']} (${pct(visitCounts['4+'] + visitCounts['8+'])}%)</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">8+ ANC Visits:</span>
            <span class="detail-value">${visitCounts['8+']} (${pct(visitCounts['8+'])}%)</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Zero ANC Visits:</span>
            <span class="detail-value">${visitCounts['0']} (${pct(visitCounts['0'])}%)</span>
          </div>
        `;
        
      } catch (error) {
        console.error('Error loading ANC visits chart:', error);
      }
    }

    // Early ANC Chart
    // Oxytocin Chart
    async function loadOxytocinChart(patientsData) {
      try {
        let oxytocinYes = 0;
        let oxytocinNo = 0;
        const totalPatients = patientsData.length;

        patientsData.forEach(patient => {
          const summaryData = patient.summary || {};
            let hasOxytocin = false;
            
          Object.keys(summaryData).forEach(key => {
              if (key.startsWith('Medication_Oxytocin_') && !key.includes('_UL') && !key.includes('_drops')) {
              if (summaryData[key] === 'Y' || summaryData[key] === 'Yes') {
                  hasOxytocin = true;
                }
              }
            });
            
            if (hasOxytocin) {
              oxytocinYes++;
            } else {
              oxytocinNo++;
            }
        });
        
        const ctx = document.getElementById('oxytocinChart').getContext('2d');
        chartInstances['oxytocinChart'] = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Oxytocin Used', 'No Oxytocin'],
            datasets: [{
              data: totalPatients > 0 ? [oxytocinYes, oxytocinNo] : [0, 0],
              backgroundColor: ['#3b82f6', '#6b7280'],
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
              title: { display: true, text: `Oxytocin Usage (${totalPatients} patients)`, font: { size: 14, weight: 'bold' } }
            }
          }
        });

        const pct = (value) => totalPatients > 0 ? Math.round((value / totalPatients) * 100) : 0;
        
        document.getElementById('oxytocinDetails').innerHTML = `
          <div class="detail-item"><span class="detail-label">Total Patients:</span><span class="detail-value">${totalPatients}</span></div>
          <div class="detail-item"><span class="detail-label">Oxytocin Used:</span><span class="detail-value">${oxytocinYes} (${pct(oxytocinYes)}%)</span></div>
          <div class="detail-item"><span class="detail-label">No Oxytocin:</span><span class="detail-value">${oxytocinNo} (${pct(oxytocinNo)}%)</span></div>
        `;
        
      } catch (error) {
        console.error('Error loading Oxytocin chart:', error);
      }
    }

    // High Risk Chart
    async function loadHighRiskChart(patientsData) {
      try {
        let highRisk = 0;
        let normalRisk = 0;
        let riskFactors = {};
        const totalPatients = patientsData.length;

        patientsData.forEach(patient => {
          const data = patient.profile || {};
          if (data.high_risk === 'yes' || data.high_risk === 'Yes') {
            highRisk++;
            
            if (data.risk_factors && Array.isArray(data.risk_factors)) {
              data.risk_factors.forEach(factor => {
                riskFactors[factor] = (riskFactors[factor] || 0) + 1;
              });
            }
          } else {
            normalRisk++;
          }
        });
        
        const ctx = document.getElementById('highRiskChart').getContext('2d');
        chartInstances['highRiskChart'] = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ['High Risk', 'Normal Risk'],
            datasets: [{
              data: totalPatients > 0 ? [highRisk, normalRisk] : [0, 0],
              backgroundColor: ['#ef4444', '#10b981'],
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
              title: { display: true, text: `High Risk Pregnancies (${totalPatients} patients)`, font: { size: 14, weight: 'bold' } }
            }
          }
        });
        
        const pct = (value) => totalPatients > 0 ? Math.round((value / totalPatients) * 100) : 0;
        
        let riskFactorsHtml = '';
        Object.entries(riskFactors).forEach(([factor, count]) => {
          riskFactorsHtml += `<div class="detail-item"><span class="detail-label">${factor}:</span><span class="detail-value">${count}</span></div>`;
        });
        
        document.getElementById('highRiskDetails').innerHTML = `
          <div class="detail-item"><span class="detail-label">Total Patients:</span><span class="detail-value">${totalPatients}</span></div>
          <div class="detail-item"><span class="detail-label">High Risk:</span><span class="detail-value">${highRisk} (${pct(highRisk)}%)</span></div>
          <div class="detail-item"><span class="detail-label">Normal Risk:</span><span class="detail-value">${normalRisk} (${pct(normalRisk)}%)</span></div>
          ${riskFactorsHtml ? '<hr><strong>Risk Factors:</strong>' + riskFactorsHtml : ''}
        `;
        
      } catch (error) {
        console.error('Error loading High Risk chart:', error);
      }
    }

    // TT Chart
    async function loadTTChart(patientsData) {
      try {
        let ttComplete = 0;
        let ttIncomplete = 0;
        const totalPatients = patientsData.length;

        patientsData.forEach(patient => {
          const visits = patient.antenatalVisits || [];
          const hasTT = visits.some(visit => {
            const visitData = visit.data || {};
            return visitData.ttTdCompletion === 'Complete' ||
                (visitData.tt1 && visitData.tt1 !== '') ||
              (visitData.tt2 && visitData.tt2 !== '');
          });
          
          if (hasTT) {
            ttComplete++;
          } else {
            ttIncomplete++;
          }
        });
        
        const ctx = document.getElementById('ttChart').getContext('2d');
        chartInstances['ttChart'] = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['TT Complete', 'TT Incomplete'],
            datasets: [{
              data: totalPatients > 0 ? [ttComplete, ttIncomplete] : [0, 0],
              backgroundColor: ['#22c55e', '#f59e0b'],
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
              title: { display: true, text: `TT Vaccination (${totalPatients} patients)`, font: { size: 14, weight: 'bold' } }
            }
          }
        });

        const pct = (value) => totalPatients > 0 ? Math.round((value / totalPatients) * 100) : 0;
        
        document.getElementById('ttDetails').innerHTML = `
          <div class="detail-item"><span class="detail-label">Total Patients:</span><span class="detail-value">${totalPatients}</span></div>
          <div class="detail-item"><span class="detail-label">TT Complete:</span><span class="detail-value">${ttComplete} (${pct(ttComplete)}%)</span></div>
          <div class="detail-item"><span class="detail-label">TT Incomplete:</span><span class="detail-value">${ttIncomplete} (${pct(ttIncomplete)}%)</span></div>
        `;
        
      } catch (error) {
        console.error('Error loading TT chart:', error);
      }
    }

    // Folic Acid Chart
    async function loadFolicAcidChart(patientsData) {
      try {
        let folicAcidGiven = 0;
        let folicAcidNotGiven = 0;
        const totalPatients = patientsData.length;

        patientsData.forEach(patient => {
          const visits = patient.antenatalVisits || [];
          const hasFolicAcid = visits.some(({ data = {} }) => {
            return data.ironFolicAcid === 'Given' ||
              data.folicAcid === 'Given' ||
              (typeof data.treatmentGiven === 'string' && data.treatmentGiven.toLowerCase().includes('folic'));
          });
          
          if (hasFolicAcid) {
            folicAcidGiven++;
          } else {
            folicAcidNotGiven++;
          }
        });
        
        const ctx = document.getElementById('folicAcidChart').getContext('2d');
        chartInstances['folicAcidChart'] = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Folic Acid Given', 'Not Given'],
            datasets: [{
              data: totalPatients > 0 ? [folicAcidGiven, folicAcidNotGiven] : [0, 0],
              backgroundColor: ['#10b981', '#ef4444'],
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
              title: { display: true, text: `Folic Acid & B1 (${totalPatients} patients)`, font: { size: 14, weight: 'bold' } }
            }
          }
        });

        const pct = (value) => totalPatients > 0 ? Math.round((value / totalPatients) * 100) : 0;
        
        document.getElementById('folicAcidDetails').innerHTML = `
          <div class="detail-item"><span class="detail-label">Total Patients:</span><span class="detail-value">${totalPatients}</span></div>
          <div class="detail-item"><span class="detail-label">Folic Acid Given:</span><span class="detail-value">${folicAcidGiven} (${pct(folicAcidGiven)}%)</span></div>
          <div class="detail-item"><span class="detail-label">Not Given:</span><span class="detail-value">${folicAcidNotGiven} (${pct(folicAcidNotGiven)}%)</span></div>
        `;
        
      } catch (error) {
        console.error('Error loading Folic Acid chart:', error);
      }
    }

    // HIV & Syphilis Chart
    async function loadHIVSyphilisChart(patientsData) {
      try {
        let hivPositive = 0;
        let syphilisPositive = 0;
        let bothNegative = 0;
        let notTested = 0;
        const totalPatients = patientsData.length;

        patientsData.forEach(patient => {
          const tests = patient.testRecords || [];
          let hasHIV = false;
          let hasSyphilis = false;
          let hasAnyTestRecord = false;
          
          tests.forEach(({ data = {} }) => {
            if (data.hivDone === 'Yes' || data.hivResult) {
              hasAnyTestRecord = true;
              if (data.hivResult === 'Reactive' || data.hivResult === 'Positive') {
                hasHIV = true;
            }
            }
            if (data.syphilisDone === 'Yes' || data.syphilisResult) {
              hasAnyTestRecord = true;
              if (data.syphilisResult === 'Reactive' || data.syphilisResult === 'Positive') {
                hasSyphilis = true;
              }
            }
          });
          
          if (!hasAnyTestRecord) {
            notTested++;
          } else if (hasHIV || hasSyphilis) {
            if (hasHIV) hivPositive++;
            if (hasSyphilis) syphilisPositive++;
          } else {
            bothNegative++;
          }
        });
        
        const ctx = document.getElementById('hivSyphilisChart').getContext('2d');
        
        // Only show chart if there are tested patients
        if (totalPatients > 0) {
          chartInstances['hivSyphilisChart'] = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: ['HIV Positive', 'Syphilis Positive', 'Both Negative', 'Not Tested'],
              datasets: [{
                data: totalPatients > 0 ? [hivPositive, syphilisPositive, bothNegative, notTested] : [0, 0, 0, 0],
                backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#6b7280'],
                borderWidth: 2,
                borderColor: '#ffffff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
                title: { display: true, text: `HIV & Syphilis Testing (${totalPatients} patients)`, font: { size: 14, weight: 'bold' } }
              }
            }
          });
        }
        
        const pct = (value) => totalPatients > 0 ? Math.round((value / totalPatients) * 100) : 0;
        
        document.getElementById('hivSyphilisDetails').innerHTML = `
          <div class="detail-item"><span class="detail-label">Total Patients:</span><span class="detail-value">${totalPatients}</span></div>
          <div class="detail-item"><span class="detail-label">HIV Positive:</span><span class="detail-value">${hivPositive} (${pct(hivPositive)}%)</span></div>
          <div class="detail-item"><span class="detail-label">Syphilis Positive:</span><span class="detail-value">${syphilisPositive} (${pct(syphilisPositive)}%)</span></div>
          <div class="detail-item"><span class="detail-label">Both Negative:</span><span class="detail-value">${bothNegative} (${pct(bothNegative)}%)</span></div>
          <div class="detail-item"><span class="detail-label">Not Tested:</span><span class="detail-value">${notTested} (${pct(notTested)}%)</span></div>
        `;
        
      } catch (error) {
        console.error('Error loading HIV & Syphilis chart:', error);
      }
    }

    // PPH Chart
    async function loadPPHChart(patientsData) {
      try {
        let pphCases = 0;
        let noPPH = 0;
        const totalPatients = patientsData.length;

        patientsData.forEach(patient => {
          const birthRecord = patient.birthRecord ? patient.birthRecord.data : null;
          let hasPPH = false;

          if (birthRecord) {
            if (birthRecord.manualPPH === true ||
              birthRecord.pphDetected === true ||
              birthRecord.pphAutoDetected === true ||
              birthRecord.postpartumHemorrhage === true ||
              (birthRecord.totalBloodLoss && parseInt(birthRecord.totalBloodLoss, 10) >= 300)) {
              hasPPH = true;
            }
          }
          
          if (hasPPH) {
            pphCases++;
          } else {
            noPPH++;
          }
        });
        
        const ctx = document.getElementById('pphChart').getContext('2d');
        chartInstances['pphChart'] = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['PPH Cases', 'No PPH'],
            datasets: [{
              data: totalPatients > 0 ? [pphCases, noPPH] : [0, 0],
              backgroundColor: ['#ef4444', '#10b981'],
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
              title: { display: true, text: `PPH Cases (${totalPatients} patients)`, font: { size: 14, weight: 'bold' } }
            }
          }
        });

        const pct = (value) => totalPatients > 0 ? Math.round((value / totalPatients) * 100) : 0;
        
        document.getElementById('pphDetails').innerHTML = `
          <div class="detail-item"><span class="detail-label">Total Patients:</span><span class="detail-value">${totalPatients}</span></div>
          <div class="detail-item"><span class="detail-label">PPH Cases:</span><span class="detail-value">${pphCases} (${pct(pphCases)}%)</span></div>
          <div class="detail-item"><span class="detail-label">No PPH:</span><span class="detail-value">${noPPH} (${pct(noPPH)}%)</span></div>
        `;
        
      } catch (error) {
        console.error('Error loading PPH chart:', error);
      }
    }

    // Newborn Rate Chart
    async function loadNewbornRateChart(patientsSnap) {
      try {
        let successfulBirths = 0;
        let transfers = 0;
        let otherOutcomes = 0;
        let noLabour = 0;
        let totalPatients = 0;
        
        for (const doc of patientsSnap.docs) {
          totalPatients++;
          
          // Check End Treatment data from summary.html (saved in records/endTreatment)
          const endTreatmentDoc = await firebase.firestore()
            .collection('patients')
            .doc(doc.id)
            .collection('records')
            .doc('endTreatment')
            .get();
          
          if (endTreatmentDoc.exists) {
            const endTreatmentData = endTreatmentDoc.data();
            const outcome = endTreatmentData.outcome;
            
            if (outcome === 'birth') {
              successfulBirths++;
            } else if (outcome === 'transfer') {
              transfers++;
            } else if (outcome === 'other') {
              otherOutcomes++;
            } else {
              otherOutcomes++;
            }
          } else {
            // If no End Treatment recorded, check if there's a birth record (indicating successful birth)
            const birthRecordDoc = await firebase.firestore()
              .collection('patients')
              .doc(doc.id)
              .collection('records')
              .doc('birthRecord')
              .get();
            
            if (birthRecordDoc.exists) {
              successfulBirths++;
            } else {
              // Check if patient has any labour care records (summary data)
              const summaryDoc = await firebase.firestore()
                .collection('patients')
                .doc(doc.id)
                .collection('records')
                .doc('summary')
                .get();
              
              if (summaryDoc.exists) {
                otherOutcomes++; // Has labour care but no outcome recorded
              } else {
                noLabour++; // No labour care yet
              }
            }
          }
        }
        
        const ctx = document.getElementById('newbornRateChart').getContext('2d');
        chartInstances['newbornRateChart'] = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Successful Births', 'Transfers', 'Other Outcomes', 'No Labour'],
            datasets: [{
              data: [successfulBirths, transfers, otherOutcomes, noLabour],
              backgroundColor: ['#10b981', '#f59e0b', '#6b7280', '#e5e7eb'],
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
              title: { display: true, text: `Birth Outcomes (${totalPatients} patients)`, font: { size: 14, weight: 'bold' } }
            }
          }
        });
        
        document.getElementById('newbornRateDetails').innerHTML = `
          <div class="detail-item"><span class="detail-label">Total Patients:</span><span class="detail-value">${totalPatients}</span></div>
          <div class="detail-item"><span class="detail-label">Successful Births:</span><span class="detail-value">${successfulBirths} (${Math.round((successfulBirths / totalPatients) * 100)}%)</span></div>
          <div class="detail-item"><span class="detail-label">Transfers:</span><span class="detail-value">${transfers} (${Math.round((transfers / totalPatients) * 100)}%)</span></div>
          <div class="detail-item"><span class="detail-label">Other Outcomes:</span><span class="detail-value">${otherOutcomes} (${Math.round((otherOutcomes / totalPatients) * 100)}%)</span></div>
          <div class="detail-item"><span class="detail-label">No Labour Care:</span><span class="detail-value">${noLabour} (${Math.round((noLabour / totalPatients) * 100)}%)</span></div>
        `;
        
      } catch (error) {
        console.error('Error loading Newborn Rate chart:', error);
      }
    }

    // Transfer Chart
    async function loadTransferChart(patientsData) {
      try {
        let births = 0;
        let transfers = 0;
        let other = 0;
        let noOutcome = 0;
        const totalPatients = patientsData.length;
        
        patientsData.forEach(patient => {
          let outcomeFound = false;
          const endTreatment = patient.endTreatment ? patient.endTreatment.data : null;

          if (endTreatment && endTreatment.outcome) {
            if (endTreatment.outcome === 'birth') {
              births++;
            } else if (endTreatment.outcome === 'transfer') {
              transfers++;
            } else if (endTreatment.outcome === 'other') {
              other++;
            } else {
              other++;
            }
              outcomeFound = true;
          }

          if (!outcomeFound && patient.birthRecord) {
              births++;
              outcomeFound = true;
          }

          if (!outcomeFound && patient.transferRecord) {
                transfers++;
                outcomeFound = true;
          }

          if (!outcomeFound && patient.outcomeRecord) {
                  other++;
                  outcomeFound = true;
          }
          
          if (!outcomeFound) {
            noOutcome++;
          }
        });
        
        const ctx = document.getElementById('transferChart').getContext('2d');
        chartInstances['transferChart'] = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Birth', 'Transfer', 'Other', 'No Outcome'],
            datasets: [{
              data: totalPatients > 0 ? [births, transfers, other, noOutcome] : [0, 0, 0, 0],
              backgroundColor: ['#10b981', '#ef4444', '#6b7280', '#e5e7eb'],
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
              title: { display: true, text: `Treatment Outcomes (${totalPatients} patients)`, font: { size: 14, weight: 'bold' } }
            }
          }
        });

        const pct = (value) => totalPatients > 0 ? Math.round((value / totalPatients) * 100) : 0;
        
        document.getElementById('transferDetails').innerHTML = `
          <div class="detail-item"><span class="detail-label">Total Patients:</span><span class="detail-value">${totalPatients}</span></div>
          <div class="detail-item"><span class="detail-label">Birth:</span><span class="detail-value">${births} (${pct(births)}%)</span></div>
          <div class="detail-item"><span class="detail-label">Transfer:</span><span class="detail-value">${transfers} (${pct(transfers)}%)</span></div>
          <div class="detail-item"><span class="detail-label">Other:</span><span class="detail-value">${other} (${pct(other)}%)</span></div>
          <div class="detail-item"><span class="detail-label">No Outcome:</span><span class="detail-value">${noOutcome} (${pct(noOutcome)}%)</span></div>
        `;
        
      } catch (error) {
        console.error('Error loading Outcomes chart:', error);
      }
    }

    // Load comprehensive dashboard content
    async function loadDashboardContent() {
      try {
        // Load new analytics
        await loadNewAnalytics();
        
      } catch (error) {
        console.error('Error loading dashboard content:', error);
      }
    }

    // Load new analytics based on user role
    async function loadNewAnalytics() {
      try {
        if (userRole === 'TMO') {
          // Show TMO analytics with charts
          document.getElementById('tmoAnalytics').style.display = 'block';
          document.getElementById('standardAnalytics').style.display = 'none';
          
          // Load midwife filter options
          await loadMidwifeFilter();
          
          // Load TMO analytics
          await loadTMOAnalytics();
          
        } else {
          // Show TMO-style analytics for Midwives (showing only their own patients)
          document.getElementById('tmoAnalytics').style.display = 'block';
          document.getElementById('standardAnalytics').style.display = 'none';
          
          // Hide the midwife filter for midwives (they only see their own data)
          document.getElementById('midwifeFilter').closest('.analytics-card').style.display = 'none';
          
          // Load TMO analytics with current user's patients
          await loadTMOAnalytics();
        }

      } catch (error) {
        console.error('Error loading new analytics:', error);
      }
    }

    // Load ANC Analysis
    async function loadANCAnalysis() {
      try {
        const ancData = await getANCAnalysis();
        const container = document.getElementById('ancAnalysis');
        
        let html = '<div class="analytics-content">';
        html += `<div class="analytics-item"><span class="analytics-label">Early ANC (1st trimester):</span><span class="analytics-value">${ancData.earlyANC} (${ancData.earlyANCPercentage}%)</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">At least 4 ANC visits:</span><span class="analytics-value">${ancData.atLeast4ANC} (${ancData.atLeast4ANCPercentage}%)</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">TT/TD completion:</span><span class="analytics-value">${ancData.ttTdCompletion} (${ancData.ttTdCompletionPercentage}%)</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Anemia cases:</span><span class="analytics-value">${ancData.anemiaCases} (${ancData.anemiaCasesPercentage}%)</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Infection cases:</span><span class="analytics-value">${ancData.infectionCases} (${ancData.infectionCasesPercentage}%)</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Anemia treated:</span><span class="analytics-value">${ancData.anemiaTreated} (${ancData.anemiaTreatedPercentage}%)</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">High-risk pregnancies:</span><span class="analytics-value">${ancData.highRiskPregnancies} (${ancData.highRiskPregnanciesPercentage}%)</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Referred cases:</span><span class="analytics-value">${ancData.referredCases} (${ancData.referredCasesPercentage}%)</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Next pregnancy within 24 months:</span><span class="analytics-value">${ancData.nextPregnancy24Months} (${ancData.nextPregnancy24MonthsPercentage}%)</span></div>`;
        html += '</div>';
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading ANC analysis:', error);
        document.getElementById('ancAnalysis').innerHTML = '<p class="text-muted">Data not available</p>';
      }
    }

    // Load Postnatal Analysis
    async function loadPostnatalAnalysis() {
      try {
        const postnatalData = await getPostnatalAnalysis();
        const container = document.getElementById('postnatalAnalysis');
        
        let html = '<div class="analytics-content">';
        html += `<div class="analytics-item"><span class="analytics-label">Total postnatal visits:</span><span class="analytics-value">${postnatalData.totalVisits}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Patients with danger signs:</span><span class="analytics-value">${postnatalData.dangerSigns}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Vitamin B1 given:</span><span class="analytics-value">${postnatalData.vitaminB1}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Vitamin A given:</span><span class="analytics-value">${postnatalData.vitaminA}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Iron & Folic Acid:</span><span class="analytics-value">${postnatalData.ironFolicAcid}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Contraception provided:</span><span class="analytics-value">${postnatalData.contraception}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Referrals made:</span><span class="analytics-value">${postnatalData.referrals}</span></div>`;
        html += '</div>';
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading postnatal analysis:', error);
        document.getElementById('postnatalAnalysis').innerHTML = '<p class="text-muted">Data not available</p>';
      }
    }

    // Load Patient Analysis
    async function loadPatientAnalysis() {
      try {
        const patientData = await getPatientAnalysis();
        const container = document.getElementById('patientAnalysis');
        
        let html = '<div class="analytics-content">';
        html += `<div class="analytics-item"><span class="analytics-label">Total registered patients:</span><span class="analytics-value">${patientData.totalPatients}</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Average age:</span><span class="analytics-value">${patientData.averageAge} years</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Primipara (0):</span><span class="analytics-value">${patientData.primipara} (${patientData.primiparaPercentage}%)</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Multipara (1+):</span><span class="analytics-value">${patientData.multipara} (${patientData.multiparaPercentage}%)</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">High-risk pregnancies:</span><span class="analytics-value">${patientData.highRisk} (${patientData.highRiskPercentage}%)</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Early ANC visits:</span><span class="analytics-value">${patientData.earlyANC} (${patientData.earlyANCPercentage}%)</span></div>`;
        html += `<div class="analytics-item"><span class="analytics-label">Patients with complications:</span><span class="analytics-value">${patientData.complications} (${patientData.complicationsPercentage}%)</span></div>`;
        html += '</div>';
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading patient analysis:', error);
        document.getElementById('patientAnalysis').innerHTML = '<p class="text-muted">Data not available</p>';
      }
    }

    // Get ANC Analysis Data
    async function getANCAnalysis() {
      try {
        if (!analyticsData) {
          analyticsData = await buildAnalyticsData();
        }

        const patients = analyticsData?.patients || [];
        const totalPatients = patients.length;

        let earlyANC = 0;
        let atLeast4ANC = 0;
        let ttTdCompletion = 0;
        let anemiaCases = 0;
        let infectionCases = 0;
        let anemiaTreated = 0;
        let highRiskPregnancies = 0;
        let referredCases = 0;
        let nextPregnancy24Months = 0;

        patients.forEach(patient => {
          const profile = patient.profile || {};
          const visits = patient.antenatalVisits || [];

          const hasEarlyANC = profile.early_anc_visit === true ||
            (typeof profile.early_anc_visit === 'string' && profile.early_anc_visit.toLowerCase() === 'yes') ||
            (profile.early_anc_number && parseInt(profile.early_anc_number, 10) > 0);
          if (hasEarlyANC) {
            earlyANC++;
          }
          
          if (profile.high_risk === 'yes' || profile.high_risk === 'Yes') {
            highRiskPregnancies++;
          }

          if (visits.length >= 4) {
              atLeast4ANC++;
            }
            
          visits.forEach(({ data = {} }) => {
            const hemoglobin = data.hemoglobin !== undefined ? parseFloat(data.hemoglobin) : NaN;
            if (!isNaN(hemoglobin) && hemoglobin < 11) {
                anemiaCases++;
              }
              
            if (data.ironFolicAcid === 'Given' ||
              (typeof data.treatmentGiven === 'string' && data.treatmentGiven.toLowerCase().includes('iron'))) {
                anemiaTreated++;
              }
              
            if (data.referral === 'Yes') {
                referredCases++;
              }
              
            if (data.ttTdCompletion === 'Complete') {
              ttTdCompletion++;
            }

            if (data.hiv === 'Positive' ||
              data.syphilis === 'Positive' ||
              data.hepatitisB === 'Positive' ||
              data.hepatitisC === 'Positive') {
              infectionCases++;
            }
          });
        });

        const pct = (value) => totalPatients > 0 ? Math.round((value / totalPatients) * 100) : 0;

        return {
          earlyANC,
          earlyANCPercentage: pct(earlyANC),
          atLeast4ANC,
          atLeast4ANCPercentage: pct(atLeast4ANC),
          ttTdCompletion,
          ttTdCompletionPercentage: pct(ttTdCompletion),
          anemiaCases,
          anemiaCasesPercentage: pct(anemiaCases),
          infectionCases,
          infectionCasesPercentage: pct(infectionCases),
          anemiaTreated,
          anemiaTreatedPercentage: pct(anemiaTreated),
          highRiskPregnancies,
          highRiskPregnanciesPercentage: pct(highRiskPregnancies),
          referredCases,
          referredCasesPercentage: pct(referredCases),
          nextPregnancy24Months,
          nextPregnancy24MonthsPercentage: pct(nextPregnancy24Months)
        };
      } catch (error) {
        console.error('Error getting ANC analysis:', error);
        return {
          earlyANC: 0, earlyANCPercentage: 0,
          atLeast4ANC: 0, atLeast4ANCPercentage: 0,
          ttTdCompletion: 0, ttTdCompletionPercentage: 0,
          anemiaCases: 0, anemiaCasesPercentage: 0,
          infectionCases: 0, infectionCasesPercentage: 0,
          anemiaTreated: 0, anemiaTreatedPercentage: 0,
          highRiskPregnancies: 0, highRiskPregnanciesPercentage: 0,
          referredCases: 0, referredCasesPercentage: 0,
          nextPregnancy24Months: 0, nextPregnancy24MonthsPercentage: 0
        };
      }
    }

    // Get Postnatal Analysis Data
    async function getPostnatalAnalysis() {
      try {
        if (!analyticsData) {
          analyticsData = await buildAnalyticsData();
        }

        const patients = analyticsData?.patients || [];

        let totalVisits = 0;
        let dangerSigns = 0;
        let vitaminB1 = 0;
        let vitaminA = 0;
        let ironFolicAcid = 0;
        let contraception = 0;
        let referrals = 0;

        patients.forEach(patient => {
          const visits = patient.postpartumVisits || [];
          totalVisits += visits.length;

          visits.forEach(({ data = {} }) => {
            if (data.dangerSigns && Object.keys(data.dangerSigns).some(key => data.dangerSigns[key] === true)) {
                dangerSigns++;
              }
              
            if (data.vitaminB1 === 'Yes') vitaminB1++;
            if (data.vitaminA === 'Yes') vitaminA++;
            if (data.ironFolicAcid === 'Yes') ironFolicAcid++;

            if (data.contraceptionMethod && data.contraceptionMethod !== '') {
                contraception++;
              }
              
            if (data.referral === 'Yes' || data.referred === 'Yes') {
                referrals++;
              }
            });
        });

        return {
          totalVisits,
          dangerSigns,
          vitaminB1,
          vitaminA,
          ironFolicAcid,
          contraception,
          referrals
        };
      } catch (error) {
        console.error('Error getting postnatal analysis:', error);
        return {
          totalVisits: 0, dangerSigns: 0, vitaminB1: 0, vitaminA: 0,
          ironFolicAcid: 0, contraception: 0, referrals: 0
        };
      }
    }

    // Get Patient Analysis Data
    async function getPatientAnalysis() {
      try {
        if (!analyticsData) {
          analyticsData = await buildAnalyticsData();
        }

        const patients = analyticsData?.patients || [];

        let totalAge = 0;
        let primipara = 0;
        let multipara = 0;
        let highRisk = 0;
        let earlyANC = 0;
        let complications = 0;

        const totalPatients = patients.length;

        const parseParity = (value) => {
          if (value === undefined || value === null) return null;
          if (typeof value === 'number') return value;
          if (typeof value === 'string') {
            const trimmed = value.trim();
            if (!trimmed) return null;
            const direct = parseInt(trimmed, 10);
            if (!isNaN(direct)) return direct;
            const match = trimmed.match(/P(\d+)/i);
            if (match && match[1]) {
              const parsed = parseInt(match[1], 10);
              if (!isNaN(parsed)) return parsed;
            }
          }
          return null;
        };

        patients.forEach(patient => {
          const data = patient.profile || {};

          if (data.age) {
            const ageVal = parseInt(data.age, 10);
            if (!isNaN(ageVal)) {
              totalAge += ageVal;
            }
          }
          
          const parityValue = parseParity(data.parity);
          if (parityValue === 0) {
            primipara++;
          } else if (parityValue && parityValue > 0) {
            multipara++;
          }
          
          if (data.high_risk_pregnancy === 'Yes' || data.highRiskPregnancy === 'Yes' || 
              data.high_risk === 'Yes' || data.highRisk === 'Yes' ||
              data.high_risk_pregnancy === true || data.highRiskPregnancy === true) {
            highRisk++;
          }
          
          const hasEarlyANC = data.early_anc_visit === true ||
            (typeof data.early_anc_visit === 'string' && data.early_anc_visit.toLowerCase() === 'yes') ||
            (data.early_anc_number && parseInt(data.early_anc_number, 10) > 0);
          if (hasEarlyANC) {
            earlyANC++;
          }
          
          if (data.risk_factors) {
            if (Array.isArray(data.risk_factors) && data.risk_factors.length > 0) {
              complications++;
            } else if (typeof data.risk_factors === 'string' && data.risk_factors.trim() !== '') {
              complications++;
            }
          }
        });

        const pct = (value) => totalPatients > 0 ? Math.round((value / totalPatients) * 100) : 0;

        return {
          totalPatients,
          averageAge: totalPatients > 0 ? Math.round(totalAge / totalPatients) : 0,
          primipara,
          primiparaPercentage: pct(primipara),
          multipara,
          multiparaPercentage: pct(multipara),
          highRisk,
          highRiskPercentage: pct(highRisk),
          earlyANC,
          earlyANCPercentage: pct(earlyANC),
          complications,
          complicationsPercentage: pct(complications)
        };
      } catch (error) {
        console.error('Error getting patient analysis:', error);
        return {
          totalPatients: 0, averageAge: 0, 
          primipara: 0, primiparaPercentage: 0,
          multipara: 0, multiparaPercentage: 0,
          highRisk: 0, highRiskPercentage: 0,
          earlyANC: 0, earlyANCPercentage: 0,
          complications: 0, complicationsPercentage: 0
        };
      }
    }

    // Go back function
    function goBack() {
      window.history.back();
    }



    // Initialize dashboard when page loads
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        initializeDashboard();
      } else {
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>
