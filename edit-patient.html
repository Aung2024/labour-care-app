<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Patient - Maternal & Child Health Care System</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="js/firebase.js"></script>
  <style>
    :root {
      --primary-color: #3b82f6;
      --secondary-color: #1e40af;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --light-bg: #f8fafc;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    body {
      background: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .header-section {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1.5rem 0;
      margin-bottom: 2rem;
    }

    .form-section {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
      border-left: 4px solid var(--primary-color);
    }

    .section-title {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 0.5rem;
    }

    .patient-info-banner {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border-left: 4px solid var(--primary-color);
    }

    .btn-update {
      background: linear-gradient(135deg, var(--success-color), #059669);
      border: none;
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-update:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      color: white;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-antenatal { background: #dcfce7; color: #166534; }
    .status-labour { background: #fef3c7; color: #92400e; }
    .status-postpartum { background: #e0e7ff; color: #3730a3; }

    .loading-spinner {
      display: none;
      text-align: center;
      padding: 2rem;
    }

    .alert-info {
      background: #dbeafe;
      border: 1px solid var(--primary-color);
      color: #1e40af;
    }

    .footer {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      color: #374151;
      text-align: center;
      padding: 2rem;
      margin-top: 2rem;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: var(--card-shadow);
    }

    /* Report buttons styling */
    .report-btn {
      transition: all 0.3s ease;
      border-width: 2px;
      font-weight: 500;
    }

    .report-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .report-btn.btn-outline-primary:hover {
      background: #2563eb;
      border-color: #2563eb;
      color: white;
    }

    .report-btn.btn-outline-success:hover {
      background: #059669;
      border-color: #059669;
      color: white;
    }

    .report-btn.btn-outline-danger:hover {
      background: #dc2626;
      border-color: #dc2626;
      color: white;
    }

    .report-btn.btn-outline-warning:hover {
      background: #d97706;
      border-color: #d97706;
      color: white;
    }

    /* Mobile-first Action Buttons */
    .action-buttons-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-width: 400px;
      margin: 0 auto;
    }

    .btn-action {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
      min-height: 56px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-action i {
      font-size: 1.1rem;
      width: 20px;
      text-align: center;
    }

    .btn-reset {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
    }

    .btn-reset:hover {
      background: linear-gradient(135deg, #4b5563, #374151);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
      color: white;
    }

    .btn-update {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .btn-update:hover {
      background: linear-gradient(135deg, #059669, #047857);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      color: white;
    }

    .btn-cancel {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .btn-cancel:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      color: white;
    }

    /* Desktop layout */
    @media (min-width: 768px) {
      .action-buttons-container {
        flex-direction: row;
        max-width: none;
        justify-content: center;
      }

      .btn-action {
        flex: 1;
        max-width: 200px;
      }
    }

    /* Mobile responsive */
    @media (max-width: 767px) {
      .btn-action {
        width: 100%;
        padding: 1.25rem 1.5rem;
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header-section">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="mb-0">
            <i class="fas fa-user-edit me-3"></i>
            Edit Patient Data
          </h1>
        </div>
        <div class="col-md-4 text-end">
          <div class="d-flex align-items-center justify-content-end gap-3">
            <a href="list.html" class="btn btn-outline-light btn-sm">
              <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
            <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
              <i class="fas fa-sign-out-alt me-2"></i>Logout
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading patient data...</p>
    </div>

    <!-- Patient Information Banner -->
    <div class="patient-info-banner" id="patientBanner" style="display: none;">
      <div class="row">
        <div class="col-md-8">
          <h4 id="currentPatientName">Patient Name</h4>
          <div class="row">
            <div class="col-md-3">
              <small><strong>Current Status:</strong> <span id="currentStatus" class="status-badge">-</span></small>
            </div>
            <div class="col-md-3">
              <small><strong>Age:</strong> <span id="currentAge">-</span></small>
            </div>
            <div class="col-md-3">
              <small><strong>Created:</strong> <span id="createdDate">-</span></small>
            </div>
          </div>
        </div>
        <div class="col-md-4 text-end">
          <div class="alert alert-info mb-0">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Editing Mode</strong><br>
            <small>Make changes and click Update to save</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Patient Form -->
    <form id="editPatientForm" style="display: none;">
      <!-- Basic Information -->
      <div class="form-section">
        <h5 class="section-title">
          <i class="fas fa-user me-2"></i>Basic Information
        </h5>
        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label required-field">Patient Name</label>
              <input type="text" name="name" id="name" class="form-control" required>
            </div>
          </div>
          <div class="col-md-2">
            <div class="mb-3">
              <label class="form-label required-field">Age</label>
              <input type="number" name="age" id="age" class="form-control" min="10" max="60" required>
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Phone Number</label>
              <input type="tel" name="phone" id="phone" class="form-control">
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Patient Address</label>
              <input type="text" name="patient_address" id="patient_address" class="form-control">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Emergency Contact Name</label>
              <input type="text" name="emergency_contact" id="emergency_contact" class="form-control">
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Emergency Contact Phone</label>
              <input type="tel" name="emergency_phone" id="emergency_phone" class="form-control">
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Parity</label>
              <input type="text" name="parity" id="parity" class="form-control">
            </div>
          </div>
        </div>
        
        <!-- High Risk Pregnancy Assessment -->
        <div class="row mt-3">
          <div class="col-md-12">
            <div class="mb-3">
              <label class="form-label">High Risk Pregnancy Assessment</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="high_risk" id="highRiskNo" value="no" onchange="toggleHighRiskDetails()">
                <label class="form-check-label" for="highRiskNo">
                  No - Standard risk pregnancy
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="high_risk" id="highRiskYes" value="yes" onchange="toggleHighRiskDetails()">
                <label class="form-check-label" for="highRiskYes">
                  Yes - High risk pregnancy
                </label>
              </div>
              <div id="highRiskDetails" style="display: none;" class="mt-3">
                <label class="form-label">High Risk Factors (select all that apply):</label>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="riskFactors" id="riskAge" value="maternal_age">
                      <label class="form-check-label" for="riskAge">Maternal age ≥35 years</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="riskFactors" id="riskDiabetes" value="diabetes">
                      <label class="form-check-label" for="riskDiabetes">Diabetes (pre-existing or gestational)</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="riskFactors" id="riskHypertension" value="hypertension">
                      <label class="form-check-label" for="riskHypertension">Hypertension</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="riskFactors" id="riskPrevious" value="previous_complications">
                      <label class="form-check-label" for="riskPrevious">Previous pregnancy complications</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="riskFactors" id="riskMultiple" value="multiple_pregnancy">
                      <label class="form-check-label" for="riskMultiple">Multiple pregnancy</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="riskFactors" id="riskPlacenta" value="placenta_issues">
                      <label class="form-check-label" for="riskPlacenta">Placenta previa/abruption</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="riskFactors" id="riskOther" value="other">
                      <label class="form-check-label" for="riskOther">Other medical conditions</label>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <label class="form-label">Additional Notes:</label>
                  <textarea name="risk_notes" id="risk_notes" class="form-control" rows="3" placeholder="Describe any other risk factors or concerns"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Early ANC Visit -->
        <div class="row mt-3">
          <div class="col-md-12">
            <div class="mb-3">
              <label class="form-label">Early ANC Visit</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="early_anc_visit" id="early_anc_visit">
                <label class="form-check-label" for="early_anc_visit">
                  Patient had early ANC visit (before 12 weeks)
                </label>
              </div>
            </div>
          </div>
        </div>
        </div>
      </div>



      <!-- Delivery Information (for postpartum patients) -->
      <div class="form-section" id="deliverySection" style="display: none;">
        <h5 class="section-title">
          <i class="fas fa-heart me-2"></i>Delivery Information
        </h5>
        <div class="row">
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Delivery Date</label>
              <input type="date" name="delivery_date" id="delivery_date" class="form-control">
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Delivery Type</label>
              <select name="delivery_type" id="delivery_type" class="form-control">
                <option value="">Select type</option>
                <option value="Normal Vaginal Delivery">Normal Vaginal Delivery</option>
                <option value="Assisted Vaginal Delivery">Assisted Vaginal Delivery</option>
                <option value="Cesarean Section">Cesarean Section</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Birth Weight (kg)</label>
              <input type="number" name="birth_weight" id="birth_weight" class="form-control" step="0.01" min="0" max="10">
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Treatment Outcome</label>
              <select name="treatment_outcome" id="treatment_outcome" class="form-control">
                <option value="">Select outcome</option>
                <option value="birth">Birth</option>
                <option value="transfer">Transfer</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
        </div>
      </div>


      <!-- Action Buttons -->
      <div class="form-section">
        <div class="action-buttons-container">
          <button type="button" class="btn-action btn-reset" onclick="resetForm()">
            <i class="fas fa-undo"></i>
            <span>Reset Changes</span>
          </button>
          <button type="submit" class="btn-action btn-update">
            <i class="fas fa-save"></i>
            <span>Update Patient Data</span>
          </button>
          <a href="list.html" class="btn-action btn-cancel">
            <i class="fas fa-times"></i>
            <span>Cancel</span>
          </a>
        </div>
      </div>
    </form>
  </div>

  <script>
    let currentUser = null;
    let currentPatient = null;
    let patientId = null;
    let originalData = {};

    // Get patient ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    patientId = urlParams.get('id') || urlParams.get('patient'); // Support both 'id' and 'patient' parameters
    
    console.log('Edit Patient Page - URL search params:', window.location.search);
    console.log('Edit Patient Page - Patient ID found:', patientId);

    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
        if (patientId) {
          loadPatientData();
        } else {
          alert("No patient ID provided. Redirecting to patient list.");
          window.location.href = "list.html";
        }
      }
    });


    async function loadPatientData() {
      try {
        document.getElementById("loadingSpinner").style.display = "block";
        
        const patientDoc = await db.collection("patients").doc(patientId).get();
        if (patientDoc.exists) {
          currentPatient = patientDoc.data();
          originalData = { ...currentPatient }; // Store original data
          
          populateForm();
          updatePatientBanner();
          
          document.getElementById("loadingSpinner").style.display = "none";
          document.getElementById("patientBanner").style.display = "block";
          document.getElementById("editPatientForm").style.display = "block";
        } else {
          alert("Patient not found!");
          window.location.href = "list.html";
        }
      } catch (error) {
        console.error("Error loading patient data:", error);
        alert("Error loading patient data: " + error.message);
        window.location.href = "list.html";
      }
    }

    function populateForm() {
      // Populate all form fields with current patient data
      const fields = [
        'name', 'age', 'phone', 'patient_address', 'emergency_contact', 
        'emergency_phone', 'parity', 'delivery_date', 'delivery_type', 'birth_weight', 
        'treatment_outcome', 'registration_date', 'high_risk', 'risk_notes'
      ];

      fields.forEach(field => {
        const element = document.getElementById(field);
        if (element && currentPatient[field] !== undefined) {
          element.value = currentPatient[field] || '';
        }
      });

      // Special handling for Early ANC checkbox
      const earlyAncVisitCheckbox = document.getElementById('early_anc_visit');
      if (earlyAncVisitCheckbox) {
        earlyAncVisitCheckbox.checked = currentPatient.early_anc_visit === true;
        toggleEarlyAncNumberEdit(); // Show/hide number field based on checkbox
      }

      // Special handling for High Risk assessment
      if (currentPatient.high_risk === 'yes') {
        document.getElementById('highRiskYes').checked = true;
        document.getElementById('highRiskNo').checked = false;
        toggleHighRiskDetailsEdit(); // Show risk factors
        
        // Populate risk factors checkboxes
        if (currentPatient.risk_factors && Array.isArray(currentPatient.risk_factors)) {
          currentPatient.risk_factors.forEach(factor => {
            const checkbox = document.querySelector(`input[name="riskFactors"][value="${factor}"]`);
            if (checkbox) {
              checkbox.checked = true;
            }
          });
        }
      } else {
        document.getElementById('highRiskNo').checked = true;
        document.getElementById('highRiskYes').checked = false;
        toggleHighRiskDetailsEdit(); // Hide risk factors
      }

      // Show/hide delivery section based on status
      toggleDeliverySection();
      
      // Add event listeners
      const highRiskYesElement = document.getElementById('highRiskYes');
      if (highRiskYesElement) {
        highRiskYesElement.addEventListener('change', toggleHighRiskDetailsEdit);
      }
      
      const highRiskNoElement = document.getElementById('highRiskNo');
      if (highRiskNoElement) {
        highRiskNoElement.addEventListener('change', toggleHighRiskDetailsEdit);
      }
    }

    function toggleDeliverySection() {
      const deliverySection = document.getElementById('deliverySection');
      if (deliverySection) {
        // Hide delivery section by default since status is now automatic
        deliverySection.style.display = 'none';
      }
    }

    function updatePatientBanner() {
      document.getElementById("currentPatientName").textContent = currentPatient.name || 'Unknown Patient';
      document.getElementById("currentAge").textContent = currentPatient.age || 'N/A';
      
      // Update status badge
      const statusElement = document.getElementById("currentStatus");
      const status = currentPatient.status || currentPatient.treatmentStatus || 'antenatal';
      statusElement.textContent = getStatusText(status);
      statusElement.className = `status-badge ${getStatusClass(status)}`;
      
      // Update created date
      const createdDate = currentPatient.created_at ? 
        new Date(currentPatient.created_at.seconds * 1000).toLocaleDateString() : 
        'Unknown';
      document.getElementById("createdDate").textContent = createdDate;
    }

    function getStatusClass(status) {
      switch(status) {
        case 'antenatal':
        case 'active':
          return 'status-antenatal';
        case 'labour':
          return 'status-labour';
        case 'postpartum':
          return 'status-postpartum';
        default:
          return 'status-antenatal';
      }
    }

    function getStatusText(status) {
      switch(status) {
        case 'antenatal':
        case 'active':
          return 'Antenatal';
        case 'labour':
          return 'Labour Care';
        case 'postpartum':
          return 'Postnatal';
        default:
          return 'Antenatal';
      }
    }


    // Toggle Early ANC number field in edit form
    function toggleEarlyAncNumberEdit() {
      // Early ANC number field has been removed as per new logic
      // This function is kept for backward compatibility but does nothing
      return;
    }

    // Toggle High Risk details in edit form
    function toggleHighRiskDetailsEdit() {
      const highRiskYes = document.getElementById('highRiskYes').checked;
      const highRiskDetails = document.getElementById('highRiskDetails');
      
      if (highRiskYes) {
        highRiskDetails.style.display = 'block';
      } else {
        highRiskDetails.style.display = 'none';
        // Clear all checkboxes when hiding
        const checkboxes = highRiskDetails.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => checkbox.checked = false);
      }
    }

    // Toggle high risk details visibility
    function toggleHighRiskDetails() {
      const highRiskYes = document.getElementById('highRiskYes');
      const highRiskDetails = document.getElementById('highRiskDetails');
      
      if (highRiskYes.checked) {
        highRiskDetails.style.display = 'block';
      } else {
        highRiskDetails.style.display = 'none';
      }
    }

    function resetForm() {
      if (confirm("Are you sure you want to reset all changes? This will restore the original patient data.")) {
        populateForm();
      }
    }


    // Form submission
    document.getElementById("editPatientForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      
      try {
        const submitButton = e.target.querySelector('button[type="submit"]');
        if (submitButton) {
          const originalText = submitButton.innerHTML;
          submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
          submitButton.disabled = true;
        }

        const formData = new FormData(e.target);
        const updatedData = {};
        
        // Convert form data to object
        for (let [key, value] of formData.entries()) {
          updatedData[key] = value || null;
        }
        
        // Special handling for Early ANC checkbox
        const earlyAncVisitCheckbox = document.getElementById('early_anc_visit');
        updatedData.early_anc_visit = earlyAncVisitCheckbox ? earlyAncVisitCheckbox.checked : false;
        
        // Special handling for High Risk factors
        const riskFactorCheckboxes = document.querySelectorAll('input[name="riskFactors"]:checked');
        const riskFactors = Array.from(riskFactorCheckboxes).map(checkbox => checkbox.value);
        updatedData.risk_factors = riskFactors;
        
        // Add metadata
        updatedData.last_updated = firebase.firestore.FieldValue.serverTimestamp();
        updatedData.updated_by = currentUser.uid;
        
        // Keep original creation data
        updatedData.created_at = currentPatient.created_at;
        updatedData.created_by = currentPatient.created_by || currentPatient.createdBy;
        updatedData.township = currentPatient.township; // Keep original township
        
        // Update patient in Firestore
        await db.collection("patients").doc(patientId).update(updatedData);
        
        alert("Patient data updated successfully!");
        window.location.href = "list.html";
        
      } catch (error) {
        console.error("Error updating patient data:", error);
        alert("Error updating patient data: " + error.message);
        
        // Reset button
        const submitButton = document.querySelector('button[type="submit"]');
        if (submitButton) {
          submitButton.innerHTML = '<i class="fas fa-save me-2"></i>Update Patient Data';
          submitButton.disabled = false;
        }
      }
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>

  <footer class="footer">
    <div class="container">
      <p class="mb-0">
        <i class="fas fa-heart me-2"></i>
        © 2025 Maternal & Child Health Care System — Designed for clinical excellence - Powered by Jhpiego Myanmar
      </p>
    </div>
  </footer>
</body>
</html>
