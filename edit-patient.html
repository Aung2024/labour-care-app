<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Patient - Maternal & Child Health Care System</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="js/firebase.js"></script>
  <style>
    :root {
      --primary-color: #3b82f6;
      --secondary-color: #1e40af;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --light-bg: #f8fafc;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    body {
      background: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .header-section {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1.5rem 0;
      margin-bottom: 2rem;
    }

    .form-section {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
      border-left: 4px solid var(--primary-color);
    }

    .section-title {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 0.5rem;
    }


    .btn-update {
      background: linear-gradient(135deg, var(--success-color), #059669);
      border: none;
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-update:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      color: white;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-antenatal { background: #dcfce7; color: #166534; }
    .status-labour { background: #fef3c7; color: #92400e; }
    .status-postpartum { background: #e0e7ff; color: #3730a3; }

    .loading-spinner {
      display: none;
      text-align: center;
      padding: 2rem;
    }

    .alert-info {
      background: #dbeafe;
      border: 1px solid var(--primary-color);
      color: #1e40af;
    }

    .footer {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      color: #374151;
      text-align: center;
      padding: 2rem;
      margin-top: 2rem;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: var(--card-shadow);
    }

    /* Parity System Styling */
    .form-label-sm {
      display: block;
      font-weight: 600;
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 0.35rem;
    }

    .parity-selects {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      background: rgba(59, 130, 246, 0.08);
      border: 1px solid rgba(59, 130, 246, 0.18);
      border-radius: 16px;
      padding: 1rem 1.25rem;
      min-height: 80px;
    }

    .parity-selects .select-block {
      flex: 1 1 160px;
      display: flex;
      flex-direction: column;
    }

    .parity-selects .select-block label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--primary-color);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.35rem;
    }

    .parity-selects .select-block select {
      border-radius: 12px;
      border: 2px solid rgba(59, 130, 246, 0.35);
      height: 48px;
      font-weight: 600;
      color: #1f2937;
      background: rgba(255, 255, 255, 0.92);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .parity-selects .select-block select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
    }

    .parity-selects .parity-plus {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: white;
      color: var(--primary-color);
      font-size: 1.25rem;
      font-weight: 700;
      box-shadow: 0 8px 18px -8px rgba(59, 130, 246, 0.45);
      margin: auto 0;
    }

    .parity-helper {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 0.75rem;
    }

    /* Report buttons styling */
    .report-btn {
      transition: all 0.3s ease;
      border-width: 2px;
      font-weight: 500;
    }

    .report-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .report-btn.btn-outline-primary:hover {
      background: #2563eb;
      border-color: #2563eb;
      color: white;
    }

    .report-btn.btn-outline-success:hover {
      background: #059669;
      border-color: #059669;
      color: white;
    }

    .report-btn.btn-outline-danger:hover {
      background: #dc2626;
      border-color: #dc2626;
      color: white;
    }

    .report-btn.btn-outline-warning:hover {
      background: #d97706;
      border-color: #d97706;
      color: white;
    }

    /* Mobile-first Action Buttons */
    .action-buttons-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-width: 400px;
      margin: 0 auto;
    }

    .btn-action {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
      min-height: 56px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-action i {
      font-size: 1.1rem;
      width: 20px;
      text-align: center;
    }

    .btn-reset {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
    }

    .btn-reset:hover {
      background: linear-gradient(135deg, #4b5563, #374151);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
      color: white;
    }

    .btn-update {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .btn-update:hover {
      background: linear-gradient(135deg, #059669, #047857);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      color: white;
    }

    .btn-cancel {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .btn-cancel:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      color: white;
    }

    .btn-delete {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: white;
    }

    .btn-delete:hover {
      background: linear-gradient(135deg, #b91c1c, #991b1b);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
      color: white;
    }

    /* Desktop layout */
    @media (min-width: 768px) {
      .action-buttons-container {
        flex-direction: row;
        max-width: none;
        justify-content: center;
      }

      .btn-action {
        flex: 1;
        max-width: 200px;
      }
    }

    /* Mobile responsive */
    @media (max-width: 767px) {
      .btn-action {
        width: 100%;
        padding: 1.25rem 1.5rem;
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header-section">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="mb-0">
            <i class="fas fa-user-edit me-3"></i>
            Edit Patient Data
          </h1>
        </div>
        <div class="col-md-4 text-end">
          <div class="d-flex align-items-center justify-content-end gap-3">
            <a href="list.html" class="btn btn-outline-light btn-sm">
              <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
            <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
              <i class="fas fa-sign-out-alt me-2"></i>Logout
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading patient data...</p>
    </div>

    <!-- Patient Name Header -->
    <div class="mb-4" id="patientNameHeader" style="display: none;">
      <h2 class="mb-0">
        <i class="fas fa-user me-2"></i>
        <span id="currentPatientName">Patient Name</span>
      </h2>
    </div>

    <!-- Edit Patient Form -->
    <form id="editPatientForm" style="display: none;">
      <!-- Basic Information -->
      <div class="form-section">
        <h5 class="section-title">
          <i class="fas fa-user me-2"></i>Basic Information
        </h5>
        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label required-field">Patient Name</label>
              <input type="text" name="name" id="name" class="form-control" required>
            </div>
          </div>
          <div class="col-md-2">
            <div class="mb-3">
              <label class="form-label required-field">Age</label>
              <input type="number" name="age" id="age" class="form-control" min="10" max="60" required>
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Phone Number</label>
              <input type="tel" name="phone" id="phone" class="form-control">
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Patient Address</label>
              <input type="text" name="patient_address" id="patient_address" class="form-control">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">Emergency Contact Name</label>
              <input type="text" name="emergency_contact" id="emergency_contact" class="form-control">
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Emergency Contact Phone</label>
              <input type="tel" name="emergency_phone" id="emergency_phone" class="form-control">
            </div>
          </div>
            </div>
                <div class="row">
                  <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Parity & Gravida</label>
              <div class="parity-selects">
                <div class="select-block">
                  <label for="gravidaSelect">Gravida (G)</label>
                  <select name="gravida_value" id="gravidaSelect" class="form-control">
                    <option value="">Select</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                  </select>
                    </div>
                <div class="select-block">
                  <label for="parityPrimarySelect">Parity</label>
                  <select name="parity_primary" id="parityPrimarySelect" class="form-control">
                    <option value="">Select</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                  </select>
                    </div>
                <div class="parity-plus">+</div>
                <div class="select-block">
                  <label for="paritySecondarySelect"></label>
                  <select name="parity_secondary" id="paritySecondarySelect" class="form-control">
                    <option value="">Select</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                  </select>
                    </div>
                    </div>
              <input type="hidden" name="parity" id="parity" value="">
              <input type="hidden" name="pregnancyWithin24Months" id="pregnancyWithin24Months" value="false">
              <div class="parity-helper">
                Stored as <span id="parityPreview">‚Äî</span>
                  </div>
              <div id="youngestChildFields" class="mt-3" style="display: none;">
                <label class="form-label">Age of Youngest Child</label>
                <div class="row g-3 align-items-end">
                  <div class="col-6">
                    <label for="youngestChildAgeYears" class="form-label-sm">Years</label>
                    <input type="number" min="0" max="25" class="form-control" id="youngestChildAgeYears" name="youngestChildAgeYears" placeholder="Years">
                    </div>
                  <div class="col-6">
                    <label for="youngestChildAgeMonths" class="form-label-sm">Months</label>
                    <input type="number" min="0" max="11" class="form-control" id="youngestChildAgeMonths" name="youngestChildAgeMonths" placeholder="Months">
                    </div>
                    </div>
                <div id="pregnancy24Alert" class="alert alert-warning mt-3" style="display: none;">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  This pregnancy occurred within 24 months of the last birth. Please monitor closely.
                  </div>
                </div>
            </div>
          </div>
        </div>
        </div>
      </div>



      <!-- Delivery Information (for postpartum patients) -->
      <div class="form-section" id="deliverySection" style="display: none;">
        <h5 class="section-title">
          <i class="fas fa-heart me-2"></i>Delivery Information
        </h5>
        <div class="row">
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Delivery Date</label>
              <input type="date" name="delivery_date" id="delivery_date" class="form-control">
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Delivery Type</label>
              <select name="delivery_type" id="delivery_type" class="form-control">
                <option value="">Select type</option>
                <option value="Normal Vaginal Delivery">Normal Vaginal Delivery</option>
                <option value="Assisted Vaginal Delivery">Assisted Vaginal Delivery</option>
                <option value="Cesarean Section">Cesarean Section</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Birth Weight (kg)</label>
              <input type="number" name="birth_weight" id="birth_weight" class="form-control" step="0.01" min="0" max="10">
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label class="form-label">Treatment Outcome</label>
              <select name="treatment_outcome" id="treatment_outcome" class="form-control">
                <option value="">Select outcome</option>
                <option value="birth">Birth</option>
                <option value="transfer">Transfer</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
        </div>
      </div>


      <!-- Action Buttons -->
      <div class="form-section">
        <div class="action-buttons-container">
          <button type="button" class="btn-action btn-reset" onclick="resetForm()">
            <i class="fas fa-undo"></i>
            <span>Reset Changes</span>
          </button>
          <button type="submit" class="btn-action btn-update">
            <i class="fas fa-save"></i>
            <span>Update Patient Data</span>
          </button>
          <button type="button" class="btn-action btn-delete" onclick="deletePatient()">
            <i class="fas fa-trash-alt"></i>
            <span>Delete Patient</span>
          </button>
          <a href="list.html" class="btn-action btn-cancel">
            <i class="fas fa-times"></i>
            <span>Cancel</span>
          </a>
        </div>
      </div>
    </form>
  </div>

  <script>
    let currentUser = null;
    let currentPatient = null;
    let patientId = null;
    let originalData = {};

    // Get patient ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    patientId = urlParams.get('id') || urlParams.get('patient'); // Support both 'id' and 'patient' parameters
    
    console.log('Edit Patient Page - URL search params:', window.location.search);
    console.log('Edit Patient Page - Patient ID found:', patientId);

    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
        if (patientId) {
          loadPatientData();
        } else {
          alert("No patient ID provided. Redirecting to patient list.");
          window.location.href = "list.html";
        }
      }
    });


    async function loadPatientData() {
      try {
        document.getElementById("loadingSpinner").style.display = "block";
        
        const patientDoc = await db.collection("patients").doc(patientId).get();
        if (patientDoc.exists) {
          currentPatient = patientDoc.data();
          originalData = { ...currentPatient }; // Store original data
          
          populateForm();
          updatePatientBanner();
          initializeParitySystem();
          
          document.getElementById("loadingSpinner").style.display = "none";
          document.getElementById("patientNameHeader").style.display = "block";
          document.getElementById("editPatientForm").style.display = "block";
        } else {
          alert("Patient not found!");
          window.location.href = "list.html";
        }
      } catch (error) {
        console.error("Error loading patient data:", error);
        alert("Error loading patient data: " + error.message);
        window.location.href = "list.html";
      }
    }

    function populateForm() {
      // Populate all form fields with current patient data
      const fields = [
        'name', 'age', 'phone', 'patient_address', 'emergency_contact', 
        'emergency_phone', 'delivery_date', 'delivery_type', 'birth_weight', 
        'treatment_outcome', 'registration_date'
      ];

      fields.forEach(field => {
        const element = document.getElementById(field);
        if (element && currentPatient[field] !== undefined) {
          element.value = currentPatient[field] || '';
        }
      });

      // Populate parity fields
      if (currentPatient.gravida !== undefined && currentPatient.gravida !== null) {
        const gravidaSelect = document.getElementById('gravidaSelect');
        if (gravidaSelect) {
          gravidaSelect.value = currentPatient.gravida.toString();
        }
      }
      
      if (currentPatient.parity_primary !== undefined && currentPatient.parity_primary !== null) {
        const parityPrimarySelect = document.getElementById('parityPrimarySelect');
        if (parityPrimarySelect) {
          parityPrimarySelect.value = currentPatient.parity_primary.toString();
        }
      }
      
      if (currentPatient.parity_secondary !== undefined && currentPatient.parity_secondary !== null) {
        const paritySecondarySelect = document.getElementById('paritySecondarySelect');
        if (paritySecondarySelect) {
          paritySecondarySelect.value = currentPatient.parity_secondary.toString();
        }
      }

      // Populate youngest child age fields
      if (currentPatient.youngest_child_age_years !== undefined && currentPatient.youngest_child_age_years !== null) {
        const youngestYearsInput = document.getElementById('youngestChildAgeYears');
        if (youngestYearsInput) {
          youngestYearsInput.value = currentPatient.youngest_child_age_years.toString();
        }
      }
      
      if (currentPatient.youngest_child_age_months !== undefined && currentPatient.youngest_child_age_months !== null) {
        const youngestMonthsInput = document.getElementById('youngestChildAgeMonths');
        if (youngestMonthsInput) {
          youngestMonthsInput.value = currentPatient.youngest_child_age_months.toString();
        }
      }

      // Show/hide delivery section based on status
      toggleDeliverySection();
      
      // Update parity field after populating (will be called again in initializeParitySystem)
      setTimeout(() => {
        const parityHiddenInput = document.getElementById('parity');
        const parityPreview = document.getElementById('parityPreview');
        if (parityHiddenInput && parityPreview) {
          const currentParity = currentPatient.parity || '';
          parityHiddenInput.value = currentParity;
          parityPreview.textContent = currentParity || '‚Äî';
        }
      }, 100);
    }

    function toggleDeliverySection() {
      const deliverySection = document.getElementById('deliverySection');
      if (deliverySection) {
        // Hide delivery section by default since status is now automatic
        deliverySection.style.display = 'none';
      }
    }

    function updatePatientBanner() {
      document.getElementById("currentPatientName").textContent = currentPatient.name || 'Unknown Patient';
    }



    // Parity System Functions
    function initializeParitySystem() {
      const parityHiddenInput = document.getElementById('parity');
      const parityPreview = document.getElementById('parityPreview');
      const parityControls = {
        gravida: document.getElementById('gravidaSelect'),
        primary: document.getElementById('parityPrimarySelect'),
        secondary: document.getElementById('paritySecondarySelect')
      };
      const youngestChildFields = document.getElementById('youngestChildFields');
      const youngestChildAgeYearsInput = document.getElementById('youngestChildAgeYears');
      const youngestChildAgeMonthsInput = document.getElementById('youngestChildAgeMonths');
      const pregnancyAlert = document.getElementById('pregnancy24Alert');
      const pregnancyFlagInput = document.getElementById('pregnancyWithin24Months');

      function buildParityString() {
        const g = parityControls.gravida ? parityControls.gravida.value.trim() : '';
        const p1 = parityControls.primary ? parityControls.primary.value.trim() : '';
        const p2 = parityControls.secondary ? parityControls.secondary.value.trim() : '';

        let parts = [];
        if (g) {
          parts.push(`G${g}`);
        }
        if (p1) {
          let segment = `P${p1}`;
          if (p2) {
            segment += `+${p2}`;
          }
          parts.push(segment);
        } else if (p2) {
          parts.push(`P0+${p2}`);
        }

        return parts.join('');
      }

      function updateParityField() {
        if (!parityHiddenInput) return;
        const combined = buildParityString();
        parityHiddenInput.value = combined;
        if (parityPreview) {
          parityPreview.textContent = combined || '‚Äî';
        }
      }

      function resetYoungestChildInputs() {
        if (youngestChildAgeYearsInput) youngestChildAgeYearsInput.value = '';
        if (youngestChildAgeMonthsInput) youngestChildAgeMonthsInput.value = '';
      }

      function toggleYoungestChildFields() {
        if (!parityControls.gravida || !youngestChildFields) return;
        const gravidaVal = parseInt(parityControls.gravida.value, 10);
        if (!Number.isNaN(gravidaVal) && gravidaVal >= 2) {
          youngestChildFields.style.display = 'block';
      } else {
          youngestChildFields.style.display = 'none';
          if (pregnancyAlert) pregnancyAlert.style.display = 'none';
          if (pregnancyFlagInput) pregnancyFlagInput.value = 'false';
          resetYoungestChildInputs();
        }
      }

      function evaluatePregnancyInterval() {
        if (!parityControls.gravida) return;
        const gravidaVal = parseInt(parityControls.gravida.value, 10);
        if (Number.isNaN(gravidaVal) || gravidaVal < 2) {
          if (pregnancyAlert) pregnancyAlert.style.display = 'none';
          if (pregnancyFlagInput) pregnancyFlagInput.value = 'false';
          return;
        }

        const years = youngestChildAgeYearsInput ? parseInt(youngestChildAgeYearsInput.value, 10) : NaN;
        const months = youngestChildAgeMonthsInput ? parseInt(youngestChildAgeMonthsInput.value, 10) : NaN;

        if (Number.isNaN(years) && Number.isNaN(months)) {
          if (pregnancyAlert) pregnancyAlert.style.display = 'none';
          if (pregnancyFlagInput) pregnancyFlagInput.value = 'false';
      return;
    }

        const safeYears = Number.isNaN(years) ? 0 : Math.max(0, years);
        const safeMonthsRaw = Number.isNaN(months) ? 0 : Math.max(0, months);
        const safeMonths = Math.min(safeMonthsRaw, 11);
        const totalMonths = safeYears * 12 + safeMonths;
        const within24 = totalMonths >= 0 && totalMonths < 24;

        if (pregnancyAlert) {
          pregnancyAlert.style.display = within24 ? 'block' : 'none';
        }
        if (pregnancyFlagInput) {
          pregnancyFlagInput.value = within24 ? 'true' : 'false';
        }
      }

      // Add event listeners
      Object.values(parityControls).forEach(control => {
        if (control) {
          control.addEventListener('change', updateParityField);
        }
      });

      if (parityControls.gravida) {
        parityControls.gravida.addEventListener('change', () => {
          toggleYoungestChildFields();
          evaluatePregnancyInterval();
          updateParityField();
        });
      }
      
      if (youngestChildAgeYearsInput) {
        youngestChildAgeYearsInput.addEventListener('input', evaluatePregnancyInterval);
        youngestChildAgeYearsInput.addEventListener('change', evaluatePregnancyInterval);
      }
      
      if (youngestChildAgeMonthsInput) {
        youngestChildAgeMonthsInput.addEventListener('input', evaluatePregnancyInterval);
        youngestChildAgeMonthsInput.addEventListener('change', evaluatePregnancyInterval);
      }

      // Initialize state
      updateParityField();
      toggleYoungestChildFields();
      evaluatePregnancyInterval();
    }

    function resetForm() {
      if (confirm("Are you sure you want to reset all changes? This will restore the original patient data.")) {
        populateForm();
      }
    }

    async function deletePatient() {
      // Double confirmation for delete action
      const firstConfirm = confirm("‚ö†Ô∏è WARNING: This will permanently delete the patient record and ALL associated data (ANC visits, lab tests, labour care records, etc.).\n\nAre you sure you want to continue?");
      
      if (!firstConfirm) return;
      
      const secondConfirm = confirm("üî¥ FINAL WARNING: This action cannot be undone!\n\nType 'DELETE' to confirm permanent deletion of patient record.");
      
      if (!secondConfirm) return;
      
      const userInput = prompt("To confirm deletion, please type 'DELETE' exactly:");
      
      if (userInput !== 'DELETE') {
        alert("Deletion cancelled. Patient record remains intact.");
        return;
      }

      try {
        // Show loading state
        const deleteButton = document.querySelector('.btn-delete');
        const originalText = deleteButton.innerHTML;
        deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Deleting...</span>';
        deleteButton.disabled = true;

        // Delete the main patient document
        await db.collection("patients").doc(patientId).delete();
        
        // Delete all subcollections (ANC visits, lab tests, etc.)
        const subcollections = ['antenatal_visits', 'lab_tests', 'labour_care', 'postpartum_visits', 'baby_records'];
        
        for (const subcollection of subcollections) {
          try {
            const snapshot = await db.collection("patients").doc(patientId).collection(subcollection).get();
            const batch = db.batch();
            snapshot.docs.forEach(doc => {
              batch.delete(doc.ref);
            });
            if (!snapshot.empty) {
              await batch.commit();
            }
          } catch (error) {
            console.log(`Subcollection ${subcollection} may not exist or already deleted:`, error);
          }
        }

        // Success message
        alert("‚úÖ Patient record and all associated data have been permanently deleted.");
        
        // Redirect to patient list
        window.location.href = "list.html";
        
      } catch (error) {
        console.error("Error deleting patient:", error);
        alert("‚ùå Error deleting patient: " + error.message);
        
        // Reset button state
        const deleteButton = document.querySelector('.btn-delete');
        if (deleteButton) {
          deleteButton.innerHTML = originalText;
          deleteButton.disabled = false;
        }
      }
    }


    // Form submission
    document.getElementById("editPatientForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      
      try {
        const submitButton = e.target.querySelector('button[type="submit"]');
        if (submitButton) {
          const originalText = submitButton.innerHTML;
          submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
          submitButton.disabled = true;
        }

        const formData = new FormData(e.target);
        const updatedData = {};
        
        // Convert form data to object
        for (let [key, value] of formData.entries()) {
          updatedData[key] = value || null;
        }
        
        // Handle parity fields
        const gravidaValue = formData.get('gravida_value') ? parseInt(formData.get('gravida_value'), 10) : null;
        const parityPrimaryValue = formData.get('parity_primary') ? parseInt(formData.get('parity_primary'), 10) : null;
        const paritySecondaryValue = formData.get('parity_secondary') ? parseInt(formData.get('parity_secondary'), 10) : null;
        const youngestYearsRaw = formData.get('youngestChildAgeYears') ? parseInt(formData.get('youngestChildAgeYears'), 10) : null;
        const youngestMonthsRaw = formData.get('youngestChildAgeMonths') ? parseInt(formData.get('youngestChildAgeMonths'), 10) : null;
        
        updatedData.gravida = Number.isFinite(gravidaValue) ? gravidaValue : null;
        updatedData.parity_primary = Number.isFinite(parityPrimaryValue) ? parityPrimaryValue : null;
        updatedData.parity_secondary = Number.isFinite(paritySecondaryValue) ? paritySecondaryValue : null;
        updatedData.youngest_child_age_years = Number.isFinite(youngestYearsRaw) ? Math.max(0, youngestYearsRaw) : null;
        updatedData.youngest_child_age_months = Number.isFinite(youngestMonthsRaw) ? Math.max(0, Math.min(11, youngestMonthsRaw)) : null;
        
        // Calculate interval months
        const intervalMonths = (updatedData.youngest_child_age_years === null && updatedData.youngest_child_age_months === null)
          ? null
          : (updatedData.youngest_child_age_years || 0) * 12 + (updatedData.youngest_child_age_months || 0);
        updatedData.youngest_child_interval_months = intervalMonths;
        
        // Pregnancy within 24 months flag
        const pregnancyWithin24 = formData.get('pregnancyWithin24Months') === 'true';
        updatedData.pregnancy_within_24_months = pregnancyWithin24;
        updatedData.frequent_pregnancy = pregnancyWithin24 ? 'Yes' : 'No';
        
        // Keep parity string (generated by the parity system)
        updatedData.parity = formData.get('parity') || '';
        
        // Add metadata
        updatedData.last_updated = firebase.firestore.FieldValue.serverTimestamp();
        updatedData.updated_by = currentUser.uid;
        
        // Keep original creation data
        updatedData.created_at = currentPatient.created_at;
        updatedData.created_by = currentPatient.created_by || currentPatient.createdBy;
        updatedData.township = currentPatient.township; // Keep original township
        
        // Update patient in Firestore
        await db.collection("patients").doc(patientId).update(updatedData);
        
        alert("Patient data updated successfully!");
        window.location.href = "list.html";
        
      } catch (error) {
        console.error("Error updating patient data:", error);
        alert("Error updating patient data: " + error.message);
        
        // Reset button
        const submitButton = document.querySelector('button[type="submit"]');
        if (submitButton) {
          submitButton.innerHTML = '<i class="fas fa-save me-2"></i>Update Patient Data';
          submitButton.disabled = false;
        }
      }
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>

  <footer class="footer">
    <div class="container">
      <p class="mb-0">
        <i class="fas fa-heart me-2"></i>
        MNCH App 2025 | Developed by Jhpiego Myanmar for MoH.
      </p>
    </div>
  </footer>
</body>
</html>
