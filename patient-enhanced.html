<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#10b981">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Patient Registration - Maternal & Child Health Care System</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <style>
    :root {
      --primary-color: #10b981;
      --secondary-color: #059669;
      --accent-color: #34d399;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --card-hover-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--background-gradient);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated background elements */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
      animation: float 20s ease-in-out infinite;
      z-index: 0;
    }

    body::after {
      content: '';
      position: fixed;
      top: -30%;
      right: -30%;
      width: 160%;
      height: 160%;
      background: radial-gradient(circle, rgba(52, 211, 153, 0.08) 0%, transparent 50%);
      animation: float 25s ease-in-out infinite reverse;
      z-index: 0;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      50% { transform: translate(-20px, -20px) rotate(180deg); }
    }

    /* Header styling */
    .header-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      color: var(--text-primary);
      padding: 1rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      z-index: 1;
    }

    .header-section h1 {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0;
    }

    .header-section p {
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 400;
    }

    /* Main container */
    .main-container {
      flex: 1;
      padding: 2rem 1rem;
      position: relative;
      z-index: 1;
    }

    /* Form container */
    .form-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 3rem 2.5rem;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 2rem;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .form-container:hover {
      transform: translateY(-2px);
      box-shadow: var(--card-hover-shadow);
    }

    /* Form sections */
    .form-section {
      margin-bottom: 2.5rem;
      padding: 2rem;
      border: 2px solid rgba(16, 185, 129, 0.1);
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .form-section:hover {
      border-color: rgba(16, 185, 129, 0.2);
      background: rgba(255, 255, 255, 0.7);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .section-title i {
      color: var(--primary-color);
      font-size: 1.75rem;
    }

    /* Form styling */
    .form-group {
      margin-bottom: 1.5rem;
      position: relative;
    }

    .form-label {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-label i {
      color: var(--primary-color);
      width: 16px;
    }

    .form-control {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      font-size: 1rem;
      font-weight: 400;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.8);
    }

    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
      background: white;
    }

    .form-control::placeholder {
      color: #9ca3af;
      font-weight: 400;
    }

    .form-label-sm {
      display: block;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 0.35rem;
    }

    .parity-selects {
      display: flex;
      align-items: stretch;
      gap: 0.75rem;
      flex-wrap: wrap;
      background: rgba(16, 185, 129, 0.08);
      border: 1px solid rgba(16, 185, 129, 0.18);
      border-radius: 16px;
      padding: 1rem 1.25rem;
    }

    .parity-selects .select-block {
      flex: 1 1 160px;
      display: flex;
      flex-direction: column;
    }

    .parity-selects .select-block label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--primary-color);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.35rem;
    }

    .parity-selects .select-block select {
      border-radius: 12px;
      border: 2px solid rgba(16, 185, 129, 0.35);
      height: 48px;
      font-weight: 600;
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.92);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .parity-selects .select-block select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
    }

    .parity-selects .parity-plus {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: white;
      color: var(--primary-color);
      font-size: 1.25rem;
      font-weight: 700;
      box-shadow: 0 8px 18px -8px rgba(16, 185, 129, 0.45);
      margin: auto 0;
    }

    .parity-helper {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.75rem;
    }

    .form-text {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      font-style: italic;
    }

    /* Required field indicator */
    .required-field::after {
      content: " *";
      color: #dc2626;
      font-weight: 700;
    }

    /* Checkbox and radio styling */
    .form-check {
      margin-bottom: 1rem;
    }

    .form-check-input {
      width: 20px;
      height: 20px;
      border: 2px solid #d1d5db;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .form-check-input:checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }

    .form-check-label {
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      user-select: none;
      margin-left: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-check-label:hover {
      color: var(--primary-color);
    }

    /* Buttons */
    .btn {
      border-radius: 12px;
      padding: 1rem 2rem;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      border: none;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--secondary-color), #047857);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
      color: white;
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      border: 2px solid #d1d5db;
      color: var(--text-secondary);
      background: transparent;
    }

    .btn-secondary:hover {
      background: rgba(243, 244, 246, 0.8);
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    /* Action buttons container */
    .action-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 2rem;
    }

    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Alert styling */
    .alert {
      border: none;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 4px solid;
    }

    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      color: #047857;
      border-left-color: var(--primary-color);
    }

    .alert-danger {
      background: rgba(220, 38, 38, 0.1);
      color: #991b1b;
      border-left-color: #dc2626;
    }

    .alert-warning {
      background: rgba(251, 191, 36, 0.1);
      color: #92400e;
      border-left-color: #f59e0b;
    }

    /* Footer */
    .footer {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      color: var(--text-secondary);
      text-align: center;
      padding: 2rem 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      z-index: 1;
      margin-top: auto;
    }

    .footer p {
      margin: 0;
      font-size: 0.9rem;
      font-weight: 400;
      line-height: 1.5;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .main-container {
        padding: 1rem 0.5rem;
      }

      .form-container {
        padding: 2rem 1.5rem;
        margin: 1rem;
        border-radius: 20px;
      }

      .form-section {
        padding: 1.5rem;
      }

      .header-section h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }

      .header-section .row {
        flex-wrap: wrap;
      }

      .header-section .col-md-4 {
        width: 100%;
        margin-top: 0.75rem;
      }

      .header-section .d-flex {
        flex-wrap: wrap;
        gap: 0.5rem !important;
        justify-content: flex-start !important;
      }

      .header-section .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.8rem;
        white-space: nowrap;
      }

      .language-switcher {
        order: 1;
      }

      .header-section .btn-secondary {
        order: 2;
        flex: 0 0 auto;
      }

      .section-title {
        font-size: 1.25rem;
      }

      .form-control {
        padding: 0.875rem 1rem;
        font-size: 0.95rem;
      }

      .btn {
        padding: 0.875rem 1.5rem;
        font-size: 0.95rem;
      }

      .action-buttons {
        flex-direction: column;
      }

      .footer {
        padding: 1.5rem 1rem;
      }

      .footer p {
        font-size: 0.85rem;
      }

      .parity-selects {
        padding: 0.85rem;
        gap: 0.6rem;
      }

      .parity-selects .select-block {
        flex: 1 1 140px;
      }
    }

    @media (max-width: 576px) {
      .header-section {
        padding: 0.75rem 0;
      }

      .header-section h1 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
      }

      .header-section .col-md-4 {
        margin-top: 0.5rem;
      }

      .header-section .d-flex {
        gap: 0.375rem !important;
      }

      .header-section .btn-sm {
        padding: 0.3rem 0.6rem;
        font-size: 0.75rem;
      }

      .header-section .btn-secondary {
        padding: 0.3rem 0.6rem;
        font-size: 0.75rem;
      }

      .language-btn {
        padding: 0.3rem 0.5rem !important;
        font-size: 0.7rem !important;
      }

      .flag-icon {
        font-size: 0.875rem;
      }

      .parity-selects {
        flex-direction: column;
        align-items: stretch;
        padding: 0.85rem;
      }

      .parity-selects .parity-plus {
        width: 100%;
        height: 38px;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        letter-spacing: 0.15em;
        background: rgba(16, 185, 129, 0.15);
        color: var(--primary-color);
        box-shadow: none;
      }

      .parity-selects .select-block {
        flex: 1 1 auto;
      }
    }

    /* High risk details toggle */
    #highRiskDetails {
      margin-top: 1rem;
      padding: 1.5rem;
      background: rgba(251, 191, 36, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(251, 191, 36, 0.2);
      transition: all 0.3s ease;
    }

    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-antenatal { background: rgba(16, 185, 129, 0.1); color: #047857; }
    .status-labour { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
    .status-postpartum { background: rgba(139, 92, 246, 0.1); color: #7c3aed; }
    .status-baby { background: rgba(251, 191, 36, 0.1); color: #d97706; }
    .status-other { background: rgba(107, 114, 128, 0.1); color: #374151; }
    .status-transferred { background: rgba(59, 130, 246, 0.1); color: #2563eb; }

    /* Language Switcher */
    .language-switcher {
      display: flex;
      gap: 0.25rem;
      align-items: center;
    }

    .language-btn {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      border-radius: 8px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .language-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .language-btn:hover:not(.active) {
      background: rgba(16, 185, 129, 0.1);
      border-color: var(--primary-color);
    }

    .flag-icon {
      font-size: 1rem;
    }

    /* Age Risk Alert */
    #ageRiskAlert {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(220, 38, 38, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(220, 38, 38, 0.3);
      transition: all 0.3s ease;
    }

    #ageRiskAlert.show {
      display: block;
    }

    #ageRiskAlert.hide {
      display: none;
    }

    /* Risk indicator on age input */
    .form-control.is-high-risk {
      border-color: #dc2626;
      box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1);
    }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  <script>
    const REGION_TSP_DATA = [
      {
        stateOrRegion: "ကချင်ပြည်နယ်",
        districts: [
          {
            district: "ပူတာအို",
            constituencies: [
              { name: "ခေါင်လန်ဖူး", code: "KCN-1" },
              { name: "ဆွမ်ပရာဘွမ်", code: "KCN-2" },
              { name: "နောင်မွန်း", code: "KCN-3" },
              { name: "ပူတာအို", code: "KCN-4" },
              { name: "မချမ်းဘော", code: "KCN-5" }
            ]
          },
          {
            district: "ဗန်းမော်",
            constituencies: [
              { name: "ဗန်းမော်", code: "KCN-6" },
              { name: "မံစီ", code: "KCN-7" },
              { name: "မိုးမောက်", code: "KCN-8" },
              { name: "ရွှေကူ", code: "KCN-9" }
            ]
          },
          {
            district: "မိုးညှင်း",
            constituencies: [
              { name: "ဖားကန့်", code: "KCN-10" },
              { name: "မိုးကောင်း", code: "KCN-11" },
              { name: "မိုးညှင်း", code: "KCN-12" }
            ]
          },
          {
            district: "မြစ်ကြီးနား",
            constituencies: [
              { name: "ချီဖွေ", code: "KCN-13" },
              { name: "ဆော့လော်", code: "KCN-14" },
              { name: "တနိုင်း", code: "KCN-15" },
              { name: "မြစ်ကြီးနား", code: "KCN-16" },
              { name: "ဝိုင်းမော်", code: "KCN-17" },
              { name: "အင်ဂျန်းယန်", code: "KCN-18" }
            ]
          }
        ]
      },
      {
        stateOrRegion: "ကယားပြည်နယ်",
        districts: [
          {
            district: "ဘောလခဲ",
            constituencies: [
              { name: "ဖားဆောင်း", code: "KYH-1" },
              { name: "ဘောလခဲ့", code: "KYH-2" },
              { name: "မယ်စဲ", code: "KYH-3" }
            ]
          },
          {
            district: "လွိုင်ကော်",
            constituencies: [
              { name: "ဒီးမော့ဆို", code: "KYH-4" },
              { name: "ဖရူဆို", code: "KYH-5" },
              { name: "ရှားတော", code: "KYH-6" },
              { name: "လွိုင်ကော်", code: "KYH-7" }
            ]
          }
        ]
      },
      {
        stateOrRegion: "ကရင်ပြည်နယ်",
        districts: [
          {
            district: "ကော့ကရိတ်",
            constituencies: [
              { name: "ကော့ကရိတ်", code: "KYN-1" },
              { name: "ကြာအင်းဆိပ်ကြီး", code: "KYN-2" }
            ]
          },
          {
            district: "ဖာပွန်",
            constituencies: [
              { name: "ဖာပွန်", code: "KYN-3" }
            ]
          },
          {
            district: "ဘားအံ",
            constituencies: [
              { name: "ဘားအံ", code: "KYN-4" },
              { name: "လှိုင်းဘွဲ့", code: "KYN-5" },
              { name: "သံတောင်ကြီး", code: "KYN-6" }
            ]
          },
          {
            district: "မြဝတီ",
            constituencies: [
              { name: "မြဝတီ", code: "KYN-7" }
            ]
          }
        ]
      },
      {
        stateOrRegion: "ချင်းပြည်နယ်",
        districts: [
          {
            district: "ဖလမ်း",
            constituencies: [
              { name: "တီးတိန်", code: "CHN-1" },
              { name: "တွန်းဇန်", code: "CHN-2" },
              { name: "ဖလမ်း", code: "CHN-3" }
            ]
          },
          {
            district: "မင်းတပ်",
            constituencies: [
              { name: "ကန်ပက်လက်", code: "CHN-4" },
              { name: "ပလက်ဝ", code: "CHN-5" },
              { name: "မတူပီ", code: "CHN-6" },
              { name: "မင်းတပ်", code: "CHN-7" }
            ]
          },
          {
            district: "ဟားခါး",
            constituencies: [
              { name: "ထန်တလန်", code: "CHN-8" },
              { name: "ဟားခါး", code: "CHN-9" }
            ]
          }
        ]
      },
      {
        stateOrRegion: "စစ်ကိုင်းတိုင်းဒေသကြီး",
        districts: [
          {
            district: "ကလေး",
            constituencies: [
              { name: "ကလေး", code: "SGG-1" },
              { name: "ကလေးဝ", code: "SGG-2" },
              { name: "မင်းကင်း", code: "SGG-3" }
            ]
          },
          {
            district: "ကသာ",
            constituencies: [
              { name: "ကသာ", code: "SGG-4" },
              { name: "ကောလင်း", code: "SGG-5" },
              { name: "ထီးချိုင့်", code: "SGG-6" },
              { name: "ပင်လည်ဘူး", code: "SGG-7" },
              { name: "ဗန်းမောက်", code: "SGG-8" },
              { name: "ဝန်းသို", code: "SGG-9" },
              { name: "အင်းတော်", code: "SGG-10" }
            ]
          },
          {
            district: "ကန့်ဘလူ",
            constituencies: [
              { name: "ကန့်ဘလူ", code: "SGG-11" },
              { name: "ကျွန်းလှ", code: "SGG-12" },
              { name: "တန့်ဆည်", code: "SGG-13" },
              { name: "ရေဦး", code: "SGG-14" }
            ]
          },
          {
            district: "ခန္တီး",
            constituencies: [
              { name: "ခန္တီး", code: "SGG-15" },
              { name: "နန်းယွန်း", code: "SGG-16" },
              { name: "လဟယ်", code: "SGG-17" },
              { name: "လေရှီး", code: "SGG-18" },
              { name: "ဟုမ္မလင်း", code: "SGG-19" }
            ]
          },
          {
            district: "စစ်ကိုင်း",
            constituencies: [
              { name: "စစ်ကိုင်း", code: "SGG-20" },
              { name: "မြင်းမူ", code: "SGG-21" },
              { name: "မြောင်", code: "SGG-22" }
            ]
          },
          {
            district: "တမူး",
            constituencies: [
              { name: "တမူး", code: "SGG-23" }
            ]
          },
          {
            district: "မော်လိုက်",
            constituencies: [
              { name: "ဖောင်းပြင်", code: "SGG-24" },
              { name: "မော်လိုက်", code: "SGG-25" }
            ]
          },
          {
            district: "မုံရွာ",
            constituencies: [
              { name: "ချောင်းဦး", code: "SGG-26" },
              { name: "ဘုတလင်", code: "SGG-27" },
              { name: "မုံရွာ", code: "SGG-28" },
              { name: "အရာတော်", code: "SGG-29" }
            ]
          },
          {
            district: "ယင်းမာပင်",
            constituencies: [
              { name: "ကနီ", code: "SGG-30" },
              { name: "ဆားလင်းကြီး", code: "SGG-31" },
              { name: "ပုလဲ", code: "SGG-32" },
              { name: "ယင်းမာပင်", code: "SGG-33" }
            ]
          },
          {
            district: "ရွှေဘို",
            constituencies: [
              { name: "ခင်ဦး", code: "SGG-34" },
              { name: "ဒီပဲယင်း", code: "SGG-35" },
              { name: "ရွှေဘို", code: "SGG-36" },
              { name: "ဝက်လက်", code: "SGG-37" }
            ]
          }
        ]
      },
      {
        stateOrRegion: "တနင်္သာရီတိုင်းဒေသကြီး",
        districts: [
          {
            district: "ကော့သောင်း",
            constituencies: [
              { name: "ကော့သောင်း", code: "TNI-1" },
              { name: "ဘုတ်ပြင်း", code: "TNI-2" }
            ]
          },
          {
            district: "ထားဝယ်",
            constituencies: [
              { name: "ထားဝယ်", code: "TNI-3" },
              { name: "ရေဖြူ", code: "TNI-4" },
              { name: "လောင်းလုံး", code: "TNI-5" },
              { name: "သရက်ချောင်း", code: "TNI-6" }
            ]
          },
          {
            district: "မြိတ်",
            constituencies: [
              { name: "ကျွန်းစု", code: "TNI-7" },
              { name: "တနင်္သာရီ", code: "TNI-8" },
              { name: "ပုလော", code: "TNI-9" },
              { name: "မြိတ်", code: "TNI-10" }
            ]
          }
        ]
      },
      {
        stateOrRegion: "ပဲခူးတိုင်းဒေသကြီး",
        districts: [
          {
            district: "တောင်ငူ",
            constituencies: [
              { name: "ကျောက်ကြီး", code: "BG0-1" },
              { name: "တောင်ငူ", code: "BGO-2" },
              { name: "ထန်းတပင်", code: "BGO-3" },
              { name: "ဖြူး", code: "BG0-4" },
              { name: "ရေတာရှည်", code: "BGO-5" },
              { name: "အုတ်တွင်း", code: "BGO-6" }
            ]
          },
          {
            district: "ပဲခူး",
            constituencies: [
              { name: "ကဝ", code: "BGO-7" },
              { name: "ကျောက်တံခါး", code: "BGO-8" },
              { name: "ညောင်လေးပင်", code: "BGO-9" },
              { name: "ဒိုက်ဦး", code: "BGO-10" },
              { name: "ပဲခူး", code: "BGO-11" },
              { name: "ရွှေကျင်", code: "BGO-12" },
              { name: "ဝေါ", code: "BG0-13" },
              { name: "သနပ်ပင်", code: "BG0-14" }
            ]
          },
          {
            district: "ပြည်",
            constituencies: [
              { name: "ပေါက်ခေါင်း", code: "BG0-15" },
              { name: "ပေါင်းတည်", code: "BGO-16" },
              { name: "ပန်းတောင်း", code: "BGO-17" },
              { name: "ပြည်", code: "BGO-18" },
              { name: "ရွှေတောင်", code: "BGO-19" },
              { name: "သဲကုန်း", code: "BGO-20" }
            ]
          },
          {
            district: "သာယာဝတီ",
            constituencies: [
              { name: "ကြို့ပင်ကောက်", code: "BG0-21" },
              { name: "ဇီးကုန်း", code: "BGO-22" },
              { name: "နတ်တလင်း", code: "BGO-23" },
              { name: "မိုးညို", code: "BGO-24" },
              { name: "မင်းလှ", code: "BGO-25" },
              { name: "လက်ပံတန်း", code: "BGO-26" },
              { name: "သာယာဝတီ", code: "BGO-27" },
              { name: "အုတ်ဖို", code: "BGO-28" }
            ]
          }
        ]
      },
      {
        stateOrRegion: "မကွေးတိုင်းဒေသကြီး",
        districts: [
          {
            district: "ဂန့်ဂေါ",
            constituencies: [
              { name: "ဂန့်ဂေါ", code: "MGY-1" },
              { name: "ဆော", code: "MGY-2" },
              { name: "ထီးလင်း", code: "MGY-3" }
            ]
          },
          {
            district: "ပခုက္ကူ",
            constituencies: [
              { name: "ဆိပ်ဖြူ", code: "MGY-4" },
              { name: "ပခုက္ကူ", code: "MGY-5" },
              { name: "ပေါက်", code: "MGY-6" },
              { name: "မြိုင်", code: "MGY-7" },
              { name: "ရေစကြို", code: "MGY-8" }
            ]
          },
          {
            district: "မကွေး",
            constituencies: [
              { name: "ချောက်", code: "MGY-9" },
              { name: "တောင်တွင်းကြီး", code: "MGY-10" },
              { name: "နတ်မောက်", code: "MGY-11" },
              { name: "မကွေး", code: "MGY-12" },
              { name: "မြို့သစ်", code: "MGY-13" },
              { name: "ရေနံချောင်း", code: "MGY-14" }
            ]
          },
          {
            district: "မင်းဘူး",
            constituencies: [
              { name: "ငဖဲ", code: "MGY=15" },
              { name: "စလင်း", code: "MGY-15" },
              { name: "စေတုတ္ထရာ", code: "MGY-17" },
              { name: "ပွင့်ဖြူ", code: "MGY-18" },
              { name: "မင်းဘူး", code: "MGY-19" }
            ]
          },
          {
            district: "သရက်",
            constituencies: [
              { name: "ကံမ", code: "MGY-20" },
              { name: "ဆင်ပေါင်ဝဲ", code: "MGY-21" },
              { name: "မင်းတုန်း", code: "MGY-22" },
              { name: "မင်းလှ", code: "MGY-23" },
              { name: "သရက်", code: "MGY-24" },
              { name: "အောင်လံ", code: "MGY-25" }
            ]
          }
        ]
      },
      {
        stateOrRegion: "မန္တလေးတိုင်းဒေသကြီး",
        districts: [
          {
            district: "ကျောက်ဆည်",
            constituencies: [
              { name: "ကျောက်ဆည်", code: "MDY-1" },
              { name: "စဉ့်ကိုင်", code: "MDY-2" },
              { name: "တံတားဦး", code: "MDY-3" },
              { name: "မြစ်သား", code: "MDY-4" }
            ]
          },
          {
            district: "ညောင်ဦး",
            constituencies: [
              { name: "ကျောက်ပန်းတောင်း", code: "MDY-5" },
              { name: "ညောင်ဦး", code: "MDY-6" }
            ]
          },
          {
            district: "ပြင်ဦးလွင်",
            constituencies: [
              { name: "စဉ့်ကူး", code: "MDY-7" },
              { name: "ပြင်ဦးလွင်", code: "MDY-8" },
              { name: "မိုးကုတ်", code: "MDY-9" },
              { name: "မတ္တရာ", code: "MDY-10" },
              { name: "သပိတ်ကျင်း", code: "MDY-11" }
            ]
          },
          {
            district: "မန္တလေး",
            constituencies: [
              { name: "ချမ်းမြသာစည်", code: "MDY-12" },
              { name: "ချမ်းအေးသာဇံ", code: "MDY-13" },
              { name: "ပြည်ကြီးတံခွန်", code: "MDY-14" },
              { name: "မဟာအောင်မြေ", code: "MDY-15" },
              { name: "အောင်မြေသာဇံ", code: "MDY-16" },
              { name: "ပုသိမ်ကြီး", code: "MDY-17" },
              { name: "အမရပူရ", code: "MDY-18" }
            ]
          },
          {
            district: "မိတ္ထီလာ",
            constituencies: [
              { name: "မလှိုင်", code: "MDY-19" },
              { name: "မိတ္ထီလာ", code: "MDY-20" },
              { name: "ဝမ်းတွင်း", code: "MDY-21" },
              { name: "သာစည်", code: "MDY-22" }
            ]
          },
          {
            district: "မြင်းခြံ",
            constituencies: [
              { name: "ငါန်းဇွန်", code: "MDY-23" },
              { name: "တောင်သာ", code: "MDY-24" },
              { name: "နွားထိုးကြီး", code: "MDY-25" },
              { name: "မြင်းခြံ", code: "MDY-26" }
            ]
          },
          {
            district: "ရမည်းသင်း",
            constituencies: [
              { name: "ပျော်ဘွယ်", code: "MDY-27" },
              { name: "ရမည်းသင်း", code: "MDY-28" }
            ]
          }
        ]
      },
      {
        stateOrRegion: "မွန်ပြည်နယ်",
        districts: [
          {
            district: "မော်လမြိုင်",
            constituencies: [
              { name: "ကျိုက်မရော", code: "MON-1" },
              { name: "ချောင်းဆုံ", code: "MON-2" },
              { name: "မုဒုံ", code: "MON-3" },
              { name: "မော်လမြိုင်", code: "MON-4" },
              { name: "ရေး", code: "MON-5" },
              { name: "သံဖြူဇရပ်", code: "MON-6" }
            ]
          },
          {
            district: "သထုံ",
            constituencies: [
              { name: "ကျိုက်ထို", code: "MON-7" },
              { name: "ပေါင်", code: "MON-8" },
              { name: "ဘီးလင်း", code: "MON-9" },
              { name: "သထုံ", code: "MON-10" }
            ]
          }
        ]
      },
      {
        stateOrRegion: "ရခိုင်ပြည်နယ်",
        districts: [
          {
            district: "ကျောက်ဖြူ",
            constituencies: [
              { name: "ကျောက်ဖြူ", code: "RKE-1" },
              { name: "မာန်အောင်", code: "RKE-2" },
              { name: "ရမ်းဗြဲ", code: "RKE-3" },
              { name: "အမ်း", code: "RKE-4" }
            ]
          },
          {
            district: "စစ်တွေ",
            constituencies: [
              { name: "စစ်တွေ", code: "RKE-5" },
              { name: "ပေါက်တော", code: "RKE-6" },
              { name: "ပုဏ္ဏားကျွန်း", code: "RKE-7" },
              { name: "ရသေ့တောင်", code: "RKE-8" }
            ]
          },
          {
            district: "မောင်တော",
            constituencies: [
              { name: "ဘူးသီးတောင်", code: "RKE-9" },
              { name: "မောင်တော", code: "RKE-10" }
            ]
          },
          {
            district: "မြောက်ဦး",
            constituencies: [
              { name: "ကျောက်တော်", code: "RKE-11" },
              { name: "မင်းပြား", code: "RKE-12" },
              { name: "မြေပုံ", code: "RKE-13" },
              { name: "မြောက်ဦး", code: "RKE-14" }
            ]
          },
          {
            district: "သံတွဲ",
            constituencies: [
              { name: "ဂွ", code: "RKE-15" },
              { name: "တောင်ကုတ်", code: "RKE-16" },
              { name: "သံတွဲ", code: "RKE-17" }
            ]
          }
        ]
      },
      {
        stateOrRegion: "ရန်ကုန်တိုင်းဒေသကြီး",
        districts: [
          {
            district: "ရန်ကုန်(မြောက်ပိုင်း)",
            constituencies: [
              { name: "တိုက်ကြီး", code: "YGN-1" },
              { name: "ထန်းတပင်", code: "YGN-2" },
              { name: "မင်္ဂလာဒုံ", code: "YGN-3" },
              { name: "မှော်ဘီ", code: "YGN-4" },
              { name: "ရွှေပြည်သာ", code: "YGN-5" },
              { name: "လှိုင်သာယာ", code: "YGN-6" },
              { name: "လှည်းကူး", code: "YGN-7" },
              { name: "အင်းစိန်", code: "YGN-8" }
            ]
          },
          {
            district: "ရန်ကုန်(အရှေ့ပိုင်း)",
            constituencies: [
              { name: "တာမွေ", code: "YGN-9" },
              { name: "တောင်ဥက္ကလာပ", code: "YGN-10" },
              { name: "ဒဂုံမြို့သစ်(ဆိပ်ကမ်း)", code: "YGN-11" },
              { name: "ဒဂုံမြို့သစ်(တောင်ပိုင်း)", code: "YGN-12" },
              { name: "ဒဂုံမြို့သစ်(မြောက်ပိုင်း)", code: "YGN-13" },
              { name: "ဒဂုံမြို့သစ်(အရှေ့ပိုင်း)", code: "YGN-14" },
              { name: "ဒေါပုံ", code: "YGN-15" },
              { name: "ပုဇွန်တောင်", code: "YGN-16" },
              { name: "ဗိုလ်တထောင်", code: "YGN-17" },
              { name: "မင်္ဂလာတောင်ညွှန့်", code: "YGN-18" },
              { name: "မြောက်ဥက္ကလာပ", code: "YGN-19" },
              { name: "ရန်ကင်း", code: "YGN-20" },
              { name: "သာကေတ", code: "YGN-21" },
              { name: "သင်္ဃန်းကျွန်း", code: "YGN-22" }
            ]
          },
          {
            district: "ရန်ကုန်(တောင်ပိုင်း)",
            constituencies: [
              { name: "ကိုကိုးကျွန်း", code: "YGN-23" },
              { name: "ကော့မှူး", code: "YGN-24" },
              { name: "ကျောက်တန်း", code: "YGN-25" },
              { name: "ကွမ်းခြံကုန်း", code: "YGN-26" },
              { name: "ခရမ်း", code: "YGN-27" },
              { name: "ဆိပ်ကြီး/ ခနောင်တို", code: "YGN-28" },
              { name: "တွံတေး", code: "YGN-29" },
              { name: "ဒလ", code: "YGN-30" },
              { name: "သန်လျင်", code: "YGN-31" },
              { name: "သုံးခွ", code: "YGN-32" }
            ]
          },
          {
            district: "ရန်ကုန်(အနောက်ပိုင်း)",
            constituencies: [
              { name: "ကမာရွတ်", code: "YGN-33" },
              { name: "ကျောက်တံတား", code: "YGN-34" },
              { name: "ကြည့်မြင်တိုင်", code: "YGN-35" },
              { name: "စမ်းချောင်း", code: "YGN-36" },
              { name: "ဆိပ်ကမ်း", code: "YGN-37" },
              { name: "ဒဂုံ", code: "YGN-38" },
              { name: "ပန်းဘဲတန်း", code: "YGN-39" },
              { name: "ဗဟန်း", code: "YGN-40" },
              { name: "မရမ်းကုန်း", code: "YGN-41" },
              { name: "လသာ", code: "YGN-42" },
              { name: "လမ်းမတော်", code: "YGN-43" },
              { name: "လှိုင်", code: "YGN-44" },
              { name: "အလုံ", code: "YGN-45" }
            ]
          }
        ]
      },
      {
        stateOrRegion: "ရှမ်းပြည်နယ်",
        districts: [
          {
            district: "ကျောက်မဲ",
            constituencies: [
              { name: "ကျောက်မဲ", code: "SHN-1" },
              { name: "နမ္မတူ", code: "SHN-2" },
              { name: "နမ့်ဆန်", code: "SHN-3" },
              { name: "ခင်ချို", code: "SHN-4" },
              { name: "မန်တုံ", code: "SHN-5" },
              { name: "သီပေါ", code: "SHN-6" }
            ]
          },
          {
            district: "ကျိုင်းတုံ",
            constituencies: [
              { name: "ကျိုင်းတုံ", code: "SHN-7" },
              { name: "မိုင်းခတ်", code: "SHN-8" },
              { name: "မိုင်းယန်း", code: "SHN-9" },
              { name: "မိုင်းလား", code: "SHN-10" },
              { name: "မိုင်းပျဉ်း", code: "SHN-11" }
            ]
          },
          {
            district: "တာချီလိတ်",
            constituencies: [
              { name: "တာချီလိတ်", code: "SHN-12" },
              { name: "မိုင်းဖြတ်", code: "SHN-13" },
              { name: "မိုင်းယောင်း", code: "SHN-14" }
            ]
          },
          {
            district: "တောင်ကြီး",
            constituencies: [
              { name: "ကလော", code: "SHN-15" },
              { name: "ဆီဆိုင်", code: "SHN-16" },
              { name: "ညောင်ရွှေ", code: "SHN-17" },
              { name: "တောင်ကြီး", code: "SHN-18" },
              { name: "ပင်းတယ", code: "SHN-19" },
              { name: "ပင်လောင်း", code: "SHN-20" },
              { name: "ဖယ်ခုံ", code: "SHN-21" },
              { name: "ရွာငံ", code: "SHN-22" },
              { name: "ရပ်စောက်", code: "SHN-23" },
              { name: "ဟိုပုံး", code: "SHN-24" }
            ]
          },
          {
            district: "မူဆယ်",
            constituencies: [
              { name: "ကွတ်ခိုင်", code: "SHN-25" },
              { name: "နမ့်ခမ်း", code: "SHN-26" },
              { name: "မူဆယ်", code: "SHN-27" }
            ]
          },
          {
            district: "မိုးမိတ်",
            constituencies: [
              { name: "မဘိမ်း", code: "SHN-28" },
              { name: "မိုးမိတ်", code: "SHN-29" }
            ]
          },
          {
            district: "မက်မန်း",
            constituencies: [
              { name: "နားဖန်း", code: "SHN-30" },
              { name: "ပန်ဆန်း(ပန်ခမ်း)", code: "SHN-31" },
              { name: "မက်မန်း", code: "SHN-32" }
            ]
          },
          {
            district: "မိုင်းဆတ်",
            constituencies: [
              { name: "မိုင်းဆတ်", code: "SHN-33" },
              { name: "မိုင်းတုံ", code: "SHN-34" }
            ]
          },
          {
            district: "လားရှိုး",
            constituencies: [
              { name: "ကွမ်လုံ", code: "SHN-35" },
              { name: "တန့်ယန်း", code: "SHN-36" },
              { name: "မိုင်းရယ်", code: "SHN-37" },
              { name: "လားရှိုး", code: "SHN-38" },
              { name: "သိန္နီ", code: "SHN-39" }
            ]
          },
          {
            district: "လင်းခေး",
            constituencies: [
              { name: "မိုးနဲ့", code: "SHN-40" },
              { name: "မိုင်းပန်", code: "SHN-41" },
              { name: "မောက်မယ်", code: "SHN-42" },
              { name: "လင်းခေး", code: "SHN-43" }
            ]
          },
          {
            district: "လောက်ကိုင်",
            constituencies: [
              { name: "ကုန်းကြမ်း", code: "SHN-44" },
              { name: "လောက်ကိုင်", code: "SHN-45" }
            ]
          },
          {
            district: "လွိုင်လင်",
            constituencies: [
              { name: "ကျေးသီး", code: "SHN-46" },
              { name: "ကွန်ဟိန်း", code: "SHN-47" },
              { name: "နမ့်စန်", code: "SHN-48" },
              { name: "မိုင်းကိုင်", code: "SHN-49" },
              { name: "မိုင်းရှူး", code: "SHN-50" },
              { name: "လဲချား", code: "SHN-51" },
              { name: "လွိုင်လင်", code: "SHN-52" }
            ]
          },
          {
            district: "ဟိုပန်",
            constituencies: [
              { name: "ပန်ဝိုင်", code: "SHN-53" },
              { name: "မိုင်းမော", code: "SHN-54" },
              { name: "ဟိုပန်", code: "SHN-55" }
            ]
          }
        ]
      },
      {
        stateOrRegion: "ဧရာဝတီတိုင်းဒေသကြီး",
        districts: [
          {
            district: "ပုသိမ်",
            constituencies: [
              { name: "ကန်ကြီးထောင့်", code: "AYY-1" },
              { name: "ကျောင်းကုန်း", code: "AYY-2" },
              { name: "ကျုံပျော်", code: "AYY-3" },
              { name: "ငပုတော", code: "AYY-4" },
              { name: "ပုသိမ်", code: "AYY-5" },
              { name: "ရေကြည်", code: "AYY-6" },
              { name: "သာပေါင်း", code: "AYY-7" }
            ]
          },
          {
            district: "ဖျာပုံ",
            constituencies: [
              { name: "ကျိုက်လတ်", code: "AYY-8" },
              { name: "ဒေးဒရဲ", code: "AYY-9" },
              { name: "ဖျာပုံ", code: "AYY-10" },
              { name: "ဘိုကလေး", code: "AYY-11" }
            ]
          },
          {
            district: "မအူပင်",
            constituencies: [
              { name: "ညောင်တုန်း", code: "AYY-12" },
              { name: "ဓနုဖြူ", code: "AYY-13" },
              { name: "ပန်းတနော်", code: "AYY-14" },
              { name: "မအူပင်", code: "AYY-15" }
            ]
          },
          {
            district: "မြောင်းမြ",
            constituencies: [
              { name: "မြောင်းမြ", code: "AYY-16" },
              { name: "ဝါးခယ်မ", code: "AYY-17" },
              { name: "အိမ်မဲ", code: "AYY-18" }
            ]
          },
          {
            district: "လပ္ပတ္တာ",
            constituencies: [
              { name: "မော်လမြိုင်ကျွန်း", code: "AYY-19" },
              { name: "လပ္ပတ္တာ", code: "AYY-20" }
            ]
          },
          {
            district: "ဟင်္သာတ",
            constituencies: [
              { name: "ကြံခင်း", code: "AYY-21" },
              { name: "ဇလွန်", code: "AYY-22" },
              { name: "မြန်အောင်", code: "AYY32" },
              { name: "လေးမျက်နှာ", code: "AYY-24" },
              { name: "ဟင်္သာတ", code: "AYY-25" },
              { name: "အင်္ဂပူ", code: "AYY-26" }
            ]
          }
        ]
      },
      {
        stateOrRegion: "နေပြည်တော်",
        districts: [
          {
            district: "ဒက္ခိဏ (တောင်ပိုင်း)",
            constituencies: [
              { name: "ဇမ္ဗူသီရိ", code: "NPW-1" },
              { name: "ဒက္ခိဏသီရိ", code: "NPW-2" },
              { name: "ပျဉ်းမနား", code: "NPW-3" },
              { name: "လယ်ဝေး", code: "NPW-4" }
            ]
          },
          {
            district: "ဥတ္တရ (မြောက်ပိုင်း)",
            constituencies: [
              { name: "ဇေယျာသီရိ", code: "NPW-5" },
              { name: "တပ်ကုန်း", code: "NPW-6" },
              { name: "ပုဗ္ဗသီရိ", code: "NPW-7" },
              { name: "ဥတ္တရသီရိ", code: "NPW-8" }
            ]
          }
        ]
      }
    ];

    function normalizeLocationName(name) {
      return (name || '').toString().trim().replace(/\s+/g, '').toLowerCase();
    }

    const TOWNSHIP_CODE_LOOKUP = (() => {
      const map = new Map();
      REGION_TSP_DATA.forEach(region => {
        region.districts.forEach(district => {
          district.constituencies.forEach(constituency => {
            const regionShort = constituency.code.split('-')[0] || '';
            const key = normalizeLocationName(constituency.name);
            if (!map.has(key)) {
              map.set(key, {
                regionShort,
                tspCode: constituency.code,
                stateOrRegion: region.stateOrRegion,
                district: district.district,
                constituency: constituency.name
              });
            }
          });
        });
      });
      
      // Add English name mappings for all townships from registration.html
      // This handles cases where township names are stored in English but the lookup data uses Myanmar script
      // Comprehensive mapping of all English township names to Myanmar constituency codes
      const englishMappings = [
        // Nay Pyi Taw
        { englishName: 'Pyinmana', regionShort: 'NPW', tspCode: 'NPW-3', stateOrRegion: 'နေပြည်တော်', district: 'ဒက္ခိဏ (တောင်ပိုင်း)', constituency: 'ပျဉ်းမနား' },
        { englishName: 'Dekkhinathiri', regionShort: 'NPW', tspCode: 'NPW-2', stateOrRegion: 'နေပြည်တော်', district: 'ဒက္ခိဏ (တောင်ပိုင်း)', constituency: 'ဒက္ခိဏသီရိ' },
        { englishName: 'Lewe', regionShort: 'NPW', tspCode: 'NPW-4', stateOrRegion: 'နေပြည်တော်', district: 'ဒက္ခိဏ (တောင်ပိုင်း)', constituency: 'လယ်ဝေး' },
        { englishName: 'Ottarathiri', regionShort: 'NPW', tspCode: 'NPW-7', stateOrRegion: 'နေပြည်တော်', district: 'ဥတ္တရ (မြောက်ပိုင်း)', constituency: 'ပုဗ္ဗသီရိ' },
        { englishName: 'Pobbathiri', regionShort: 'NPW', tspCode: 'NPW-6', stateOrRegion: 'နေပြည်တော်', district: 'ဥတ္တရ (မြောက်ပိုင်း)', constituency: 'တပ်ကုန်း' },
        { englishName: 'Tatkon', regionShort: 'NPW', tspCode: 'NPW-1', stateOrRegion: 'နေပြည်တော်', district: 'ဒက္ခိဏ (တောင်ပိုင်း)', constituency: 'ဇမ္ဗူသီရိ' },
        { englishName: 'Zabuthiri', regionShort: 'NPW', tspCode: 'NPW-5', stateOrRegion: 'နေပြည်တော်', district: 'ဥတ္တရ (မြောက်ပိုင်း)', constituency: 'ဇေယျာသီရိ' },
        
        // Yangon Region - Comprehensive mapping
        { englishName: 'South Dagon', regionShort: 'YGN', tspCode: 'YGN-12', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'ဒဂုံမြို့သစ်(တောင်ပိုင်း)' },
        { englishName: 'Dagon', regionShort: 'YGN', tspCode: 'YGN-38', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အနောက်ပိုင်း)', constituency: 'ဒဂုံ' },
        { englishName: 'Dagon Myothit (South)', regionShort: 'YGN', tspCode: 'YGN-12', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'ဒဂုံမြို့သစ်(တောင်ပိုင်း)' },
        { englishName: 'Dagon Myothit (North)', regionShort: 'YGN', tspCode: 'YGN-13', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'ဒဂုံမြို့သစ်(မြောက်ပိုင်း)' },
        { englishName: 'Dagon Myothit (East)', regionShort: 'YGN', tspCode: 'YGN-14', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'ဒဂုံမြို့သစ်(အရှေ့ပိုင်း)' },
        { englishName: 'Dagon Myothit (Seikkan)', regionShort: 'YGN', tspCode: 'YGN-11', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'ဒဂုံမြို့သစ်(ဆိပ်ကမ်း)' },
        { englishName: 'North Dagon', regionShort: 'YGN', tspCode: 'YGN-13', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'ဒဂုံမြို့သစ်(မြောက်ပိုင်း)' },
        { englishName: 'East Dagon', regionShort: 'YGN', tspCode: 'YGN-14', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'ဒဂုံမြို့သစ်(အရှေ့ပိုင်း)' },
        { englishName: 'Seikkan', regionShort: 'YGN', tspCode: 'YGN-11', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'ဒဂုံမြို့သစ်(ဆိပ်ကမ်း)' },
        { englishName: 'Ahlone', regionShort: 'YGN', tspCode: 'YGN-35', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အနောက်ပိုင်း)', constituency: 'ကြည့်မြင်တိုင်' },
        { englishName: 'Bahan', regionShort: 'YGN', tspCode: 'YGN-40', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အနောက်ပိုင်း)', constituency: 'ဗဟန်း' },
        { englishName: 'Botataung', regionShort: 'YGN', tspCode: 'YGN-34', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အနောက်ပိုင်း)', constituency: 'ကျောက်တံတား' },
        { englishName: 'Cocokyun', regionShort: 'YGN', tspCode: 'YGN-23', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(တောင်ပိုင်း)', constituency: 'ကိုကိုးကျွန်း' },
        { englishName: 'Dala', regionShort: 'YGN', tspCode: 'YGN-30', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(တောင်ပိုင်း)', constituency: 'ဒလ' },
        { englishName: 'Dawbon', regionShort: 'YGN', tspCode: 'YGN-15', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'ဒေါပုံ' },
        { englishName: 'Hlaing', regionShort: 'YGN', tspCode: 'YGN-44', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အနောက်ပိုင်း)', constituency: 'လှိုင်' },
        { englishName: 'Hlaingthaya (East)', regionShort: 'YGN', tspCode: 'YGN-6', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(မြောက်ပိုင်း)', constituency: 'လှိုင်သာယာ' },
        { englishName: 'Hlaingthaya (West)', regionShort: 'YGN', tspCode: 'YGN-5', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(မြောက်ပိုင်း)', constituency: 'ရွှေပြည်သာ' },
        { englishName: 'Insein', regionShort: 'YGN', tspCode: 'YGN-8', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(မြောက်ပိုင်း)', constituency: 'အင်းစိန်' },
        { englishName: 'Kamaryut', regionShort: 'YGN', tspCode: 'YGN-3', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(မြောက်ပိုင်း)', constituency: 'မင်္ဂလာဒုံ' },
        { englishName: 'Kyauktada', regionShort: 'YGN', tspCode: 'YGN-33', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အနောက်ပိုင်း)', constituency: 'ကမာရွတ်' },
        { englishName: 'Kyauktan', regionShort: 'YGN', tspCode: 'YGN-20', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'ရန်ကင်း' },
        { englishName: 'Kyeemyindaing', regionShort: 'YGN', tspCode: 'YGN-42', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အနောက်ပိုင်း)', constituency: 'လသာ' },
        { englishName: 'Lanmadaw', regionShort: 'YGN', tspCode: 'YGN-43', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အနောက်ပိုင်း)', constituency: 'လမ်းမတော်' },
        { englishName: 'Latha', regionShort: 'YGN', tspCode: 'YGN-39', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အနောက်ပိုင်း)', constituency: 'ပန်းဘဲတန်း' },
        { englishName: 'Mayangone', regionShort: 'YGN', tspCode: 'YGN-4', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(မြောက်ပိုင်း)', constituency: 'မှော်ဘီ' },
        { englishName: 'Mingaladon', regionShort: 'YGN', tspCode: 'YGN-3', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(မြောက်ပိုင်း)', constituency: 'မင်္ဂလာဒုံ' },
        { englishName: 'Mingalar Taung Nyunt', regionShort: 'YGN', tspCode: 'YGN-18', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'မင်္ဂလာတောင်ညွှန့်' },
        { englishName: 'North Okkalapa', regionShort: 'YGN', tspCode: 'YGN-19', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'မြောက်ဥက္ကလာပ' },
        { englishName: 'Pabedan', regionShort: 'YGN', tspCode: 'YGN-36', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အနောက်ပိုင်း)', constituency: 'စမ်းချောင်း' },
        { englishName: 'Pazundaung', regionShort: 'YGN', tspCode: 'YGN-9', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'တာမွေ' },
        { englishName: 'Sanchaung', regionShort: 'YGN', tspCode: 'YGN-45', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အနောက်ပိုင်း)', constituency: 'အလုံ' },
        { englishName: 'Seikkyi Khanaungto', regionShort: 'YGN', tspCode: 'YGN-7', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(မြောက်ပိုင်း)', constituency: 'လှည်းကူး' },
        { englishName: 'Shwepyithar', regionShort: 'YGN', tspCode: 'YGN-5', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(မြောက်ပိုင်း)', constituency: 'ရွှေပြည်သာ' },
        { englishName: 'South Okkalapa', regionShort: 'YGN', tspCode: 'YGN-10', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'တောင်ဥက္ကလာပ' },
        { englishName: 'Tamwe', regionShort: 'YGN', tspCode: 'YGN-17', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'ဗိုလ်တထောင်' },
        { englishName: 'Thingangyun', regionShort: 'YGN', tspCode: 'YGN-16', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'ပုဇွန်တောင်' },
        { englishName: 'Thaketa', regionShort: 'YGN', tspCode: 'YGN-21', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'သာကေတ' },
        { englishName: 'Yankin', regionShort: 'YGN', tspCode: 'YGN-22', stateOrRegion: 'ရန်ကုန်တိုင်းဒေသကြီး', district: 'ရန်ကုန်(အရှေ့ပိုင်း)', constituency: 'သင်္ဃန်းကျွန်း' },
        
        // Mandalay Region
        { englishName: 'Amarapura', regionShort: 'MDY', tspCode: 'MDY-18', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'မန္တလေး', constituency: 'အမရပူရ' },
        { englishName: 'Aungmyaythazan', regionShort: 'MDY', tspCode: 'MDY-13', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'မန္တလေး', constituency: 'ချမ်းအေးသာဇံ' },
        { englishName: 'Chanayethazan', regionShort: 'MDY', tspCode: 'MDY-12', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'မန္တလေး', constituency: 'ချမ်းမြသာစည်' },
        { englishName: 'Chanmyathazi', regionShort: 'MDY', tspCode: 'MDY-14', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'မန္တလေး', constituency: 'ပြည်ကြီးတံခွန်' },
        { englishName: 'Kyaukpadaung', regionShort: 'MDY', tspCode: 'MDY-1', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'ကျောက်ဆည်', constituency: 'ကျောက်ဆည်' },
        { englishName: 'Kyaukse', regionShort: 'MDY', tspCode: 'MDY-26', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'မြင်းခြံ', constituency: 'မြင်းခြံ' },
        { englishName: 'Madaya', regionShort: 'MDY', tspCode: 'MDY-8', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'ပြင်ဦးလွင်', constituency: 'ပြင်ဦးလွင်' },
        { englishName: 'Mahaaungmyay', regionShort: 'MDY', tspCode: 'MDY-15', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'မန္တလေး', constituency: 'မဟာအောင်မြေ' },
        { englishName: 'Mahlaing', regionShort: 'MDY', tspCode: 'MDY-20', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'မိတ္ထီလာ', constituency: 'မိတ္ထီလာ' },
        { englishName: 'Meiktila', regionShort: 'MDY', tspCode: 'MDY-10', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'ပြင်ဦးလွင်', constituency: 'မတ္တရာ' },
        { englishName: 'Mogoke', regionShort: 'MDY', tspCode: 'MDY-9', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'ပြင်ဦးလွင်', constituency: 'မိုးကုတ်' },
        { englishName: 'Myingyan', regionShort: 'MDY', tspCode: 'MDY-21', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'မိတ္ထီလာ', constituency: 'ဝမ်းတွင်း' },
        { englishName: 'Myittha', regionShort: 'MDY', tspCode: 'MDY-3', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'ကျောက်ဆည်', constituency: 'တံတားဦး' },
        { englishName: 'Natogyi', regionShort: 'MDY', tspCode: 'MDY-4', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'ကျောက်ဆည်', constituency: 'မြစ်သား' },
        { englishName: 'Ngazun', regionShort: 'MDY', tspCode: 'MDY-23', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'မြင်းခြံ', constituency: 'ငါန်းဇွန်' },
        { englishName: 'Nyaung-U', regionShort: 'MDY', tspCode: 'MDY-6', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'ညောင်ဦး', constituency: 'ညောင်ဦး' },
        { englishName: 'Patheingyi', regionShort: 'MDY', tspCode: 'MDY-2', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'ကျောက်ဆည်', constituency: 'စဉ့်ကိုင်' },
        { englishName: 'Pyigyidagun', regionShort: 'MDY', tspCode: 'MDY-16', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'မန္တလေး', constituency: 'အောင်မြေသာဇံ' },
        { englishName: 'Pyinoolwin', regionShort: 'MDY', tspCode: 'MDY-7', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'ပြင်ဦးလွင်', constituency: 'စဉ့်ကူး' },
        { englishName: 'Singu', regionShort: 'MDY', tspCode: 'MDY-24', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'မြင်းခြံ', constituency: 'တောင်သာ' },
        { englishName: 'Sintgaing', regionShort: 'MDY', tspCode: 'MDY-25', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'မြင်းခြံ', constituency: 'နွားထိုးကြီး' },
        { englishName: 'Tada-U', regionShort: 'MDY', tspCode: 'MDY-5', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'ညောင်ဦး', constituency: 'ကျောက်ပန်းတောင်း' },
        { englishName: 'Taungtha', regionShort: 'MDY', tspCode: 'MDY-22', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'မိတ္ထီလာ', constituency: 'သာစည်' },
        { englishName: 'Thazi', regionShort: 'MDY', tspCode: 'MDY-19', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'မိတ္ထီလာ', constituency: 'မလှိုင်' },
        { englishName: 'Wundwin', regionShort: 'MDY', tspCode: 'MDY-27', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'ရမည်းသင်း', constituency: 'ပျော်ဘွယ်' },
        { englishName: 'Yamethin', regionShort: 'MDY', tspCode: 'MDY-28', stateOrRegion: 'မန္တလေးတိုင်းဒေသကြီး', district: 'ရမည်းသင်း', constituency: 'ရမည်းသင်း' },
        
        // Note: This is a partial mapping. Due to the large number of townships (300+), 
        // additional mappings should be added following the same pattern.
        // To add more: Match English township name from registration.html to Myanmar constituency 
        // name in REGION_TSP_DATA and use the corresponding code as tspCode.
      ];
      
      englishMappings.forEach(mapping => {
        const key = normalizeLocationName(mapping.englishName);
        if (!map.has(key)) {
          map.set(key, {
            regionShort: mapping.regionShort,
            tspCode: mapping.tspCode,
            stateOrRegion: mapping.stateOrRegion,
            district: mapping.district,
            constituency: mapping.constituency
          });
        }
      });
      
      return map;
    })();

    function getLocationMetadataByTownship(township) {
      if (!township) return null;
      const normalized = normalizeLocationName(township);
      if (TOWNSHIP_CODE_LOOKUP.has(normalized)) {
        const metadata = TOWNSHIP_CODE_LOOKUP.get(normalized);
        console.log('Location metadata found for township:', township, '->', metadata);
        return metadata;
      }
      console.warn('No location metadata found for township:', township, '(normalized:', normalized, ')');
      return null;
    }

    function formatRegistrationDateDisplay(dateString) {
      if (!dateString) return null;
      const dateObj = new Date(dateString);
      if (Number.isNaN(dateObj.getTime())) {
        return null;
      }
      return dateObj.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    }

  function sanitizeCodeSegment(value, fallback) {
    const segment = (value || fallback || '').toString().trim();
    return segment ? segment.replace(/[^A-Za-z0-9-]/g, '').toUpperCase() : fallback;
  }

  // Preview function: Get the next ID without incrementing the counter
  async function previewNextPatientId(regionShortRaw, tspCodeRaw) {
    try {
      console.log('previewNextPatientId called with:', { regionShortRaw, tspCodeRaw });
      
      // Check if user is authenticated
      const user = firebase.auth().currentUser;
      if (!user) {
        throw new Error('User not authenticated');
      }
      
      const db = firebase.firestore();
      const regionShort = sanitizeCodeSegment(regionShortRaw, 'GEN');
      const tspCode = sanitizeCodeSegment(tspCodeRaw, 'UNK');
      const yearSuffix = new Date().getFullYear().toString().slice(-2);
      // Counter ID uses only TSP code (region short code removed as it's redundant)
      const sanitizedTspCode = tspCode.replace(/[^A-Za-z0-9]/g, '');
      const counterId = `${sanitizedTspCode}_${yearSuffix}`;
      const counterRef = db.collection('patient_counters').doc(counterId);
      
      console.log('Reading current serial for preview, counter ID:', counterId);
      
      // Read-only: Get current serial without incrementing
      const snapshot = await counterRef.get();
      let currentSerial = 0;
      if (snapshot.exists) {
        const data = snapshot.data();
        if (typeof data.lastSerial === 'number') {
          currentSerial = data.lastSerial;
          console.log('Current serial from counter:', currentSerial);
        }
      }
      
      // Calculate what the next ID would be (without actually incrementing)
      const nextSerial = currentSerial + 1;
      const serialStr = String(nextSerial).padStart(6, '0');
      // Patient ID format: TSP_CODE-YEAR_SERIAL (region short code removed)
      const previewId = `${tspCode}-${yearSuffix}${serialStr}`;
      console.log('Preview ID calculated:', previewId);
      
      return {
        uniqueId: previewId,
        meta: {
          regionShort,
          tspCode,
          yearSuffix,
          serial: nextSerial
        }
      };
    } catch (error) {
      console.error('Error in previewNextPatientId:', error);
      throw new Error(`Failed to preview ID: ${error.message || error} (Code: ${error.code || 'unknown'})`);
    }
  }

  async function generatePatientUniqueId(regionShortRaw, tspCodeRaw) {
    try {
      console.log('generatePatientUniqueId called with:', { regionShortRaw, tspCodeRaw });
      
      // Check if user is authenticated
      const user = firebase.auth().currentUser;
      if (!user) {
        throw new Error('User not authenticated');
      }
      console.log('User authenticated:', user.uid);
      
      const db = firebase.firestore();
      const regionShort = sanitizeCodeSegment(regionShortRaw, 'GEN');
      const tspCode = sanitizeCodeSegment(tspCodeRaw, 'UNK');
      const yearSuffix = new Date().getFullYear().toString().slice(-2);
      // Counter ID uses only TSP code (region short code removed as it's redundant)
      const sanitizedTspCode = tspCode.replace(/[^A-Za-z0-9]/g, '');
      const counterId = `${sanitizedTspCode}_${yearSuffix}`;
      const counterRef = db.collection('patient_counters').doc(counterId);
      
      console.log('Counter reference:', counterId);
      console.log('Attempting Firestore transaction...');

      const nextSerial = await db.runTransaction(async (transaction) => {
        console.log('Transaction started');
        const snapshot = await transaction.get(counterRef);
        console.log('Counter snapshot exists:', snapshot.exists);
        
        let currentSerial = 0;
        if (snapshot.exists) {
          const data = snapshot.data();
          console.log('Counter data:', data);
          if (typeof data.lastSerial === 'number') {
            currentSerial = data.lastSerial;
            console.log('Current serial:', currentSerial);
          }
        }
        const updatedSerial = currentSerial + 1;
        console.log('Updating serial to:', updatedSerial);
        
        transaction.set(counterRef, {
          lastSerial: updatedSerial,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        return updatedSerial;
      });

      console.log('Transaction completed. Next serial:', nextSerial);
      const serialStr = String(nextSerial).padStart(6, '0');
      // Patient ID format: TSP_CODE-YEAR_SERIAL (region short code removed)
      const uniqueId = `${tspCode}-${yearSuffix}${serialStr}`;
      console.log('Generated unique ID:', uniqueId);
      
      return {
        uniqueId,
        meta: {
          regionShort,
          tspCode,
          yearSuffix,
          serial: nextSerial
        }
      };
    } catch (error) {
      console.error('Error in generatePatientUniqueId:', error);
      console.error('Error code:', error.code);
      console.error('Error message:', error.message);
      console.error('Error stack:', error.stack);
      
      // Re-throw with more context
      throw new Error(`Failed to generate ID: ${error.message || error} (Code: ${error.code || 'unknown'})`);
    }
  }
    // Load user's township and display it
    async function loadUserTownship() {
      try {
        console.log('loadUserTownship() called');
        
        // Wait for Firebase auth to be ready
        let user = firebase.auth().currentUser;
        if (!user) {
          console.log('No current user, waiting for auth state...');
          await new Promise((resolve) => {
            const unsubscribe = firebase.auth().onAuthStateChanged((authUser) => {
              unsubscribe();
              user = authUser;
              resolve();
            });
            // Timeout after 5 seconds
            setTimeout(() => {
              unsubscribe();
              resolve();
            }, 5000);
          });
        }
        
        if (!user) {
          console.error('No authenticated user found after waiting');
          return;
        }
        
        console.log('Loading township for user:', user.uid);
        
        const userDoc = await firebase.firestore().collection("users").doc(user.uid).get();
        console.log('User document exists:', userDoc.exists);
        
        if (userDoc.exists) {
          const userData = userDoc.data();
          console.log('Full user data:', userData);
          console.log('Township from user data:', userData.township);
          
          const township = userData.township || 'Not set';
          console.log('Township to display:', township);
          
          // Only update display elements if they exist
          const userTownshipEl = document.getElementById('userTownship');
          const townshipDisplayEl = document.getElementById('townshipDisplay');
          if (userTownshipEl) {
            userTownshipEl.textContent = township;
          }
          if (townshipDisplayEl) {
            townshipDisplayEl.style.display = 'block';
          }

          const regionShortInput = document.getElementById('regionShort');
          const tspCodeInput = document.getElementById('tspCode');
          const tspCodeDisplay = document.getElementById('tspCodeDisplay');

          const locationMetadata = getLocationMetadataByTownship(township);
          let regionShort = 'UNK';
          let tspCode = 'UNK-0';
          
          if (locationMetadata) {
            regionShort = locationMetadata.regionShort || 'UNK';
            tspCode = locationMetadata.tspCode || 'UNK-0';
            if (regionShortInput) regionShortInput.value = regionShort;
            if (tspCodeInput) tspCodeInput.value = tspCode;
            if (tspCodeDisplay) tspCodeDisplay.textContent = tspCode;
          } else {
            if (regionShortInput) regionShortInput.value = regionShort;
            if (tspCodeInput) tspCodeInput.value = tspCode;
            if (tspCodeDisplay) tspCodeDisplay.textContent = tspCode;
            console.warn('No location metadata found for township:', township);
          }
          
          // Preview the next patient ID (read-only, doesn't increment counter)
          const patientUniqueIdDisplay = document.getElementById('patientUniqueIdDisplay');
          if (patientUniqueIdDisplay && regionShort !== 'UNK' && tspCode !== 'UNK-0') {
            try {
              console.log('Loading preview ID...');
              patientUniqueIdDisplay.value = 'Loading...';
              const previewResult = await previewNextPatientId(regionShort, tspCode);
              if (patientUniqueIdDisplay) {
                patientUniqueIdDisplay.value = previewResult.uniqueId;
                patientUniqueIdDisplay.placeholder = previewResult.uniqueId;
              }
              console.log('Preview ID loaded:', previewResult.uniqueId);
            } catch (previewError) {
              console.warn('Failed to load preview ID:', previewError);
              if (patientUniqueIdDisplay) {
                patientUniqueIdDisplay.value = '';
                patientUniqueIdDisplay.placeholder = 'ID will be generated when you save';
              }
            }
          } else {
            if (patientUniqueIdDisplay) {
              patientUniqueIdDisplay.value = '';
              patientUniqueIdDisplay.placeholder = 'ID will be generated when you save';
            }
          }
          console.log('Location codes loaded. Preview ID displayed (counter will increment on save).');
          
          // Check if township is properly set
          if (!userData.township || userData.township.trim() === '') {
            const townshipDisplayEl = document.getElementById('townshipDisplay');
            if (townshipDisplayEl) {
              townshipDisplayEl.innerHTML = `
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Warning:</strong> Your township is not set. 
                <br><small class="text-muted">Patients created without a township may not display properly.</small>
              </div>
            `;
            }
            console.warn('User township is not set!');
          }
          
          console.log('User township loaded and displayed:', township);
        } else {
          console.error('User document does not exist!');
          const townshipDisplayEl = document.getElementById('townshipDisplay');
          if (townshipDisplayEl) {
            townshipDisplayEl.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-circle"></i>
              <strong>Error:</strong> User data not found. Please contact administrator.
            </div>
          `;
          }
        }
      } catch (error) {
        console.error('Error loading user township:', error);
        const townshipDisplayEl = document.getElementById('townshipDisplay');
        if (townshipDisplayEl) {
          townshipDisplayEl.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            <strong>Error:</strong> Failed to load user data. Please refresh the page.
          </div>
        `;
        }
      }
    }




    // Language Switcher Functionality
    let currentLanguage = localStorage.getItem('appLanguage') || 'mm';
    
    function switchLanguage(lang) {
      currentLanguage = lang;
      localStorage.setItem('appLanguage', lang);
      
      // Update active button
      document.querySelectorAll('.language-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      // Update all text elements with lang-text class
      document.querySelectorAll('.lang-text').forEach(el => {
        const text = el.dataset[lang] || el.dataset.en || el.textContent;
        el.textContent = text;
      });
      
      // Update placeholders
      const placeholders = {
        en: {
          name: 'Enter patient\'s full name',
          age: 'Enter age',
          phone: 'Enter phone number',
          address: 'Enter patient\'s address',
          emergencyContact: 'Enter emergency contact name',
          emergencyPhone: 'Enter emergency contact phone'
        },
        mm: {
          name: 'လူနာ၏ အမည်အပြည့်အစုံ ထည့်သွင်းပါ',
          age: 'အသက်ထည့်သွင်းပါ',
          phone: 'ဖုန်းနံပါတ် ထည့်သွင်းပါ',
          address: 'လူနာ၏ လိပ်စာ ထည့်သွင်းပါ',
          emergencyContact: 'အရေးပေါ်ဆက်သွယ်ရမည့်သူ၏ အမည် ထည့်သွင်းပါ',
          emergencyPhone: 'အရေးပေါ်ဆက်သွယ်ရမဉ့်ဖုန်း ထည့်သွင်းပါ'
        }
      };
      
      if (placeholders[lang]) {
        const nameInput = document.getElementById('name');
        const ageInput = document.getElementById('age');
        const phoneInput = document.getElementById('phone');
        const addressInput = document.getElementById('patientAddress');
        const emergencyContactInput = document.getElementById('emergencyContact');
        const emergencyPhoneInput = document.getElementById('emergencyPhone');
        
        if (nameInput) nameInput.placeholder = placeholders[lang].name;
        if (ageInput) ageInput.placeholder = placeholders[lang].age;
        if (phoneInput) phoneInput.placeholder = placeholders[lang].phone;
        if (addressInput) addressInput.placeholder = placeholders[lang].address;
        if (emergencyContactInput) emergencyContactInput.placeholder = placeholders[lang].emergencyContact;
        if (emergencyPhoneInput) emergencyPhoneInput.placeholder = placeholders[lang].emergencyPhone;
      }
    }
    
    // Age-based Risk Detection
    function evaluateAgeRisk() {
      const ageInput = document.getElementById('age');
      const ageRiskAlert = document.getElementById('ageRiskAlert');
      const ageValue = ageInput ? parseInt(ageInput.value, 10) : NaN;
      
      if (Number.isNaN(ageValue) || ageValue === 0) {
        if (ageRiskAlert) {
          ageRiskAlert.classList.remove('show');
          ageRiskAlert.classList.add('hide');
          ageRiskAlert.style.display = 'none';
        }
        if (ageInput) ageInput.classList.remove('is-high-risk');
        return false;
      }
      
      const isHighRisk = ageValue < 17 || ageValue >= 40;
      
      if (ageRiskAlert) {
        if (isHighRisk) {
          ageRiskAlert.classList.remove('hide');
          ageRiskAlert.classList.add('show');
          ageRiskAlert.style.display = 'block';
        } else {
          ageRiskAlert.classList.remove('show');
          ageRiskAlert.classList.add('hide');
          ageRiskAlert.style.display = 'none';
        }
      }
      
      if (ageInput) {
        ageInput.classList.toggle('is-high-risk', isHighRisk);
      }
      
      return isHighRisk;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded - Initializing patient registration page');
      
      // Initialize language switcher
      document.querySelectorAll('.language-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          switchLanguage(this.dataset.lang);
        });
      });
      
      // Set initial language
      switchLanguage(currentLanguage);
      
      // Age risk detection and English number only validation
      const ageInput = document.getElementById('age');
      if (ageInput) {
        // Only allow English numbers (0-9)
        ageInput.addEventListener('input', function(e) {
          // Remove any non-English digits
          let value = e.target.value.replace(/[^0-9]/g, '');
          if (e.target.value !== value) {
            e.target.value = value;
          }
          evaluateAgeRisk();
        });
        
        // Handle paste events to filter non-English numbers
        ageInput.addEventListener('paste', function(e) {
          e.preventDefault();
          const pastedText = (e.clipboardData || window.clipboardData).getData('text');
          const englishNumbersOnly = pastedText.replace(/[^0-9]/g, '');
          if (englishNumbersOnly) {
            e.target.value = englishNumbersOnly;
            evaluateAgeRisk();
          }
        });
        
        // Handle keypress to prevent non-English numbers
        ageInput.addEventListener('keypress', function(e) {
          // Allow: backspace, delete, tab, escape, enter, and numbers 0-9
          if ([46, 8, 9, 27, 13, 110, 190].indexOf(e.keyCode) !== -1 ||
              // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
              (e.keyCode === 65 && e.ctrlKey === true) ||
              (e.keyCode === 67 && e.ctrlKey === true) ||
              (e.keyCode === 86 && e.ctrlKey === true) ||
              (e.keyCode === 88 && e.ctrlKey === true) ||
              // Allow: home, end, left, right
              (e.keyCode >= 35 && e.keyCode <= 39)) {
            return;
          }
          // Ensure that it is a number and stop the keypress if not
          if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
            e.preventDefault();
          }
        });
        
        ageInput.addEventListener('change', evaluateAgeRisk);
      }
      
      // Load township asynchronously without blocking
      console.log('About to call loadUserTownship()');
      loadUserTownship()
        .then(() => {
          console.log('loadUserTownship() completed successfully');
        })
        .catch(error => {
          console.error('Error loading user township:', error);
          console.error('Error stack:', error.stack);
          // Update patient ID field to show it will be generated on save
          const patientIdField = document.getElementById('patientUniqueIdDisplay');
          if (patientIdField) {
            patientIdField.placeholder = 'ID will be generated when you save';
            patientIdField.value = '';
          }
          // Page should still be usable even if township loading fails
        });
      
      // Parity controls setup
      const parityHiddenInput = document.getElementById('parity');
      const parityPreview = document.getElementById('parityPreview');
      const parityControls = {
        gravida: document.getElementById('gravidaSelect'),
        primary: document.getElementById('parityPrimarySelect'),
        secondary: document.getElementById('paritySecondarySelect')
      };
      const youngestChildFields = document.getElementById('youngestChildFields');
      const youngestChildAgeYearsInput = document.getElementById('youngestChildAgeYears');
      const youngestChildAgeMonthsInput = document.getElementById('youngestChildAgeMonths');
      const pregnancyAlert = document.getElementById('pregnancy24Alert');
      const pregnancyFlagInput = document.getElementById('pregnancyWithin24Months');
      const registrationDateInput = document.getElementById('registration_date');
      const registrationDateFormatted = document.getElementById('registrationDateFormatted');
      const regionShortInputHidden = document.getElementById('regionShort');
      const tspCodeInputHidden = document.getElementById('tspCode');
      const patientUniqueIdHidden = document.getElementById('patientUniqueId');
      const patientUniqueIdDisplay = document.getElementById('patientUniqueIdDisplay');

      function buildParityString() {
        const g = parityControls.gravida ? parityControls.gravida.value.trim() : '';
        const p1 = parityControls.primary ? parityControls.primary.value.trim() : '';
        const p2 = parityControls.secondary ? parityControls.secondary.value.trim() : '';

        let parts = [];
        if (g) {
          parts.push(`G${g}`);
        }
        if (p1) {
          let segment = `P${p1}`;
          if (p2) {
            segment += `+${p2}`;
          }
          parts.push(segment);
        } else if (p2) {
          parts.push(`P0+${p2}`);
        }

        return parts.join('');
      }

      function updateParityField() {
        if (!parityHiddenInput) return;
        const combined = buildParityString();
        parityHiddenInput.value = combined;
        if (parityPreview) {
          parityPreview.textContent = combined || '—';
        }
      }

      function resetYoungestChildInputs() {
        if (youngestChildAgeYearsInput) youngestChildAgeYearsInput.value = '';
        if (youngestChildAgeMonthsInput) youngestChildAgeMonthsInput.value = '';
      }

      function toggleYoungestChildFields() {
        if (!parityControls.gravida || !youngestChildFields) return;
        const gravidaVal = parseInt(parityControls.gravida.value, 10);
        if (!Number.isNaN(gravidaVal) && gravidaVal >= 2) {
          youngestChildFields.style.display = 'block';
        } else {
          youngestChildFields.style.display = 'none';
          if (pregnancyAlert) pregnancyAlert.style.display = 'none';
          if (pregnancyFlagInput) pregnancyFlagInput.value = 'false';
          resetYoungestChildInputs();
        }
      }

      function evaluatePregnancyInterval() {
        if (!parityControls.gravida) return;
        const gravidaVal = parseInt(parityControls.gravida.value, 10);
        if (Number.isNaN(gravidaVal) || gravidaVal < 2) {
          if (pregnancyAlert) pregnancyAlert.style.display = 'none';
          if (pregnancyFlagInput) pregnancyFlagInput.value = 'false';
          return;
        }

        const years = youngestChildAgeYearsInput ? parseInt(youngestChildAgeYearsInput.value, 10) : NaN;
        const months = youngestChildAgeMonthsInput ? parseInt(youngestChildAgeMonthsInput.value, 10) : NaN;

        if (Number.isNaN(years) && Number.isNaN(months)) {
          if (pregnancyAlert) pregnancyAlert.style.display = 'none';
          if (pregnancyFlagInput) pregnancyFlagInput.value = 'false';
          return;
        }

        const safeYears = Number.isNaN(years) ? 0 : Math.max(0, years);
        const safeMonthsRaw = Number.isNaN(months) ? 0 : Math.max(0, months);
        const safeMonths = Math.min(safeMonthsRaw, 11);
        const totalMonths = safeYears * 12 + safeMonths;
        const within24 = totalMonths >= 0 && totalMonths < 24;

        if (pregnancyAlert) {
          pregnancyAlert.style.display = within24 ? 'block' : 'none';
        }
        if (pregnancyFlagInput) {
          pregnancyFlagInput.value = within24 ? 'true' : 'false';
        }
      }

      function updateRegistrationDatePreview() {
        if (!registrationDateFormatted) return;
        const formatted = formatRegistrationDateDisplay(registrationDateInput ? registrationDateInput.value : null);
        registrationDateFormatted.textContent = formatted || '—';
      }

      Object.values(parityControls).forEach(control => {
        if (control) {
          control.addEventListener('change', updateParityField);
        }
      });

      if (parityControls.gravida) {
        parityControls.gravida.addEventListener('change', () => {
          toggleYoungestChildFields();
          evaluatePregnancyInterval();
        });
      }
      if (youngestChildAgeYearsInput) {
        youngestChildAgeYearsInput.addEventListener('input', evaluatePregnancyInterval);
        youngestChildAgeYearsInput.addEventListener('change', evaluatePregnancyInterval);
      }
      if (youngestChildAgeMonthsInput) {
        youngestChildAgeMonthsInput.addEventListener('input', evaluatePregnancyInterval);
        youngestChildAgeMonthsInput.addEventListener('change', evaluatePregnancyInterval);
      }
      if (registrationDateInput) {
        registrationDateInput.addEventListener('change', updateRegistrationDatePreview);
        registrationDateInput.addEventListener('input', updateRegistrationDatePreview);
      }

      updateParityField();
      toggleYoungestChildFields();
      evaluatePregnancyInterval();
      updateRegistrationDatePreview();
      
      // Add form submission listener with delay to ensure DOM is ready
      setTimeout(() => {
        const form = document.getElementById("patientForm");
        console.log('Form found:', form);
      
      // Debug form structure
      console.log('Form element:', form);
      console.log('All buttons in form:', form.querySelectorAll('button'));
      
      // Add click listener to button as backup
      let submitBtn = form.querySelector('button[type="submit"]');
      console.log('Submit button found:', submitBtn);
      
      // Try alternative selectors if first one fails
      if (!submitBtn) {
        submitBtn = form.querySelector('.btn-primary');
        console.log('Alternative button found:', submitBtn);
      }
      
      // Last resort - search entire document
      if (!submitBtn) {
        submitBtn = document.querySelector('button[type="submit"]');
        console.log('Document-wide submit button found:', submitBtn);
      }
      
      if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
          console.log('Button clicked!');
        });
      } else {
        console.error('Submit button not found anywhere!');
        console.log('Available buttons:', document.querySelectorAll('button'));
      }
      
      form.addEventListener("submit", async (e) => {
      console.log('Form submit event triggered');
      e.preventDefault();
      
      // Get button reference and show loading state
      let submitBtn = form.querySelector('button[type="submit"]');
      
      // Fallback to alternative selectors if first one fails
      if (!submitBtn) {
        submitBtn = form.querySelector('.btn-primary');
      }
      
      // Last resort - search entire document
      if (!submitBtn) {
        submitBtn = document.querySelector('button[type="submit"]');
      }
      
      console.log('Form submission - Submit button found:', submitBtn);
      
      const messageDiv = document.getElementById('message');
      const originalText = submitBtn ? submitBtn.innerHTML : '';
      
      // Ensure parity hidden value is up to date before collecting data
      updateParityField();
      
      // Show loading state
      if (submitBtn) {
        submitBtn.innerHTML = '<div class="loading"></div> Registering Patient...';
        submitBtn.disabled = true;
      }
      
      // Clear previous messages
      messageDiv.textContent = '';
      messageDiv.className = '';
      
      const data = Object.fromEntries(new FormData(form));
      
      // Basic form validation
      if (!data.name || !data.age || !data.registration_date) {
        messageDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Please fill in all required fields (Name, Age, Registration Date).</div>';
        // Reset button state on validation error
        if (submitBtn) {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
        return;
      }
      try {
        const user = firebase.auth().currentUser;
        console.log('Current user object:', user);
        console.log('Current user UID:', user?.uid);
        
        if (!user) {
          console.error('❌ No authenticated user found!');
          document.getElementById("message").innerHTML = 
            '<div class="alert alert-danger">❌ Error: You must be logged in to register patients.</div>';
          
          // Reset button state
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
          return;
        }
        
        // Fetch the user's township from Firestore
        const userDoc = await firebase.firestore().collection("users").doc(user.uid).get();
        console.log('User document exists:', userDoc.exists);
        
        if (userDoc.exists) {
          const userData = userDoc.data();
          console.log('User data:', userData);
          console.log('User township from Firestore:', userData.township);
        }
        
        const userTownship = userDoc.exists ? userDoc.data().township : "";
        console.log('Township to assign to patient:', userTownship);
        
        // Validate township
        if (!userTownship || userTownship.trim() === '') {
          console.error('User township is empty or invalid:', userTownship);
          document.getElementById("message").innerHTML = 
            '<div class="alert alert-warning">⚠️ Warning: Your township is not set. Please contact an administrator to set your township.</div>';
          
          // Reset button state on township validation error
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
          return;
        }
        
        // Add township and timestamp (using snake_case only to avoid duplicates)
        data.township = userTownship;
        
        console.log('Setting created_by field:', user.uid);
        console.log('Registration date:', data.registration_date);

        // Resolve location metadata and ensure hidden fields are populated
        let resolvedRegionShort = data.regionShort || '';
        let resolvedTspCode = data.tspCode || '';
        const locationMetadata = getLocationMetadataByTownship(userTownship);
        if ((!resolvedRegionShort || !resolvedTspCode) && locationMetadata) {
          resolvedRegionShort = locationMetadata.regionShort || resolvedRegionShort;
          resolvedTspCode = locationMetadata.tspCode || resolvedTspCode;
        }
        if (regionShortInputHidden) regionShortInputHidden.value = resolvedRegionShort || '';
        if (tspCodeInputHidden) tspCodeInputHidden.value = resolvedTspCode || '';

        // Use pre-generated patient ID or generate if not present
        if (!data.patientUniqueId && patientUniqueIdHidden && patientUniqueIdHidden.value) {
          data.patientUniqueId = patientUniqueIdHidden.value;
        }
        if (!data.patientUniqueId) {
          try {
            const idResult = await generatePatientUniqueId(resolvedRegionShort, resolvedTspCode);
            data.patientUniqueId = idResult.uniqueId;
            if (patientUniqueIdHidden) patientUniqueIdHidden.value = idResult.uniqueId;
            if (patientUniqueIdDisplay) patientUniqueIdDisplay.value = idResult.uniqueId;
          } catch (idError) {
            console.error('Failed to generate patient unique ID:', idError);
            data.patientUniqueId = data.patientUniqueId || `GEN-${Date.now()}`;
          }
        } else {
          if (patientUniqueIdHidden) patientUniqueIdHidden.value = data.patientUniqueId;
          if (patientUniqueIdDisplay) patientUniqueIdDisplay.value = data.patientUniqueId;
        }

        const gravidaValue = data.gravida_value ? parseInt(data.gravida_value, 10) : null;
        const parityPrimaryValue = data.parity_primary ? parseInt(data.parity_primary, 10) : null;
        const paritySecondaryValue = data.parity_secondary ? parseInt(data.parity_secondary, 10) : null;
        const youngestYearsRaw = data.youngestChildAgeYears !== undefined && data.youngestChildAgeYears !== '' ? parseInt(data.youngestChildAgeYears, 10) : null;
        const youngestMonthsRaw = data.youngestChildAgeMonths !== undefined && data.youngestChildAgeMonths !== '' ? parseInt(data.youngestChildAgeMonths, 10) : null;
        const youngestYears = Number.isFinite(youngestYearsRaw) ? Math.max(0, youngestYearsRaw) : null;
        const youngestMonths = Number.isFinite(youngestMonthsRaw) ? Math.max(0, Math.min(11, youngestMonthsRaw)) : null;
        const intervalMonths = (youngestYears === null && youngestMonths === null)
          ? null
          : (youngestYears || 0) * 12 + (youngestMonths || 0);
        const pregnancyWithin24 = data.pregnancyWithin24Months === 'true';
        const frequentPregnancy = pregnancyWithin24 ? 'Yes' : 'No';
        const ageValue = parseInt(data.age, 10);
        const ageRisk = (Number.isFinite(ageValue) && (ageValue < 17 || ageValue >= 40)) ? 'Yes' : 'No';
        const registrationDateDisplay = formatRegistrationDateDisplay(data.registration_date);
        
        // Convert field names to snake_case for consistency (no duplicates)
        const processedData = {
          name: data.name,
          age: parseInt(data.age),
          township: data.township,
          created_at: firebase.firestore.FieldValue.serverTimestamp(),
          created_by: user.uid,
          status: 'registered', // NEW: Initial status is "Registered"
          
          // Basic info
          parity: data.parity || '',
          registration_date: data.registration_date || null,
          registration_date_display: registrationDateDisplay || null,
          gravida: Number.isFinite(gravidaValue) ? gravidaValue : null,
          parity_primary: Number.isFinite(parityPrimaryValue) ? parityPrimaryValue : null,
          parity_secondary: Number.isFinite(paritySecondaryValue) ? paritySecondaryValue : null,
          
          // Maternal history
          youngest_child_age_years: youngestYears,
          youngest_child_age_months: youngestMonths,
          youngest_child_interval_months: intervalMonths,
          pregnancy_within_24_months: pregnancyWithin24,
          frequent_pregnancy: frequentPregnancy,
          age_risk: ageRisk,
          maternal_age_risk: ageRisk === 'Yes',
          
          // Location identifiers
          region_short_code: resolvedRegionShort || null,
          tsp_code: resolvedTspCode || null,
          patient_unique_id: data.patientUniqueId || null,
          
          // Contact info
          phone: data.phone || null,
          patient_address: data.patientAddress || null,
          emergency_contact: data.emergencyContact || null,
          emergency_phone: data.emergencyPhone || null
        };
        
        console.log('Processed data to save:', processedData);
        console.log('created_by field in processed data:', processedData.created_by);
        
        const docRef = await firebase.firestore().collection("patients").add(processedData);
        console.log("Document written with ID: ", docRef.id);
        console.log('Patient created with township:', userTownship);
        console.log('Patient created by:', processedData.created_by);
        
        // Verify what was actually saved to Firestore
        const savedDoc = await docRef.get();
        if (savedDoc.exists) {
          const savedData = savedDoc.data();
          console.log('✅ Verification - Document saved successfully');
          console.log('✅ Verification - created_by field in saved document:', savedData.created_by);
          console.log('✅ Verification - Full saved document:', savedData);
        } else {
          console.error('❌ Verification failed - Document not found after creation');
        }
        
        // Log the saved data for verification
        console.log('Saved patient data:', {
          id: docRef.id,
          name: processedData.name,
          age: processedData.age,
          township: processedData.township,
          status: processedData.status,
          registration_date: processedData.registration_date,
          parity: processedData.parity,
          patient_unique_id: processedData.patient_unique_id,
          pregnancy_within_24_months: processedData.pregnancy_within_24_months
        });
        
        // Show success message
        const successDetails = data.patientUniqueId
          ? `<br><strong>Patient ID:</strong> ${data.patientUniqueId}`
          : '';
        messageDiv.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Patient record created successfully! Redirecting to dashboard...${successDetails}</div>`;
        
        // Reset button
        if (submitBtn) {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
        
        // Reset form
        form.reset();
        updateParityField();
        toggleYoungestChildFields();
        evaluatePregnancyInterval();
        if (patientUniqueIdHidden) patientUniqueIdHidden.value = '';
        if (patientUniqueIdDisplay) patientUniqueIdDisplay.value = '';
        updateRegistrationDatePreview();
        
        // Auto-redirect to index.html after 2 seconds
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
        
      } catch (error) {
        console.error("Error adding document: ", error);
        
        // Reset button state on error
        if (submitBtn) {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
        
        // Show error message
        messageDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error creating patient record: ${error.message}</div>`;
      }
      });

      form.addEventListener('reset', async () => {
        setTimeout(async () => {
          updateParityField();
          toggleYoungestChildFields();
          evaluatePregnancyInterval();
          evaluateAgeRisk();
          updateRegistrationDatePreview();
          
          // Reload preview ID after reset (read-only, doesn't increment counter)
          if (patientUniqueIdHidden) patientUniqueIdHidden.value = '';
          
          const regionShortInput = document.getElementById('regionShort');
          const tspCodeInput = document.getElementById('tspCode');
          const regionShort = regionShortInput ? regionShortInput.value : '';
          const tspCode = tspCodeInput ? tspCodeInput.value : '';
          
          if (patientUniqueIdDisplay && regionShort && tspCode && regionShort !== 'UNK' && tspCode !== 'UNK-0') {
            try {
              patientUniqueIdDisplay.value = 'Loading...';
              const previewResult = await previewNextPatientId(regionShort, tspCode);
              if (patientUniqueIdDisplay) {
                patientUniqueIdDisplay.value = previewResult.uniqueId;
                patientUniqueIdDisplay.placeholder = previewResult.uniqueId;
              }
            } catch (previewError) {
              console.warn('Failed to reload preview ID after reset:', previewError);
              if (patientUniqueIdDisplay) {
                patientUniqueIdDisplay.value = '';
                patientUniqueIdDisplay.placeholder = 'ID will be generated when you save';
              }
            }
          } else {
            if (patientUniqueIdDisplay) {
              patientUniqueIdDisplay.value = '';
              patientUniqueIdDisplay.placeholder = 'ID will be generated when you save';
            }
          }
        }, 0);
      });
      }, 100); // 100ms delay to ensure DOM is ready
    });
    
    // Debug function to check user township (can be called from console)
    window.debugUserTownship = async function() {
      try {
        const user = firebase.auth().currentUser;
        if (!user) {
          console.log('No user logged in');
          return;
        }
        
        console.log('=== DEBUG USER TOWNSHIP ===');
        console.log('User ID:', user.uid);
        
        const userDoc = await firebase.firestore().collection("users").doc(user.uid).get();
        console.log('User document exists:', userDoc.exists);
        
        if (userDoc.exists) {
          const userData = userDoc.data();
          console.log('Full user data:', userData);
          console.log('Township field:', userData.township);
          console.log('Township type:', typeof userData.township);
          console.log('Township length:', userData.township ? userData.township.length : 'N/A');
          console.log('Township trimmed:', userData.township ? userData.township.trim() : 'N/A');
        } else {
          console.log('User document does not exist!');
        }
        console.log('=== END DEBUG ===');
      } catch (error) {
        console.error('Debug error:', error);
      }
    };
  </script>
</head>
<body>
  <!-- Header -->
  <div class="header-section">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1>
            <i class="fas fa-user-plus me-3"></i>
            <span class="lang-text" data-en="Patient Registration" data-mm="လူနာမှတ်ပုံတင်ခြင်း">Patient Registration</span>
          </h1>
        </div>
        <div class="col-md-4 text-end">
          <div class="d-flex align-items-center justify-content-end gap-3">
            <!-- Language Switcher -->
            <div class="language-switcher">
              <button type="button" class="btn btn-sm btn-outline-secondary language-btn" data-lang="en" title="English">
                <span class="flag-icon">🇬🇧</span> ENG
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary language-btn active" data-lang="mm" title="မြန်မာ">
                <span class="flag-icon">🇲🇲</span> MM
              </button>
            </div>
            <a href="index.html" class="btn btn-secondary btn-sm">
              <i class="fas fa-home me-2"></i><span class="lang-text" data-en="Home" data-mm="ပင်မစာမျက်နှာ">Home</span>
            </a>
            <button class="btn btn-secondary btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
              <i class="fas fa-sign-out-alt me-2"></i><span class="lang-text" data-en="Logout" data-mm="ထွက်ရန်">Logout</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <div class="container">
    

      <!-- Patient Registration Form -->
      <form id="patientForm" class="form-container">
        <!-- Basic Information -->
        <div class="form-section">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="name" class="form-label required-field">
                  <i class="fas fa-id-card"></i><span class="lang-text" data-en="Patient Name" data-mm="လူနာအမည်">Patient Name</span>
                </label>
                <input type="text" name="name" id="name" class="form-control" placeholder="Enter patient's full name" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="age" class="form-label required-field">
                  <i class="fas fa-calendar-alt"></i><span class="lang-text" data-en="Age" data-mm="အသက်">Age</span>
                </label>
                <input type="number" name="age" id="age" class="form-control" placeholder="Enter age" required min="12" max="50" pattern="[0-9]*" inputmode="numeric">
                <div id="ageRiskAlert" class="alert alert-danger hide" style="display: none;">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  <span class="lang-text" data-en="⚠️ High Risk: Maternal age is 17 or under, or 40 and over. Please monitor closely." data-mm="⚠️ အန္တရာယ်များ: မိခင်အသက်သည် ၁၇ နှစ်အောက် သို့မဟုတ် ၄၀ နှစ်နှင့် အထက်ဖြစ်သည်။ ဂရုတစိုက်စောင့်ကြည့်ပါ။">⚠️ High Risk: Maternal age is 17 or under, or 40 and over. Please monitor closely.</span>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="phone" class="form-label">
                  <i class="fas fa-phone"></i><span class="lang-text" data-en="Phone Number" data-mm="ဖုန်းနံပါတ်">Phone Number</span>
                </label>
                <input type="tel" name="phone" id="phone" class="form-control" placeholder="Enter phone number">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="patientAddress" class="form-label">
                  <i class="fas fa-map-marker-alt"></i><span class="lang-text" data-en="Patient Address" data-mm="လူနာလိပ်စာ">Patient Address</span>
                </label>
                <input type="text" name="patientAddress" id="patientAddress" class="form-control" placeholder="Enter patient's address">
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="emergencyContact" class="form-label">
                  <i class="fas fa-user-friends"></i><span class="lang-text" data-en="Emergency Contact Name" data-mm="အရေးပေါ်ဆက်သွယ်ရမည့်သူ">Emergency Contact Name</span>
                </label>
                <input type="text" name="emergencyContact" id="emergencyContact" class="form-control" placeholder="Enter emergency contact name">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="emergencyPhone" class="form-label">
                  <i class="fas fa-phone-alt"></i><span class="lang-text" data-en="Emergency Contact Phone" data-mm="အရေးပေါ်ဆက်သွယ်ရန်ဖုန်း">Emergency Contact Phone</span>
                </label>
                <input type="tel" name="emergencyPhone" id="emergencyPhone" class="form-control" placeholder="Enter emergency contact phone">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="registration_date" class="form-label required-field">
                  <i class="fas fa-calendar-check"></i><span class="lang-text" data-en="Date of Registration" data-mm="မှတ်ပုံတင်သည့်နေ့">Date of Registration</span>
                </label>
                <input type="date" name="registration_date" id="registration_date" class="form-control" required>
                <div class="form-text">
                
                  <span class="d-block mt-1">
                     <strong id="registrationDateFormatted">—</strong>
                  </span>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-baby"></i><span class="lang-text" data-en="Parity & Gravida" data-mm="ကိုယ်ဝန်နှင့် မွေးဖွားမှု">Parity & Gravida</span>
                </label>
                <div class="parity-selects">
                  <div class="select-block">
                    <label for="gravidaSelect"><span class="lang-text" data-en="Gravida (G)" data-mm="ကိုယ်ဝန်ဆောင် အကြိမ်">Gravida (G)</span></label>
                    <select name="gravida_value" id="gravidaSelect" class="form-control">
                      <option value="">Select</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                      <option value="6">6</option>
                      <option value="7">7</option>
                      <option value="8">8</option>
                      <option value="9">9</option>
                      <option value="10">10</option>
                    </select>
              </div>
                  <div class="select-block">
                    <label for="parityPrimarySelect"><span class="lang-text" data-en="Parity" data-mm="မွေးဖွားအကြိမ်">Parity</span></label>
                    <select name="parity_primary" id="parityPrimarySelect" class="form-control">
                      <option value="">Select</option>
                      <option value="0">0</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                      <option value="6">6</option>
                      <option value="7">7</option>
                      <option value="8">8</option>
                      <option value="9">9</option>
                      <option value="10">10</option>
                    </select>
                  </div>
                  <div class="parity-plus">+</div>
                  <div class="select-block">
                    <label for="paritySecondarySelect"><span class="lang-text" data-en="Parity" data-mm="မွေးဖွားအကြိမ်">Parity</span></label>
                    <select name="parity_secondary" id="paritySecondarySelect" class="form-control">
                      <option value="">Select</option>
                      <option value="0">0</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                      <option value="6">6</option>
                      <option value="7">7</option>
                      <option value="8">8</option>
                      <option value="9">9</option>
                      <option value="10">10</option>
                    </select>
                  </div>
                </div>
                <input type="hidden" name="parity" id="parity" value="">
                <input type="hidden" name="pregnancyWithin24Months" id="pregnancyWithin24Months" value="false">
                <input type="hidden" name="regionShort" id="regionShort" value="">
                <input type="hidden" name="tspCode" id="tspCode" value="">
                <input type="hidden" name="patientUniqueId" id="patientUniqueId" value="">
                <div class="parity-helper">
                  Stored as <span id="parityPreview">—</span>
                </div>
                <div id="youngestChildFields" class="mt-3" style="display: none;">
                  <label class="form-label">
                    <i class="fas fa-child"></i>Age of Youngest Child
                  </label>
                  <div class="row g-3 align-items-end">
                    <div class="col-6">
                      <label for="youngestChildAgeYears" class="form-label-sm">Years</label>
                      <input type="number" min="0" max="25" class="form-control" id="youngestChildAgeYears" name="youngestChildAgeYears" placeholder="Years">
                    </div>
                    <div class="col-6">
                      <label for="youngestChildAgeMonths" class="form-label-sm">Months</label>
                      <input type="number" min="0" max="11" class="form-control" id="youngestChildAgeMonths" name="youngestChildAgeMonths" placeholder="Months">
                    </div>
                  </div>
                  <div id="pregnancy24Alert" class="alert alert-warning mt-3" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    This pregnancy occurred within 24 months of the last birth. Please monitor closely.
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row mt-2">
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-id-badge"></i><span class="lang-text" data-en="Generated Patient ID" data-mm="လူနာ ID">Generated Patient ID</span>
                </label>
                <input type="text" class="form-control" id="patientUniqueIdDisplay" placeholder="ID will be generated when you save" readonly>
                <div class="form-text">
                  <span class="lang-text" data-en="" data-mm="">Preview of the ID that will be assigned when you save. The counter increments only upon successful save.</span>
                </div>
              </div>
            </div>
          </div>
          
        </div>






        <!-- Action Buttons -->
        <div class="action-buttons">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-user-plus me-2"></i><span class="lang-text" data-en="Register Patient" data-mm="လူနာ မှတ်ပုံတင်ရန်">Register Patient</span>
          </button>
          <button type="reset" class="btn btn-secondary">
            <i class="fas fa-undo me-2"></i><span class="lang-text" data-en="Reset Form" data-mm="အစက ပြန်ဖြည့်ရန်">Reset Form</span>
          </button>
        </div>
      </form>

      <!-- Message Display -->
      <div id="message" class="mt-4"></div>
    </div>
  </div>

  <!-- Professional Footer -->
  <footer class="footer">
    <p>MNCH App 2025 | Developed by Jhpiego Myanmar for MoH.</p>
  </footer>
</body>
</html>
