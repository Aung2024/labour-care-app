<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>New Patient</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
 <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> <!-- MISSING! -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="js/firebase.js"></script>
   <!-- THEN run your auth check -->
  <script>
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) window.location.href = "login.html";
    });
  </script>
</head>
<body class="container my-4">
  <h3>Create New Patient Record</h3>
  <form id="patientForm" class="mt-4">
    <div class="mb-2">
      <label>Patient ID</label>
      <input type="text" name="id" class="form-control" required>
    </div>
    <div class="mb-2">
      <label>Patient Name</label>
      <input type="text" name="name" class="form-control" required>
    </div>
    <div class="mb-2">
      <label>Age</label>
      <input type="number" name="age" class="form-control" required>
    </div>
    <div class="mb-2">
      <label>Ruptured membranes (Date and Time)</label>
      <input type="datetime-local" name="rupturedMembranes" class="form-control">
    </div>
    <div class="mb-2">
      <label>Risk Factors</label>
      <textarea name="riskFactors" class="form-control" rows="2"></textarea>
    </div>
    <div class="mb-2">
      <label>Parity</label>
      <input type="number" name="parity" class="form-control">
    </div>
    <div class="mb-2">
      <label>Labour Onset</label>
      <select name="labourOnset" class="form-control" required>
        <option value="">Select...</option>
        <option value="Spontaneous">Spontaneous</option>
        <option value="Induced">Induced</option>
      </select>
    </div>
    <div class="mb-2">
      <label>Active Labour Diagnosis (Date)</label>
      <input type="date" name="activeDiagnosis" class="form-control">
    </div>
    <button type="submit" class="btn btn-primary mt-3">Save</button>
  </form>
  <div id="message" class="mt-3"></div>
  <a href="index.html" class="btn btn-secondary mt-3">⬅️ Back to Home</a>
  <button class="btn btn-outline-danger" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">Logout</button>
  <script>
    const form = document.getElementById("patientForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form));
      try {
        const user = firebase.auth().currentUser;
        // Create patient with auto-generated ID
        const docRef = await db.collection("patients").add({
          name: form.name.value,
          age: form.age.value,
          parity: form.parity.value,
          rupturedMembranes: form.rupturedMembranes.value,
          riskFactors: form.riskFactors.value,
          labourOnset: form.labourOnset.value,
          activeDiagnosis: form.activeDiagnosis.value,
          createdBy: user.uid,
          township: form.township ? form.township.value : "", // if you add township
          createdAt: new Date().toISOString()
        });
        // Optionally update the document with its own ID for easy search
        await docRef.update({ id: docRef.id });

        document.getElementById("message").innerHTML =
          `<div class="alert alert-success">✅ Patient created. <a href="summary.html?patient=${docRef.id}">Open Summary</a></div>`;
        form.reset();
      } catch (err) {
        document.getElementById("message").innerHTML =
          `<div class="alert alert-danger">❌ Error: ${err.message}</div>`;
      }
    });

    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) window.location.href = "login.html";
    });
  </script>
</body>
</html>
