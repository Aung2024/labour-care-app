<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>New Patient</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/style.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
 <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> <!-- MISSING! -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="js/firebase.js"></script>
   <!-- THEN run your auth check -->
  <script>
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "login.html";
      } else {
        // Load and display user's township
        loadUserTownship();
      }
    });
    
    // Load user's township and display it
    async function loadUserTownship() {
      try {
        const user = firebase.auth().currentUser;
        if (!user) return;
        
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          const township = userData.township || 'Not set';
          
          document.getElementById('userTownship').textContent = township;
          document.getElementById('townshipDisplay').style.display = 'block';
          
          console.log('User township loaded:', township);
        }
      } catch (error) {
        console.error('Error loading user township:', error);
      }
    }
  </script>
</head>
<body class="container my-4">
  <h3>Create New Patient Record</h3>
  
  <!-- Township Display -->
  <div id="townshipDisplay" class="alert alert-info mb-3" style="display: none;">
    <i class="fas fa-map-marker-alt"></i>
    <strong>Township:</strong> <span id="userTownship">Loading...</span>
    <br><small class="text-muted">This patient will automatically be assigned to your township.</small>
  </div>
  
  <form id="patientForm" class="mt-4">
    <div class="mb-2">
      <label>Patient Name</label>
      <input type="text" name="name" class="form-control" required>
    </div>
    <div class="mb-2">
      <label>Age</label>
      <input type="number" name="age" class="form-control" required>
    </div>
    <div class="mb-2">
      <label>Ruptured membranes (Date and Time)</label>
      <input type="datetime-local" name="rupturedMembranes" class="form-control">
    </div>
    <div class="mb-2">
      <label>Risk Factors</label>
      <textarea name="riskFactors" class="form-control" rows="2"></textarea>
    </div>
    <div class="mb-2">
      <label>Parity</label>
      <input type="number" name="parity" class="form-control">
    </div>
    <div class="mb-2">
      <label>Labour Onset</label>
      <select name="labourOnset" class="form-control" required>
        <option value="">Select...</option>
        <option value="Spontaneous">Spontaneous</option>
        <option value="Induced">Induced</option>
      </select>
    </div>
    <div class="mb-2">
      <label>Active Labour Diagnosis (Date)</label>
      <input type="date" name="activeDiagnosis" class="form-control">
    </div>
    <button type="submit" class="btn btn-primary mt-3">Save</button>
  </form>
  <div id="message" class="mt-3"></div>
  <a href="index.html" class="btn btn-secondary mt-3">⬅️ Back to Home</a>
  <button class="btn btn-outline-danger" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">Logout</button>
  <script>
    const form = document.getElementById("patientForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form));
      try {
        const user = firebase.auth().currentUser;
        // Fetch the user's township from Firestore
        const userDoc = await db.collection("users").doc(user.uid).get();
        const userTownship = userDoc.exists ? userDoc.data().township : "";
        // Create patient with auto-generated ID
        const docRef = await db.collection("patients").add({
          name: data.name,
          age: data.age,
          parity: data.parity,
          rupturedMembranes: data.rupturedMembranes,
          riskFactors: data.riskFactors,
          labourOnset: data.labourOnset,
          activeDiagnosis: data.activeDiagnosis,
          createdBy: user.uid,
          township: userTownship,
          treatmentStatus: 'active', // Default status for new patients
          createdAt: new Date().toISOString()
        });
        // Optionally update the document with its own ID for easy search
        await docRef.update({ id: docRef.id });

        document.getElementById("message").innerHTML =
          `<div class="alert alert-success">✅ Patient created. <a href="summary.html?patient=${docRef.id}">Open Summary</a></div>`;
        form.reset();
      } catch (err) {
        document.getElementById("message").innerHTML =
          `<div class="alert alert-danger">❌ Error: ${err.message}</div>`;
      }
    });

    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) window.location.href = "login.html";
    });
  </script>
</body>
<footer class="footer">
  © 2025 Labour Care App &mdash; Designed for clinical excellence
</footer>
</html>
