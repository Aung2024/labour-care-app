<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Antenatal Care Report</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="js/firebase.js"></script>
  <style>
    @media print {
      body { margin: 0; }
      .no-print { display: none !important; }
      .page-break { page-break-before: always; }
    }

    body {
      font-family: 'Arial', sans-serif;
      font-size: 12px;
      line-height: 1.2;
      background: white;
      color: black;
    }

    .report-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: white;
    }

    .report-header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #000;
      padding-bottom: 15px;
    }

    .report-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .report-subtitle {
      font-size: 14px;
      color: #666;
    }

    .patient-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .patient-info h5 {
      margin-bottom: 10px;
      color: #495057;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 5px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .info-label {
      font-weight: bold;
      min-width: 120px;
    }

    .visits-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 11px;
    }

    .visits-table th,
    .visits-table td {
      border: 1px solid #000;
      padding: 4px;
      text-align: center;
      vertical-align: middle;
    }

    .visits-table th {
      background-color: #e9ecef;
      font-weight: bold;
      font-size: 10px;
    }

    .visits-table .visit-number {
      background-color: #f8f9fa;
      font-weight: bold;
    }

    .treatment-section {
      margin-top: 20px;
      border-top: 1px solid #dee2e6;
      padding-top: 15px;
    }

    .treatment-item {
      background-color: #f8f9fa;
      border-left: 4px solid #28a745;
      padding: 15px;
      border-radius: 5px;
    }

    .treatment-header {
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
    }

    .treatment-content {
      color: #6c757d;
      line-height: 1.5;
    }

    .danger-signs-section {
      margin-top: 20px;
      border-top: 1px solid #dee2e6;
      padding-top: 15px;
    }

    .danger-signs-item {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
    }

    .danger-signs-header {
      font-weight: 600;
      color: #856404;
      margin-bottom: 8px;
    }

    .danger-signs-content {
      color: #856404;
      line-height: 1.5;
    }

    .danger-signs-list {
      list-style-type: none;
      padding-left: 0;
    }

    .danger-signs-list li {
      padding: 5px 0;
      border-bottom: 1px solid #ffeaa7;
    }

    .danger-signs-list li:last-child {
      border-bottom: none;
    }

    .summary-section {
      margin-top: 20px;
      border-top: 1px solid #dee2e6;
      padding-top: 15px;
    }

    .summary-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #495057;
    }

    .recommendations {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 5px;
      padding: 10px;
      margin-top: 15px;
    }

    .print-info {
      text-align: center;
      margin-top: 20px;
      font-size: 10px;
      color: #666;
    }

    .loading {
      text-align: center;
      padding: 50px;
    }

    .btn-group {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .compact-table {
      font-size: 10px;
    }

    .compact-table th {
      font-size: 9px;
      padding: 2px;
    }

    .compact-table td {
      padding: 2px;
      font-size: 9px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 50px;
      text-align: center;
    }
    
    .compact-table td:first-child {
      max-width: 30px;
    }
    
    .compact-table td:nth-child(2) {
      max-width: 70px;
    }
    
    .compact-table td:nth-child(3) {
      max-width: 80px;
    }

    .compact-table .visit-number {
      font-weight: bold;
      background: #f8f9fa;
    }

    .header-logo {
      width: 50px;
      height: 50px;
      margin-bottom: 10px;
    }

    .clinic-info {
      margin-bottom: 15px;
      text-align: center;
      font-size: 12px;
    }

    .patient-summary {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .summary-card {
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
      background: #f8f9fa;
    }

    .summary-card h6 {
      margin-bottom: 5px;
      font-size: 12px;
      color: #495057;
    }

    .summary-value {
      font-size: 14px;
      font-weight: bold;
      color: #007bff;
    }
  </style>
</head>
<body>
  <!-- Print/Close Buttons -->
  <div class="btn-group no-print">
    <button class="btn btn-primary btn-sm" onclick="window.print()">
      <i class="fas fa-print me-1"></i>Print Report
    </button>
    <button class="btn btn-secondary btn-sm" onclick="window.close()">
      <i class="fas fa-times me-1"></i>Close
    </button>
  </div>

  <div class="report-container">
    <!-- Loading State -->
    <div id="loadingState" class="loading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading antenatal care report...</p>
    </div>

    <!-- Report Content -->
    <div id="reportContent" style="display: none;">
      <!-- Header -->
      <div class="report-header">
        <div class="clinic-info">
          <strong>Maternal & Child Health Care System</strong><br>
          <small>Antenatal Care Record</small>
        </div>
        <div class="report-title">Antenatal Care Summary Report</div>
        <div class="report-subtitle">Complete Antenatal Visit History</div>
      </div>

      <!-- Patient Information -->
      <div class="patient-info">
        <h5><i class="fas fa-user me-2"></i>Patient Information</h5>
        <div class="patient-summary">
          <div class="summary-card">
            <h6>Patient Details</h6>
            <div><strong>Name:</strong> <span id="patientName">-</span></div>
            <div><strong>Age:</strong> <span id="patientAge">-</span></div>
            <div><strong>Parity:</strong> <span id="patientParity">-</span></div>
          </div>
          <div class="summary-card">
            <h6>Pregnancy Details</h6>
            <div><strong>LMP:</strong> <span id="patientLMP">-</span></div>
            <div><strong>EDD:</strong> <span id="patientEDD">-</span></div>
            <div><strong>Current GA:</strong> <span id="currentGA">-</span></div>
          </div>
          <div class="summary-card">
            <h6>Contact Information</h6>
            <div><strong>Phone:</strong> <span id="patientPhone">-</span></div>
            <div><strong>Early ANC Visits:</strong> <span id="earlyAncVisits" class="summary-value">0</span></div>
            <div><strong>Total Visits:</strong> <span id="totalVisits" class="summary-value">0</span></div>
          </div>
        </div>
      </div>

      <!-- Visits Table - Compact Design -->
      <table class="visits-table compact-table">
        <thead>
          <tr>
            <th>No</th>
            <th>Date</th>
            <th>Weight</th>
            <th>BP</th>
            <th>GA</th>
            <th>FH</th>
            <th>Fetal Pres</th>
            <th>FHR</th>
            <th>Urine</th>
            <th>Deworm</th>
            <th>IFA</th>
            <th>TT/TD</th>
            <th>Follow-up</th>
            <th>Referral</th>
            <th>Initial</th>
          </tr>
        </thead>
        <tbody id="visitsTableBody">
          <!-- Visits will be populated here -->
        </tbody>
      </table>

      <!-- Treatment Information Section -->
      <div class="treatment-section mt-4">
        <h5><i class="fas fa-pills me-2"></i>Treatment Information</h5>
        <div id="treatmentInfo" class="treatment-info">
          <!-- Treatment information will be populated here -->
        </div>
      </div>

      <!-- Danger Signs Section -->
      <div class="danger-signs-section mt-4">
        <h5><i class="fas fa-exclamation-triangle me-2"></i>Danger Signs Assessment</h5>
        <div id="dangerSignsInfo" class="danger-signs-info">
          <!-- Danger signs information will be populated here -->
        </div>
      </div>

      <!-- Visit Statistics Section -->
      <div class="summary-section">
        <div class="summary-title">Visit Statistics</div>
        <div class="row">
          <div class="col-md-12">
            <h6>Visit Statistics:</h6>
            <p><strong>First Visit:</strong> <span id="firstVisitDate">-</span></p>
            <p><strong>Last Visit:</strong> <span id="lastVisitDate">-</span></p>
            <p><strong>Average Visit Interval:</strong> <span id="averageInterval">-</span></p>
          </div>
        </div>
      </div>

      <!-- Recommendations -->
      <div class="recommendations">
        <h6><i class="fas fa-lightbulb me-2"></i>Clinical Recommendations</h6>
        <div id="recommendationsContent">
          <ul>
            <li>Continue regular antenatal visits as scheduled</li>
            <li>Maintain proper nutrition and iron supplementation</li>
            <li>Monitor fetal movements and report any concerns</li>
            <li>Prepare for delivery and emergency planning</li>
          </ul>
        </div>
      </div>

      <!-- Print Information -->
      <div class="print-info">
        <hr>
        <p><strong>Report Generated:</strong> <span id="reportDate"></span> | 
           <strong>Generated by:</strong> <span id="generatedBy">System</span></p>
        <p><small>This report contains confidential medical information. Handle with care.</small></p>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let currentPatient = null;
    let patientId = null;
    let antenatalVisits = [];

    // Get patient ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    patientId = urlParams.get('patient');

    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        alert("Please log in to view this report.");
        window.close();
      } else {
        currentUser = user;
        if (patientId) {
          loadReportData();
        } else {
          alert("No patient ID provided.");
          window.close();
        }
      }
    });

    async function loadReportData() {
      try {
        // Load patient data
        const patientDoc = await db.collection("patients").doc(patientId).get();
        if (!patientDoc.exists) {
          alert("Patient not found!");
          window.close();
          return;
        }
        
        currentPatient = patientDoc.data();
        
        // Load antenatal visits - try visitDate first, fallback to timestamp
        let visitsSnapshot;
        try {
          visitsSnapshot = await db.collection("patients")
            .doc(patientId)
            .collection("antenatal_visits")
            .orderBy("visitDate", "asc")
            .get();
        } catch (error) {
          // Fallback to timestamp if visitDate ordering fails
          console.log("visitDate ordering failed, using timestamp:", error);
          visitsSnapshot = await db.collection("patients")
            .doc(patientId)
            .collection("antenatal_visits")
            .orderBy("timestamp", "asc")
            .get();
        }

        antenatalVisits = [];
        visitsSnapshot.forEach(doc => {
          antenatalVisits.push({
            id: doc.id,
            ...doc.data()
          });
        });

        // Populate report
        populatePatientInfo();
        populateVisitsTable();
        populateSummary();
        
        // Show report and hide loading
        document.getElementById("loadingState").style.display = "none";
        document.getElementById("reportContent").style.display = "block";
        
        // Set report generation info
        document.getElementById("reportDate").textContent = new Date().toLocaleString();
        document.getElementById("generatedBy").textContent = currentUser.email;

      } catch (error) {
        console.error("Error loading report data:", error);
        alert("Error loading report data: " + error.message);
        window.close();
      }
    }

    function populatePatientInfo() {
      document.getElementById("patientName").textContent = currentPatient.name || 'Unknown';
      document.getElementById("patientAge").textContent = currentPatient.age || 'N/A';
      document.getElementById("patientParity").textContent = currentPatient.parity || 'N/A';
      document.getElementById("patientLMP").textContent = currentPatient.lmp || 'Not recorded';
      document.getElementById("patientEDD").textContent = currentPatient.edd || 'Not calculated';
      document.getElementById("patientPhone").textContent = currentPatient.phone || 'Not provided';
      // Calculate early ANC visits
      const earlyAncVisits = currentPatient.early_anc_number || 0;
      document.getElementById("earlyAncVisits").textContent = earlyAncVisits;
      
      // Total visits = early ANC visits + recorded visits (only count visits with actual data)
      // More robust filtering to handle corrupted data
      const actualVisits = antenatalVisits.filter(visit => {
        // Must have a valid visit date
        if (!visit.visitDate || visit.visitDate.trim() === '') return false;
        
        // Must have a valid visit number
        if (!visit.visitNumber || visit.visitNumber <= 0) return false;
        
        // Must have some actual medical data (not just empty records)
        const hasMedicalData = visit.weight || visit.bloodPressure || visit.gestationalAge || 
                              visit.fundalHeight || visit.fetalPresentation || visit.fetalHeartRate;
        
        return hasMedicalData;
      });
      
      // Remove duplicates based on visit date and number
      const uniqueVisits = [];
      const seenVisits = new Set();
      
      actualVisits.forEach(visit => {
        const key = `${visit.visitDate}-${visit.visitNumber}`;
        if (!seenVisits.has(key)) {
          seenVisits.add(key);
          uniqueVisits.push(visit);
        }
      });
      
      const totalVisits = earlyAncVisits + uniqueVisits.length;
      
      // Debug logging - more detailed
      console.log('=== VISIT COUNT DEBUG ===');
      console.log('Early ANC visits:', earlyAncVisits);
      console.log('All visits count:', antenatalVisits.length);
      console.log('Actual visits count (after filtering):', actualVisits.length);
      console.log('Unique visits count (after deduplication):', uniqueVisits.length);
      console.log('Total visits (final):', totalVisits);
      console.log('All visits data:', antenatalVisits);
      console.log('Actual visits data (filtered):', actualVisits);
      console.log('Unique visits data (deduplicated):', uniqueVisits);
      
      // Check for duplicates or issues
      const visitDates = antenatalVisits.map(v => v.visitDate);
      const uniqueDates = [...new Set(visitDates)];
      console.log('Unique visit dates:', uniqueDates);
      console.log('Duplicate dates found:', visitDates.length !== uniqueDates.length);
      
      // Show what was filtered out
      const filteredOut = antenatalVisits.filter(visit => {
        if (!visit.visitDate || visit.visitDate.trim() === '') return true;
        if (!visit.visitNumber || visit.visitNumber <= 0) return true;
        const hasMedicalData = visit.weight || visit.bloodPressure || visit.gestationalAge || 
                              visit.fundalHeight || visit.fetalPresentation || visit.fetalHeartRate;
        return !hasMedicalData;
      });
      console.log('Filtered out visits (corrupted/empty):', filteredOut.length, filteredOut);
      
      document.getElementById("totalVisits").textContent = totalVisits;
      
      // Calculate current gestational age
      if (currentPatient.lmp) {
        const lmpDate = new Date(currentPatient.lmp);
        const today = new Date();
        const diffTime = today - lmpDate;
        const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
        const diffDays = Math.floor((diffTime % (1000 * 60 * 60 * 24 * 7)) / (1000 * 60 * 60 * 24));
        document.getElementById("currentGA").textContent = `${diffWeeks}w ${diffDays}d`;
      } else {
        document.getElementById("currentGA").textContent = 'Not calculated';
      }
    }

    function populateVisitsTable() {
      const tableBody = document.getElementById("visitsTableBody");
      
      if (antenatalVisits.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="16" class="text-center">No antenatal visits recorded</td>
          </tr>
        `;
        return;
      }

      // Use the filtered and deduplicated visits for the table
      const visitsToShow = uniqueVisits.length > 0 ? uniqueVisits : antenatalVisits;
      
      let tableHTML = '';
      visitsToShow.forEach((visit, index) => {
        const visitNumber = index + 1; // Sequential numbering
        const visitDate = visit.visitDate ? 
          new Date(visit.visitDate).toLocaleDateString() : 
          'N/A';
        
        // Format danger signs if present
        let dangerSignsText = '';
        if (visit.dangerSignsPresent === 'Yes' && visit.dangerSigns) {
          const dangerSignsList = [];
          if (visit.dangerSigns.vaginal_bleeding) dangerSignsList.push('Vaginal bleeding');
          if (visit.dangerSigns.convulsions) dangerSignsList.push('Convulsions');
          if (visit.dangerSigns.loss_consciousness) dangerSignsList.push('Loss of consciousness');
          if (visit.dangerSigns.severe_headache) dangerSignsList.push('Severe headache');
          if (visit.dangerSigns.blurred_vision) dangerSignsList.push('Blurred vision');
          if (visit.dangerSigns.vomiting) dangerSignsList.push('Vomiting');
          if (visit.dangerSigns.severe_abdominal_pain) dangerSignsList.push('Severe abdominal pain');
          if (visit.dangerSigns.fever) dangerSignsList.push('Fever');
          if (visit.dangerSigns.fatigue) dangerSignsList.push('Fatigue');
          if (visit.dangerSigns.fast_breathing) dangerSignsList.push('Fast breathing');
          if (visit.dangerSigns.difficulty_breathing) dangerSignsList.push('Difficulty in breathing');
          if (visit.dangerSigns.puffiness) dangerSignsList.push('Puffiness of face, hands and leg');
          if (visit.dangerSigns.oliguria) dangerSignsList.push('Oliguria');
          if (visit.dangerSigns.excessive_vomiting) dangerSignsList.push('Excessive vomiting');
          if (visit.dangerSigns.abdominal_pain) dangerSignsList.push('Abdominal pain');
          if (visit.dangerSigns.reduced_fetal_movement) dangerSignsList.push('Reduced/absent fetal movement');
          if (visit.dangerSigns.no_labour_pain) dangerSignsList.push('No labor pain after 6 hours of membrane rupture');
          if (visit.dangerSigns.no_delivery) dangerSignsList.push('No delivery until 12 hours of labour pain');
          if (visit.dangerSigns.postpartum_hemorrhage) dangerSignsList.push('Postpartum hemorrhage after birth');
          if (visit.dangerSigns.no_placenta) dangerSignsList.push('No placenta delivery until 1 hour after child birth');
          if (visit.dangerSigns.very_small_baby) dangerSignsList.push('Very small babies (<1500gm/1.5kg)');
          if (visit.dangerSigns.difficulty_breathing_baby) dangerSignsList.push('Difficulty in breathing (baby)');
          dangerSignsText = dangerSignsList.join(', ') || 'Present';
        } else if (visit.dangerSignsPresent === 'No') {
          dangerSignsText = 'None';
        }
        
        tableHTML += `
          <tr>
            <td class="visit-number">${visitNumber}</td>
            <td>${visitDate}</td>
            <td>${visit.weight || '-'}</td>
            <td>${visit.bloodPressure || '-'}</td>
            <td>${visit.gestationalAge || visit.gestationWeeks || '-'}</td>
            <td>${visit.fundalHeight || '-'}</td>
            <td>${visit.fetalPresentation || '-'}</td>
            <td>${visit.fetalHeartRate || '-'}</td>
            <td>${visit.urineTest || '-'}</td>
            <td>${visit.deworming || '-'}</td>
            <td>${visit.ironFolicAcid || '-'}</td>
            <td>${visit.tetanusToxoid || '-'}</td>
            <td>${visit.followUpDate ? new Date(visit.followUpDate).toLocaleDateString() : (visit.nextAppointment ? new Date(visit.nextAppointment).toLocaleDateString() : '-')}</td>
            <td>${visit.referral || '-'}</td>
            <td>${visit.initial || '-'}</td>
          </tr>
        `;
      });

      // Always show all 12 rows for the report
      for (let i = visitsToShow.length; i < 12; i++) {
        tableHTML += `
          <tr>
            <td class="visit-number">${i + 1}</td>
            <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
            <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
            <td>-</td><td>-</td>
          </tr>
        `;
      }

      tableBody.innerHTML = tableHTML;
      
      // Populate treatment information
      populateTreatmentInfo();
      
      // Populate danger signs information
      populateDangerSignsInfo();
    }

    function populateTreatmentInfo() {
      const treatmentContainer = document.getElementById('treatmentInfo');
      
      if (antenatalVisits.length === 0) {
        treatmentContainer.innerHTML = '<p class="text-muted">No treatment information recorded.</p>';
        return;
      }

      let treatmentHTML = '';
      antenatalVisits.forEach((visit, index) => {
        const visitNumber = index + 1;
        const visitDate = visit.visitDate ? 
          new Date(visit.visitDate).toLocaleDateString() : 
          'N/A';
        
        if (visit.treatmentGiven && visit.treatmentGiven.trim() !== '') {
          treatmentHTML += `
            <div class="treatment-item mb-3">
              <div class="treatment-header">
                <strong>Visit ${visitNumber}</strong> - ${visitDate}
              </div>
              <div class="treatment-content">
                ${visit.treatmentGiven}
              </div>
            </div>
          `;
        }
      });

      if (treatmentHTML === '') {
        treatmentHTML = '<p class="text-muted">No specific treatments recorded.</p>';
      }

      treatmentContainer.innerHTML = treatmentHTML;
    }

    function populateDangerSignsInfo() {
      const dangerSignsContainer = document.getElementById('dangerSignsInfo');
      
      if (antenatalVisits.length === 0) {
        dangerSignsContainer.innerHTML = '<p class="text-muted">No danger signs assessments recorded.</p>';
        return;
      }

      let dangerSignsHTML = '';
      antenatalVisits.forEach((visit, index) => {
        const visitNumber = index + 1;
        const visitDate = visit.visitDate ? 
          new Date(visit.visitDate).toLocaleDateString() : 
          'N/A';
        
        if (visit.dangerSignsPresent === 'Yes' && visit.dangerSigns) {
          const dangerSignsList = [];
          if (visit.dangerSigns.vaginal_bleeding) dangerSignsList.push('Vaginal bleeding');
          if (visit.dangerSigns.convulsions) dangerSignsList.push('Convulsions');
          if (visit.dangerSigns.loss_consciousness) dangerSignsList.push('Loss of consciousness');
          if (visit.dangerSigns.severe_headache) dangerSignsList.push('Severe headache');
          if (visit.dangerSigns.blurred_vision) dangerSignsList.push('Blurred vision');
          if (visit.dangerSigns.vomiting) dangerSignsList.push('Vomiting');
          if (visit.dangerSigns.severe_abdominal_pain) dangerSignsList.push('Severe abdominal pain');
          if (visit.dangerSigns.fever) dangerSignsList.push('Fever');
          if (visit.dangerSigns.fatigue) dangerSignsList.push('Fatigue');
          if (visit.dangerSigns.fast_breathing) dangerSignsList.push('Fast breathing');
          if (visit.dangerSigns.difficulty_breathing) dangerSignsList.push('Difficulty in breathing');
          if (visit.dangerSigns.puffiness) dangerSignsList.push('Puffiness of face, hands and leg');
          if (visit.dangerSigns.oliguria) dangerSignsList.push('Oliguria');
          if (visit.dangerSigns.excessive_vomiting) dangerSignsList.push('Excessive vomiting');
          if (visit.dangerSigns.abdominal_pain) dangerSignsList.push('Abdominal pain');
          if (visit.dangerSigns.reduced_fetal_movement) dangerSignsList.push('Reduced/absent fetal movement');
          if (visit.dangerSigns.no_labour_pain) dangerSignsList.push('No labor pain after 6 hours of membrane rupture');
          if (visit.dangerSigns.no_delivery) dangerSignsList.push('No delivery until 12 hours of labour pain');
          if (visit.dangerSigns.postpartum_hemorrhage) dangerSignsList.push('Postpartum hemorrhage after birth');
          if (visit.dangerSigns.no_placenta) dangerSignsList.push('No placenta delivery until 1 hour after child birth');
          if (visit.dangerSigns.very_small_baby) dangerSignsList.push('Very small babies (<1500gm/1.5kg)');
          if (visit.dangerSigns.difficulty_breathing_baby) dangerSignsList.push('Difficulty in breathing (baby)');
          
          if (dangerSignsList.length > 0) {
            dangerSignsHTML += `
              <div class="danger-signs-item">
                <div class="danger-signs-header">
                  <strong>Visit ${visitNumber}</strong> - ${visitDate}
                </div>
                <div class="danger-signs-content">
                  <ul class="danger-signs-list">
                    ${dangerSignsList.map(sign => `<li>${sign}</li>`).join('')}
                  </ul>
                </div>
              </div>
            `;
          }
        } else if (visit.dangerSignsPresent === 'No') {
          dangerSignsHTML += `
            <div class="danger-signs-item">
              <div class="danger-signs-header">
                <strong>Visit ${visitNumber}</strong> - ${visitDate}
              </div>
              <div class="danger-signs-content">
                No danger signs present
              </div>
            </div>
          `;
        }
      });

      if (dangerSignsHTML === '') {
        dangerSignsHTML = '<p class="text-muted">No danger signs assessments recorded.</p>';
      }

      dangerSignsContainer.innerHTML = dangerSignsHTML;
    }

    function populateSummary() {
      // Visit statistics only
      if (antenatalVisits.length > 0) {
        const firstVisit = new Date(antenatalVisits[0].visitDate);
        const lastVisit = new Date(antenatalVisits[antenatalVisits.length - 1].visitDate);
        
        document.getElementById("firstVisitDate").textContent = firstVisit.toLocaleDateString();
        document.getElementById("lastVisitDate").textContent = lastVisit.toLocaleDateString();
        
        // Calculate average interval
        if (antenatalVisits.length > 1) {
          const totalDays = (lastVisit - firstVisit) / (1000 * 60 * 60 * 24);
          const averageDays = Math.round(totalDays / (antenatalVisits.length - 1));
          document.getElementById("averageInterval").textContent = `${averageDays} days`;
        } else {
          document.getElementById("averageInterval").textContent = 'N/A (Single visit)';
        }
      } else {
        document.getElementById("firstVisitDate").textContent = 'No visits recorded';
        document.getElementById("lastVisitDate").textContent = 'No visits recorded';
        document.getElementById("averageInterval").textContent = 'N/A';
      }

      // Generate dynamic recommendations based on data
      generateRecommendations();
    }

    function generateRecommendations() {
      const recommendations = [];
      
      // Get clinical notes from visits
      antenatalVisits.forEach((visit, index) => {
        const visitNumber = index + 1;
        const visitDate = visit.visitDate ? 
          new Date(visit.visitDate).toLocaleDateString() : 
          'N/A';
        
        if (visit.clinicalNotes && visit.clinicalNotes.trim() !== '') {
          recommendations.push(`<strong>Visit ${visitNumber} (${visitDate}):</strong> ${visit.clinicalNotes}`);
        }
      });
      
      // If no clinical notes found, show default message
      if (recommendations.length === 0) {
        recommendations.push("No specific clinical recommendations recorded");
      }
      
      // Update recommendations content
      const recommendationsHTML = recommendations.map(rec => `<li>${rec}</li>`).join('');
      document.getElementById("recommendationsContent").innerHTML = `<ul>${recommendationsHTML}</ul>`;
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>
</html>
