<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Antenatal Care Report</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="js/firebase.js"></script>
  <style>
    @media print {
      body { margin: 0; }
      .no-print { display: none !important; }
      .page-break { page-break-before: always; }
    }

    body {
      font-family: 'Arial', sans-serif;
      font-size: 12px;
      line-height: 1.2;
      background: white;
      color: black;
    }

    .report-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: white;
    }

    .report-header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #000;
      padding-bottom: 15px;
    }

    .report-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .report-subtitle {
      font-size: 14px;
      color: #666;
    }

    .patient-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .patient-info h5 {
      margin-bottom: 10px;
      color: #495057;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 5px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .info-label {
      font-weight: bold;
      min-width: 120px;
    }

    .visits-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 11px;
    }

    .visits-table th,
    .visits-table td {
      border: 1px solid #000;
      padding: 4px;
      text-align: center;
      vertical-align: middle;
    }

    .visits-table th {
      background-color: #e9ecef;
      font-weight: bold;
      font-size: 10px;
    }

    .visits-table .visit-number {
      background-color: #f8f9fa;
      font-weight: bold;
    }

    .summary-section {
      margin-top: 20px;
      border-top: 1px solid #dee2e6;
      padding-top: 15px;
    }

    .summary-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #495057;
    }

    .recommendations {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 5px;
      padding: 10px;
      margin-top: 15px;
    }

    .print-info {
      text-align: center;
      margin-top: 20px;
      font-size: 10px;
      color: #666;
    }

    .loading {
      text-align: center;
      padding: 50px;
    }

    .btn-group {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .compact-table {
      font-size: 10px;
    }

    .compact-table th {
      font-size: 9px;
      padding: 2px;
    }

    .compact-table td {
      padding: 2px;
      font-size: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 60px;
    }

    .compact-table .visit-number {
      font-weight: bold;
      background: #f8f9fa;
    }

    .header-logo {
      width: 50px;
      height: 50px;
      margin-bottom: 10px;
    }

    .clinic-info {
      margin-bottom: 15px;
      text-align: center;
      font-size: 12px;
    }

    .patient-summary {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .summary-card {
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
      background: #f8f9fa;
    }

    .summary-card h6 {
      margin-bottom: 5px;
      font-size: 12px;
      color: #495057;
    }

    .summary-value {
      font-size: 14px;
      font-weight: bold;
      color: #007bff;
    }
  </style>
</head>
<body>
  <!-- Print/Close Buttons -->
  <div class="btn-group no-print">
    <button class="btn btn-primary btn-sm" onclick="window.print()">
      <i class="fas fa-print me-1"></i>Print Report
    </button>
    <button class="btn btn-secondary btn-sm" onclick="window.close()">
      <i class="fas fa-times me-1"></i>Close
    </button>
  </div>

  <div class="report-container">
    <!-- Loading State -->
    <div id="loadingState" class="loading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading antenatal care report...</p>
    </div>

    <!-- Report Content -->
    <div id="reportContent" style="display: none;">
      <!-- Header -->
      <div class="report-header">
        <div class="clinic-info">
          <strong>Maternal & Child Health Care System</strong><br>
          <small>Antenatal Care Record</small>
        </div>
        <div class="report-title">Antenatal Care Summary Report</div>
        <div class="report-subtitle">Complete Antenatal Visit History</div>
      </div>

      <!-- Patient Information -->
      <div class="patient-info">
        <h5><i class="fas fa-user me-2"></i>Patient Information</h5>
        <div class="patient-summary">
          <div class="summary-card">
            <h6>Patient Details</h6>
            <div><strong>Name:</strong> <span id="patientName">-</span></div>
            <div><strong>Age:</strong> <span id="patientAge">-</span></div>
            <div><strong>Parity:</strong> <span id="patientParity">-</span></div>
          </div>
          <div class="summary-card">
            <h6>Pregnancy Details</h6>
            <div><strong>LMP:</strong> <span id="patientLMP">-</span></div>
            <div><strong>EDD:</strong> <span id="patientEDD">-</span></div>
            <div><strong>Current GA:</strong> <span id="currentGA">-</span></div>
          </div>
          <div class="summary-card">
            <h6>Contact Information</h6>
            <div><strong>Phone:</strong> <span id="patientPhone">-</span></div>
            <div><strong>Township:</strong> <span id="patientTownship">-</span></div>
            <div><strong>Total Visits:</strong> <span id="totalVisits" class="summary-value">0</span></div>
          </div>
        </div>
      </div>

      <!-- Visits Table - Compact Design -->
      <table class="visits-table compact-table">
        <thead>
          <tr>
            <th>Visit</th>
            <th>Date</th>
            <th>GA</th>
            <th>Weight</th>
            <th>BP</th>
            <th>FH</th>
            <th>FHR</th>
            <th>Urine</th>
            <th>IFA</th>
            <th>TT/TD</th>
            <th>Follow-up</th>
            <th>Danger Signs</th>
            <th>Initial</th>
          </tr>
        </thead>
        <tbody id="visitsTableBody">
          <!-- Visits will be populated here -->
        </tbody>
      </table>

      <!-- Summary Section -->
      <div class="summary-section">
        <div class="summary-title">Clinical Summary</div>
        <div class="row">
          <div class="col-md-6">
            <h6>Risk Factors:</h6>
            <p id="riskFactors">None recorded</p>
            
            <h6>Labour Information:</h6>
            <p><strong>Onset:</strong> <span id="labourOnset">-</span></p>
            <p><strong>Membranes:</strong> <span id="rupturedMembranes">-</span></p>
            
            <h6>Danger Signs:</h6>
            <p><strong>Recorded:</strong> <span id="dangerSignsSummary">-</span></p>
            <p><strong>TT/TD Completion:</strong> <span id="ttTdCompletionStatus">-</span></p>
          </div>
          <div class="col-md-6">
            <h6>Visit Statistics:</h6>
            <p><strong>First Visit:</strong> <span id="firstVisitDate">-</span></p>
            <p><strong>Last Visit:</strong> <span id="lastVisitDate">-</span></p>
            <p><strong>Average Visit Interval:</strong> <span id="averageInterval">-</span></p>
          </div>
        </div>
      </div>

      <!-- Recommendations -->
      <div class="recommendations">
        <h6><i class="fas fa-lightbulb me-2"></i>Clinical Recommendations</h6>
        <div id="recommendationsContent">
          <ul>
            <li>Continue regular antenatal visits as scheduled</li>
            <li>Maintain proper nutrition and iron supplementation</li>
            <li>Monitor fetal movements and report any concerns</li>
            <li>Prepare for delivery and emergency planning</li>
          </ul>
        </div>
      </div>

      <!-- Print Information -->
      <div class="print-info">
        <hr>
        <p><strong>Report Generated:</strong> <span id="reportDate"></span> | 
           <strong>Generated by:</strong> <span id="generatedBy">System</span></p>
        <p><small>This report contains confidential medical information. Handle with care.</small></p>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let currentPatient = null;
    let patientId = null;
    let antenatalVisits = [];

    // Get patient ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    patientId = urlParams.get('patient');

    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        alert("Please log in to view this report.");
        window.close();
      } else {
        currentUser = user;
        if (patientId) {
          loadReportData();
        } else {
          alert("No patient ID provided.");
          window.close();
        }
      }
    });

    async function loadReportData() {
      try {
        // Load patient data
        const patientDoc = await db.collection("patients").doc(patientId).get();
        if (!patientDoc.exists) {
          alert("Patient not found!");
          window.close();
          return;
        }
        
        currentPatient = patientDoc.data();
        
        // Load antenatal visits
        const visitsSnapshot = await db.collection("patients")
          .doc(patientId)
          .collection("antenatal_visits")
          .orderBy("visit_date", "asc")
          .get();

        antenatalVisits = [];
        visitsSnapshot.forEach(doc => {
          antenatalVisits.push({
            id: doc.id,
            ...doc.data()
          });
        });

        // Populate report
        populatePatientInfo();
        populateVisitsTable();
        populateSummary();
        
        // Show report and hide loading
        document.getElementById("loadingState").style.display = "none";
        document.getElementById("reportContent").style.display = "block";
        
        // Set report generation info
        document.getElementById("reportDate").textContent = new Date().toLocaleString();
        document.getElementById("generatedBy").textContent = currentUser.email;

      } catch (error) {
        console.error("Error loading report data:", error);
        alert("Error loading report data: " + error.message);
        window.close();
      }
    }

    function populatePatientInfo() {
      document.getElementById("patientName").textContent = currentPatient.name || 'Unknown';
      document.getElementById("patientAge").textContent = currentPatient.age || 'N/A';
      document.getElementById("patientParity").textContent = currentPatient.parity || 'N/A';
      document.getElementById("patientLMP").textContent = currentPatient.lmp || 'Not recorded';
      document.getElementById("patientEDD").textContent = currentPatient.edd || 'Not calculated';
      document.getElementById("patientPhone").textContent = currentPatient.phone || 'Not provided';
      document.getElementById("patientTownship").textContent = currentPatient.township || 'Not set';
      document.getElementById("totalVisits").textContent = antenatalVisits.length;
      
      // Calculate current gestational age
      if (currentPatient.lmp) {
        const lmpDate = new Date(currentPatient.lmp);
        const today = new Date();
        const diffTime = today - lmpDate;
        const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
        const diffDays = Math.floor((diffTime % (1000 * 60 * 60 * 24 * 7)) / (1000 * 60 * 60 * 24));
        document.getElementById("currentGA").textContent = `${diffWeeks}w ${diffDays}d`;
      } else {
        document.getElementById("currentGA").textContent = 'Not calculated';
      }
    }

    function populateVisitsTable() {
      const tableBody = document.getElementById("visitsTableBody");
      
      if (antenatalVisits.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="13" class="text-center">No antenatal visits recorded</td>
          </tr>
        `;
        return;
      }

      let tableHTML = '';
      antenatalVisits.forEach((visit, index) => {
        const visitDate = visit.visit_date ? 
          new Date(visit.visit_date.seconds * 1000).toLocaleDateString() : 
          visit.visitDate || 'N/A';
        
        // Format danger signs if present
        let dangerSignsText = '';
        if (visit.dangerSignsPresent === 'Yes' && visit.dangerSigns) {
          const dangerSignsList = [];
          if (visit.dangerSigns.vaginal_bleeding) dangerSignsList.push('Vaginal bleeding');
          if (visit.dangerSigns.convulsions) dangerSignsList.push('Convulsions');
          if (visit.dangerSigns.severe_headache) dangerSignsList.push('Severe headache');
          if (visit.dangerSigns.blurred_vision) dangerSignsList.push('Blurred vision');
          if (visit.dangerSigns.severe_abdominal_pain) dangerSignsList.push('Severe abdominal pain');
          if (visit.dangerSigns.fever) dangerSignsList.push('Fever');
          if (visit.dangerSigns.puffiness) dangerSignsList.push('Puffiness');
          if (visit.dangerSigns.reduced_fetal_movement) dangerSignsList.push('Reduced fetal movement');
          dangerSignsText = dangerSignsList.join(', ') || 'Present';
        } else if (visit.dangerSignsPresent === 'No') {
          dangerSignsText = 'None';
        }
        
        tableHTML += `
          <tr>
            <td class="visit-number">${visit.visitNumber || index + 1}</td>
            <td>${visitDate}</td>
            <td>${visit.gestationalAge || visit.gestationWeeks || '-'}</td>
            <td>${visit.weight || '-'}</td>
            <td>${visit.bloodPressure || '-'}</td>
            <td>${visit.fundalHeight || '-'}</td>
            <td>${visit.fetalHeartRate || '-'}</td>
            <td>${visit.urineTest || '-'}</td>
            <td>${visit.ironFolicAcid || '-'}</td>
            <td>${visit.tetanusToxoid || '-'}</td>
            <td>${visit.followUpDate ? new Date(visit.followUpDate).toLocaleDateString() : (visit.nextAppointment ? new Date(visit.nextAppointment).toLocaleDateString() : '-')}</td>
            <td>${dangerSignsText}</td>
            <td>${visit.midwifeName || '-'}</td>
          </tr>
        `;
      });

      // Add empty rows to make it look more like a form (up to 12 rows total)
      const emptyRowsNeeded = Math.max(0, 12 - antenatalVisits.length);
      for (let i = 0; i < emptyRowsNeeded; i++) {
        tableHTML += `
          <tr>
            <td class="visit-number">${antenatalVisits.length + i + 1}</td>
            <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
            <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
          </tr>
        `;
      }

      tableBody.innerHTML = tableHTML;
    }

    function populateSummary() {
      // Risk factors
      document.getElementById("riskFactors").textContent = 
        currentPatient.risk_factors || 'None recorded';
      
      // Labour information
      document.getElementById("labourOnset").textContent = 
        currentPatient.labour_onset || 'Not specified';
      document.getElementById("rupturedMembranes").textContent = 
        currentPatient.ruptured_membrane || 'Not recorded';
      
      // Danger signs summary
      let dangerSignsCount = 0;
      let ttTdCompletion = 'Not recorded';
      
      antenatalVisits.forEach(visit => {
        if (visit.dangerSignsPresent === 'Yes') {
          dangerSignsCount++;
        }
        if (visit.ttTdCompletion) {
          ttTdCompletion = visit.ttTdCompletion;
        }
      });
      
      document.getElementById("dangerSignsSummary").textContent = 
        dangerSignsCount > 0 ? `${dangerSignsCount} visits with danger signs` : 'No danger signs recorded';
      document.getElementById("ttTdCompletionStatus").textContent = ttTdCompletion;
      
      // Visit statistics
      if (antenatalVisits.length > 0) {
        const firstVisit = new Date(antenatalVisits[0].visit_date.seconds * 1000);
        const lastVisit = new Date(antenatalVisits[antenatalVisits.length - 1].visit_date.seconds * 1000);
        
        document.getElementById("firstVisitDate").textContent = firstVisit.toLocaleDateString();
        document.getElementById("lastVisitDate").textContent = lastVisit.toLocaleDateString();
        
        // Calculate average interval
        if (antenatalVisits.length > 1) {
          const totalDays = (lastVisit - firstVisit) / (1000 * 60 * 60 * 24);
          const averageDays = Math.round(totalDays / (antenatalVisits.length - 1));
          document.getElementById("averageInterval").textContent = `${averageDays} days`;
        } else {
          document.getElementById("averageInterval").textContent = 'N/A (Single visit)';
        }
      } else {
        document.getElementById("firstVisitDate").textContent = 'No visits recorded';
        document.getElementById("lastVisitDate").textContent = 'No visits recorded';
        document.getElementById("averageInterval").textContent = 'N/A';
      }

      // Generate dynamic recommendations based on data
      generateRecommendations();
    }

    function generateRecommendations() {
      const recommendations = [];
      
      // Check visit frequency
      if (antenatalVisits.length < 4) {
        recommendations.push("Increase visit frequency - WHO recommends minimum 4 antenatal visits");
      }
      
      // Check for risk factors
      if (currentPatient.risk_factors && currentPatient.risk_factors.trim()) {
        recommendations.push("Monitor risk factors closely: " + currentPatient.risk_factors);
      }
      
      // Check gestational age
      if (currentPatient.lmp) {
        const lmpDate = new Date(currentPatient.lmp);
        const today = new Date();
        const gestationalWeeks = Math.floor((today - lmpDate) / (1000 * 60 * 60 * 24 * 7));
        
        if (gestationalWeeks > 36) {
          recommendations.push("Patient approaching term - prepare for delivery planning");
        } else if (gestationalWeeks > 28) {
          recommendations.push("Third trimester monitoring - increase visit frequency");
        }
      }
      
      // Check for recent visits
      if (antenatalVisits.length > 0) {
        const lastVisitDate = new Date(antenatalVisits[antenatalVisits.length - 1].visit_date.seconds * 1000);
        const daysSinceLastVisit = Math.floor((new Date() - lastVisitDate) / (1000 * 60 * 60 * 24));
        
        if (daysSinceLastVisit > 28) {
          recommendations.push("Schedule next visit soon - last visit was " + daysSinceLastVisit + " days ago");
        }
      }
      
      // Default recommendations
      if (recommendations.length === 0) {
        recommendations.push("Continue regular antenatal care as scheduled");
        recommendations.push("Maintain proper nutrition and iron supplementation");
        recommendations.push("Monitor fetal movements and report any concerns");
      }
      
      // Update recommendations content
      const recommendationsHTML = recommendations.map(rec => `<li>${rec}</li>`).join('');
      document.getElementById("recommendationsContent").innerHTML = `<ul>${recommendationsHTML}</ul>`;
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>
</html>
