
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Editable WHO Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <style>
    table { font-size: 0.85rem; border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; text-align: center; padding: 4px; min-width: 60px; }
    input { width: 100%; border: none; text-align: center; background: none; }
    input:focus { outline: 1px solid #007bff; background-color: #eef; }
    .header { background-color: #f0f0f0; font-weight: bold; }
    .label { text-align: left; background-color: #f9f9f9; font-weight: bold; padding-left: 6px; }
  </style>
</head>
<body class="container-fluid p-3">
  <h4>WHO Labour Summary Chart (Editable)</h4>
  <div id="patientInfo" class="mb-3 text-muted"></div>
  <div class="table-responsive">
    <form id="summaryForm">
      <table id="summaryTable">
        <thead>
          <tr>
            <th class="label">Time</th>
            <th>Pulse</th>
            <th>Temp</th>
            <th>BP</th>
            <th>FHR</th>
            <th>Contractions</th>
            <th>Cervix</th>
            <th>Descent</th>
            <th>Oxytocin</th>
            <th>Antibiotics</th>
            <th>Initials</th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
      </table>
      <button type="submit" class="btn btn-primary mt-3">ðŸ’¾ Save All</button>
    </form>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("patient");
    const times = ["01:00", "01:30", "02:00", "02:30", "03:00", "03:30", "04:00", "04:30", "05:00", "05:30"];
    const fields = ["pulse","temperature","bp","fhr","contractions","cervix","descent","oxytocin","antibiotics","initials"];
    const summaryBody = document.getElementById("summaryBody");

    async function loadData() {
      const pat = await db.collection("patients").doc(patientId).get();
      if (!pat.exists) return;
      const patient = pat.data();
      document.getElementById("patientInfo").innerText = `Patient: ${patient.name} | ID: ${patientId} | Age: ${patient.age}`;

      const snap = await db.collection("patients").doc(patientId).collection("records").get();
      const records = {};
      snap.forEach(doc => {
        const r = doc.data();
        const dt = new Date(r.timestamp);
        const hour = dt.getHours().toString().padStart(2, '0');
        const min = dt.getMinutes() < 30 ? "00" : "30";
        const time = `${hour}:${min}`;
        records[time] = { id: doc.id, ...r };
      });

      times.forEach(time => {
        const r = records[time] || {};
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="label">${time}</td>` + fields.map(f => `
          <td><input name="${time}_${f}" value="${r[f] || ''}" /></td>
        `).join('');
        summaryBody.appendChild(tr);
      });
    }

    document.getElementById("summaryForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const updates = {};

      for (let [key, val] of form.entries()) {
        const [time, field] = key.split("_");
        const ts = new Date();
        const [h, m] = time.split(":");
        ts.setHours(h);
        ts.setMinutes(m);
        const keyStr = time;
        if (!updates[keyStr]) {
          updates[keyStr] = { timestamp: ts.toISOString() };
        }
        updates[keyStr][field] = val;
      }

      for (let t in updates) {
        await db.collection("patients").doc(patientId).collection("records").add(updates[t]);
      }

      alert("âœ… Records saved!");
    });

    loadData();
  </script>
</body>
</html>
