
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WHO Labour Care Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-size: 0.85rem; }
    table { table-layout: fixed; border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; text-align: center; padding: 4px; }
    input { width: 100%; border: none; text-align: center; background: transparent; }
    input:focus { outline: 1px solid #007bff; background-color: #eef; }
    .section-header { background-color: #f1f1f1; font-weight: bold; text-align: left; padding-left: 5px; }
    .patient-info { background-color: #f9f9f9; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
  </style>
</head>
<body class="container-fluid p-3">
  <h4>WHO Labour Care Summary</h4>
  <div id="patientInfo" class="patient-info"></div>

  <form id="summaryForm">
    <div class="table-responsive">
      <table id="summaryTable">
        <thead>
          <tr>
            <th>Section</th>
            <th>01:00</th><th>02:00</th><th>03:00</th><th>04:00</th><th>05:00</th><th>06:00</th><th>07:00</th><th>08:00</th><th>09:00</th><th>10:00</th><th>11:00</th><th>12:00</th><th>2nd-1h</th><th>2nd-2h</th><th>2nd-3h</th>
          </tr>
        </thead>
        <tbody id="summaryBody">
        </tbody>
      </table>
    </div>
    <button type="submit" class="btn btn-primary mt-3">ðŸ’¾ Save</button>
  </form>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  <script>
    const sections = {
      "Supportive Care": ["Companion", "Pain relief", "Oral fluid", "Posture"],
      "Baby": ["Baseline FHR", "FHR deceleration", "Amniotic fluid", "Fetal position", "Caput", "Moulding"],
      "Woman": ["Pulse", "Systolic BP", "Diastolic BP", "Temperature", "Urine"],
      "Labour Progress - Cervix": ["0 cm", "1 cm", "2 cm", "3 cm", "4 cm", "5 cm"],
      "Labour Progress - Descent": ["0", "1", "2", "3", "4", "5"],
      "Medication": ["Oxytocin", "Medicine", "IV fluids"],
      "Shared Decision-Making": ["Assessment", "Plan"],
      "Initials": ["Initials"]
    };

    const columns = [...Array(12).keys()].map(h => ("0" + (h + 1)).slice(-2) + ":00")
                    .concat(["2nd-1h", "2nd-2h", "2nd-3h"]);

    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("patient");

    async function loadPatientInfo() {
      const doc = await db.collection("patients").doc(patientId).get();
      if (!doc.exists) return;
      const data = doc.data();
      const html = `
        <strong>Name:</strong> ${data.name || ""} |
        <strong>Age:</strong> ${data.age || ""} |
        <strong>Parity:</strong> ${data.parity || ""} <br>
        <strong>Labour Onset:</strong> ${data.labourOnset || ""} |
        <strong>Active Labour Diagnosis:</strong> ${data.activeDiagnosis || ""} <br>
        <strong>Ruptured Membranes:</strong> ${data.rupturedMembranes || ""} |
        <strong>Risk Factors:</strong> ${data.riskFactors || ""}
      `;
      document.getElementById("patientInfo").innerHTML = html;
    }

    function buildGrid() {
      const tbody = document.getElementById("summaryBody");
      for (const section in sections) {
        const rows = sections[section];
        rows.forEach((label, index) => {
          const tr = document.createElement("tr");
          if (index === 0) {
            tr.innerHTML = `<td class="section-header" rowspan="${rows.length}">${section}</td>`;
          }
          if (index !== 0) tr.innerHTML = "";
          tr.innerHTML += `<td>${label}</td>` + columns.map(c =>
            `<td><input name="${c}_${label.replace(/\s+/g, '_')}" /></td>`
          ).join('');
          tbody.appendChild(tr);
        });
      }
    }

    async function saveData(e) {
      e.preventDefault();
      const form = new FormData(e.target);
      const records = {};
      for (let [key, value] of form.entries()) {
        const [time, label] = key.split("_");
        if (!records[time]) records[time] = { timestamp: new Date().toISOString() };
        records[time][label] = value;
      }
      for (const t in records) {
        await db.collection("patients").doc(patientId).collection("records").add(records[t]);
      }
      alert("âœ… Saved successfully.");
    }

    loadPatientInfo();
    buildGrid();
    document.getElementById("summaryForm").addEventListener("submit", saveData);
  </script>
</body>
</html>
