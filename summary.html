<!DOCTYPE html>
<html lang="en">
<head>
  <title>WHO Labour Care Guide - Summary</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
</head>
<body>
  <!-- Professional Header -->
  <div class="medical-header">
    <div class="header-content">
      <div class="header-left">
        <div class="app-title">üë©‚Äç‚öïÔ∏è Labour Care Guide</div>
        <div class="page-subtitle">WHO Labour Care Summary Form</div>
      </div>
      <div class="header-right">
        <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </div>

  <div class="main-container">
    <!-- Patient Information Card -->
    <div class="patient-card">
      <div class="card-header">
        <h3><i class="fas fa-user-injured"></i> Patient Information</h3>
      </div>
      <div class="patient-form">
        <div class="form-row">
          <div class="form-group">
            <label for="p_name">Patient Name</label>
            <input type="text" id="p_name" class="form-control" placeholder="Enter patient name">
          </div>
          <div class="form-group">
            <label for="p_age">Age</label>
            <input type="number" id="p_age" class="form-control" placeholder="Age">
          </div>
          <div class="form-group">
            <label for="p_parity">Parity</label>
            <input type="number" id="p_parity" class="form-control" placeholder="Parity">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="p_onset">Labour Onset</label>
            <select id="p_onset" class="form-control">
              <option value="">Select onset type</option>
              <option value="Spontaneous">Spontaneous</option>
              <option value="Induced">Induced</option>
            </select>
          </div>
          <div class="form-group">
            <label for="p_active">Active Labour Diagnosis</label>
            <input type="date" id="p_active" class="form-control">
          </div>
          <div class="form-group">
            <label for="p_membrane">Ruptured Membranes</label>
            <input type="datetime-local" id="p_membrane" class="form-control">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full-width">
            <label for="p_risk">Risk Factors</label>
            <textarea id="p_risk" class="form-control" rows="2" placeholder="Enter any risk factors"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <div class="action-left">
        <a href="list.html" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left"></i> Back to Patient List
        </a>
      </div>
      <div class="action-right">
        <button class="btn btn-primary btn-lg" onclick="saveData()">
          <i class="fas fa-save"></i> Save Progress
        </button>
      </div>
    </div>

    <!-- Recommendations Box -->
    <div id="recommendationsBox" class="recommendations-box"></div>

    <!-- Labour Care Summary Table -->
    <div class="summary-container">
      <div class="table-header">
        <h3><i class="fas fa-clipboard-list"></i> Labour Care Summary</h3>
        <p class="table-subtitle">Complete the form below for each time interval during active labour</p>
      </div>
      
      <div class="table-wrapper">
        <table id="summaryTable" class="summary-table"></table>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const patientId = params.get("patient");
    const timeCols = Array.from({ length: 25 }, (_, i) => {
      const h = String(Math.floor(i / 2)).padStart(2, '0');
      const m = i % 2 === 0 ? "00" : "30";
      return `${h}:${m}`;
    });

    const sections = {
      "Supportive Care": [
        "Companion",
        "Pain relief",
        "Oral fluid",
        "Posture"
      ],
      "Baby": [
        "Baseline FHR",
        "FHR deceleration",
        "Amniotic fluid",
        "Fetal position",
        "Caput",
        "Moulding"
      ],
      "Woman": [
        "Pulse",
        "Systolic BP",
        "Diastolic BP",
        "Temperature C",
        "Urine"
      ],
      "Labour Progress": [
        "Contractions per 10 min",
        "Duration of contractions",
        "Cervix 10",
        "Cervix 9",
        "Cervix 8",
        "Cervix 7",
        "Cervix 6",
        "Cervix 5",
        "Descent 5",
        "Descent 4",
        "Descent 3",
        "Descent 2",
        "Descent 1",
        "Descent 0"
      ],
      "Medication": [
        "Oxytocin (U/L,drops/min)",
        "Medicine",
        "IV fluids"
      ],
      "Shared Decision-Making": [
        "Assessment",
        "Plan"
      ],
      "Initials": [
        "Initials"
      ]
    };

    const dropdownOptions = {
      // Supportive care
      "Companion": ["Yes", "No", "Woman Decline"],
      "Pain relief": ["Yes", "No", "Woman Decline"],
      "Oral fluid": ["Yes", "No", "Woman Decline"],
      "Posture": ["Mobile", "Supine"],

      // Baby
      "Baseline FHR": ["<110", "110-160", ">160"],
      "FHR deceleration": ["None", "Early", "Late", "Variable"],
      "Amniotic fluid": ["Clear", "Meconium", "Bloody", "Intact Membranes"],
      "Fetal position": ["OA", "OP", "OT"],
      "Caput": ["None", "+", "++", "+++"],
      "Moulding": ["None", "+", "++", "+++"],

      // Woman
      "Pulse": ["<60", "60-100", ">100", ">120"],
      "Systolic BP": ["<90", "90-140", ">140"],
      "Diastolic BP": ["<60", "60-90", ">90"],
      "Temperature C": ["<36", "36-37.5", ">37.5"],
      "Urine": ["P-", "P Trace", "P1+", "P2+", "P3+"],

      // Labour Progress
      "Contractions per 10 min": ["<2", "2-5", ">5"],
      "Duration of contractions": ["<20s", "20-40s", ">40s"],
      "Cervix 10": ["X", "O"],
      "Cervix 9": ["X", "O"],
      "Cervix 8": ["X", "O"],
      "Cervix 7": ["X", "O"],
      "Cervix 6": ["X", "O"],
      "Cervix 5": ["X", "O"],
      "Descent 5": ["X", "O"],
      "Descent 4": ["X", "O"],
      "Descent 3": ["X", "O"],
      "Descent 2": ["X", "O"],
      "Descent 1": ["X", "O"],
      "Descent 0": ["X", "O"],

      // Medication
      "Oxytocin (U/L,drops/min)": ["None", "Started"],
      "Medicine": ["None", "Antibiotic", "Antihypertensive", "Other"],
      "IV fluids": ["None", "Started", "Stopped"]
    };

    const alertValues = {
      // Supportive care
      "Companion": ["No"],
      "Pain relief": ["No"],
      "Oral fluid": ["No"],
      "Posture": ["Supine"],

      // Baby
      "Baseline FHR": ["<110", ">160"],
      "FHR deceleration": ["Late"],
      "Amniotic fluid": ["Meconium", "Bloody"],
      "Fetal position": ["OP", "OT"],
      "Caput": ["+++"],
      "Moulding": ["+++"],

      // Woman
      "Pulse": ["<60", ">120"],
      "Systolic BP": ["<90", ">140"],
      "Diastolic BP": ["<60", ">90"],
      "Temperature C": ["<36", ">37.5"],
      "Urine": ["P1+", "P2+", "P3+"],

      // Labour Progress
      "Contractions per 10 min": ["<2", ">5"],
      "Duration of contractions": ["<20s", ">40s"]
    };

    const recommendations = {
      "Companion": {
        "No": "Encourage presence of a companion of choice for support."
      },
      "Pain relief": {
        "No": "Assess pain and offer appropriate pain relief options."
      },
      "Oral fluid": {
        "No": "Encourage oral fluid intake unless contraindicated."
      },
      "Posture": {
        "Supine": "Encourage upright or mobile posture for comfort and progress."
      },
      "Baseline FHR": {
        "<110": "Assess for fetal distress. Prepare for immediate intervention.",
        ">160": "Assess for fetal distress. Prepare for immediate intervention."
      },
      "FHR deceleration": {
        "Late": "Reassess fetal condition. Consider immediate intervention.",
        "Variable": "Monitor closely and reassess fetal condition."
      },
      "Amniotic fluid": {
        "Meconium": "Monitor for fetal distress. Prepare for possible intervention.",
        "Bloody": "Assess for placental abruption or other complications."
      },
      "Fetal position": {
        "OP": "Monitor labour progress. Consider position change or intervention.",
        "OT": "Monitor labour progress. Consider position change or intervention."
      },
      "Caput": {
        "+++": "Monitor for obstructed labour. Consider intervention."
      },
      "Moulding": {
        "+++": "Monitor for obstructed labour. Consider intervention."
      },
      "Pulse": {
        "<60": "Assess for underlying causes. Monitor closely.",
        ">120": "Assess for infection, dehydration, pain, anxiety."
      },
      "Systolic BP": {
        "<90": "Assess for shock. Initiate appropriate management.",
        ">140": "Assess for pre-eclampsia. Initiate appropriate management."
      },
      "Diastolic BP": {
        "<60": "Assess for shock. Monitor closely.",
        ">90": "Assess for pre-eclampsia. Initiate appropriate management."
      },
      "Temperature C": {
        "<36": "Assess for hypothermia. Initiate warming measures.",
        ">37.5": "Assess for infection. Initiate appropriate management."
      },
      "Urine": {
        "P1+": "Assess for pre-eclampsia. Monitor and manage.",
        "P2+": "Assess for pre-eclampsia. Monitor and manage.",
        "P3+": "Assess for pre-eclampsia. Monitor and manage."
      },
      "Contractions per 10 min": {
        "<2": "Assess labour progress. Consider augmentation.",
        ">5": "Assess for uterine hyperstimulation. Consider tocolysis."
      },
      "Duration of contractions": {
        "<20s": "Assess labour progress. Consider augmentation.",
        ">40s": "Assess for uterine hyperstimulation. Consider tocolysis."
      }
    };

    async function loadData() {
      try {
        // Get current user and their Firestore profile
        const user = firebase.auth().currentUser;
        if (!user) {
          document.body.innerHTML = '<div class="alert alert-danger">Not authenticated.</div>';
          return;
        }
        
        // Fetch user profile
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (!userDoc.exists) {
          document.body.innerHTML = '<div class="alert alert-danger">User profile not found.</div>';
          return;
        }
        const userData = userDoc.data();

        // Get patient document
        const patientDoc = await db.collection("patients").doc(patientId).get({ source: "server" });
        if (!patientDoc.exists) {
          document.body.innerHTML = '<div class="alert alert-danger">Patient not found.</div>';
          return;
        }
        const d = patientDoc.data();

        // Access control: Super Admin always allowed, TMO if township matches, Midwife if createdBy matches
        let allowed = false;
        
        if (userData.role === "Super Admin" || userData.role === "admin") {
          allowed = true;
        } else if (userData.role === "TMO") {
          // TMO can access if township matches (handle cases where township might be undefined)
          const patientTownship = d.township || "";
          const userTownship = userData.township || "";
          if (patientTownship && userTownship && patientTownship === userTownship) {
            allowed = true;
          }
        } else if (userData.role === "Midwife" || userData.role === "midwife") {
          // Midwife can access if they created the patient
          if (d.createdBy === user.uid) {
            allowed = true;
          }
        }

        if (!allowed) {
          // Better error message based on role
          let errorMessage = "";
          if (userData.role === "TMO") {
            errorMessage = `Access Denied: You can only access patients in your township (${userData.township || 'undefined'}). This patient is in township: ${d.township || 'undefined'}.`;
          } else if (userData.role === "Midwife" || userData.role === "midwife") {
            errorMessage = `Access Denied: You can only access patients you created. This patient was created by: ${d.createdBy || 'unknown'}.`;
          } else {
            errorMessage = `Access Denied: You do not have permission to view this patient record. Please contact your administrator.`;
          }
          
          document.body.innerHTML = `
            <div class="alert alert-danger">
              <h4>Access Denied</h4>
              <p><strong>Reason:</strong> ${errorMessage}</p>
              <hr>
              <a href="list.html" class="btn btn-primary">‚Üê Back to Patient List</a>
            </div>
          `;
          return;
        }

        // Populate patient info
        document.getElementById("p_name").value = d.name || "";
        document.getElementById("p_age").value = d.age || "";
        document.getElementById("p_parity").value = d.parity || "";
        document.getElementById("p_onset").value = d.labour_onset || "";
        document.getElementById("p_active").value = d.active_labour || "";
        document.getElementById("p_membrane").value = d.ruptured_membrane || "";
        document.getElementById("p_risk").value = d.risk_factors || "";

        // Load records
        const snap = await db.collection("patients").doc(patientId).collection("records").get({ source: "server" });
        const existing = {};
        snap.forEach(doc => {
          const d = doc.data();
          existing[d.time] = d;
        });

        // Generate the summary table
        generateSummaryTable(existing);
        showRecommendations();
        
        // Add event listeners for form changes
        document.querySelectorAll('select, input').forEach(el => {
          el.addEventListener('change', showRecommendations);
        });
      } catch (error) {
        console.error("Error loading data:", error);
        document.body.innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
      }
    }

    function generateSummaryTable(existing) {
      const table = document.getElementById("summaryTable");
      
      // Table header
      let header = `
        <thead>
          <tr class="table-header-row">
            <th class="sticky-section">Section</th>
            <th class="sticky-field">Field</th>
            ${timeCols.map(t => `<th class="time-header">${t}</th>`).join("")}
          </tr>
        </thead>
        <tbody>
      `;

      // Table body
      for (const [section, fields] of Object.entries(sections)) {
        // Section header row
        header += `<tr class="section-header">
          <td class="section-title" colspan="${timeCols.length + 2}">
            <div class="section-header-content">
              <i class="fas fa-layer-group"></i>
              ${section}
            </div>
          </td>
        </tr>`;

        // Field rows
        fields.forEach((field, index) => {
          const row = document.createElement("tr");
          row.className = "field-row";
          
          // Section cell (sticky)
          if (index === 0) {
            const sectionCell = document.createElement("td");
            sectionCell.className = "sticky-section section-label";
            sectionCell.rowSpan = fields.length;
            sectionCell.innerHTML = `<div class="section-label-content">${section}</div>`;
            row.appendChild(sectionCell);
          }
          
          // Field cell (sticky)
          const label = document.createElement("td");
          label.className = "sticky-field field-label";
          label.innerHTML = `<div class="field-label-content">${field}</div>`;
          row.appendChild(label);

          // Time columns
          for (const time of timeCols) {
            const key = `${time}_${field.replace(/\s+/g, "_")}`;
            const value = existing[time] && existing[time][field] ? existing[time][field] : "";
            
            const td = document.createElement("td");
            td.className = "time-cell";
            
            if (dropdownOptions[field]) {
              const select = document.createElement("select");
              select.name = key;
              select.className = "form-select form-select-sm";
              
              // Add blank option first
              const blankOption = document.createElement("option");
              blankOption.value = "";
              blankOption.textContent = "";
              select.appendChild(blankOption);
              
              dropdownOptions[field].forEach(opt => {
                const option = document.createElement("option");
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
              });
              
              select.value = value !== undefined ? value : "";
              td.appendChild(select);
            } else {
              const input = document.createElement("input");
              input.name = key;
              input.type = "text";
              input.className = "form-control form-control-sm";
              input.value = value;
              td.appendChild(input);
            }
            
            row.appendChild(td);
          }
          
          table.appendChild(row);
        });
      }

      header += "</tbody>";
      table.innerHTML = header;
    }

    function getLatestValue(field) {
      // Go through timeCols in reverse to find the latest non-empty value
      for (let i = timeCols.length - 1; i >= 0; i--) {
        const key = `${timeCols[i]}_${field.replace(/\s+/g, "_")}`;
        const el = document.getElementsByName(key)[0];
        if (el && el.value) return el.value;
      }
      return "";
    }

    function showRecommendations() {
      const recs = [];
      for (const fieldList of Object.values(sections)) {
        for (const field of fieldList) {
          const latestValue = getLatestValue(field);
          if (recommendations[field] && recommendations[field][latestValue]) {
            recs.push(`${field} (${latestValue}): ${recommendations[field][latestValue]}`);
          }
        }
      }
      
      const box = document.getElementById("recommendationsBox");
      if (recs.length) {
        box.innerHTML = `
          <div class="recommendations-content">
            <div class="recommendations-header">
              <i class="fas fa-lightbulb"></i>
              <span>Clinical Recommendations</span>
            </div>
            <div class="recommendations-list">
              ${recs.map(r => `<div class="recommendation-item">${r}</div>`).join("")}
            </div>
          </div>
        `;
      } else {
        box.innerHTML = "";
      }
    }

    async function saveData() {
      try {
        const base = db.collection("patients").doc(patientId);

        // Fetch existing patient data to preserve createdBy
        const patientDoc = await base.get();
        let createdBy = "";
        if (patientDoc.exists && patientDoc.data().createdBy) {
          createdBy = patientDoc.data().createdBy;
        }

        // Save patient info
        await base.set({
          name: document.getElementById("p_name").value,
          age: document.getElementById("p_age").value,
          parity: document.getElementById("p_parity").value,
          labour_onset: document.getElementById("p_onset").value,
          active_labour: document.getElementById("p_active").value,
          ruptured_membrane: document.getElementById("p_membrane").value,
          risk_factors: document.getElementById("p_risk").value,
          createdBy
        });

        // Save time-based records
        for (const time of timeCols) {
          const data = { time, timestamp: new Date().toISOString() };
          for (const fieldList of Object.values(sections)) {
            for (const field of fieldList) {
              const key = `${time}_${field.replace(/\s+/g, "_")}`;
              const el = document.getElementsByName(key)[0];
              if (el) data[field] = el.value;
            }
          }
          await base.collection("records").doc(time).set(data);
        }
        
        // Show success message
        showSaveSuccess();
      } catch (error) {
        console.error("Error saving data:", error);
        showSaveError(error.message);
      }
    }

    function showSaveSuccess() {
      const actionBar = document.querySelector('.action-right');
      const successMsg = document.createElement('div');
      successMsg.className = 'save-success';
      successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Saved successfully!';
      actionBar.appendChild(successMsg);
      
      setTimeout(() => {
        successMsg.remove();
      }, 3000);
    }

    function showSaveError(message) {
      const actionBar = document.querySelector('.action-right');
      const errorMsg = document.createElement('div');
      errorMsg.className = 'save-error';
      errorMsg.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error: ${message}`;
      actionBar.appendChild(errorMsg);
      
      setTimeout(() => {
        errorMsg.remove();
      }, 5000);
    }

    // Load data when page loads
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "login.html";
      } else {
        // Only load data after user is authenticated
        loadData();
      }
    });
  </script>
</body>
<footer class="footer">
  ¬© 2025 Labour Care App &mdash; Designed for clinical excellence
</footer>
</html>