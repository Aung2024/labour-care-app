<!DOCTYPE html>
<html>
<head>
  <title>WHO Labour Summary</title>
  <meta charset="UTF-8">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .patient-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .patient-info div { display: flex; flex-direction: column; }
    .table-responsive {
      width: 100vw;
      max-width: 100vw;
      overflow-x: auto;
      overflow-y: auto;
      margin-left: -20px;
      margin-right: -20px;
      padding-left: 0;
      padding-right: 0;
      max-height: 70vh;
      margin-top: 20px;
    }
    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      background: #f8fafc;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(60, 80, 180, 0.08);
    }
    th, td {
      font-size: 1em;
      background: #fff;
      text-align: center;
      vertical-align: middle;
      box-sizing: border-box;
      padding: 10px 8px;
      border-bottom: 1px solid #e5e7eb;
      transition: background 0.2s;
    }
    th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #6366f1;
      color: #fff;
      font-weight: bold;
      border-bottom: 2px solid #6366f1;
    }
    th.sticky, td.sticky {
      position: sticky;
      left: 0;
      z-index: 11;
      background: #e0e7ff;
      color: #3730a3;
    }
    th.sticky2, td.sticky2 {
      position: sticky;
      left: 170px; /* Match width of .sticky */
      z-index: 10;
      background: #e0e7ff;
      color: #2563eb;
    }
    /* Ensure sticky columns are above sticky header */
    th.sticky, th.sticky2 {
      z-index: 12;
    }
    .section-label {
      writing-mode: vertical-rl;
      text-orientation: mixed;
      background: #e0e7ff;
      font-weight: bold;
      text-align: center;
      vertical-align: middle;
      padding: 16px 0;
      border-right: none;
      border-bottom: none;
      font-size: 1.1em;
      letter-spacing: 1px;
      color: #3730a3; /* Deep blue for vertical section label */
    }
    .section-row {
      background: #eef2ff;
    }
    .section-divider {
      height: 0;
      border: none;
      border-top: 6px solid #6366f1;
      margin: 0;
    }
    th {
      background: #6366f1;
      color: #0d1fc9;
      font-weight: bold;
      border-bottom: 2px solid #6366f1;
    }
    .alert-cell {
      background-color: #fee2e2 !important;
      border: 2px solid #ef4444 !important;
      border-radius: 8px;
    }
    select, input {
      width: 100%;
      font-size: 1em;
      min-width: 60px;
      box-sizing: border-box;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: #fff;
    }
    select {
      white-space: normal;
      max-width: 100%;
    }
    @media (max-width: 900px) {
      th, td { font-size: 0.95em; padding: 4px; }
      select, input { font-size: 0.95em; min-width: 40px; }
      th.sticky, td.sticky, th.sticky2, td.sticky2 { min-width: 100px; max-width: 120px; width: 120px; }
      th.sticky2, td.sticky2 { left: 120px; }
    }
    @media (max-width: 600px) {
      th, td { font-size: 0.85em; padding: 2px; }
      select, input { font-size: 0.85em; min-width: 35px; }
      .table-responsive { margin-left: -10px; margin-right: -10px; padding-left: 5px; padding-right: 5px; }
      .patient-info { grid-template-columns: 1fr; }
      body { padding: 5px; }
      th.sticky, td.sticky, th.sticky2, td.sticky2 { min-width: 60px; max-width: 60px; width: 60px; }
      th.sticky2, td.sticky2 { left: 60px; }
    }
  </style>
</head>
<body>
  <h2>Labour Care Guide</h2>
  <div class="patient-info" id="patientInfo">
    <div><label>Name</label><input id="p_name" /></div>
    <div><label>Age</label><input id="p_age" /></div>
    <div><label>Parity</label><input id="p_parity" /></div>
    <div><label>Labour Onset</label><input id="p_onset" type="datetime-local" /></div>
    <div><label>Active Labour Diagnosis</label><input id="p_active" type="date" /></div>
    <div><label>Ruptured Membranes</label><input id="p_membrane" type="datetime-local" /></div>
    <div><label>Risk Factors</label><input id="p_risk" /></div>
  </div>
  <div class="table-responsive">
    <table id="summaryTable"></table>
  </div>
  <button onclick="saveData()">ðŸ’¾ Save</button>

  <script>
    const params = new URLSearchParams(window.location.search);
    const patientId = params.get("patient");
    const timeCols = Array.from({ length: 25 }, (_, i) => {
      const h = String(Math.floor(i / 2)).padStart(2, '0');
      const m = i % 2 === 0 ? "00" : "30";
      return `${h}:${m}`;
    });

    const sections = {
      "Supportive care": [
        "Companion",
        "Pain relief",
        "Oral fluid",
        "Posture"
      ],
      "Baby": [
        "Baseline FHR",
        "FHR deceleration",
        "Amniotic fluid",
        "Fetal position",
        "Caput",
        "Moulding"
      ],
      "Woman": [
        "Pulse",
        "Systolic BP",
        "Diastolic BP",
        "Temperature C",
        "Urine"
      ],
      "Labour Progress": [
        "Contractions per 10 min",
        "Duration of contractions",
        "Cervix 10",
        "Cervix 9",
        "Cervix 8",
        "Cervix 7",
        "Cervix 6",
        "Cervix 5",
        "Descent 4",
        "Descent 3",
        "Descent 2",
        "Descent 1"
      ],
      "Medication": [
        "Oxytocin (U/L,drops/min)",
        "Medicine",
        "IV fluids"
      ],
      "Shared Decision-Making": [
        "Assessment",
        "Plan"
      ],
      "Initials": [
        "Initials"
      ]
    };

    const dropdownOptions = {
      // Supportive care
      "Companion": ["Yes", "No","Woman Decline"],
      "Pain relief": ["Yes", "No","Woman Decline"],
      "Oral fluid": ["Yes", "No","Woman Decline"],
      "Posture": ["Mobile", "Supine"],

      // Baby
      "Baseline FHR": ["<110", "110-160", ">160"],
      "FHR deceleration": ["None", "Early", "Late", "Variable"],
      "Amniotic fluid": ["Clear", "Meconium", "Bloody", "Intact Membranes"],
      "Fetal position": ["OA", "OP", "OT"],
      "Caput": ["None", "+", "++", "+++"],
      "Moulding": ["None", "+", "++", "+++"],

      // Woman
      "Pulse": ["<60", "60-100", ">100",">120"],
      "Systolic BP": ["<90", "90-140", ">140"],
      "Diastolic BP": ["<60", "60-90", ">90"],
      "Temperature C": ["<36", "36-37.5", ">37.5"],
      "Urine": ["P-","P Trace","P1+","P2+","P3+"],

      // Labour Progress
      "Contractions per 10 min": ["<2", "2-5", ">5"],
      "Duration of contractions": ["<20s", "20-40s", ">40s"],
      "Cervix 10": ["X", "O"],
      "Cervix 9": ["X", "O"],
      "Cervix 8": ["X", "O"],
      "Cervix 7": ["X", "O"],
      "Cervix 6": ["X", "O"],
      "Cervix 5": ["X", "O"],
      "Descent 4": ["X", "O"],
      "Descent 3": ["X", "O"],
      "Descent 2": ["X", "O"],
      "Descent 1": ["X", "O"],

      // Medication
      "Oxytocin (U/L,drops/min)": ["None", "Started" ],
      "Medicine": ["None", "Antibiotic", "Antihypertensive", "Other"],
      "IV fluids": ["None", "Started", "Stopped"],

     

     
    };

    const alertValues = {
  // Supportive care
  "Companion": ["No"],
  "Pain relief": ["No"],
  "Oral fluid": ["No"],
  "Posture": ["Supine"],

  // Baby
  "Baseline FHR": ["<110", ">160"],
  "FHR deceleration": ["Late"],
  "Amniotic fluid": ["Meconium", "Bloody"],
  "Fetal position": ["OP", "OT"],
  "Caput": ["+++"],
  "Moulding": ["+++"],

  // Woman
  "Pulse": ["<60", ">120"],
  "Systolic BP": ["<90", ">140"],
  "Diastolic BP": ["<60", ">90"],
  "Temperature C": ["<36", ">37.5"],
  "Urine": ["P1+", "P2+", "P3+"],

  // Labour Progress
  "Contractions per 10 min": ["<2", ">5"],
  "Duration of contractions": ["<20s", ">40s"],

  // Medication, Shared Decision-Making, Initials
  // (No alerts specified in LCG for these)
};

    async function loadData() {
      const patientDoc = await db.collection("patients").doc(patientId).get({ source: "server" });
      if (patientDoc.exists) {
        const d = patientDoc.data();
        document.getElementById("p_name").value = d.name || "";
        document.getElementById("p_age").value = d.age || "";
        document.getElementById("p_parity").value = d.parity || "";
        document.getElementById("p_onset").value = d.labour_onset || "";
        document.getElementById("p_active").value = d.active_labour || "";
        document.getElementById("p_membrane").value = d.ruptured_membrane || "";
        document.getElementById("p_risk").value = d.risk_factors || "";
      }

      const snap = await db.collection("patients").doc(patientId).collection("records").get({ source: "server" });
      const existing = {};
      snap.forEach(doc => {
        const d = doc.data();
        existing[d.time] = d;
      });

      const table = document.getElementById("summaryTable");
      // Table header
      let header = `<tr>
        <th class="sticky" rowspan="2">Section</th>
        <th class="sticky2" rowspan="2">Field</th>
        <th colspan="${timeCols.length}" style="text-align:center;">ACTIVE FIRST STAGE</th>
      </tr>
      <tr>
        ${timeCols.map(t => `<th class="time">${t}</th>`).join("")}
      </tr>`;
      table.innerHTML = header;

      // Table body
      for (const [section, fields] of Object.entries(sections)) {
        fields.forEach((field, index) => {
          const row = document.createElement("tr");
          if (index === 0) row.className = "section-row";

          // Section cell (sticky, vertical label)
          if (index === 0) {
            const sectionCell = document.createElement("td");
            sectionCell.className = "sticky section-label";
            sectionCell.rowSpan = fields.length;
            sectionCell.textContent = section;
            row.appendChild(sectionCell);
          }
          // Field cell (sticky2)
          const label = document.createElement("td");
          label.className = "sticky2";
          label.textContent = field;
          row.appendChild(label);

          // Time columns
          for (const time of timeCols) {
            const key = `${time}_${field.replace(/\s+/g, "_")}`;
            const value = existing[time] && existing[time][field] ? existing[time][field] : "";
            const alert = checkAlert(field, value) ? "alert-cell time" : "time";
            const td = document.createElement("td");
            td.className = alert;
            if (dropdownOptions[field]) {
              const select = document.createElement("select");
              select.name = key;
              // Add blank option first
              const blankOption = document.createElement("option");
              blankOption.value = "";
              blankOption.textContent = "";
              select.appendChild(blankOption);
              dropdownOptions[field].forEach(opt => {
                const option = document.createElement("option");
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
              });
              select.value = value !== undefined ? value : "";
              td.appendChild(select);
            } else {
              const input = document.createElement("input");
              input.name = key;
              input.value = value;
              td.appendChild(input);
            }
            row.appendChild(td);
          }
          table.appendChild(row);
        });

        // Add thick blue divider after each section
        const dividerRow = document.createElement("tr");
        dividerRow.innerHTML = `<td colspan="${2 + timeCols.length}"><hr class="section-divider"></td>`;
        table.appendChild(dividerRow);
      }
    }

    function checkAlert(field, value) {
      return alertValues[field] && alertValues[field].includes(value);
    }

    async function saveData() {
      const base = db.collection("patients").doc(patientId);

      await base.set({
        name: document.getElementById("p_name").value,
        age: document.getElementById("p_age").value,
        parity: document.getElementById("p_parity").value,
        labour_onset: document.getElementById("p_onset").value,
        active_labour: document.getElementById("p_active").value,
        ruptured_membrane: document.getElementById("p_membrane").value,
        risk_factors: document.getElementById("p_risk").value
      });

      for (const time of timeCols) {
        const data = { time, timestamp: new Date().toISOString() };
        for (const fieldList of Object.values(sections)) {
          for (const field of fieldList) {
            const key = `${time}_${field.replace(/\s+/g, "_")}`;
            const el = document.getElementsByName(key)[0];
            if (el) data[field] = el.value;
          }
        }
        await base.collection("records").doc(time).set(data);
      }
      alert("âœ… Saved");
    }

    loadData();
  </script>
</body>
</html>