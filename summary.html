<!DOCTYPE html>
<html>
<head>
  <title>WHO Labour Summary</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> <!-- MISSING! -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="js/firebase.js"></script>
</head>
<body>
  <div class="header-bar">
    <span class="header-title">üë©‚Äç‚öïÔ∏è Labour Care Guide - Summary</span>
    <button class="logout-btn" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">Logout</button>
  </div>
  <div class="main-content">
    <div class="patient-info" id="patientInfo">
      <div><label>Name</label><input id="p_name" /></div>
      <div><label>Age</label><input id="p_age" /></div>
      <div><label>Parity</label><input id="p_parity" /></div>
      <div>
        <label>Labour Onset</label>
        <select id="p_onset">
          <option value="">Select...</option>
          <option value="Spontaneous">Spontaneous</option>
          <option value="Induced">Induced</option>
        </select>
      </div>
      <div><label>Active Labour Diagnosis</label><input id="p_active" type="date" /></div>
      <div><label>Ruptured Membranes</label><input id="p_membrane" type="datetime-local" /></div>
      <div><label>Risk Factors</label><input id="p_risk" /></div>
    </div>
    <div class="controls-bar">
      <button class="btn btn-primary" onclick="saveData()">üíæ Save</button>
      <a href="list.html" class="btn btn-secondary">‚¨ÖÔ∏è Back to List</a>
      <div>
        <button class="btn btn-warning me-2" onclick="loadDataWithDebug()">üêõ Debug Load</button>
        <button class="btn btn-info" onclick="testFirestoreAccess()">üîç Test Access</button>
      </div>
    </div>
    <div id="recommendationsBox"></div>
    <div class="table-responsive">
      <table id="summaryTable"></table>
    </div>
  </div>
  <script>
    const params = new URLSearchParams(window.location.search);
    const patientId = params.get("patient");
    const timeCols = Array.from({ length: 25 }, (_, i) => {
      const h = String(Math.floor(i / 2)).padStart(2, '0');
      const m = i % 2 === 0 ? "00" : "30";
      return `${h}:${m}`;
    });

    const sections = {
      "Supportive care": [
        "Companion",
        "Pain relief",
        "Oral fluid",
        "Posture"
      ],
      "Baby": [
        "Baseline FHR",
        "FHR deceleration",
        "Amniotic fluid",
        "Fetal position",
        "Caput",
        "Moulding"
      ],
      "Woman": [
        "Pulse",
        "Systolic BP",
        "Diastolic BP",
        "Temperature C",
        "Urine"
      ],
      "Labour Progress": [
        "Contractions per 10 min",
        "Duration of contractions",
        "Cervix 10",
        "Cervix 9",
        "Cervix 8",
        "Cervix 7",
        "Cervix 6",
        "Cervix 5",
        "Descent 5",
        "Descent 4",
        "Descent 3",
        "Descent 2",
        "Descent 1",
        "Descent 0"
      ],
      "Medication": [
        "Oxytocin (U/L,drops/min)",
        "Medicine",
        "IV fluids"
      ],
      "Shared Decision-Making": [
        "Assessment",
        "Plan"
      ],
      "Initials": [
        "Initials"
      ]
    };

    const dropdownOptions = {
      // Supportive care
      "Companion": ["Yes", "No","Woman Decline"],
      "Pain relief": ["Yes", "No","Woman Decline"],
      "Oral fluid": ["Yes", "No","Woman Decline"],
      "Posture": ["Mobile", "Supine"],

      // Baby
      "Baseline FHR": ["<110", "110-160", ">160"],
      "FHR deceleration": ["None", "Early", "Late", "Variable"],
      "Amniotic fluid": ["Clear", "Meconium", "Bloody", "Intact Membranes"],
      "Fetal position": ["OA", "OP", "OT"],
      "Caput": ["None", "+", "++", "+++"],
      "Moulding": ["None", "+", "++", "+++"],

      // Woman
      "Pulse": ["<60", "60-100", ">100",">120"],
      "Systolic BP": ["<90", "90-140", ">140"],
      "Diastolic BP": ["<60", "60-90", ">90"],
      "Temperature C": ["<36", "36-37.5", ">37.5"],
      "Urine": ["P-","P Trace","P1+","P2+","P3+"],

      // Labour Progress
      "Contractions per 10 min": ["<2", "2-5", ">5"],
      "Duration of contractions": ["<20s", "20-40s", ">40s"],
      "Cervix 10": ["X", "O"],
      "Cervix 9": ["X", "O"],
      "Cervix 8": ["X", "O"],
      "Cervix 7": ["X", "O"],
      "Cervix 6": ["X", "O"],
      "Cervix 5": ["X", "O"],
      "Descent 5": ["X", "O"],
      "Descent 4": ["X", "O"],
      "Descent 3": ["X", "O"],
      "Descent 2": ["X", "O"],
      "Descent 1": ["X", "O"],
      "Descent 0": ["X", "O"],

      // Medication
      "Oxytocin (U/L,drops/min)": ["None", "Started" ],
      "Medicine": ["None", "Antibiotic", "Antihypertensive", "Other"],
      "IV fluids": ["None", "Started", "Stopped"],

     

     
    };

    const alertValues = {
  // Supportive care
  "Companion": ["No"],
  "Pain relief": ["No"],
  "Oral fluid": ["No"],
  "Posture": ["Supine"],

  // Baby
  "Baseline FHR": ["<110", ">160"],
  "FHR deceleration": ["Late"],
  "Amniotic fluid": ["Meconium", "Bloody"],
  "Fetal position": ["OP", "OT"],
  "Caput": ["+++"],
  "Moulding": ["+++"],

  // Woman
  "Pulse": ["<60", ">120"],
  "Systolic BP": ["<90", ">140"],
  "Diastolic BP": ["<60", ">90"],
  "Temperature C": ["<36", ">37.5"],
  "Urine": ["P1+", "P2+", "P3+"],

  // Labour Progress
  "Contractions per 10 min": ["<2", ">5"],
  "Duration of contractions": ["<20s", ">40s"],

  // Medication, Shared Decision-Making, Initials
  // (No alerts specified in LCG for these)
};

    const recommendations = {
  "Companion": {
    "No": "Encourage presence of a companion of choice for support."
  },
  "Pain relief": {
    "No": "Assess pain and offer appropriate pain relief options."
  },
  "Oral fluid": {
    "No": "Encourage oral fluid intake unless contraindicated."
  },
  "Posture": {
    "Supine": "Encourage upright or mobile posture for comfort and progress."
  },
  "Baseline FHR": {
    "<110": "Assess for fetal distress. Prepare for immediate intervention.",
    ">160": "Assess for fetal distress. Prepare for immediate intervention."
  },
  "FHR deceleration": {
    "Late": "Reassess fetal condition. Consider immediate intervention.",
    "Variable": "Monitor closely and reassess fetal condition."
  },
  "Amniotic fluid": {
    "Meconium": "Monitor for fetal distress. Prepare for possible intervention.",
    "Bloody": "Assess for placental abruption or other complications."
  },
  "Fetal position": {
    "OP": "Monitor labour progress. Consider position change or intervention.",
    "OT": "Monitor labour progress. Consider position change or intervention."
  },
  "Caput": {
    "+++": "Monitor for obstructed labour. Consider intervention."
  },
  "Moulding": {
    "+++": "Monitor for obstructed labour. Consider intervention."
  },
  "Pulse": {
    "<60": "Assess for underlying causes. Monitor closely.",
    ">120": "Assess for infection, dehydration, pain, anxiety."
  },
  "Systolic BP": {
    "<90": "Assess for shock. Initiate appropriate management.",
    ">140": "Assess for pre-eclampsia. Initiate appropriate management."
  },
  "Diastolic BP": {
    "<60": "Assess for shock. Monitor closely.",
    ">90": "Assess for pre-eclampsia. Initiate appropriate management."
  },
  "Temperature C": {
    "<36": "Assess for hypothermia. Initiate warming measures.",
    ">37.5": "Assess for infection. Initiate appropriate management."
  },
  "Urine": {
    "P1+": "Assess for pre-eclampsia. Monitor and manage.",
    "P2+": "Assess for pre-eclampsia. Monitor and manage.",
    "P3+": "Assess for pre-eclampsia. Monitor and manage."
  },
  "Contractions per 10 min": {
    "<2": "Assess labour progress. Consider augmentation.",
    ">5": "Assess for uterine hyperstimulation. Consider tocolysis."
  },
  "Duration of contractions": {
    "<20s": "Assess labour progress. Consider augmentation.",
    ">40s": "Assess for uterine hyperstimulation. Consider tocolysis."
  }
  // Add more as per WHO manual if needed
};

    async function loadData() {
      try {
        // Get current user and their Firestore profile
        const user = firebase.auth().currentUser;
        if (!user) {
          document.body.innerHTML = '<div class="alert alert-danger">Not authenticated.</div>';
          return;
        }
        console.log("User authenticated:", user.uid);
        
        // Fetch user profile
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (!userDoc.exists) {
          document.body.innerHTML = '<div class="alert alert-danger">User profile not found.</div>';
          return;
        }
        const userData = userDoc.data();
        console.log("User profile loaded:", userData);

        // Get patient document
        console.log("Loading patient:", patientId);
        const patientDoc = await db.collection("patients").doc(patientId).get({ source: "server" });
        if (!patientDoc.exists) {
          document.body.innerHTML = '<div class="alert alert-danger">Patient not found.</div>';
          return;
        }
        const d = patientDoc.data();
        console.log("Patient data loaded:", d);

      // Access control: Super Admin always allowed, TMO if township matches, Midwife if createdBy matches
      let allowed = false;
      
      // TEMPORARY: Add bypass for testing (remove this in production)
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('debug') === 'true') {
        allowed = true;
        console.log("DEBUG MODE: Access granted for testing");
      } else {
        if (userData.role === "Super Admin" || userData.role === "admin") {
          allowed = true;
          console.log("Access granted: Super Admin");
        } else if (userData.role === "TMO") {
          // TMO can access if township matches (handle cases where township might be undefined)
          const patientTownship = d.township || "";
          const userTownship = userData.township || "";
          if (patientTownship && userTownship && patientTownship === userTownship) {
            allowed = true;
            console.log("Access granted: TMO - township match");
          } else {
            console.log("Access denied: TMO - township mismatch", { patientTownship, userTownship });
          }
        } else if (userData.role === "Midwife" || userData.role === "midwife") {
          // Midwife can access if they created the patient
          if (d.createdBy === user.uid) {
            allowed = true;
            console.log("Access granted: Midwife - created by user");
          } else {
            console.log("Access denied: Midwife - not created by user", { 
              patientCreatedBy: d.createdBy, 
              userUid: user.uid 
            });
          }
        } else {
          console.log("Access denied: Unknown role", userData.role);
        }
      }

      if (!allowed) {
        console.log("Access denied. User role:", userData.role);
        console.log("User township:", userData.township);
        console.log("Patient township:", d.township);
        console.log("Patient createdBy:", d.createdBy);
        console.log("User UID:", user.uid);
        
        // Better error message based on role
        let errorMessage = "";
        if (userData.role === "TMO") {
          errorMessage = `Access Denied: You can only access patients in your township (${userData.township || 'undefined'}). This patient is in township: ${d.township || 'undefined'}.`;
        } else if (userData.role === "Midwife" || userData.role === "midwife") {
          errorMessage = `Access Denied: You can only access patients you created. This patient was created by: ${d.createdBy || 'unknown'}.`;
        } else {
          errorMessage = `Access Denied: You do not have permission to view this patient record. Please contact your administrator.`;
        }
        
        document.body.innerHTML = `
          <div class="alert alert-danger">
            <h4>Access Denied</h4>
            <p><strong>Reason:</strong> ${errorMessage}</p>
            <hr>
            <p><strong>User Role:</strong> ${userData.role}</p>
            <p><strong>User Township:</strong> ${userData.township || 'undefined'}</p>
            <p><strong>Patient Township:</strong> ${d.township || 'undefined'}</p>
            <p><strong>Patient Created By:</strong> ${d.createdBy || 'undefined'}</p>
            <p><strong>User UID:</strong> ${user.uid}</p>
            <p><strong>Patient ID:</strong> ${patientId}</p>
            <hr>
            <a href="list.html" class="btn btn-primary">‚Üê Back to Patient List</a>
            <button class="btn btn-warning ms-2" onclick="loadDataWithDebug()">üêõ Debug Mode</button>
          </div>
        `;
        return;
      }

      // Populate patient info
      document.getElementById("p_name").value = d.name || "";
      document.getElementById("p_age").value = d.age || "";
      document.getElementById("p_parity").value = d.parity || "";
      document.getElementById("p_onset").value = d.labour_onset || "";
      document.getElementById("p_active").value = d.active_labour || "";
      document.getElementById("p_membrane").value = d.ruptured_membrane || "";
      document.getElementById("p_risk").value = d.risk_factors || "";

      // Load records
      const snap = await db.collection("patients").doc(patientId).collection("records").get({ source: "server" });
      const existing = {};
      snap.forEach(doc => {
        const d = doc.data();
        existing[d.time] = d;
      });

      const table = document.getElementById("summaryTable");
      // Table header
      let header = `<tr>
        <th class="sticky" rowspan="2">Section</th>
        <th class="sticky2" rowspan="2">Field</th>
        <th colspan="${timeCols.length}" style="text-align:center;">ACTIVE FIRST STAGE</th>
      </tr>
      <tr>
        ${timeCols.map(t => `<th class="time">${t}</th>`).join("")}
      </tr>`;
      table.innerHTML = header;

      // Table body
      for (const [section, fields] of Object.entries(sections)) {
        fields.forEach((field, index) => {
          const row = document.createElement("tr");
          if (index === 0) row.className = "section-row";

          // Section cell (sticky, vertical label)
          if (index === 0) {
            const sectionCell = document.createElement("td");
            sectionCell.className = "sticky section-label";
            sectionCell.rowSpan = fields.length;
            sectionCell.textContent = section;
            row.appendChild(sectionCell);
          }
          // Field cell (sticky2)
          const label = document.createElement("td");
          label.className = "sticky2";
          label.textContent = field;
          row.appendChild(label);

          // Find the latest value and time for this field using existing data
          const { value: latestValue, time: latestTime } = getLatestValueAndTime(field, existing, timeCols);

          // Time columns
          for (const time of timeCols) {
            const key = `${time}_${field.replace(/\s+/g, "_")}`;
            const value = existing[time] && existing[time][field] ? existing[time][field] : "";
            let cellClass = "time";
            // Highlight only the latest cell if it's an alert value
            if (time === latestTime && alertValues[field] && alertValues[field].includes(latestValue)) {
              cellClass += " alert-cell";
            }
            // Highlight Labour Progress "O" or "X"
            if (
              section === "Labour Progress" &&
              (value === "O" || value === "X")
            ) {
              cellClass += " trend-cell";
            }
            const td = document.createElement("td");
            td.className = cellClass;
            if (dropdownOptions[field]) {
              const select = document.createElement("select");
              select.name = key;
              // Add blank option first
              const blankOption = document.createElement("option");
              blankOption.value = "";
              blankOption.textContent = "";
              select.appendChild(blankOption);
              dropdownOptions[field].forEach(opt => {
                const option = document.createElement("option");
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
              });
              select.value = value !== undefined ? value : "";
              td.appendChild(select);
            } else {
              const input = document.createElement("input");
              input.name = key;
              input.value = value;
              td.appendChild(input);
            }
            row.appendChild(td);
          }
          table.appendChild(row);
        });

        // Add thick blue divider after each section
        const dividerRow = document.createElement("tr");
        dividerRow.innerHTML = `<td colspan="${2 + timeCols.length}"><hr class="section-divider"></td>`;
        table.appendChild(dividerRow);
      }
      showRecommendations();
      document.querySelectorAll('select, input').forEach(el => {
        el.addEventListener('change', showRecommendations);
      });
    } catch (error) {
      console.error("Error loading data:", error);
      document.body.innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
    }
  }

    function getLatestValue(field) {
  // Go through timeCols in reverse to find the latest non-empty value
  for (let i = timeCols.length - 1; i >= 0; i--) {
    const key = `${timeCols[i]}_${field.replace(/\s+/g, "_")}`;
    const el = document.getElementsByName(key)[0];
    if (el && el.value) return el.value;
  }
  return "";
}

    function getLatestValueAndTime(field, existing, timeCols) {
  for (let i = timeCols.length - 1; i >= 0; i--) {
    const time = timeCols[i];
    if (existing[time] && existing[time][field] && existing[time][field] !== "") {
      return { value: existing[time][field], time };
    }
  }
  return { value: "", time: null };
}

    function showRecommendations() {
  const recs = [];
  for (const fieldList of Object.values(sections)) {
    for (const field of fieldList) {
      const latestValue = getLatestValue(field);
      if (recommendations[field] && recommendations[field][latestValue]) {
        recs.push(`${field} (${latestValue}): ${recommendations[field][latestValue]}`);
      }
    }
  }
  const box = document.getElementById("recommendationsBox");
  if (recs.length) {
    box.innerHTML = `<div style="background:#e0e7ff;border-left:6px solid #6366f1;padding:12px;border-radius:8px;">
      <b>Recommendations:</b><ul>${recs.map(r => `<li>${r}</li>`).join("")}</ul>
    </div>`;
  } else {
    box.innerHTML = "";
  }
}

// For cell highlighting, update checkAlert to use only the latest value:
function checkAlert(field, value) {
  const latestValue = getLatestValue(field);
  return alertValues[field] && alertValues[field].includes(latestValue);
}

    async function saveData() {
      const base = db.collection("patients").doc(patientId);

      // Fetch existing patient data to preserve createdBy
      const patientDoc = await base.get();
      let createdBy = "";
      if (patientDoc.exists && patientDoc.data().createdBy) {
        createdBy = patientDoc.data().createdBy;
      }

      await base.set({
        name: document.getElementById("p_name").value,
        age: document.getElementById("p_age").value,
        parity: document.getElementById("p_parity").value,
        labour_onset: document.getElementById("p_onset").value,
        active_labour: document.getElementById("p_active").value,
        ruptured_membrane: document.getElementById("p_membrane").value,
        risk_factors: document.getElementById("p_risk").value,
        createdBy // <-- preserve createdBy!
      });

      for (const time of timeCols) {
        const data = { time, timestamp: new Date().toISOString() };
        for (const fieldList of Object.values(sections)) {
          for (const field of fieldList) {
            const key = `${time}_${field.replace(/\s+/g, "_")}`;
            const el = document.getElementsByName(key)[0];
            if (el) data[field] = el.value;
          }
        }
        await base.collection("records").doc(time).set(data);
      }
      alert("‚úÖ Saved");
    }
    
    async function loadDataWithDebug() {
      // Temporarily enable debug mode
      const currentUrl = new URL(window.location);
      currentUrl.searchParams.set('debug', 'true');
      window.history.pushState({}, '', currentUrl);
      await loadData();
    }
    
    async function testFirestoreAccess() {
      try {
        console.log("Testing Firestore access in summary...");
        const user = firebase.auth().currentUser;
        console.log("Current user:", user);
        
        if (user) {
          // Test reading user document
          const userDoc = await db.collection("users").doc(user.uid).get();
          console.log("User document accessible:", userDoc.exists);
          
          // Test reading specific patient document
          try {
            const patientDoc = await db.collection("patients").doc(patientId).get();
            console.log("Patient document accessible:", patientDoc.exists);
            if (patientDoc.exists) {
              console.log("Patient data:", patientDoc.data());
            }
          } catch (error) {
            console.error("Cannot access patient document:", error.message);
          }
        }
      } catch (error) {
        console.error("Firestore test failed:", error);
      }
    }

    // loadData(); // Removed - now called in auth callback
  </script>
  <script>
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "login.html";
      } else {
        // Only load data after user is authenticated
        loadData();
      }
    });
  </script>
</body>
<footer class="footer">
  ¬© 2025 Labour Care App &mdash; Designed for clinical excellence
</footer>
</html>