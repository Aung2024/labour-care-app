<!DOCTYPE html>
<html>
<head>
  <title>WHO Labour Summary</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <style>
    body {
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(120deg, #eef2ff 0%, #f8fafc 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    .header-bar {
      background: #6366f1;
      color: #fff;
      padding: 18px 32px;
      border-radius: 0 0 24px 24px;
      box-shadow: 0 4px 24px rgba(60,80,180,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }
    .header-title {
      font-size: 2em;
      font-weight: bold;
      letter-spacing: 1px;
      color: #fff;
      margin: 0;
    }
    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 12px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 32px rgba(60,80,180,0.10);
    }
    .patient-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 18px;
      margin-bottom: 24px;
      background: #eef2ff;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 2px 12px rgba(99,102,241,0.06);
    }
    .patient-info div {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .patient-info label {
      font-weight: 500;
      color: #3730a3;
      margin-bottom: 2px;
    }
    .patient-info input, .patient-info select {
      font-size: 1em;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      padding: 6px 8px;
      background: #fff;
    }
    .controls-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 18px;
      justify-content: flex-end;
      align-items: center;
    }
    .controls-bar button {
      font-size: 1.1em;
      border-radius: 8px;
      padding: 8px 18px;
    }
    .table-responsive {
      margin-top: 18px;
      margin-bottom: 18px;
      border-radius: 16px;
      box-shadow: 0 2px 16px rgba(99,102,241,0.08);
      background: #f8fafc;
      overflow-x: auto;
      overflow-y: auto;
      padding: 0;
      max-height: 70vh;
    }
    #recommendationsBox {
      margin-bottom: 24px;
      font-size: 1.1em;
    }
    .logout-btn {
      font-size: 1em;
      border-radius: 8px;
      padding: 6px 16px;
      background: #fff;
      color: #6366f1;
      border: 2px solid #6366f1;
      font-weight: 500;
      transition: background 0.2s, color 0.2s;
    }
    .logout-btn:hover {
      background: #6366f1;
      color: #fff;
    }
    .alert-cell {
  background: #fee2e2 !important;
  border: 2px solid #ef4444 !important;
  color: #b91c1c !important;
  font-weight: bold;
}
.trend-cell {
  background: #e0e7ff !important;
  color: #3730a3 !important;
  font-weight: bold;
}
.section-divider {
  border: 0;
  border-top: 4px solid #6366f1;
  margin: 0;
}
    @media (max-width: 900px) {
      .main-content { padding: 12px 2px; }
      .header-bar { padding: 12px 8px; font-size: 1.1em; }
      .header-title { font-size: 1.3em; }
      .patient-info { grid-template-columns: 1fr; gap: 8px; padding: 8px; }
    }
    @media (max-width: 600px) {
      .main-content { padding: 4px 0; }
      .header-bar { padding: 8px 4px; font-size: 1em; }
      .header-title { font-size: 1em; }
      .patient-info { gap: 4px; padding: 4px; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> <!-- MISSING! -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="js/firebase.js"></script>
</head>
<body>
  <div class="header-bar">
    <span class="header-title">üë©‚Äç‚öïÔ∏è Labour Care Guide - Summary</span>
    <button class="logout-btn" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">Logout</button>
  </div>
  <div class="main-content">
    <div class="patient-info" id="patientInfo">
      <div><label>Name</label><input id="p_name" /></div>
      <div><label>Age</label><input id="p_age" /></div>
      <div><label>Parity</label><input id="p_parity" /></div>
      <div>
        <label>Labour Onset</label>
        <select id="p_onset">
          <option value="">Select...</option>
          <option value="Spontaneous">Spontaneous</option>
          <option value="Induced">Induced</option>
        </select>
      </div>
      <div><label>Active Labour Diagnosis</label><input id="p_active" type="date" /></div>
      <div><label>Ruptured Membranes</label><input id="p_membrane" type="datetime-local" /></div>
      <div><label>Risk Factors</label><input id="p_risk" /></div>
    </div>
    <div class="controls-bar">
      <button class="btn btn-primary" onclick="saveData()">üíæ Save</button>
      <a href="list.html" class="btn btn-secondary">‚¨ÖÔ∏è Back to List</a>
    </div>
    <div id="recommendationsBox"></div>
    <div class="table-responsive">
      <table id="summaryTable"></table>
    </div>
  </div>
  <script>
    const params = new URLSearchParams(window.location.search);
    const patientId = params.get("patient");
    const timeCols = Array.from({ length: 25 }, (_, i) => {
      const h = String(Math.floor(i / 2)).padStart(2, '0');
      const m = i % 2 === 0 ? "00" : "30";
      return `${h}:${m}`;
    });

    const sections = {
      "Supportive care": [
        "Companion",
        "Pain relief",
        "Oral fluid",
        "Posture"
      ],
      "Baby": [
        "Baseline FHR",
        "FHR deceleration",
        "Amniotic fluid",
        "Fetal position",
        "Caput",
        "Moulding"
      ],
      "Woman": [
        "Pulse",
        "Systolic BP",
        "Diastolic BP",
        "Temperature C",
        "Urine"
      ],
      "Labour Progress": [
        "Contractions per 10 min",
        "Duration of contractions",
        "Cervix 10",
        "Cervix 9",
        "Cervix 8",
        "Cervix 7",
        "Cervix 6",
        "Cervix 5",
        "Descent 5",
        "Descent 4",
        "Descent 3",
        "Descent 2",
        "Descent 1",
        "Descent 0"
      ],
      "Medication": [
        "Oxytocin (U/L,drops/min)",
        "Medicine",
        "IV fluids"
      ],
      "Shared Decision-Making": [
        "Assessment",
        "Plan"
      ],
      "Initials": [
        "Initials"
      ]
    };

    const dropdownOptions = {
      // Supportive care
      "Companion": ["Yes", "No","Woman Decline"],
      "Pain relief": ["Yes", "No","Woman Decline"],
      "Oral fluid": ["Yes", "No","Woman Decline"],
      "Posture": ["Mobile", "Supine"],

      // Baby
      "Baseline FHR": ["<110", "110-160", ">160"],
      "FHR deceleration": ["None", "Early", "Late", "Variable"],
      "Amniotic fluid": ["Clear", "Meconium", "Bloody", "Intact Membranes"],
      "Fetal position": ["OA", "OP", "OT"],
      "Caput": ["None", "+", "++", "+++"],
      "Moulding": ["None", "+", "++", "+++"],

      // Woman
      "Pulse": ["<60", "60-100", ">100",">120"],
      "Systolic BP": ["<90", "90-140", ">140"],
      "Diastolic BP": ["<60", "60-90", ">90"],
      "Temperature C": ["<36", "36-37.5", ">37.5"],
      "Urine": ["P-","P Trace","P1+","P2+","P3+"],

      // Labour Progress
      "Contractions per 10 min": ["<2", "2-5", ">5"],
      "Duration of contractions": ["<20s", "20-40s", ">40s"],
      "Cervix 10": ["X", "O"],
      "Cervix 9": ["X", "O"],
      "Cervix 8": ["X", "O"],
      "Cervix 7": ["X", "O"],
      "Cervix 6": ["X", "O"],
      "Cervix 5": ["X", "O"],
      "Descent 5": ["X", "O"],
      "Descent 4": ["X", "O"],
      "Descent 3": ["X", "O"],
      "Descent 2": ["X", "O"],
      "Descent 1": ["X", "O"],
      "Descent 0": ["X", "O"],

      // Medication
      "Oxytocin (U/L,drops/min)": ["None", "Started" ],
      "Medicine": ["None", "Antibiotic", "Antihypertensive", "Other"],
      "IV fluids": ["None", "Started", "Stopped"],

     

     
    };

    const alertValues = {
  // Supportive care
  "Companion": ["No"],
  "Pain relief": ["No"],
  "Oral fluid": ["No"],
  "Posture": ["Supine"],

  // Baby
  "Baseline FHR": ["<110", ">160"],
  "FHR deceleration": ["Late"],
  "Amniotic fluid": ["Meconium", "Bloody"],
  "Fetal position": ["OP", "OT"],
  "Caput": ["+++"],
  "Moulding": ["+++"],

  // Woman
  "Pulse": ["<60", ">120"],
  "Systolic BP": ["<90", ">140"],
  "Diastolic BP": ["<60", ">90"],
  "Temperature C": ["<36", ">37.5"],
  "Urine": ["P1+", "P2+", "P3+"],

  // Labour Progress
  "Contractions per 10 min": ["<2", ">5"],
  "Duration of contractions": ["<20s", ">40s"],

  // Medication, Shared Decision-Making, Initials
  // (No alerts specified in LCG for these)
};

    const recommendations = {
  "Companion": {
    "No": "Encourage presence of a companion of choice for support."
  },
  "Pain relief": {
    "No": "Assess pain and offer appropriate pain relief options."
  },
  "Oral fluid": {
    "No": "Encourage oral fluid intake unless contraindicated."
  },
  "Posture": {
    "Supine": "Encourage upright or mobile posture for comfort and progress."
  },
  "Baseline FHR": {
    "<110": "Assess for fetal distress. Prepare for immediate intervention.",
    ">160": "Assess for fetal distress. Prepare for immediate intervention."
  },
  "FHR deceleration": {
    "Late": "Reassess fetal condition. Consider immediate intervention.",
    "Variable": "Monitor closely and reassess fetal condition."
  },
  "Amniotic fluid": {
    "Meconium": "Monitor for fetal distress. Prepare for possible intervention.",
    "Bloody": "Assess for placental abruption or other complications."
  },
  "Fetal position": {
    "OP": "Monitor labour progress. Consider position change or intervention.",
    "OT": "Monitor labour progress. Consider position change or intervention."
  },
  "Caput": {
    "+++": "Monitor for obstructed labour. Consider intervention."
  },
  "Moulding": {
    "+++": "Monitor for obstructed labour. Consider intervention."
  },
  "Pulse": {
    "<60": "Assess for underlying causes. Monitor closely.",
    ">120": "Assess for infection, dehydration, pain, anxiety."
  },
  "Systolic BP": {
    "<90": "Assess for shock. Initiate appropriate management.",
    ">140": "Assess for pre-eclampsia. Initiate appropriate management."
  },
  "Diastolic BP": {
    "<60": "Assess for shock. Monitor closely.",
    ">90": "Assess for pre-eclampsia. Initiate appropriate management."
  },
  "Temperature C": {
    "<36": "Assess for hypothermia. Initiate warming measures.",
    ">37.5": "Assess for infection. Initiate appropriate management."
  },
  "Urine": {
    "P1+": "Assess for pre-eclampsia. Monitor and manage.",
    "P2+": "Assess for pre-eclampsia. Monitor and manage.",
    "P3+": "Assess for pre-eclampsia. Monitor and manage."
  },
  "Contractions per 10 min": {
    "<2": "Assess labour progress. Consider augmentation.",
    ">5": "Assess for uterine hyperstimulation. Consider tocolysis."
  },
  "Duration of contractions": {
    "<20s": "Assess labour progress. Consider augmentation.",
    ">40s": "Assess for uterine hyperstimulation. Consider tocolysis."
  }
  // Add more as per WHO manual if needed
};

    async function loadData() {
      const patientDoc = await db.collection("patients").doc(patientId).get({ source: "server" });
      if (patientDoc.exists) {
        const d = patientDoc.data();
        document.getElementById("p_name").value = d.name || "";
        document.getElementById("p_age").value = d.age || "";
        document.getElementById("p_parity").value = d.parity || "";
        document.getElementById("p_onset").value = d.labour_onset || "";
        document.getElementById("p_active").value = d.active_labour || "";
        document.getElementById("p_membrane").value = d.ruptured_membrane || "";
        document.getElementById("p_risk").value = d.risk_factors || "";
      }

      const snap = await db.collection("patients").doc(patientId).collection("records").get({ source: "server" });
      const existing = {};
      snap.forEach(doc => {
        const d = doc.data();
        existing[d.time] = d;
      });

      const table = document.getElementById("summaryTable");
      // Table header
      let header = `<tr>
        <th class="sticky" rowspan="2">Section</th>
        <th class="sticky2" rowspan="2">Field</th>
        <th colspan="${timeCols.length}" style="text-align:center;">ACTIVE FIRST STAGE</th>
      </tr>
      <tr>
        ${timeCols.map(t => `<th class="time">${t}</th>`).join("")}
      </tr>`;
      table.innerHTML = header;

      // Table body
      for (const [section, fields] of Object.entries(sections)) {
        fields.forEach((field, index) => {
          const row = document.createElement("tr");
          if (index === 0) row.className = "section-row";

          // Section cell (sticky, vertical label)
          if (index === 0) {
            const sectionCell = document.createElement("td");
            sectionCell.className = "sticky section-label";
            sectionCell.rowSpan = fields.length;
            sectionCell.textContent = section;
            row.appendChild(sectionCell);
          }
          // Field cell (sticky2)
          const label = document.createElement("td");
          label.className = "sticky2";
          label.textContent = field;
          row.appendChild(label);

          // Find the latest value and time for this field using existing data
          const { value: latestValue, time: latestTime } = getLatestValueAndTime(field, existing, timeCols);

          // Time columns
          for (const time of timeCols) {
            const key = `${time}_${field.replace(/\s+/g, "_")}`;
            const value = existing[time] && existing[time][field] ? existing[time][field] : "";
            let cellClass = "time";
            // Highlight only the latest cell if it's an alert value
            if (time === latestTime && alertValues[field] && alertValues[field].includes(latestValue)) {
              cellClass += " alert-cell";
            }
            // Highlight Labour Progress "O" or "X"
            if (
              section === "Labour Progress" &&
              (value === "O" || value === "X")
            ) {
              cellClass += " trend-cell";
            }
            const td = document.createElement("td");
            td.className = cellClass;
            if (dropdownOptions[field]) {
              const select = document.createElement("select");
              select.name = key;
              // Add blank option first
              const blankOption = document.createElement("option");
              blankOption.value = "";
              blankOption.textContent = "";
              select.appendChild(blankOption);
              dropdownOptions[field].forEach(opt => {
                const option = document.createElement("option");
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
              });
              select.value = value !== undefined ? value : "";
              td.appendChild(select);
            } else {
              const input = document.createElement("input");
              input.name = key;
              input.value = value;
              td.appendChild(input);
            }
            row.appendChild(td);
          }
          table.appendChild(row);
        });

        // Add thick blue divider after each section
        const dividerRow = document.createElement("tr");
        dividerRow.innerHTML = `<td colspan="${2 + timeCols.length}"><hr class="section-divider"></td>`;
        table.appendChild(dividerRow);
      }
      showRecommendations();
      document.querySelectorAll('select, input').forEach(el => {
        el.addEventListener('change', showRecommendations);
      });
    }

    function getLatestValue(field) {
  // Go through timeCols in reverse to find the latest non-empty value
  for (let i = timeCols.length - 1; i >= 0; i--) {
    const key = `${timeCols[i]}_${field.replace(/\s+/g, "_")}`;
    const el = document.getElementsByName(key)[0];
    if (el && el.value) return el.value;
  }
  return "";
}

    function getLatestValueAndTime(field, existing, timeCols) {
  for (let i = timeCols.length - 1; i >= 0; i--) {
    const time = timeCols[i];
    if (existing[time] && existing[time][field] && existing[time][field] !== "") {
      return { value: existing[time][field], time };
    }
  }
  return { value: "", time: null };
}

    function showRecommendations() {
  const recs = [];
  for (const fieldList of Object.values(sections)) {
    for (const field of fieldList) {
      const latestValue = getLatestValue(field);
      if (recommendations[field] && recommendations[field][latestValue]) {
        recs.push(`${field} (${latestValue}): ${recommendations[field][latestValue]}`);
      }
    }
  }
  const box = document.getElementById("recommendationsBox");
  if (recs.length) {
    box.innerHTML = `<div style="background:#e0e7ff;border-left:6px solid #6366f1;padding:12px;border-radius:8px;">
      <b>Recommendations:</b><ul>${recs.map(r => `<li>${r}</li>`).join("")}</ul>
    </div>`;
  } else {
    box.innerHTML = "";
  }
}

// For cell highlighting, update checkAlert to use only the latest value:
function checkAlert(field, value) {
  const latestValue = getLatestValue(field);
  return alertValues[field] && alertValues[field].includes(latestValue);
}

    async function saveData() {
      const base = db.collection("patients").doc(patientId);

      // Fetch existing patient data to preserve createdBy
      const patientDoc = await base.get();
      let createdBy = "";
      if (patientDoc.exists && patientDoc.data().createdBy) {
        createdBy = patientDoc.data().createdBy;
      }

      await base.set({
        name: document.getElementById("p_name").value,
        age: document.getElementById("p_age").value,
        parity: document.getElementById("p_parity").value,
        labour_onset: document.getElementById("p_onset").value,
        active_labour: document.getElementById("p_active").value,
        ruptured_membrane: document.getElementById("p_membrane").value,
        risk_factors: document.getElementById("p_risk").value,
        createdBy // <-- preserve createdBy!
      });

      for (const time of timeCols) {
        const data = { time, timestamp: new Date().toISOString() };
        for (const fieldList of Object.values(sections)) {
          for (const field of fieldList) {
            const key = `${time}_${field.replace(/\s+/g, "_")}`;
            const el = document.getElementsByName(key)[0];
            if (el) data[field] = el.value;
          }
        }
        await base.collection("records").doc(time).set(data);
      }
      alert("‚úÖ Saved");
    }

    loadData();
  </script>
  <script>
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) window.location.href = "login.html";
    });
  </script>
</body>
</html>