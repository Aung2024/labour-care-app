<!DOCTYPE html>
<html lang="en">
<head>
  <title>WHO Labour Care Guide - Summary</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
</head>
<body>
  <!-- Professional Header -->
  <div class="medical-header">
    <div class="header-content">
      <div class="header-left">
        <div class="app-title">üë©‚Äç‚öïÔ∏è Labour Care Guide</div>
        <div class="page-subtitle">WHO Labour Care Summary Form</div>
      </div>
      <div class="header-right">
        <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </div>

  <div class="main-container">
    <!-- Patient Information Card -->
    <div class="patient-card">
      <div class="card-header" onclick="togglePatientInfo()" style="cursor: pointer;">
        <h3><i class="fas fa-user-injured"></i> Patient Information</h3>
        <div class="toggle-icon">
          <i class="fas fa-chevron-down" id="toggleIcon"></i>
        </div>
      </div>
      <div class="patient-form" id="patientForm">
        <div class="form-row">
          <div class="form-group">
            <label for="p_name">Patient Name</label>
            <input type="text" id="p_name" class="form-control" placeholder="Enter patient name">
          </div>
          <div class="form-group">
            <label for="p_age">Age</label>
            <input type="number" id="p_age" class="form-control" placeholder="Age">
          </div>
          <div class="form-group">
            <label for="p_parity">Parity</label>
            <input type="number" id="p_parity" class="form-control" placeholder="Parity">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="p_onset">Labour Onset</label>
            <select id="p_onset" class="form-control">
              <option value="">Select onset type</option>
              <option value="Spontaneous">Spontaneous</option>
              <option value="Induced">Induced</option>
            </select>
          </div>
          <div class="form-group">
            <label for="p_active">Active Labour Diagnosis</label>
            <input type="date" id="p_active" class="form-control">
          </div>
          <div class="form-group">
            <label for="p_membrane">Ruptured Membranes</label>
            <input type="datetime-local" id="p_membrane" class="form-control">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full-width">
            <label for="p_risk">Risk Factors</label>
            <textarea id="p_risk" class="form-control" rows="2" placeholder="Enter any risk factors"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="floating-actions">
      <a href="list.html" class="floating-btn btn-back">
        <i class="fas fa-arrow-left"></i>
        <span>Back to List</span>
      </a>
      <button class="floating-btn btn-save" onclick="saveData()">
        <i class="fas fa-save"></i>
        <span>Save Progress</span>
      </button>
    </div>

    <!-- Success Message Display -->
    <div id="successMessage" class="success-message" style="display: none;">
      <i class="fas fa-check-circle"></i>
      <span>Saved Successfully</span>
    </div>

    <!-- Labour Care Summary Table -->
    <div class="summary-container">
      <div class="table-header">
        <h3><i class="fas fa-clipboard-list"></i> Labour Care Summary</h3>
        <p class="table-subtitle">Complete the form below for each time interval during active labour</p>
      </div>
      
      <!-- Supportive Care Table -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('supportiveCare')" style="cursor: pointer;">
          <h4><i class="fas fa-hands-helping"></i> Supportive Care</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleSupportiveCare"></i>
          </div>
        </div>
        <div class="table-wrapper" id="supportiveCareWrapper">
          <table class="summary-table" id="supportiveCareTable"></table>
        </div>
        <div class="table-legend">
          <small><strong>Legend:</strong> 
            Table 1: Contractions with 30-min intervals | 
            Table 2: Cervix plotting with hourly intervals | 
            Table 3: Descent plotting with hourly intervals
          </small>
        </div>
      </div>

      <!-- Baby Table -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('baby')" style="cursor: pointer;">
          <h4><i class="fas fa-baby"></i> Baby</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleBaby"></i>
          </div>
        </div>
        <div class="table-wrapper" id="babyWrapper">
          <table class="summary-table" id="babyTable"></table>
        </div>
        <div class="table-legend">
          <small><strong>Legend:</strong> 
            FHR: N=No, E=Early, L=Late, V=Variable | 
            Amniotic: I=Intact, C=Clear, M=Meconium, B=Bloody | 
            Position: A=Anterior, P=Posterior, T=Transverse | 
            Caput/Moulding: 0=None, +=Mild, ++=Moderate, +++=Severe
          </small>
        </div>
      </div>

      <!-- Woman Table -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('woman')" style="cursor: pointer;">
          <h4><i class="fas fa-female"></i> Woman</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleWoman"></i>
          </div>
        </div>
        <div class="table-wrapper" id="womanWrapper">
          <table class="summary-table" id="womanTable"></table>
        </div>
        <div class="table-legend">
          <small><strong>Legend:</strong> 
            Pulse: <60 or >120 bpm | 
            BP: SBP <90 or >140, DBP >90 mmHg | 
            Temperature: <36 or >37.5¬∞C | 
            Urine: -/- (none), P (Protein), A (Acetone) with grades -, Trace, +, ++, +++, ++++
          </small>
        </div>
      </div>

      <!-- Labour Progress Table -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('labourProgress')" style="cursor: pointer;">
          <h4><i class="fas fa-chart-line"></i> Labour Progress</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleLabourProgress"></i>
          </div>
        </div>
        <div class="table-wrapper" id="labourProgressWrapper">
          <!-- First Table: Contractions -->
          <table class="summary-table" id="contractionsTable"></table>
          
          <!-- Second Table: Cervix Plot -->
          <table class="summary-table" id="cervixPlotTable"></table>
          
          <!-- Third Table: Descent Plot -->
          <table class="summary-table" id="descentPlotTable"></table>
        </div>
        <div class="table-legend">
          <small><strong>Legend:</strong> 
            Contractions: Number inputs for frequency and duration | 
            Cervix Plot: Select "X" to plot cervical dilation progress | 
            Descent Plot: Select "O" to plot fetal descent progress
          </small>
        </div>
      </div>

      <!-- Medication Table -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('medication')" style="cursor: pointer;">
          <h4><i class="fas fa-pills"></i> Medication</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleMedication"></i>
          </div>
        </div>
        <div class="table-wrapper" id="medicationWrapper">
          <table class="summary-table" id="medicationTable"></table>
        </div>
      </div>

      <!-- Shared Decision-Making Table -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('decisionMaking')" style="cursor: pointer;">
          <h4><i class="fas fa-comments"></i> Shared Decision-Making</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleDecisionMaking"></i>
          </div>
        </div>
        <div class="table-wrapper" id="decisionMakingWrapper">
          <table class="summary-table" id="decisionMakingTable"></table>
        </div>
      </div>

      <!-- Initials Table -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('initials')" style="cursor: pointer;">
          <h4><i class="fas fa-signature"></i> Initials</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleInitials"></i>
          </div>
        </div>
        <div class="table-wrapper" id="initialsWrapper">
          <table class="summary-table" id="initialsTable"></table>
        </div>
      </div>

      <!-- Clinical Recommendations Section -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('recommendations')" style="cursor: pointer;">
          <h4><i class="fas fa-lightbulb"></i> Clinical Recommendations</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleRecommendations"></i>
          </div>
        </div>
        <div class="recommendations-container" id="recommendationsWrapper">
          <div id="recommendationsBox"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const patientId = params.get("patient");
    
    const sections = {
      "Supportive Care": [
        "Companion",
        "Pain relief", 
        "Oral fluid",
        "Posture"
      ],
      "Baby": [
        "Baseline FHR",
        "FHR deceleration",
        "Amniotic fluid",
        "Fetal position",
        "Caput",
        "Moulding"
      ],
      "Woman": [
        "Pulse",
        "Systolic BP",
        "Diastolic BP", 
        "Temperature C",
        "Urine"
      ],
      "Labour Progress": [
        "Contractions per 10 min",
        "Duration of contractions"
      ],
      "Cervix Plot": [
        "Cervix [Plot X]"
      ],
      "Descent Plot": [
        "Descent [Plot O]"
      ],
      "Medication": [
        "Oxytocin (U/L, drops/min)",
        "Medicine",
        "IV fluids"
      ],
      "Shared Decision-Making": [
        "ASSESSMENT",
        "PLAN",
        "INITIALS"
      ]
    };

    const dropdownOptions = {
      // Supportive care
      "Companion": ["Y", "N", "D"],
      "Pain relief": ["Y", "N", "D"],
      "Oral fluid": ["Y", "N", "D"],
      "Posture": ["M", "SP"],

      // Baby
      "FHR deceleration": ["N", "E", "L", "V"],
      "Amniotic fluid": ["I", "C", "M", "M+", "M++", "M+++", "B"],
      "Fetal position": ["A", "P", "T"],
      "Caput": ["0", "+", "++", "+++"],
      "Moulding": ["0", "+", "++", "+++"],

      // Woman
      "Pulse": ["<60", "60-100", ">100", ">120"],
      "Systolic BP": ["<90", "90-140", ">140"],
      "Diastolic BP": ["<60", "60-90", ">90"],
      "Temperature C": ["<36", "36-37.5", ">37.5"],
      "Urine": ["-/-", "P-", "P Trace", "P+", "P++", "P+++", "P++++", "A-", "A Trace", "A+", "A++", "A+++", "A++++"],

      // Labour Progress
      "Contractions per 10 min": ["<2", "2-5", ">5"],
      "Duration of contractions": ["<20s", "20-40s", ">40s"],
      "Cervix [Plot X]": ["", "X"],
      "Descent [Plot O]": ["", "O"],

      // Medication
      "Oxytocin (U/L, drops/min)": ["None", "Started", "Stopped"],
      "Medicine": ["None", "Started", "Stopped"],
      "IV fluids": ["None", "Started", "Stopped"]
    };

    const alertValues = {
      // Supportive care - WHO LCG values
      "Companion": ["N"], // N = No companion
      "Pain relief": ["N"], // N = No pain relief
      "Oral fluid": ["N"], // N = No oral fluid
      "Posture": ["SP"], // SP = Supine position

      // Baby - WHO LCG values
      "Baseline FHR": [], // Will be handled by number input range checking
      "FHR deceleration": ["L"], // L = Late decelerations
      "Amniotic fluid": ["M+++", "B"], // M+++ = Severe meconium, B = Bloody
      "Fetal position": ["P", "T"], // P = Posterior, T = Transverse
      "Caput": ["+++"], // +++ = Severe caput
      "Moulding": ["+++"], // +++ = Severe moulding

      // Woman - WHO LCG values
      "Pulse": [], // Will be handled by number input range checking
      "Systolic BP": [], // Will be handled by number input range checking
      "Diastolic BP": [], // Will be handled by number input range checking
      "Temperature C": [], // Will be handled by number input range checking
      "Urine": ["P+", "P++", "P+++", "P++++", "A+", "A++", "A+++", "A++++"], // Protein and Acetone alerts

      // Labour Progress - WHO LCG values
      "Contractions per 10 min": ["<2", ">5"], // Abnormal contraction frequency
      "Duration of contractions": ["<20s", ">40s"], // Abnormal contraction duration
      "Cervix [Plot X]": [], // No alerts for plotting
      "Descent [Plot O]": [] // No alerts for plotting
    };

    // WHO LCG Alert Values for each field
    const whoAlertValues = {
      // Supportive Care
      "Companion": "N", // N = No companion
      "Pain relief": "N", // N = No pain relief  
      "Oral fluid": "N", // N = No oral fluid
      "Posture": "SP", // SP = Supine position

      // Baby
      "Baseline FHR": "<110, ‚â•160", // Abnormal FHR values
      "FHR deceleration": "L", // L = Late decelerations
      "Amniotic fluid": "M+++, B", // M+++ = Meconium, B = Bloody
      "Fetal position": "P, T", // P = Posterior, T = Transverse
      "Caput": "+++", // +++ = Severe caput
      "Moulding": "+++", // +++ = Severe moulding

      // Woman
      "Pulse": "<60, ‚â•120", // Abnormal pulse values
      "Systolic BP": "<90, ‚â•140", // Abnormal BP values
      "Diastolic BP": "‚â•90", // High diastolic BP
      "Temperature C": "<36, ‚â•37.5", // Abnormal temperature
      "Urine": "P++, A++", // P++ = Proteinuria, A++ = Acetone

      // Labour Progress
      "Contractions per 10 min": "‚â§2, >5", // Abnormal contraction frequency
      "Duration of contractions": "<20, >60" // Abnormal contraction duration
    };

    // Cervix Plot values (X values)
    const cervixPlotValues = {
      "10": "", // Empty for 10cm
      "9": "‚â•2h",
      "8": "‚â•2.5h", 
      "7": "‚â•3h",
      "6": "‚â•5h",
      "5": "‚â•6h"
    };

    // Descent Plot values (O values)
    const descentPlotValues = {
      "5": "", // Empty for all descent values
      "4": "",
      "3": "",
      "2": "",
      "1": "",
      "0": ""
    };

    const recommendations = {
      "Companion": {
        "N": "Encourage presence of a companion of choice for support."
      },
      "Pain relief": {
        "N": "Assess pain and offer appropriate pain relief options."
      },
      "Oral fluid": {
        "N": "Encourage oral fluid intake unless contraindicated."
      },
      "Posture": {
        "SP": "Encourage upright or mobile posture for comfort and progress."
      },
      "Baseline FHR": {
        "<110": "Assess for fetal distress. Prepare for immediate intervention.",
        ">160": "Assess for fetal distress. Prepare for immediate intervention."
      },
      "FHR deceleration": {
        "L": "Reassess fetal condition. Consider immediate intervention.",
        "V": "Monitor closely and reassess fetal condition."
      },
      "Amniotic fluid": {
        "M+++": "Monitor for fetal distress. Prepare for possible intervention.",
        "B": "Assess for placental abruption or other complications."
      },
      "Fetal position": {
        "P": "Monitor labour progress. Consider position change or intervention.",
        "T": "Monitor labour progress. Consider position change or intervention."
      },
      "Caput": {
        "+++": "Monitor for obstructed labour. Consider intervention."
      },
      "Moulding": {
        "+++": "Monitor for obstructed labour. Consider intervention."
      },
      "Pulse": {
        "<60": "Assess for underlying causes. Monitor closely.",
        ">120": "Assess for infection, dehydration, pain, anxiety."
      },
      "Systolic BP": {
        "<90": "Assess for shock. Initiate appropriate management.",
        ">140": "Assess for pre-eclampsia. Initiate appropriate management."
      },
      "Diastolic BP": {
        ">90": "Assess for pre-eclampsia. Initiate appropriate management."
      },
      "Temperature C": {
        "<36": "Assess for hypothermia. Initiate warming measures.",
        ">37.5": "Assess for infection. Initiate appropriate management."
      },
      "Urine": {
        "P1+": "Assess for pre-eclampsia. Monitor and manage.",
        "P2+": "Assess for pre-eclampsia. Monitor and manage.",
        "P3+": "Assess for pre-eclampsia. Monitor and manage."
      },
      "Contractions per 10 min": {
        "<2": "Assess labour progress. Consider augmentation.",
        ">5": "Assess for uterine hyperstimulation. Consider tocolysis."
      },
      "Duration of contractions": {
        "<20s": "Assess labour progress. Consider augmentation.",
        ">40s": "Assess for uterine hyperstimulation. Consider tocolysis."
      }
    };

    async function loadData() {
      try {
        // Get current user and their Firestore profile
        const user = firebase.auth().currentUser;
        if (!user) {
          document.body.innerHTML = '<div class="alert alert-danger">Not authenticated.</div>';
          return;
        }
        
        // Fetch user profile
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (!userDoc.exists) {
          document.body.innerHTML = '<div class="alert alert-danger">User profile not found.</div>';
          return;
        }
        const userData = userDoc.data();

        // Get patient document
        const patientDoc = await db.collection("patients").doc(patientId).get({ source: "server" });
        if (!patientDoc.exists) {
          document.body.innerHTML = '<div class="alert alert-danger">Patient not found.</div>';
          return;
        }
        const d = patientDoc.data();

        // Access control: Super Admin always allowed, TMO if township matches, Midwife if createdBy matches
        let allowed = false;
        
        if (userData.role === "Super Admin" || userData.role === "admin") {
          allowed = true;
        } else if (userData.role === "TMO") {
          // TMO can access if township matches (handle cases where township might be undefined)
          const patientTownship = d.township || "";
          const userTownship = userData.township || "";
          if (patientTownship && userTownship && patientTownship === userTownship) {
            allowed = true;
          }
        } else if (userData.role === "Midwife" || userData.role === "midwife") {
          // Midwife can access if they created the patient
          if (d.createdBy === user.uid) {
            allowed = true;
          }
        }

        if (!allowed) {
          // Better error message based on role
          let errorMessage = "";
          if (userData.role === "TMO") {
            errorMessage = `Access Denied: You can only access patients in your township (${userData.township || 'undefined'}). This patient is in township: ${d.township || 'undefined'}.`;
          } else if (userData.role === "Midwife" || userData.role === "midwife") {
            errorMessage = `Access Denied: You can only access patients you created. This patient was created by: ${d.createdBy || 'unknown'}.`;
          } else {
            errorMessage = `Access Denied: You do not have permission to view this patient record. Please contact your administrator.`;
          }
          
          document.body.innerHTML = `
            <div class="alert alert-danger">
              <h4>Access Denied</h4>
              <p><strong>Reason:</strong> ${errorMessage}</p>
              <hr>
              <a href="list.html" class="btn btn-primary">‚Üê Back to Patient List</a>
            </div>
          `;
          return;
        }

        // Populate patient info
        document.getElementById("p_name").value = d.name || "";
        document.getElementById("p_age").value = d.age || "";
        document.getElementById("p_parity").value = d.parity || "";
        document.getElementById("p_onset").value = d.labour_onset || "";
        document.getElementById("p_active").value = d.active_labour || "";
        document.getElementById("p_membrane").value = d.ruptured_membrane || "";
        document.getElementById("p_risk").value = d.risk_factors || "";

        // Load records
        const snap = await db.collection("patients").doc(patientId).collection("records").get({ source: "server" });
        const existing = {};
        snap.forEach(doc => {
          const d = doc.data();
          existing[d.time] = d;
        });

        // Generate the summary table
        generateSummaryTable(existing);
        showRecommendations();
        
        // Add event listeners for form changes
        document.querySelectorAll('select, input').forEach(el => {
          el.addEventListener('change', showRecommendations);
        });
      } catch (error) {
        console.error("Error loading data:", error);
        document.body.innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
      }
    }

    function generateSummaryTable(existing) {
      // Clear existing tables
      document.getElementById("supportiveCareTable").innerHTML = "";
      document.getElementById("babyTable").innerHTML = "";
      document.getElementById("womanTable").innerHTML = "";
      document.getElementById("contractionsTable").innerHTML = "";
      document.getElementById("cervixPlotTable").innerHTML = "";
      document.getElementById("descentPlotTable").innerHTML = "";
      document.getElementById("medicationTable").innerHTML = "";
      document.getElementById("decisionMakingTable").innerHTML = "";
      document.getElementById("initialsTable").innerHTML = ""; // Clear initials table

      // Generate each section table
      generateSectionTable("Supportive Care", sections["Supportive Care"], "supportiveCareTable", existing);
      generateSectionTable("Baby", sections["Baby"], "babyTable", existing);
      generateSectionTable("Woman", sections["Woman"], "womanTable", existing);
      generateContractionsTable("contractionsTable", existing);
      generateCervixPlotTable("cervixPlotTable", existing);
      generateDescentPlotTable("descentPlotTable", existing);
      generateSectionTable("Medication", sections["Medication"], "medicationTable", existing);
      generateSectionTable("Shared Decision-Making", sections["Shared Decision-Making"], "decisionMakingTable", existing);
      generateInitialsTable("initialsTable", existing); // Generate initials table
      
      // Add event listeners for form changes
      addFormEventListeners();
      
      // Highlight any existing alert values after tables are generated
      setTimeout(() => {
        const allSelects = document.querySelectorAll('select');
        const allNumberInputs = document.querySelectorAll('input[type="number"]');
        
        allSelects.forEach(select => checkAndHighlightAlert(select));
        allNumberInputs.forEach(input => checkAndHighlightAlert(input));
      }, 100);
    }

    function generateSectionTable(sectionName, fields, tableId, existing) {
      const table = document.getElementById(tableId);
      
      // Create table header
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      
      // Field header
      const fieldHeader = document.createElement("th");
      fieldHeader.className = "field-header sticky-field";
      fieldHeader.textContent = "Field";
      headerRow.appendChild(fieldHeader);
      
      // Alert header
      const alertHeader = document.createElement("th");
      alertHeader.className = "alert-header sticky-alert";
      alertHeader.textContent = "Alert";
      headerRow.appendChild(alertHeader);
      
      // Time headers
      timeCols.forEach(time => {
        const timeHeader = document.createElement("th");
        timeHeader.className = "time-header";
        timeHeader.textContent = time;
        headerRow.appendChild(timeHeader);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create table body
      const tbody = document.createElement("tbody");
      
      fields.forEach(field => {
        const row = document.createElement("tr");
        row.className = "field-row";
        
        // Field cell (sticky)
        const fieldCell = document.createElement("td");
        fieldCell.className = "field-cell sticky-field";
        fieldCell.textContent = field;
        row.appendChild(fieldCell);
        
        // Alert cell (sticky) - Use WHO LCG values
        const alertCell = document.createElement("td");
        alertCell.className = "alert-cell sticky-alert";
        const alertValue = whoAlertValues[field] || "";
        alertCell.innerHTML = `<span class="alert-indicator">${alertValue}</span>`;
        row.appendChild(alertCell);
        
        // Time cells
        timeCols.forEach((time, index) => {
          const key = `${time}_${field.replace(/\s+/g, "_")}`;
          const value = existing[time] && existing[time][field] ? existing[time][field] : "";
          
          const timeCell = document.createElement("td");
          timeCell.className = "time-cell";
          
          // Add stage divider after 12 hours (24 time columns)
          if (index === 24) {
            timeCell.innerHTML = '<div class="stage-divider-cell">SECOND STAGE</div>';
            timeCell.className = "time-cell stage-divider-cell";
          } else {
            // Special handling for number input fields
            if (field === "Baseline FHR" || field === "Pulse" || field === "Systolic BP" || field === "Diastolic BP" || field === "Temperature C") {
              const input = document.createElement("input");
              input.name = key;
              input.type = "number";
              input.className = "form-control form-control-sm";
              
              // Set appropriate ranges for each field
              if (field === "Baseline FHR") {
                input.min = "50";
                input.max = "200";
                input.step = "1";
              } else if (field === "Pulse") {
                input.min = "40";
                input.max = "200";
                input.step = "1";
              } else if (field === "Systolic BP") {
                input.min = "60";
                input.max = "200";
                input.step = "1";
              } else if (field === "Diastolic BP") {
                input.min = "40";
                input.max = "120";
                input.step = "1";
              } else if (field === "Temperature C") {
                input.min = "30";
                input.max = "42";
                input.step = "0.1";
              }
              
              input.value = value;
              timeCell.appendChild(input);
            } else if (dropdownOptions[field]) {
              const select = document.createElement("select");
              select.name = key;
              select.className = "form-select form-select-sm";
              
              // Add blank option first
              const blankOption = document.createElement("option");
              blankOption.value = "";
              blankOption.textContent = "";
              select.appendChild(blankOption);
              
              dropdownOptions[field].forEach(opt => {
                const option = document.createElement("option");
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
              });
              
              select.value = value !== undefined ? value : "";
              timeCell.appendChild(select);
            } else {
              const input = document.createElement("input");
              input.name = key;
              input.type = "text";
              input.className = "form-control form-control-sm";
              input.value = value;
              timeCell.appendChild(input);
            }
          }
          
          row.appendChild(timeCell);
        });
        
        tbody.appendChild(row);
      });
      
      table.appendChild(tbody);
    }

    function addFormEventListeners() {
      // Add event listeners to all select and input elements
      document.querySelectorAll('select, input').forEach(el => {
        el.addEventListener('change', showRecommendations);
        el.addEventListener('input', showRecommendations);
      });
    }

    function getLatestValue(field) {
      // Go through timeCols in reverse to find the latest non-empty value
      for (let i = timeCols.length - 1; i >= 0; i--) {
        const key = `${timeCols[i]}_${field.replace(/\s+/g, "_")}`;
        const el = document.getElementsByName(key)[0];
        if (el && el.value) return el.value;
      }
      return "";
    }

    function showRecommendations() {
      const recs = [];
      for (const fieldList of Object.values(sections)) {
        for (const field of fieldList) {
          const latestValue = getLatestValue(field);
          if (recommendations[field] && recommendations[field][latestValue]) {
            recs.push(`${field} (${latestValue}): ${recommendations[field][latestValue]}`);
          }
        }
      }
      
      const box = document.getElementById("recommendationsBox");
      if (recs.length) {
        box.innerHTML = `
          <div class="recommendations-content">
            <div class="recommendations-header">
              <i class="fas fa-lightbulb"></i>
              <span>Clinical Recommendations</span>
            </div>
            <div class="recommendations-list">
              ${recs.map(r => `<div class="recommendation-item">${r}</div>`).join("")}
            </div>
          </div>
        `;
      } else {
        box.innerHTML = "";
      }
    }

    async function saveData() {
      try {
        const base = db.collection("patients").doc(patientId);

        // Fetch existing patient data to preserve createdBy
        const patientDoc = await base.get();
        let createdBy = "";
        if (patientDoc.exists && patientDoc.data().createdBy) {
          createdBy = patientDoc.data().createdBy;
        }

        // Save patient info
        await base.set({
          name: document.getElementById("p_name").value,
          age: document.getElementById("p_age").value,
          parity: document.getElementById("p_parity").value,
          labour_onset: document.getElementById("p_onset").value,
          active_labour: document.getElementById("p_active").value,
          ruptured_membrane: document.getElementById("p_membrane").value,
          risk_factors: document.getElementById("p_risk").value,
          createdBy
        });

        // Save time-based records from all tables
        for (const time of timeCols) {
          const data = { time, timestamp: new Date().toISOString() };
          
          // Collect data from all section tables
          for (const fieldList of Object.values(sections)) {
            for (const field of fieldList) {
              const key = `${time}_${field.replace(/\s+/g, "_")}`;
              const el = document.getElementsByName(key)[0];
              if (el) {
                data[field] = el.value;
              }
            }
          }

          // Save to Firestore
          await base.collection("records").doc(time).set(data);
        }

        showSaveSuccess();
      } catch (error) {
        console.error("Error saving data:", error);
        showSaveError(error.message);
      }
    }

    // Show save success message
    function showSaveSuccess() {
      const successMessage = document.getElementById('successMessage');
      if (successMessage) {
        successMessage.style.display = 'flex';
        successMessage.style.zIndex = '9999';
        console.log('Success message displayed');
        
        setTimeout(() => {
          successMessage.style.display = 'none';
        }, 3000);
      } else {
        console.error('Success message element not found');
      }
    }

    // Show save error message
    function showSaveError(errorMessage) {
      const successMessage = document.getElementById('successMessage');
      if (successMessage) {
        successMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Save Error: ' + errorMessage + '</span>';
        successMessage.className = 'success-message error-message';
        successMessage.style.display = 'flex';
        successMessage.style.zIndex = '9999';
        
        setTimeout(() => {
          successMessage.style.display = 'none';
          successMessage.innerHTML = '<i class="fas fa-check-circle"></i><span>Saved Successfully</span>';
          successMessage.className = 'success-message';
        }, 5000);
        
        console.error("Save error:", errorMessage);
      } else {
        console.error('Success message element not found');
      }
    }

    // Generate time columns including Second Stage
    function generateTimeColumns() {
      const timeCols = [];
      
      // First Stage: 00:00 to 12:00 (25 columns: 00:00, 00:30, 01:00, ..., 12:00)
      for (let hour = 0; hour <= 12; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          timeCols.push(timeStr);
        }
      }
      
      // Second Stage: 12:30 to 15:30 (7 columns: 12:30, 13:00, 13:30, 14:00, 14:30, 15:00, 15:30)
      for (let hour = 12; hour <= 15; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          if (hour === 12 && minute === 0) continue; // Skip 12:00 as it's already in first stage
          const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          timeCols.push(timeStr);
        }
      }
      
      return timeCols;
    }

    // Initialize time columns
    const timeCols = generateTimeColumns();

    // Load data when page loads
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "login.html";
      } else {
        // Only load data after user is authenticated
        loadData();
      }
    });

    // Populate time columns in the header
    function populateTimeColumns() {
      const timeColumnsContainer = document.getElementById('timeColumns');
      if (timeColumnsContainer) {
        timeColumnsContainer.innerHTML = timeCols.map(t => 
          `<div class="time-column">${t}</div>`
        ).join('');
      }
    }

    // Call this after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      populateTimeColumns();
      initializeFoldedSections(); // Initialize all sections as folded
      addAlertHighlighting(); // Add alert highlighting functionality
    });

    // Toggle patient information section
    function togglePatientInfo() {
      const patientForm = document.getElementById('patientForm');
      const toggleIcon = document.getElementById('toggleIcon');
      
      if (patientForm.style.display === 'none') {
        patientForm.style.display = 'block';
        toggleIcon.className = 'fas fa-chevron-down';
      } else {
        patientForm.style.display = 'none';
        toggleIcon.className = 'fas fa-chevron-right';
      }
    }

    // Toggle section visibility
    function toggleSection(sectionId) {
      const wrapper = document.getElementById(`${sectionId}Wrapper`);
      const toggleIcon = document.getElementById(`toggle${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);
      
      if (wrapper.style.display === 'none') {
        wrapper.style.display = 'block';
        toggleIcon.className = 'fas fa-chevron-down';
      } else {
        wrapper.style.display = 'none';
        toggleIcon.className = 'fas fa-chevron-right';
      }
    }

    // Labour Progress Table - Fixed structure based on HTML file
    function generateContractionsTable(tableId, existing) {
      const table = document.getElementById(tableId);
      
      // Create table header
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      
      // First column: Field
      const fieldHeader = document.createElement("th");
      fieldHeader.className = "field-header sticky-field";
      fieldHeader.textContent = "Field";
      headerRow.appendChild(fieldHeader);
      
      // Second column: Alert
      const alertHeader = document.createElement("th");
      alertHeader.className = "alert-header sticky-alert";
      alertHeader.textContent = "Alert";
      headerRow.appendChild(alertHeader);
      
      // Time headers (30-minute intervals for contractions)
      timeCols.forEach(time => {
        const timeHeader = document.createElement("th");
        timeHeader.className = "time-header";
        timeHeader.textContent = time;
        headerRow.appendChild(timeHeader);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create table body
      const tbody = document.createElement("tbody");
      
      // First row: Contractions per 10 min
      const contractionsRow = document.createElement("tr");
      
      // Field cell
      const contractionsFieldCell = document.createElement("td");
      contractionsFieldCell.className = "field-cell sticky-field";
      contractionsFieldCell.textContent = "Contractions per 10 min";
      contractionsRow.appendChild(contractionsFieldCell);
      
      // Alert cell
      const contractionsAlertCell = document.createElement("td");
      contractionsAlertCell.className = "alert-cell sticky-alert";
      contractionsAlertCell.textContent = "‚â§2, >5";
      contractionsRow.appendChild(contractionsAlertCell);
      
      // Time cells
      timeCols.forEach((time, index) => {
        const timeCell = document.createElement("td");
        timeCell.className = "time-cell";
        
        const key = `Labour_Progress_Contractions_per_10_min_${time}`;
        const value = existing[key] || "";
        
        const input = document.createElement("input");
        input.name = key;
        input.type = "number";
        input.className = "form-control form-control-sm";
        input.min = "0";
        input.max = "10";
        input.step = "1";
        input.value = value;
        timeCell.appendChild(input);
        contractionsRow.appendChild(timeCell);
      });
      
      tbody.appendChild(contractionsRow);
      
      // Second row: Duration of contractions
      const durationRow = document.createElement("tr");
      
      // Field cell
      const durationFieldCell = document.createElement("td");
      durationFieldCell.className = "field-cell sticky-field";
      durationFieldCell.textContent = "Duration of contractions";
      durationRow.appendChild(durationFieldCell);
      
      // Alert cell
      const durationAlertCell = document.createElement("td");
      durationAlertCell.className = "alert-cell sticky-alert";
      durationAlertCell.textContent = "<20, >60";
      durationRow.appendChild(durationAlertCell);
      
      // Time cells
      timeCols.forEach((time, index) => {
        const timeCell = document.createElement("td");
        timeCell.className = "time-cell";
        
        const key = `Labour_Progress_Duration_of_contractions_${time}`;
        const value = existing[key] || "";
        
        const input = document.createElement("input");
        input.name = key;
        input.type = "number";
        input.className = "form-control form-control-sm";
        input.min = "0";
        input.max = "120";
        input.step = "5";
        input.value = value;
        timeCell.appendChild(input);
        durationRow.appendChild(timeCell);
      });
      
      tbody.appendChild(durationRow);
      table.appendChild(tbody);
    }

    function generateCervixPlotTable(tableId, existing) {
      const table = document.getElementById(tableId);
      
      // Create table header
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      
      // Cervix [Plot X] header (merged cell spanning all rows)
      const cervixHeader = document.createElement("th");
      cervixHeader.className = "cervix-header";
      cervixHeader.textContent = "Cervix [Plot X]";
      cervixHeader.rowSpan = 7; // Span all 6 data rows + 1 header row
      headerRow.appendChild(cervixHeader);
      
      // First column: Field
      const fieldHeader = document.createElement("th");
      fieldHeader.className = "field-header sticky-field";
      fieldHeader.textContent = "Field";
      headerRow.appendChild(fieldHeader);
      
      // Second column: Alert
      const alertHeader = document.createElement("th");
      alertHeader.className = "alert-header sticky-alert";
      alertHeader.textContent = "Alert";
      headerRow.appendChild(alertHeader);
      
      // Time headers (hourly intervals for plotting)
      const plotTimeCols = ["00:00", "01:00", "02:00", "03:00", "04:00", "05:00", "06:00", "07:00", "08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00"];
      
      plotTimeCols.forEach(time => {
        const timeHeader = document.createElement("th");
        timeHeader.className = "time-header";
        timeHeader.textContent = time;
        headerRow.appendChild(timeHeader);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create table body
      const tbody = document.createElement("tbody");
      
      // Cervix Plot rows (10, 9, 8, 7, 6, 5)
      const cervixValues = ["10", "9", "8", "7", "6", "5"];
      const timeLabels = ["", "‚â• 2h", "‚â• 2.5h", "‚â• 3h", "‚â• 5h", "‚â• 6h"];
      
      cervixValues.forEach((cervix, index) => {
        const row = document.createElement("tr");
        
        // Field cell (cervix value)
        const fieldCell = document.createElement("td");
        fieldCell.className = "field-cell sticky-field";
        fieldCell.textContent = cervix;
        row.appendChild(fieldCell);
        
        // Alert cell (time label)
        const alertCell = document.createElement("td");
        alertCell.className = "alert-cell sticky-alert";
        alertCell.textContent = timeLabels[index];
        row.appendChild(alertCell);
        
        // Time cells
        plotTimeCols.forEach((time, timeIndex) => {
          const timeCell = document.createElement("td");
          timeCell.className = "time-cell";
          
          const key = `Labour_Progress_Cervix_Plot_X_${cervix}_${time}`;
          const value = existing[key] || "";
          
          const select = document.createElement("select");
          select.name = key;
          select.className = "form-select form-select-sm plot-select";
          
          // Add blank option first
          const blankOption = document.createElement("option");
          blankOption.value = "";
          blankOption.textContent = "";
          select.appendChild(blankOption);
          
          // Add X option
          const xOption = document.createElement("option");
          xOption.value = "X";
          xOption.textContent = "X";
          select.appendChild(xOption);
          
          select.value = value;
          timeCell.appendChild(select);
          row.appendChild(timeCell);
        });
        
        tbody.appendChild(row);
      });
      
      table.appendChild(tbody);
    }

    function generateDescentPlotTable(tableId, existing) {
      const table = document.getElementById(tableId);
      
      // Create table header
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      
      // Descent [Plot O] header (merged cell spanning all rows)
      const descentHeader = document.createElement("th");
      descentHeader.className = "descent-header";
      descentHeader.textContent = "Descent [Plot O]";
      descentHeader.rowSpan = 7; // Span all 6 data rows + 1 header row
      headerRow.appendChild(descentHeader);
      
      // First column: Field
      const fieldHeader = document.createElement("th");
      fieldHeader.className = "field-header sticky-field";
      fieldHeader.textContent = "Field";
      headerRow.appendChild(fieldHeader);
      
      // Second column: Alert
      const alertHeader = document.createElement("th");
      alertHeader.className = "alert-header sticky-alert";
      alertHeader.textContent = "Alert";
      headerRow.appendChild(alertHeader);
      
      // Time headers (hourly intervals for plotting)
      const plotTimeCols = ["00:00", "01:00", "02:00", "03:00", "04:00", "05:00", "06:00", "07:00", "08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00"];
      
      plotTimeCols.forEach(time => {
        const timeHeader = document.createElement("th");
        timeHeader.className = "time-header";
        timeHeader.textContent = time;
        headerRow.appendChild(timeHeader);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create table body
      const tbody = document.createElement("tbody");
      
      // Descent Plot rows (5, 4, 3, 2, 1, 0)
      const descentValues = ["5", "4", "3", "2", "1", "0"];
      
      descentValues.forEach((descent, index) => {
        const row = document.createElement("tr");
        
        // Field cell (descent value)
        const fieldCell = document.createElement("td");
        fieldCell.className = "field-cell sticky-field";
        fieldCell.textContent = descent;
        row.appendChild(fieldCell);
        
        // Alert cell (empty for descent)
        const alertCell = document.createElement("td");
        alertCell.className = "alert-cell sticky-alert";
        alertCell.textContent = "";
        row.appendChild(alertCell);
        
        // Time cells
        plotTimeCols.forEach((time, timeIndex) => {
          const timeCell = document.createElement("td");
          timeCell.className = "time-cell";
          
          const key = `Labour_Progress_Descent_Plot_O_${descent}_${time}`;
          const value = existing[key] || "";
          
          const select = document.createElement("select");
          select.name = key;
          select.className = "form-select form-select-sm plot-select";
          
          // Add blank option first
          const blankOption = document.createElement("option");
          blankOption.value = "";
          blankOption.textContent = "";
          select.appendChild(blankOption);
          
          // Add O option
          const oOption = document.createElement("option");
          oOption.value = "O";
          oOption.textContent = "O";
          select.appendChild(oOption);
          
          select.value = value;
          timeCell.appendChild(select);
          row.appendChild(timeCell);
        });
        
        tbody.appendChild(row);
      });
      
      table.appendChild(tbody);
    }

    // Function to check and highlight alert values
    function checkAndHighlightAlert(element) {
      const value = element.value;
      if (!value) {
        // Clear highlighting if no value
        element.classList.remove('alert-value');
        element.style.border = '';
        element.style.backgroundColor = '';
        return;
      }

      const nameParts = element.name.split('_');
      if (nameParts.length >= 2) {
        // Reconstruct the field name properly, handling spaces
        const field = nameParts.slice(1).join('_').replace(/_/g, ' ');
        
        console.log('Checking alert for:', field, 'value:', value, 'element name:', element.name); // Debug log
        
        let isAlert = false;
        
        // Simple alert checking based on field and value
        if (field === "Baseline FHR" && element.type === "number") {
          const fhrValue = parseFloat(value);
          if (!isNaN(fhrValue) && (fhrValue < 110 || fhrValue > 160)) {
            isAlert = true;
          }
        } else if (field === "Pulse" && element.type === "number") {
          const pulseValue = parseFloat(value);
          if (!isNaN(pulseValue) && (pulseValue < 60 || pulseValue > 120)) {
            isAlert = true;
          }
        } else if (field === "Systolic BP" && element.type === "number") {
          const bpValue = parseFloat(value);
          if (!isNaN(bpValue) && (bpValue < 90 || bpValue > 140)) {
            isAlert = true;
          }
        } else if (field === "Diastolic BP" && element.type === "number") {
          const bpValue = parseFloat(value);
          if (!isNaN(bpValue) && bpValue > 90) {
            isAlert = true;
          }
        } else if (field === "Temperature C" && element.type === "number") {
          const tempValue = parseFloat(value);
          if (!isNaN(tempValue) && (tempValue < 36 || tempValue > 37.5)) {
            isAlert = true;
          }
        } else if (field === "Contractions per 10 min" && element.type === "number") {
          const contractionsValue = parseFloat(value);
          if (!isNaN(contractionsValue) && (contractionsValue <= 2 || contractionsValue > 5)) {
            isAlert = true;
          }
        } else if (field === "Duration of contractions" && element.type === "number") {
          const durationValue = parseFloat(value);
          if (!isNaN(durationValue) && (durationValue < 20 || durationValue > 60)) {
            isAlert = true;
          }
        } else if (field === "Cervix [Plot X]" && value === "X") {
          // No alert for plotting X
        } else if (field === "Descent [Plot O]" && value === "O") {
          // No alert for plotting O
        } else if (field === "FHR deceleration" && value === "L") {
          isAlert = true;
        } else if (field === "Amniotic fluid" && (value === "M+++" || value === "B")) {
          isAlert = true;
        } else if (field === "Fetal position" && (value === "P" || value === "T")) {
          isAlert = true;
        } else if (field === "Caput" && value === "+++") {
          isAlert = true;
        } else if (field === "Moulding" && value === "+++") {
          isAlert = true;
        } else if (field === "Companion" && value === "N") {
          isAlert = true;
        } else if (field === "Pain relief" && value === "N") {
          isAlert = true;
        } else if (field === "Oral fluid" && value === "N") {
          isAlert = true;
        } else if (field === "Posture" && value === "SP") {
          isAlert = true;
        }
        
        if (isAlert) {
          console.log('Applying alert styling to:', field, value); // Debug log
          element.classList.add('alert-value');
          element.style.border = '2px solid #dc2626';
          element.style.backgroundColor = '#fef2f2';
        } else {
          element.classList.remove('alert-value');
          element.style.border = '';
          element.style.backgroundColor = '';
        }
      }
    }

    // Add alert highlighting functionality
    function addAlertHighlighting() {
      // Add event listeners to all select elements
      document.addEventListener('change', function(e) {
        if (e.target.tagName === 'SELECT') {
          checkAndHighlightAlert(e.target);
        }
      });

      // Add event listeners to all input elements
      document.addEventListener('input', function(e) {
        if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
          checkAndHighlightAlert(e.target);
        }
      });

      // Check all existing elements on page load
      function highlightExistingAlerts() {
        const allSelects = document.querySelectorAll('select');
        const allNumberInputs = document.querySelectorAll('input[type="number"]');
        
        allSelects.forEach(select => checkAndHighlightAlert(select));
        allNumberInputs.forEach(input => checkAndHighlightAlert(input));
      }

      // Run immediately and also after a short delay to catch dynamically created elements
      highlightExistingAlerts();
      setTimeout(highlightExistingAlerts, 100);
      setTimeout(highlightExistingAlerts, 500);
    }

    // Initialize all sections as folded
    function initializeFoldedSections() {
      // Start with Patient Information folded
      document.getElementById('patientForm').style.display = 'none';
      document.getElementById('toggleIcon').className = 'fas fa-chevron-right';
      
      // Start with all section tables folded
      const sections = ['supportiveCare', 'baby', 'woman', 'labourProgress', 'medication', 'decisionMaking', 'initials', 'recommendations'];
      sections.forEach(sectionId => {
        const wrapper = document.getElementById(`${sectionId}Wrapper`);
        const toggleIcon = document.getElementById(`toggle${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);
        
        if (wrapper && toggleIcon) {
          wrapper.style.display = 'none';
          toggleIcon.className = 'fas fa-chevron-right';
        }
      });
    }

    // Generate Initials Table
    function generateInitialsTable(tableId, existing) {
      const table = document.getElementById(tableId);
      
      // Create table header
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      
      // First column: Field
      const fieldHeader = document.createElement("th");
      fieldHeader.className = "field-header sticky-field";
      fieldHeader.textContent = "Field";
      headerRow.appendChild(fieldHeader);
      
      // Second column: Alert
      const alertHeader = document.createElement("th");
      alertHeader.className = "alert-header sticky-alert";
      alertHeader.textContent = "Alert";
      headerRow.appendChild(alertHeader);
      
      // Time headers (30-minute intervals)
      timeCols.forEach(time => {
        const timeHeader = document.createElement("th");
        timeHeader.className = "time-header";
        timeHeader.textContent = time;
        headerRow.appendChild(timeHeader);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create table body
      const tbody = document.createElement("tbody");
      
      // Initials row
      const initialsRow = document.createElement("tr");
      
      // Field cell
      const fieldCell = document.createElement("td");
      fieldCell.className = "field-cell sticky-field";
      fieldCell.textContent = "INITIALS";
      initialsRow.appendChild(fieldCell);
      
      // Alert cell (empty for initials)
      const alertCell = document.createElement("td");
      alertCell.className = "alert-cell sticky-alert";
      alertCell.textContent = "";
      initialsRow.appendChild(alertCell);
      
      // Time cells
      timeCols.forEach((time, index) => {
        const timeCell = document.createElement("td");
        timeCell.className = "time-cell";
        
        const key = `Initials_${time}`;
        const value = existing[key] || "";
        
        const input = document.createElement("input");
        input.name = key;
        input.type = "text";
        input.className = "form-control form-control-sm";
        input.placeholder = "Initials";
        input.value = value;
        timeCell.appendChild(input);
        initialsRow.appendChild(timeCell);
      });
      
      tbody.appendChild(initialsRow);
      table.appendChild(tbody);
    }
  </script>
</body>
<footer class="footer">
  ¬© 2025 Labour Care App &mdash; Designed for clinical excellence
</footer>
</html>