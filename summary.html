<!DOCTYPE html>
<html>
<head>
  <title>WHO Labour Summary</title>
  <meta charset="UTF-8">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .patient-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .patient-info div { display: flex; flex-direction: column; }
    .table-responsive {
      width: 100%;
      overflow-x: auto;
      overflow-y: auto; /* Add this for vertical scroll if needed */
      max-height: 70vh; /* Optional: limit height */
      margin-top: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 600px;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 0.95em;
      background: #fff;
      text-align: center;
      vertical-align: middle;
      box-sizing: border-box;
    }
    th.sticky, td.sticky {
      position: sticky;
      left: 0;
      background: #f7f7f7;
      z-index: 3;
      width: 140px;
      min-width: 140px;
      max-width: 140px;
      text-align: left;
      font-weight: bold;
      box-shadow: 2px 0 2px -2px #ccc;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 0;
      background-clip: padding-box; /* <-- Add this */
    }
    th.sticky2, td.sticky2 {
      position: sticky;
      left: 140px; /* <-- Match the width of .sticky */
      background: #f7f7f7;
      z-index: 2;
      width: 140px;
      min-width: 140px;
      max-width: 140px;
      text-align: left;
      font-weight: normal;
      box-shadow: 2px 0 2px -2px #ccc;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-left: 0;
      background-clip: padding-box; /* <-- Add this */
    }
    th.time, td.time {
      min-width: 70px;
      max-width: 100px;
      word-break: break-word;
      white-space: normal;
    }
    .alert-cell { background-color: #f8d7da !important; }
    select, input {
      width: 100%;
      font-size: 0.95em;
      min-width: 60px;
      box-sizing: border-box;
      padding: 2px;
    }
    select {
      white-space: normal;
      max-width: 100%;
    }
    .section-label {
      writing-mode: vertical-rl;
      text-orientation: mixed;
      background: #eee;
      font-weight: bold;
      text-align: center;
      vertical-align: middle;
      min-height: 60px;
    }
    th {
      background: #f0f0f0;
      font-weight: bold;
    }
    /* Responsive styles */
    @media (max-width: 900px) {
      th, td { font-size: 0.85em; padding: 4px; }
      select, input { font-size: 0.85em; min-width: 40px; }
      th.sticky, td.sticky, th.sticky2, td.sticky2 { min-width: 80px; max-width: 100px; width: 100px; }
      th.time, td.time { min-width: 50px; max-width: 70px; }
      th.sticky2, td.sticky2 { left: 100px; }
    }
    @media (max-width: 600px) {
      th, td { font-size: 0.75em; padding: 2px; }
      select, input { font-size: 0.75em; min-width: 35px; }
      .table-responsive { margin-left: -10px; margin-right: -10px; padding-left: 5px; padding-right: 5px; }
      .patient-info { grid-template-columns: 1fr; }
      body { padding: 5px; }
      th.sticky, td.sticky, th.sticky2, td.sticky2 { min-width: 60px, max-width: 60px, width: 60px; }
      th.time, td.time { min-width: 40px, max-width: 60px; }
      th.sticky2, td.sticky2 { left: 60px; } /* <-- Match the width of .sticky */
    }
  </style>
</head>
<body>
  <h2>Labour Summary</h2>
  <div class="patient-info" id="patientInfo">
    <div><label>Name</label><input id="p_name" /></div>
    <div><label>Age</label><input id="p_age" /></div>
    <div><label>Parity</label><input id="p_parity" /></div>
    <div><label>Labour Onset</label><input id="p_onset" type="datetime-local" /></div>
    <div><label>Active Labour Diagnosis</label><input id="p_active" type="date" /></div>
    <div><label>Ruptured Membranes</label><input id="p_membrane" type="datetime-local" /></div>
    <div><label>Risk Factors</label><input id="p_risk" /></div>
  </div>
  <div class="table-responsive">
    <table id="summaryTable"></table>
  </div>
  <button onclick="saveData()">ðŸ’¾ Save</button>

  <script>
    const params = new URLSearchParams(window.location.search);
    const patientId = params.get("patient");
    const timeCols = Array.from({ length: 25 }, (_, i) => {
      const h = String(Math.floor(i / 2)).padStart(2, '0');
      const m = i % 2 === 0 ? "00" : "30";
      return `${h}:${m}`;
    });

    const sections = {
      "Supportive care": [
        "Companion",
        "Pain relief",
        "Oral fluid",
        "Posture"
      ],
      "Baby": [
        "Baseline FHR",
        "FHR deceleration",
        "Amniotic fluid",
        "Fetal position",
        "Caput",
        "Moulding"
      ],
      "Woman": [
        "Pulse",
        "Systolic BP",
        "Diastolic BP",
        "Temperature C",
        "Urine"
      ],
      "Labour Progress": [
        "Contractions per 10 min",
        "Duration of contractions",
        "Cervix 10",
        "Cervix 9",
        "Cervix 8",
        "Cervix 7",
        "Cervix 6",
        "Cervix 5",
        "Descent 4",
        "Descent 3",
        "Descent 2",
        "Descent 1"
      ],
      "Medication": [
        "Oxytocin (U/L,drops/min)",
        "Medicine",
        "IV fluids"
      ],
      "Shared Decision-Making": [
        "Assessment",
        "Plan"
      ],
      "Initials": [
        "Initials"
      ]
    };

    const dropdownOptions = {
      // Supportive care
      "Companion": ["Yes", "No","Woman Decline"],
      "Pain relief": ["Yes", "No","Woman Decline"],
      "Oral fluid": ["Yes", "No","Woman Decline"],
      "Posture": ["Mobile", "Supine"],

      // Baby
      "Baseline FHR": ["<110", "110-160", ">160"],
      "FHR deceleration": ["None", "Early", "Late", "Variable"],
      "Amniotic fluid": ["Clear", "Meconium", "Bloody", "Intact Membranes"],
      "Fetal position": ["OA", "OP", "OT"],
      "Caput": ["None", "+", "++", "+++"],
      "Moulding": ["None", "+", "++", "+++"],

      // Woman
      "Pulse": ["<60", "60-100", ">100",">120"],
      "Systolic BP": ["<90", "90-140", ">140"],
      "Diastolic BP": ["<60", "60-90", ">90"],
      "Temperature C": ["<36", "36-37.5", ">37.5"],
      "Urine": ["P-","P Trace","P1+","P2+","P3+"],

      // Labour Progress
      "Contractions per 10 min": ["<2", "2-5", ">5"],
      "Duration of contractions": ["<20s", "20-40s", ">40s"],
      "Cervix 10": ["X", "O"],
      "Cervix 9": ["X", "O"],
      "Cervix 8": ["X", "O"],
      "Cervix 7": ["X", "O"],
      "Cervix 6": ["X", "O"],
      "Cervix 5": ["X", "O"],
      "Descent 4": ["X", "O"],
      "Descent 3": ["X", "O"],
      "Descent 2": ["X", "O"],
      "Descent 1": ["X", "O"],

      // Medication
      "Oxytocin (U/L,drops/min)": ["None", "Started" ],
      "Medicine": ["None", "Antibiotic", "Antihypertensive", "Other"],
      "IV fluids": ["None", "Started", "Stopped"],

     

     
    };

    const alertValues = {
  // Supportive care
  "Companion": ["No"],
  "Pain relief": ["No"],
  "Oral fluid": ["No"],
  "Posture": ["Supine"],

  // Baby
  "Baseline FHR": ["<110", ">160"],
  "FHR deceleration": ["Late"],
  "Amniotic fluid": ["Meconium", "Bloody"],
  "Fetal position": ["OP", "OT"],
  "Caput": ["+++"],
  "Moulding": ["+++"],

  // Woman
  "Pulse": ["<60", ">120"],
  "Systolic BP": ["<90", ">140"],
  "Diastolic BP": ["<60", ">90"],
  "Temperature C": ["<36", ">37.5"],
  "Urine": ["P1+", "P2+", "P3+"],

  // Labour Progress
  "Contractions per 10 min": ["<2", ">5"],
  "Duration of contractions": ["<20s", ">40s"],

  // Medication, Shared Decision-Making, Initials
  // (No alerts specified in LCG for these)
};

    async function loadData() {
      const patientDoc = await db.collection("patients").doc(patientId).get({ source: "server" });
      if (patientDoc.exists) {
        const d = patientDoc.data();
        document.getElementById("p_name").value = d.name || "";
        document.getElementById("p_age").value = d.age || "";
        document.getElementById("p_parity").value = d.parity || "";
        document.getElementById("p_onset").value = d.labour_onset || "";
        document.getElementById("p_active").value = d.active_labour || "";
        document.getElementById("p_membrane").value = d.ruptured_membrane || "";
        document.getElementById("p_risk").value = d.risk_factors || "";
      }

      const snap = await db.collection("patients").doc(patientId).collection("records").get({ source: "server" });
      const existing = {};
      snap.forEach(doc => {
        const d = doc.data();
        existing[d.time] = d;
      });

      const table = document.getElementById("summaryTable");
      // Table header
      let header = `<tr>
        <th class="sticky" rowspan="2">Section</th>
        <th class="sticky2" rowspan="2">Field</th>
        <th colspan="${timeCols.length}" style="text-align:center;">Time</th>
      </tr>
      <tr>
        ${timeCols.map(t => `<th class="time">${t}</th>`).join("")}
      </tr>`;
      table.innerHTML = header;

      // Table body
      for (const [section, fields] of Object.entries(sections)) {
        fields.forEach((field, index) => {
          const row = document.createElement("tr");
          // Section cell (sticky, vertical label)
          if (index === 0) {
            const sectionCell = document.createElement("td");
            sectionCell.className = "sticky section-label";
            sectionCell.rowSpan = fields.length;
            sectionCell.textContent = section;
            row.appendChild(sectionCell);
          }
          // Field cell (sticky2)
          const label = document.createElement("td");
          label.className = "sticky2";
          label.textContent = field;
          row.appendChild(label);

          // Time columns
          for (const time of timeCols) {
            const key = `${time}_${field.replace(/\s+/g, "_")}`;
            const value = existing[time] && existing[time][field] ? existing[time][field] : "";
            const alert = checkAlert(field, value) ? "alert-cell time" : "time";
            const td = document.createElement("td");
            td.className = alert;
         if (dropdownOptions[field]) {
  const select = document.createElement("select");
  select.name = key;
  // Add blank option first
  const blankOption = document.createElement("option");
  blankOption.value = "";
  blankOption.textContent = "";
  select.appendChild(blankOption);
  dropdownOptions[field].forEach(opt => {
    const option = document.createElement("option");
    option.value = opt;
    option.textContent = opt;
    select.appendChild(option);
  });
  // Always set the value after all options are added
  select.value = value !== undefined ? value : "";
  td.appendChild(select);
}
            else {
              const input = document.createElement("input");
              input.name = key;
              input.value = value;
              td.appendChild(input);
            }
            row.appendChild(td);
          }
          table.appendChild(row);
        });
      }
    }

    function checkAlert(field, value) {
      return alertValues[field] && alertValues[field].includes(value);
    }

    async function saveData() {
      const base = db.collection("patients").doc(patientId);

      await base.set({
        name: document.getElementById("p_name").value,
        age: document.getElementById("p_age").value,
        parity: document.getElementById("p_parity").value,
        labour_onset: document.getElementById("p_onset").value,
        active_labour: document.getElementById("p_active").value,
        ruptured_membrane: document.getElementById("p_membrane").value,
        risk_factors: document.getElementById("p_risk").value
      });

      for (const time of timeCols) {
        const data = { time, timestamp: new Date().toISOString() };
        for (const fieldList of Object.values(sections)) {
          for (const field of fieldList) {
            const key = `${time}_${field.replace(/\s+/g, "_")}`;
            const el = document.getElementsByName(key)[0];
            if (el) data[field] = el.value;
          }
        }
        await base.collection("records").doc(time).set(data);
      }
      alert("âœ… Saved");
    }

    loadData();
  </script>
</body>
</html>