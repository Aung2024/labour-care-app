<!DOCTYPE html>
<html lang="en">
<head>
  <title>WHO Labour Care Guide - Summary</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- External CSS -->
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/summary-specific.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <!-- Custom CSS for this page -->
  <style>
    .plot-inputs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }
    
    .plot-inputs input {
      flex: 1;
    }
    
    .plot-inputs button {
      white-space: nowrap;
    }
    
    .back-button-section {
      margin: 20px 0;
    }
    
    .time-input-section {
      margin: 15px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .alert-value {
      background-color: #dc3545 !important;
      color: white !important;
    }
    
    .second-stage {
      background-color: #dcfce7 !important;
      color: #166534 !important;
    }
    
    .success-message {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      margin: 15px 0;
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 8px;
      font-weight: 500;
    }
    
    .success-message.error-message {
      background-color: #f8d7da;
      color: #721c24;
      border-color: #f5c6cb;
    }
    
    .success-message i {
      font-size: 18px;
    }
    
    .section-card {
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: #f8f9fa;
      cursor: pointer;
      border-bottom: 1px solid #e9ecef;
    }
    
    .toggle-icon {
      transition: transform 0.3s ease;
    }
    
    .table-wrapper {
      padding: 20px;
    }
    
    .action-buttons {
      text-align: center;
      margin: 30px 0;
    }
    
    .action-buttons .btn {
      margin: 0 10px;
      padding: 12px 24px;
      font-size: 16px;
    }
    
    .recommendations-section {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
  </style>
  
  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  
  <!-- Chart.js for plotting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Professional Header -->
  <div class="medical-header">
    <div class="header-content">
      <div class="header-left">
        <div class="app-title">üë©‚Äç‚öïÔ∏è Labour Care Guide</div>
        <div class="page-subtitle">WHO Labour Care Summary Form</div>
      </div>
      <div class="header-right">
        <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </div>

  <div class="main-container">
    <!-- Patient Information Card -->
    <div class="patient-card">
      <div class="card-header" onclick="togglePatientInfo()" style="cursor: pointer;">
        <h3><i class="fas fa-user-injured"></i> Patient Information</h3>
        <div class="toggle-icon">
          <i class="fas fa-chevron-down" id="toggleIcon"></i>
        </div>
      </div>
      <div class="patient-form" id="patientForm">
        <div class="form-row">
          <div class="form-group">
            <label for="p_name">Patient Name</label>
            <input type="text" id="p_name" class="form-control" placeholder="Enter patient name">
          </div>
          <div class="form-group">
            <label for="p_age">Age</label>
            <input type="number" id="p_age" class="form-control" placeholder="Age">
          </div>
          <div class="form-group">
            <label for="p_parity">Parity</label>
            <input type="number" id="p_parity" class="form-control" placeholder="Parity">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="p_onset">Labour Onset</label>
            <select id="p_onset" class="form-control">
              <option value="">Select onset type</option>
              <option value="Spontaneous">Spontaneous</option>
              <option value="Induced">Induced</option>
            </select>
          </div>
          <div class="form-group">
            <label for="p_active">Active Labour Diagnosis</label>
            <input type="date" id="p_active" class="form-control">
          </div>
          <div class="form-group">
            <label for="p_membrane">Membrane Rupture</label>
            <input type="date" id="p_membrane" class="form-control">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="p_risk">Risk Factors</label>
            <textarea id="p_risk" class="form-control" placeholder="Enter risk factors"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Starting Time Requirement -->
    <div id="startingTimeRequirement" class="starting-time-requirement" style="display: none;">
      <i class="fas fa-clock"></i>
      <strong>Please set the Active First Stage Start Time to begin data entry</strong>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="success-message" style="display: none;">
      <i class="fas fa-check-circle"></i>
      <span>Saved Successfully</span>
    </div>

    <!-- Starting Time Input -->
    <div class="time-input-section">
      <div class="form-group">
        <label for="startingTime">Active First Stage Start Time</label>
        <input type="time" id="startingTime" class="form-control" required>
      </div>
    </div>

    <!-- Second Stage Time Input -->
    <div class="time-input-section">
      <div class="form-group">
        <label for="secondStageTime">Second Stage Start Time</label>
        <input type="time" id="secondStageTime" class="form-control">
        <button class="btn btn-warning btn-sm" onclick="confirmSecondStage()">Confirm Second Stage</button>
      </div>
    </div>

    <!-- Back Button -->
    <div class="back-button-section">
      <button class="btn btn-secondary" onclick="goBack()">
        <i class="fas fa-arrow-left"></i> Back to Patient List
      </button>
    </div>

    <!-- Second Stage Card -->
    <div id="secondStageCard" class="second-stage-card" style="display: none;">
      <h4><i class="fas fa-baby"></i> Second Stage Management</h4>
      <div class="form-group">
        <label for="secondStageTime">Second Stage Start Time</label>
        <input type="time" id="secondStageTime" class="form-control">
      </div>
      <button class="btn" onclick="confirmSecondStage()">Confirm Second Stage</button>
      <div class="duration-display">
        <strong>First Stage Duration: <span id="firstStageDuration">-</span></strong>
      </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="success-message">
      <i class="fas fa-check-circle"></i>
      <span>Saved Successfully</span>
    </div>

    <!-- Main Content Sections -->
    <div class="content-sections">
      <!-- Supportive Care Section -->
      <div id="supportiveCareSection" class="section-card">
        <div class="section-header" onclick="toggleSection('supportiveCareSection')">
          <h3><i class="fas fa-hands-helping"></i> Supportive Care</h3>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="table-wrapper">
          <div id="supportiveCareTable"></div>
        </div>
      </div>

      <!-- FHR Section (Separate from Baby) -->
      <div id="fhrSection" class="section-card">
        <div class="section-header" onclick="toggleSection('fhrSection')">
          <h3><i class="fas fa-heartbeat"></i> Fetal Heart Rate</h3>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="table-wrapper">
          <div id="fhrTable"></div>
        </div>
      </div>

      <!-- Baby Section -->
      <div id="babySection" class="section-card">
        <div class="section-header" onclick="toggleSection('babySection')">
          <h3><i class="fas fa-baby"></i> Baby Assessment</h3>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="table-wrapper">
          <div id="babyTable"></div>
        </div>
      </div>

      <!-- Woman Section -->
      <div id="womanSection" class="section-card">
        <div class="section-header" onclick="toggleSection('womanSection')">
          <h3><i class="fas fa-female"></i> Woman</h3>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="table-wrapper">
          <div id="womanTable"></div>
        </div>
      </div>

      <!-- Contractions Section (Separate from Labour Progress) -->
      <div id="contractionsSection" class="section-card">
        <div class="section-header" onclick="toggleSection('contractionsSection')">
          <h3><i class="fas fa-chart-line"></i> Contractions</h3>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="table-wrapper">
          <div id="contractionsTable"></div>
        </div>
      </div>

      <!-- Plotting Charts Section -->
      <div id="plottingSection" class="section-card">
        <div class="section-header" onclick="toggleSection('plottingSection')">
          <h3><i class="fas fa-chart-area"></i> Progress Plotting</h3>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="table-wrapper">
          <div class="plotting-charts">
            <div class="chart-container">
              <h4>Cervix Dilation</h4>
              <div class="plot-inputs">
                <input type="number" id="cervixDilation" class="form-control" placeholder="Dilation (cm)" min="0" max="10" step="0.5">
                <input type="time" id="cervixTime" class="form-control">
                <button class="btn btn-primary btn-sm" onclick="addPlotPoint('cervix')">Add Point</button>
              </div>
              <canvas id="cervixChart" width="800" height="400"></canvas>
            </div>
            <div class="chart-container">
              <h4>Fetal Descent</h4>
              <div class="plot-inputs">
                <input type="number" id="fetalDescent" class="form-control" placeholder="Station (-3 to +3)" min="-3" max="3" step="0.5">
                <input type="time" id="descentTime" class="form-control">
                <button class="btn btn-primary btn-sm" onclick="addPlotPoint('descent')">Add Point</button>
              </div>
              <canvas id="descentChart" width="800" height="400"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Medication Section -->
      <div id="medicationSection" class="section-card">
        <div class="section-header" onclick="toggleSection('medicationSection')">
          <h3><i class="fas fa-pills"></i> Medication</h3>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="table-wrapper">
          <div id="medicationTable"></div>
        </div>
      </div>

      <!-- Decision Making Section -->
      <div id="decisionMakingSection" class="section-card">
        <div class="section-header" onclick="toggleSection('decisionMakingSection')">
          <h3><i class="fas fa-comments"></i> Shared Decision-Making</h3>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="table-wrapper">
          <div id="decisionMakingTable"></div>
        </div>
      </div>

      <!-- Initials Section -->
      <div id="initialsSection" class="section-card">
        <div class="section-header" onclick="toggleSection('initialsSection')">
          <h3><i class="fas fa-signature"></i> Initials</h3>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="table-wrapper">
          <div id="initialsTable"></div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn btn-primary" onclick="saveData()">
        <i class="fas fa-save"></i> Save Data
      </button>
      <button class="btn btn-success" onclick="window.print()">
        <i class="fas fa-print"></i> Print Summary
      </button>
    </div>

    <!-- Recommendations Section -->
    <div id="recommendations" class="recommendations-section">
      <!-- Recommendations will be populated here -->
    </div>
  </div>

  <footer class="footer">
    <p>&copy; 2025 Labour Care App &mdash; Designed for clinical excellence</p>
  </footer>

  <!-- Main JavaScript -->
  <script>
    // ============================================================================
    // GLOBAL VARIABLES AND DATA
    // ============================================================================
    
    let activeFirstStageStartTime = null;
    let secondStageStartTime = null;
    let firstStageDuration = null;
    let timeCols = [];
    let existing = {};

    // Section definitions
    const sections = {
      "Supportive Care": ["Companion", "Pain_Relief", "Oral_fluids", "Mobility"],
      "Baby": ["Baseline FHR", "FHR deceleration", "Amniotic fluid", "Fetal position", "Caput", "Moulding"],
      "Woman": ["Pulse", "Systolic BP", "Diastolic BP", "Temperature C", "Urine"],
      "Labour Progress": ["Contractions per 10 min", "Duration of contractions"],
      "Medication": ["Oxytocin (U/L, drops/min)", "Medicine", "IV fluids"],
      "Shared Decision-Making": ["ASSESSMENT", "PLAN", "INITIALS"]
    };

    // Dropdown options
    const dropdownOptions = {
      "Companion": ["Y", "N", "D"],
      "Pain_Relief": ["Y", "N", "D"],
      "Oral_fluids": ["Y", "N", "D"],
      "Mobility": ["M", "SP"],
      "FHR deceleration": ["N", "E", "L", "V"],
      "Amniotic fluid": ["I", "C", "M", "M+", "M++", "M+++", "B"],
      "Fetal position": ["A", "P", "T"],
      "Caput": ["0", "+", "++", "+++"],
      "Moulding": ["0", "+", "++", "+++"],
      "Pulse": ["<60", "60-100", ">100", ">120"],
      "Systolic BP": ["<90", "90-140", ">140"],
      "Diastolic BP": ["<60", "60-90", ">90"],
      "Temperature C": ["<36", "36-37.5", ">37.5"],
      "Urine": ["-/-", "P-", "P Trace", "P+", "P++", "P+++", "P++++", "A-", "A Trace", "A+", "A++", "A+++", "A++++"],
      "Contractions per 10 min": ["<2", "2-5", ">5"],
      "Duration of contractions": ["<20s", "20-40s", ">40s"],
      "Oxytocin (U/L, drops/min)": ["None", "Started", "Stopped"],
      "Medicine": ["None", "Started", "Stopped"],
      "IV fluids": ["None", "Started", "Stopped"]
    };

    // WHO Alert Values
    const whoAlertValues = {
      "Companion": "N",
      "Pain_Relief": "N", 
      "Oral_fluids": "N",
      "Mobility": "SP",
      "Baseline FHR": "110-160",
      "FHR deceleration": "L",
      "Amniotic fluid": "M+++, B",
      "Fetal position": "P, T",
      "Caput": "+++",
      "Moulding": "+++",
      "Pulse": "<60, >120",
      "Systolic BP": "<90, >140",
      "Diastolic BP": ">90",
      "Temperature C": "<36, >37.5",
      "Urine": "P++++, A++++"
    };

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    
    function getPatientIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('patient');
    }

    function checkAndHighlightAlert(element) {
      if (!element) return;
      
      const fieldName = element.name;
      const value = element.value;
      
      element.classList.remove('alert-value');
      
      if (fieldName.includes('Companion') && value === 'N') {
        element.classList.add('alert-value');
      } else if (fieldName.includes('Mobility') && value === 'SP') {
        element.classList.add('alert-value');
      } else if (fieldName.includes('Baseline_FHR')) {
        const fhr = parseFloat(value);
        if (fhr < 110 || fhr > 160) {
          element.classList.add('alert-value');
        }
      }
    }

    function showSaveSuccess() {
      const successMessage = document.getElementById('successMessage');
      if (successMessage) {
        successMessage.style.display = 'flex';
        setTimeout(() => {
          successMessage.style.display = 'none';
        }, 3000);
      }
    }

    function showSaveError(errorMessage) {
      const successMessage = document.getElementById('successMessage');
      if (successMessage) {
        successMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Save Error: ' + errorMessage + '</span>';
        successMessage.className = 'success-message error-message';
        successMessage.style.display = 'flex';
        setTimeout(() => {
          successMessage.style.display = 'none';
          successMessage.innerHTML = '<i class="fas fa-check-circle"></i><span>Saved Successfully</span>';
          successMessage.className = 'success-message';
        }, 5000);
      }
    }

    // ============================================================================
    // TIME MANAGEMENT FUNCTIONS
    // ============================================================================
    
    function generateTimeColumns() {
      timeCols = [];
      for (let hour = 0; hour <= 15; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          if (hour === 0 && minute === 0) continue;
          const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          timeCols.push(timeStr);
        }
      }
      return timeCols;
    }

    function generateDynamicTimeColumns() {
      if (!activeFirstStageStartTime) {
        console.log('No starting time set, using default time columns');
        return;
      }
      
      const startHour = parseInt(activeFirstStageStartTime.split(':')[0]);
      const startMinute = parseInt(activeFirstStageStartTime.split(':')[1]);
      
      timeCols = [];
      
      // Start from the exact starting time
      let currentHour = startHour;
      let currentMinute = startMinute;
      
      // Generate columns for 12 hours from the exact starting time
      for (let i = 0; i < 24; i++) { // 24 half-hour intervals = 12 hours
        const timeStr = `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`;
        timeCols.push(timeStr);
        
        // Move to next 30-minute interval
        currentMinute += 30;
        if (currentMinute >= 60) {
          currentMinute = 0;
          currentHour += 1;
        }
      }
      
      console.log('Generated dynamic time columns:', timeCols);
    }

    function isSecondStageTime(time) {
      if (!activeFirstStageStartTime || !secondStageStartTime) return false;
      
      const firstTime = new Date(`2000-01-01T${activeFirstStageStartTime}:00`);
      const secondTime = new Date(`2000-01-01T${secondStageStartTime}:00`);
      const checkTime = new Date(`2000-01-01T${time}:00`);
      
      return checkTime >= secondTime;
    }

    // ============================================================================
    // TABLE GENERATION FUNCTIONS
    // ============================================================================
    
    function generateSupportiveCareTable() {
      const table = document.getElementById("supportiveCareTable");
      if (!table) return;
      
      let tableHTML = `
        <div class="table-container">
          <table class="lcg-table">
            <thead>
              <tr>
                <th class="field-column">Field</th>
                <th class="alert-column">Alert</th>
                ${timeCols.map(time => `<th class="time-column ${isSecondStageTime(time) ? 'second-stage' : ''}">${time}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
      `;
      
      sections["Supportive Care"].forEach(field => {
        const fieldKey = field.replace(/\s+/g, "_");
        const alertValue = whoAlertValues[field] || "";
        const options = dropdownOptions[field] || [];
        
        tableHTML += `
          <tr>
            <td class="field-column">${field}</td>
            <td class="alert-column">${alertValue}</td>
        `;
        
        timeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${fieldKey}_${timeKey}`;
          const value = existing[key] || '';
          
          tableHTML += `
            <td class="data-cell ${isSecondStageTime(time) ? 'second-stage' : ''}">
              <select name="${key}" class="form-control" onchange="checkAndHighlightAlert(this)">
                <option value="">Select</option>
                ${options.map(option => `<option value="${option}" ${value === option ? 'selected' : ''}>${option}</option>`).join('')}
              </select>
            </td>
          `;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += `
            </tbody>
          </table>
        </div>
      `;
      
      table.innerHTML = tableHTML;
      
      // Apply alert highlighting after table generation
      setTimeout(() => {
        table.querySelectorAll('select').forEach(select => {
          if (select.value) {
            checkAndHighlightAlert(select);
          }
        });
      }, 100);
    }

    function generateBabyTable() {
      const table = document.getElementById("babyTable");
      if (!table) return;
      
      let tableHTML = `
        <div class="table-container">
          <table class="lcg-table">
            <thead>
              <tr>
                <th class="field-column">Field</th>
                <th class="alert-column">Alert</th>
                ${timeCols.map(time => `<th class="time-column ${isSecondStageTime(time) ? 'second-stage' : ''}">${time}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
      `;
      
      // Baseline FHR - number input
      tableHTML += `
        <tr>
          <td class="field-column">Baseline FHR</td>
          <td class="alert-column">110-160</td>
      `;
      
              timeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `Baseline_FHR_${timeKey}`;
          const value = existing[key] || '';
          
          tableHTML += `<td class="data-cell ${isSecondStageTime(time) ? 'second-stage' : ''}"><input type="number" name="${key}" value="${value}" class="form-control" min="60" max="200" onchange="checkAndHighlightAlert(this)"></td>`;
        });
      
      tableHTML += '</tr>';
      
      // Other baby fields - dropdowns
      const babyFields = ["FHR deceleration", "Amniotic fluid", "Fetal position", "Caput", "Moulding"];
      babyFields.forEach(field => {
        const fieldKey = field.replace(/\s+/g, "_");
        const alertValue = whoAlertValues[field] || "";
        const options = dropdownOptions[field] || [];
        
        tableHTML += `
          <tr>
            <td class="field-column">${field}</td>
            <td class="alert-column">${alertValue}</td>
        `;
        
        timeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${fieldKey}_${timeKey}`;
          const value = existing[key] || '';
          
          tableHTML += `
            <td class="data-cell ${isSecondStageTime(time) ? 'second-stage' : ''}">
              <select name="${key}" class="form-control" onchange="checkAndHighlightAlert(this)">
                <option value="">Select</option>
                ${options.map(option => `<option value="${option}" ${value === option ? 'selected' : ''}>${option}</option>`).join('')}
              </select>
            </td>
          `;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += `
            </tbody>
          </table>
        </div>
      `;
      
      table.innerHTML = tableHTML;
      
      // Apply alert highlighting after table generation
      setTimeout(() => {
        table.querySelectorAll('select, input').forEach(element => {
          if (element.value) {
            checkAndHighlightAlert(element);
          }
        });
      }, 100);
    }

    function generateWomanTable() {
      const table = document.getElementById("womanTable");
      if (!table) return;
      
      let tableHTML = `
        <div class="table-container">
          <table class="lcg-table">
            <thead>
              <tr>
                <th class="field-column">Field</th>
                <th class="alert-column">Alert</th>
                ${timeCols.map(time => `<th class="time-column ${isSecondStageTime(time) ? 'second-stage' : ''}">${time}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
      `;
      
      sections["Woman"].forEach(field => {
        const fieldKey = field.replace(/\s+/g, "_");
        const alertValue = whoAlertValues[field] || "";
        
        tableHTML += `
          <tr>
            <td class="field-column">${field}</td>
            <td class="alert-column">${alertValue}</td>
        `;
        
        timeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${fieldKey}_${timeKey}`;
          const value = existing[key] || '';
          
          tableHTML += `<td class="data-cell ${isSecondStageTime(time) ? 'second-stage' : ''}"><input type="text" name="${key}" value="${value}" class="form-control" onchange="checkAndHighlightAlert(this)"></td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += `
            </tbody>
          </table>
        </div>
      `;
      
      table.innerHTML = tableHTML;
      
      // Apply alert highlighting after table generation
      setTimeout(() => {
        table.querySelectorAll('select, input').forEach(element => {
          if (element.value) {
            checkAndHighlightAlert(element);
          }
        });
      }, 100);
    }

    function generateContractionsTable() {
      const table = document.getElementById("contractionsTable");
      if (!table) return;
      
      let tableHTML = `
        <div class="table-container">
          <table class="lcg-table">
            <thead>
              <tr>
                <th class="field-column">Field</th>
                <th class="alert-column">Alert</th>
                ${timeCols.map(time => `<th class="time-column ${isSecondStageTime(time) ? 'second-stage' : ''}">${time}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
      `;
      
      const contractionFields = ["Contractions per 10 min", "Duration of contractions"];
      contractionFields.forEach(field => {
        const fieldKey = field.replace(/\s+/g, "_");
        const alertValue = whoAlertValues[field] || "";
        
        tableHTML += `
          <tr>
            <td class="field-column">${field}</td>
            <td class="alert-column">${alertValue}</td>
        `;
        
        timeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `${fieldKey}_${timeKey}`;
          const value = existing[key] || '';
          
          tableHTML += `<td class="data-cell ${isSecondStageTime(time) ? 'second-stage' : ''}"><input type="number" name="${key}" value="${value}" class="form-control" onchange="checkAndHighlightAlert(this)"></td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += `
            </tbody>
          </table>
        </div>
      `;
      
      table.innerHTML = tableHTML;
      
      // Apply alert highlighting after table generation
      setTimeout(() => {
        table.querySelectorAll('select, input').forEach(element => {
          if (element.value) {
            checkAndHighlightAlert(element);
          }
        });
      }, 100);
    }

    function generateMedicationTable() {
      const table = document.getElementById("medicationTable");
      if (!table) return;
      
      let tableHTML = `
        <div class="table-container">
          <table class="lcg-table">
            <thead>
              <tr>
                <th class="field-column">Field</th>
                <th class="alert-column">Alert</th>
                ${timeCols.map(time => `<th class="time-column ${isSecondStageTime(time) ? 'second-stage' : ''}">${time}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
      `;
      
      const medicationFields = ["Oxytocin (U/L, drops/min)", "Medicine", "IV fluids"];
      medicationFields.forEach(field => {
        const fieldKey = field.replace(/\s+/g, "_");
        const options = dropdownOptions[field] || [];
        
        tableHTML += `
          <tr>
            <td class="field-column">${field}</td>
            <td class="alert-column">-</td>
        `;
        
        timeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `Medication_${fieldKey}_${timeKey}`;
          const value = existing[key] || '';
          
          tableHTML += `
            <td class="data-cell ${isSecondStageTime(time) ? 'second-stage' : ''}">
              <select name="${key}" class="form-control" onchange="checkAndHighlightAlert(this)">
                <option value="">Select</option>
                ${options.map(option => `<option value="${option}" ${value === option ? 'selected' : ''}>${option}</option>`).join('')}
              </select>
            </td>
          `;
        });
        
        tableHTML += '</tr>';
      });
      
      tableHTML += `
            </tbody>
          </table>
        </div>
      `;
      
      table.innerHTML = tableHTML;
      
      // Apply alert highlighting after table generation
      setTimeout(() => {
        table.querySelectorAll('select, input').forEach(element => {
          if (element.value) {
            checkAndHighlightAlert(element);
          }
        });
      }, 100);
    }

    function generateDecisionMakingTable() {
      const table = document.getElementById("decisionMakingTable");
      if (!table) return;
      
      let tableHTML = `
        <div class="table-container">
          <table class="lcg-table">
            <thead>
              <tr>
                <th class="field-column">Field</th>
                <th class="alert-column">Alert</th>
                ${timeCols.map(time => `<th class="time-column ${isSecondStageTime(time) ? 'second-stage' : ''}">${time}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
      `;
      
      // Assessment fields
      const assessmentFields = ["Pain", "Progress", "Maternal", "Fetal"];
      assessmentFields.forEach(field => {
        const fieldKey = field.replace(/\s+/g, "_");
        
        tableHTML += `
          <tr>
            <td class="field-column">ASSESSMENT - ${field}</td>
            <td class="alert-column">-</td>
        `;
        
        timeCols.forEach(time => {
          const timeKey = time.replace(':', '_');
          const key = `ASSESSMENT_${fieldKey}_${timeKey}`;
          const value = existing[key] || '';
          
          tableHTML += `<td class="data-cell ${isSecondStageTime(time) ? 'second-stage' : ''}"><input type="text" name="${key}" value="${value}" class="form-control" placeholder="Assessment" onchange="checkAndHighlightAlert(this)"></td>`;
        });
        
        tableHTML += '</tr>';
      });
      
      // Plan field
      tableHTML += `
        <tr>
          <td class="field-column">PLAN</td>
          <td class="alert-column">-</td>
      `;
      
      timeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `PLAN_${timeKey}`;
        const value = existing[key] || '';
        
        tableHTML += `<td class="data-cell ${isSecondStageTime(time) ? 'second-stage' : ''}"><input type="text" name="${key}" value="${value}" class="form-control" placeholder="Plan" onchange="checkAndHighlightAlert(this)"></td>`;
      });
      
      tableHTML += '</tr>';
      
      tableHTML += `
            </tbody>
          </table>
        </div>
      `;
      
      table.innerHTML = tableHTML;
      
      // Apply alert highlighting after table generation
      setTimeout(() => {
        table.querySelectorAll('select, input').forEach(element => {
          if (element.value) {
            checkAndHighlightAlert(element);
          }
        });
      }, 100);
    }

    function generateInitialsTable() {
      const table = document.getElementById("initialsTable");
      if (!table) return;
      
      let tableHTML = `
        <div class="table-container">
          <table class="lcg-table">
            <thead>
              <tr>
                <th class="field-column">Field</th>
                <th class="alert-column">Alert</th>
                ${timeCols.map(time => `<th class="time-column ${isSecondStageTime(time) ? 'second-stage' : ''}">${time}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="field-column">INITIALS</td>
                <td class="alert-column">-</td>
      `;
      
      timeCols.forEach(time => {
        const timeKey = time.replace(':', '_');
        const key = `INITIALS_${timeKey}`;
        const value = existing[key] || '';
        
        tableHTML += `<td class="data-cell ${isSecondStageTime(time) ? 'second-stage' : ''}"><input type="text" name="${key}" value="${value}" class="form-control" placeholder="Initials" onchange="checkAndHighlightAlert(this)"></td>`;
      });
      
      tableHTML += `
              </tr>
            </tbody>
          </table>
        </div>
      `;
      
      table.innerHTML = tableHTML;
      
      // Apply alert highlighting after table generation
      setTimeout(() => {
        table.querySelectorAll('select, input').forEach(element => {
          if (element.value) {
            checkAndHighlightAlert(element);
          }
        });
      }, 100);
    }

    function generateAllTables() {
      console.log('üîÑ Generating all tables...');
      
      generateSupportiveCareTable();
      generateBabyTable();
      generateWomanTable();
      generateContractionsTable();
      generateMedicationTable();
      generateDecisionMakingTable();
      generateInitialsTable();
      
      console.log('‚úÖ All tables generated successfully');
    }

    // ============================================================================
    // DATA LOADING AND SAVING
    // ============================================================================
    
    async function loadData() {
      try {
        const user = firebase.auth().currentUser;
        if (!user) {
          document.body.innerHTML = '<div class="alert alert-danger">Not authenticated.</div>';
          return;
        }
        
        const userDoc = await firebase.firestore().collection("users").doc(user.uid).get();
        if (!userDoc.exists) {
          document.body.innerHTML = '<div class="alert alert-danger">User profile not found.</div>';
          return;
        }
        
        const patientId = getPatientIdFromUrl();
        if (!patientId) {
          document.body.innerHTML = '<div class="alert alert-danger">Patient ID not found.</div>';
          return;
        }

        const patientDoc = await firebase.firestore().collection("patients").doc(patientId).get({ source: "server" });
        if (!patientDoc.exists) {
          document.body.innerHTML = '<div class="alert alert-danger">Patient not found.</div>';
          return;
        }
        
        const d = patientDoc.data();
        
        // Populate patient info
        document.getElementById("p_name").value = d.name || "";
        document.getElementById("p_age").value = d.age || "";
        document.getElementById("p_parity").value = d.parity || "";
        document.getElementById("p_onset").value = d.labour_onset || "";
        document.getElementById("p_active").value = d.active_labour || "";
        document.getElementById("p_membrane").value = d.ruptured_membrane || "";
        document.getElementById("p_risk").value = d.risk_factors || "";

        // Load starting time
        try {
          const startingTimeDoc = await firebase.firestore()
            .collection("patients").doc(patientId)
            .collection("records").doc("startingTime").get();
          
          if (startingTimeDoc.exists) {
            const startingData = startingTimeDoc.data();
            activeFirstStageStartTime = startingData.startingTime;
            document.getElementById("startingTime").value = activeFirstStageStartTime;
            
            generateDynamicTimeColumns();
            
            // Load existing records
            const recordsDoc = await firebase.firestore()
              .collection("patients").doc(patientId)
              .collection("records").doc("summary").get();
            
            if (recordsDoc.exists) {
              existing = recordsDoc.data();
            }
            
            generateAllTables();
            showAllTables();
            document.getElementById("startingTimeRequirement").style.display = "none";
            
          } else {
            hideAllTables();
            showStartingTimeRequirement();
          }
        } catch (error) {
          console.error("Error loading starting time data:", error);
          hideAllTables();
          showStartingTimeRequirement();
        }

        // Add event listeners
        addEventListeners();
        
      } catch (error) {
        console.error("Error loading data:", error);
        document.body.innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
      }
    }

    async function saveData() {
      try {
        const patientId = getPatientIdFromUrl();
        if (!patientId) {
          showSaveError('No patient ID found');
          return;
        }
        
        const formData = {};
        const allInputs = document.querySelectorAll('input, select');
        
        allInputs.forEach(input => {
          if (input.name && input.value) {
            formData[input.name] = input.value;
          }
        });
        
        formData.startingTime = activeFirstStageStartTime;
        formData.timestamp = firebase.firestore.FieldValue.serverTimestamp();
        formData.updatedBy = firebase.auth().currentUser?.uid || 'unknown';
        
        await firebase.firestore()
          .collection("patients")
          .doc(patientId)
          .collection("records")
          .doc("summary")
          .set(formData);
        
        console.log('‚úÖ Data saved successfully');
        showSaveSuccess();
        
      } catch (error) {
        console.error('‚ùå Error saving data:', error);
        showSaveError('Failed to save data: ' + error.message);
      }
    }

    // ============================================================================
    // UI FUNCTIONS
    // ============================================================================
    
    function addEventListeners() {
      // Starting time input
      const startingTimeInput = document.getElementById("startingTime");
      if (startingTimeInput) {
        startingTimeInput.addEventListener("change", handleStartingTimeChange);
      }
      
      // Form inputs
      document.querySelectorAll('select, input').forEach(el => {
        el.addEventListener('change', function() {
          checkAndHighlightAlert(this);
        });
      });
    }

    function handleStartingTimeChange() {
      const newTime = this.value;
      if (newTime) {
        activeFirstStageStartTime = newTime;
        generateDynamicTimeColumns();
        generateAllTables();
        showAllTables();
        document.getElementById("startingTimeRequirement").style.display = "none";
      }
    }

    function togglePatientInfo() {
      const form = document.getElementById('patientForm');
      const toggleIcon = document.getElementById('toggleIcon');
      
      if (form.style.display === 'none') {
        form.style.display = 'block';
        toggleIcon.className = 'fas fa-chevron-down';
      } else {
        form.style.display = 'none';
        toggleIcon.className = 'fas fa-chevron-right';
      }
    }

    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        const tableWrapper = section.querySelector('.table-wrapper');
        if (tableWrapper) {
          const isVisible = tableWrapper.style.display !== 'none';
          tableWrapper.style.display = isVisible ? 'none' : 'block';
          
          // Update the toggle icon
          const toggleIcon = section.querySelector('.toggle-icon i');
          if (toggleIcon) {
            toggleIcon.className = isVisible ? 'fas fa-chevron-right' : 'fas fa-chevron-down';
          }
        }
      }
    }

    function hideAllTables() {
      const sections = ['supportiveCareSection', 'babySection', 'womanSection', 'contractionsSection', 'medicationSection', 'decisionMakingSection', 'initialsSection'];
      sections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
          const tableWrapper = section.querySelector('.table-wrapper');
          if (tableWrapper) {
            tableWrapper.style.display = 'none';
          }
          // Update toggle icon to show collapsed state
          const toggleIcon = section.querySelector('.toggle-icon i');
          if (toggleIcon) {
            toggleIcon.className = 'fas fa-chevron-right';
          }
        }
      });
    }

    function showAllTables() {
      const sections = ['supportiveCareSection', 'babySection', 'womanSection', 'contractionsSection', 'medicationSection', 'decisionMakingSection', 'initialsSection'];
      sections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
          const tableWrapper = section.querySelector('.table-wrapper');
          if (tableWrapper) {
            tableWrapper.style.display = 'block';
          }
          // Update toggle icon to show expanded state
          const toggleIcon = section.querySelector('.toggleIcon i');
          if (toggleIcon) {
            toggleIcon.className = 'fas fa-chevron-down';
          }
        }
      });
    }

    function showStartingTimeRequirement() {
      const requirementDiv = document.getElementById('startingTimeRequirement');
      if (requirementDiv) {
        requirementDiv.style.display = 'block';
      }
    }

    function confirmSecondStage() {
      const secondStageTime = document.getElementById('secondStageTime').value;
      if (!secondStageTime) {
        alert('Please enter the Second Stage Start Time first');
        return;
      }
      
      if (!activeFirstStageStartTime) {
        alert('Please set the Active First Stage Start Time first');
        return;
      }
      
      // Save second stage time
      saveSecondStageData(secondStageTime);
      
      // Update colors for second stage
      updateSecondStageColors();
      
      alert('Second Stage confirmed! Time columns will now show second stage highlighting.');
    }

    function saveSecondStageData(secondStageTime) {
      const patientId = getPatientIdFromUrl();
      if (patientId) {
        firebase.firestore()
          .collection("patients").doc(patientId)
          .collection("records").doc("secondStage")
          .set({
            secondStageTime: secondStageTime,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
      }
    }

    function updateSecondStageColors() {
      // Add second-stage class to time columns and data cells
      document.querySelectorAll('.time-column').forEach((col, index) => {
        if (index >= 2) { // Skip Field and Alert columns
          const timeText = col.textContent;
          if (isSecondStageTime(timeText)) {
            col.classList.add('second-stage');
          }
        }
      });
    }

    function goBack() {
      window.location.href = 'list.html';
    }

    // ============================================================================
    // PLOTTING FUNCTIONS
    // ============================================================================
    
    let cervixData = [];
    let descentData = [];
    let cervixChart = null;
    let descentChart = null;

    function addPlotPoint(type) {
      if (type === 'cervix') {
        const dilation = document.getElementById('cervixDilation').value;
        const time = document.getElementById('cervixTime').value;
        if (dilation && time) {
          cervixData.push({ x: time, y: parseFloat(dilation) });
          updateCervixChart();
          document.getElementById('cervixDilation').value = '';
          document.getElementById('cervixTime').value = '';
        }
      } else if (type === 'descent') {
        const descent = document.getElementById('fetalDescent').value;
        const time = document.getElementById('descentTime').value;
        if (descent && time) {
          descentData.push({ x: time, y: parseFloat(descent) });
          updateDescentChart();
          document.getElementById('fetalDescent').value = '';
          document.getElementById('descentTime').value = '';
        }
      }
    }

    function updateCervixChart() {
      const ctx = document.getElementById('cervixChart').getContext('2d');
      if (cervixChart) {
        cervixChart.destroy();
      }
      
      cervixChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: cervixData.map(d => d.x),
          datasets: [{
            label: 'Cervix Dilation (cm)',
            data: cervixData.map(d => d.y),
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 10
            }
          }
        }
      });
    }

    function updateDescentChart() {
      const ctx = document.getElementById('descentChart').getContext('2d');
      if (descentChart) {
        descentChart.destroy();
      }
      
      descentChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: descentData.map(d => d.x),
          datasets: [{
            label: 'Fetal Descent (Station)',
            data: descentData.map(d => d.y),
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              min: -3,
              max: 3
            }
          }
        }
      });
    }

    function initializePlottingCharts() {
      // Initialize empty charts
      updateCervixChart();
      updateDescentChart();
    }

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    
    // Firebase auth state change listener
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        console.log('User authenticated:', user.email);
        loadData();
      } else {
        console.log('User not authenticated');
        window.location.href = 'login.html';
      }
    });

    // DOM content loaded listener
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing summary page...');
      
      // Initialize time columns
      generateTimeColumns();
      
      // Initialize patient form as collapsed
      document.getElementById('patientForm').style.display = 'none';
      document.getElementById('toggleIcon').className = 'fas fa-chevron-right';
      
      // Initialize all sections as collapsed
      const sections = ['supportiveCareSection', 'babySection', 'womanSection', 'contractionsSection', 'medicationSection', 'decisionMakingSection', 'initialsSection'];
      sections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
          const tableWrapper = section.querySelector('.table-wrapper');
          if (tableWrapper) {
            tableWrapper.style.display = 'none';
          }
          const toggleIcon = section.querySelector('.toggle-icon i');
          if (toggleIcon) {
            toggleIcon.className = 'fas fa-chevron-right';
          }
        }
      });
      
      // Initialize plotting charts
      initializePlottingCharts();
    });
  </script>
</body>
</html>
