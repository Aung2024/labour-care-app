
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WHO Labour Summary - Final</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-size: 0.8rem; }
    .scroll-wrapper { overflow-x: auto; }
    table { border-collapse: collapse; width: max-content; min-width: 100%; }
    th, td { border: 1px solid #ccc; text-align: center; padding: 2px; min-width: 80px; }
    th.sticky, td.sticky { position: sticky; left: 0; background: #fff; z-index: 1; }
    th.section, td.section { position: sticky; left: 80px; background: #f9f9f9; z-index: 1; }
    input, select { width: 100%; border: none; background: transparent; text-align: center; }
    input:focus, select:focus { outline: 1px solid #007bff; background-color: #eef; }
    .patient-info { background: #f3f3f3; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
  </style>
</head>
<body class="container-fluid py-3">
  <h4>üìù WHO Labour Care Chart</h4>
  <div id="patientInfo" class="patient-info"></div>
  <form id="summaryForm">
    <div class="scroll-wrapper">
      <table id="summaryTable">
        <thead>
          <tr>
            <th class="sticky">Section</th>
            <th class="section">Parameter</th>
<th>01:00</th><th>01:30</th><th>02:00</th><th>02:30</th><th>03:00</th><th>03:30</th><th>04:00</th><th>04:30</th><th>05:00</th><th>05:30</th><th>06:00</th><th>06:30</th><th>07:00</th><th>07:30</th><th>2nd-1h</th><th>2nd-1h.5</th><th>2nd-2h</th><th>2nd-2h.5</th><th>2nd-3h</th><th>2nd-3h.5</th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </div>
    <button type="submit" class="btn btn-primary mt-3">üíæ Save</button>
  </form>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  <script>
    const sections = {
      "Supportive Care": ["Companion", "Pain relief", "Oral fluid", "Posture"],
      "Baby": ["Baseline FHR", "FHR deceleration", "Amniotic fluid", "Fetal position", "Caput", "Moulding"],
      "Woman": ["Pulse", "Systolic BP", "Diastolic BP", "Temperature", "Urine"],
      "Labour Progress - Cervix": ["0 cm", "1 cm", "2 cm", "3 cm", "4 cm", "5 cm"],
      "Labour Progress - Descent": ["0", "1", "2", "3", "4", "5"],
      "Medication": ["Oxytocin", "Medicine", "IV fluids"],
      "Shared Decision-Making": ["Assessment", "Plan"],
      "Initials": ["Initials"]
    };

    const dropdownOptions = {
      "FHR deceleration": ["None", "Early", "Late", "Variable"],
      "Amniotic fluid": ["Clear", "Meconium", "Blood", "Absent"],
      "Fetal position": ["OA", "OP", "OT", "Unknown"],
      "Caput": ["0", "+", "++", "+++"],
      "Moulding": ["0", "+", "++", "+++"],
      "Companion": ["Yes", "No"],
      "Oral fluid": ["Yes", "No"],
      "Posture": ["Upright", "Supine", "Lateral", "Other"]
    };

    const columns = [...Array(14).keys()].map(i => {
      const h = 1 + Math.floor(i / 2);
      const m = i % 2 === 0 ? "00" : "30";
      return ("0" + h).slice(-2) + ":" + m;
    }).concat(["2nd-1h", "2nd-1.5h", "2nd-2h", "2nd-2.5h", "2nd-3h"]);

    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("patient");

    async function loadPatientInfo() {
      const doc = await db.collection("patients").doc(patientId).get();
      if (!doc.exists) return;
      const d = doc.data();
      document.getElementById("patientInfo").innerHTML = `
        <strong>Name:</strong> ${d.name || ""} |
        <strong>Age:</strong> ${d.age || ""} |
        <strong>Parity:</strong> ${d.parity || ""}<br>
        <strong>Labour Onset:</strong> ${d.labourOnset || ""} |
        <strong>Active Labour Diagnosis:</strong> ${d.activeDiagnosis || ""}<br>
        <strong>Ruptured Membranes:</strong> ${d.rupturedMembranes || ""} |
        <strong>Risk Factors:</strong> ${d.riskFactors || ""}
      `;
    }

    function buildGrid() {
      const tbody = document.getElementById("summaryBody");
      for (const [section, fields] of Object.entries(sections)) {
        fields.forEach((field, i) => {
          const row = document.createElement("tr");
          if (i === 0) {
            row.innerHTML = `<td class="sticky" rowspan="${fields.length}">${section}</td>`;
          }
          row.innerHTML += `<td class="section">${field}</td>`;
          row.innerHTML += columns.map(col => {
            const key = col + "_" + field.replace(/\s+/g, "_");
            if (dropdownOptions[field]) {
              const opts = dropdownOptions[field].map(o => `<option value="${o}">${o}</option>`).join('');
              return `<td><select name="${key}">${opts}</select></td>`;
            } else {
              return `<td><input name="${key}" /></td>`;
            }
          }).join('');
          tbody.appendChild(row);
        });
      }
    }

    async function saveData(e) {
      e.preventDefault();
      const form = new FormData(e.target);
      const records = {};
      for (const [k, v] of form.entries()) {
        const [time, field] = k.split("_", 2);
        if (!records[time]) records[time] = { timestamp: new Date().toISOString() };
        records[time][field] = v;
      }
      for (const t in records) {
        await db.collection("patients").doc(patientId).collection("records").add(records[t]);
      }
      alert("‚úÖ Saved.");
    }

    loadPatientInfo();
    buildGrid();
    document.getElementById("summaryForm").addEventListener("submit", saveData);
  </script>
</body>
</html>
