
<!DOCTYPE html>
<html>
<head>
  <title>Labour Summary - WHO Format</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    .patient-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    .patient-info div { display: flex; flex-direction: column; }

    .table-container {
      overflow-x: auto;
      border: 1px solid #ccc;
    }

    table {
      border-collapse: collapse;
      min-width: 1600px;
      table-layout: fixed;
      width: 100%;
    }

    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 5px;
      font-size: 0.85em;
    }

    .section-label {
      writing-mode: vertical-rl;
      text-orientation: mixed;
      background-color: #eee;
      font-weight: bold;
    }

    .alert-cell {
      background-color: #f8d7da !important;
    }

    select, input {
      width: 100%;
      font-size: 0.85em;
    }

    button {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>WHO Labour Care Summary</h2>

  <div class="patient-info">
    <div><label>Name</label><input id="p_name" /></div>
    <div><label>Age</label><input id="p_age" /></div>
    <div><label>Parity</label><input id="p_parity" /></div>
    <div><label>Labour Onset</label><input id="p_onset" type="datetime-local" /></div>
    <div><label>Active Labour Diagnosis</label><input id="p_active" type="date" /></div>
    <div><label>Ruptured Membranes</label><input id="p_membrane" type="datetime-local" /></div>
    <div><label>Risk Factors</label><input id="p_risk" /></div>
  </div>

  <div class="table-container">
    <table id="summaryTable"></table>
  </div>

  <button onclick="saveData()">ðŸ’¾ Save All</button>

  <script>
    const params = new URLSearchParams(window.location.search);
    const patientId = params.get("patient");

    const timeCols = Array.from({ length: 25 }, (_, i) => {
      const h = String(Math.floor(i / 2)).padStart(2, '0');
      const m = i % 2 === 0 ? "00" : "30";
      return \`\${h}:\${m}\`;
    });

    const sections = {
      "Supportive Care": ["Companion", "Pain relief", "Oral fluid", "Posture"],
      "Baby": ["Baseline FHR", "FHR deceleration", "Amniotic fluid", "Fetal position", "Caput", "Moulding"],
      "Woman": ["Pulse", "Systolic BP", "Diastolic BP", "Temperature", "Urine"],
      "Labour Progress (Cervix)": ["10", "9", "8", "7", "6", "5"],
      "Labour Progress (Descent)": ["4", "3", "2", "1"],
      "Medication": ["Oxytocin", "Medicine", "IV Fluids"],
      "Shared Decision-Making": ["Assessment", "Plan"],
      "Initials": ["Initials"]
    };

    const dropdownOptions = {
      "Companion": ["Yes", "No"],
      "Pain relief": ["None", "Given"],
      "Oral fluid": ["Yes", "No"],
      "Posture": ["Upright", "Supine"],
      "Baseline FHR": ["<110", "110-160", ">160"],
      "FHR deceleration": ["None", "Early", "Late"],
      "Amniotic fluid": ["Clear", "Meconium", "Blood stained"],
      "Fetal position": ["LOA", "ROA", "OP", "Transverse"],
      "Caput": ["None", "Mild", "Severe"],
      "Moulding": ["None", "1+", "2+", "3+"],
      "Urine": ["Clear", "Protein", "Ketones"],
      "Assessment": ["Continue", "Refer", "Urgent review"]
    };

    function checkAlert(field, value) {
      return (
        (field === "FHR deceleration" && value === "Late") ||
        (field === "Amniotic fluid" && value === "Meconium") ||
        (field === "Temperature" && value === ">38") ||
        (field === "Caput" && value === "Severe") ||
        (field === "Moulding" && value === "3+")
      );
    }

    async function loadData() {
      const doc = await db.collection("patients").doc(patientId).get();
      if (doc.exists) {
        const d = doc.data();
        document.getElementById("p_name").value = d.name || "";
        document.getElementById("p_age").value = d.age || "";
        document.getElementById("p_parity").value = d.parity || "";
        document.getElementById("p_onset").value = d.labour_onset || "";
        document.getElementById("p_active").value = d.active_labour || "";
        document.getElementById("p_membrane").value = d.ruptured_membrane || "";
        document.getElementById("p_risk").value = d.risk_factors || "";
      }

      const records = {};
      const snap = await db.collection("patients").doc(patientId).collection("records").get();
      snap.forEach(doc => {
        records[doc.id] = doc.data();
      });

      const table = document.getElementById("summaryTable");
      table.innerHTML = '<tr><th rowspan="2">Section</th><th rowspan="2">Field</th><th colspan="' + timeCols.length + '">Time</th></tr>';
      table.innerHTML += '<tr>' + timeCols.map(t => '<th>' + t + '</th>').join('') + '</tr>';

      Object.entries(sections).forEach(([section, fields]) => {
        fields.forEach((field, index) => {
          const row = document.createElement("tr");
          if (index === 0) {
            const sectionCell = document.createElement("td");
            sectionCell.rowSpan = fields.length;
            sectionCell.className = "section-label";
            sectionCell.innerText = section;
            row.appendChild(sectionCell);
          }
          const fieldCell = document.createElement("td");
          fieldCell.innerText = field;
          row.appendChild(fieldCell);

          timeCols.forEach(time => {
            const cellKey = \`\${time}_\${field.replace(/\s+/g, "_")}\`;
            const value = records[time] && records[time][field] ? records[time][field] : "";
            const alert = checkAlert(field, value) ? "alert-cell" : "";
            const td = document.createElement("td");
            td.className = alert;
            if (dropdownOptions[field]) {
              const select = document.createElement("select");
              select.name = cellKey;
              dropdownOptions[field].forEach(opt => {
                const o = document.createElement("option");
                o.value = opt;
                o.textContent = opt;
                if (value === opt) o.selected = true;
                select.appendChild(o);
              });
              td.appendChild(select);
            } else {
              const input = document.createElement("input");
              input.name = cellKey;
              input.value = value;
              td.appendChild(input);
            }
            row.appendChild(td);
          });
          table.appendChild(row);
        });
      });
    }

    async function saveData() {
      const base = db.collection("patients").doc(patientId);
      await base.set({
        name: document.getElementById("p_name").value,
        age: document.getElementById("p_age").value,
        parity: document.getElementById("p_parity").value,
        labour_onset: document.getElementById("p_onset").value,
        active_labour: document.getElementById("p_active").value,
        ruptured_membrane: document.getElementById("p_membrane").value,
        risk_factors: document.getElementById("p_risk").value
      });

      for (const time of timeCols) {
        const data = { time, timestamp: new Date().toISOString() };
        for (const [section, fields] of Object.entries(sections)) {
          for (const field of fields) {
            const key = \`\${time}_\${field.replace(/\s+/g, "_")}\`;
            const el = document.getElementsByName(key)[0];
            if (el) data[field] = el.value;
          }
        }
        await base.collection("records").doc(time).set(data);
      }

      alert("âœ… Saved successfully!");
    }

    loadData();
  </script>
</body>
</html>
