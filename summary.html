<!DOCTYPE html>
<html lang="en">
<head>
  <title>WHO Labour Care Guide - Summary</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
</head>
<body>
  <!-- Professional Header -->
  <div class="medical-header">
    <div class="header-content">
      <div class="header-left">
        <div class="app-title">üë©‚Äç‚öïÔ∏è Labour Care Guide</div>
        <div class="page-subtitle">WHO Labour Care Summary Form</div>
      </div>
      <div class="header-right">
        <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </div>

  <div class="main-container">
    <!-- Patient Information Card -->
    <div class="patient-card">
      <div class="card-header" onclick="togglePatientInfo()" style="cursor: pointer;">
        <h3><i class="fas fa-user-injured"></i> Patient Information</h3>
        <div class="toggle-icon">
          <i class="fas fa-chevron-down" id="toggleIcon"></i>
        </div>
      </div>
      <div class="patient-form" id="patientForm">
        <div class="form-row">
          <div class="form-group">
            <label for="p_name">Patient Name</label>
            <input type="text" id="p_name" class="form-control" placeholder="Enter patient name">
          </div>
          <div class="form-group">
            <label for="p_age">Age</label>
            <input type="number" id="p_age" class="form-control" placeholder="Age">
          </div>
          <div class="form-group">
            <label for="p_parity">Parity</label>
            <input type="number" id="p_parity" class="form-control" placeholder="Parity">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="p_onset">Labour Onset</label>
            <select id="p_onset" class="form-control">
              <option value="">Select onset type</option>
              <option value="Spontaneous">Spontaneous</option>
              <option value="Induced">Induced</option>
            </select>
          </div>
          <div class="form-group">
            <label for="p_active">Active Labour Diagnosis</label>
            <input type="date" id="p_active" class="form-control">
          </div>
          <div class="form-group">
            <label for="p_membrane">Ruptured Membranes</label>
            <input type="datetime-local" id="p_membrane" class="form-control">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full-width">
            <label for="p_risk">Risk Factors</label>
            <textarea id="p_risk" class="form-control" rows="2" placeholder="Enter any risk factors"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="floating-actions">
      <a href="list.html" class="floating-btn btn-back">
        <i class="fas fa-arrow-left"></i>
        <span>Back to List</span>
      </a>
      <button class="floating-btn btn-save" onclick="saveData()">
        <i class="fas fa-save"></i>
        <span>Save Progress</span>
      </button>
    </div>

    <!-- Success Message Display -->
    <div id="successMessage" class="success-message" style="display: none;">
      <i class="fas fa-check-circle"></i>
      <span>Saved Successfully</span>
    </div>

    <!-- Labour Care Summary Table -->
    <div class="summary-container">
      <div class="table-header">
        <h3><i class="fas fa-clipboard-list"></i> Labour Care Summary</h3>
        <p class="table-subtitle">Complete the form below for each time interval during active labour</p>
      </div>
      
      <!-- Supportive Care Table -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('supportiveCare')" style="cursor: pointer;">
          <h4><i class="fas fa-hands-helping"></i> Supportive Care</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleSupportiveCare"></i>
          </div>
        </div>
        <div class="table-wrapper" id="supportiveCareWrapper">
          <table class="summary-table" id="supportiveCareTable"></table>
        </div>
        <div class="table-legend">
          <small><strong>Legend:</strong> 
            Table 1: Contractions with 30-min intervals (starting 00:30) | 
            Table 2: Cervix plotting with hourly intervals (starting 01:00) | 
            Table 3: Descent plotting with hourly intervals (starting 01:00)
          </small>
        </div>
      </div>

      <!-- Baby Table -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('baby')" style="cursor: pointer;">
          <h4><i class="fas fa-baby"></i> Baby</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleBaby"></i>
          </div>
        </div>
        <div class="table-wrapper" id="babyWrapper">
          <table class="summary-table" id="babyTable"></table>
        </div>
        <div class="table-legend">
          <small><strong>Legend:</strong> 
            FHR: N=No, E=Early, L=Late, V=Variable | 
            Amniotic: I=Intact, C=Clear, M=Meconium, B=Bloody | 
            Position: A=Anterior, P=Posterior, T=Transverse | 
            Caput/Moulding: 0=None, +=Mild, ++=Moderate, +++=Severe
          </small>
        </div>
      </div>

      <!-- Woman Table -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('woman')" style="cursor: pointer;">
          <h4><i class="fas fa-female"></i> Woman</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleWoman"></i>
          </div>
        </div>
        <div class="table-wrapper" id="womanWrapper">
          <table class="summary-table" id="womanTable"></table>
        </div>
        <div class="table-legend">
          <small><strong>Legend:</strong> 
            Pulse: <60 or >120 bpm | 
            BP: SBP <90 or >140, DBP >90 mmHg | 
            Temperature: <36 or >37.5¬∞C | 
            Urine: -/- (none), P (Protein), A (Acetone) with grades -, Trace, +, ++, +++, ++++
          </small>
        </div>
      </div>

      <!-- Labour Progress Section -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('labourProgress')" style="cursor: pointer;">
          <h4><i class="fas fa-chart-line"></i> Labour Progress</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleLabourProgress"></i>
          </div>
        </div>
        <div class="table-wrapper" id="labourProgressWrapper">
          <!-- Contractions Table (Keep as is) -->
          <div class="contractions-section">
            <h5 class="chart-title">Contractions</h5>
            <div class="table-wrapper">
              <table class="summary-table" id="contractionsTable"></table>
            </div>
          </div>
          
          <!-- Cervix Plotting Chart -->
          <div class="plotting-section">
            <h5 class="chart-title">Cervix Plotting (WHO LCG Guidelines)</h5>
            <div class="plotting-container">
              <div class="plotting-info">
                <p><strong>Instructions:</strong> Click on the chart to plot cervical dilation progress. Plot 'X' when cervical dilation is observed.</p>
                <p><strong>Alert Thresholds:</strong> Plot 'X' to record cervical dilatation. Alert triggered when lag time for current cervical dilatation is exceeded with no progress.</p>
              </div>
              <div class="chart-wrapper">
                <canvas id="cervixChart" width="800" height="400"></canvas>
                <div class="chart-controls">
                  <div class="chart-status mb-2">
                    <small class="text-muted">
                      <span class="badge bg-primary">Saved: <span id="cervixSavedCount">0</span></span>
                      <span class="badge bg-warning">New: <span id="cervixUnsavedCount">0</span></span>
                    </small>
                  </div>
                  <button class="btn btn-sm btn-outline-primary" onclick="clearCervixChart()">Clear New Points</button>
                  <button class="btn btn-sm btn-outline-success" onclick="savePlotData()">Save Plot</button>
                  <button class="btn btn-sm btn-outline-danger" onclick="clearAllCervixData()">Clear All Plot</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Descent Plotting Chart -->
          <div class="plotting-section">
            <h5 class="chart-title">Fetal Descent Plotting (WHO LCG Guidelines)</h5>
            <div class="plotting-container">
              <div class="plotting-info">
                <p><strong>Instructions:</strong> Click on the chart to plot fetal descent progress. Plot 'O' when descent is observed.</p>
                <p><strong>Alert Thresholds:</strong> Monitor descent progress. In second stage, insert 'P' to indicate when pushing begins.</p>
              </div>
              <div class="chart-wrapper">
                <canvas id="descentChart" width="800" height="400"></canvas>
                <div class="chart-controls">
                  <div class="chart-status mb-2">
                    <small class="text-muted">
                      <span class="badge bg-primary">Saved: <span id="descentSavedCount">0</span></span>
                      <span class="badge bg-warning">New: <span id="descentUnsavedCount">0</span></span>
                    </small>
                  </div>
                  <button class="btn btn-sm btn-outline-primary" onclick="clearDescentChart()">Clear New Points</button>
                  <button class="btn btn-sm btn-outline-success" onclick="savePlotData()">Save Plot</button>
                  <button class="btn btn-sm btn-outline-danger" onclick="clearAllDescentData()">Clear All Plot</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="table-legend">
          <small><strong>Legend:</strong> 
            Contractions: Number inputs for frequency and duration | 
            Cervix Plot: Click to plot 'X' for cervical dilation progress | 
            Descent Plot: Click to plot 'O' for fetal descent progress
          </small>
        </div>
      </div>

      <!-- Medication Table -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('medication')" style="cursor: pointer;">
          <h4><i class="fas fa-pills"></i> Medication</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleMedication"></i>
          </div>
        </div>
        <div class="table-wrapper" id="medicationWrapper">
          <table class="summary-table" id="medicationTable"></table>
        </div>
      </div>

      <!-- Shared Decision-Making Table -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('decisionMaking')" style="cursor: pointer;">
          <h4><i class="fas fa-comments"></i> Shared Decision-Making</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleDecisionMaking"></i>
          </div>
        </div>
        <div class="table-wrapper" id="decisionMakingWrapper">
          <table class="summary-table" id="decisionMakingTable"></table>
        </div>
      </div>

      <!-- Initials Table -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('initials')" style="cursor: pointer;">
          <h4><i class="fas fa-signature"></i> Initials</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleInitials"></i>
          </div>
        </div>
        <div class="table-wrapper" id="initialsWrapper">
          <table class="summary-table" id="initialsTable"></table>
        </div>
      </div>

      <!-- Clinical Recommendations Section -->
      <div class="section-table">
        <div class="section-title" onclick="toggleSection('recommendations')" style="cursor: pointer;">
          <h4><i class="fas fa-lightbulb"></i> Clinical Recommendations</h4>
          <div class="toggle-icon">
            <i class="fas fa-chevron-down" id="toggleRecommendations"></i>
          </div>
        </div>
        <div class="recommendations-container" id="recommendationsWrapper">
          <div id="recommendationsBox"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const patientId = params.get("patient");
    
    const sections = {
      "Supportive Care": [
        "Companion",
        "Pain relief", 
        "Oral fluid",
        "Posture"
      ],
      "Baby": [
        "Baseline FHR",
        "FHR deceleration",
        "Amniotic fluid",
        "Fetal position",
        "Caput",
        "Moulding"
      ],
      "Woman": [
        "Pulse",
        "Systolic BP",
        "Diastolic BP", 
        "Temperature C",
        "Urine"
      ],
      "Labour Progress": [
        "Contractions per 10 min",
        "Duration of contractions"
      ],
      "Cervix Plot": [
        "Cervix [Plot X]"
      ],
      "Descent Plot": [
        "Descent [Plot O]"
      ],
      "Medication": [
        "Oxytocin (U/L, drops/min)",
        "Medicine",
        "IV fluids"
      ],
      "Shared Decision-Making": [
        "ASSESSMENT",
        "PLAN",
        "INITIALS"
      ]
    };

    const dropdownOptions = {
      // Supportive care
      "Companion": ["Y", "N", "D"],
      "Pain relief": ["Y", "N", "D"],
      "Oral fluid": ["Y", "N", "D"],
      "Posture": ["M", "SP"],

      // Baby
      "FHR deceleration": ["N", "E", "L", "V"],
      "Amniotic fluid": ["I", "C", "M", "M+", "M++", "M+++", "B"],
      "Fetal position": ["A", "P", "T"],
      "Caput": ["0", "+", "++", "+++"],
      "Moulding": ["0", "+", "++", "+++"],

      // Woman
      "Pulse": ["<60", "60-100", ">100", ">120"],
      "Systolic BP": ["<90", "90-140", ">140"],
      "Diastolic BP": ["<60", "60-90", ">90"],
      "Temperature C": ["<36", "36-37.5", ">37.5"],
      "Urine": ["-/-", "P-", "P Trace", "P+", "P++", "P+++", "P++++", "A-", "A Trace", "A+", "A++", "A+++", "A++++"],

      // Labour Progress
      "Contractions per 10 min": ["<2", "2-5", ">5"],
      "Duration of contractions": ["<20s", "20-40s", ">40s"],
      "Cervix [Plot X]": ["", "X"],
      "Descent [Plot O]": ["", "O"],

      // Medication
      "Oxytocin (U/L, drops/min)": ["None", "Started", "Stopped"],
      "Medicine": ["None", "Started", "Stopped"],
      "IV fluids": ["None", "Started", "Stopped"]
    };

    const alertValues = {
      // Supportive care - WHO LCG values
      "Companion": ["N"], // N = No companion
      "Pain relief": ["N"], // N = No pain relief
      "Oral fluid": ["N"], // N = No oral fluid
      "Posture": ["SP"], // SP = Supine position

      // Baby - WHO LCG values
      "Baseline FHR": [], // Will be handled by number input range checking
      "FHR deceleration": ["L"], // L = Late decelerations
      "Amniotic fluid": ["M+++", "B"], // M+++ = Severe meconium, B = Bloody
      "Fetal position": ["P", "T"], // P = Posterior, T = Transverse
      "Caput": ["+++"], // +++ = Severe caput
      "Moulding": ["+++"], // +++ = Severe moulding

      // Woman - WHO LCG values
      "Pulse": [], // Will be handled by number input range checking
      "Systolic BP": [], // Will be handled by number input range checking
      "Diastolic BP": [], // Will be handled by number input range checking
      "Temperature C": [], // Will be handled by number input range checking
      "Urine": ["P+", "P++", "P+++", "P++++", "A+", "A++", "A+++", "A++++"], // Protein and Acetone alerts

      // Labour Progress - WHO LCG values
      "Contractions per 10 min": ["<2", ">5"], // Abnormal contraction frequency
      "Duration of contractions": ["<20s", ">40s"], // Abnormal contraction duration
      "Cervix [Plot X]": [], // No alerts for plotting
      "Descent [Plot O]": [] // No alerts for plotting
    };

    // WHO LCG Alert Values for each field
    const whoAlertValues = {
      // Supportive Care
      "Companion": "N", // N = No companion
      "Pain relief": "N", // N = No pain relief  
      "Oral fluid": "N", // N = No oral fluid
      "Posture": "SP", // SP = Supine position

      // Baby
      "Baseline FHR": "<110, ‚â•160", // Abnormal FHR values
      "FHR deceleration": "L", // L = Late decelerations
      "Amniotic fluid": "M+++, B", // M+++ = Meconium, B = Bloody
      "Fetal position": "P, T", // P = Posterior, T = Transverse
      "Caput": "+++", // +++ = Severe caput
      "Moulding": "+++", // +++ = Severe moulding

      // Woman
      "Pulse": "<60, ‚â•120", // Abnormal pulse values
      "Systolic BP": "<90, ‚â•140", // Abnormal BP values
      "Diastolic BP": "‚â•90", // High diastolic BP
      "Temperature C": "<36, ‚â•37.5", // Abnormal temperature
      "Urine": "P++, A++", // P++ = Proteinuria, A++ = Acetone

      // Labour Progress
      "Contractions per 10 min": "‚â§2, >5", // Abnormal contraction frequency
      "Duration of contractions": "<20, >60" // Abnormal contraction duration
    };

    // Cervix Plot values (X values)
    const cervixPlotValues = {
      "10": "", // Empty for 10cm
      "9": "‚â•2h",
      "8": "‚â•2.5h", 
      "7": "‚â•3h",
      "6": "‚â•5h",
      "5": "‚â•6h"
    };

    // Descent Plot values (O values)
    const descentPlotValues = {
      "5": "", // Empty for all descent values
      "4": "",
      "3": "",
      "2": "",
      "1": "",
      "0": ""
    };

    const recommendations = {
      "Companion": {
        "N": "Encourage presence of a companion of choice for support."
      },
      "Mobility": {
        "SP": "Encourage upright or mobile posture for comfort and progress."
      },
      "Pain relief": {
        "N": "Assess pain and offer appropriate pain relief options."
      },
      "Oral fluid": {
        "N": "Encourage oral fluid intake unless contraindicated."
      },
      "Baseline FHR": {
        "<110": "Assess for fetal distress. Prepare for immediate intervention.",
        ">160": "Assess for fetal distress. Prepare for immediate intervention."
      },
      "FHR deceleration": {
        "L": "Reassess fetal condition. Consider immediate intervention.",
        "V": "Monitor closely and reassess fetal condition."
      },
      "Amniotic fluid": {
        "M": "Monitor for fetal distress. Prepare for possible intervention.",
        "M+": "Monitor for fetal distress. Prepare for possible intervention.",
        "M++": "Monitor for fetal distress. Prepare for possible intervention.",
        "M+++": "Monitor for fetal distress. Prepare for possible intervention.",
        "B": "Assess for placental abruption or other complications."
      },
      "Fetal position": {
        "P": "Monitor labour progress. Consider position change or intervention.",
        "T": "Monitor labour progress. Consider position change or intervention."
      },
      "Caput": {
        "+": "Monitor for obstructed labour. Consider intervention.",
        "++": "Monitor for obstructed labour. Consider intervention.",
        "+++": "Monitor for obstructed labour. Consider intervention."
      },
      "Moulding": {
        "++": "Monitor for obstructed labour. Consider intervention.",
        "+++": "Monitor for obstructed labour. Consider intervention."
      },
      "Pulse": {
        "<50": "Assess for underlying causes. Monitor closely.",
        ">100": "Assess for infection, dehydration, pain, anxiety."
      },
      "Systolic BP": {
        "<90": "Assess for shock. Initiate appropriate management.",
        ">140": "Assess for pre-eclampsia. Initiate appropriate management."
      },
      "Diastolic BP": {
        "<60": "Assess for hypotension. Monitor closely.",
        ">90": "Assess for pre-eclampsia. Initiate appropriate management."
      },
      "Temperature C": {
        "<36.0": "Assess for hypothermia. Initiate warming measures.",
        ">37.5": "Assess for infection. Initiate appropriate management."
      },
      "Urine": {
        "P+": "Assess for pre-eclampsia. Monitor and manage.",
        "P++": "Assess for pre-eclampsia. Monitor and manage.",
        "P+++": "Assess for pre-eclampsia. Monitor and manage.",
        "P++++": "Assess for pre-eclampsia. Monitor and manage.",
        "A+": "Assess for diabetic ketoacidosis. Monitor and manage.",
        "A++": "Assess for diabetic ketoacidosis. Monitor and manage.",
        "A+++": "Assess for diabetic ketoacidosis. Monitor and manage.",
        "A++++": "Assess for diabetic ketoacidosis. Monitor and manage."
      },
      "Contractions per 10 min": {
        "<2": "Assess labour progress. Consider augmentation.",
        ">5": "Assess for uterine hyperstimulation. Consider tocolysis."
      },
      "Duration of contractions": {
        "<20": "Assess labour progress. Consider augmentation.",
        ">60": "Assess for uterine hyperstimulation. Consider tocolysis."
      }
    };

    async function loadData() {
      try {
        // Get current user and their Firestore profile
        const user = firebase.auth().currentUser;
        if (!user) {
          document.body.innerHTML = '<div class="alert alert-danger">Not authenticated.</div>';
          return;
        }
        
        // Fetch user profile
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (!userDoc.exists) {
          document.body.innerHTML = '<div class="alert alert-danger">User profile not found.</div>';
          return;
        }
        const userData = userDoc.data();

        // Get patient document
        const patientDoc = await db.collection("patients").doc(patientId).get({ source: "server" });
        if (!patientDoc.exists) {
          document.body.innerHTML = '<div class="alert alert-danger">Patient not found.</div>';
          return;
        }
        const d = patientDoc.data();

        // Access control: Super Admin always allowed, TMO if township matches, Midwife if createdBy matches
        let allowed = false;
        
        if (userData.role === "Super Admin" || userData.role === "admin") {
          allowed = true;
        } else if (userData.role === "TMO") {
          // TMO can access if township matches (handle cases where township might be undefined)
          const patientTownship = d.township || "";
          const userTownship = userData.township || "";
          if (patientTownship && userTownship && patientTownship === userTownship) {
            allowed = true;
          }
        } else if (userData.role === "Midwife" || userData.role === "midwife") {
          // Midwife can access if they created the patient
          if (d.createdBy === user.uid) {
            allowed = true;
          }
        }

        if (!allowed) {
          // Better error message based on role
          let errorMessage = "";
          if (userData.role === "TMO") {
            errorMessage = `Access Denied: You can only access patients in your township (${userData.township || 'undefined'}). This patient is in township: ${d.township || 'undefined'}.`;
          } else if (userData.role === "Midwife" || userData.role === "midwife") {
            errorMessage = `Access Denied: You can only access patients you created. This patient was created by: ${d.createdBy || 'unknown'}.`;
          } else {
            errorMessage = `Access Denied: You do not have permission to view this patient record. Please contact your administrator.`;
          }
          
          document.body.innerHTML = `
            <div class="alert alert-danger">
              <h4>Access Denied</h4>
              <p><strong>Reason:</strong> ${errorMessage}</p>
              <hr>
              <a href="list.html" class="btn btn-primary">‚Üê Back to Patient List</a>
            </div>
          `;
          return;
        }

        // Populate patient info
        document.getElementById("p_name").value = d.name || "";
        document.getElementById("p_age").value = d.age || "";
        document.getElementById("p_parity").value = d.parity || "";
        document.getElementById("p_onset").value = d.labour_onset || "";
        document.getElementById("p_active").value = d.active_labour || "";
        document.getElementById("p_membrane").value = d.ruptured_membrane || "";
        document.getElementById("p_risk").value = d.risk_factors || "";

        // Load records
        const snap = await db.collection("patients").doc(patientId).collection("records").get({ source: "server" });
        const existing = {};
        snap.forEach(doc => {
          const d = doc.data();
          existing[d.time] = d;
        });

        // Generate the summary table
        generateSummaryTable(existing);
        showRecommendations();
        
        // Load plotting data from previous sessions
        await loadPlotData();
        
        // Setup alert highlighting for real-time alerts
        addAlertHighlighting();
        
        // Add event listeners for form changes
        document.querySelectorAll('select, input').forEach(el => {
          el.addEventListener('change', showRecommendations);
        });
      } catch (error) {
        console.error("Error loading data:", error);
        document.body.innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
      }
    }

    function generateSummaryTable(existing) {
      
      // Clear existing tables
      document.getElementById("supportiveCareTable").innerHTML = "";
      document.getElementById("babyTable").innerHTML = "";
      document.getElementById("womanTable").innerHTML = "";
      document.getElementById("contractionsTable").innerHTML = "";
      // Note: Plotting charts are handled separately
      document.getElementById("medicationTable").innerHTML = "";
      document.getElementById("decisionMakingTable").innerHTML = "";
      document.getElementById("initialsTable").innerHTML = ""; // Clear initials table

      // Generate each section table
      generateSectionTable("Supportive Care", sections["Supportive Care"], "supportiveCareTable", existing);
      generateSectionTable("Baby", sections["Baby"], "babyTable", existing);
      generateSectionTable("Woman", sections["Woman"], "womanTable", existing);
      
      // Generate Contractions table (keep as is)
      generateContractionsTable("contractionsTable", existing);
      
      // Initialize plotting charts (replaces the old table generation)
      initializePlottingCharts();
      
      generateSectionTable("Medication", sections["Medication"], "medicationTable", existing);
      generateSectionTable("Shared Decision-Making", sections["Shared Decision-Making"], "decisionMakingTable", existing);
      generateInitialsTable("initialsTable", existing); // Generate initials table
      
      // Add event listeners for form changes
      addFormEventListeners();
      
      // Highlight any existing alert values after tables are generated
      setTimeout(() => {
        const allSelects = document.querySelectorAll('select');
        const allNumberInputs = document.querySelectorAll('input[type="number"]');
        
        allSelects.forEach(select => checkAndHighlightAlert(select));
        allNumberInputs.forEach(input => checkAndHighlightAlert(input));
      }, 100);
    }

    function generateSectionTable(sectionName, fields, tableId, existing) {
      const table = document.getElementById(tableId);
      
      // Create table header
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      
      // Field header
      const fieldHeader = document.createElement("th");
      fieldHeader.className = "field-header sticky-field";
      fieldHeader.textContent = "Field";
      headerRow.appendChild(fieldHeader);
      
      // Alert header
      const alertHeader = document.createElement("th");
      alertHeader.className = "alert-header sticky-alert";
      alertHeader.textContent = "Alert";
      headerRow.appendChild(alertHeader);
      
      // Time headers
      timeCols.forEach(time => {
        const timeHeader = document.createElement("th");
        timeHeader.className = "time-header";
        timeHeader.textContent = time;
        headerRow.appendChild(timeHeader);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create table body
      const tbody = document.createElement("tbody");
      
      fields.forEach(field => {
        const row = document.createElement("tr");
        row.className = "field-row";
        
        // Field cell (sticky)
        const fieldCell = document.createElement("td");
        fieldCell.className = "field-cell sticky-field";
        fieldCell.textContent = field;
        row.appendChild(fieldCell);
        
        // Alert cell (sticky) - Use WHO LCG values
        const alertCell = document.createElement("td");
        alertCell.className = "alert-cell sticky-alert";
        const alertValue = whoAlertValues[field] || "";
        alertCell.innerHTML = `<span class="alert-indicator">${alertValue}</span>`;
        row.appendChild(alertCell);
        
        // Time cells
        timeCols.forEach((time, index) => {
          const key = `${time}_${field.replace(/\s+/g, "_")}`;
          const value = existing[time] && existing[time][field] ? existing[time][field] : "";
          
          const timeCell = document.createElement("td");
          timeCell.className = "time-cell";
          
          // Special handling for number input fields
          if (field === "Baseline FHR" || field === "Pulse" || field === "Systolic BP" || field === "Diastolic BP" || field === "Temperature C") {
            const input = document.createElement("input");
            input.name = key;
            input.type = "number";
            input.className = "form-control form-control-sm";
            
            // Set appropriate ranges for each field
            if (field === "Baseline FHR") {
              input.min = "50";
              input.max = "200";
              input.step = "1";
            } else if (field === "Pulse") {
              input.min = "40";
              input.max = "200";
              input.step = "1";
            } else if (field === "Systolic BP") {
              input.min = "60";
              input.max = "200";
              input.step = "1";
            } else if (field === "Diastolic BP") {
              input.min = "40";
              input.max = "120";
              input.step = "1";
            } else if (field === "Temperature C") {
              input.min = "30";
              input.max = "42";
              input.step = "0.1";
            }
            
            input.value = value;
            timeCell.appendChild(input);
          } else if (dropdownOptions[field]) {
            const select = document.createElement("select");
            select.name = key;
            select.className = "form-select form-select-sm";
            
            // Add blank option first
            const blankOption = document.createElement("option");
            blankOption.value = "";
            blankOption.textContent = "";
            select.appendChild(blankOption);
            
            dropdownOptions[field].forEach(opt => {
              const option = document.createElement("option");
              option.value = opt;
              option.textContent = opt;
              select.appendChild(option);
            });
            
            select.value = value !== undefined ? value : "";
            timeCell.appendChild(select);
          } else {
            const input = document.createElement("input");
            input.name = key;
            input.type = "text";
            input.className = "form-control form-control-sm";
            input.value = value;
            timeCell.appendChild(input);
          }
          
          row.appendChild(timeCell);
        });
        
        tbody.appendChild(row);
      });
      
      table.appendChild(tbody);
    }

    // Labour Progress Table - Contractions (Keep as is)
    function generateContractionsTable(tableId, existing) {
      const table = document.getElementById(tableId);
      
      // Create table header
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      
      // First column: Field
      const fieldHeader = document.createElement("th");
      fieldHeader.className = "field-header sticky-field";
      fieldHeader.textContent = "Field";
      headerRow.appendChild(fieldHeader);
      
      // Second column: Alert
      const alertHeader = document.createElement("th");
      alertHeader.className = "alert-header sticky-alert";
      alertHeader.textContent = "Alert";
      headerRow.appendChild(alertHeader);
      
      // Time headers (30-minute intervals for contractions)
      timeCols.forEach(time => {
        const timeHeader = document.createElement("th");
        timeHeader.className = "time-header";
        timeHeader.textContent = time;
        headerRow.appendChild(timeHeader);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create table body
      const tbody = document.createElement("tbody");
      
      // First row: Contractions per 10 min
      const contractionsRow = document.createElement("tr");
      
      // Field cell
      const contractionsFieldCell = document.createElement("td");
      contractionsFieldCell.className = "field-cell sticky-field";
      contractionsFieldCell.textContent = "Contractions per 10 min";
      contractionsRow.appendChild(contractionsFieldCell);
      
      // Alert cell
      const contractionsAlertCell = document.createElement("td");
      contractionsAlertCell.className = "alert-cell sticky-alert";
      contractionsAlertCell.textContent = "‚â§2, >5";
      contractionsRow.appendChild(contractionsAlertCell);
      
      // Time cells
      timeCols.forEach((time, index) => {
        const timeCell = document.createElement("td");
        timeCell.className = "time-cell";
        
        const key = `Labour_Progress_Contractions_per_10_min_${time}`;
        const value = existing[key] || "";
        
        const input = document.createElement("input");
        input.name = key;
        input.type = "number";
        input.className = "form-control form-control-sm";
        input.min = "0";
        input.max = "10";
        input.step = "1";
        input.value = value;
        timeCell.appendChild(input);
        contractionsRow.appendChild(timeCell);
      });
      
      tbody.appendChild(contractionsRow);
      
      // Second row: Duration of contractions
      const durationRow = document.createElement("tr");
      
      // Field cell
      const durationFieldCell = document.createElement("td");
      durationFieldCell.className = "field-cell sticky-field";
      durationFieldCell.textContent = "Duration of contractions";
      durationRow.appendChild(durationFieldCell);
      
      // Alert cell
      const durationAlertCell = document.createElement("td");
      durationAlertCell.className = "alert-cell sticky-alert";
      durationAlertCell.textContent = "<20, >60";
      durationRow.appendChild(durationAlertCell);
      
      // Time cells
      timeCols.forEach((time, index) => {
        const timeCell = document.createElement("td");
        timeCell.className = "time-cell";
        
        const key = `Labour_Progress_Duration_of_contractions_${time}`;
        const value = existing[key] || "";
        
        const input = document.createElement("input");
        input.name = key;
        input.type = "number";
        input.className = "form-control form-control-sm";
        input.min = "0";
        input.max = "120";
        input.step = "5";
        input.value = value;
        timeCell.appendChild(input);
        durationRow.appendChild(timeCell);
      });
      
      tbody.appendChild(durationRow);
      table.appendChild(tbody);
      
      // Add event listeners to contractions inputs for real-time alerts
      const allInputs = table.querySelectorAll('input[type="number"]');
      allInputs.forEach(input => {
        input.addEventListener('input', function() {
          checkAndHighlightAlert(this);
          showRecommendations();
        });
        input.addEventListener('change', function() {
          checkAndHighlightAlert(this);
          showRecommendations();
        });
      });
    }

    // Essential functions that were accidentally removed
    function addFormEventListeners() {
      // Add event listeners to all select and input elements
      document.querySelectorAll('select, input').forEach(el => {
        el.addEventListener('change', function() {
          checkAndHighlightAlert(this);
          showRecommendations();
        });
        el.addEventListener('input', function() {
          if (this.type === 'number') {
            checkAndHighlightAlert(this);
            showRecommendations();
          }
        });
      });
    }

    function getLatestValue(field) {
      // Go through timeCols in reverse to find the latest non-empty value
      for (let i = timeCols.length - 1; i >= 0; i--) {
        const key = `${timeCols[i]}_${field.replace(/\s+/g, "_")}`;
        const el = document.getElementsByName(key)[0];
        if (el && el.value) return el.value;
      }
      return "";
    }

    function showRecommendations() {
      const recs = new Set(); // Use Set to avoid duplicates
      
      // Check all section tables
      for (const fieldList of Object.values(sections)) {
        for (const field of fieldList) {
          const latestValue = getLatestValue(field);
          if (recommendations[field] && recommendations[field][latestValue]) {
            recs.add(`${field} (${latestValue}): ${recommendations[field][latestValue]}`);
          }
        }
      }
      
      // Check contractions table specifically
      const contractionsTable = document.getElementById('contractionsTable');
      if (contractionsTable) {
        const contractionsInputs = contractionsTable.querySelectorAll('input[type="number"]');
        contractionsInputs.forEach(input => {
          const fieldName = input.name;
          const value = input.value;
          
          if (fieldName.includes('Contractions_per_10_min')) {
            const numValue = parseFloat(value);
            if (numValue < 2 && recommendations["Contractions per 10 min"]["<2"]) {
              recs.add(`Contractions per 10 min (<2): ${recommendations["Contractions per 10 min"]["<2"]}`);
            } else if (numValue > 5 && recommendations["Contractions per 10 min"][">5"]) {
              recs.add(`Contractions per 10 min (>5): ${recommendations["Contractions per 10 min"][">5"]}`);
            }
          } else if (fieldName.includes('Duration_of_contractions')) {
            const numValue = parseFloat(value);
            if (numValue < 20 && recommendations["Duration of contractions"]["<20"]) {
              recs.add(`Duration of contractions (<20): ${recommendations["Duration of contractions"]["<20"]}`);
            } else if (numValue > 60 && recommendations["Duration of contractions"][">60"]) {
              recs.add(`Duration of contractions (>60): ${recommendations["Duration of contractions"][">60"]}`);
            }
          }
        });
      }
      
      // Check all number inputs for alert values
      const allNumberInputs = document.querySelectorAll('input[type="number"]');
      allNumberInputs.forEach(input => {
        const fieldName = input.name;
        const value = parseFloat(input.value);
        
        if (fieldName.includes('Baseline_FHR')) {
          if (value < 110 && recommendations["Baseline FHR"]["<110"]) {
            recs.add(`Baseline FHR (<110): ${recommendations["Baseline FHR"]["<110"]}`);
          } else if (value > 160 && recommendations["Baseline FHR"][">160"]) {
            recs.add(`Baseline FHR (>160): ${recommendations["Baseline FHR"][">160"]}`);
          }
        } else if (fieldName.includes('Pulse')) {
          if (value < 50 && recommendations["Pulse"]["<50"]) {
            recs.add(`Pulse (<50): ${recommendations["Pulse"]["<50"]}`);
          } else if (value > 100 && recommendations["Pulse"][">100"]) {
            recs.add(`Pulse (>100): ${recommendations["Pulse"][">100"]}`);
          }
        } else if (fieldName.includes('Systolic_BP')) {
          if (value < 90 && recommendations["Systolic BP"]["<90"]) {
            recs.add(`Systolic BP (<90): ${recommendations["Systolic BP"]["<90"]}`);
          } else if (value > 140 && recommendations["Systolic BP"][">140"]) {
            recs.add(`Systolic BP (>140): ${recommendations["Systolic BP"][">140"]}`);
          }
        } else if (fieldName.includes('Diastolic_BP')) {
          if (value < 60 && recommendations["Diastolic BP"]["<60"]) {
            recs.add(`Diastolic BP (<60): ${recommendations["Diastolic BP"]["<60"]}`);
          } else if (value > 90 && recommendations["Diastolic BP"][">90"]) {
            recs.add(`Diastolic BP (>90): ${recommendations["Diastolic BP"][">90"]}`);
          }
        } else if (fieldName.includes('Temperature_C')) {
          if (value < 36.0 && recommendations["Temperature C"]["<36.0"]) {
            recs.add(`Temperature C (<36.0): ${recommendations["Temperature C"]["<36.0"]}`);
          } else if (value > 37.5 && recommendations["Temperature C"][">37.5"]) {
            recs.add(`Temperature C (>37.5): ${recommendations["Temperature C"][">37.5"]}`);
          }
        }
      });
      
      const box = document.getElementById("recommendationsBox");
      if (recs.size > 0) {
        box.innerHTML = `
          <div class="recommendations-content">
            <div class="recommendations-header">
              <i class="fas fa-lightbulb"></i>
              <span>Clinical Recommendations</span>
            </div>
            <div class="recommendations-list">
              ${Array.from(recs).map(r => `<div class="recommendation-item">${r}</div>`).join("")}
            </div>
          </div>
        `;
      } else {
        box.innerHTML = "";
      }
    }

    async function saveData() {
      try {
        const base = db.collection("patients").doc(patientId);

        // Fetch existing patient data to preserve createdBy
        const patientDoc = await base.get();
        let createdBy = "";
        if (patientDoc.exists && patientDoc.data().createdBy) {
          createdBy = patientDoc.data().createdBy;
        }

        // Save patient info
        await base.set({
          name: document.getElementById("p_name").value,
          age: document.getElementById("p_age").value,
          parity: document.getElementById("p_parity").value,
          labour_onset: document.getElementById("p_onset").value,
          active_labour: document.getElementById("p_active").value,
          ruptured_membrane: document.getElementById("p_membrane").value,
          risk_factors: document.getElementById("p_risk").value,
          createdBy
        });

        // Save time-based records from all tables
        for (const time of timeCols) {
          const data = { time, timestamp: new Date().toISOString() };
          
          // Collect data from all section tables
          for (const fieldList of Object.values(sections)) {
            for (const field of fieldList) {
              const key = `${time}_${field.replace(/\s+/g, "_")}`;
              const el = document.getElementsByName(key)[0];
              if (el) {
                data[field] = el.value;
              }
            }
          }

          // Save to Firestore
          await base.collection("records").doc(time).set(data);
        }

        showSaveSuccess();
      } catch (error) {
        console.error("Error saving data:", error);
        showSaveError(error.message);
      }
    }

    // Show save success message
    function showSaveSuccess() {
      const successMessage = document.getElementById('successMessage');
      if (successMessage) {
        successMessage.style.display = 'flex';
        successMessage.style.zIndex = '9999';
        console.log('Success message displayed');
        
        setTimeout(() => {
          successMessage.style.display = 'none';
        }, 3000);
      } else {
        console.error('Success message element not found');
      }
    }

    // Show save error message
    function showSaveError(errorMessage) {
      const successMessage = document.getElementById('successMessage');
      if (successMessage) {
        successMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Save Error: ' + errorMessage + '</span>';
        successMessage.className = 'success-message error-message';
        successMessage.style.display = 'flex';
        successMessage.style.zIndex = '9999';
        
        setTimeout(() => {
          successMessage.style.display = 'none';
          successMessage.innerHTML = '<i class="fas fa-check-circle"></i><span>Saved Successfully</span>';
          successMessage.className = 'success-message';
        }, 5000);
        
        console.error("Save error:", errorMessage);
      } else {
        console.error('Success message element not found');
      }
    }

    // Generate time columns starting from 00:30
    function generateTimeColumns() {
      const timeCols = [];
      for (let hour = 0; hour <= 15; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          if (hour === 0 && minute === 0) continue; // Skip 00:00
          const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          timeCols.push(timeStr);
        }
      }
      return timeCols;
    }

    // Initialize time columns
    const timeCols = generateTimeColumns();

    // Load data when page loads
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "login.html";
      } else {
        // Only load data after user is authenticated
        loadData();
      }
    });

    // Populate time columns in the header
    function populateTimeColumns() {
      const timeColumnsContainer = document.getElementById('timeColumns');
      if (timeColumnsContainer) {
        timeColumnsContainer.innerHTML = timeCols.map(t => 
          `<div class="time-column">${t}</div>`
        ).join('');
      }
    }

    // Call this after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      populateTimeColumns();
      initializeFoldedSections(); // Initialize all sections as folded
      addAlertHighlighting(); // Add alert highlighting functionality
      initializePlottingCharts(); // Initialize plotting charts
      
      // Test if sticky positioning is supported
      testStickySupport();
    });
    
    // Test if sticky positioning is supported
    function testStickySupport() {
      const testElement = document.createElement('div');
      testElement.style.position = 'sticky';
      testElement.style.top = '0';
      
      if (testElement.style.position === 'sticky') {
        console.log('‚úÖ Sticky positioning is supported');
      } else {
        console.log('‚ùå Sticky positioning is NOT supported - using fallback');
        // Add fallback CSS class
        document.body.classList.add('no-sticky-support');
      }
    }

    // Toggle patient information section
    function togglePatientInfo() {
      const patientForm = document.getElementById('patientForm');
      const toggleIcon = document.getElementById('toggleIcon');
      
      if (patientForm.style.display === 'none') {
        patientForm.style.display = 'block';
        toggleIcon.className = 'fas fa-chevron-down';
      } else {
        patientForm.style.display = 'none';
        toggleIcon.className = 'fas fa-chevron-right';
      }
    }

    // Toggle section visibility
    function toggleSection(sectionId) {
      const wrapper = document.getElementById(`${sectionId}Wrapper`);
      const toggleIcon = document.getElementById(`toggle${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);
      
      if (wrapper.style.display === 'none') {
        wrapper.style.display = 'block';
        toggleIcon.className = 'fas fa-chevron-down';
      } else {
        wrapper.style.display = 'none';
        toggleIcon.className = 'fas fa-chevron-right';
      }
    }

    // Initialize all sections as folded
    function initializeFoldedSections() {
      // Start with Patient Information folded
      document.getElementById('patientForm').style.display = 'none';
      document.getElementById('toggleIcon').className = 'fas fa-chevron-right';
      
      // Start with all section tables folded
      const sections = ['supportiveCare', 'baby', 'woman', 'labourProgress', 'medication', 'decisionMaking', 'initials', 'recommendations'];
      sections.forEach(sectionId => {
        const wrapper = document.getElementById(`${sectionId}Wrapper`);
        const toggleIcon = document.getElementById(`toggle${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);
        
        if (wrapper && toggleIcon) {
          wrapper.style.display = 'none';
          toggleIcon.className = 'fas fa-chevron-right';
        }
      });
    }

    // Generate Initials Table
    function generateInitialsTable(tableId, existing) {
      const table = document.getElementById(tableId);
      
      // Create table header
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      
      // First column: Field
      const fieldHeader = document.createElement("th");
      fieldHeader.className = "field-header sticky-field";
      fieldHeader.textContent = "Field";
      headerRow.appendChild(fieldHeader);
      
      // Second column: Alert
      const alertHeader = document.createElement("th");
      alertHeader.className = "alert-header sticky-alert";
      alertHeader.textContent = "Alert";
      headerRow.appendChild(alertHeader);
      
      // Time headers (30-minute intervals)
      timeCols.forEach(time => {
        const timeHeader = document.createElement("th");
        timeHeader.className = "time-header";
        timeHeader.textContent = time;
        headerRow.appendChild(timeHeader);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create table body
      const tbody = document.createElement("tbody");
      
      // Initials row
      const initialsRow = document.createElement("tr");
      
      // Field cell
      const fieldCell = document.createElement("td");
      fieldCell.className = "field-cell sticky-field";
      fieldCell.textContent = "INITIALS";
      initialsRow.appendChild(fieldCell);
      
      // Alert cell (empty for initials)
      const alertCell = document.createElement("td");
      alertCell.className = "alert-cell sticky-alert";
      alertCell.textContent = "";
      initialsRow.appendChild(alertCell);
      
      // Time cells
      timeCols.forEach((time, index) => {
        const timeCell = document.createElement("td");
        timeCell.className = "time-cell";
        
        const key = `Initials_${time}`;
        const value = existing[key] || "";
        
        const input = document.createElement("input");
        input.name = key;
        input.type = "text";
        input.className = "form-control form-control-sm";
        input.placeholder = "Initials";
        input.value = value;
        timeCell.appendChild(input);
        initialsRow.appendChild(timeCell);
      });
      
      tbody.appendChild(initialsRow);
      table.appendChild(tbody);
    }

    // Global variables for plotting
    let cervixChart = null;
    let descentChart = null;
    let cervixData = [];
    let descentData = [];
    let unsavedCervixPoints = [];
    let unsavedDescentPoints = [];

    // Initialize plotting charts
    function initializePlottingCharts() {
      // Initialize Cervix Chart
      const cervixCanvas = document.getElementById('cervixChart');
      if (cervixCanvas) {
        cervixChart = cervixCanvas.getContext('2d');
        setupChart(cervixCanvas, 'cervix');
      }
      
      // Initialize Descent Chart
      const descentCanvas = document.getElementById('descentChart');
      if (descentCanvas) {
        descentChart = descentCanvas.getContext('2d');
        setupChart(descentCanvas, 'descent');
      }
      
      // Update initial status
      updateChartStatus();
    }

    // Setup chart with grid and labels
    function setupChart(canvas, type) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      
      // Clear canvas
      ctx.clearRect(0, 0, width, height);
      
      // Draw grid
      drawGrid(ctx, width, height, type);
      
      // Draw labels
      drawLabels(ctx, width, height, type);
      
      // Redraw all saved points
      redrawSavedPoints(canvas, type);
      
      // Redraw all unsaved points
      redrawUnsavedPoints(canvas, type);
      
      // Add click/touch event listeners
      addChartEventListeners(canvas, type);
    }

    // Draw grid lines
    function drawGrid(ctx, width, height, type) {
      ctx.strokeStyle = '#e5e7eb';
      ctx.lineWidth = 1;
      
      // Vertical lines (time intervals)
      const timeIntervals = type === 'cervix' ? 15 : 15; // 15 hours
      for (let i = 0; i <= timeIntervals; i++) {
        const x = (width * 0.1) + (i * (width * 0.8) / timeIntervals);
        ctx.beginPath();
        ctx.moveTo(x, height * 0.1);
        ctx.lineTo(x, height * 0.9);
        ctx.stroke();
      }
      
      // Horizontal lines (cervix/descent values)
      const valueIntervals = type === 'cervix' ? 6 : 6; // 6 levels
      for (let i = 0; i <= valueIntervals; i++) {
        const y = height * 0.1 + (i * (height * 0.8) / valueIntervals);
        ctx.beginPath();
        ctx.moveTo(width * 0.1, y);
        ctx.lineTo(width * 0.9, y);
        ctx.stroke();
      }
    }

    // Draw chart labels
    function drawLabels(ctx, width, height, type) {
      ctx.fillStyle = '#374151';
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';
      
      // Time labels (x-axis)
      const timeIntervals = type === 'cervix' ? 15 : 15;
      for (let i = 0; i <= timeIntervals; i++) {
        const x = (width * 0.1) + (i * (width * 0.8) / timeIntervals);
        const time = i === 0 ? '0h' : `${i}h`;
        ctx.fillText(time, x, height * 0.95);
      }
      
      // Value labels (y-axis)
      if (type === 'cervix') {
        const cervixValues = ['10cm', '9cm', '8cm', '7cm', '6cm', '5cm'];
        for (let i = 0; i < cervixValues.length; i++) {
          const y = height * 0.1 + (i * (height * 0.8) / (cervixValues.length - 1));
          ctx.fillText(cervixValues[i], width * 0.05, y + 4);
        }
      } else {
        const descentValues = ['5', '4', '3', '2', '1', '0'];
        for (let i = 0; i < descentValues.length; i++) {
          const y = height * 0.1 + (i * (height * 0.8) / (descentValues.length - 1));
          ctx.fillText(descentValues[i], width * 0.05, y + 4);
        }
      }
      
      // Chart title
      ctx.font = 'bold 16px Arial';
      ctx.fillText(type === 'cervix' ? 'Cervical Dilation Progress' : 'Fetal Descent Progress', width / 2, height * 0.05);
    }

    // Add event listeners for chart interaction
    function addChartEventListeners(canvas, type) {
      // Mouse events
      canvas.addEventListener('click', (e) => handleChartClick(e, canvas, type));
      
      // Touch events for mobile
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        // Create a synthetic event
        const syntheticEvent = {
          offsetX: x,
          offsetY: y
        };
        handleChartClick(syntheticEvent, canvas, type);
      });
    }

    // Handle chart clicks/touches
    function handleChartClick(e, canvas, type) {
      const rect = canvas.getBoundingClientRect();
      const x = e.offsetX;
      const y = e.offsetY;
      
      // Convert pixel coordinates to chart values
      const timeValue = Math.round(((x - rect.width * 0.1) / (rect.width * 0.8)) * 15);
      const valueIndex = Math.round(((y - rect.height * 0.1) / (rect.height * 0.8)) * 5);
      
      if (timeValue >= 0 && timeValue <= 15 && valueIndex >= 0 && valueIndex <= 5) {
        addPlotPoint(canvas, type, timeValue, valueIndex);
      }
    }

    // Add a plot point to the chart (as unsaved)
    function addPlotPoint(canvas, type, time, value) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      
      // Calculate pixel coordinates
      const x = (width * 0.1) + (time * (width * 0.8) / 15);
      const y = height * 0.1 + (value * (height * 0.8) / 5);
      
      // Create the data point
      const dataPoint = { time, value, x, y, saved: false };
      
      // Add to unsaved points
      if (type === 'cervix') {
        unsavedCervixPoints.push(dataPoint);
      } else {
        unsavedDescentPoints.push(dataPoint);
      }
      
      // Draw the plot point with unsaved style
      ctx.fillStyle = type === 'cervix' ? '#60a5fa' : '#34d399'; // Lighter color for unsaved
      ctx.font = 'bold 18px Arial'; // Smaller font for unsaved points
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      if (type === 'cervix') {
        ctx.fillText('X', x, y);
      } else {
        ctx.fillText('O', x, y);
      }
      
      // Update status indicators
      updateChartStatus();
      
      // Check for alerts based on WHO LCG guidelines
      checkPlottingAlerts(type, time, value);
    }

    // Check for plotting alerts based on WHO LCG guidelines
    function checkPlottingAlerts(type, time, value) {
      if (type === 'cervix') {
        // WHO LCG Cervix Alert Guidelines
        const cervixValues = [10, 9, 8, 7, 6, 5];
        const alertThresholds = ['', '‚â• 2h', '‚â• 2.5h', '‚â• 3h', '‚â• 5h', '‚â• 6h'];
        
        if (alertThresholds[value] && time > 0) {
          console.log(`‚ö†Ô∏è Cervix Alert: ${cervixValues[value]}cm at ${time}h - ${alertThresholds[value]}`);
          // You can add visual alerts here
        }
      } else {
        // WHO LCG Descent Alert Guidelines
        if (time >= 12 && value > 0) {
          console.log(`‚ö†Ô∏è Descent Alert: Second stage - pushing should begin`);
          // You can add visual alerts here
        }
      }
    }

    // Clear only unsaved points (keep saved data)
    function clearCervixChart() {
      if (cervixChart) {
        unsavedCervixPoints = [];
        setupChart(document.getElementById('cervixChart'), 'cervix');
        updateChartStatus();
        console.log('üßπ Cleared unsaved cervix points');
      }
    }

    function clearDescentChart() {
      if (descentChart) {
        unsavedDescentPoints = [];
        setupChart(document.getElementById('descentChart'), 'descent');
        updateChartStatus();
        console.log('üßπ Cleared unsaved descent points');
      }
    }

    // Clear ALL data (both saved and unsaved)
    async function clearAllCervixData() {
      if (confirm('‚ö†Ô∏è This will permanently delete ALL cervix plot data. Are you sure?')) {
        try {
          // Clear from Firestore
          const base = db.collection("patients").doc(patientId);
          await base.collection("plotData").doc("cervix").delete();
          
          // Clear local data
          cervixData = [];
          unsavedCervixPoints = [];
          
          // Redraw chart
          setupChart(document.getElementById('cervixChart'), 'cervix');
          updateChartStatus();
          
          console.log('üóëÔ∏è Cleared all cervix data');
        } catch (error) {
          console.error('‚ùå Error clearing cervix data:', error);
        }
      }
    }

    async function clearAllDescentData() {
      if (confirm('‚ö†Ô∏è This will permanently delete ALL descent plot data. Are you sure?')) {
        try {
          // Clear from Firestore
          const base = db.collection("patients").doc(patientId);
          await base.collection("plotData").doc("descent").delete();
          
          // Clear local data
          descentData = [];
          unsavedDescentPoints = [];
          
          // Redraw chart
          setupChart(document.getElementById('descentChart'), 'descent');
          updateChartStatus();
          
          console.log('üóëÔ∏è Cleared all descent data');
        } catch (error) {
          console.error('‚ùå Error clearing descent data:', error);
        }
      }
    }

    // Redraw saved points
    function redrawSavedPoints(canvas, type) {
      const data = type === 'cervix' ? cervixData : descentData;
      const ctx = canvas.getContext('2d');
      
      ctx.fillStyle = type === 'cervix' ? '#3b82f6' : '#10b981';
      ctx.font = 'bold 24px Arial'; // Larger font for saved points
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      data.forEach(point => {
        if (type === 'cervix') {
          ctx.fillText('X', point.x, point.y);
        } else {
          ctx.fillText('O', point.x, point.y);
        }
      });
    }

    // Redraw unsaved points
    function redrawUnsavedPoints(canvas, type) {
      const data = type === 'cervix' ? unsavedCervixPoints : unsavedDescentPoints;
      const ctx = canvas.getContext('2d');
      
      ctx.fillStyle = type === 'cervix' ? '#60a5fa' : '#34d399'; // Lighter color for unsaved
      ctx.font = 'bold 18px Arial'; // Smaller font for unsaved points
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      data.forEach(point => {
        if (type === 'cervix') {
          ctx.fillText('X', point.x, point.y);
        } else {
          ctx.fillText('O', point.x, point.y);
        }
      });
    }

    // Save plotting data to Firestore
    async function savePlotData() {
      try {
        // Check if user is authenticated
        if (!firebase.auth().currentUser) {
          throw new Error('User not authenticated');
        }

        const base = db.collection("patients").doc(patientId);
        
        // Combine saved and unsaved data
        const allCervixData = [...cervixData, ...unsavedCervixPoints];
        const allDescentData = [...descentData, ...unsavedDescentPoints];
        
        // Save cervix plot data
        if (allCervixData.length > 0) {
          await base.collection("plotData").doc("cervix").set({
            data: allCervixData,
            timestamp: new Date().toISOString(),
            savedBy: firebase.auth().currentUser.uid
          });
          cervixData = allCervixData;
          unsavedCervixPoints = [];
        }
        
        // Save descent plot data
        if (allDescentData.length > 0) {
          await base.collection("plotData").doc("descent").set({
            data: allDescentData,
            timestamp: new Date().toISOString(),
            savedBy: firebase.auth().currentUser.uid
          });
          descentData = allDescentData;
          unsavedDescentPoints = [];
        }
        
        // Show success message
        showSaveSuccess();
        console.log('‚úÖ Plot data saved successfully');
        
        // Redraw charts to show saved state
        if (cervixChart) {
          setupChart(document.getElementById('cervixChart'), 'cervix');
        }
        if (descentChart) {
          setupChart(document.getElementById('descentChart'), 'descent');
        }
        
        // Update status indicators
        updateChartStatus();
        
      } catch (error) {
        console.error('‚ùå Error saving plot data:', error);
        showSaveError(`Failed to save plot data: ${error.message}`);
      }
    }

    // Load plotting data from Firestore
    async function loadPlotData() {
      try {
        const base = db.collection("patients").doc(patientId);
        
        // Load cervix data
        const cervixDoc = await base.collection("plotData").doc("cervix").get();
        if (cervixDoc.exists) {
          cervixData = cervixDoc.data().data || [];
          console.log('üìä Loaded cervix data:', cervixData.length, 'points');
        }
        
        // Load descent data
        const descentDoc = await base.collection("plotData").doc("descent").get();
        if (descentDoc.exists) {
          descentData = descentDoc.data().data || [];
          console.log('üìä Loaded descent data:', descentData.length, 'points');
        }
        
        console.log('‚úÖ Plot data loaded successfully');
        
        // Update status indicators
        updateChartStatus();
      } catch (error) {
        console.error('‚ùå Error loading plot data:', error);
        // Don't show error to user for loading, just log it
      }
    }

    // Alert highlighting function - RESTORED!
    function checkAndHighlightAlert(element) {
      if (!element) return;
      
      const fieldName = element.name;
      const value = element.value;
      
      // Remove any existing alert highlighting
      element.classList.remove('alert-value');
      
      // Check for alert conditions based on field and value
      if (fieldName.includes('Companion') && value === 'N') {
        element.classList.add('alert-value');
      } else if (fieldName.includes('Mobility') && value === 'SP') {
        element.classList.add('alert-value');
      } else if (fieldName.includes('Baseline_FHR')) {
        const fhr = parseFloat(value);
        if (fhr < 110 || fhr > 160) {
          element.classList.add('alert-value');
        }
      } else if (fieldName.includes('Pulse')) {
        const pulse = parseFloat(value);
        if (pulse < 50 || pulse > 100) {
          element.classList.add('alert-value');
        }
      } else if (fieldName.includes('Systolic_BP')) {
        const bp = parseFloat(value);
        if (bp < 90 || bp > 140) {
          element.classList.add('alert-value');
        }
      } else if (fieldName.includes('Diastolic_BP')) {
        const bp = parseFloat(value);
        if (bp < 60 || bp > 90) {
          element.classList.add('alert-value');
        }
      } else if (fieldName.includes('Temperature_C')) {
        const temp = parseFloat(value);
        if (temp < 36.0 || temp > 37.5) {
          element.classList.add('alert-value');
        }
      } else if (fieldName.includes('FHR_deceleration') && value === 'L') {
        element.classList.add('alert-value');
      } else if (fieldName.includes('Amniotic_fluid') && (value === 'M' || value === 'M+' || value === 'M++' || value === 'M+++')) {
        element.classList.add('alert-value');
      } else if (fieldName.includes('Fetal_position') && value === 'T') {
        element.classList.add('alert-value');
      } else if (fieldName.includes('Caput') && (value === '+' || value === '++' || value === '+++')) {
        element.classList.add('alert-value');
      } else if (fieldName.includes('Moulding') && (value === '++' || value === '+++')) {
        element.classList.add('alert-value');
      } else if (fieldName.includes('Pain_Relief') && value === 'N') {
        element.classList.add('alert-value');
      } else if (fieldName.includes('Oral_fluids') && value === 'N') {
        element.classList.add('alert-value');
      } else if (fieldName.includes('Contractions_per_10_min')) {
        const contractions = parseFloat(value);
        if (contractions < 2 || contractions > 5) {
          element.classList.add('alert-value');
        }
      } else if (fieldName.includes('Duration_of_contractions')) {
        const duration = parseFloat(value);
        if (duration < 20 || duration > 60) {
          element.classList.add('alert-value');
        }
      } else if (fieldName.includes('Urine')) {
        if (value.includes('P') || value.includes('A')) {
          element.classList.add('alert-value');
        }
      }
    }

    // Add alert highlighting to all form elements
    function addAlertHighlighting() {
      // Add event listeners for real-time alert checking
      document.addEventListener('change', function(e) {
        if (e.target.matches('select, input')) {
          checkAndHighlightAlert(e.target);
        }
      });
      
      document.addEventListener('input', function(e) {
        if (e.target.matches('input[type="number"]')) {
          checkAndHighlightAlert(e.target);
        }
      });
    }

    // Update chart status indicators
    function updateChartStatus() {
      // Update cervix chart status
      const cervixSavedElement = document.getElementById('cervixSavedCount');
      const cervixUnsavedElement = document.getElementById('cervixUnsavedCount');
      if (cervixSavedElement) cervixSavedElement.textContent = cervixData.length;
      if (cervixUnsavedElement) cervixUnsavedElement.textContent = unsavedCervixPoints.length;
      
      // Update descent chart status
      const descentSavedElement = document.getElementById('descentSavedCount');
      const descentUnsavedElement = document.getElementById('descentUnsavedCount');
      if (descentSavedElement) descentSavedElement.textContent = descentData.length;
      if (descentUnsavedElement) descentUnsavedElement.textContent = unsavedDescentPoints.length;
    }

    // Redraw chart with existing data
    function redrawChart(type) {
      const canvas = document.getElementById(type === 'cervix' ? 'cervixChart' : 'descentChart');
      if (!canvas) return;
      
      setupChart(canvas, type);
      
      // Redraw all saved points
      const data = type === 'cervix' ? cervixData : descentData;
      data.forEach(point => {
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = type === 'cervix' ? '#3b82f6' : '#10b981';
        ctx.font = 'bold 20px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        if (type === 'cervix') {
          ctx.fillText('X', point.x, point.y);
        } else {
          ctx.fillText('O', point.x, point.y);
        }
      });
    }
  </script>
</body>
<footer class="footer">
  ¬© 2025 Labour Care App &mdash; Designed for clinical excellence
</footer>
</html>