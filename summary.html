<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WHO Labour Summary Chart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <style>
    body { font-size: 0.85rem; }
    table { border-collapse: collapse; table-layout: fixed; }
    th, td { border: 1px solid #ddd; text-align: center; vertical-align: middle; padding: 0.4em; }
    th.section-header { background-color: #f0f0f0; font-weight: bold; }
    td.alert { background-color: #ffe6e6; }
    .section-title { background-color: #f8f9fa; font-weight: bold; text-align: left; padding-left: 8px; }
    .small-note { font-size: 0.75rem; color: #777; }
    .rotate { transform: rotate(-90deg); white-space: nowrap; }
    .hour-col { width: 70px; }
    .label-cell { background: #eee; font-weight: bold; }
  </style>
</head>
<body class="container-fluid my-3">
  <h3>WHO Labour Summary Chart</h3>
  <div id="patientInfo" class="mb-3"></div>

  <div class="table-responsive">
    <table class="table" id="whoTable">
      <thead>
        <tr>
          <th class="label-cell">Observation</th>
          <th>01:00</th><th>01:30</th><th>02:00</th><th>02:30</th><th>03:00</th>
          <th>03:30</th><th>04:00</th><th>04:30</th><th>05:00</th><th>05:30</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td class="label-cell">Pulse</td></tr>
        <tr><td class="label-cell">Temperature</td></tr>
        <tr><td class="label-cell">BP</td></tr>
        <tr><td class="label-cell">Contractions</td></tr>
        <tr><td class="label-cell">Cervix</td></tr>
        <tr><td class="label-cell">Descent</td></tr>
        <tr><td class="label-cell">FHR</td></tr>
        <tr><td class="label-cell">Oxytocin</td></tr>
        <tr><td class="label-cell">Initials</td></tr>
      </tbody>
    </table>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("patient");

    function getTimeSlot(dateStr) {
      const dt = new Date(dateStr);
      const hour = dt.getHours().toString().padStart(2, "0");
      const min = dt.getMinutes() < 30 ? "00" : "30";
      return hour + ":" + min;
    }

    async function loadData() {
      const pat = await db.collection("patients").doc(patientId).get();
      if (!pat.exists) return;
      const patient = pat.data();
      document.getElementById("patientInfo").innerHTML = `
        <strong>Name:</strong> ${patient.name} | <strong>Age:</strong> ${patient.age} | 
        <strong>Parity:</strong> ${patient.parity} | <strong>ID:</strong> ${patientId}
      `;

      const recordsSnap = await db.collection("patients").doc(patientId).collection("records").orderBy("timestamp").get();
      const grouped = {};

      recordsSnap.forEach(doc => {
        const r = doc.data();
        const time = getTimeSlot(r.timestamp);
        grouped[time] = r;
      });

      const times = ["01:00","01:30","02:00","02:30","03:00","03:30","04:00","04:30","05:00","05:30"];
      const fields = ["pulse","temperature","bp","contractions","cervix","descent","fhr","oxytocin","initials"];
      const tableBody = document.getElementById("tableBody");
      const rows = fields.map(() => []);

      times.forEach(t => {
        const r = grouped[t] || {};
        fields.forEach((f, i) => {
          const val = r[f] || "";
          const alert = (f === "pulse" && parseInt(val) > 100) ? "alert" : "";
          rows[i].push(`<td class="${alert}">${val}</td>`);
        });
      });

      const rowEls = rows.map((cells, i) => {
        const tr = tableBody.children[i];
        tr.innerHTML += cells.join("");
        return tr.outerHTML;
      });

      tableBody.innerHTML = rowEls.join("");
    }

    loadData();
  </script>
</body>
</html>
