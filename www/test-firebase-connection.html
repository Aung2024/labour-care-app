<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Connection Test - Mac WiFi</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 2rem auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    .test-card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1rem 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-card h3 {
      margin-top: 0;
      color: #333;
    }
    .status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-weight: 600;
      margin: 0.5rem 0;
    }
    .status.success {
      background: #10b981;
      color: white;
    }
    .status.failure {
      background: #ef4444;
      color: white;
    }
    .status.testing {
      background: #f59e0b;
      color: white;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }
    button:hover {
      background: #1d4ed8;
    }
    pre {
      background: #1f2937;
      color: #10b981;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.875rem;
    }
    .solution {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
    }
    .solution h4 {
      margin-top: 0;
      color: #92400e;
    }
    code {
      background: #e5e7eb;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1>üîç Firebase Connection Test - Mac WiFi</h1>
  
  <div class="test-card">
    <h3>Quick Test</h3>
    <button onclick="runQuickTest()">Test Firebase Connection</button>
    <div id="quickTestResult"></div>
  </div>

  <div class="test-card">
    <h3>Detailed Diagnostics</h3>
    <button onclick="runFullDiagnostics()">Run Full Diagnostics</button>
    <div id="diagnosticsResult"></div>
  </div>

  <div class="test-card">
    <h3>Mac-Specific Solutions</h3>
    
    <div class="solution">
      <h4>Solution 1: Change DNS Settings (Recommended)</h4>
      <ol>
        <li>Open <strong>System Settings</strong> (or System Preferences on older macOS)</li>
        <li>Go to <strong>Network</strong></li>
        <li>Select your WiFi connection</li>
        <li>Click <strong>Details...</strong> or the gear icon</li>
        <li>Go to <strong>DNS</strong> tab</li>
        <li>Click <strong>+</strong> to add DNS servers:
          <ul>
            <li><code>8.8.8.8</code> (Google DNS)</li>
            <li><code>8.8.4.4</code> (Google DNS secondary)</li>
            <li>OR</li>
            <li><code>1.1.1.1</code> (Cloudflare DNS)</li>
            <li><code>1.0.0.1</code> (Cloudflare DNS secondary)</li>
          </ul>
        </li>
        <li>Click <strong>OK</strong> and <strong>Apply</strong></li>
        <li>Disconnect and reconnect to WiFi</li>
        <li>Refresh this page and test again</li>
      </ol>
    </div>

    <div class="solution">
      <h4>Solution 2: Test with Mobile Hotspot</h4>
      <ol>
        <li>Turn on mobile hotspot on your phone</li>
        <li>Connect your Mac to the mobile hotspot</li>
        <li>Test Firebase connection again</li>
        <li>If it works, your WiFi network is definitely blocking Firebase</li>
      </ol>
    </div>

    <div class="solution">
      <h4>Solution 3: Flush DNS Cache (Terminal)</h4>
      <p>Open Terminal and run:</p>
      <pre>sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder</pre>
      <p>Then test again.</p>
    </div>

    <div class="solution">
      <h4>Solution 4: Test Domain Access</h4>
      <button onclick="testDomains()">Test Firebase Domains</button>
      <div id="domainTestResult"></div>
    </div>

    <div class="solution">
      <h4>Solution 5: Use VPN</h4>
      <p>If you have VPN access, connect to VPN and test again. This will bypass network blocks.</p>
    </div>
  </div>

  <div class="test-card">
    <h3>Network Information</h3>
    <div id="networkInfo"></div>
  </div>

  <script>
    // Load Firebase SDK
    const firebaseScripts = [
      'https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js',
      'https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js',
      'https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js'
    ];

    let firebaseLoaded = false;
    let loadCount = 0;

    firebaseScripts.forEach(src => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = () => {
        loadCount++;
        if (loadCount === firebaseScripts.length) {
          // Load firebase config
          const configScript = document.createElement('script');
          configScript.src = 'js/firebase.js';
          configScript.onload = () => {
            firebaseLoaded = true;
            console.log('‚úÖ Firebase loaded');
          };
          document.head.appendChild(configScript);
        }
      };
      document.head.appendChild(script);
    });

    async function runQuickTest() {
      const resultDiv = document.getElementById('quickTestResult');
      resultDiv.innerHTML = '<span class="status testing">Testing...</span>';
      
      try {
        if (!firebaseLoaded) {
          throw new Error('Firebase not loaded yet. Wait a moment and try again.');
        }

        const db = firebase.firestore();
        const testRef = db.collection('_test').doc('connection');
        
        const startTime = performance.now();
        await testRef.get({ source: 'server' });
        const endTime = performance.now();
        const latency = Math.round(endTime - startTime);

        resultDiv.innerHTML = `
          <span class="status success">‚úÖ Connection Successful!</span>
          <p>Latency: ${latency}ms</p>
          <p>Your Mac can connect to Firebase on this network.</p>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <span class="status failure">‚ùå Connection Failed</span>
          <p><strong>Error:</strong> ${error.message}</p>
          <p><strong>Code:</strong> ${error.code || 'unknown'}</p>
          <p>Your WiFi network is likely blocking Firebase. Try the solutions below.</p>
        `;
      }
    }

    async function runFullDiagnostics() {
      const resultDiv = document.getElementById('diagnosticsResult');
      resultDiv.innerHTML = '<span class="status testing">Running diagnostics...</span>';

      const results = {
        timestamp: new Date().toISOString(),
        platform: navigator.platform,
        userAgent: navigator.userAgent,
        onLine: navigator.onLine,
        tests: {}
      };

      // Test 1: DNS Resolution
      results.tests.dns = await testDNS();
      
      // Test 2: Firebase Auth Domain
      results.tests.firebaseAuth = await testDomain('labourcare-2481a.firebaseapp.com');
      
      // Test 3: Firestore API
      results.tests.firestoreAPI = await testDomain('firestore.googleapis.com');
      
      // Test 4: Google Static
      results.tests.googleStatic = await testDomain('www.gstatic.com');
      
      // Test 5: Firestore Connection
      if (firebaseLoaded) {
        results.tests.firestoreConnection = await testFirestore();
      }

      let html = '<h4>Test Results:</h4>';
      for (const [testName, testResult] of Object.entries(results.tests)) {
        const status = testResult.success ? 'success' : 'failure';
        const icon = testResult.success ? '‚úÖ' : '‚ùå';
        html += `
          <div style="margin: 0.5rem 0;">
            <span class="status ${status}">${icon} ${testName}</span>
            <p style="margin: 0.25rem 0; font-size: 0.9rem;">${testResult.message || testResult.error || 'Test completed'}</p>
          </div>
        `;
      }

      html += '<details style="margin-top: 1rem;"><summary>Full Results (JSON)</summary><pre>' + JSON.stringify(results, null, 2) + '</pre></details>';
      resultDiv.innerHTML = html;
    }

    async function testDNS() {
      try {
        const startTime = performance.now();
        const response = await fetch('https://labourcare-2481a.firebaseapp.com/.well-known/security.txt', {
          method: 'HEAD',
          mode: 'no-cors',
          cache: 'no-cache'
        });
        const endTime = performance.now();
        return {
          success: true,
          latency: Math.round(endTime - startTime),
          message: `DNS resolution successful (${Math.round(endTime - startTime)}ms)`
        };
      } catch (error) {
        return {
          success: false,
          error: error.message,
          message: 'DNS resolution failed - Domain may be blocked'
        };
      }
    }

    async function testDomain(domain) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        const startTime = performance.now();
        
        await fetch(`https://${domain}`, {
          method: 'HEAD',
          mode: 'no-cors',
          signal: controller.signal,
          cache: 'no-cache'
        });
        
        clearTimeout(timeoutId);
        const endTime = performance.now();
        return {
          success: true,
          latency: Math.round(endTime - startTime),
          message: `${domain} is reachable (${Math.round(endTime - startTime)}ms)`
        };
      } catch (error) {
        return {
          success: false,
          domain: domain,
          error: error.message,
          message: `${domain} is NOT reachable - May be blocked`
        };
      }
    }

    async function testFirestore() {
      try {
        if (!firebase || !firebase.firestore) {
          return { success: false, message: 'Firebase not initialized' };
        }
        
        const db = firebase.firestore();
        const startTime = performance.now();
        await db.collection('_test').doc('connection').get({ source: 'server' });
        const endTime = performance.now();
        
        return {
          success: true,
          latency: Math.round(endTime - startTime),
          message: `Firestore connection successful (${Math.round(endTime - startTime)}ms)`
        };
      } catch (error) {
        return {
          success: false,
          error: error.message,
          code: error.code,
          message: `Firestore connection failed: ${error.message}`
        };
      }
    }

    async function testDomains() {
      const resultDiv = document.getElementById('domainTestResult');
      resultDiv.innerHTML = '<span class="status testing">Testing domains...</span>';

      const domains = [
        'labourcare-2481a.firebaseapp.com',
        'firestore.googleapis.com',
        'www.gstatic.com',
        'www.googleapis.com'
      ];

      let html = '<h4>Domain Test Results:</h4>';
      for (const domain of domains) {
        const result = await testDomain(domain);
        const status = result.success ? 'success' : 'failure';
        const icon = result.success ? '‚úÖ' : '‚ùå';
        html += `
          <div style="margin: 0.5rem 0;">
            <span class="status ${status}">${icon} ${domain}</span>
            <p style="margin: 0.25rem 0; font-size: 0.9rem;">${result.message}</p>
          </div>
        `;
      }

      resultDiv.innerHTML = html;
    }

    // Display network info
    function displayNetworkInfo() {
      const infoDiv = document.getElementById('networkInfo');
      const info = {
        platform: navigator.platform,
        userAgent: navigator.userAgent,
        onLine: navigator.onLine,
        language: navigator.language,
        cookieEnabled: navigator.cookieEnabled
      };

      if (navigator.connection) {
        info.connection = {
          effectiveType: navigator.connection.effectiveType,
          downlink: navigator.connection.downlink,
          rtt: navigator.connection.rtt,
          saveData: navigator.connection.saveData
        };
      }

      infoDiv.innerHTML = '<pre>' + JSON.stringify(info, null, 2) + '</pre>';
    }

    // Run on load
    window.addEventListener('load', () => {
      displayNetworkInfo();
      setTimeout(() => {
        if (firebaseLoaded) {
          console.log('Ready to test');
        }
      }, 2000);
    });
  </script>
</body>
</html>

