<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Postpartum Visit History - Maternal & Child Health Care System</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="js/firebase.js"></script>
  <script src="js/auth-guard.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root {
      --primary-color: #7c3aed;
      --secondary-color: #6d28d9;
      --accent-color: #a78bfa;
      --light-bg: #faf5ff;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    body {
      background: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .header-section {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
    }

    .patient-info {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 1px solid #0ea5e9;
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 2rem;
    }

    .patient-info h4 {
      color: #0369a1;
      margin-bottom: 1rem;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .info-label {
      font-weight: 600;
      color: #374151;
    }

    .info-value {
      color: #6b7280;
    }

    .visits-container {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      box-shadow: var(--card-shadow);
      margin-bottom: 2rem;
    }

    .visit-card {
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    .visit-card:hover {
      background: #f1f5f9;
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.15);
    }

    .visit-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .visit-number {
      background: var(--primary-color);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .visit-date {
      color: var(--secondary-color);
      font-weight: 600;
    }

    .visit-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .detail-item {
      background: white;
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .detail-label {
      font-size: 0.75rem;
      color: #6b7280;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .detail-value {
      color: #374151;
      font-weight: 500;
    }

    .danger-signs-present {
      background: #fef2f2;
      border-left: 4px solid #dc2626;
      padding: 0.75rem;
      border-radius: 0 8px 8px 0;
      margin-top: 1rem;
    }

    .danger-signs-present .detail-label {
      color: #dc2626;
    }

    .btn-primary-action {
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      border: none;
      color: white;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .btn-primary-action:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(124, 58, 237, 0.3);
      color: white;
    }

    .loading-spinner {
      text-align: center;
      padding: 3rem;
      color: var(--primary-color);
    }

    /* Language Switcher */
    .language-switcher {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .language-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 0.4rem 0.75rem;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .language-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .language-btn.active {
      background: rgba(255, 255, 255, 0.9);
      color: var(--primary-color);
      font-weight: 600;
    }

    .flag-icon {
      font-size: 1rem;
    }

    /* Professional Report Styling */
    .report-section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid #e5e7eb;
    }

    .report-section-title {
      color: var(--primary-color);
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--primary-color);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .report-section-title i {
      font-size: 1rem;
    }

    .report-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .report-item {
      background: #f9fafb;
      padding: 0.875rem;
      border-radius: 8px;
      border-left: 3px solid var(--primary-color);
    }

    .report-label {
      font-size: 0.8rem;
      color: #6b7280;
      font-weight: 600;
      margin-bottom: 0.375rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .report-value {
      color: #1f2937;
      font-weight: 500;
      font-size: 0.95rem;
    }

    .report-value.yes {
      color: #059669;
      font-weight: 600;
    }

    .report-value.no {
      color: #6b7280;
    }

    .visit-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }

    .visit-card:hover {
      border-color: var(--primary-color);
      box-shadow: 0 6px 20px rgba(124, 58, 237, 0.15);
    }

    .visit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #e5e7eb;
    }

    .visit-number {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 0.625rem 1.25rem;
      border-radius: 25px;
      font-weight: 700;
      font-size: 0.95rem;
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    }

    .visit-date {
      color: var(--secondary-color);
      font-weight: 600;
      font-size: 1rem;
    }

    .danger-signs-alert {
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      border-left: 4px solid #dc2626;
      padding: 1rem;
      border-radius: 0 8px 8px 0;
      margin-top: 1.5rem;
    }

    .danger-signs-alert .report-label {
      color: #dc2626;
      font-size: 0.85rem;
    }

    .danger-signs-alert .report-value {
      color: #991b1b;
      font-weight: 600;
    }

    .treatment-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .treatment-badge {
      background: var(--primary-color);
      color: white;
      padding: 0.375rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .contraceptive-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .contraceptive-badge {
      background: #10b981;
      color: white;
      padding: 0.375rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .notes-section {
      background: #f0f9ff;
      border-left: 3px solid #0ea5e9;
      padding: 1rem;
      border-radius: 0 8px 8px 0;
      margin-top: 1rem;
    }

    .notes-section .report-label {
      color: #0369a1;
    }

    .notes-section .report-value {
      color: #0c4a6e;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    @media (max-width: 768px) {
      .header-section {
        padding: 1.5rem 0;
      }
      
      .visits-container {
        padding: 1rem;
        margin: 0 1rem 1rem;
      }
      
      .visit-card {
        padding: 1.25rem;
      }

      .report-grid {
        grid-template-columns: 1fr;
      }

      .report-section {
        padding: 1rem;
      }

      .visit-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }

      .header-section .d-flex {
        flex-wrap: wrap;
        gap: 0.5rem !important;
        justify-content: flex-start !important;
      }

      .language-switcher {
        order: 1;
      }

      .header-section .btn-outline-light {
        order: 2;
      }
    }
  </style>
</head>
<body>
  <!-- Header Section -->
  <div class="header-section">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="mb-2">
            <i class="fas fa-history me-3"></i>
            <span class="lang-text" data-en="Postpartum Visit History" data-my="·Äô·ÄΩ·Ä±·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äô·Ä≠·ÄÅ·ÄÑ·Ä∫ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äõ·Äæ·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Äæ·ÄØ ·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏">Postpartum Visit History</span>
          </h1>
          <p class="mb-0 opacity-75 lang-text" data-en="View all postpartum care visits for this patient" data-my="·Ä§·Äú·Ä∞·Äî·Ä¨·Åè ·Äô·ÄΩ·Ä±·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äô·Ä≠·ÄÅ·ÄÑ·Ä∫ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äõ·Äæ·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Äæ·ÄØ ·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äõ·Äæ·ÄØ·Äõ·Äî·Ä∫">
            View all postpartum care visits for this patient
          </p>
        </div>
        <div class="col-md-4 text-md-end">
          <div class="d-flex align-items-center justify-content-end gap-3">
            <!-- Language Switcher -->
            <div class="language-switcher">
              <button type="button" class="btn btn-sm language-btn active" data-lang="en" title="English">
                <span class="flag-icon">üá¨üáß</span> ENG
              </button>
              <button type="button" class="btn btn-sm language-btn" data-lang="my" title="·Äô·Äº·Äî·Ä∫·Äô·Ä¨">
                <span class="flag-icon">üá≤üá≤</span> MM
              </button>
            </div>
            <a href="postpartum-care.html" class="btn btn-outline-light btn-sm">
              <i class="fas fa-arrow-left me-2"></i><span class="lang-text" data-en="Back to Postpartum Care" data-my="·Äô·ÄΩ·Ä±·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äô·Ä≠·ÄÅ·ÄÑ·Ä∫ ·Äï·Äº·ÄØ·ÄÖ·ÄØ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äõ·Äæ·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Äæ·ÄØ·Äû·Ä≠·ÄØ·Ä∑ ·Äï·Äº·Äî·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äõ·Äî·Ä∫">Back to Postpartum Care</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Patient Information -->
    <div class="patient-info">
      <h4><i class="fas fa-user me-2"></i><span class="lang-text" data-en="Patient Information" data-my="·Äú·Ä∞·Äî·Ä¨ ·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Ä°·Äú·ÄÄ·Ä∫">Patient Information</span></h4>
      <div class="info-row">
        <span class="info-label lang-text" data-en="Name:" data-my="·Ä°·Äô·Ää·Ä∫:">Name:</span>
        <span class="info-value" id="patientName">Loading...</span>
      </div>
      <div class="info-row">
        <span class="info-label lang-text" data-en="Age:" data-my="·Ä°·Äû·ÄÄ·Ä∫:">Age:</span>
        <span class="info-value" id="patientAge">Loading...</span>
      </div>
      <div class="info-row">
        <span class="info-label lang-text" data-en="Phone:" data-my="·Äñ·ÄØ·Äî·Ä∫·Ä∏:">Phone:</span>
        <span class="info-value" id="patientPhone">Loading...</span>
      </div>
    </div>

    <!-- Visit History -->
    <div class="visits-container">
      <h4 class="mb-3"><i class="fas fa-clipboard-list me-2"></i><span class="lang-text" data-en="Visit History" data-my="·Äº·Äû·Äô·Äæ·ÄØ ·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏">Visit History</span></h4>
      <div id="visitsList">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading visit history...</p>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
    
      <p class="copyright">MNCH App 2025 | Developed by Jhpiego Myanmar for MoH.</p>
    </div>
  </footer>

  <script>
    let currentUser = null;
    let currentPatient = null;
    let postpartumVisits = [];
    
    // Language switching
    let currentLanguage = localStorage.getItem('appLanguage') || 'en';

    // Language switching function
    function switchLanguage(lang) {
      currentLanguage = lang;
      localStorage.setItem('appLanguage', lang);
      
      // Update active button
      document.querySelectorAll('.language-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      // Update all text elements with lang-text class
      document.querySelectorAll('.lang-text').forEach(el => {
        const text = el.dataset[lang] || el.dataset.en || el.textContent;
        el.innerHTML = text.replace(/&#10;/g, '<br>').replace(/\n/g, '<br>');
      });
      
      // Redisplay visits with new language
      if (postpartumVisits.length > 0) {
        displayVisits();
      }
    }

    // Initialize Firebase and load data
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await loadVisitHistory();
      } else {
        window.location.href = 'login.html';
      }
    });

    // Load visit history
    async function loadVisitHistory() {
      try {
        showLoading(true);
        
        const urlParams = new URLSearchParams(window.location.search);
        const patientId = urlParams.get('patient');
        
        if (!patientId) {
          alert('No patient ID provided');
          window.location.href = 'postpartum-care.html';
          return;
        }
        
        const db = firebase.firestore();
        
        // Load patient data
        const patientDoc = await db.collection('patients').doc(patientId).get();
        if (!patientDoc.exists) {
          alert('Patient not found');
          window.location.href = 'postpartum-care.html';
          return;
        }
        
        currentPatient = { id: patientDoc.id, ...patientDoc.data() };
        
        // Load postpartum visits
        const visitsSnapshot = await db.collection('patients')
          .doc(patientId)
          .collection('postpartum_visits')
          .orderBy('visitDate', 'desc')
          .get();
        
        postpartumVisits = [];
        visitsSnapshot.forEach(doc => {
          postpartumVisits.push({ id: doc.id, ...doc.data() });
        });
        
        // Populate patient info
        populatePatientInfo();
        
        // Display visits
        displayVisits();
        
        showLoading(false);
        
      } catch (error) {
        console.error('Error loading visit history:', error);
        alert('Error loading visit history: ' + error.message);
        showLoading(false);
      }
    }

    // Populate patient information
    function populatePatientInfo() {
      document.getElementById('patientName').textContent = currentPatient.name || 'Unknown';
      document.getElementById('patientAge').textContent = currentPatient.age || 'N/A';
      document.getElementById('patientPhone').textContent = currentPatient.phone || 'Not provided';
    }

    // Display visits
    function displayVisits() {
      const container = document.getElementById('visitsList');
      
      if (postpartumVisits.length === 0) {
        const noVisitsText = currentLanguage === 'my' ? '·Äô·ÄΩ·Ä±·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äô·Ä≠·ÄÅ·ÄÑ·Ä∫ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äõ·Äæ·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Äæ·ÄØ ·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏ ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´' : 'No postpartum visits have been recorded for this patient yet.';
        const recordFirstText = currentLanguage === 'my' ? '·Äï·Äë·Äô·ÄÜ·ÄØ·Ä∂·Ä∏ ·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Äê·ÄÑ·Ä∫·Äõ·Äî·Ä∫' : 'Record First Visit';
        container.innerHTML = `
          <div class="text-center text-muted py-4">
            <i class="fas fa-clipboard-list fa-3x mb-3"></i>
            <h5 class="lang-text" data-en="No Postpartum Visits" data-my="·Äô·ÄΩ·Ä±·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äô·Ä≠·ÄÅ·ÄÑ·Ä∫ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äõ·Äæ·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Äæ·ÄØ ·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏ ·Äô·Äõ·Äæ·Ä≠·Äï·Ä´">No Postpartum Visits</h5>
            <p>${noVisitsText}</p>
            <a href="postpartum-form.html?patient=${currentPatient.id}" class="btn btn-primary-action">
              <i class="fas fa-plus me-2"></i>${recordFirstText}
            </a>
          </div>
        `;
        return;
      }
      
      container.innerHTML = postpartumVisits.map(visit => {
        const hasDangerSigns = visit.dangerSigns && Object.values(visit.dangerSigns).some(sign => sign === true);
        
        // Build Visit Information Section
        const visitInfoSection = `
          <div class="report-section">
            <div class="report-section-title">
              <i class="fas fa-calendar-alt"></i>
              <span>${getLabel('Visit Information')}</span>
            </div>
            <div class="report-grid">
              <div class="report-item">
                <div class="report-label">${getLabel('Visit Date')}</div>
                <div class="report-value">${formatDate(visit.visitDate)}</div>
              </div>
              <div class="report-item">
                <div class="report-label">${getLabel('Visit Number')}</div>
                <div class="report-value">${visit.visitNumber || '-'}</div>
              </div>
              ${visit.deliveredDateTime ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Delivered Date & Time')}</div>
                <div class="report-value">${formatDate(visit.deliveredDateTime)}</div>
              </div>
              ` : ''}
              ${visit.postpartumDays !== null && visit.postpartumDays !== undefined ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Post-partum Period')}</div>
                <div class="report-value">${visit.postpartumDays} ${getLabel('Days')}, ${visit.postpartumHours || 0} ${getLabel('Hours')}</div>
              </div>
              ` : ''}
            </div>
          </div>
        `;
        
        // Build Vital Signs Section
        const vitalSignsSection = `
          <div class="report-section">
            <div class="report-section-title">
              <i class="fas fa-heartbeat"></i>
              <span>${getLabel('Vital Signs')}</span>
            </div>
            <div class="report-grid">
              ${visit.temperature ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Temperature')}</div>
                <div class="report-value">${visit.temperature}¬∞C</div>
              </div>
              ` : ''}
              ${visit.bloodPressure ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Blood Pressure')}</div>
                <div class="report-value">${visit.bloodPressure} mmHg</div>
              </div>
              ` : ''}
              ${visit.pulseRate ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Pulse Rate')}</div>
                <div class="report-value">${visit.pulseRate} bpm</div>
              </div>
              ` : ''}
            </div>
          </div>
        `;
        
        // Build Physical Examination Section
        const physicalExamSection = `
          <div class="report-section">
            <div class="report-section-title">
              <i class="fas fa-stethoscope"></i>
              <span>${getLabel('Physical Examination')}</span>
            </div>
            <div class="report-grid">
              ${visit.breastEngorgement ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Breast Engorgement')}</div>
                <div class="report-value">${formatYesNo(visit.breastEngorgement)}</div>
              </div>
              ` : ''}
              ${visit.nippleCondition ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Nipple Condition')}</div>
                <div class="report-value">${visit.nippleCondition}</div>
              </div>
              ` : ''}
              ${visit.breastMilkProduction ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Breast Milk Production')}</div>
                <div class="report-value">${formatYesNo(visit.breastMilkProduction)}</div>
              </div>
              ` : ''}
              ${visit.uterusInvolution ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Uterine Involution')}</div>
                <div class="report-value">${visit.uterusInvolution}</div>
              </div>
              ` : ''}
              ${visit.vaginalBleeding ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Vaginal Discharge')}</div>
                <div class="report-value">${visit.vaginalBleeding}</div>
              </div>
              ` : ''}
              ${visit.dischargeSmell ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Discharge Smell')}</div>
                <div class="report-value">${visit.dischargeSmell}</div>
              </div>
              ` : ''}
              ${visit.episiotomyHealing ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Episiotomy Healing')}</div>
                <div class="report-value">${visit.episiotomyHealing}</div>
              </div>
              ` : ''}
              ${visit.urination ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Urination')}</div>
                <div class="report-value">${visit.urination}</div>
              </div>
              ` : ''}
              ${visit.constipation ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Constipation')}</div>
                <div class="report-value">${formatYesNo(visit.constipation)}</div>
              </div>
              ` : ''}
              ${visit.mentalHealthAssessment ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Mental Health')}</div>
                <div class="report-value">${visit.mentalHealthAssessment}</div>
              </div>
              ` : ''}
            </div>
          </div>
        `;
        
        // Build Treatment & Counselling Section
        const treatmentSection = `
          <div class="report-section">
            <div class="report-section-title">
              <i class="fas fa-pills"></i>
              <span>${getLabel('Treatment & Counselling')}</span>
            </div>
            <div class="report-grid">
              ${visit.vitaminBComplex ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Vitamin B Complex')}</div>
                <div class="report-value">${formatYesNo(visit.vitaminBComplex)}</div>
              </div>
              ` : ''}
              ${visit.vitaminA ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Vitamin A')}</div>
                <div class="report-value">${formatYesNo(visit.vitaminA)}</div>
              </div>
              ` : ''}
              ${visit.ironFolic ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Iron & Folic Acid')}</div>
                <div class="report-value">${formatYesNo(visit.ironFolic)}</div>
              </div>
              ` : ''}
              ${visit.contraception ? `
              <div class="report-item">
                <div class="report-label">${getLabel('Contraception')}</div>
                <div class="report-value">${formatYesNo(visit.contraception)}</div>
              </div>
              ` : ''}
              ${visit.contraceptiveMethods && Array.isArray(visit.contraceptiveMethods) && visit.contraceptiveMethods.length > 0 ? `
              <div class="report-item" style="grid-column: 1 / -1;">
                <div class="report-label">${getLabel('Contraceptive Methods')}</div>
                <div class="report-value">
                  <div class="contraceptive-badges">
                    ${visit.contraceptiveMethods.map(method => `<span class="badge bg-primary">${method}</span>`).join('')}
                  </div>
                </div>
              </div>
              ` : ''}
            </div>
          </div>
        `;
        
        // Build Danger Signs Section
        const dangerSignsSection = hasDangerSigns ? `
          <div class="report-section">
            <div class="report-section-title">
              <i class="fas fa-exclamation-triangle"></i>
              <span>${getLabel('Danger Signs')}</span>
            </div>
            <div class="danger-signs-alert">
              <i class="fas fa-exclamation-circle"></i>
              <div class="report-value">${getDangerSignsText(visit.dangerSigns)}</div>
            </div>
          </div>
        ` : '';
        
        // Build Additional Information Section
        const additionalInfoSection = (visit.otherSymptoms || visit.treatment || visit.referralGiven || visit.referralReason || visit.clinicalNotes) ? `
          <div class="report-section">
            <div class="report-section-title">
              <i class="fas fa-info-circle"></i>
              <span>${getLabel('Additional Information')}</span>
            </div>
            <div class="notes-section">
              ${visit.otherSymptoms ? `
              <div class="notes-item">
                <div class="report-label">${getLabel('Other Symptoms')}</div>
                <div class="report-value">${visit.otherSymptoms}</div>
              </div>
              ` : ''}
              ${visit.treatment ? `
              <div class="notes-item">
                <div class="report-label">${getLabel('Treatment Given')}</div>
                <div class="report-value">${visit.treatment}</div>
              </div>
              ` : ''}
              ${visit.referralGiven ? `
              <div class="notes-item">
                <div class="report-label">${getLabel('Referral Given')}</div>
                <div class="report-value">${formatYesNo(visit.referralGiven)}</div>
              </div>
              ` : ''}
              ${visit.referralReason ? `
              <div class="notes-item">
                <div class="report-label">${getLabel('Reason for Referral')}</div>
                <div class="report-value">${visit.referralReason}</div>
              </div>
              ` : ''}
              ${visit.clinicalNotes ? `
              <div class="notes-item">
                <div class="report-label">${getLabel('Clinical Notes')}</div>
                <div class="report-value">${visit.clinicalNotes}</div>
              </div>
              ` : ''}
            </div>
          </div>
        ` : '';
        
        return `
          <div class="visit-card">
            <div class="visit-header">
              <span class="visit-number">${getLabel('Visit Number')} #${visit.visitNumber || '-'}</span>
              <span class="visit-date">${formatDate(visit.visitDate)}</span>
            </div>
            
            ${visitInfoSection}
            ${vitalSignsSection}
            ${physicalExamSection}
            ${treatmentSection}
            ${dangerSignsSection}
            ${additionalInfoSection}
          </div>
        `;
      }).join('');
    }

    // Helper function to format date
    function formatDate(dateValue) {
      if (!dateValue) return 'Not recorded';
      try {
        const date = dateValue.toDate ? dateValue.toDate() : new Date(dateValue);
        return date.toLocaleDateString();
      } catch (e) {
        return 'Invalid date';
      }
    }

    // Helper function to format Yes/No values
    function formatYesNo(value) {
      if (value === 'Yes' || value === true) {
        return '<span class="report-value yes">Yes</span>';
      }
      return '<span class="report-value no">No</span>';
    }

    // Helper function to get translated label
    function getLabel(key) {
      const labels = {
        en: {
          'Visit Information': 'Visit Information',
          'Vital Signs': 'Vital Signs',
          'Physical Examination': 'Physical Examination',
          'Treatment & Counselling': 'Treatment & Counselling',
          'Danger Signs': 'Danger Signs',
          'Additional Information': 'Additional Information',
          'Visit Date': 'Visit Date',
          'Visit Number': 'Visit Number',
          'Delivered Date & Time': 'Delivered Date & Time',
          'Post-partum Period': 'Post-partum Period',
          'Days': 'Days',
          'Hours': 'Hours',
          'Temperature': 'Temperature',
          'Blood Pressure': 'Blood Pressure',
          'Pulse Rate': 'Pulse Rate',
          'Breast Engorgement': 'Breast Engorgement',
          'Nipple Condition': 'Nipple Condition',
          'Breast Milk Production': 'Breast Milk Production',
          'Uterine Involution': 'Uterine Involution',
          'Vaginal Discharge': 'Vaginal Discharge',
          'Discharge Smell': 'Discharge Smell',
          'Episiotomy Healing': 'Episiotomy Healing',
          'Urination': 'Urination',
          'Constipation': 'Constipation',
          'Mental Health': 'Mental Health Assessment',
          'Vitamin B Complex': 'Vitamin B Complex',
          'Vitamin A': 'Vitamin A',
          'Iron & Folic Acid': 'Iron & Folic Acid',
          'Contraception': 'Contraception',
          'Contraceptive Methods': 'Contraceptive Methods',
          'Other Symptoms': 'Other Symptoms',
          'Treatment Given': 'Treatment Given',
          'Referral Given': 'Referral Given',
          'Reason for Referral': 'Reason for Referral',
          'Clinical Notes': 'Clinical Notes',
          'Not recorded': 'Not recorded',
          'Not assessed': 'Not assessed'
        },
        my: {
          'Visit Information': '·Äô·ÄΩ·Ä±·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äô·Ä≠·ÄÅ·ÄÑ·Ä∫ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äõ·Äæ·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Äæ·ÄØ·ÄÜ·Ä≠·ÄØ·ÄÑ·Ä∫·Äõ·Ä¨ ·Äû·Äê·ÄÑ·Ä∫·Ä∏·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Ä°·Äú·ÄÄ·Ä∫',
          'Vital Signs': 'Vital Signs',
          'Physical Examination': '·Ä°·Äë·ÄΩ·Ä±·Äë·ÄΩ·Ä± ·ÄÖ·Äô·Ä∫·Ä∏·Äû·Äï·Ä∫·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Treatment & Counselling': '·ÄÜ·Ä±·Ä∏·ÄÄ·ÄØ·Äû·Äô·Äæ·ÄØ·Äï·Ä±·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Danger Signs': '·Ä°·Äî·Äπ·Äê·Äõ·Ä¨·Äö·Ä∫·Äú·ÄÄ·Äπ·ÄÅ·Äè·Ä¨·Äô·Äª·Ä¨·Ä∏',
          'Additional Information': '·Ä°·ÄÅ·Äº·Ä¨·Ä∏ ·Äú·ÄÄ·Äπ·ÄÅ·Äè·Ä¨·Äô·Äª·Ä¨·Ä∏',
          'Visit Date': '·Äï·Äº·Äû·Äû·Ää·Ä∑·Ä∫ ·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤',
          'Visit Number': '·Ä°·ÄÄ·Äº·Ä≠·Äô·Ä∫·Ä°·Äõ·Ä±·Ä°·Äê·ÄΩ·ÄÄ·Ä∫',
          'Delivered Date & Time': '·Äô·ÄΩ·Ä±·Ä∏·Äñ·ÄΩ·Ä¨·Ä∏·Äû·Ää·Ä∑·Ä∫ ·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫',
          'Post-partum Period': '·Äô·ÄΩ·Ä±·Ä∏·Äñ·ÄΩ·Ä¨·Ä∏·Äï·Äº·ÄÆ·Ä∏·ÄÄ·Ä¨·Äú',
          'Days': '·Äõ·ÄÄ·Ä∫',
          'Hours': '·Äî·Ä¨·Äõ·ÄÆ',
          'Temperature': '·ÄÄ·Ä≠·ÄØ·Äö·Ä∫·Ä°·Äï·Ä∞·ÄÅ·Äª·Ä≠·Äî·Ä∫',
          'Blood Pressure': '·Äû·ÄΩ·Ä±·Ä∏·Äï·Ä±·Ä´·ÄÑ·Ä∫·ÄÅ·Äª·Ä≠·Äî·Ä∫',
          'Pulse Rate': '·Äû·ÄΩ·Ä±·Ä∏·ÄÅ·ÄØ·Äî·Ä∫·Äî·Äæ·ÄØ·Äî·Ä∫·Ä∏',
          'Breast Engorgement': '·Äõ·ÄÑ·Ä∫·Äû·Ä¨·Ä∏·Äê·ÄÑ·Ä∫·Ä∏·Äô·Ä¨·Äô·Äæ·ÄØ',
          'Nipple Condition': '·Äî·Ä≠·ÄØ·Ä∑·Äû·ÄÆ·Ä∏·ÄÅ·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Ä°·ÄÅ·Äº·Ä±·Ä°·Äî·Ä±',
          'Breast Milk Production': '·Äî·Ä≠·ÄØ·Ä∑·Äë·ÄΩ·ÄÄ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Uterine Involution': '·Äû·Ä¨·Ä∏·Ä°·Ä≠·Äô·Ä∫ ·Äú·ÄØ·Ä∂·Ä∏·Äô·Ä¨·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Vaginal Discharge': '·Äô·Ä≠·Äî·Ä∫·Ä∏·Äô·ÄÄ·Ä≠·ÄØ·Äö·Ä∫·Äô·Äæ ·Äû·ÄΩ·Ä±·Ä∏·ÄÜ·ÄÑ·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Discharge Smell': '·Ä°·Äî·Ä∂·Ä∑',
          'Episiotomy Healing': '·Äô·ÄΩ·Ä±·Ä∏·Äú·Äô·Ä∫·Ä∏·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Ä°·Äî·Ä¨ ·Ä°·ÄÅ·Äº·Ä±·Ä°·Äî·Ä±',
          'Urination': '·ÄÜ·ÄÆ·Ä∏·Äû·ÄΩ·Ä¨·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Constipation': '·Äù·Äô·Ä∫·Ä∏·ÄÅ·Äª·ÄØ·Äï·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Mental Health': '·ÄÖ·Ä≠·Äê·Ä∫·ÄÄ·Äª·Äî·Ä∫·Ä∏·Äô·Ä¨·Äõ·Ä±·Ä∏',
          'Vitamin B Complex': '·Äó·ÄÆ·Äê·Ä¨·Äô·ÄÑ·Ä∫ ·Äò·ÄÆ·Äù·Äô·Ä∫·Ä∏',
          'Vitamin A': '·Äó·ÄÆ·Äê·Ä¨·Äô·ÄÑ·Ä∫ ·Ä°·Ä±',
          'Iron & Folic Acid': '·Äû·Ä∂·Äì·Ä´·Äê·Ä∫·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·Äñ·Ä±·Ä¨·Äú·ÄÖ·Ä∫·Ä°·ÄÄ·Ä∫·ÄÜ·ÄÖ·Ä∫',
          'Contraception': '·Äû·Ä¨·Ä∏·ÄÜ·ÄÄ·Ä∫·ÄÅ·Äº·Ä¨·Ä∏·Äî·Ää·Ä∫·Ä∏·Äú·Äô·Ä∫·Ä∏',
          'Contraceptive Methods': '·Äû·Ä¨·Ä∏·ÄÜ·ÄÄ·Ä∫·ÄÅ·Äº·Ä¨·Ä∏·Äî·Ää·Ä∫·Ä∏·Äú·Äô·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏',
          'Other Symptoms': '·Ä°·ÄÅ·Äº·Ä¨·Ä∏ ·Äú·ÄÄ·Äπ·ÄÅ·Äè·Ä¨·Äô·Äª·Ä¨·Ä∏',
          'Treatment Given': '·ÄÄ·ÄØ·Äû·Äô·Äæ·ÄØ·Äï·Ä±·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Referral Given': '·Äú·ÄΩ·Äæ·Ä≤·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Ää·ÄΩ·Äæ·Äî·Ä∫·Ä∏·Äï·Ä≠·ÄØ·Ä∑·Äô·Äæ·ÄØ',
          'Reason for Referral': '·Äú·ÄΩ·Äæ·Ä≤·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Ää·ÄΩ·Äæ·Äî·Ä∫·Ä∏·Äï·Ä≠·ÄØ·Ä∑·Äû·Ää·Ä∑·Ä∫ ·Ä°·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏',
          'Clinical Notes': '·ÄÜ·Ä±·Ä∏·ÄÄ·ÄØ·Äû·Äô·Äæ·ÄØ·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏',
          'Not recorded': '·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Äê·ÄÑ·Ä∫·Äë·Ä¨·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ ·Äô·Äõ·Äæ·Ä≠',
          'Not assessed': '·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏·Äë·Ä¨·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ ·Äô·Äõ·Äæ·Ä≠'
        }
      };
      return labels[currentLanguage][key] || key;
    }

    // Get danger signs text with translations
    function getDangerSignsText(dangerSigns) {
      if (!dangerSigns) return getLabel('Not assessed');
      
      const signs = [];
      const signLabels = {
        en: {
          'Heavy bleeding': 'Heavy bleeding',
          'Severe headache': 'Severe headache',
          'Convulsions': 'Convulsions',
          'Breathing problems': 'Breathing problems',
          'Fever/Fatigue': 'Fever/Fatigue',
          'Breast engorgement': 'Breast engorgement',
          'Urinary problems': 'Urinary problems',
          'Wound inflammation': 'Wound inflammation',
          'Foul discharge': 'Foul discharge'
        },
        my: {
          'Heavy bleeding': '·Äô·ÄΩ·Ä±·Ä∏·Äñ·ÄΩ·Ä¨·Ä∏·Äï·Äº·ÄÆ·Ä∏·ÄÅ·Äª·Ä≠·Äî·Ä∫ ·Äû·ÄΩ·Ä±·Ä∏·Äû·ÄΩ·Äî·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Severe headache': '·Äï·Äº·ÄÑ·Ä∫·Ä∏·Äë·Äî·Ä∫·ÄÖ·ÄΩ·Ä¨ ·ÄÅ·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·ÄÄ·Ä≠·ÄØ·ÄÄ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Convulsions': '·Äê·ÄÄ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Breathing problems': '·Ä°·Äû·ÄÄ·Ä∫·Äõ·Äæ·Ä∞·Äô·Äº·Äî·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Fever/Fatigue': '·Äñ·Äª·Ä¨·Ä∏·Äï·Äº·ÄÆ·Ä∏ ·Ä°·Ä¨·Ä∏·Äî·Ää·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Breast engorgement': '·Äõ·ÄÑ·Ä∫·Äû·Ä¨·Ä∏·Äê·ÄÑ·Ä∫·Ä∏·Äô·Ä¨·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Urinary problems': '·ÄÜ·ÄÆ·Ä∏·Äû·ÄΩ·Ä¨·Ä∏·Äõ·ÄÅ·ÄÄ·Ä∫·ÄÅ·Ä≤·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏',
          'Wound inflammation': '·Äô·ÄΩ·Ä±·Ä∏·Äú·Äô·Ä∫·Ä∏·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Ä°·Äî·Ä¨ ·Äî·ÄÆ·Äõ·Ä≤·Äö·Ä±·Ä¨·ÄÑ·Ä∫·Äõ·Äô·Ä∫·Ä∏',
          'Foul discharge': '·Ä°·Äî·Ä∂·Ä∑·ÄÜ·Ä≠·ÄØ·Ä∏·Äû·Ä±·Ä¨ ·Äû·ÄΩ·Ä±·Ä∏/·Ä°·Äõ·Ää·Ä∫ ·ÄÜ·ÄÑ·Ä∫·Ä∏'
        }
      };
      
      if (dangerSigns.heavyBleeding) signs.push(signLabels[currentLanguage]['Heavy bleeding']);
      if (dangerSigns.severeHeadache) signs.push(signLabels[currentLanguage]['Severe headache']);
      if (dangerSigns.convulsions) signs.push(signLabels[currentLanguage]['Convulsions']);
      if (dangerSigns.breathingProblems) signs.push(signLabels[currentLanguage]['Breathing problems']);
      if (dangerSigns.feverFatigue) signs.push(signLabels[currentLanguage]['Fever/Fatigue']);
      if (dangerSigns.breastEngorgementDanger) signs.push(signLabels[currentLanguage]['Breast engorgement']);
      if (dangerSigns.urinaryProblems) signs.push(signLabels[currentLanguage]['Urinary problems']);
      if (dangerSigns.woundInflammation) signs.push(signLabels[currentLanguage]['Wound inflammation']);
      if (dangerSigns.foulDischarge) signs.push(signLabels[currentLanguage]['Foul discharge']);
      
      return signs.length > 0 ? signs.join(', ') : getLabel('Not assessed');
    }

    // Show/hide loading spinner
    function showLoading(show) {
      const spinner = document.getElementById('loadingSpinner');
      const container = document.querySelector('.container');
      
      if (show) {
        spinner.style.display = 'block';
        container.style.display = 'none';
      } else {
        spinner.style.display = 'none';
        container.style.display = 'block';
      }
    }
  </script>
</body>
</html>
