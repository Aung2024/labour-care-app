<!DOCTYPE html>
<html lang="en">
<head>
  <title>Birth Record - Maternal & Child Health Care System</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="languages/language-switcher.css" />
  
  <style>
    .birth-form-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .birth-header {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
    }
    
    .birth-header h1 {
      margin: 0;
      font-size: 2.5rem;
      font-weight: 700;
    }
    
    .birth-header p {
      margin: 10px 0 0 0;
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .form-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }
    
    .form-section h3 {
      color: #374151;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #10b981;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-section h3 i {
      color: #10b981;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .form-control:invalid {
      border-color: #ef4444;
    }
    
    .required-field::after {
      content: " *";
      color: #ef4444;
      font-weight: bold;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 12px;
    }
    
    .btn-save-birth {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .btn-save-birth:hover {
      background: linear-gradient(135deg, #059669, #047857);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }
    
    .btn-back {
      background: #6b7280;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-back:hover {
      background: #4b5563;
      transform: translateY(-1px);
    }
    
    .success-message {
      display: none;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin: 20px 0;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .success-message i {
      font-size: 2rem;
      margin-bottom: 10px;
      display: block;
    }
    
    .patient-info {
      background: #f3f4f6;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      border-left: 4px solid #10b981;
    }
    
    .patient-info h4 {
      color: #374151;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .patient-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .info-item {
      display: flex;
      flex-direction: column;
    }
    
    .info-label {
      font-size: 0.9rem;
      color: #6b7280;
      font-weight: 500;
      margin-bottom: 5px;
    }
    
    .info-value {
      font-weight: 600;
      color: #374151;
    }

    /* Complications & E-MOTIVE Styling */
    .section-subtitle {
      color: #374151;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .complications-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1.5rem;
    }

    .hemorrhage-alert {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      border: 1px solid #f87171;
      border-radius: 8px;
      padding: 1rem;
      color: #991b1b;
      text-align: center;
    }

    .hemorrhage-alert i {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      display: block;
    }

    .hemorrhage-alert strong {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .hemorrhage-alert p {
      margin: 0;
      font-size: 0.9rem;
    }

    /* Vital Signs Grid */
    .vital-signs-set {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 1rem;
      background: white;
    }

    .vital-signs-header {
      background: #f8fafc;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e2e8f0;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .vital-set-title {
      margin: 0;
      color: #374151;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .remove-vital-set {
      background: #fee2e2;
      border: 1px solid #fca5a5;
      color: #dc2626;
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .remove-vital-set:hover {
      background: #fecaca;
      border-color: #f87171;
    }

    .vital-signs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }

    .vital-sign-item {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
    }

    .vital-sign-item label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .vital-input-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .vital-at {
      font-size: 0.8rem;
      color: #6b7280;
      font-weight: 500;
    }

    .time-input {
      flex: 0 0 120px;
      font-size: 0.9rem;
    }

    /* E-MOTIVE Bundle Styling */
    .emotive-bundle {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 12px;
      padding: 1.5rem;
    }

    /* Best Practices Bundle Styling */
    .best-practices-bundle {
      background: #fdf4ff;
      border: 1px solid #e879f9;
      border-radius: 12px;
      padding: 1.5rem;
    }

    .emotive-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1rem;
    }

    .emotive-item {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      transition: all 0.3s ease;
    }

    .emotive-item:hover {
      border-color: #10b981;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
    }

    .emotive-checkbox {
      flex-shrink: 0;
      margin-top: 0.25rem;
    }

    .emotive-content {
      flex: 1;
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
    }

    .emotive-letter {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .emotive-description {
      flex: 1;
    }

    .emotive-description strong {
      display: block;
      color: #374151;
      margin-bottom: 0.25rem;
      font-size: 0.95rem;
    }

    .emotive-description p {
      color: #6b7280;
      font-size: 0.8rem;
      margin: 0 0 0.75rem 0;
      line-height: 1.3;
    }

    .duration-input {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .duration-input .form-control {
      flex: 1;
      font-size: 0.9rem;
      padding: 0.375rem 0.75rem;
    }

    .duration-unit {
      font-size: 0.8rem;
      color: #6b7280;
      font-weight: 500;
    }

    /* Custom Checkbox Styling */
    .custom-checkbox {
      display: none;
    }

    .checkbox-label {
      cursor: pointer;
      display: block;
      position: relative;
      margin: 0;
    }

    .checkmark {
      display: block;
      width: 20px;
      height: 20px;
      background: white;
      border: 2px solid #d1d5db;
      border-radius: 4px;
      position: relative;
      transition: all 0.3s ease;
    }

    .checkmark:after {
      content: '';
      position: absolute;
      display: none;
      left: 6px;
      top: 2px;
      width: 6px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .custom-checkbox:checked + .checkbox-label .checkmark {
      background: #10b981;
      border-color: #10b981;
    }

    .custom-checkbox:checked + .checkbox-label .checkmark:after {
      display: block;
    }

    .checkbox-label:hover .checkmark {
      border-color: #10b981;
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .vital-signs-grid {
        grid-template-columns: 1fr;
      }
      
      .emotive-grid {
        grid-template-columns: 1fr;
      }
      
      .vital-input-group {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
      }
      
      .vital-at {
        text-align: center;
      }
      
      .time-input {
        flex: 1;
      }
    }

    .footer {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      color: #374151;
      text-align: center;
      padding: 2rem;
      margin-top: 2rem;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  <script src="languages/language-manager.js"></script>
</head>
<body>
  <!-- Professional Header -->
  <div class="medical-header">
    <div class="header-content">
      <div class="header-left">
        <div class="app-title">👩‍⚕️ Maternal & Child Health Care System</div>
        <div class="page-subtitle">Birth Record - Baby Information</div>
      </div>
      <div class="header-right">
        <button class="btn btn-outline-light btn-sm" onclick="firebase.auth().signOut(); localStorage.clear(); window.location='login.html';">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </div>

  <div class="main-container">
    <div class="birth-form-container">
      <!-- Birth Header -->
      <div class="birth-header">
        <h1><i class="fas fa-baby"></i> Birth Record</h1>
        <p>Congratulations! Please record the baby's information and birth details</p>
      </div>

      <!-- Patient Information Display -->
      <div class="patient-info">
        <h4><i class="fas fa-user-injured"></i> Patient Information</h4>
        <div class="patient-info-grid" id="patientInfoGrid">
          <!-- Patient info will be populated here -->
        </div>
      </div>

      <!-- Birth Information Form -->
      <form id="birthForm" onsubmit="saveBirthRecord(event)">
        <!-- Baby Information Section -->
        <div class="form-section">
          <h3><i class="fas fa-baby"></i> Baby Information</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="babyName">Baby's Name</label>
              <input type="text" id="babyName" name="babyName" class="form-control" placeholder="Enter baby's name">
            </div>
            <div class="form-group">
              <label for="babyGender">Gender</label>
              <select id="babyGender" name="babyGender" class="form-control">
                <option value="">Select gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="birthTime">Birth Time</label>
              <input type="datetime-local" id="birthTime" name="birthTime" class="form-control">
            </div>
            <div class="form-group">
              <label for="birthWeight">Birth Weight (Lb)</label>
              <input type="number" id="birthWeight" name="birthWeight" class="form-control" min="1" max="20" step="0.1" placeholder="e.g., 7.1">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="birthLength">Birth Length (cm)</label>
              <input type="number" id="birthLength" name="birthLength" class="form-control" min="20" max="70" step="0.1" placeholder="e.g., 50.5">
            </div>
            <div class="form-group">
              <label for="headCircumference">Head Circumference (cm)</label>
              <input type="number" id="headCircumference" name="headCircumference" class="form-control" min="20" max="50" step="0.1" placeholder="e.g., 35.2">
            </div>
          </div>
        </div>

        <!-- Birth Details Section -->
        <div class="form-section">
          <h3><i class="fas fa-calendar-check"></i> Birth Details</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="birthPlace">Birth Place</label>
              <input type="text" id="birthPlace" name="birthPlace" class="form-control" placeholder="e.g., Home, Clinic, Hospital">
            </div>
            <div class="form-group">
              <label for="deliveryMethod">Delivery Method</label>
              <select id="deliveryMethod" name="deliveryMethod" class="form-control">
                <option value="">Select delivery method</option>
                <option value="Normal Vaginal Delivery">Normal Vaginal Delivery</option>
                <option value="Assisted Vaginal Delivery">Assisted Vaginal Delivery</option>
                <option value="Cesarean Section">Cesarean Section</option>
                <option value="Vacuum Extraction">Vacuum Extraction</option>
                <option value="Forceps Delivery">Forceps Delivery</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="apgarScore1min">APGAR Score (1 min)</label>
              <input type="number" id="apgarScore1min" name="apgarScore1min" class="form-control" min="0" max="10" placeholder="0-10">
            </div>
            <div class="form-group">
              <label for="apgarScore5min">APGAR Score (5 min)</label>
              <input type="number" id="apgarScore5min" name="apgarScore5min" class="form-control" min="0" max="10" placeholder="0-10">
            </div>
          </div>
          
          <div class="form-group">
            <label for="birthComplications">Birth Complications</label>
            <textarea id="birthComplications" name="birthComplications" class="form-control" rows="3" placeholder="Describe any complications during birth (if none, leave blank)"></textarea>
          </div>
        </div>

        <!-- Parent Information Section -->
        <div class="form-section">
          <h3><i class="fas fa-users"></i> Parent Information</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="motherName">Mother's Name</label>
              <input type="text" id="motherName" name="motherName" class="form-control" placeholder="Enter mother's full name">
            </div>
            <div class="form-group">
              <label for="fatherName">Father's Name</label>
              <input type="text" id="fatherName" name="fatherName" class="form-control" placeholder="Enter father's full name">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="motherAge">Mother's Age</label>
              <input type="number" id="motherAge" name="motherAge" class="form-control" min="12" max="60" placeholder="Enter mother's age">
            </div>
            <div class="form-group">
              <label for="motherPhone">Mother's Phone</label>
              <input type="tel" id="motherPhone" name="motherPhone" class="form-control" placeholder="Enter phone number">
            </div>
          </div>
        </div>

        <!-- Complications & E-MOTIVE Section -->
        <div class="form-section">
          <h3><i class="fas fa-exclamation-triangle"></i> Complications & E-MOTIVE Bundle</h3>
          <p class="text-muted mb-4">Post-partum hemorrhage management best practices</p>
          
          <!-- Blood Loss Monitoring -->
          <div class="complications-card mb-4">
            <h5 class="section-subtitle">Blood Loss Monitoring & PPH Detection</h5>
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label for="totalBloodLoss">Total Blood Loss (within 1st hr after birth)</label>
                  <div class="input-group">
                    <input type="number" id="totalBloodLoss" name="totalBloodLoss" class="form-control" placeholder="Enter amount" oninput="checkBloodLoss()">
                    <span class="input-group-text">ml</span>
                  </div>
                  <small class="text-muted">Monitor blood loss within first hour</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label for="uterineTone">Uterine Tone</label>
                  <select id="uterineTone" name="uterineTone" class="form-control" onchange="checkBloodLoss()">
                    <option value="">Select uterine tone</option>
                    <option value="well-contracted">Well contracted</option>
                    <option value="not-contracted">Not contracted</option>
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label>Manual PPH Decision</label>
                  <div class="emotive-item" style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 8px;">
                    <div class="emotive-checkbox">
                      <input type="checkbox" id="manualPPH" name="manualPPH" class="custom-checkbox" onchange="checkBloodLoss()">
                      <label for="manualPPH" class="checkbox-label">
                        <span class="checkmark"></span>
                      </label>
                    </div>
                    <div class="emotive-content">
                      <div class="emotive-letter" style="background: linear-gradient(135deg, #dc2626, #b91c1c);">PPH</div>
                      <div class="emotive-description">
                        <strong>Mark as PPH</strong>
                        <p>Midwife Decision - Override automatic detection</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- PPH Alert -->
            <div id="hemorrhageAlert" class="hemorrhage-alert" style="display: none;">
              <i class="fas fa-exclamation-triangle"></i>
              <strong id="pphAlertTitle">Postpartum Hemorrhage (PPH) detected!</strong>
              <p id="pphAlertMessage">Start EMOTIVE bundle and follow protocols</p>
            </div>
          </div>

          <!-- Vital Signs Monitoring -->
          <div class="complications-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="section-subtitle mb-0">Vital Signs Monitoring</h5>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="addVitalSignsSet()">
                <i class="fas fa-plus me-1"></i>Add More Readings
              </button>
            </div>
            <p class="text-muted mb-3">Record vital signs with time (Monitor every 15min if >1 abnormal feature)</p>
            
            <div id="vitalSignsContainer">
              <!-- Initial vital signs set -->
              <div class="vital-signs-set" data-set="1">
                <div class="vital-signs-header">
                  <h6 class="vital-set-title">
                    <i class="fas fa-heartbeat me-2"></i>Vital Signs Reading #1
                  </h6>
                </div>
                
                <!-- Common Time Input -->
                <div class="mb-3">
                  <label class="form-label">Recording Time:</label>
                  <input type="time" id="vitalTime_1" name="vitalTime_1" class="form-control time-input" style="width: 200px;">
                </div>
                
                <div class="vital-signs-grid">
                  <div class="vital-sign-item">
                    <label>Temperature (°C)</label>
                    <input type="number" id="temperature_1" name="temperature_1" class="form-control" placeholder="37.5" step="0.1">
                  </div>
                  
                  <div class="vital-sign-item">
                    <label>Blood Pressure (mmHg)</label>
                    <input type="text" id="bloodPressure_1" name="bloodPressure_1" class="form-control" placeholder="120/80">
                  </div>
                  
                  <div class="vital-sign-item">
                    <label>Pulse Rate (bpm)</label>
                    <input type="number" id="pulseRate_1" name="pulseRate_1" class="form-control" placeholder="80" min="40" max="200">
                  </div>
                  
                  <div class="vital-sign-item">
                    <label>Respiratory Rate (breaths/min)</label>
                    <input type="number" id="respiratoryRate_1" name="respiratoryRate_1" class="form-control" placeholder="20" min="10" max="40">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Impending Shock Alert -->
          <div class="complications-card mb-4">
            <h5 class="section-subtitle">Signs and Symptoms of Impending Shock</h5>
            <p class="text-muted mb-3">Assess for signs of impending shock</p>
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="systolicBP">Systolic Blood Pressure</label>
                  <div class="input-group">
                    <input type="number" id="systolicBP" name="systolicBP" class="form-control" placeholder="Enter systolic BP" min="50" max="200" oninput="checkImpendingShock()">
                    <span class="input-group-text">mmHg</span>
                  </div>
                  <small class="text-muted">Normal: ≥90mmHg</small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="pulseRateShock">Pulse Rate</label>
                  <div class="input-group">
                    <input type="number" id="pulseRateShock" name="pulseRateShock" class="form-control" placeholder="Enter pulse rate" min="40" max="200" oninput="checkImpendingShock()">
                    <span class="input-group-text">bpm</span>
                  </div>
                  <small class="text-muted">Normal: ≤100bpm</small>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="respiratoryRateShock">Respiratory Rate</label>
                  <div class="input-group">
                    <input type="number" id="respiratoryRateShock" name="respiratoryRateShock" class="form-control" placeholder="Enter respiratory rate" min="10" max="40" oninput="checkImpendingShock()">
                    <span class="input-group-text">breaths/min</span>
                  </div>
                  <small class="text-muted">Normal: ≤22 breaths/min</small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="urineOutput">Urine Output</label>
                  <select id="urineOutput" name="urineOutput" class="form-control" onchange="checkImpendingShock()">
                    <option value="">Select urine output</option>
                    <option value="normal">Normal output</option>
                    <option value="decreased">Decreased output</option>
                    <option value="no-output">No output</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Checkbox Symptoms -->
            <div class="row mt-3">
              <div class="col-md-6">
                <div class="form-group">
                  <label>Skin Appearance</label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="paleSkin" name="paleSkin" onchange="checkImpendingShock()">
                    <label class="form-check-label" for="paleSkin">
                      Pale, Cool and Clammy skin
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="sweating" name="sweating" onchange="checkImpendingShock()">
                    <label class="form-check-label" for="sweating">
                      Sweating
                    </label>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label>Mental Status & Other Symptoms</label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="mentalSymptoms" name="mentalSymptoms" onchange="checkImpendingShock()">
                    <label class="form-check-label" for="mentalSymptoms">
                      Anxiety, Restlessness, Confusion or Dizziness
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="otherSymptoms" name="otherSymptoms" onchange="checkImpendingShock()">
                    <label class="form-check-label" for="otherSymptoms">
                      Nausea, Vomiting and excessive thirst
                    </label>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Impending Shock Alert -->
            <div id="impendingShockAlert" class="hemorrhage-alert" style="display: none; background: linear-gradient(135deg, #fee2e2, #fecaca);">
              <i class="fas fa-exclamation-triangle"></i>
              <strong>Possible impending shock detected!</strong>
              <p>Recheck parameters. If shock confirmed, start protocols.</p>
            </div>
          </div>

          <!-- E-MOTIVE Bundle -->
          <div class="emotive-bundle">
            <h5 class="section-subtitle">Start E-MOTIVE Bundle</h5>
            <p class="text-muted mb-4">Check interventions performed and record duration</p>
            
            <div class="emotive-grid">
              <div class="emotive-item">
                <div class="emotive-checkbox">
                  <input type="checkbox" id="massageUterus" name="massageUterus" class="custom-checkbox">
                  <label for="massageUterus" class="checkbox-label">
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="emotive-content">
                  <div class="emotive-letter">M</div>
                  <div class="emotive-description">
                    <strong>Massage Uterus</strong>
                    <p>Bimanual uterine compression</p>
                    <div class="duration-input">
                      <input type="text" id="massageDuration" name="massageDuration" class="form-control" placeholder="Duration">
                      <span class="duration-unit">mins</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="emotive-item">
                <div class="emotive-checkbox">
                  <input type="checkbox" id="oxytocinDrugs" name="oxytocinDrugs" class="custom-checkbox">
                  <label for="oxytocinDrugs" class="checkbox-label">
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="emotive-content">
                  <div class="emotive-letter">O</div>
                  <div class="emotive-description">
                    <strong>Oxytocic Drugs</strong>
                    <p>Administer uterotonic medications</p>
                    <div class="duration-input">
                      <input type="text" id="oxytocinDuration" name="oxytocinDuration" class="form-control" placeholder="Duration">
                      <span class="duration-unit">mins</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="emotive-item">
                <div class="emotive-checkbox">
                  <input type="checkbox" id="tranexamicAcid" name="tranexamicAcid" class="custom-checkbox">
                  <label for="tranexamicAcid" class="checkbox-label">
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="emotive-content">
                  <div class="emotive-letter">T</div>
                  <div class="emotive-description">
                    <strong>Tranexamic Acid</strong>
                    <p>Anti-fibrinolytic therapy</p>
                    <div class="duration-input">
                      <input type="text" id="tranexamicDuration" name="tranexamicDuration" class="form-control" placeholder="Duration">
                      <span class="duration-unit">mins</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="emotive-item">
                <div class="emotive-checkbox">
                  <input type="checkbox" id="ivFluids" name="ivFluids" class="custom-checkbox">
                  <label for="ivFluids" class="checkbox-label">
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="emotive-content">
                  <div class="emotive-letter">IV</div>
                  <div class="emotive-description">
                    <strong>IV Fluids</strong>
                    <p>Intravenous fluid resuscitation</p>
                    <div class="duration-input">
                      <input type="text" id="ivFluidsDuration" name="ivFluidsDuration" class="form-control" placeholder="Duration">
                      <span class="duration-unit">mins</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="emotive-item">
                <div class="emotive-checkbox">
                  <input type="checkbox" id="examination" name="examination" class="custom-checkbox">
                  <label for="examination" class="checkbox-label">
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="emotive-content">
                  <div class="emotive-letter">E</div>
                  <div class="emotive-description">
                    <strong>Examination & Escalation</strong>
                    <p>Assess and escalate care if needed</p>
                    <div class="duration-input">
                      <input type="text" id="examinationDuration" name="examinationDuration" class="form-control" placeholder="Duration">
                      <span class="duration-unit">mins</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Best Practices Section -->
        <div class="form-section">
          <h3><i class="fas fa-award"></i> Best Practices Checklist</h3>
          <p class="text-muted mb-4">Essential maternal and newborn care practices</p>
          
          <!-- Maternal Outcome Practices -->
          <div class="best-practices-bundle mb-4">
            <h5 class="section-subtitle">Maternal Outcome Practices</h5>
            <div class="emotive-grid">
              <div class="emotive-item">
                <div class="emotive-checkbox">
                  <input type="checkbox" id="uteronicReceived" name="uteronicReceived" class="custom-checkbox">
                  <label for="uteronicReceived" class="checkbox-label">
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="emotive-content">
                  <div class="emotive-letter" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">Ut</div>
                  <div class="emotive-description">
                    <strong>Uterotonic Received</strong>
                    <p>Oxytocin 10 IU IM in third stage of labour/immediately after birth</p>
                  </div>
                </div>
              </div>

              <div class="emotive-item">
                <div class="emotive-checkbox">
                  <input type="checkbox" id="cordTraction" name="cordTraction" class="custom-checkbox">
                  <label for="cordTraction" class="checkbox-label">
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="emotive-content">
                  <div class="emotive-letter" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">Ct</div>
                  <div class="emotive-description">
                    <strong>Control Cord Traction</strong>
                    <p>Controlled cord traction performed</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Birth/Newborn Practices -->
          <div class="best-practices-bundle">
            <h5 class="section-subtitle">Birth & Newborn Care Practices</h5>
            <div class="emotive-grid">
              <div class="emotive-item">
                <div class="emotive-checkbox">
                  <input type="checkbox" id="delayedCordClamping" name="delayedCordClamping" class="custom-checkbox">
                  <label for="delayedCordClamping" class="checkbox-label">
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="emotive-content">
                  <div class="emotive-letter" style="background: linear-gradient(135deg, #ec4899, #db2777);">Dc</div>
                  <div class="emotive-description">
                    <strong>Delayed Cord Clamping</strong>
                    <p>Practiced delay cord clamping (1-3 min)</p>
                    <div class="duration-input">
                      <input type="text" id="cordClampingDuration" name="cordClampingDuration" class="form-control" placeholder="Duration">
                      <span class="duration-unit">mins</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="emotive-item">
                <div class="emotive-checkbox">
                  <input type="checkbox" id="skinToSkinContact" name="skinToSkinContact" class="custom-checkbox">
                  <label for="skinToSkinContact" class="checkbox-label">
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="emotive-content">
                  <div class="emotive-letter" style="background: linear-gradient(135deg, #ec4899, #db2777);">Sk</div>
                  <div class="emotive-description">
                    <strong>Skin to Skin Contact</strong>
                    <p>Practiced skin to skin contact immediately after birth</p>
                  </div>
                </div>
              </div>

              <div class="emotive-item">
                <div class="emotive-checkbox">
                  <input type="checkbox" id="breastfeedingWithinHour" name="breastfeedingWithinHour" class="custom-checkbox">
                  <label for="breastfeedingWithinHour" class="checkbox-label">
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="emotive-content">
                  <div class="emotive-letter" style="background: linear-gradient(135deg, #ec4899, #db2777);">Bf</div>
                  <div class="emotive-description">
                    <strong>Breastfeeding Within One Hour</strong>
                    <p>Breastfeeding initiated within one hour of birth</p>
                  </div>
                </div>
              </div>

              <div class="emotive-item">
                <div class="emotive-checkbox">
                  <input type="checkbox" id="eyeCare" name="eyeCare" class="custom-checkbox">
                  <label for="eyeCare" class="checkbox-label">
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="emotive-content">
                  <div class="emotive-letter" style="background: linear-gradient(135deg, #ec4899, #db2777);">Ec</div>
                  <div class="emotive-description">
                    <strong>Eye Care (TEO)</strong>
                    <p>Provision of eye care with Tetracycline Eye Ointment</p>
                  </div>
                </div>
              </div>

              <div class="emotive-item">
                <div class="emotive-checkbox">
                  <input type="checkbox" id="vitaminK" name="vitaminK" class="custom-checkbox">
                  <label for="vitaminK" class="checkbox-label">
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="emotive-content">
                  <div class="emotive-letter" style="background: linear-gradient(135deg, #ec4899, #db2777);">Vk</div>
                  <div class="emotive-description">
                    <strong>Vitamin K Injection</strong>
                    <p>Provision of vitamin K (1mg IM) on first day of life</p>
                  </div>
                </div>
              </div>

              <div class="emotive-item">
                <div class="emotive-checkbox">
                  <input type="checkbox" id="hepBVaccine" name="hepBVaccine" class="custom-checkbox">
                  <label for="hepBVaccine" class="checkbox-label">
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="emotive-content">
                  <div class="emotive-letter" style="background: linear-gradient(135deg, #ec4899, #db2777);">Hb</div>
                  <div class="emotive-description">
                    <strong>Hep B Vaccine</strong>
                    <p>Provision of Hep B vaccine on first day of life</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button type="button" class="btn-back" onclick="goBack()">
            <i class="fas fa-arrow-left"></i> Back to Summary
          </button>
          <button type="submit" class="btn-save-birth">
            <i class="fas fa-save"></i> Save Birth Record
          </button>
        </div>
      </form>

      <!-- Success Message -->
      <div id="successMessage" class="success-message">
        <i class="fas fa-check-circle"></i>
        <h4>Birth Record Saved Successfully!</h4>
        <p>The baby's information has been recorded. You can now view the complete birth record.</p>
        <button class="btn btn-light mt-3" onclick="viewBirthRecord()">
          <i class="fas fa-eye"></i> View Birth Record
        </button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p class="mb-0">
        <i class="fas fa-heart me-2"></i>
        © 2025 Maternal & Child Health Care System — Designed for clinical excellence - Powered by Jhpiego Myanmar
      </p>
    </div>
  </footer>

  <script>
    // Get patient ID from URL parameters
    function getPatientIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('patient');
    }

    // Check if in edit mode
    function isEditMode() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('edit') === 'true';
    }

    // Load patient information
    async function loadPatientInfo() {
      try {
        const patientId = getPatientIdFromUrl();
        if (!patientId) {
          document.body.innerHTML = '<div class="alert alert-danger">Patient ID not found.</div>';
          return;
        }

        // Check if user is authenticated
        const user = firebase.auth().currentUser;
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        // Load patient data
        const patientDoc = await firebase.firestore()
          .collection("patients")
          .doc(patientId)
          .get();

        if (!patientDoc.exists) {
          document.body.innerHTML = '<div class="alert alert-danger">Patient not found.</div>';
          return;
        }

        const patientData = patientDoc.data();
        
        // Populate patient info display
        const patientInfoGrid = document.getElementById('patientInfoGrid');
        patientInfoGrid.innerHTML = `
          <div class="info-item">
            <span class="info-label">Patient Name</span>
            <span class="info-value">${patientData.name || 'N/A'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Age</span>
            <span class="info-value">${patientData.age || 'N/A'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Parity</span>
            <span class="info-value">${patientData.parity || 'N/A'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Labour Onset</span>
            <span class="info-value">${patientData.labour_onset || 'N/A'}</span>
          </div>
        `;

        // Pre-fill mother's name and age
        document.getElementById('motherName').value = patientData.name || '';
        document.getElementById('motherAge').value = patientData.age || '';

        // If in edit mode, load existing birth record
        if (isEditMode()) {
          await loadExistingBirthRecord(patientId);
          document.querySelector('.birth-header h1').innerHTML = '<i class="fas fa-edit"></i> Edit Birth Record';
          document.querySelector('.birth-header p').textContent = 'Update the baby\'s information and birth details';
          document.querySelector('.btn-save-birth').innerHTML = '<i class="fas fa-save"></i> Update Birth Record';
        } else {
          // Set default birth time to current time for new records
          const now = new Date();
          const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
          document.getElementById('birthTime').value = localDateTime.toISOString().slice(0, 16);
        }

      } catch (error) {
        console.error('Error loading patient info:', error);
        document.body.innerHTML = `<div class="alert alert-danger">Error loading patient information: ${error.message}</div>`;
      }
    }

    // Load existing birth record for editing
    async function loadExistingBirthRecord(patientId) {
      try {
        const birthRecordDoc = await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .collection('records')
          .doc('birthRecord')
          .get();

        if (birthRecordDoc.exists) {
          const data = birthRecordDoc.data();
          
          // Populate all form fields with existing data
          document.getElementById('babyName').value = data.babyName || '';
          document.getElementById('babyGender').value = data.babyGender || '';
          document.getElementById('birthTime').value = data.birthTime || '';
          document.getElementById('birthWeight').value = data.birthWeight || '';
          document.getElementById('birthLength').value = data.birthLength || '';
          document.getElementById('headCircumference').value = data.headCircumference || '';
          document.getElementById('birthPlace').value = data.birthPlace || '';
          document.getElementById('deliveryMethod').value = data.deliveryMethod || '';
          document.getElementById('apgarScore1min').value = data.apgarScore1min || '';
          document.getElementById('apgarScore5min').value = data.apgarScore5min || '';
          document.getElementById('birthComplications').value = data.birthComplications || '';
          document.getElementById('motherName').value = data.motherName || '';
          document.getElementById('fatherName').value = data.fatherName || '';
          document.getElementById('motherAge').value = data.motherAge || '';
          document.getElementById('motherPhone').value = data.motherPhone || '';
          
          // Load complications data
          document.getElementById('totalBloodLoss').value = data.totalBloodLoss || '';
          document.getElementById('uterineTone').value = data.uterineTone || '';
          document.getElementById('manualPPH').checked = data.manualPPH || false;
          
          // Load impending shock assessment data
          document.getElementById('systolicBP').value = data.systolicBP || '';
          document.getElementById('pulseRateShock').value = data.pulseRateShock || '';
          document.getElementById('respiratoryRateShock').value = data.respiratoryRateShock || '';
          document.getElementById('urineOutput').value = data.urineOutput || '';
          document.getElementById('paleSkin').checked = data.paleSkin || false;
          document.getElementById('sweating').checked = data.sweating || false;
          document.getElementById('mentalSymptoms').checked = data.mentalSymptoms || false;
          document.getElementById('otherSymptoms').checked = data.otherSymptoms || false;
          
          // Load vital signs data (handle both old single format and new multiple format)
          if (data.vitalSigns && Array.isArray(data.vitalSigns)) {
            // Load multiple vital signs sets
            loadMultipleVitalSigns(data.vitalSigns);
          } else {
            // Load old single vital signs format
            document.getElementById('vitalTime_1').value = data.temperatureTime || '';
            document.getElementById('temperature_1').value = data.temperature || '';
            document.getElementById('bloodPressure_1').value = data.bloodPressure || '';
            document.getElementById('pulseRate_1').value = data.pulseRate || '';
            document.getElementById('respiratoryRate_1').value = data.respiratoryRate || '';
          }
          
          // Check for alerts
          checkBloodLoss();
          checkImpendingShock();
          
          // Load MOTIVE bundle data
          document.getElementById('massageUterus').checked = data.massageUterus || false;
          document.getElementById('massageDuration').value = data.massageDuration || '';
          document.getElementById('oxytocinDrugs').checked = data.oxytocinDrugs || false;
          document.getElementById('oxytocinDuration').value = data.oxytocinDuration || '';
          document.getElementById('tranexamicAcid').checked = data.tranexamicAcid || false;
          document.getElementById('tranexamicDuration').value = data.tranexamicDuration || '';
          document.getElementById('ivFluids').checked = data.ivFluids || false;
          document.getElementById('ivFluidsDuration').value = data.ivFluidsDuration || '';
          document.getElementById('examination').checked = data.examination || false;
          document.getElementById('examinationDuration').value = data.examinationDuration || '';
          
          // Load Best Practices data
          document.getElementById('uteronicReceived').checked = data.uteronicReceived || false;
          document.getElementById('cordTraction').checked = data.cordTraction || false;
          document.getElementById('delayedCordClamping').checked = data.delayedCordClamping || false;
          document.getElementById('cordClampingDuration').value = data.cordClampingDuration || '';
          document.getElementById('skinToSkinContact').checked = data.skinToSkinContact || false;
          document.getElementById('breastfeedingWithinHour').checked = data.breastfeedingWithinHour || false;
          document.getElementById('eyeCare').checked = data.eyeCare || false;
          document.getElementById('vitaminK').checked = data.vitaminK || false;
          document.getElementById('hepBVaccine').checked = data.hepBVaccine || false;
          
          console.log('Existing birth record loaded for editing');
        } else {
          console.log('No existing birth record found');
        }
      } catch (error) {
        console.error('Error loading existing birth record:', error);
      }
    }

    // Save birth record
    async function saveBirthRecord(event) {
      event.preventDefault();
      
      try {
        const patientId = getPatientIdFromUrl();
        if (!patientId) {
          alert('Patient ID not found.');
          return;
        }

        // Collect form data
        const formData = {
          babyName: document.getElementById('babyName').value || '',
          babyGender: document.getElementById('babyGender').value || '',
          birthTime: document.getElementById('birthTime').value || '',
          birthWeight: parseFloat(document.getElementById('birthWeight').value) || null, // Changed to pounds
          birthLength: parseFloat(document.getElementById('birthLength').value) || null,
          headCircumference: parseFloat(document.getElementById('headCircumference').value) || null,
          birthPlace: document.getElementById('birthPlace').value || '',
          deliveryMethod: document.getElementById('deliveryMethod').value || '',
          apgarScore1min: parseInt(document.getElementById('apgarScore1min').value) || null,
          apgarScore5min: parseInt(document.getElementById('apgarScore5min').value) || null,
          birthComplications: document.getElementById('birthComplications').value || '',
          motherName: document.getElementById('motherName').value || '',
          fatherName: document.getElementById('fatherName').value || '',
          motherAge: parseInt(document.getElementById('motherAge').value) || null,
          motherPhone: document.getElementById('motherPhone').value || '',
          
          // Complications & E-MOTIVE data
          totalBloodLoss: parseInt(document.getElementById('totalBloodLoss').value) || null,
          uterineTone: document.getElementById('uterineTone').value || '',
          manualPPH: document.getElementById('manualPPH').checked,
          
          // Impending Shock Assessment
          systolicBP: parseInt(document.getElementById('systolicBP').value) || null,
          pulseRateShock: parseInt(document.getElementById('pulseRateShock').value) || null,
          respiratoryRateShock: parseInt(document.getElementById('respiratoryRateShock').value) || null,
          urineOutput: document.getElementById('urineOutput').value || '',
          paleSkin: document.getElementById('paleSkin').checked,
          sweating: document.getElementById('sweating').checked,
          mentalSymptoms: document.getElementById('mentalSymptoms').checked,
          otherSymptoms: document.getElementById('otherSymptoms').checked,
          
          // Collect all vital signs sets
          vitalSigns: collectAllVitalSigns(),
          
          // Auto-detect hemorrhage and shock
          postpartumHemorrhage: (parseInt(document.getElementById('totalBloodLoss').value) || 0) > 300 || document.getElementById('manualPPH').checked,
          pphDetected: (parseInt(document.getElementById('totalBloodLoss').value) || 0) > 300 || document.getElementById('manualPPH').checked,
          pphAutoDetected: (parseInt(document.getElementById('totalBloodLoss').value) || 0) > 300,
          impendingShock: checkImpendingShockStatus(),
          
          // MOTIVE Bundle
          massageUterus: document.getElementById('massageUterus').checked,
          massageDuration: document.getElementById('massageDuration').value || '',
          oxytocinDrugs: document.getElementById('oxytocinDrugs').checked,
          oxytocinDuration: document.getElementById('oxytocinDuration').value || '',
          tranexamicAcid: document.getElementById('tranexamicAcid').checked,
          tranexamicDuration: document.getElementById('tranexamicDuration').value || '',
          ivFluids: document.getElementById('ivFluids').checked,
          ivFluidsDuration: document.getElementById('ivFluidsDuration').value || '',
          examination: document.getElementById('examination').checked,
          examinationDuration: document.getElementById('examinationDuration').value || '',
          
          // Best Practices - Maternal Outcome
          uteronicReceived: document.getElementById('uteronicReceived').checked,
          cordTraction: document.getElementById('cordTraction').checked,
          
          // Best Practices - Birth & Newborn Care
          delayedCordClamping: document.getElementById('delayedCordClamping').checked,
          cordClampingDuration: document.getElementById('cordClampingDuration').value || '',
          skinToSkinContact: document.getElementById('skinToSkinContact').checked,
          breastfeedingWithinHour: document.getElementById('breastfeedingWithinHour').checked,
          eyeCare: document.getElementById('eyeCare').checked,
          vitaminK: document.getElementById('vitaminK').checked,
          hepBVaccine: document.getElementById('hepBVaccine').checked,
          
          patientId: patientId,
          recordedBy: firebase.auth().currentUser?.uid || 'unknown',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Save birth record to Firestore
        await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .collection('records')
          .doc('birthRecord')
          .set(formData);

        // Update patient status to "postpartum" in main patients collection (using new 3-status system)
        await firebase.firestore()
          .collection('patients')
          .doc(patientId)
          .update({
            status: 'postpartum',
            birthRecordId: firebase.firestore().collection('patients').doc(patientId).collection('records').doc('birthRecord').id,
            last_updated: firebase.firestore.FieldValue.serverTimestamp()
          });

        // Show success message and redirect
        if (isEditMode()) {
          alert('Birth record updated successfully! Redirecting to baby care...');
          window.location.href = 'baby-care.html';
        } else {
          alert('Birth record saved successfully! Redirecting to dashboard...');
          window.location.href = 'index.html';
        }
        
        console.log('Birth record saved successfully and patient status updated');

      } catch (error) {
        console.error('Error saving birth record:', error);
        alert(`Error saving birth record: ${error.message}`);
      }
    }

    // Go back to summary page
    function goBack() {
      const patientId = getPatientIdFromUrl();
      if (patientId) {
        window.location.href = `summary.html?patient=${patientId}`;
      } else {
        window.location.href = 'list.html';
      }
    }

    // View birth record
    function viewBirthRecord() {
      const patientId = getPatientIdFromUrl();
      if (patientId) {
        // You can create a birth-record-view.html page or redirect to summary
        window.location.href = `summary.html?patient=${patientId}`;
      }
    }

    // Auto-detect postpartum hemorrhage based on blood loss and uterine tone
    function checkBloodLoss() {
      const bloodLoss = parseInt(document.getElementById('totalBloodLoss').value);
      const uterineTone = document.getElementById('uterineTone').value;
      const manualPPH = document.getElementById('manualPPH').checked;
      const hemorrhageAlert = document.getElementById('hemorrhageAlert');
      const pphAlertTitle = document.getElementById('pphAlertTitle');
      const pphAlertMessage = document.getElementById('pphAlertMessage');
      
      // Manual PPH override
      if (manualPPH) {
        hemorrhageAlert.style.display = 'block';
        pphAlertTitle.textContent = 'Postpartum Hemorrhage (PPH) detected!';
        pphAlertMessage.textContent = 'Start EMOTIVE bundle and follow protocols';
        return;
      }
      
      // Automatic PPH detection
      if (bloodLoss && bloodLoss >= 500) {
        // Blood loss 500ml or more = PPH
        hemorrhageAlert.style.display = 'block';
        pphAlertTitle.textContent = 'Postpartum Hemorrhage (PPH) detected!';
        pphAlertMessage.textContent = 'Start EMOTIVE bundle and follow protocols';
        
        // Show alert to user only once
        if (!hemorrhageAlert.getAttribute('data-alerted')) {
          alert('⚠️ Postpartum hemorrhage detected (≥500ml). Start EMOTIVE bundle and follow protocols.');
          hemorrhageAlert.setAttribute('data-alerted', 'true');
        }
      } else if (bloodLoss && bloodLoss >= 300 && uterineTone === 'not-contracted') {
        // Blood loss 300ml or more + abnormal uterine tone = PPH
        hemorrhageAlert.style.display = 'block';
        pphAlertTitle.textContent = 'Postpartum Hemorrhage (PPH) detected!';
        pphAlertMessage.textContent = 'Check abnormal parameters (e.g SHOCK) and if found, Start EMOTIVE bundle and follow protocols';
        
        // Show alert to user only once
        if (!hemorrhageAlert.getAttribute('data-alerted')) {
          alert('⚠️ Postpartum hemorrhage detected (≥300ml + abnormal uterine tone). Check for shock and start EMOTIVE bundle if confirmed.');
          hemorrhageAlert.setAttribute('data-alerted', 'true');
        }
      } else {
        hemorrhageAlert.style.display = 'none';
        hemorrhageAlert.removeAttribute('data-alerted');
      }
    }

    // Check for impending shock symptoms
    function checkImpendingShock() {
      const systolicBP = parseInt(document.getElementById('systolicBP').value);
      const pulseRate = parseInt(document.getElementById('pulseRateShock').value);
      const respiratoryRate = parseInt(document.getElementById('respiratoryRateShock').value);
      const urineOutput = document.getElementById('urineOutput').value;
      const paleSkin = document.getElementById('paleSkin').checked;
      const sweating = document.getElementById('sweating').checked;
      const mentalSymptoms = document.getElementById('mentalSymptoms').checked;
      const otherSymptoms = document.getElementById('otherSymptoms').checked;
      
      const shockAlert = document.getElementById('impendingShockAlert');
      
      // Check for abnormal parameters
      let abnormalCount = 0;
      
      if (systolicBP && systolicBP < 90) abnormalCount++;
      if (pulseRate && pulseRate > 100) abnormalCount++;
      if (respiratoryRate && respiratoryRate > 22) abnormalCount++;
      if (urineOutput === 'decreased' || urineOutput === 'no-output') abnormalCount++;
      if (paleSkin) abnormalCount++;
      if (sweating) abnormalCount++;
      if (mentalSymptoms) abnormalCount++;
      if (otherSymptoms) abnormalCount++;
      
      // Show alert if any abnormal parameters are present
      if (abnormalCount > 0) {
        shockAlert.style.display = 'block';
        
        // Show alert to user only once
        if (!shockAlert.getAttribute('data-alerted')) {
          alert('⚠️ Possible impending shock detected! Recheck parameters. If shock confirmed, start protocols.');
          shockAlert.setAttribute('data-alerted', 'true');
        }
      } else {
        shockAlert.style.display = 'none';
        shockAlert.removeAttribute('data-alerted');
      }
    }

    // Check impending shock status for data saving
    function checkImpendingShockStatus() {
      const systolicBP = parseInt(document.getElementById('systolicBP').value);
      const pulseRate = parseInt(document.getElementById('pulseRateShock').value);
      const respiratoryRate = parseInt(document.getElementById('respiratoryRateShock').value);
      const urineOutput = document.getElementById('urineOutput').value;
      const paleSkin = document.getElementById('paleSkin').checked;
      const sweating = document.getElementById('sweating').checked;
      const mentalSymptoms = document.getElementById('mentalSymptoms').checked;
      const otherSymptoms = document.getElementById('otherSymptoms').checked;
      
      // Check for abnormal parameters
      let abnormalCount = 0;
      
      if (systolicBP && systolicBP < 90) abnormalCount++;
      if (pulseRate && pulseRate > 100) abnormalCount++;
      if (respiratoryRate && respiratoryRate > 22) abnormalCount++;
      if (urineOutput === 'decreased' || urineOutput === 'no-output') abnormalCount++;
      if (paleSkin) abnormalCount++;
      if (sweating) abnormalCount++;
      if (mentalSymptoms) abnormalCount++;
      if (otherSymptoms) abnormalCount++;
      
      return abnormalCount > 0;
    }

    // Add new vital signs set
    let vitalSignsCounter = 1;
    
    function addVitalSignsSet() {
      vitalSignsCounter++;
      const container = document.getElementById('vitalSignsContainer');
      
      const newVitalSet = document.createElement('div');
      newVitalSet.className = 'vital-signs-set';
      newVitalSet.setAttribute('data-set', vitalSignsCounter);
      
      newVitalSet.innerHTML = `
        <div class="vital-signs-header">
          <h6 class="vital-set-title">
            <i class="fas fa-heartbeat me-2"></i>Vital Signs Reading #${vitalSignsCounter}
          </h6>
          <button type="button" class="remove-vital-set" onclick="removeVitalSignsSet(${vitalSignsCounter})">
            <i class="fas fa-times me-1"></i>Remove
          </button>
        </div>
        
        <!-- Common Time Input -->
        <div class="mb-3">
          <label class="form-label">Recording Time:</label>
          <input type="time" id="vitalTime_${vitalSignsCounter}" name="vitalTime_${vitalSignsCounter}" class="form-control time-input" style="width: 200px;">
        </div>
        
        <div class="vital-signs-grid">
          <div class="vital-sign-item">
            <label>Temperature (°C)</label>
            <input type="number" id="temperature_${vitalSignsCounter}" name="temperature_${vitalSignsCounter}" class="form-control" placeholder="37.5" step="0.1">
          </div>
          
          <div class="vital-sign-item">
            <label>Blood Pressure (mmHg)</label>
            <input type="text" id="bloodPressure_${vitalSignsCounter}" name="bloodPressure_${vitalSignsCounter}" class="form-control" placeholder="120/80">
          </div>
          
          <div class="vital-sign-item">
            <label>Pulse Rate (bpm)</label>
            <input type="number" id="pulseRate_${vitalSignsCounter}" name="pulseRate_${vitalSignsCounter}" class="form-control" placeholder="80" min="40" max="200">
          </div>
          
          <div class="vital-sign-item">
            <label>Respiratory Rate (breaths/min)</label>
            <input type="number" id="respiratoryRate_${vitalSignsCounter}" name="respiratoryRate_${vitalSignsCounter}" class="form-control" placeholder="20" min="10" max="40">
          </div>
        </div>
      `;
      
      container.appendChild(newVitalSet);
      
      // Auto-set current time for new reading
      const now = new Date();
      const currentTime = now.toTimeString().slice(0, 5);
      document.getElementById(`vitalTime_${vitalSignsCounter}`).value = currentTime;
    }

    function removeVitalSignsSet(setNumber) {
      if (setNumber === 1) {
        alert('Cannot remove the first vital signs reading.');
        return;
      }
      
      const setElement = document.querySelector(`[data-set="${setNumber}"]`);
      if (setElement) {
        setElement.remove();
      }
    }

    function collectAllVitalSigns() {
      const vitalSigns = [];
      const vitalSets = document.querySelectorAll('.vital-signs-set');
      
      vitalSets.forEach(set => {
        const setNumber = set.getAttribute('data-set');
        const vitalData = {
          setNumber: parseInt(setNumber),
          recordingTime: document.getElementById(`vitalTime_${setNumber}`).value || '',
          temperature: parseFloat(document.getElementById(`temperature_${setNumber}`).value) || null,
          bloodPressure: document.getElementById(`bloodPressure_${setNumber}`).value || '',
          pulseRate: parseInt(document.getElementById(`pulseRate_${setNumber}`).value) || null,
          respiratoryRate: parseInt(document.getElementById(`respiratoryRate_${setNumber}`).value) || null
        };
        
        // Only add if at least one vital sign is recorded
        if (vitalData.temperature || vitalData.bloodPressure || vitalData.pulseRate || vitalData.respiratoryRate) {
          vitalSigns.push(vitalData);
        }
      });
      
      return vitalSigns;
    }

    function loadMultipleVitalSigns(vitalSignsData) {
      // Clear existing vital signs except the first one
      const container = document.getElementById('vitalSignsContainer');
      const existingSets = container.querySelectorAll('.vital-signs-set');
      existingSets.forEach((set, index) => {
        if (index > 0) {
          set.remove();
        }
      });
      
      // Reset counter
      vitalSignsCounter = 1;
      
      // Load each vital signs set
      vitalSignsData.forEach((vital, index) => {
        if (index === 0) {
          // Load into first set
          document.getElementById('vitalTime_1').value = vital.recordingTime || vital.temperatureTime || '';
          document.getElementById('temperature_1').value = vital.temperature || '';
          document.getElementById('bloodPressure_1').value = vital.bloodPressure || '';
          document.getElementById('pulseRate_1').value = vital.pulseRate || '';
          document.getElementById('respiratoryRate_1').value = vital.respiratoryRate || '';
        } else {
          // Add new set and populate
          addVitalSignsSet();
          const setNumber = vitalSignsCounter;
          document.getElementById(`vitalTime_${setNumber}`).value = vital.recordingTime || vital.temperatureTime || '';
          document.getElementById(`temperature_${setNumber}`).value = vital.temperature || '';
          document.getElementById(`bloodPressure_${setNumber}`).value = vital.bloodPressure || '';
          document.getElementById(`pulseRate_${setNumber}`).value = vital.pulseRate || '';
          document.getElementById(`respiratoryRate_${setNumber}`).value = vital.respiratoryRate || '';
        }
      });
    }

    // Load data when page loads
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) {
        window.location.href = "login.html";
      } else {
        loadPatientInfo();
        
        // Add event listener for blood loss monitoring
        document.getElementById('totalBloodLoss').addEventListener('input', checkBloodLoss);
      }
    });
  </script>
</body>
</html>
