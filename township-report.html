<!DOCTYPE html>
<html lang="en">
<head>
  <title>Township Report - Maternal & Child Health Care System</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --primary-color: #2563eb;
      --secondary-color: #1e40af;
      --success-color: #059669;
      --warning-color: #d97706;
      --danger-color: #dc2626;
      --info-color: #0891b2;
      --light-bg: #f8fafc;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    .report-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .report-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 40px;
      text-align: center;
    }

    .report-header h1 {
      margin: 0;
      font-size: 2.5rem;
      font-weight: 700;
    }

    .report-header p {
      margin: 10px 0 0 0;
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .report-content {
      padding: 40px;
    }

    .report-section {
      margin-bottom: 40px;
      page-break-inside: avoid;
    }

    .section-title {
      color: var(--primary-color);
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      font-size: 1.2rem;
    }

    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid #e5e7eb;
    }

    .chart-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 15px;
      text-align: center;
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
      margin-bottom: 15px;
    }

    .chart-details {
      background: #f8fafc;
      border-radius: 8px;
      padding: 15px;
      font-size: 0.9rem;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .detail-label {
      font-weight: 500;
      color: #6b7280;
    }

    .detail-value {
      font-weight: 600;
      color: #374151;
    }

    .insights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .insight-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid #e5e7eb;
    }

    .insight-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .insight-content {
      font-size: 0.9rem;
      color: #374151;
      line-height: 1.5;
    }

    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
    }

    .summary-table th,
    .summary-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    .summary-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #374151;
    }

    .summary-table tr:last-child td {
      border-bottom: none;
    }

    .metric-highlight {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      border: 1px solid #93c5fd;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }

    .metric-highlight h6 {
      color: #1e40af;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .metric-highlight p {
      color: #1e3a8a;
      margin: 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 12px;
      position: relative;
      z-index: 10;
    }

    .btn-generate {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
    }

    .btn-generate:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--secondary-color), #1e3a8a);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }

    .btn-generate:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-print {
      background: linear-gradient(135deg, var(--success-color), #047857);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-print:hover {
      background: linear-gradient(135deg, #047857, #065f46);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background: #4b5563;
      transform: translateY(-2px);
    }

    .loading-spinner {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
      border-width: 0.3em;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .action-buttons {
        flex-direction: column;
        align-items: stretch;
      }

      .btn-generate,
      .btn-print,
      .btn-secondary {
        width: 100%;
        text-align: center;
      }

      .insights-grid {
        grid-template-columns: 1fr;
      }

      .chart-wrapper {
        height: 250px;
      }
    }

    /* Print Styles */
    @media print {
      body {
        background: white !important;
        padding: 0 !important;
      }

      .report-container {
        box-shadow: none !important;
        border-radius: 0 !important;
        margin: 0 !important;
        max-width: none !important;
      }

      .action-buttons {
        display: none !important;
      }

      .report-header {
        background: #2563eb !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .chart-container {
        page-break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #e5e7eb !important;
      }

      .section-title {
        color: #2563eb !important;
        border-bottom-color: #2563eb !important;
      }
    }

    .footer {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      color: #374151;
      text-align: center;
      padding: 2rem;
      margin-top: 2rem;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="report-container">
      <!-- Report Header -->
      <div class="report-header">
        <h1><i class="fas fa-chart-line"></i> Township Health Report</h1>
        <p>Comprehensive Maternal & Child Health Analytics</p>
        <div id="reportMeta" style="margin-top: 20px; font-size: 0.9rem; opacity: 0.8;">
          <!-- Report metadata will be populated here -->
        </div>
      </div>

      <!-- Report Content -->
      <div class="report-content">
        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Generating Report...</span>
          </div>
          <p class="mt-3">Generating comprehensive township report...</p>
        </div>

        <!-- Report Sections (hidden initially) -->
        <div id="reportSections" style="display: none;">
          <!-- Executive Summary -->
          <div class="report-section">
            <h2 class="section-title">
              <i class="fas fa-clipboard-list"></i> Executive Summary
            </h2>
            <div class="insights-grid">
              <div class="insight-card">
                <div class="insight-title">
                  <i class="fas fa-users"></i> Total Patients
                </div>
                <div class="insight-content">
                  <div id="totalPatientsSummary">Loading...</div>
                </div>
              </div>
              <div class="insight-card">
                <div class="insight-title">
                  <i class="fas fa-user-md"></i> Active Midwives
                </div>
                <div class="insight-content">
                  <div id="activeMidwivesSummary">Loading...</div>
                </div>
              </div>
              <div class="insight-card">
                <div class="insight-title">
                  <i class="fas fa-baby"></i> Birth Outcomes
                </div>
                <div class="insight-content">
                  <div id="birthOutcomesSummary">Loading...</div>
                </div>
              </div>
              <div class="insight-card">
                <div class="insight-title">
                  <i class="fas fa-exclamation-triangle"></i> Risk Indicators
                </div>
                <div class="insight-content">
                  <div id="riskIndicatorsSummary">Loading...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ANC Analysis -->
          <div class="report-section">
            <h2 class="section-title">
              <i class="fas fa-baby-carriage"></i> Antenatal Care Analysis
            </h2>
            <div class="chart-container">
              <div class="chart-title">ANC Visit Distribution</div>
              <div class="chart-wrapper">
                <canvas id="ancVisitsChart"></canvas>
              </div>
              <div class="chart-details" id="ancVisitsDetails">
                <!-- Chart details will be populated here -->
              </div>
            </div>
            
            <div class="insights-grid">
              <div class="insight-card">
                <div class="insight-title">
                  <i class="fas fa-early-bird"></i> Early ANC Coverage
                </div>
                <div class="insight-content">
                  <div id="earlyANCAnalysis">Loading...</div>
                </div>
              </div>
              <div class="insight-card">
                <div class="insight-title">
                  <i class="fas fa-vial"></i> Test Coverage
                </div>
                <div class="insight-content">
                  <div id="testCoverageAnalysis">Loading...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Labour Care Analysis -->
          <div class="report-section">
            <h2 class="section-title">
              <i class="fas fa-heartbeat"></i> Labour Care Analysis
            </h2>
            
            <div class="chart-container">
              <div class="chart-title">Birth Outcomes Distribution</div>
              <div class="chart-wrapper">
                <canvas id="birthOutcomesChart"></canvas>
              </div>
              <div class="chart-details" id="birthOutcomesDetails">
                <!-- Chart details will be populated here -->
              </div>
            </div>

            <div class="chart-container">
              <div class="chart-title">PPH Cases Analysis</div>
              <div class="chart-wrapper">
                <canvas id="pphCasesChart"></canvas>
              </div>
              <div class="chart-details" id="pphCasesDetails">
                <!-- Chart details will be populated here -->
              </div>
            </div>

            <div class="insights-grid">
              <div class="insight-card">
                <div class="insight-title">
                  <i class="fas fa-syringe"></i> Oxytocin Usage
                </div>
                <div class="insight-content">
                  <div id="oxytocinAnalysis">Loading...</div>
                </div>
              </div>
              <div class="insight-card">
                <div class="insight-title">
                  <i class="fas fa-ambulance"></i> Transfer Rates
                </div>
                <div class="insight-content">
                  <div id="transferAnalysis">Loading...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Health Indicators -->
          <div class="report-section">
            <h2 class="section-title">
              <i class="fas fa-chart-bar"></i> Health Indicators
            </h2>
            
            <div class="chart-container">
              <div class="chart-title">HIV & Syphilis Testing Results</div>
              <div class="chart-wrapper">
                <canvas id="hivSyphilisChart"></canvas>
              </div>
              <div class="chart-details" id="hivSyphilisDetails">
                <!-- Chart details will be populated here -->
              </div>
            </div>

            <div class="insights-grid">
              <div class="insight-card">
                <div class="insight-title">
                  <i class="fas fa-exclamation-circle"></i> High Risk Pregnancies
                </div>
                <div class="insight-content">
                  <div id="highRiskAnalysis">Loading...</div>
                </div>
              </div>
              <div class="insight-card">
                <div class="insight-title">
                  <i class="fas fa-pills"></i> Supplement Coverage
                </div>
                <div class="insight-content">
                  <div id="supplementAnalysis">Loading...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Midwife Performance -->
          <div class="report-section">
            <h2 class="section-title">
              <i class="fas fa-user-md"></i> Midwife Performance Analysis
            </h2>
            
            <div class="chart-container">
              <div class="chart-title">Patient Distribution by Midwife</div>
              <div class="chart-wrapper">
                <canvas id="midwifeDistributionChart"></canvas>
              </div>
              <div class="chart-details" id="midwifeDistributionDetails">
                <!-- Chart details will be populated here -->
              </div>
            </div>

            <table class="summary-table">
              <thead>
                <tr>
                  <th>Midwife</th>
                  <th>Total Patients</th>
                  <th>ANC Visits</th>
                  <th>Birth Outcomes</th>
                  <th>PPH Cases</th>
                  <th>High Risk %</th>
                </tr>
              </thead>
              <tbody id="midwifePerformanceTable">
                <!-- Table rows will be populated here -->
              </tbody>
            </table>
          </div>

          <!-- Recommendations -->
          <div class="report-section">
            <h2 class="section-title">
              <i class="fas fa-lightbulb"></i> Key Recommendations
            </h2>
            <div id="recommendationsList">
              <!-- Recommendations will be populated here -->
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button class="btn-generate" id="generateBtn" onclick="generateReport()">
            <i class="fas fa-sync-alt"></i> Regenerate Report
          </button>
          <button class="btn-print" onclick="printReport()">
            <i class="fas fa-print"></i> Print Report
          </button>
          <button class="btn btn-secondary" onclick="window.location.href='index.html'">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
          </button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p class="mb-0">
        <i class="fas fa-heart me-2"></i>
        MNCH App 2025 | Developed by Jhpiego Myanmar for MoH.
      </p>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="js/firebase.js"></script>
  
  <script>
    let currentUser = null;
    let userTownship = null;
    let reportData = {};

    // Initialize Firebase auth state
    firebase.auth().onAuthStateChanged(async function(user) {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      
      currentUser = user;
      
      // Check if user is TMO
      const userDoc = await firebase.firestore()
        .collection('users')
        .doc(user.uid)
        .get();
      
      if (!userDoc.exists || userDoc.data().role !== 'TMO') {
        alert('Access denied. This report is only available for TMO users.');
        window.location.href = "index.html";
        return;
      }
      
      userTownship = userDoc.data().township;
      
      console.log('Township Report initialized for:', userTownship);
      
      // Auto-generate report
      await generateReport();
    });

    // Generate comprehensive township report
    async function generateReport() {
      try {
        console.log('Generate Report button clicked');
        
        // Disable button during generation
        let generateBtn = document.getElementById('generateBtn');
        if (generateBtn) {
          generateBtn.disabled = true;
          generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        }
        
        // Show loading spinner
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('reportSections').style.display = 'none';
        
        // Update report metadata
        document.getElementById('reportMeta').innerHTML = `
          <div><strong>Township:</strong> ${userTownship}</div>
          <div><strong>Generated:</strong> ${new Date().toLocaleString()}</div>
          <div><strong>Generated by:</strong> ${currentUser.email}</div>
        `;
        
        // Collect all data
        await collectReportData();
        
        // Generate all charts and insights
        await generateAllCharts();
        await generateInsights();
        await generateRecommendations();
        
        // Hide loading spinner and show report
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('reportSections').style.display = 'block';
        
        // Re-enable button
        generateBtn = document.getElementById('generateBtn');
        if (generateBtn) {
          generateBtn.disabled = false;
          generateBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Regenerate Report';
        }
        
        console.log('Township report generated successfully');
        
      } catch (error) {
        console.error('Error generating report:', error);
        document.getElementById('loadingSpinner').style.display = 'none';
        
        // Re-enable button on error
        let generateBtn = document.getElementById('generateBtn');
        if (generateBtn) {
          generateBtn.disabled = false;
          generateBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Regenerate Report';
        }
        
        alert('Error generating report: ' + error.message);
      }
    }

    // Collect all data for the report
    async function collectReportData() {
      console.log('Collecting report data...');
      
      // Get all patients in township
      const patientsSnap = await firebase.firestore()
        .collection('patients')
        .where('township', '==', userTownship)
        .get();
      
      reportData.patients = [];
      patientsSnap.forEach(doc => {
        reportData.patients.push({ id: doc.id, ...doc.data() });
      });
      
      // Get all midwives in township
      const midwivesSnap = await firebase.firestore()
        .collection('users')
        .where('role', '==', 'Midwife')
        .where('township', '==', userTownship)
        .get();
      
      reportData.midwives = [];
      midwivesSnap.forEach(doc => {
        reportData.midwives.push({ id: doc.id, ...doc.data() });
      });
      
      // Collect additional data for each patient
      for (let patient of reportData.patients) {
        // ANC visits
        const ancVisitsSnap = await firebase.firestore()
          .collection('patients')
          .doc(patient.id)
          .collection('antenatal_visits')
          .get();
        patient.ancVisits = ancVisitsSnap.docs.map(doc => doc.data());
        
        // Test records
        const testRecordsSnap = await firebase.firestore()
          .collection('patients')
          .doc(patient.id)
          .collection('testRecords')
          .get();
        patient.testRecords = testRecordsSnap.docs.map(doc => doc.data());
        
        // Birth records
        const birthRecordDoc = await firebase.firestore()
          .collection('patients')
          .doc(patient.id)
          .collection('records')
          .doc('birthRecord')
          .get();
        patient.birthRecord = birthRecordDoc.exists ? birthRecordDoc.data() : null;
        
        // End treatment records
        const endTreatmentDoc = await firebase.firestore()
          .collection('patients')
          .doc(patient.id)
          .collection('records')
          .doc('endTreatment')
          .get();
        patient.endTreatment = endTreatmentDoc.exists ? endTreatmentDoc.data() : null;
        
        // Summary records
        const summaryDoc = await firebase.firestore()
          .collection('patients')
          .doc(patient.id)
          .collection('records')
          .doc('summary')
          .get();
        patient.summary = summaryDoc.exists ? summaryDoc.data() : null;
      }
      
      console.log('Report data collected:', reportData);
    }

    // Generate all charts
    async function generateAllCharts() {
      await generateANCVisitsChart();
      await generateBirthOutcomesChart();
      await generatePPHCasesChart();
      await generateHIVSyphilisChart();
      await generateMidwifeDistributionChart();
    }

    // Generate ANC visits chart
    async function generateANCVisitsChart() {
      const ctx = document.getElementById('ancVisitsChart').getContext('2d');
      
      // Calculate ANC visit distribution
      let zeroVisits = 0, lowVisits = 0, adequateVisits = 0, optimalVisits = 0;
      
      reportData.patients.forEach(patient => {
        const visitCount = patient.ancVisits ? patient.ancVisits.length : 0;
        if (visitCount === 0) zeroVisits++;
        else if (visitCount <= 3) lowVisits++;
        else if (visitCount <= 7) adequateVisits++;
        else optimalVisits++;
      });
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Zero visits', '1-3 visits', '4-7 visits', '8+ visits'],
          datasets: [{
            data: [zeroVisits, lowVisits, adequateVisits, optimalVisits],
            backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#10b981'],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
            title: { display: true, text: `ANC Visit Distribution (${reportData.patients.length} patients)`, font: { size: 14, weight: 'bold' } }
          }
        }
      });
      
      // Update details
      const total = reportData.patients.length;
      document.getElementById('ancVisitsDetails').innerHTML = `
        <div class="detail-item"><span class="detail-label">Total Patients:</span><span class="detail-value">${total}</span></div>
        <div class="detail-item"><span class="detail-label">Zero visits:</span><span class="detail-value">${zeroVisits} (${Math.round((zeroVisits / total) * 100)}%)</span></div>
        <div class="detail-item"><span class="detail-label">1-3 visits:</span><span class="detail-value">${lowVisits} (${Math.round((lowVisits / total) * 100)}%)</span></div>
        <div class="detail-item"><span class="detail-label">4-7 visits:</span><span class="detail-value">${adequateVisits} (${Math.round((adequateVisits / total) * 100)}%)</span></div>
        <div class="detail-item"><span class="detail-label">8+ visits:</span><span class="detail-value">${optimalVisits} (${Math.round((optimalVisits / total) * 100)}%)</span></div>
      `;
    }

    // Generate birth outcomes chart
    async function generateBirthOutcomesChart() {
      const ctx = document.getElementById('birthOutcomesChart').getContext('2d');
      
      let successfulBirths = 0, transfers = 0, otherOutcomes = 0, noLabour = 0;
      
      reportData.patients.forEach(patient => {
        if (patient.endTreatment) {
          const outcome = patient.endTreatment.outcome;
          if (outcome === 'birth') successfulBirths++;
          else if (outcome === 'transfer') transfers++;
          else otherOutcomes++;
        } else if (patient.birthRecord) {
          successfulBirths++;
        } else if (patient.summary) {
          otherOutcomes++;
        } else {
          noLabour++;
        }
      });
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Successful Births', 'Transfers', 'Other Outcomes', 'No Labour'],
          datasets: [{
            data: [successfulBirths, transfers, otherOutcomes, noLabour],
            backgroundColor: ['#10b981', '#f59e0b', '#6b7280', '#e5e7eb'],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
            title: { display: true, text: `Birth Outcomes (${reportData.patients.length} patients)`, font: { size: 14, weight: 'bold' } }
          }
        }
      });
      
      // Update details
      const total = reportData.patients.length;
      document.getElementById('birthOutcomesDetails').innerHTML = `
        <div class="detail-item"><span class="detail-label">Total Patients:</span><span class="detail-value">${total}</span></div>
        <div class="detail-item"><span class="detail-label">Successful Births:</span><span class="detail-value">${successfulBirths} (${Math.round((successfulBirths / total) * 100)}%)</span></div>
        <div class="detail-item"><span class="detail-label">Transfers:</span><span class="detail-value">${transfers} (${Math.round((transfers / total) * 100)}%)</span></div>
        <div class="detail-item"><span class="detail-label">Other Outcomes:</span><span class="detail-value">${otherOutcomes} (${Math.round((otherOutcomes / total) * 100)}%)</span></div>
        <div class="detail-item"><span class="detail-label">No Labour Care:</span><span class="detail-value">${noLabour} (${Math.round((noLabour / total) * 100)}%)</span></div>
      `;
    }

    // Generate PPH cases chart
    async function generatePPHCasesChart() {
      const ctx = document.getElementById('pphCasesChart').getContext('2d');
      
      let pphCases = 0, noPPH = 0;
      
      reportData.patients.forEach(patient => {
        if (patient.birthRecord) {
          const birthData = patient.birthRecord;
          if (birthData.manualPPH === true || 
              birthData.pphDetected === true ||
              birthData.pphAutoDetected === true ||
              birthData.postpartumHemorrhage === true ||
              (birthData.totalBloodLoss && parseInt(birthData.totalBloodLoss) >= 300)) {
            pphCases++;
          } else {
            noPPH++;
          }
        } else {
          noPPH++;
        }
      });
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['PPH Cases', 'No PPH'],
          datasets: [{
            data: [pphCases, noPPH],
            backgroundColor: ['#ef4444', '#10b981'],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
            title: { display: true, text: `PPH Cases (${reportData.patients.length} patients)`, font: { size: 14, weight: 'bold' } }
          }
        }
      });
      
      // Update details
      const total = reportData.patients.length;
      document.getElementById('pphCasesDetails').innerHTML = `
        <div class="detail-item"><span class="detail-label">Total Patients:</span><span class="detail-value">${total}</span></div>
        <div class="detail-item"><span class="detail-label">PPH Cases:</span><span class="detail-value">${pphCases} (${Math.round((pphCases / total) * 100)}%)</span></div>
        <div class="detail-item"><span class="detail-label">No PPH:</span><span class="detail-value">${noPPH} (${Math.round((noPPH / total) * 100)}%)</span></div>
      `;
    }

    // Generate HIV & Syphilis chart
    async function generateHIVSyphilisChart() {
      const ctx = document.getElementById('hivSyphilisChart').getContext('2d');
      
      let hivReactive = 0, syphilisReactive = 0, bothReactive = 0, noneReactive = 0;
      
      reportData.patients.forEach(patient => {
        if (patient.testRecords && patient.testRecords.length > 0) {
          const latestTest = patient.testRecords[patient.testRecords.length - 1];
          const hivPositive = latestTest.hivDone === 'Yes' && latestTest.hivResult === 'Reactive';
          const syphilisPositive = latestTest.syphilisDone === 'Yes' && latestTest.syphilisResult === 'Reactive';
          
          if (hivPositive && syphilisPositive) bothReactive++;
          else if (hivPositive) hivReactive++;
          else if (syphilisPositive) syphilisReactive++;
          else noneReactive++;
        } else {
          noneReactive++;
        }
      });
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['HIV Reactive', 'Syphilis Reactive', 'Both Reactive', 'None Reactive'],
          datasets: [{
            data: [hivReactive, syphilisReactive, bothReactive, noneReactive],
            backgroundColor: ['#dc2626', '#7c3aed', '#dc2626', '#10b981'],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
            title: { display: true, text: `HIV & Syphilis Results (${reportData.patients.length} patients)`, font: { size: 14, weight: 'bold' } }
          }
        }
      });
      
      // Update details
      const total = reportData.patients.length;
      document.getElementById('hivSyphilisDetails').innerHTML = `
        <div class="detail-item"><span class="detail-label">Total Patients:</span><span class="detail-value">${total}</span></div>
        <div class="detail-item"><span class="detail-label">HIV Reactive:</span><span class="detail-value">${hivReactive} (${Math.round((hivReactive / total) * 100)}%)</span></div>
        <div class="detail-item"><span class="detail-label">Syphilis Reactive:</span><span class="detail-value">${syphilisReactive} (${Math.round((syphilisReactive / total) * 100)}%)</span></div>
        <div class="detail-item"><span class="detail-label">Both Reactive:</span><span class="detail-value">${bothReactive} (${Math.round((bothReactive / total) * 100)}%)</span></div>
        <div class="detail-item"><span class="detail-label">None Reactive:</span><span class="detail-value">${noneReactive} (${Math.round((noneReactive / total) * 100)}%)</span></div>
      `;
    }

    // Generate midwife distribution chart
    async function generateMidwifeDistributionChart() {
      const ctx = document.getElementById('midwifeDistributionChart').getContext('2d');
      
      // Count patients per midwife
      const midwifeCounts = {};
      reportData.midwives.forEach(midwife => {
        midwifeCounts[midwife.id] = 0;
      });
      
      reportData.patients.forEach(patient => {
        if (patient.created_by && midwifeCounts.hasOwnProperty(patient.created_by)) {
          midwifeCounts[patient.created_by]++;
        }
      });
      
      const labels = reportData.midwives.map(m => m.name || m.email);
      const data = reportData.midwives.map(m => midwifeCounts[m.id]);
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Number of Patients',
            data: data,
            backgroundColor: '#3b82f6',
            borderColor: '#1e40af',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: true, text: `Patient Distribution by Midwife`, font: { size: 14, weight: 'bold' } }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
      
      // Update details
      document.getElementById('midwifeDistributionDetails').innerHTML = `
        <div class="detail-item"><span class="detail-label">Total Midwives:</span><span class="detail-value">${reportData.midwives.length}</span></div>
        <div class="detail-item"><span class="detail-label">Average Patients/Midwife:</span><span class="detail-value">${Math.round(reportData.patients.length / reportData.midwives.length)}</span></div>
      `;
    }

    // Generate insights
    async function generateInsights() {
      const totalPatients = reportData.patients.length;
      const totalMidwives = reportData.midwives.length;
      
      // Executive Summary
      document.getElementById('totalPatientsSummary').innerHTML = `
        <strong>${totalPatients}</strong> total patients registered in ${userTownship}
      `;
      
      document.getElementById('activeMidwivesSummary').innerHTML = `
        <strong>${totalMidwives}</strong> active midwives providing care
      `;
      
      // Birth outcomes summary
      let successfulBirths = 0, transfers = 0;
      reportData.patients.forEach(patient => {
        if (patient.endTreatment) {
          if (patient.endTreatment.outcome === 'birth') successfulBirths++;
          else if (patient.endTreatment.outcome === 'transfer') transfers++;
        } else if (patient.birthRecord) {
          successfulBirths++;
        }
      });
      
      document.getElementById('birthOutcomesSummary').innerHTML = `
        <strong>${successfulBirths}</strong> successful births<br>
        <strong>${transfers}</strong> transfers
      `;
      
      // Risk indicators
      let highRiskCount = 0, pphCount = 0;
      reportData.patients.forEach(patient => {
        if (patient.high_risk_pregnancy === 'Yes' || patient.high_risk_pregnancy === true) {
          highRiskCount++;
        }
        if (patient.birthRecord && (patient.birthRecord.pphDetected || patient.birthRecord.postpartumHemorrhage)) {
          pphCount++;
        }
      });
      
      document.getElementById('riskIndicatorsSummary').innerHTML = `
        <strong>${highRiskCount}</strong> high-risk pregnancies<br>
        <strong>${pphCount}</strong> PPH cases
      `;
      
      // Early ANC analysis
      let earlyANCCount = 0;
      reportData.patients.forEach(patient => {
        if (patient.early_anc_visit === 'Yes' || patient.early_anc_visit === true) {
          earlyANCCount++;
        }
      });
      
      document.getElementById('earlyANCAnalysis').innerHTML = `
        <div class="metric-highlight">
          <h6>Early ANC Coverage</h6>
          <p><strong>${earlyANCCount}</strong> patients (${Math.round((earlyANCCount / totalPatients) * 100)}%) received early ANC care</p>
        </div>
      `;
      
      // Test coverage analysis
      let testedCount = 0;
      reportData.patients.forEach(patient => {
        if (patient.testRecords && patient.testRecords.length > 0) {
          const latestTest = patient.testRecords[patient.testRecords.length - 1];
          if (latestTest.hivDone === 'Yes' || latestTest.syphilisDone === 'Yes') {
            testedCount++;
          }
        }
      });
      
      document.getElementById('testCoverageAnalysis').innerHTML = `
        <div class="metric-highlight">
          <h6>Test Coverage</h6>
          <p><strong>${testedCount}</strong> patients (${Math.round((testedCount / totalPatients) * 100)}%) have been tested for HIV/Syphilis</p>
        </div>
      `;
      
      // Oxytocin analysis
      let oxytocinUsed = 0;
      reportData.patients.forEach(patient => {
        if (patient.summary) {
          const summary = patient.summary;
          for (let key in summary) {
            if (key.includes('Oxytocin') && (summary[key] === 'Y' || summary[key] === 'Yes')) {
              oxytocinUsed++;
              break;
            }
          }
        }
      });
      
      document.getElementById('oxytocinAnalysis').innerHTML = `
        <div class="metric-highlight">
          <h6>Oxytocin Usage</h6>
          <p><strong>${oxytocinUsed}</strong> patients (${Math.round((oxytocinUsed / totalPatients) * 100)}%) received oxytocin during labour</p>
        </div>
      `;
      
      // Transfer analysis
      let transferCount = 0;
      reportData.patients.forEach(patient => {
        if (patient.endTreatment && patient.endTreatment.outcome === 'transfer') {
          transferCount++;
        }
      });
      
      document.getElementById('transferAnalysis').innerHTML = `
        <div class="metric-highlight">
          <h6>Transfer Rate</h6>
          <p><strong>${transferCount}</strong> patients (${Math.round((transferCount / totalPatients) * 100)}%) were transferred for higher care</p>
        </div>
      `;
      
      // High risk analysis
      document.getElementById('highRiskAnalysis').innerHTML = `
        <div class="metric-highlight">
          <h6>High Risk Pregnancies</h6>
          <p><strong>${highRiskCount}</strong> patients (${Math.round((highRiskCount / totalPatients) * 100)}%) identified as high-risk</p>
        </div>
      `;
      
      // Supplement analysis
      let supplementCount = 0;
      reportData.patients.forEach(patient => {
        if (patient.ancVisits && patient.ancVisits.length > 0) {
          patient.ancVisits.forEach(visit => {
            if (visit.ironFolicAcid === 'Given' || visit.ironFolicAcid === 'Yes') {
              supplementCount++;
              return;
            }
          });
        }
      });
      
      document.getElementById('supplementAnalysis').innerHTML = `
        <div class="metric-highlight">
          <h6>Iron & Folic Acid</h6>
          <p><strong>${supplementCount}</strong> patients received iron & folic acid supplements</p>
        </div>
      `;
      
      // Generate midwife performance table
      generateMidwifePerformanceTable();
    }

    // Generate midwife performance table
    function generateMidwifePerformanceTable() {
      const tableBody = document.getElementById('midwifePerformanceTable');
      tableBody.innerHTML = '';
      
      reportData.midwives.forEach(midwife => {
        const midwifePatients = reportData.patients.filter(p => p.created_by === midwife.id);
        const ancVisits = midwifePatients.reduce((sum, p) => sum + (p.ancVisits ? p.ancVisits.length : 0), 0);
        const birthOutcomes = midwifePatients.filter(p => p.birthRecord || (p.endTreatment && p.endTreatment.outcome === 'birth')).length;
        const pphCases = midwifePatients.filter(p => p.birthRecord && (p.birthRecord.pphDetected || p.birthRecord.postpartumHemorrhage)).length;
        const highRisk = midwifePatients.filter(p => p.high_risk_pregnancy === 'Yes' || p.high_risk_pregnancy === true).length;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${midwife.name || midwife.email}</td>
          <td>${midwifePatients.length}</td>
          <td>${ancVisits}</td>
          <td>${birthOutcomes}</td>
          <td>${pphCases}</td>
          <td>${Math.round((highRisk / midwifePatients.length) * 100)}%</td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Generate recommendations
    async function generateRecommendations() {
      const recommendations = [];
      const totalPatients = reportData.patients.length;
      
      // ANC recommendations
      let zeroVisits = 0;
      reportData.patients.forEach(patient => {
        if (!patient.ancVisits || patient.ancVisits.length === 0) {
          zeroVisits++;
        }
      });
      
      if (zeroVisits > 0) {
        recommendations.push({
          priority: 'High',
          category: 'ANC Care',
          title: 'Improve Early ANC Access',
          description: `${zeroVisits} patients (${Math.round((zeroVisits / totalPatients) * 100)}%) have no ANC visits recorded. Consider community outreach and education programs.`
        });
      }
      
      // PPH recommendations
      let pphCases = 0;
      reportData.patients.forEach(patient => {
        if (patient.birthRecord && (patient.birthRecord.pphDetected || patient.birthRecord.postpartumHemorrhage)) {
          pphCases++;
        }
      });
      
      if (pphCases > 0) {
        recommendations.push({
          priority: 'High',
          category: 'Labour Care',
          title: 'PPH Prevention Training',
          description: `${pphCases} PPH cases recorded. Recommend additional training on PPH prevention and E-MOTIVE bundle implementation.`
        });
      }
      
      // High risk recommendations
      let highRiskCount = 0;
      reportData.patients.forEach(patient => {
        if (patient.high_risk_pregnancy === 'Yes' || patient.high_risk_pregnancy === true) {
          highRiskCount++;
        }
      });
      
      if (highRiskCount > totalPatients * 0.3) {
        recommendations.push({
          priority: 'Medium',
          category: 'Risk Management',
          title: 'High Risk Pregnancy Management',
          description: `${Math.round((highRiskCount / totalPatients) * 100)}% of patients are high-risk. Ensure adequate referral pathways and specialized care.`
        });
      }
      
      // Test coverage recommendations
      let testedCount = 0;
      reportData.patients.forEach(patient => {
        if (patient.testRecords && patient.testRecords.length > 0) {
          const latestTest = patient.testRecords[patient.testRecords.length - 1];
          if (latestTest.hivDone === 'Yes' || latestTest.syphilisDone === 'Yes') {
            testedCount++;
          }
        }
      });
      
      if (testedCount < totalPatients * 0.8) {
        recommendations.push({
          priority: 'Medium',
          category: 'Testing',
          title: 'Improve HIV/Syphilis Testing Coverage',
          description: `Only ${Math.round((testedCount / totalPatients) * 100)}% of patients have been tested. Strengthen testing protocols and follow-up procedures.`
        });
      }
      
      // Display recommendations
      const recommendationsList = document.getElementById('recommendationsList');
      recommendationsList.innerHTML = '';
      
      recommendations.forEach(rec => {
        const priorityClass = rec.priority === 'High' ? 'danger' : 'warning';
        const recElement = document.createElement('div');
        recElement.className = `alert alert-${priorityClass} alert-dismissible fade show`;
        recElement.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="alert-heading">
                <i class="fas fa-exclamation-triangle"></i> 
                ${rec.title} 
                <span class="badge bg-${priorityClass === 'danger' ? 'danger' : 'warning'}">${rec.priority}</span>
              </h6>
              <p class="mb-0"><strong>Category:</strong> ${rec.category}</p>
              <p class="mb-0">${rec.description}</p>
            </div>
          </div>
        `;
        recommendationsList.appendChild(recElement);
      });
      
      if (recommendations.length === 0) {
        recommendationsList.innerHTML = `
          <div class="alert alert-success">
            <h6 class="alert-heading"><i class="fas fa-check-circle"></i> Excellent Performance</h6>
            <p class="mb-0">All key health indicators are within acceptable ranges. Continue current practices and monitoring.</p>
          </div>
        `;
      }
    }

    // Print report
    function printReport() {
      window.print();
    }
  </script>
</body>
</html>
